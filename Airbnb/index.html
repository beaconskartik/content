<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Airbnb Reservation System - Principal Engineer System Design</title>
<style>
  :root {
    --primary: #FF5A5F;
    --primary-dark: #E04850;
    --secondary: #00A699;
    --accent: #FC642D;
    --purple: #7B2FF7;
    --blue: #428BF9;
    --dark: #ffffff;
    --darker: #f1f5f9;
    --card-bg: #ffffff;
    --card-border: #e2e8f0;
    --text: #1e293b;
    --text-muted: #4b5563;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--dark);
    color: var(--text);
    line-height: 1.7;
    scroll-behavior: smooth;
  }
  /* HERO */
  .hero {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #6B73FF 100%);
    padding: 60px 40px;
    text-align: center;
    border-bottom: 3px solid var(--primary);
    position: relative;
    overflow: hidden;
  }
  .hero::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle at 30% 50%, rgba(255,90,95,0.08) 0%, transparent 50%),
                radial-gradient(circle at 70% 50%, rgba(0,166,153,0.08) 0%, transparent 50%);
    animation: pulse 8s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
  .hero h1 {
    font-size: 3em;
    background: linear-gradient(135deg, #ffffff, #e0e7ff, #ffffff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    position: relative;
    margin-bottom: 10px;
  }
  .hero .subtitle {
    font-size: 1.2em;
    color: rgba(255,255,255,0.9);
    position: relative;
  }
  .badge {
    display: inline-block;
    padding: 4px 14px;
    border-radius: 20px;
    font-size: 0.8em;
    font-weight: 600;
    margin: 5px;
  }
  .badge-red { background: rgba(255,255,255,0.15); color: #ffffff; border: 1px solid rgba(255,255,255,0.3); }
  .badge-green { background: rgba(0,166,153,0.2); color: #ffffff; border: 1px solid var(--secondary); }
  .badge-blue { background: rgba(255,255,255,0.15); color: #ffffff; border: 1px solid rgba(255,255,255,0.3); }
  .badge-purple { background: rgba(255,255,255,0.15); color: #ffffff; border: 1px solid rgba(255,255,255,0.3); }
  .badge-orange { background: rgba(255,255,255,0.15); color: #ffffff; border: 1px solid rgba(255,255,255,0.3); }

  /* NAV */
  .toc {
    background: #f8fafc;
    padding: 30px 40px;
    border-bottom: 1px solid var(--card-border);
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .toc h2 { color: var(--secondary); margin-bottom: 15px; font-size: 1.1em; text-transform: uppercase; letter-spacing: 2px; }
  .toc-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  .toc a {
    color: var(--text-muted);
    text-decoration: none;
    padding: 6px 16px;
    border-radius: 8px;
    background: var(--card-bg);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    font-size: 0.85em;
    transition: all 0.3s;
  }
  .toc a:hover {
    color: var(--primary);
    border-color: var(--primary);
    background: rgba(255,90,95,0.1);
  }

  /* SECTIONS */
  .container { max-width: 1300px; margin: 0 auto; padding: 0 30px; }
  section { padding: 50px 0; border-bottom: 1px solid var(--card-border); }
  section h2 {
    font-size: 2em;
    margin-bottom: 25px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  section h2 .icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2em;
  }
  section h3 {
    font-size: 1.3em;
    color: #ffffff;
    margin: 25px 0 12px;
    padding-left: 12px;
    border-left: 3px solid var(--secondary);
  }
  section h4 {
    font-size: 1.1em;
    color: var(--blue);
    margin: 18px 0 8px;
  }

  /* CARDS */
  .card {
    background: var(--card-bg);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 12px;
    padding: 24px;
    margin: 15px 0;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
  }
  .card-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin: 20px 0;
  }
  .card-header {
    font-size: 1.1em;
    font-weight: 700;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* DIAGRAM BOXES */
  .diagram-box {
    background: linear-gradient(135deg, var(--card-bg), var(--darker));
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 16px;
    padding: 30px;
    margin: 25px 0;
    overflow-x: auto;
  }
  .diagram-box svg { max-width: 100%; height: auto; }

  /* TABLES */
  table {
    width: 100%;
    border-collapse: collapse;
    margin: 15px 0;
    font-size: 0.92em;
  }
  th {
    background: linear-gradient(135deg, rgba(255,90,95,0.15), rgba(0,166,153,0.15));
    color: var(--text);
    padding: 12px 16px;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid var(--primary);
  }
  td {
    padding: 10px 16px;
    border-bottom: 1px solid var(--card-border);
  }
  tr:hover td { background: rgba(255,255,255,0.03); }

  /* CODE */
  pre {
    background: #f6f8fa;
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 10px;
    padding: 20px;
    overflow-x: auto;
    font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
    font-size: 0.88em;
    line-height: 1.6;
    margin: 15px 0;
  }
  code {
    font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
    font-size: 0.9em;
  }
  .keyword { color: #cf222e; }
  .string { color: #0a3069; }
  .comment { color: #6e7781; }
  .type { color: #8250df; }
  .func { color: #0550ae; }
  .number { color: #f0883e; }

  /* TIPS */
  .tip-box {
    border-radius: 12px;
    padding: 20px 24px;
    margin: 20px 0;
    border-left: 4px solid;
  }
  .tip-interview {
    background: rgba(123,47,247,0.1);
    border-color: var(--purple);
  }
  .tip-warning {
    background: rgba(245,158,11,0.1);
    border-color: var(--warning);
  }
  .tip-success {
    background: rgba(16,185,129,0.1);
    border-color: var(--success);
  }
  .tip-danger {
    background: rgba(239,68,68,0.1);
    border-color: var(--danger);
  }
  .tip-box .tip-title {
    font-weight: 700;
    margin-bottom: 6px;
    font-size: 0.95em;
  }

  /* FLOW ITEMS */
  .flow-steps {
    display: flex;
    flex-wrap: wrap;
    gap: 0;
    margin: 20px 0;
    align-items: center;
  }
  .flow-step {
    background: var(--card-bg);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 10px;
    padding: 12px 20px;
    text-align: center;
    font-size: 0.9em;
    min-width: 140px;
  }
  .flow-arrow {
    color: var(--primary);
    font-size: 1.5em;
    padding: 0 5px;
  }

  /* LISTS */
  ul { padding-left: 20px; margin: 8px 0; }
  li { margin: 4px 0; }
  li::marker { color: var(--primary); }

  /* COMPARISON */
  .comparison {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin: 20px 0;
  }
  .option-a { border-top: 3px solid var(--secondary); }
  .option-b { border-top: 3px solid var(--accent); }

  /* METRIC CARDS */
  .metric-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin: 20px 0;
  }
  .metric-card {
    background: var(--card-bg);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
  }
  .metric-value {
    font-size: 2em;
    font-weight: 800;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .metric-label {
    color: var(--text-muted);
    font-size: 0.85em;
    margin-top: 4px;
  }

  /* PROGRESS BAR */
  .bar-chart { margin: 15px 0; }
  .bar-row {
    display: flex;
    align-items: center;
    margin: 8px 0;
    gap: 10px;
  }
  .bar-label {
    width: 160px;
    font-size: 0.85em;
    text-align: right;
    color: var(--text-muted);
  }
  .bar-track {
    flex: 1;
    height: 24px;
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    overflow: hidden;
  }
  .bar-fill {
    height: 100%;
    border-radius: 12px;
    display: flex;
    align-items: center;
    padding-left: 10px;
    font-size: 0.75em;
    font-weight: 600;
    color: white;
  }

  /* FOOTER */
  footer {
    background: #f8fafc;
    padding: 30px 40px;
    text-align: center;
    color: var(--text-muted);
    font-size: 0.85em;
  }
  footer a { color: var(--secondary); text-decoration: none; }

  /* RESPONSIVE */
  @media (max-width: 768px) {
    .hero h1 { font-size: 2em; }
    .comparison { grid-template-columns: 1fr; }
    .card-grid { grid-template-columns: 1fr; }
    .container { padding: 0 15px; }
    .toc { padding: 15px; }
    section { padding: 30px 0; }
  }
  /* === DIAGRAM ZOOM CONTROLS === */
  .diagram-box { position: relative; }
  .diagram-zoom-controls {
    position: absolute; top: 12px; right: 12px; z-index: 10;
    display: flex; gap: 4px; opacity: 0.5; transition: opacity 0.3s;
  }
  .diagram-box:hover .diagram-zoom-controls { opacity: 1; }
  .diagram-zoom-controls button {
    width: 32px; height: 32px; border-radius: 8px; border: 1px solid #e5e7eb;
    background: #ffffff; color: #1e293b; cursor: pointer; font-size: 16px;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.2s;
    font-family: system-ui; line-height: 1; padding: 0;
  }
  .diagram-zoom-controls button:hover { background: #f1f5f9; border-color: var(--blue); color: var(--blue); }
  .diagram-zoom-controls button:active { transform: scale(0.95); }
  .diagram-zoom-controls .zoom-level {
    font-size: 11px; color: #64748b; display: flex; align-items: center;
    padding: 0 6px; font-weight: 600; min-width: 40px; justify-content: center;
  }
  .diagram-box svg { transition: transform 0.3s ease; transform-origin: center center; }
  .diagram-box.fullscreen {
    position: fixed !important; top: 0; left: 0; width: 100vw; height: 100vh;
    z-index: 9999; background: #ffffff; border-radius: 0; padding: 20px;
    display: flex; align-items: center; justify-content: center;
    overflow: auto;
  }
  .diagram-box.fullscreen .diagram-zoom-controls { opacity: 1; top: 20px; right: 20px; }
</style>
</head>
<body>

<!-- ==================== HERO ==================== -->
<div class="hero">
  <h1>Airbnb Reservation System Design</h1>
  <p class="subtitle">A Principal Engineer's Comprehensive Blueprint</p>
  <div style="margin-top:15px; position:relative;">
    <span class="badge badge-red">System Design</span>
    <span class="badge badge-green">Scalability</span>
    <span class="badge badge-blue">Microservices</span>
    <span class="badge badge-purple">Interview Prep</span>
    <span class="badge badge-orange">Principal Level</span>
  </div>
</div>

<!-- ==================== TABLE OF CONTENTS ==================== -->
<nav class="toc">
  <h2>Navigation</h2>
  <div class="toc-grid">
    <a href="#overview">Overview</a>
    <a href="#requirements">Requirements</a>
    <a href="#estimates">Capacity Estimates</a>
    <a href="#hld">High-Level Design</a>
    <a href="#api">API Design</a>
    <a href="#datamodel">Data Modeling</a>
    <a href="#booking-flow">Booking Flow</a>
    <a href="#search">Search &amp; Discovery</a>
    <a href="#concurrency">Concurrency &amp; Double Booking</a>
    <a href="#tradeoffs">Trade-offs &amp; Options</a>
    <a href="#deep-dives">Deep Dives</a>
    <a href="#peak-events">Peak Events &amp; Olympics</a>
    <a href="#interview-tips">Interview Tips</a>
    <a href="#sources">Sources</a>
    <a href="capacity-reference.html" style="color:var(--blue);border-color:var(--blue);">&#128200; Capacity Reference &rarr;</a>
    <a href="topics/index.html" style="color:var(--purple);border-color:var(--purple);font-weight:700;">&#127891; 18 System Design Topics &rarr;</a>
  </div>
</nav>

<div class="container">

<!-- ==================== SECTION 1: OVERVIEW ==================== -->
<section id="overview">
  <h2><span class="icon" style="background:linear-gradient(135deg,var(--primary),var(--accent));">&#127968;</span> System Overview</h2>

  <p>Airbnb is a global marketplace connecting <strong>hosts</strong> who list properties with <strong>guests</strong> who search and book stays. The reservation system is the <em>transactional heart</em> of the platform &mdash; responsible for availability management, booking orchestration, payment processing, and ensuring <strong>no double bookings ever occur</strong>.</p>

  <div class="card-grid">
    <div class="card">
      <div class="card-header" style="color:var(--primary);">&#128100; Key Actors</div>
      <ul>
        <li><strong>Guests</strong> &mdash; Search, browse, book, pay, review</li>
        <li><strong>Hosts</strong> &mdash; List properties, set pricing, manage availability</li>
        <li><strong>Admins</strong> &mdash; Moderate content, handle disputes, analytics</li>
      </ul>
    </div>
    <div class="card">
      <div class="card-header" style="color:var(--secondary);">&#127758; Scale at a Glance</div>
      <ul>
        <li><strong>150M+</strong> users worldwide</li>
        <li><strong>7M+</strong> active listings</li>
        <li><strong>2M+</strong> people stay per night</li>
        <li><strong>220+</strong> countries & regions</li>
      </ul>
    </div>
    <div class="card">
      <div class="card-header" style="color:var(--purple);">&#9889; Core Challenges</div>
      <ul>
        <li>Prevent double-booking at scale</li>
        <li>Sub-500ms search latency</li>
        <li>Global availability with consistency</li>
        <li>Dynamic pricing in real-time</li>
      </ul>
    </div>
  </div>
</section>

<!-- ==================== SECTION 2: REQUIREMENTS ==================== -->
<section id="requirements">
  <h2><span class="icon" style="background:linear-gradient(135deg,var(--secondary),var(--blue));">&#128203;</span> Functional &amp; Non-Functional Requirements</h2>

  <h3>Functional Requirements (FR)</h3>
  <div class="card-grid">
    <div class="card" style="border-top:3px solid var(--primary);">
      <div class="card-header" style="color:var(--primary);">FR1: Property Listing Management</div>
      <ul>
        <li>Hosts can create, update, and delete property listings</li>
        <li>Upload photos, set amenities, house rules</li>
        <li>Define pricing (per night, seasonal, weekend)</li>
        <li>Set availability calendar (block/unblock dates)</li>
      </ul>
    </div>
    <div class="card" style="border-top:3px solid var(--secondary);">
      <div class="card-header" style="color:var(--secondary);">FR2: Search &amp; Discovery</div>
      <ul>
        <li>Search by location (geo-based), dates, guests count</li>
        <li>Filter by price range, property type, amenities</li>
        <li>Sort by relevance, price, rating, distance</li>
        <li>Display availability in real-time</li>
      </ul>
    </div>
    <div class="card" style="border-top:3px solid var(--blue);">
      <div class="card-header" style="color:var(--blue);">FR3: Booking &amp; Reservation</div>
      <ul>
        <li>Reserve property for date range (check-in/check-out)</li>
        <li>Prevent double booking (strong consistency)</li>
        <li>Support instant book &amp; request-to-book flows</li>
        <li>Cancellation with configurable policies</li>
      </ul>
    </div>
    <div class="card" style="border-top:3px solid var(--purple);">
      <div class="card-header" style="color:var(--purple);">FR4: Payments</div>
      <ul>
        <li>Collect payment from guest at booking</li>
        <li>Hold funds until check-in (escrow)</li>
        <li>Payout to host after stay</li>
        <li>Handle refunds on cancellation</li>
      </ul>
    </div>
    <div class="card" style="border-top:3px solid var(--accent);">
      <div class="card-header" style="color:var(--accent);">FR5: Messaging &amp; Notifications</div>
      <ul>
        <li>Guest-Host messaging (pre &amp; post booking)</li>
        <li>Push notifications, email, SMS alerts</li>
        <li>Booking confirmations &amp; reminders</li>
      </ul>
    </div>
    <div class="card" style="border-top:3px solid var(--success);">
      <div class="card-header" style="color:var(--success);">FR6: Reviews &amp; Ratings</div>
      <ul>
        <li>Guests review properties after checkout</li>
        <li>Hosts review guests</li>
        <li>Star ratings (cleanliness, accuracy, etc.)</li>
        <li>Mutual reveal after both parties submit</li>
      </ul>
    </div>
  </div>

  <h3>Non-Functional Requirements (NFR)</h3>
  <table>
    <thead>
      <tr><th>NFR</th><th>Target</th><th>Rationale</th></tr>
    </thead>
    <tbody>
      <tr><td><strong>Availability</strong></td><td>99.99% uptime</td><td>Downtime = lost bookings = lost revenue</td></tr>
      <tr><td><strong>Consistency</strong></td><td>Strong for bookings</td><td>Double booking is unacceptable &mdash; no eventual consistency for reservations</td></tr>
      <tr><td><strong>Search Latency</strong></td><td>&lt; 500ms p99</td><td>Users expect instant results</td></tr>
      <tr><td><strong>Booking Latency</strong></td><td>&lt; 2-3 seconds</td><td>End-to-end booking confirmation including payment</td></tr>
      <tr><td><strong>Scalability</strong></td><td>Horizontal</td><td>Handle 10x traffic spikes (holidays, events)</td></tr>
      <tr><td><strong>Durability</strong></td><td>Zero data loss</td><td>Financial transactions must never be lost</td></tr>
      <tr><td><strong>Security</strong></td><td>PCI-DSS, GDPR</td><td>Payment card data &amp; personal information protection</td></tr>
      <tr><td><strong>Fault Tolerance</strong></td><td>Graceful degradation</td><td>Partial failures should not bring down the system</td></tr>
    </tbody>
  </table>

  <div class="tip-box tip-interview">
    <div class="tip-title" style="color:var(--purple);">&#128161; Interview Tip: Requirements Gathering</div>
    <p>Always start by clarifying scope. Ask: "Should I design the full Airbnb platform or focus on the reservation/booking subsystem?" A principal engineer scopes aggressively. Focus on <strong>booking + search + availability</strong> as the core. Mention messaging, reviews, payments as boundaries you're aware of but won't deep-dive unless asked.</p>
  </div>
</section>

<!-- ==================== SECTION 3: CAPACITY ESTIMATES ==================== -->
<section id="estimates">
  <h2><span class="icon" style="background:linear-gradient(135deg,var(--accent),var(--warning));">&#128200;</span> Back-of-Envelope Estimates</h2>

  <h3>Step 0: Key Assumptions &amp; Where They Come From</h3>
  <div class="metric-grid">
    <div class="metric-card">
      <div class="metric-value">150M</div>
      <div class="metric-label">Total Registered Users</div>
    </div>
    <div class="metric-card">
      <div class="metric-value">10M</div>
      <div class="metric-label">DAU (Daily Active)</div>
    </div>
    <div class="metric-card">
      <div class="metric-value">7M</div>
      <div class="metric-label">Active Listings</div>
    </div>
    <div class="metric-card">
      <div class="metric-value">1.5M</div>
      <div class="metric-label">Bookings / Day</div>
    </div>
    <div class="metric-card">
      <div class="metric-value">100:1</div>
      <div class="metric-label">Read:Write Ratio</div>
    </div>
  </div>
  <div class="card" style="border-left:4px solid var(--warning);margin-top:15px;">
    <div class="card-header" style="color:var(--warning);">How to derive assumptions in an interview</div>
    <table>
      <thead>
        <tr><th>Assumption</th><th>How to Derive It</th></tr>
      </thead>
      <tbody>
        <tr><td><strong>150M total users</strong></td><td>Airbnb public data. In interview: "~150M users for a mature global marketplace. I can adjust if you'd like."</td></tr>
        <tr><td><strong>10M DAU</strong></td><td>DAU = ~6-7% of total users (industry norm for travel platforms &mdash; lower than social media ~25%).<br><code>150M &times; 0.07 &asymp; 10M</code></td></tr>
        <tr><td><strong>7M listings</strong></td><td>Public data. Alternatively: 150M users &times; ~5% are hosts = 7.5M hosts &times; ~1 listing each.</td></tr>
        <tr><td><strong>1.5M bookings/day</strong></td><td>~10% of DAU eventually books. Average booking journey is ~4 days.<br><code>10M &times; 10% &divide; 4 days &asymp; 250K</code>. But Airbnb reports ~550M bookings/year &asymp; <code>550M &divide; 365 &asymp; 1.5M/day</code>.</td></tr>
        <tr><td><strong>100:1 read:write</strong></td><td>Users search/browse ~100 times per booking. Typical for e-commerce.</td></tr>
      </tbody>
    </table>
  </div>

  <div class="tip-box tip-interview">
    <div class="tip-title" style="color:var(--purple);">&#128161; Interview Tip: Assumptions</div>
    <p>Always <strong>state assumptions explicitly</strong> and ask "Does that sound reasonable?" Interviewers want to see your reasoning process, not exact numbers. Round aggressively &mdash; use powers of 10. The goal is to reach the right <em>order of magnitude</em>.</p>
  </div>

  <!-- ============ QPS CALCULATIONS ============ -->
  <h3>Step 1: QPS Calculations (Show Your Math)</h3>

  <div class="card" style="border-left:4px solid var(--primary);margin-bottom:15px;">
    <div class="card-header" style="color:var(--primary);">&#9312; The Universal QPS Formula</div>
    <pre style="margin:8px 0;"><span class="comment">// The core formula used for EVERY QPS estimate:</span>
<span class="type">Average QPS</span> = Daily Volume &divide; Seconds in a Day
            = Daily Volume &divide; <span class="number">86,400</span>

<span class="comment">// Seconds in a day (memorize this!):</span>
<span class="number">24 hours</span> &times; <span class="number">60 min</span> &times; <span class="number">60 sec</span> = <span class="number">86,400 sec/day</span>
<span class="comment">// Round to ~100,000 for easy mental math (off by ~15%, acceptable)</span>

<span class="type">Peak QPS</span> = Average QPS &times; Peak Multiplier
<span class="comment">// Peak multiplier: 2x-3x for most systems, 5x-10x for event-driven spikes</span>
<span class="comment">// We use 3x as a safe default for steady-state peaks (evening hours, weekends)</span></pre>
  </div>

  <div class="card" style="border-left:4px solid var(--secondary);margin-bottom:15px;">
    <div class="card-header" style="color:var(--secondary);">&#9313; Search Queries QPS &mdash; Detailed Derivation</div>
    <pre style="margin:8px 0;"><span class="comment">// Step A: How many searches does each active user do per day?</span>
<span class="type">DAU</span>              = <span class="number">10,000,000</span> users
<span class="type">Searches per user</span> = <span class="number">5</span>       <span class="comment">// average user searches ~5 times per session</span>
                              <span class="comment">// (initial search + refine filters + change dates + etc.)</span>

<span class="comment">// Step B: Total daily searches</span>
<span class="type">Daily searches</span>   = <span class="number">10M</span> &times; <span class="number">5</span> = <span class="number">50,000,000</span> (<span class="number">50M</span>)

<span class="comment">// Step C: Convert to QPS</span>
<span class="type">Avg QPS</span>          = <span class="number">50,000,000</span> &divide; <span class="number">86,400</span>
                 = <span class="number">578.7</span>
                 &asymp; <span class="number">~580 QPS</span> &#9989;

<span class="comment">// Step D: Peak QPS (3x multiplier for evening/weekend surge)</span>
<span class="type">Peak QPS</span>         = <span class="number">580</span> &times; <span class="number">3</span> = <span class="number">~1,740 QPS</span> &#9989;</pre>
  </div>

  <div class="card" style="border-left:4px solid var(--blue);margin-bottom:15px;">
    <div class="card-header" style="color:var(--blue);">&#9314; Listing Views QPS &mdash; Detailed Derivation</div>
    <pre style="margin:8px 0;"><span class="comment">// Step A: For every search, user clicks on ~2 listings to view details</span>
<span class="type">Daily searches</span>          = <span class="number">50M</span>
<span class="type">Click-through rate</span>      = <span class="number">20%</span>  <span class="comment">// ~20% of results get clicked (industry avg)</span>
<span class="type">Results per search page</span> = <span class="number">20</span>

<span class="comment">// Step B: But easier to think of it as views per user per day</span>
<span class="type">Listing views per user</span>  = <span class="number">10</span>  <span class="comment">// user views ~10 listing detail pages per session</span>
<span class="type">Daily listing views</span>     = <span class="number">10M</span> &times; <span class="number">10</span> = <span class="number">100,000,000</span> (<span class="number">100M</span>)

<span class="comment">// Step C: Convert to QPS</span>
<span class="type">Avg QPS</span>                 = <span class="number">100,000,000</span> &divide; <span class="number">86,400</span>
                        = <span class="number">1,157</span>
                        &asymp; <span class="number">~1,160 QPS</span> &#9989;

<span class="comment">// Step D: Peak</span>
<span class="type">Peak QPS</span>                = <span class="number">1,160</span> &times; <span class="number">3</span> = <span class="number">~3,480 QPS</span> &#9989;

<span class="comment">// NOTE: Listing views are highly cacheable!</span>
<span class="comment">// With Redis cache (TTL=60s) + CDN, ~80% are cache hits</span>
<span class="comment">// Actual DB load: 1,160 &times; 0.2 = ~232 QPS reaching PostgreSQL</span></pre>
  </div>

  <div class="card" style="border-left:4px solid var(--accent);margin-bottom:15px;">
    <div class="card-header" style="color:var(--accent);">&#9315; Availability Checks QPS</div>
    <pre style="margin:8px 0;"><span class="comment">// When a user views a listing, they check the calendar for their dates</span>
<span class="comment">// Not every listing view triggers an availability check (some are just browsing photos)</span>

<span class="type">Daily listing views</span>        = <span class="number">100M</span>
<span class="type">% that check availability</span>  = <span class="number">30%</span>  <span class="comment">// ~30% of viewers actually pick dates</span>
<span class="type">Daily availability checks</span>  = <span class="number">100M</span> &times; <span class="number">0.3</span> = <span class="number">30,000,000</span> (<span class="number">30M</span>)

<span class="type">Avg QPS</span>    = <span class="number">30,000,000</span> &divide; <span class="number">86,400</span> = <span class="number">347</span> &asymp; <span class="number">~350 QPS</span> &#9989;
<span class="type">Peak QPS</span>   = <span class="number">350</span> &times; <span class="number">3</span> = <span class="number">~1,050 QPS</span> &#9989;</pre>
  </div>

  <div class="card" style="border-left:4px solid var(--purple);margin-bottom:15px;">
    <div class="card-header" style="color:var(--purple);">&#9316; Booking Writes TPS &mdash; The Critical Number</div>
    <pre style="margin:8px 0;"><span class="comment">// This is the MOST IMPORTANT calculation &mdash; it determines your DB choice</span>

<span class="type">Daily bookings</span>   = <span class="number">1,500,000</span> (<span class="number">1.5M</span>)

<span class="type">Avg TPS</span>          = <span class="number">1,500,000</span> &divide; <span class="number">86,400</span>
                 = <span class="number">17.36</span>
                 &asymp; <span class="number">~17 TPS</span> &#9989;

<span class="type">Peak TPS</span>         = <span class="number">17</span> &times; <span class="number">3</span> = <span class="number">~51 TPS</span> &#9989;

<span class="comment">// &#128161; WHY THIS MATTERS:</span>
<span class="comment">// PostgreSQL single instance = 10,000+ TPS capacity</span>
<span class="comment">// Our peak = 51 TPS</span>
<span class="comment">// We're using &lt;1% of a single PostgreSQL instance for writes!</span>
<span class="comment">// This means:</span>
<span class="comment">//   &#10003; NO need for database sharding</span>
<span class="comment">//   &#10003; NO need for distributed transactions (2PC, Saga)</span>
<span class="comment">//   &#10003; NO need for NoSQL</span>
<span class="comment">//   &#10003; Simple ACID transactions are MORE than sufficient</span>
<span class="comment">//   &#10003; Even pessimistic locking (SELECT...FOR UPDATE) works fine</span></pre>
  </div>

  <div class="card" style="border-left:4px solid var(--warning);margin-bottom:15px;">
    <div class="card-header" style="color:var(--warning);">&#9317; Payment Transactions &amp; Messages</div>
    <pre style="margin:8px 0;"><span class="comment">// Payment TPS = 1:1 with bookings (every booking triggers a payment)</span>
<span class="type">Payment TPS</span>      = <span class="number">~17 TPS</span> (same as bookings)
<span class="comment">// Note: Payment gateway latency (~500ms-2s) is the bottleneck, not our system</span>
<span class="comment">// Always make payment calls async with webhook callbacks</span>

<span class="comment">// Messages: Host-Guest conversations</span>
<span class="type">Active bookings per day</span>  = <span class="number">1.5M</span>
<span class="type">% with messages</span>          = <span class="number">40%</span>    <span class="comment">// ~40% of bookings involve messaging</span>
<span class="type">Messages per conversation</span> = <span class="number">~8</span>     <span class="comment">// average back-and-forth</span>
<span class="type">Daily messages</span>           = <span class="number">1.5M</span> &times; <span class="number">0.4</span> &times; <span class="number">8</span> = <span class="number">4,800,000</span> &asymp; <span class="number">~5M</span>

<span class="type">Avg QPS</span>   = <span class="number">5,000,000</span> &divide; <span class="number">86,400</span> = <span class="number">57.8</span> &asymp; <span class="number">~58 QPS</span> &#9989;
<span class="type">Peak QPS</span>  = <span class="number">58</span> &times; <span class="number">3</span> = <span class="number">~174 QPS</span> &#9989;</pre>
  </div>

  <h3>QPS Summary Table</h3>
  <table>
    <thead>
      <tr><th>Operation</th><th>Daily Volume</th><th>Formula</th><th>Avg QPS</th><th>Peak (3x)</th><th>Notes</th></tr>
    </thead>
    <tbody>
      <tr><td><strong>Search Queries</strong></td><td>50M</td><td style="color:var(--text-muted);font-size:0.85em;">10M DAU &times; 5 searches</td><td><strong>~580</strong></td><td><strong>~1,740</strong></td><td>Heaviest read path</td></tr>
      <tr><td><strong>Listing Views</strong></td><td>100M</td><td style="color:var(--text-muted);font-size:0.85em;">10M DAU &times; 10 views</td><td><strong>~1,160</strong></td><td><strong>~3,480</strong></td><td>~80% cache hits</td></tr>
      <tr><td><strong>Availability Checks</strong></td><td>30M</td><td style="color:var(--text-muted);font-size:0.85em;">100M views &times; 30%</td><td><strong>~350</strong></td><td><strong>~1,050</strong></td><td>Calendar query per listing</td></tr>
      <tr><td><strong>Booking Writes</strong></td><td>1.5M</td><td style="color:var(--text-muted);font-size:0.85em;">Given (550M/year)</td><td style="color:var(--success);"><strong>~17</strong></td><td style="color:var(--success);"><strong>~51</strong></td><td>Low! Single DB is fine.</td></tr>
      <tr><td><strong>Payment Txns</strong></td><td>1.5M</td><td style="color:var(--text-muted);font-size:0.85em;">1:1 with bookings</td><td><strong>~17</strong></td><td><strong>~51</strong></td><td>External gateway calls</td></tr>
      <tr><td><strong>Messages</strong></td><td>5M</td><td style="color:var(--text-muted);font-size:0.85em;">1.5M &times; 40% &times; 8 msgs</td><td><strong>~58</strong></td><td><strong>~174</strong></td><td>WebSocket / polling</td></tr>
      <tr style="background:rgba(255,90,95,0.08);">
        <td><strong>TOTAL (Read)</strong></td><td><strong>180M</strong></td><td></td><td><strong>~2,090</strong></td><td><strong>~6,270</strong></td><td style="color:var(--primary);">Reads dominate!</td></tr>
      <tr style="background:rgba(16,185,129,0.06);">
        <td><strong>TOTAL (Write)</strong></td><td><strong>~8M</strong></td><td></td><td><strong>~92</strong></td><td><strong>~276</strong></td><td style="color:var(--success);">Writes are tiny.</td></tr>
    </tbody>
  </table>

  <!-- ============ STORAGE CALCULATIONS ============ -->
  <h3>Step 2: Storage Estimates (Show Your Math)</h3>

  <div class="card" style="border-left:4px solid var(--primary);margin-bottom:15px;">
    <div class="card-header" style="color:var(--primary);">&#128190; Storage Formula</div>
    <pre style="margin:8px 0;"><span class="comment">// Storage = Number of Records &times; Size per Record &times; Replication Factor</span>
<span class="comment">// Always multiply by 3x for replication (primary + 2 replicas)</span>
<span class="comment">// Add 30% overhead for indexes, WAL, fragmentation</span>

<span class="type">Effective Storage</span> = Raw Size &times; <span class="number">3</span> (replicas) &times; <span class="number">1.3</span> (overhead)
                  = Raw Size &times; <span class="number">~4</span></pre>
  </div>

  <div class="card" style="border-left:4px solid var(--secondary);margin-bottom:15px;">
    <div class="card-header" style="color:var(--secondary);">&#128100; User Profiles Storage</div>
    <pre style="margin:8px 0;"><span class="type">Total users</span>       = <span class="number">150,000,000</span> (<span class="number">150M</span>)
<span class="type">Size per user</span>     = <span class="number">~5 KB</span>
<span class="comment">// Breakdown: name(100B) + email(50B) + phone(20B) + password_hash(60B)</span>
<span class="comment">//   + avatar_url(200B) + preferences_json(500B) + address(300B)</span>
<span class="comment">//   + payment_methods(500B) + timestamps(100B) + metadata(~3KB)</span>

<span class="type">Raw storage</span>       = <span class="number">150M</span> &times; <span class="number">5 KB</span> = <span class="number">750 GB</span>
<span class="type">With replication</span>  = <span class="number">750 GB</span> &times; <span class="number">3</span> = <span class="number">~2.25 TB</span>

<span class="comment">// &#128161; Fits in a SINGLE PostgreSQL instance (max ~tens of TB)</span></pre>
  </div>

  <div class="card" style="border-left:4px solid var(--blue);margin-bottom:15px;">
    <div class="card-header" style="color:var(--blue);">&#127968; Listing Data Storage</div>
    <pre style="margin:8px 0;"><span class="type">Total listings</span>    = <span class="number">7,000,000</span> (<span class="number">7M</span>)
<span class="type">Size per listing</span>  = <span class="number">~10 KB</span>  (metadata only, NOT photos)
<span class="comment">// Breakdown: title(200B) + description(2KB) + location/geo(100B)</span>
<span class="comment">//   + amenities_array(500B) + house_rules(500B) + pricing_config(300B)</span>
<span class="comment">//   + availability_365_days(365 &times; 10B = 3.6KB) + reviews_summary(500B)</span>
<span class="comment">//   + host_info(200B) + metadata(~2KB)</span>

<span class="type">Raw storage</span>       = <span class="number">7M</span> &times; <span class="number">10 KB</span> = <span class="number">70 GB</span>

<span class="comment">// But availability table is separate and grows:</span>
<span class="type">Availability rows</span> = <span class="number">7M listings</span> &times; <span class="number">365 days</span> = <span class="number">2.55 BILLION rows</span>
<span class="type">Size per row</span>      = <span class="number">~30 bytes</span> (listing_id, date, is_available, price_override)
<span class="type">Availability data</span> = <span class="number">2.55B</span> &times; <span class="number">30B</span> = <span class="number">~76 GB</span>

<span class="type">Total listing data</span> = <span class="number">70 GB</span> + <span class="number">76 GB</span> = <span class="number">~150 GB</span>
<span class="type">With replication</span>   = <span class="number">150 GB</span> &times; <span class="number">3</span> = <span class="number">~450 GB</span>

<span class="comment">// Growing at: ~500K new listings/year &times; 10KB = ~5 GB/year (trivial)</span></pre>
  </div>

  <div class="card" style="border-left:4px solid var(--purple);margin-bottom:15px;">
    <div class="card-header" style="color:var(--purple);">&#128203; Booking Records Storage</div>
    <pre style="margin:8px 0;"><span class="type">Daily bookings</span>    = <span class="number">1.5M</span>
<span class="type">Annual bookings</span>   = <span class="number">1.5M</span> &times; <span class="number">365</span> = <span class="number">~550M/year</span>
<span class="type">Keep for</span>          = <span class="number">5 years</span> (legal/tax requirements)
<span class="type">Total bookings</span>    = <span class="number">550M</span> &times; <span class="number">5</span> = <span class="number">2.75 BILLION</span>

<span class="type">Size per booking</span>  = <span class="number">~1 KB</span>
<span class="comment">// Breakdown: reservation_id(36B) + guest_id(36B) + listing_id(36B)</span>
<span class="comment">//   + check_in/out(16B) + num_guests(4B) + pricing_breakdown(200B)</span>
<span class="comment">//   + status(20B) + cancellation_info(100B) + payment_ref(100B)</span>
<span class="comment">//   + special_requests(200B) + timestamps(50B) + metadata(~200B)</span>

<span class="type">Raw storage</span>       = <span class="number">2.75B</span> &times; <span class="number">1 KB</span> = <span class="number">~2.75 TB</span>
<span class="type">With replication</span>  = <span class="number">2.75 TB</span> &times; <span class="number">3</span> = <span class="number">~8.25 TB</span>

<span class="comment">// Growing at: 550M/year &times; 1KB = ~550 GB/year</span>
<span class="comment">// &#128161; Consider archiving bookings older than 2 years to cold storage</span></pre>
  </div>

  <div class="card" style="border-left:4px solid var(--accent);margin-bottom:15px;">
    <div class="card-header" style="color:var(--accent);">&#128247; Media Storage (Photos) &mdash; The Big One</div>
    <pre style="margin:8px 0;"><span class="type">Active listings</span>      = <span class="number">7M</span>
<span class="type">Photos per listing</span>   = <span class="number">15</span> (average)
<span class="type">Avg photo size</span>       = <span class="number">250 KB</span> (compressed JPEG, multiple resolutions)
<span class="comment">// Airbnb stores multiple sizes: thumbnail(50KB), medium(150KB), full(500KB)</span>
<span class="comment">// Weighted average across sizes = ~250KB</span>

<span class="type">Total photos</span>         = <span class="number">7M</span> &times; <span class="number">15</span> = <span class="number">105M photos</span>
<span class="type">Raw media storage</span>    = <span class="number">105M</span> &times; <span class="number">250 KB</span> = <span class="number">~25 TB</span> &#9989;

<span class="comment">// S3/Blob Storage handles this natively (no replication calc needed &mdash;</span>
<span class="comment">// cloud object stores replicate internally with 11 nines durability)</span>

<span class="comment">// Growing at: 500K new listings/year &times; 15 photos &times; 250KB = ~1.8 TB/year</span>

<span class="comment">// &#128161; THIS is why media goes to S3/Blob, not PostgreSQL!</span>
<span class="comment">// 25 TB in a database = disaster. In S3 = $575/month (standard tier)</span></pre>
  </div>

  <div class="card" style="border-left:4px solid var(--success);margin-bottom:15px;">
    <div class="card-header" style="color:var(--success);">&#128269; Search Index + Messages + Cache</div>
    <pre style="margin:8px 0;"><span class="comment">// === ELASTICSEARCH INDEX ===</span>
<span class="type">Listings to index</span>    = <span class="number">7M</span>
<span class="type">Index doc size</span>       = <span class="number">~2 KB</span>  <span class="comment">// denormalized: title, description, geo, amenities, price</span>
<span class="type">Raw index</span>            = <span class="number">7M</span> &times; <span class="number">2 KB</span> = <span class="number">14 GB</span>
<span class="type">With ES overhead</span>    = <span class="number">14 GB</span> &times; <span class="number">3</span> (inverted index + stored fields) = <span class="number">~42 GB</span>
<span class="type">With replicas (3x)</span>  = <span class="number">42 GB</span> &times; <span class="number">3</span> = <span class="number">~126 GB</span>
<span class="comment">// Tiny! Elasticsearch handles this easily on 3-5 nodes</span>

<span class="comment">// === MESSAGES ===</span>
<span class="type">Daily messages</span>       = <span class="number">5M</span>
<span class="type">Size per message</span>    = <span class="number">~500 bytes</span> (text + metadata)
<span class="type">Retention</span>            = <span class="number">2 years</span>
<span class="type">Total messages</span>      = <span class="number">5M</span> &times; <span class="number">365</span> &times; <span class="number">2</span> = <span class="number">3.65B</span>
<span class="type">Raw storage</span>          = <span class="number">3.65B</span> &times; <span class="number">500B</span> = <span class="number">~1.8 TB</span>

<span class="comment">// === REDIS CACHE ===</span>
<span class="type">Strategy</span>: Cache top 20% of listings (Pareto: 20% gets 80% of views)
<span class="type">Hot listings</span>         = <span class="number">7M</span> &times; <span class="number">20%</span> = <span class="number">1.4M</span>
<span class="type">Cache entry size</span>    = <span class="number">~5 KB</span>  <span class="comment">// listing detail + availability + pricing</span>
<span class="type">Listing cache</span>       = <span class="number">1.4M</span> &times; <span class="number">5 KB</span> = <span class="number">~7 GB</span>

<span class="type">Session store</span>        = <span class="number">1M active sessions</span> &times; <span class="number">10 KB</span> = <span class="number">~10 GB</span>
<span class="type">Search result cache</span> = <span class="number">500K queries</span> &times; <span class="number">20 KB</span> = <span class="number">~10 GB</span>
<span class="type">Total Redis</span>          = <span class="number">7 + 10 + 10</span> = <span class="number">~27 GB</span>
<span class="comment">// &#128161; Fits on a single Redis node! (max ~100GB per node)</span>
<span class="comment">// Use cluster for HA, not for capacity</span></pre>
  </div>

  <h3>Storage Summary</h3>
  <div class="bar-chart">
    <div class="bar-row">
      <span class="bar-label">User Profiles</span>
      <div class="bar-track">
        <div class="bar-fill" style="width:3%;background:linear-gradient(90deg,var(--primary),var(--accent));">750 GB</div>
      </div>
    </div>
    <div class="bar-row">
      <span class="bar-label">Listings + Availability</span>
      <div class="bar-track">
        <div class="bar-fill" style="width:2%;background:linear-gradient(90deg,var(--secondary),var(--blue));">150 GB</div>
      </div>
    </div>
    <div class="bar-row">
      <span class="bar-label">Booking Records (5yr)</span>
      <div class="bar-track">
        <div class="bar-fill" style="width:10%;background:linear-gradient(90deg,var(--blue),var(--purple));">2.75 TB</div>
      </div>
    </div>
    <div class="bar-row">
      <span class="bar-label">Messages (2yr)</span>
      <div class="bar-track">
        <div class="bar-fill" style="width:7%;background:linear-gradient(90deg,var(--purple),var(--primary));">1.8 TB</div>
      </div>
    </div>
    <div class="bar-row">
      <span class="bar-label">Media (Photos)</span>
      <div class="bar-track">
        <div class="bar-fill" style="width:90%;background:linear-gradient(90deg,var(--accent),var(--warning));">~25 TB</div>
      </div>
    </div>
    <div class="bar-row">
      <span class="bar-label">Search Index (ES)</span>
      <div class="bar-track">
        <div class="bar-fill" style="width:1%;background:linear-gradient(90deg,var(--success),var(--secondary));">126 GB</div>
      </div>
    </div>
    <div class="bar-row">
      <span class="bar-label">Redis Cache</span>
      <div class="bar-track">
        <div class="bar-fill" style="width:0.5%;background:linear-gradient(90deg,var(--danger),var(--primary));">27 GB</div>
      </div>
    </div>
  </div>

  <table>
    <thead><tr><th>Data Type</th><th>Raw Size</th><th>Formula</th><th>With Replication</th><th>Growth/Year</th></tr></thead>
    <tbody>
      <tr><td><strong>Users</strong></td><td>750 GB</td><td style="color:var(--text-muted);font-size:0.85em;">150M &times; 5 KB</td><td>2.25 TB</td><td>~50 GB</td></tr>
      <tr><td><strong>Listings</strong></td><td>150 GB</td><td style="color:var(--text-muted);font-size:0.85em;">7M &times; 10KB + avail</td><td>450 GB</td><td>~5 GB</td></tr>
      <tr><td><strong>Bookings</strong></td><td>2.75 TB</td><td style="color:var(--text-muted);font-size:0.85em;">2.75B &times; 1 KB</td><td>8.25 TB</td><td>~550 GB</td></tr>
      <tr><td><strong>Messages</strong></td><td>1.8 TB</td><td style="color:var(--text-muted);font-size:0.85em;">3.65B &times; 500B</td><td>5.4 TB</td><td>~900 GB</td></tr>
      <tr><td><strong>Media</strong></td><td>25 TB</td><td style="color:var(--text-muted);font-size:0.85em;">105M &times; 250 KB</td><td>25 TB (S3)</td><td>~1.8 TB</td></tr>
      <tr><td><strong>ES Index</strong></td><td>42 GB</td><td style="color:var(--text-muted);font-size:0.85em;">7M &times; 2KB &times; 3</td><td>126 GB</td><td>~2 GB</td></tr>
      <tr><td><strong>Redis</strong></td><td>27 GB</td><td style="color:var(--text-muted);font-size:0.85em;">cache + sessions</td><td>N/A (in-mem)</td><td>grows with DAU</td></tr>
      <tr style="background:rgba(255,90,95,0.08);">
        <td><strong>TOTAL</strong></td><td colspan="2"><strong>~30.5 TB</strong> (raw)</td><td><strong>~42 TB</strong> (replicated)</td><td><strong>~3.3 TB/year</strong></td></tr>
    </tbody>
  </table>

  <!-- ============ BANDWIDTH ============ -->
  <h3>Step 3: Bandwidth Estimates</h3>
  <div class="card" style="border-left:4px solid var(--blue);">
    <pre style="margin:8px 0;"><span class="comment">// === INCOMING (Upload) ===</span>
<span class="type">Search requests</span>     = <span class="number">580 QPS</span> &times; <span class="number">~200 bytes/request</span> = <span class="number">~116 KB/s</span>
<span class="type">Booking writes</span>      = <span class="number">17 TPS</span> &times; <span class="number">~1 KB/request</span>    = <span class="number">~17 KB/s</span>
<span class="type">Photo uploads</span>       = <span class="number">~100/sec</span> &times; <span class="number">500 KB</span>          = <span class="number">~50 MB/s</span>  <span class="comment">// to S3 directly</span>
<span class="type">Total Incoming</span>      &asymp; <span class="number">~50 MB/s</span>

<span class="comment">// === OUTGOING (Download) &mdash; This is the big one ===</span>
<span class="type">Search responses</span>    = <span class="number">580 QPS</span> &times; <span class="number">~10 KB/response</span>   = <span class="number">~5.8 MB/s</span>
<span class="type">Listing page loads</span>  = <span class="number">1,160 QPS</span> &times; <span class="number">~50 KB</span>         = <span class="number">~58 MB/s</span>  <span class="comment">// JSON + thumbnails</span>
<span class="type">Photo downloads</span>     = <span class="number">~5,000/sec</span> &times; <span class="number">250 KB</span>        = <span class="number">~1.25 GB/s</span> <span class="comment">// via CDN!</span>
<span class="type">Total Outgoing</span>      &asymp; <span class="number">~1.3 GB/s</span>

<span class="comment">// &#128161; 95%+ of outgoing bandwidth is photo delivery through CDN</span>
<span class="comment">// Your origin servers only handle ~65 MB/s &mdash; very manageable</span></pre>
  </div>

  <div class="tip-box tip-interview">
    <div class="tip-title" style="color:var(--purple);">&#128161; Interview Tip: The Cheat Sheet</div>
    <p>Memorize these reference numbers for quick mental math:</p>
    <table style="margin-top:8px;">
      <tbody>
        <tr><td><strong>Seconds in a day</strong></td><td><code>86,400 &asymp; ~100K</code></td><td>Divide daily volume by 100K for quick QPS</td></tr>
        <tr><td><strong>Seconds in a month</strong></td><td><code>2.6M &asymp; ~2.5M</code></td><td>For monthly storage calculations</td></tr>
        <tr><td><strong>1 server handles</strong></td><td><code>~500-1000 QPS</code></td><td>For basic API pods (varies by workload)</td></tr>
        <tr><td><strong>PostgreSQL max</strong></td><td><code>~10,000+ TPS</code></td><td>Single instance write throughput</td></tr>
        <tr><td><strong>Redis throughput</strong></td><td><code>~100,000 ops/sec</code></td><td>Per node, simple GET/SET</td></tr>
        <tr><td><strong>80/20 rule</strong></td><td><code>Cache top 20%</code></td><td>20% of data serves 80% of requests</td></tr>
        <tr><td><strong>Replication</strong></td><td><code>&times; 3</code></td><td>Primary + 2 replicas (standard)</td></tr>
      </tbody>
    </table>
  </div>

  <h3>Infrastructure Estimates</h3>
  <table>
    <thead>
      <tr><th>Component</th><th>Azure Equivalent</th><th>Count</th><th>Sizing Rationale</th></tr>
    </thead>
    <tbody>
      <tr><td><strong>API Gateway</strong></td><td style="color:var(--blue);">Azure API Management</td><td>20-30</td><td>Handle ~5K peak QPS with headroom</td></tr>
      <tr><td><strong>Search Service Pods</strong></td><td style="color:var(--blue);">AKS (Azure Kubernetes)</td><td>15-20</td><td>CPU-intensive ranking + geo queries</td></tr>
      <tr><td><strong>Booking Service Pods</strong></td><td style="color:var(--blue);">AKS (Azure Kubernetes)</td><td>5-8</td><td>Low TPS but critical &mdash; over-provision for reliability</td></tr>
      <tr><td><strong>PostgreSQL</strong></td><td style="color:var(--blue);">Azure Database for PostgreSQL</td><td>3 clusters</td><td>Booking, User, Listing &mdash; with read replicas</td></tr>
      <tr><td><strong>Redis</strong></td><td style="color:var(--blue);">Azure Cache for Redis</td><td>10-15</td><td>~200 GB hot data + session store</td></tr>
      <tr><td><strong>Elasticsearch</strong></td><td style="color:var(--blue);">Azure AI Search</td><td>12-18</td><td>7M listings with geo + full-text index</td></tr>
      <tr><td><strong>Kafka Brokers</strong></td><td style="color:var(--blue);">Azure Event Hubs</td><td>6-9</td><td>Event streaming for async processing</td></tr>
      <tr><td><strong>CDN (CloudFront)</strong></td><td style="color:var(--blue);">Azure Front Door</td><td>200+</td><td>Global media delivery &amp; static assets</td></tr>
    </tbody>
  </table>

  <h3>Cloud Provider Mapping</h3>
  <div class="card" style="border-top:3px solid var(--blue);">
    <div class="card-header" style="color:var(--blue);">&#9729; Generic &harr; AWS &harr; Azure &harr; GCP</div>
    <table style="margin:10px 0;">
      <thead>
        <tr><th>Generic / OSS</th><th style="color:#f59e0b;">AWS</th><th style="color:#0078D4;">Azure</th><th style="color:#4285f4;">GCP</th></tr>
      </thead>
      <tbody>
        <tr><td>PostgreSQL</td><td>RDS / Aurora PostgreSQL</td><td style="color:#0078D4;">Azure DB for PostgreSQL</td><td>Cloud SQL / AlloyDB</td></tr>
        <tr><td>Elasticsearch</td><td>OpenSearch Service</td><td style="color:#0078D4;">Azure AI Search</td><td>Elastic Cloud on GCP</td></tr>
        <tr><td>Redis</td><td>ElastiCache for Redis</td><td style="color:#0078D4;">Azure Cache for Redis</td><td>Memorystore for Redis</td></tr>
        <tr><td>Kafka</td><td>Amazon MSK</td><td style="color:#0078D4;">Azure Event Hubs</td><td>Confluent / Pub/Sub</td></tr>
        <tr><td>Object Storage</td><td>S3</td><td style="color:#0078D4;">Azure Blob Storage</td><td>Cloud Storage (GCS)</td></tr>
        <tr><td>CDN</td><td>CloudFront</td><td style="color:#0078D4;">Azure Front Door</td><td>Cloud CDN</td></tr>
        <tr><td>API Gateway</td><td>API Gateway</td><td style="color:#0078D4;">Azure API Management</td><td>Apigee / API Gateway</td></tr>
        <tr><td>Kubernetes</td><td>EKS</td><td style="color:#0078D4;">AKS</td><td>GKE</td></tr>
        <tr><td>NoSQL (Alt DB)</td><td>DynamoDB</td><td style="color:#0078D4;">Cosmos DB</td><td>Firestore / Bigtable</td></tr>
        <tr><td>Monitoring</td><td>CloudWatch</td><td style="color:#0078D4;">Azure Monitor + App Insights</td><td>Cloud Monitoring</td></tr>
        <tr><td>Message Queue</td><td>SQS / SNS</td><td style="color:#0078D4;">Azure Service Bus</td><td>Pub/Sub</td></tr>
      </tbody>
    </table>
  </div>

  <div class="tip-box tip-success">
    <div class="tip-title" style="color:var(--success);">&#9989; Key Insight</div>
    <p>At ~17 write TPS for bookings, the system is <strong>overwhelmingly read-heavy</strong>. This means we do NOT need distributed transactions or complex consensus protocols for writes. Local ACID transactions on a single PostgreSQL cluster with read replicas are simpler, safer, and sufficient. Save complexity for the search path.</p>
  </div>
</section>

<!-- ==================== SECTION 4: HIGH-LEVEL DESIGN ==================== -->
<section id="hld">
  <h2><span class="icon" style="background:linear-gradient(135deg,var(--blue),var(--purple));">&#127959;</span> High-Level Architecture</h2>

  <div class="diagram-box">
    <svg viewBox="0 0 1160 800" xmlns="http://www.w3.org/2000/svg" style="font-family:Segoe UI,sans-serif;">
      <defs>
        <linearGradient id="g1" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#FF5A5F;stop-opacity:0.9"/>
          <stop offset="100%" style="stop-color:#E04850;stop-opacity:0.9"/>
        </linearGradient>
        <linearGradient id="g2" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#00A699;stop-opacity:0.9"/>
          <stop offset="100%" style="stop-color:#008B80;stop-opacity:0.9"/>
        </linearGradient>
        <linearGradient id="g3" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#428BF9;stop-opacity:0.9"/>
          <stop offset="100%" style="stop-color:#3070D0;stop-opacity:0.9"/>
        </linearGradient>
        <linearGradient id="g4" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#7B2FF7;stop-opacity:0.9"/>
          <stop offset="100%" style="stop-color:#6020C0;stop-opacity:0.9"/>
        </linearGradient>
        <linearGradient id="g5" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#FC642D;stop-opacity:0.9"/>
          <stop offset="100%" style="stop-color:#D04E20;stop-opacity:0.9"/>
        </linearGradient>
        <!-- Database cylinder gradient -->
        <linearGradient id="dbBlue" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style="stop-color:#5b9bf5;stop-opacity:1"/>
          <stop offset="100%" style="stop-color:#336dc9;stop-opacity:1"/>
        </linearGradient>
        <linearGradient id="dbRed" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style="stop-color:#ff7a7e;stop-opacity:1"/>
          <stop offset="100%" style="stop-color:#d94448;stop-opacity:1"/>
        </linearGradient>
        <linearGradient id="dbGreen" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style="stop-color:#2dd4b8;stop-opacity:1"/>
          <stop offset="100%" style="stop-color:#008B80;stop-opacity:1"/>
        </linearGradient>
        <linearGradient id="redisGrad" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style="stop-color:#ff4438;stop-opacity:1"/>
          <stop offset="100%" style="stop-color:#b71c1c;stop-opacity:1"/>
        </linearGradient>
        <linearGradient id="s3Grad" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style="stop-color:#4caf50;stop-opacity:1"/>
          <stop offset="100%" style="stop-color:#2e7d32;stop-opacity:1"/>
        </linearGradient>
        <linearGradient id="kafkaGrad" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#374151;stop-opacity:1"/>
          <stop offset="100%" style="stop-color:#6b7280;stop-opacity:1"/>
        </linearGradient>
        <filter id="shadow">
          <feDropShadow dx="2" dy="3" stdDeviation="4" flood-opacity="0.12"/>
        </filter>
        <filter id="glow">
          <feGaussianBlur stdDeviation="2" result="blur"/>
          <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
        </filter>
        <!-- Arrowhead marker -->
        <marker id="arrow" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
          <path d="M0,0 L8,3 L0,6 Z" fill="#94a3b8"/>
        </marker>
        <marker id="arrowRed" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
          <path d="M0,0 L8,3 L0,6 Z" fill="#ef4444"/>
        </marker>
        <marker id="arrowGreen" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
          <path d="M0,0 L8,3 L0,6 Z" fill="#00A699"/>
        </marker>
        <marker id="arrowBlue" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
          <path d="M0,0 L8,3 L0,6 Z" fill="#428BF9"/>
        </marker>
        <marker id="arrowPurple" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
          <path d="M0,0 L8,3 L0,6 Z" fill="#7B2FF7"/>
        </marker>
        <marker id="arrowOrange" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
          <path d="M0,0 L8,3 L0,6 Z" fill="#f59e0b"/>
        </marker>
      </defs>

      <!-- ======================== CLIENTS ======================== -->
      <text x="105" y="22" fill="#1e293b" font-size="13" font-weight="700" text-anchor="middle" letter-spacing="2">CLIENTS</text>

      <!-- Web Browser icon (monitor) -->
      <g filter="url(#shadow)">
        <rect x="25" y="38" width="60" height="42" rx="5" fill="#f8fafc" stroke="#FF5A5F" stroke-width="2"/>
        <rect x="30" y="43" width="50" height="28" rx="2" fill="#f1f5f9" stroke="#FF5A5F" stroke-width="1"/>
        <line x1="55" y1="80" x2="55" y2="90" stroke="#94a3b8" stroke-width="2"/>
        <line x1="40" y1="90" x2="70" y2="90" stroke="#94a3b8" stroke-width="2" stroke-linecap="round"/>
        <!-- browser chrome dots -->
        <circle cx="36" cy="49" r="2" fill="#ef4444"/><circle cx="42" cy="49" r="2" fill="#f59e0b"/><circle cx="48" cy="49" r="2" fill="#10b981"/>
      </g>
      <text x="55" y="105" fill="#94a3b8" font-size="10" text-anchor="middle">Web App</text>

      <!-- Mobile phone icon -->
      <g filter="url(#shadow)">
        <rect x="115" y="38" width="36" height="58" rx="6" fill="#f8fafc" stroke="#FF5A5F" stroke-width="2"/>
        <rect x="120" y="48" width="26" height="34" rx="1" fill="#f1f5f9"/>
        <circle cx="133" cy="89" r="3" fill="none" stroke="#94a3b8" stroke-width="1"/>
        <line x1="127" y1="44" x2="139" y2="44" stroke="#94a3b8" stroke-width="1" stroke-linecap="round"/>
      </g>
      <text x="133" y="105" fill="#94a3b8" font-size="10" text-anchor="middle">Mobile</text>

      <!-- ======================== CDN (Globe icon) ======================== -->
      <g transform="translate(55, 128)">
        <circle cx="50" cy="18" r="16" fill="none" stroke="#f59e0b" stroke-width="1.5"/>
        <ellipse cx="50" cy="18" rx="8" ry="16" fill="none" stroke="#f59e0b" stroke-width="1"/>
        <line x1="34" y1="12" x2="66" y2="12" stroke="#f59e0b" stroke-width="0.8"/>
        <line x1="34" y1="24" x2="66" y2="24" stroke="#f59e0b" stroke-width="0.8"/>
        <text x="50" y="46" fill="#f59e0b" font-size="10" font-weight="600" text-anchor="middle">CDN (CloudFront)</text>
        <text x="50" y="57" fill="#0078D4" font-size="7" font-weight="600" text-anchor="middle">Azure: Front Door</text>
      </g>

      <!-- Arrow CDN -> LB -->
      <line x1="105" y1="185" x2="105" y2="205" stroke="#94a3b8" stroke-width="2" marker-end="url(#arrow)"/>

      <!-- ======================== LOAD BALANCER (split arrows icon) ======================== -->
      <g transform="translate(55, 208)">
        <!-- LB box -->
        <rect x="0" y="0" width="100" height="38" rx="8" fill="#f8fafc" stroke="#10b981" stroke-width="2" filter="url(#shadow)"/>
        <!-- split arrow icon inside -->
        <line x1="30" y1="19" x2="45" y2="19" stroke="#10b981" stroke-width="2"/>
        <line x1="45" y1="19" x2="60" y2="10" stroke="#10b981" stroke-width="2" marker-end="url(#arrowGreen)"/>
        <line x1="45" y1="19" x2="60" y2="28" stroke="#10b981" stroke-width="2" marker-end="url(#arrowGreen)"/>
        <text x="50" y="52" fill="#10b981" font-size="10" font-weight="600" text-anchor="middle">Load Balancer (L7)</text>
      </g>

      <!-- Arrow LB -> API GW -->
      <line x1="105" y1="270" x2="105" y2="290" stroke="#94a3b8" stroke-width="2" marker-end="url(#arrow)"/>

      <!-- ======================== API GATEWAY ======================== -->
      <g filter="url(#shadow)">
        <rect x="15" y="293" width="180" height="48" rx="10" fill="url(#g1)"/>
        <!-- Gateway icon (shield) -->
        <path d="M38,307 L38,325 Q38,332 48,336 Q58,332 58,325 L58,307 Q48,303 38,307 Z" fill="none" stroke="rgba(0,0,0,0.5)" stroke-width="1.5"/>
        <text x="48" y="324" fill="white" font-size="10" text-anchor="middle">&#10003;</text>
        <text x="115" y="313" fill="white" font-size="13" font-weight="700" text-anchor="middle">API Gateway</text>
        <text x="115" y="330" fill="rgba(255,255,255,0.8)" font-size="9" text-anchor="middle">Auth | Rate Limit | Routing</text>
      </g>

      <!-- ======================== CONNECTION LINES TO SERVICES ======================== -->
      <line x1="195" y1="317" x2="296" y2="130" stroke="#00A699" stroke-width="1.8" marker-end="url(#arrowGreen)"/>
      <line x1="195" y1="317" x2="296" y2="240" stroke="#428BF9" stroke-width="1.8" marker-end="url(#arrowBlue)"/>
      <line x1="195" y1="317" x2="296" y2="350" stroke="#FF5A5F" stroke-width="1.8" marker-end="url(#arrow)"/>
      <line x1="195" y1="317" x2="296" y2="460" stroke="#7B2FF7" stroke-width="1.8" marker-end="url(#arrowPurple)"/>
      <line x1="195" y1="317" x2="296" y2="570" stroke="#FC642D" stroke-width="1.8" marker-end="url(#arrowOrange)"/>

      <!-- ======================== MICROSERVICES (Server/Container icons) ======================== -->
      <text x="385" y="22" fill="#1e293b" font-size="13" font-weight="700" text-anchor="middle" letter-spacing="2">SERVICES</text>

      <!-- Search Service -->
      <g filter="url(#shadow)">
        <rect x="300" y="95" width="170" height="62" rx="10" fill="url(#g2)"/>
        <!-- magnifying glass icon -->
        <circle cx="322" cy="118" r="9" fill="none" stroke="rgba(0,0,0,0.6)" stroke-width="2"/>
        <line x1="329" y1="124" x2="336" y2="131" stroke="rgba(0,0,0,0.6)" stroke-width="2" stroke-linecap="round"/>
        <text x="400" y="120" fill="white" font-size="12" font-weight="700" text-anchor="middle">Search Service</text>
        <text x="400" y="138" fill="rgba(255,255,255,0.8)" font-size="9" text-anchor="middle">Geo | Filters | Ranking</text>
      </g>

      <!-- Booking Service -->
      <g filter="url(#shadow)">
        <rect x="300" y="205" width="170" height="62" rx="10" fill="url(#g3)"/>
        <!-- calendar icon -->
        <rect x="314" y="218" width="18" height="16" rx="2" fill="none" stroke="rgba(0,0,0,0.6)" stroke-width="1.5"/>
        <line x1="314" y1="224" x2="332" y2="224" stroke="rgba(0,0,0,0.6)" stroke-width="1.5"/>
        <line x1="319" y1="215" x2="319" y2="219" stroke="rgba(0,0,0,0.6)" stroke-width="1.5" stroke-linecap="round"/>
        <line x1="327" y1="215" x2="327" y2="219" stroke="rgba(0,0,0,0.6)" stroke-width="1.5" stroke-linecap="round"/>
        <text x="400" y="232" fill="white" font-size="12" font-weight="700" text-anchor="middle">Booking Service</text>
        <text x="400" y="250" fill="rgba(255,255,255,0.8)" font-size="9" text-anchor="middle">Reserve | Cancel | Modify</text>
      </g>

      <!-- Listing Service -->
      <g filter="url(#shadow)">
        <rect x="300" y="315" width="170" height="62" rx="10" fill="url(#g1)"/>
        <!-- house icon -->
        <path d="M323,348 L314,340 L323,332 L332,340 Z" fill="none" stroke="rgba(0,0,0,0.6)" stroke-width="1.5"/>
        <rect x="318" y="340" width="10" height="8" fill="none" stroke="rgba(0,0,0,0.6)" stroke-width="1.5"/>
        <text x="400" y="342" fill="white" font-size="12" font-weight="700" text-anchor="middle">Listing Service</text>
        <text x="400" y="360" fill="rgba(255,255,255,0.8)" font-size="9" text-anchor="middle">CRUD | Pricing | Calendar</text>
      </g>

      <!-- Payment Service -->
      <g filter="url(#shadow)">
        <rect x="300" y="425" width="170" height="62" rx="10" fill="url(#g4)"/>
        <!-- credit card icon -->
        <rect x="312" y="443" width="22" height="15" rx="2" fill="none" stroke="rgba(0,0,0,0.6)" stroke-width="1.5"/>
        <line x1="312" y1="449" x2="334" y2="449" stroke="rgba(0,0,0,0.6)" stroke-width="1.5"/>
        <line x1="316" y1="454" x2="324" y2="454" stroke="rgba(0,0,0,0.4)" stroke-width="1"/>
        <text x="400" y="452" fill="white" font-size="12" font-weight="700" text-anchor="middle">Payment Service</text>
        <text x="400" y="470" fill="rgba(255,255,255,0.8)" font-size="9" text-anchor="middle">Charge | Refund | Payout</text>
      </g>

      <!-- User Service -->
      <g filter="url(#shadow)">
        <rect x="300" y="535" width="170" height="62" rx="10" fill="url(#g5)"/>
        <!-- person icon -->
        <circle cx="323" cy="554" r="6" fill="none" stroke="rgba(0,0,0,0.6)" stroke-width="1.5"/>
        <path d="M313,574 Q313,564 323,564 Q333,564 333,574" fill="none" stroke="rgba(0,0,0,0.6)" stroke-width="1.5"/>
        <text x="400" y="562" fill="white" font-size="12" font-weight="700" text-anchor="middle">User Service</text>
        <text x="400" y="580" fill="rgba(255,255,255,0.8)" font-size="9" text-anchor="middle">Auth | Profile | Identity</text>
      </g>

      <!-- Notification Service -->
      <g filter="url(#shadow)">
        <rect x="300" y="640" width="170" height="52" rx="10" fill="#f8fafc" stroke="#f59e0b" stroke-width="2"/>
        <!-- bell icon -->
        <path d="M323,654 Q323,648 329,648 Q335,648 335,654 L337,664 L321,664 Z" fill="none" stroke="#f59e0b" stroke-width="1.5"/>
        <circle cx="329" cy="668" r="2" fill="#f59e0b"/>
        <text x="400" y="662" fill="#f59e0b" font-size="11" font-weight="700" text-anchor="middle">Notification Service</text>
        <text x="400" y="678" fill="#94a3b8" font-size="9" text-anchor="middle">Email | SMS | Push</text>
      </g>

      <!-- ======================== AZURE EVENT HUBS ======================== -->
      <g transform="translate(538, 395)" filter="url(#shadow)">
        <rect x="0" y="0" width="175" height="70" rx="12" fill="#f8fafc" stroke="#ef4444" stroke-width="2.5"/>
        <!-- Kafka streaming icon -->
        <!-- Hub nodes -->
        <circle cx="28" cy="24" r="6" fill="#ef4444" opacity="0.9"/>
        <circle cx="28" cy="46" r="6" fill="#ef4444" opacity="0.7"/>
        <circle cx="48" cy="35" r="6" fill="#ef4444" opacity="0.8"/>
        <!-- connection lines between nodes -->
        <line x1="34" y1="24" x2="42" y2="32" stroke="#ef4444" stroke-width="1.5" opacity="0.6"/>
        <line x1="34" y1="46" x2="42" y2="38" stroke="#ef4444" stroke-width="1.5" opacity="0.6"/>
        <!-- streaming arrows -->
        <line x1="54" y1="35" x2="65" y2="28" stroke="#ef4444" stroke-width="1" opacity="0.5"/>
        <line x1="54" y1="35" x2="65" y2="35" stroke="#ef4444" stroke-width="1" opacity="0.5"/>
        <line x1="54" y1="35" x2="65" y2="42" stroke="#ef4444" stroke-width="1" opacity="0.5"/>
        <text x="125" y="22" fill="#ef4444" font-size="13" font-weight="800" text-anchor="middle">Kafka</text>
        <text x="125" y="36" fill="#0078D4" font-size="8" font-weight="600" text-anchor="middle">Azure: Event Hubs</text>
        <text x="125" y="50" fill="#94a3b8" font-size="8" text-anchor="middle">Event Streaming</text>
        <text x="125" y="62" fill="#94a3b8" font-size="7" text-anchor="middle">Async Events &amp; CDC</text>
      </g>

      <!-- Arrows services -> Kafka -->
      <line x1="470" y1="240" x2="538" y2="420" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="6,3" marker-end="url(#arrowRed)"/>
      <line x1="470" y1="350" x2="538" y2="425" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="6,3" marker-end="url(#arrowRed)"/>
      <line x1="470" y1="460" x2="538" y2="435" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="6,3" marker-end="url(#arrowRed)"/>
      <!-- Kafka -> Notification -->
      <line x1="538" y1="450" x2="470" y2="656" stroke="#f59e0b" stroke-width="1.5" stroke-dasharray="6,3" marker-end="url(#arrowOrange)"/>

      <!-- ======================== DATA LAYER ======================== -->
      <text x="905" y="22" fill="#1e293b" font-size="13" font-weight="700" text-anchor="middle" letter-spacing="2">DATA LAYER</text>

      <!-- ======= Elasticsearch (magnifying glass + index icon) ======= -->
      <g transform="translate(790, 60)" filter="url(#shadow)">
        <rect x="0" y="0" width="190" height="70" rx="12" fill="#f8fafc" stroke="#00A699" stroke-width="2"/>
        <!-- ES logo-style: layered circles -->
        <circle cx="32" cy="24" r="12" fill="none" stroke="#00A699" stroke-width="2" opacity="0.4"/>
        <circle cx="32" cy="24" r="8" fill="none" stroke="#00A699" stroke-width="2" opacity="0.7"/>
        <circle cx="32" cy="24" r="4" fill="#00A699"/>
        <!-- index bars -->
        <rect x="22" y="42" width="20" height="3" rx="1" fill="#00A699" opacity="0.6"/>
        <rect x="22" y="48" width="14" height="3" rx="1" fill="#00A699" opacity="0.4"/>
        <rect x="22" y="54" width="17" height="3" rx="1" fill="#00A699" opacity="0.5"/>
        <text x="120" y="22" fill="#00A699" font-size="12" font-weight="700" text-anchor="middle">Elasticsearch</text>
        <text x="120" y="36" fill="#0078D4" font-size="8" font-weight="600" text-anchor="middle">Azure: AI Search</text>
        <text x="120" y="50" fill="#94a3b8" font-size="8" text-anchor="middle">Full-Text + Geo Search</text>
        <text x="120" y="62" fill="#94a3b8" font-size="7" text-anchor="middle">7M listings indexed</text>
      </g>
      <line x1="470" y1="126" x2="790" y2="90" stroke="#00A699" stroke-width="1.8" stroke-dasharray="6,3" marker-end="url(#arrowGreen)"/>

      <!-- ======= PostgreSQL Booking DB (cylinder) ======= -->
      <g transform="translate(790, 160)" filter="url(#shadow)">
        <rect x="0" y="0" width="190" height="70" rx="12" fill="#f8fafc" stroke="#428BF9" stroke-width="2"/>
        <!-- Database cylinder -->
        <ellipse cx="32" cy="18" rx="14" ry="6" fill="url(#dbBlue)" opacity="0.8"/>
        <rect x="18" y="18" width="28" height="28" fill="#f8fafc"/>
        <rect x="18" y="18" width="28" height="28" fill="url(#dbBlue)" opacity="0.3"/>
        <line x1="18" y1="18" x2="18" y2="46" stroke="#428BF9" stroke-width="1.5"/>
        <line x1="46" y1="18" x2="46" y2="46" stroke="#428BF9" stroke-width="1.5"/>
        <ellipse cx="32" cy="46" rx="14" ry="6" fill="url(#dbBlue)" opacity="0.6"/>
        <ellipse cx="32" cy="32" rx="14" ry="5" fill="none" stroke="#428BF9" stroke-width="0.8" opacity="0.4"/>
        <!-- PostgreSQL elephant tiny hint -->
        <text x="32" y="36" fill="white" font-size="8" text-anchor="middle" opacity="0.6">PG</text>
        <text x="120" y="20" fill="#428BF9" font-size="12" font-weight="700" text-anchor="middle">PostgreSQL</text>
        <text x="120" y="34" fill="#0078D4" font-size="8" font-weight="600" text-anchor="middle">Azure: DB for PostgreSQL</text>
        <text x="120" y="48" fill="#1e293b" font-size="8" text-anchor="middle">Bookings + Availability</text>
        <text x="120" y="60" fill="#94a3b8" font-size="7" text-anchor="middle">ACID | Primary + Replicas</text>
      </g>
      <line x1="470" y1="240" x2="790" y2="195" stroke="#428BF9" stroke-width="1.8" stroke-dasharray="6,3" marker-end="url(#arrowBlue)"/>

      <!-- ======= PostgreSQL Listings DB (cylinder) ======= -->
      <g transform="translate(790, 260)" filter="url(#shadow)">
        <rect x="0" y="0" width="190" height="70" rx="12" fill="#f8fafc" stroke="#FF5A5F" stroke-width="2"/>
        <!-- Database cylinder -->
        <ellipse cx="32" cy="18" rx="14" ry="6" fill="url(#dbRed)" opacity="0.8"/>
        <rect x="18" y="18" width="28" height="28" fill="#f8fafc"/>
        <rect x="18" y="18" width="28" height="28" fill="url(#dbRed)" opacity="0.3"/>
        <line x1="18" y1="18" x2="18" y2="46" stroke="#FF5A5F" stroke-width="1.5"/>
        <line x1="46" y1="18" x2="46" y2="46" stroke="#FF5A5F" stroke-width="1.5"/>
        <ellipse cx="32" cy="46" rx="14" ry="6" fill="url(#dbRed)" opacity="0.6"/>
        <ellipse cx="32" cy="32" rx="14" ry="5" fill="none" stroke="#FF5A5F" stroke-width="0.8" opacity="0.4"/>
        <text x="32" y="36" fill="white" font-size="8" text-anchor="middle" opacity="0.6">PG</text>
        <text x="120" y="20" fill="#FF5A5F" font-size="12" font-weight="700" text-anchor="middle">PostgreSQL</text>
        <text x="120" y="34" fill="#0078D4" font-size="8" font-weight="600" text-anchor="middle">Azure: DB for PostgreSQL</text>
        <text x="120" y="48" fill="#1e293b" font-size="8" text-anchor="middle">Listings + Users</text>
        <text x="120" y="60" fill="#94a3b8" font-size="7" text-anchor="middle">PostGIS | Read Replicas</text>
      </g>
      <line x1="470" y1="350" x2="790" y2="295" stroke="#FF5A5F" stroke-width="1.8" stroke-dasharray="6,3"/>
      <line x1="470" y1="566" x2="790" y2="300" stroke="#FC642D" stroke-width="1.5" stroke-dasharray="6,3"/>

      <!-- ======= Redis (diamond shape) ======= -->
      <g transform="translate(790, 360)" filter="url(#shadow)">
        <rect x="0" y="0" width="190" height="70" rx="12" fill="#f8fafc" stroke="#ef4444" stroke-width="2"/>
        <!-- Redis diamond logo -->
        <polygon points="32,12 48,35 32,58 16,35" fill="none" stroke="#ef4444" stroke-width="2"/>
        <polygon points="32,20 42,35 32,50 22,35" fill="url(#redisGrad)" opacity="0.5"/>
        <!-- star in center -->
        <text x="32" y="39" fill="white" font-size="10" text-anchor="middle">&#10022;</text>
        <text x="120" y="20" fill="#ef4444" font-size="12" font-weight="700" text-anchor="middle">Redis</text>
        <text x="120" y="34" fill="#0078D4" font-size="8" font-weight="600" text-anchor="middle">Azure: Cache for Redis</text>
        <text x="120" y="48" fill="#1e293b" font-size="8" text-anchor="middle">Cache + Sessions + Locks</text>
        <text x="120" y="60" fill="#94a3b8" font-size="7" text-anchor="middle">~200 GB hot data</text>
      </g>

      <!-- ======= S3 / Object Store (bucket icon) ======= -->
      <g transform="translate(790, 460)" filter="url(#shadow)">
        <rect x="0" y="0" width="190" height="70" rx="12" fill="#f8fafc" stroke="#4caf50" stroke-width="2"/>
        <!-- Blob Storage icon -->
        <path d="M18,16 L46,16 L42,56 L22,56 Z" fill="url(#s3Grad)" opacity="0.4" stroke="#4caf50" stroke-width="1.5"/>
        <ellipse cx="32" cy="16" rx="14" ry="4" fill="url(#s3Grad)" opacity="0.6"/>
        <ellipse cx="32" cy="56" rx="10" ry="3" fill="url(#s3Grad)" opacity="0.5"/>
        <!-- Blob text inside -->
        <text x="32" y="40" fill="white" font-size="9" font-weight="700" text-anchor="middle">S3</text>
        <text x="120" y="20" fill="#4caf50" font-size="12" font-weight="700" text-anchor="middle">S3 / Object Store</text>
        <text x="120" y="34" fill="#0078D4" font-size="8" font-weight="600" text-anchor="middle">Azure: Blob Storage</text>
        <text x="120" y="48" fill="#1e293b" font-size="8" text-anchor="middle">Images, Media, Docs</text>
        <text x="120" y="60" fill="#94a3b8" font-size="7" text-anchor="middle">~25 TB | CDN origin</text>
      </g>

      <!-- ======= Payment Gateway (external cloud) ======= -->
      <g transform="translate(790, 560)" filter="url(#shadow)">
        <rect x="0" y="0" width="190" height="70" rx="12" fill="#f8fafc" stroke="#7B2FF7" stroke-width="2"/>
        <!-- Cloud shape for external service -->
        <ellipse cx="28" cy="40" rx="12" ry="9" fill="none" stroke="#7B2FF7" stroke-width="1.5" opacity="0.6"/>
        <ellipse cx="38" cy="32" rx="10" ry="8" fill="none" stroke="#7B2FF7" stroke-width="1.5" opacity="0.6"/>
        <ellipse cx="20" cy="34" rx="8" ry="7" fill="none" stroke="#7B2FF7" stroke-width="1.5" opacity="0.6"/>
        <!-- lock icon -->
        <rect x="26" y="36" width="8" height="7" rx="1" fill="#7B2FF7" opacity="0.5"/>
        <path d="M28,36 L28,33 Q30,30 32,33 L32,36" fill="none" stroke="#7B2FF7" stroke-width="1"/>
        <text x="120" y="24" fill="#7B2FF7" font-size="13" font-weight="700" text-anchor="middle">Payment Gateway</text>
        <text x="120" y="40" fill="#1e293b" font-size="9" text-anchor="middle">Stripe / Braintree</text>
        <text x="120" y="56" fill="#94a3b8" font-size="8" text-anchor="middle">External | PCI-DSS</text>
      </g>
      <line x1="470" y1="460" x2="790" y2="595" stroke="#7B2FF7" stroke-width="1.8" stroke-dasharray="6,3" marker-end="url(#arrowPurple)"/>

      <!-- Kafka -> Elasticsearch (index sync) -->
      <path d="M730,430 Q770,300 790,95" fill="none" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrowRed)"/>
      <text x="765" y="260" fill="#ef4444" font-size="9" font-weight="600" transform="rotate(-75,765,260)">index sync (CDC)</text>

      <!-- ======================== NUMBERED REQUEST FLOW ======================== -->
      <!-- Step 1: Client -> CDN -->
      <circle cx="72" cy="118" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/>
      <text x="72" y="122" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">1</text>

      <!-- Step 2: CDN -> Load Balancer -->
      <circle cx="118" cy="198" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/>
      <text x="118" y="202" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">2</text>

      <!-- Step 3: LB -> API Gateway -->
      <circle cx="118" cy="280" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/>
      <text x="118" y="284" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">3</text>

      <!-- Step 4: API GW -> Search Service -->
      <circle cx="238" cy="210" r="10" fill="#00A699" stroke="#fff" stroke-width="1.5"/>
      <text x="238" y="214" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">4</text>

      <!-- Step 5: Search -> Elasticsearch -->
      <circle cx="630" cy="100" r="10" fill="#00A699" stroke="#fff" stroke-width="1.5"/>
      <text x="630" y="104" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">5</text>

      <!-- Step 6: API GW -> Booking Service -->
      <circle cx="240" cy="275" r="10" fill="#428BF9" stroke="#fff" stroke-width="1.5"/>
      <text x="240" y="279" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">6</text>

      <!-- Step 7: Booking -> PostgreSQL -->
      <circle cx="630" cy="210" r="10" fill="#428BF9" stroke="#fff" stroke-width="1.5"/>
      <text x="630" y="214" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">7</text>

      <!-- Step 8: API GW -> Payment Service -->
      <circle cx="240" cy="396" r="10" fill="#7B2FF7" stroke="#fff" stroke-width="1.5"/>
      <text x="240" y="400" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">8</text>

      <!-- Step 9: Payment -> Payment Gateway (Stripe) -->
      <circle cx="630" cy="530" r="10" fill="#7B2FF7" stroke="#fff" stroke-width="1.5"/>
      <text x="630" y="534" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">9</text>

      <!-- Step 10: Booking -> Kafka (event emit) -->
      <circle cx="500" cy="340" r="10" fill="#ef4444" stroke="#fff" stroke-width="1.5"/>
      <text x="500" y="344" fill="#fff" font-size="9" font-weight="800" text-anchor="middle">10</text>

      <!-- Step 11: Kafka -> Notification Service -->
      <circle cx="496" cy="560" r="10" fill="#f59e0b" stroke="#fff" stroke-width="1.5"/>
      <text x="496" y="564" fill="#fff" font-size="9" font-weight="800" text-anchor="middle">11</text>

      <!-- Step 12: Kafka -> ES (CDC index sync) -->
      <circle cx="776" cy="220" r="10" fill="#ef4444" stroke="#fff" stroke-width="1.5"/>
      <text x="776" y="224" fill="#fff" font-size="9" font-weight="800" text-anchor="middle">12</text>

      <!-- ======================== LEGEND ======================== -->
      <rect x="790" y="665" width="330" height="125" rx="12" fill="#f8fafc" stroke="#334155" stroke-width="1.5"/>
      <text x="815" y="688" fill="#1e293b" font-size="11" font-weight="700">LEGEND</text>
      <!-- Sync line -->
      <line x1="815" y1="702" x2="850" y2="702" stroke="#94a3b8" stroke-width="2.5"/>
      <polygon points="848,699 855,702 848,705" fill="#94a3b8"/>
      <text x="865" y="706" fill="#94a3b8" font-size="10">Synchronous Request</text>
      <!-- Async line -->
      <line x1="815" y1="722" x2="850" y2="722" stroke="#ef4444" stroke-width="2" stroke-dasharray="6,3"/>
      <polygon points="848,719 855,722 848,725" fill="#ef4444"/>
      <text x="865" y="726" fill="#94a3b8" font-size="10">Async / Event-Driven</text>
      <!-- Service icon -->
      <rect x="815" y="736" width="16" height="12" rx="3" fill="url(#g2)"/>
      <text x="865" y="748" fill="#94a3b8" font-size="10">Microservice</text>
      <!-- DB icon -->
      <ellipse cx="823" cy="758" rx="8" ry="3" fill="#428BF9" opacity="0.6"/>
      <rect x="815" y="758" width="16" height="6" fill="#f8fafc" stroke="#428BF9" stroke-width="0.8"/>
      <text x="865" y="766" fill="#94a3b8" font-size="10">Database (Cylinder)</text>
      <!-- Numbered flow icon -->
      <circle cx="823" cy="778" r="7" fill="#FF5A5F" stroke="#fff" stroke-width="1"/>
      <text x="823" y="782" fill="#fff" font-size="8" font-weight="800" text-anchor="middle">N</text>
      <text x="865" y="783" fill="#94a3b8" font-size="10">Request Flow Step (see table below)</text>
    </svg>
  </div>

  <!-- ======= REQUEST FLOW REFERENCE TABLE ======= -->
  <h3>Request Flow Reference (Numbers on Diagram)</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th style="width:50px;">#</th>
          <th>From &rarr; To</th>
          <th>Protocol</th>
          <th>What Happens</th>
          <th>Latency</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="text-align:center;"><span style="display:inline-block;width:22px;height:22px;border-radius:50%;background:#FF5A5F;color:#fff;text-align:center;line-height:22px;font-weight:800;font-size:11px;">1</span></td>
          <td><strong>Client &rarr; CDN</strong></td>
          <td>HTTPS</td>
          <td>Static assets (JS/CSS bundles), listing images, and cached search results served from edge PoPs closest to user</td>
          <td>5&ndash;30 ms</td>
        </tr>
        <tr>
          <td style="text-align:center;"><span style="display:inline-block;width:22px;height:22px;border-radius:50%;background:#FF5A5F;color:#fff;text-align:center;line-height:22px;font-weight:800;font-size:11px;">2</span></td>
          <td><strong>CDN &rarr; Load Balancer</strong></td>
          <td>HTTPS</td>
          <td>Cache miss or dynamic API request forwarded to origin. L7 LB distributes across API Gateway instances (round-robin / least-connections)</td>
          <td>10&ndash;50 ms</td>
        </tr>
        <tr>
          <td style="text-align:center;"><span style="display:inline-block;width:22px;height:22px;border-radius:50%;background:#FF5A5F;color:#fff;text-align:center;line-height:22px;font-weight:800;font-size:11px;">3</span></td>
          <td><strong>Load Balancer &rarr; API Gateway</strong></td>
          <td>HTTPS/gRPC</td>
          <td>JWT validation, rate limiting (per-user + global), request routing to target microservice, request/response logging</td>
          <td>2&ndash;5 ms</td>
        </tr>
        <tr>
          <td style="text-align:center;"><span style="display:inline-block;width:22px;height:22px;border-radius:50%;background:#00A699;color:#fff;text-align:center;line-height:22px;font-weight:800;font-size:11px;">4</span></td>
          <td><strong>API Gateway &rarr; Search Service</strong></td>
          <td>gRPC</td>
          <td>Forward search query with filters (location, dates, price, amenities). Search Service builds Elasticsearch DSL query</td>
          <td>1&ndash;3 ms</td>
        </tr>
        <tr>
          <td style="text-align:center;"><span style="display:inline-block;width:22px;height:22px;border-radius:50%;background:#00A699;color:#fff;text-align:center;line-height:22px;font-weight:800;font-size:11px;">5</span></td>
          <td><strong>Search Service &rarr; Elasticsearch</strong></td>
          <td>HTTP (REST)</td>
          <td>Execute geo_distance + bool filter + date range availability query. Return top-N scored results with highlights</td>
          <td>20&ndash;200 ms</td>
        </tr>
        <tr>
          <td style="text-align:center;"><span style="display:inline-block;width:22px;height:22px;border-radius:50%;background:#428BF9;color:#fff;text-align:center;line-height:22px;font-weight:800;font-size:11px;">6</span></td>
          <td><strong>API Gateway &rarr; Booking Service</strong></td>
          <td>gRPC</td>
          <td>Guest initiates booking: listing_id, check_in, check_out, guests, idempotency_key. Booking Service starts reservation flow</td>
          <td>1&ndash;3 ms</td>
        </tr>
        <tr>
          <td style="text-align:center;"><span style="display:inline-block;width:22px;height:22px;border-radius:50%;background:#428BF9;color:#fff;text-align:center;line-height:22px;font-weight:800;font-size:11px;">7</span></td>
          <td><strong>Booking Service &rarr; PostgreSQL</strong></td>
          <td>TCP (libpq)</td>
          <td><code>SELECT ... FOR UPDATE</code> on availability table &rarr; check date range &rarr; INSERT reservation &rarr; UPDATE availability &rarr; COMMIT (all in one transaction)</td>
          <td>5&ndash;30 ms</td>
        </tr>
        <tr>
          <td style="text-align:center;"><span style="display:inline-block;width:22px;height:22px;border-radius:50%;background:#7B2FF7;color:#fff;text-align:center;line-height:22px;font-weight:800;font-size:11px;">8</span></td>
          <td><strong>Booking Service &rarr; Payment Service</strong></td>
          <td>gRPC</td>
          <td>Request payment authorization: amount, currency, guest_payment_method_id, idempotency_key. Payment Service orchestrates charge</td>
          <td>2&ndash;5 ms</td>
        </tr>
        <tr>
          <td style="text-align:center;"><span style="display:inline-block;width:22px;height:22px;border-radius:50%;background:#7B2FF7;color:#fff;text-align:center;line-height:22px;font-weight:800;font-size:11px;">9</span></td>
          <td><strong>Payment Service &rarr; Stripe/Braintree</strong></td>
          <td>HTTPS</td>
          <td>Create PaymentIntent / authorize charge via external payment gateway. PCI-DSS compliant. Tokenized card data only</td>
          <td>300&ndash;2000 ms</td>
        </tr>
        <tr>
          <td style="text-align:center;"><span style="display:inline-block;width:22px;height:22px;border-radius:50%;background:#ef4444;color:#fff;text-align:center;line-height:22px;font-weight:800;font-size:11px;">10</span></td>
          <td><strong>Booking Service &rarr; Kafka</strong></td>
          <td>TCP (Kafka protocol)</td>
          <td>Emit <code>BookingConfirmed</code> event with full booking payload. Async &mdash; does not block the response to client. Enables downstream reactions</td>
          <td>5&ndash;15 ms</td>
        </tr>
        <tr>
          <td style="text-align:center;"><span style="display:inline-block;width:22px;height:22px;border-radius:50%;background:#f59e0b;color:#fff;text-align:center;line-height:22px;font-weight:800;font-size:11px;">11</span></td>
          <td><strong>Kafka &rarr; Notification Service</strong></td>
          <td>Kafka Consumer</td>
          <td>Consumes BookingConfirmed event &rarr; sends confirmation email to guest + notification to host (email + push + SMS)</td>
          <td>1&ndash;5 sec (async)</td>
        </tr>
        <tr>
          <td style="text-align:center;"><span style="display:inline-block;width:22px;height:22px;border-radius:50%;background:#ef4444;color:#fff;text-align:center;line-height:22px;font-weight:800;font-size:11px;">12</span></td>
          <td><strong>Kafka &rarr; Elasticsearch (CDC)</strong></td>
          <td>Debezium / Kafka Connect</td>
          <td>Availability change captured via CDC &rarr; listing availability updated in search index so booked dates no longer appear in search results</td>
          <td>1&ndash;3 sec (async)</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ======= HAPPY PATH FLOW ======= -->
  <h3>Happy Path: Complete Booking Flow</h3>
  <div class="card" style="border-color:var(--success);">
    <h4 style="color:var(--success);">&#9989; Success Scenario (Steps 1 &rarr; 12)</h4>
    <div style="background:var(--darker);border-radius:10px;padding:20px;margin:10px 0;font-family:'Cascadia Code','Fira Code',monospace;font-size:0.88em;line-height:2;">
      <p><span style="color:var(--success);font-weight:700;">Phase 1: Discovery</span></p>
      <p>&nbsp;&nbsp;<span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:#FF5A5F;color:#fff;text-align:center;line-height:20px;font-size:9px;font-weight:800;">1</span> Guest opens app &rarr; CDN serves static assets + cached listing images</p>
      <p>&nbsp;&nbsp;<span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:#FF5A5F;color:#fff;text-align:center;line-height:20px;font-size:9px;font-weight:800;">2</span> Guest searches "Paris, Jun 15-20, 2 guests" &rarr; CDN miss &rarr; forwards to LB</p>
      <p>&nbsp;&nbsp;<span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:#FF5A5F;color:#fff;text-align:center;line-height:20px;font-size:9px;font-weight:800;">3</span> LB routes to API Gateway &rarr; validates JWT token, checks rate limit &rarr; passes</p>
      <p>&nbsp;&nbsp;<span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:#00A699;color:#fff;text-align:center;line-height:20px;font-size:9px;font-weight:800;">4</span> API GW routes to Search Service &rarr; builds ES query with geo + date filters</p>
      <p>&nbsp;&nbsp;<span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:#00A699;color:#fff;text-align:center;line-height:20px;font-size:9px;font-weight:800;">5</span> Search Service queries Elasticsearch &rarr; returns 20 ranked listings &rarr; <span style="color:var(--success);">200 OK</span></p>
      <p style="margin:10px 0;"><span style="color:var(--blue);font-weight:700;">Phase 2: Booking</span></p>
      <p>&nbsp;&nbsp;<span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:#428BF9;color:#fff;text-align:center;line-height:20px;font-size:9px;font-weight:800;">6</span> Guest clicks "Reserve" &rarr; POST /bookings with idempotency_key</p>
      <p>&nbsp;&nbsp;<span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:#428BF9;color:#fff;text-align:center;line-height:20px;font-size:9px;font-weight:800;">7</span> Booking Service: BEGIN TX &rarr; SELECT FOR UPDATE &rarr; dates available &rarr; INSERT booking (PENDING) &rarr; COMMIT</p>
      <p style="margin:10px 0;"><span style="color:var(--purple);font-weight:700;">Phase 3: Payment</span></p>
      <p>&nbsp;&nbsp;<span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:#7B2FF7;color:#fff;text-align:center;line-height:20px;font-size:9px;font-weight:800;">8</span> Booking Service calls Payment Service &rarr; "authorize $450 on guest's card"</p>
      <p>&nbsp;&nbsp;<span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:#7B2FF7;color:#fff;text-align:center;line-height:20px;font-size:9px;font-weight:800;">9</span> Payment Service calls Stripe &rarr; PaymentIntent authorized &rarr; <span style="color:var(--success);">charge succeeds</span></p>
      <p>&nbsp;&nbsp;&nbsp;&nbsp;Booking updated: PENDING &rarr; <span style="color:var(--success);font-weight:700;">CONFIRMED</span> &rarr; <span style="color:var(--success);">201 Created</span> returned to client</p>
      <p style="margin:10px 0;"><span style="color:#ef4444;font-weight:700;">Phase 4: Async Propagation</span></p>
      <p>&nbsp;&nbsp;<span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:#ef4444;color:#fff;text-align:center;line-height:20px;font-size:9px;font-weight:800;">10</span> BookingConfirmed event emitted to Kafka (fire-and-forget from client perspective)</p>
      <p>&nbsp;&nbsp;<span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:#f59e0b;color:#fff;text-align:center;line-height:20px;font-size:9px;font-weight:800;">11</span> Notification Service consumes event &rarr; sends email to guest + push to host</p>
      <p>&nbsp;&nbsp;<span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:#ef4444;color:#fff;text-align:center;line-height:20px;font-size:9px;font-weight:800;">12</span> CDC pipeline updates Elasticsearch &rarr; booked dates removed from search results</p>
      <p style="margin-top:12px;color:var(--success);font-weight:600;">Total E2E latency (client-perceived): ~500 ms &ndash; 3 sec (dominated by Stripe call at step 9)</p>
    </div>
  </div>

  <!-- ======= FAILURE PATHS ======= -->
  <h3>Failure Paths: What Can Go Wrong?</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Fails At</th>
          <th>Failure Scenario</th>
          <th>Impact</th>
          <th>Recovery Strategy</th>
          <th>User Sees</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:#FF5A5F;color:#fff;text-align:center;line-height:20px;font-size:9px;font-weight:800;">1</span> CDN</td>
          <td>CDN edge node down / cache poisoned</td>
          <td>Slow page load, missing images</td>
          <td>CDN failover to next PoP. Origin serves directly (slower). Multi-CDN setup for critical assets</td>
          <td>Slightly slower load, but functional</td>
        </tr>
        <tr>
          <td><span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:#FF5A5F;color:#fff;text-align:center;line-height:20px;font-size:9px;font-weight:800;">3</span> API Gateway</td>
          <td>Rate limit exceeded / JWT expired or invalid</td>
          <td>Request rejected before reaching any service</td>
          <td>Client retries with backoff. Refresh JWT token. Rate limit response includes <code>Retry-After</code> header</td>
          <td><span style="color:var(--danger);">429 Too Many Requests</span> or <span style="color:var(--danger);">401 Unauthorized</span></td>
        </tr>
        <tr>
          <td><span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:#00A699;color:#fff;text-align:center;line-height:20px;font-size:9px;font-weight:800;">5</span> Elasticsearch</td>
          <td>ES cluster unhealthy / shard unassigned / query timeout</td>
          <td>Search results unavailable</td>
          <td>Circuit breaker opens &rarr; fallback to PostgreSQL direct query (slower, fewer features). ES auto-recovers. Alert fires.</td>
          <td><span style="color:var(--warning);">Degraded search</span> (fewer filters, slower), or <span style="color:var(--danger);">503 Service Unavailable</span></td>
        </tr>
        <tr>
          <td><span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:#428BF9;color:#fff;text-align:center;line-height:20px;font-size:9px;font-weight:800;">7</span> PostgreSQL (availability check)</td>
          <td>Dates already booked (race condition) / DB connection timeout</td>
          <td>Booking cannot proceed &mdash; dates taken by another guest</td>
          <td><code>SELECT FOR UPDATE</code> ensures serialized access. Loser gets clean error. Idempotency key prevents duplicate bookings on retry</td>
          <td><span style="color:var(--danger);">"Dates no longer available"</span> &mdash; prompted to pick new dates</td>
        </tr>
        <tr>
          <td><span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:#428BF9;color:#fff;text-align:center;line-height:20px;font-size:9px;font-weight:800;">7</span> PostgreSQL (DB down)</td>
          <td>Primary DB down / all replicas unreachable</td>
          <td><strong>Critical</strong> &mdash; no bookings can be created</td>
          <td>Automatic failover to standby (30&ndash;60 sec). Connection pool drains and reconnects. Booking Service returns 503 with retry.</td>
          <td><span style="color:var(--danger);">"Temporarily unable to process booking. Please try again."</span></td>
        </tr>
        <tr>
          <td><span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:#7B2FF7;color:#fff;text-align:center;line-height:20px;font-size:9px;font-weight:800;">9</span> Payment Gateway</td>
          <td>Stripe timeout / card declined / insufficient funds / fraud detected</td>
          <td>Booking stays PENDING, no charge</td>
          <td><strong>Card declined:</strong> prompt user for different payment method. <strong>Stripe timeout:</strong> retry with same idempotency_key (safe). <strong>Fraud:</strong> reject &amp; flag. Release availability hold after 15-min TTL.</td>
          <td><span style="color:var(--danger);">"Payment failed"</span> with specific reason. Dates remain available for retry or others.</td>
        </tr>
        <tr>
          <td><span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:#ef4444;color:#fff;text-align:center;line-height:20px;font-size:9px;font-weight:800;">10</span> Kafka</td>
          <td>Kafka broker down / partition leader election in progress</td>
          <td>Events delayed (not lost if RF=3). Notifications &amp; index sync delayed.</td>
          <td>Producer retries with exponential backoff. Kafka replicates across 3 brokers (RF=3). <strong>Booking is already confirmed</strong> &mdash; Kafka failure does NOT roll back booking.</td>
          <td>Booking confirmed normally. Email/push notification arrives late (minutes vs seconds).</td>
        </tr>
        <tr>
          <td><span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:#f59e0b;color:#fff;text-align:center;line-height:20px;font-size:9px;font-weight:800;">11</span> Notifications</td>
          <td>Email provider down (SendGrid) / SMS gateway timeout</td>
          <td>Guest doesn't receive confirmation email</td>
          <td>Dead letter queue (DLQ) for failed sends. Retry with backoff. Fallback: try alternate channel (push if email fails). Guest can always check booking status in-app.</td>
          <td>No email, but booking visible in "My Trips" immediately.</td>
        </tr>
        <tr>
          <td><span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:#ef4444;color:#fff;text-align:center;line-height:20px;font-size:9px;font-weight:800;">12</span> CDC / ES Sync</td>
          <td>Debezium connector lag / ES indexing backpressure</td>
          <td>Search index shows stale availability (already-booked dates appear available)</td>
          <td>Step 7 catches this &mdash; even if search shows stale data, the booking will fail at the DB level with "dates unavailable". Eventual consistency resolves in &lt;30 sec typically.</td>
          <td>Guest may try to book dates that are taken, gets error at step 7. Minor UX friction.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="tip-box tip-info">
    <strong>Key Design Principle:</strong> Steps 1&ndash;9 are on the <em>synchronous critical path</em> &mdash; if any of these fail, the user gets an immediate error. Steps 10&ndash;12 are <em>asynchronous</em> &mdash; their failure does NOT affect the booking result. This is intentional: we use Kafka to decouple non-critical downstream effects from the booking transaction, improving reliability and perceived speed.
  </div>

  <div class="tip-box tip-success">
    <strong>Interview Tip:</strong> When walking through the HLD, use these numbered steps to tell a <em>story</em>: "Let me trace a booking request from the client all the way to the database and back..." This shows the interviewer you understand not just the boxes, but how data actually flows between them and what happens when things break.
  </div>

  <h3>Architecture Decisions</h3>
  <div class="card-grid">
    <div class="card">
      <div class="card-header" style="color:var(--secondary);">Microservices with Domain Boundaries</div>
      <p>Each service owns its domain data and APIs. <strong>Booking + Availability</strong> share a database for ACID guarantees (no distributed transactions needed at 17 TPS). Other services communicate via REST/gRPC and async events via Kafka.</p>
    </div>
    <div class="card">
      <div class="card-header" style="color:var(--blue);">Event-Driven Architecture</div>
      <p>Kafka serves as the central event bus. When a booking is confirmed, events trigger: search index update, notification dispatch, analytics ingestion, and payout scheduling. This decouples services and improves resilience.</p>
    </div>
    <div class="card">
      <div class="card-header" style="color:var(--purple);">CQRS for Search</div>
      <p>Writes go to PostgreSQL (source of truth). Reads are served from Elasticsearch (optimized for geo-search + filtering). Kafka CDC keeps the search index eventually consistent (&lt;2s lag).</p>
    </div>
  </div>
</section>

</div><!-- end container for first half -->

<div class="container">

<!-- ==================== SECTION 5: API DESIGN ==================== -->
<section id="api">
  <h2><span class="icon" style="background:linear-gradient(135deg,var(--secondary),var(--blue));">&#128279;</span> API Design</h2>

  <h3>Search API</h3>
  <pre><span class="comment">// Search for available listings</span>
<span class="keyword">GET</span> <span class="string">/api/v1/search</span>

<span class="comment">// Query Parameters:</span>
?location=<span class="string">"San Francisco, CA"</span>      <span class="comment">// or lat=37.77&lng=-122.42</span>
&check_in=<span class="string">2025-06-15</span>
&check_out=<span class="string">2025-06-20</span>
&guests=<span class="number">2</span>
&min_price=<span class="number">50</span>
&max_price=<span class="number">300</span>
&property_type=<span class="string">"entire_place"</span>
&amenities=<span class="string">"wifi,pool,parking"</span>
&sort_by=<span class="string">"relevance"</span>              <span class="comment">// relevance | price_asc | price_desc | rating</span>
&page=<span class="number">1</span>
&page_size=<span class="number">20</span>

<span class="comment">// Response: 200 OK</span>
{
  <span class="string">"results"</span>: [
    {
      <span class="string">"listing_id"</span>: <span class="string">"lst_abc123"</span>,
      <span class="string">"title"</span>: <span class="string">"Cozy Downtown Loft"</span>,
      <span class="string">"property_type"</span>: <span class="string">"entire_place"</span>,
      <span class="string">"location"</span>: { <span class="string">"lat"</span>: <span class="number">37.78</span>, <span class="string">"lng"</span>: <span class="number">-122.41</span>, <span class="string">"city"</span>: <span class="string">"San Francisco"</span> },
      <span class="string">"price_per_night"</span>: <span class="number">150</span>,
      <span class="string">"total_price"</span>: <span class="number">750</span>,
      <span class="string">"currency"</span>: <span class="string">"USD"</span>,
      <span class="string">"rating"</span>: <span class="number">4.85</span>,
      <span class="string">"review_count"</span>: <span class="number">142</span>,
      <span class="string">"thumbnail_url"</span>: <span class="string">"https://cdn.airbnb.com/..."</span>,
      <span class="string">"is_superhost"</span>: <span class="keyword">true</span>,
      <span class="string">"instant_book"</span>: <span class="keyword">true</span>
    }
  ],
  <span class="string">"pagination"</span>: { <span class="string">"page"</span>: <span class="number">1</span>, <span class="string">"total_pages"</span>: <span class="number">45</span>, <span class="string">"total_results"</span>: <span class="number">892</span> },
  <span class="string">"filters_applied"</span>: { ... }
}</pre>

  <h3>Booking APIs</h3>
  <pre><span class="comment">// Create a reservation</span>
<span class="keyword">POST</span> <span class="string">/api/v1/reservations</span>
<span class="comment">// Headers: Authorization: Bearer {token}</span>
<span class="comment">// Idempotency-Key: {client-generated-uuid}  &lt;-- prevents double booking on retry!</span>
{
  <span class="string">"listing_id"</span>: <span class="string">"lst_abc123"</span>,
  <span class="string">"check_in"</span>: <span class="string">"2025-06-15"</span>,
  <span class="string">"check_out"</span>: <span class="string">"2025-06-20"</span>,
  <span class="string">"guests"</span>: <span class="number">2</span>,
  <span class="string">"payment_method_id"</span>: <span class="string">"pm_xyz789"</span>,
  <span class="string">"special_requests"</span>: <span class="string">"Late check-in around 10 PM"</span>
}

<span class="comment">// Response: 201 Created</span>
{
  <span class="string">"reservation_id"</span>: <span class="string">"res_def456"</span>,
  <span class="string">"status"</span>: <span class="string">"confirmed"</span>,           <span class="comment">// confirmed | pending_approval | payment_pending</span>
  <span class="string">"listing"</span>: { <span class="string">"id"</span>: <span class="string">"lst_abc123"</span>, <span class="string">"title"</span>: <span class="string">"Cozy Downtown Loft"</span> },
  <span class="string">"dates"</span>: { <span class="string">"check_in"</span>: <span class="string">"2025-06-15"</span>, <span class="string">"check_out"</span>: <span class="string">"2025-06-20"</span>, <span class="string">"nights"</span>: <span class="number">5</span> },
  <span class="string">"pricing"</span>: {
    <span class="string">"nightly_rate"</span>: <span class="number">150</span>,
    <span class="string">"subtotal"</span>: <span class="number">750</span>,
    <span class="string">"cleaning_fee"</span>: <span class="number">75</span>,
    <span class="string">"service_fee"</span>: <span class="number">115</span>,
    <span class="string">"taxes"</span>: <span class="number">98</span>,
    <span class="string">"total"</span>: <span class="number">1038</span>,
    <span class="string">"currency"</span>: <span class="string">"USD"</span>
  },
  <span class="string">"payment_status"</span>: <span class="string">"charged"</span>,
  <span class="string">"cancellation_policy"</span>: <span class="string">"flexible"</span>,
  <span class="string">"created_at"</span>: <span class="string">"2025-05-01T14:30:00Z"</span>
}

<span class="comment">// Cancel a reservation</span>
<span class="keyword">POST</span> <span class="string">/api/v1/reservations/{reservation_id}/cancel</span>
{
  <span class="string">"reason"</span>: <span class="string">"change_of_plans"</span>,
  <span class="string">"message"</span>: <span class="string">"Sorry, my travel dates changed."</span>
}

<span class="comment">// Get reservation details</span>
<span class="keyword">GET</span> <span class="string">/api/v1/reservations/{reservation_id}</span>

<span class="comment">// List user's reservations</span>
<span class="keyword">GET</span> <span class="string">/api/v1/users/me/reservations?status=upcoming&page=1</span></pre>

  <h3>Listing Management APIs</h3>
  <pre><span class="comment">// Create a new listing (Host)</span>
<span class="keyword">POST</span> <span class="string">/api/v1/listings</span>
{
  <span class="string">"title"</span>: <span class="string">"Sunny Beach House"</span>,
  <span class="string">"description"</span>: <span class="string">"Beautiful oceanfront property..."</span>,
  <span class="string">"property_type"</span>: <span class="string">"entire_place"</span>,
  <span class="string">"location"</span>: { <span class="string">"address"</span>: <span class="string">"123 Ocean Dr"</span>, <span class="string">"city"</span>: <span class="string">"Malibu"</span>, <span class="string">"lat"</span>: <span class="number">34.03</span>, <span class="string">"lng"</span>: <span class="number">-118.78</span> },
  <span class="string">"max_guests"</span>: <span class="number">6</span>,
  <span class="string">"bedrooms"</span>: <span class="number">3</span>,
  <span class="string">"bathrooms"</span>: <span class="number">2</span>,
  <span class="string">"amenities"</span>: [<span class="string">"wifi"</span>, <span class="string">"pool"</span>, <span class="string">"parking"</span>, <span class="string">"kitchen"</span>],
  <span class="string">"base_price"</span>: <span class="number">250</span>,
  <span class="string">"cleaning_fee"</span>: <span class="number">100</span>,
  <span class="string">"cancellation_policy"</span>: <span class="string">"moderate"</span>,
  <span class="string">"house_rules"</span>: [<span class="string">"No smoking"</span>, <span class="string">"No parties"</span>]
}

<span class="comment">// Update availability calendar</span>
<span class="keyword">PUT</span> <span class="string">/api/v1/listings/{listing_id}/availability</span>
{
  <span class="string">"updates"</span>: [
    { <span class="string">"date"</span>: <span class="string">"2025-07-04"</span>, <span class="string">"available"</span>: <span class="keyword">false</span> },
    { <span class="string">"date_range"</span>: { <span class="string">"start"</span>: <span class="string">"2025-08-01"</span>, <span class="string">"end"</span>: <span class="string">"2025-08-15"</span> }, <span class="string">"price"</span>: <span class="number">350</span> }
  ]
}</pre>

  <div class="tip-box tip-interview">
    <div class="tip-title" style="color:var(--purple);">&#128161; Interview Tip: Idempotency Key</div>
    <p>Always mention the <strong>Idempotency-Key</strong> header for booking APIs. This is a client-generated UUID sent with booking requests. If the client retries (network timeout, user double-clicks), the server detects the duplicate key and returns the original response instead of creating a second booking. This is a <em>critical production pattern</em> that demonstrates principal-level thinking.</p>
  </div>
</section>

<!-- ==================== SECTION 6: DATA MODEL ==================== -->
<section id="datamodel">
  <h2><span class="icon" style="background:linear-gradient(135deg,var(--purple),var(--blue));">&#128451;</span> Data Modeling</h2>

  <h3>Entity Relationship Diagram</h3>
  <div class="diagram-box">
    <svg viewBox="0 0 1050 580" xmlns="http://www.w3.org/2000/svg" style="font-family:Segoe UI,sans-serif;">
      <!-- USERS table -->
      <rect x="20" y="20" width="220" height="195" rx="10" fill="#f8fafc" stroke="#FF5A5F" stroke-width="2"/>
      <rect x="20" y="20" width="220" height="32" rx="10" fill="url(#g1)"/>
      <rect x="20" y="42" width="220" height="2" fill="none"/>
      <text x="130" y="42" fill="white" font-size="13" font-weight="700" text-anchor="middle">USERS</text>
      <text x="35" y="70" fill="#f59e0b" font-size="10">PK</text><text x="60" y="70" fill="#1e293b" font-size="10">id UUID</text>
      <text x="60" y="88" fill="#94a3b8" font-size="10">email VARCHAR(255)</text>
      <text x="60" y="106" fill="#94a3b8" font-size="10">password_hash VARCHAR</text>
      <text x="60" y="124" fill="#94a3b8" font-size="10">full_name VARCHAR(100)</text>
      <text x="60" y="142" fill="#94a3b8" font-size="10">phone VARCHAR(20)</text>
      <text x="60" y="160" fill="#94a3b8" font-size="10">avatar_url TEXT</text>
      <text x="60" y="178" fill="#94a3b8" font-size="10">is_host BOOLEAN</text>
      <text x="60" y="196" fill="#94a3b8" font-size="10">is_superhost BOOLEAN</text>
      <text x="60" y="210" fill="#94a3b8" font-size="9">created_at, updated_at</text>

      <!-- LISTINGS table -->
      <rect x="310" y="20" width="230" height="260" rx="10" fill="#f8fafc" stroke="#00A699" stroke-width="2"/>
      <rect x="310" y="20" width="230" height="32" rx="10" fill="url(#g2)"/>
      <text x="425" y="42" fill="white" font-size="13" font-weight="700" text-anchor="middle">LISTINGS</text>
      <text x="325" y="70" fill="#f59e0b" font-size="10">PK</text><text x="350" y="70" fill="#1e293b" font-size="10">id UUID</text>
      <text x="325" y="88" fill="#79c0ff" font-size="10">FK</text><text x="350" y="88" fill="#1e293b" font-size="10">host_id UUID &rarr; USERS</text>
      <text x="350" y="106" fill="#94a3b8" font-size="10">title VARCHAR(200)</text>
      <text x="350" y="124" fill="#94a3b8" font-size="10">description TEXT</text>
      <text x="350" y="142" fill="#94a3b8" font-size="10">property_type ENUM</text>
      <text x="350" y="160" fill="#94a3b8" font-size="10">latitude DECIMAL(10,8)</text>
      <text x="350" y="178" fill="#94a3b8" font-size="10">longitude DECIMAL(11,8)</text>
      <text x="350" y="196" fill="#94a3b8" font-size="10">max_guests INT</text>
      <text x="350" y="214" fill="#94a3b8" font-size="10">bedrooms INT, bathrooms INT</text>
      <text x="350" y="232" fill="#94a3b8" font-size="10">base_price DECIMAL(10,2)</text>
      <text x="350" y="250" fill="#94a3b8" font-size="10">cleaning_fee DECIMAL(10,2)</text>
      <text x="350" y="268" fill="#94a3b8" font-size="10">status ENUM(active,inactive)</text>

      <!-- Relationship User -> Listing -->
      <line x1="240" y1="80" x2="310" y2="80" stroke="#f59e0b" stroke-width="2"/>
      <text x="275" y="75" fill="#f59e0b" font-size="9" text-anchor="middle">1:N</text>

      <!-- RESERVATIONS table -->
      <rect x="610" y="20" width="230" height="280" rx="10" fill="#f8fafc" stroke="#428BF9" stroke-width="2"/>
      <rect x="610" y="20" width="230" height="32" rx="10" fill="url(#g3)"/>
      <text x="725" y="42" fill="white" font-size="13" font-weight="700" text-anchor="middle">RESERVATIONS</text>
      <text x="625" y="70" fill="#f59e0b" font-size="10">PK</text><text x="650" y="70" fill="#1e293b" font-size="10">id UUID</text>
      <text x="625" y="88" fill="#79c0ff" font-size="10">FK</text><text x="650" y="88" fill="#1e293b" font-size="10">guest_id UUID &rarr; USERS</text>
      <text x="625" y="106" fill="#79c0ff" font-size="10">FK</text><text x="650" y="106" fill="#1e293b" font-size="10">listing_id UUID &rarr; LISTINGS</text>
      <text x="650" y="124" fill="#94a3b8" font-size="10">idempotency_key UUID</text>
      <text x="650" y="142" fill="#94a3b8" font-size="10">check_in DATE</text>
      <text x="650" y="160" fill="#94a3b8" font-size="10">check_out DATE</text>
      <text x="650" y="178" fill="#94a3b8" font-size="10">num_guests INT</text>
      <text x="650" y="196" fill="#94a3b8" font-size="10">total_price DECIMAL(10,2)</text>
      <text x="650" y="214" fill="#94a3b8" font-size="10">currency VARCHAR(3)</text>
      <text x="650" y="232" fill="#94a3b8" font-size="10">status ENUM(pending,</text>
      <text x="660" y="248" fill="#94a3b8" font-size="10">confirmed,cancelled,completed)</text>
      <text x="650" y="268" fill="#94a3b8" font-size="10">cancelled_at TIMESTAMP</text>
      <text x="650" y="286" fill="#94a3b8" font-size="9">created_at, updated_at</text>

      <!-- Relationship Listing -> Reservation -->
      <line x1="540" y1="80" x2="610" y2="80" stroke="#f59e0b" stroke-width="2"/>
      <text x="575" y="75" fill="#f59e0b" font-size="9" text-anchor="middle">1:N</text>

      <!-- User -> Reservation -->
      <path d="M130 215 L130 380 L620 380 L620 88 L610 88" fill="none" stroke="#f59e0b" stroke-width="1.5" stroke-dasharray="5,3"/>
      <text x="370" y="395" fill="#f59e0b" font-size="9" text-anchor="middle">Guest books Reservation (1:N)</text>

      <!-- AVAILABILITY table -->
      <rect x="310" y="320" width="230" height="140" rx="10" fill="#f8fafc" stroke="#FC642D" stroke-width="2"/>
      <rect x="310" y="320" width="230" height="32" rx="10" fill="url(#g5)"/>
      <text x="425" y="342" fill="white" font-size="13" font-weight="700" text-anchor="middle">AVAILABILITY</text>
      <text x="325" y="370" fill="#f59e0b" font-size="10">PK</text><text x="350" y="370" fill="#1e293b" font-size="10">id UUID</text>
      <text x="325" y="388" fill="#79c0ff" font-size="10">FK</text><text x="350" y="388" fill="#1e293b" font-size="10">listing_id UUID &rarr; LISTINGS</text>
      <text x="350" y="406" fill="#94a3b8" font-size="10">date DATE</text>
      <text x="350" y="424" fill="#94a3b8" font-size="10">is_available BOOLEAN</text>
      <text x="350" y="442" fill="#94a3b8" font-size="10">price_override DECIMAL</text>
      <text x="350" y="455" fill="#94a3b8" font-size="9">UNIQUE(listing_id, date)</text>

      <!-- Listing -> Availability -->
      <line x1="425" y1="280" x2="425" y2="320" stroke="#f59e0b" stroke-width="2"/>
      <text x="445" y="305" fill="#f59e0b" font-size="9">1:N</text>

      <!-- PAYMENTS table -->
      <rect x="610" y="340" width="230" height="170" rx="10" fill="#f8fafc" stroke="#7B2FF7" stroke-width="2"/>
      <rect x="610" y="340" width="230" height="32" rx="10" fill="url(#g4)"/>
      <text x="725" y="362" fill="white" font-size="13" font-weight="700" text-anchor="middle">PAYMENTS</text>
      <text x="625" y="390" fill="#f59e0b" font-size="10">PK</text><text x="650" y="390" fill="#1e293b" font-size="10">id UUID</text>
      <text x="625" y="408" fill="#79c0ff" font-size="10">FK</text><text x="650" y="408" fill="#1e293b" font-size="10">reservation_id &rarr; RESERVATIONS</text>
      <text x="650" y="426" fill="#94a3b8" font-size="10">amount DECIMAL(10,2)</text>
      <text x="650" y="444" fill="#94a3b8" font-size="10">currency VARCHAR(3)</text>
      <text x="650" y="462" fill="#94a3b8" font-size="10">payment_method VARCHAR</text>
      <text x="650" y="480" fill="#94a3b8" font-size="10">gateway_txn_id VARCHAR</text>
      <text x="650" y="498" fill="#94a3b8" font-size="10">status ENUM(pending,charged,</text>
      <text x="660" y="510" fill="#94a3b8" font-size="9">refunded,failed)</text>

      <!-- Reservation -> Payment -->
      <line x1="725" y1="300" x2="725" y2="340" stroke="#f59e0b" stroke-width="2"/>
      <text x="745" y="325" fill="#f59e0b" font-size="9">1:1</text>

      <!-- REVIEWS table -->
      <rect x="20" y="320" width="220" height="155" rx="10" fill="#f8fafc" stroke="#10b981" stroke-width="2"/>
      <rect x="20" y="320" width="220" height="32" rx="10" fill="#334155"/>
      <text x="130" y="342" fill="#10b981" font-size="13" font-weight="700" text-anchor="middle">REVIEWS</text>
      <text x="35" y="370" fill="#f59e0b" font-size="10">PK</text><text x="60" y="370" fill="#1e293b" font-size="10">id UUID</text>
      <text x="35" y="388" fill="#79c0ff" font-size="10">FK</text><text x="60" y="388" fill="#1e293b" font-size="10">reservation_id &rarr; RES</text>
      <text x="35" y="406" fill="#79c0ff" font-size="10">FK</text><text x="60" y="406" fill="#1e293b" font-size="10">reviewer_id &rarr; USERS</text>
      <text x="60" y="424" fill="#94a3b8" font-size="10">rating INT (1-5)</text>
      <text x="60" y="442" fill="#94a3b8" font-size="10">comment TEXT</text>
      <text x="60" y="460" fill="#94a3b8" font-size="10">cleanliness INT</text>
      <text x="60" y="475" fill="#94a3b8" font-size="9">accuracy, checkin, value INT</text>
    </svg>
  </div>

  <h3>Key Indexing Strategy</h3>
  <table>
    <thead>
      <tr><th>Table</th><th>Index</th><th>Type</th><th>Purpose</th></tr>
    </thead>
    <tbody>
      <tr><td>listings</td><td>(latitude, longitude)</td><td>GiST / Spatial</td><td>Geo-proximity search</td></tr>
      <tr><td>availability</td><td>(listing_id, date)</td><td>UNIQUE B-tree</td><td>Calendar lookups + prevent dupes</td></tr>
      <tr><td>reservations</td><td>(listing_id, check_in, check_out)</td><td>B-tree</td><td>Overlap detection for double-booking</td></tr>
      <tr><td>reservations</td><td>(idempotency_key)</td><td>UNIQUE B-tree</td><td>Idempotent booking creation</td></tr>
      <tr><td>reservations</td><td>(guest_id, status)</td><td>B-tree</td><td>User's booking history</td></tr>
      <tr><td>reviews</td><td>(listing_id, created_at DESC)</td><td>B-tree</td><td>Latest reviews per listing</td></tr>
    </tbody>
  </table>

  <h3>Database Technology Choices</h3>
  <div class="card-grid">
    <div class="card" style="border-top:3px solid var(--blue);">
      <div class="card-header" style="color:var(--blue);">PostgreSQL <span style="color:#0078D4;font-size:0.75em;font-weight:400;">(Azure: DB for PostgreSQL)</span></div>
      <ul>
        <li>Users, Listings, Reservations, Payments</li>
        <li>ACID transactions for booking consistency</li>
        <li>PostGIS extension for geospatial queries</li>
        <li>Read replicas for scaling read-heavy queries</li>
      </ul>
    </div>
    <div class="card" style="border-top:3px solid var(--danger);">
      <div class="card-header" style="color:var(--danger);">Redis <span style="color:#0078D4;font-size:0.75em;font-weight:400;">(Azure: Cache for Redis)</span></div>
      <ul>
        <li>Session management (10 GB)</li>
        <li>Listing detail cache (hot 20% ~200 GB)</li>
        <li>Distributed locks for booking (SETNX + TTL)</li>
        <li>Rate limiting counters</li>
      </ul>
    </div>
    <div class="card" style="border-top:3px solid var(--secondary);">
      <div class="card-header" style="color:var(--secondary);">Elasticsearch <span style="color:#0078D4;font-size:0.75em;font-weight:400;">(Azure: AI Search)</span></div>
      <ul>
        <li>Full-text search on listing titles/descriptions</li>
        <li>Geo-distance and geo-bounding-box queries</li>
        <li>Faceted filtering (price, amenities, type)</li>
        <li>Synced via Kafka CDC (&lt;2s lag)</li>
      </ul>
    </div>
  </div>
</section>

<!-- ==================== SECTION 7: BOOKING FLOW ==================== -->
<section id="booking-flow">
  <h2><span class="icon" style="background:linear-gradient(135deg,var(--primary),var(--accent));">&#128260;</span> Booking Flow &amp; State Machine</h2>

  <h3>End-to-End Booking Flow</h3>
  <div class="diagram-box">
    <svg viewBox="0 0 1050 420" xmlns="http://www.w3.org/2000/svg" style="font-family:Segoe UI,sans-serif;">
      <!-- Step 1 -->
      <rect x="10" y="30" width="130" height="65" rx="10" fill="#f8fafc" stroke="#FF5A5F" stroke-width="2"/>
      <text x="75" y="52" fill="#FF5A5F" font-size="10" font-weight="600" text-anchor="middle">1. GUEST</text>
      <text x="75" y="68" fill="#1e293b" font-size="9" text-anchor="middle">Clicks "Reserve"</text>
      <text x="75" y="82" fill="#94a3b8" font-size="8" text-anchor="middle">Sends Idempotency-Key</text>
      <text x="150" y="62" fill="#94a3b8" font-size="18">&#8594;</text>

      <!-- Step 2 -->
      <rect x="170" y="30" width="130" height="65" rx="10" fill="#f8fafc" stroke="#00A699" stroke-width="2"/>
      <text x="235" y="52" fill="#00A699" font-size="10" font-weight="600" text-anchor="middle">2. API GATEWAY</text>
      <text x="235" y="68" fill="#1e293b" font-size="9" text-anchor="middle">Auth + Rate Limit</text>
      <text x="235" y="82" fill="#94a3b8" font-size="8" text-anchor="middle">Route to Booking Svc</text>
      <text x="310" y="62" fill="#94a3b8" font-size="18">&#8594;</text>

      <!-- Step 3 -->
      <rect x="330" y="30" width="140" height="65" rx="10" fill="#f8fafc" stroke="#428BF9" stroke-width="2"/>
      <text x="400" y="52" fill="#428BF9" font-size="10" font-weight="600" text-anchor="middle">3. BOOKING SERVICE</text>
      <text x="400" y="68" fill="#1e293b" font-size="9" text-anchor="middle">Check Idempotency</text>
      <text x="400" y="82" fill="#94a3b8" font-size="8" text-anchor="middle">Begin Transaction</text>
      <text x="480" y="62" fill="#94a3b8" font-size="18">&#8595;</text>

      <!-- Step 4 -->
      <rect x="330" y="120" width="140" height="65" rx="10" fill="#f8fafc" stroke="#f59e0b" stroke-width="2"/>
      <text x="400" y="142" fill="#f59e0b" font-size="10" font-weight="600" text-anchor="middle">4. AVAILABILITY CHECK</text>
      <text x="400" y="158" fill="#1e293b" font-size="9" text-anchor="middle">SELECT ... FOR UPDATE</text>
      <text x="400" y="172" fill="#94a3b8" font-size="8" text-anchor="middle">Row-level lock on dates</text>
      <text x="480" y="152" fill="#94a3b8" font-size="18">&#8595;</text>

      <!-- Decision diamond -->
      <polygon points="400,210 450,240 400,270 350,240" fill="#f8fafc" stroke="#ef4444" stroke-width="2"/>
      <text x="400" y="244" fill="#ef4444" font-size="9" font-weight="600" text-anchor="middle">Avail?</text>

      <!-- No path -->
      <line x1="350" y1="240" x2="220" y2="240" stroke="#ef4444" stroke-width="1.5"/>
      <text x="285" y="235" fill="#ef4444" font-size="9" text-anchor="middle">No</text>
      <rect x="150" y="220" width="120" height="40" rx="8" fill="rgba(239,68,68,0.2)" stroke="#ef4444"/>
      <text x="210" y="244" fill="#ef4444" font-size="10" text-anchor="middle">409 Conflict</text>

      <!-- Yes path -->
      <line x1="450" y1="240" x2="530" y2="240" stroke="#10b981" stroke-width="1.5"/>
      <text x="490" y="235" fill="#10b981" font-size="9" text-anchor="middle">Yes</text>

      <!-- Step 5 -->
      <rect x="530" y="210" width="140" height="65" rx="10" fill="#f8fafc" stroke="#10b981" stroke-width="2"/>
      <text x="600" y="232" fill="#10b981" font-size="10" font-weight="600" text-anchor="middle">5. CREATE HOLD</text>
      <text x="600" y="248" fill="#1e293b" font-size="9" text-anchor="middle">INSERT reservation</text>
      <text x="600" y="262" fill="#94a3b8" font-size="8" text-anchor="middle">status = 'pending'</text>
      <text x="600" y="282" fill="#94a3b8" font-size="18">&#8595;</text>

      <!-- Step 6 -->
      <rect x="530" y="300" width="140" height="65" rx="10" fill="#f8fafc" stroke="#7B2FF7" stroke-width="2"/>
      <text x="600" y="322" fill="#7B2FF7" font-size="10" font-weight="600" text-anchor="middle">6. PAYMENT</text>
      <text x="600" y="338" fill="#1e293b" font-size="9" text-anchor="middle">Charge via Stripe</text>
      <text x="600" y="352" fill="#94a3b8" font-size="8" text-anchor="middle">5-min timeout on hold</text>

      <!-- Payment decision -->
      <text x="680" y="332" fill="#94a3b8" font-size="18">&#8594;</text>

      <!-- Step 7 success -->
      <rect x="710" y="300" width="140" height="65" rx="10" fill="#f8fafc" stroke="#10b981" stroke-width="2"/>
      <text x="780" y="322" fill="#10b981" font-size="10" font-weight="600" text-anchor="middle">7. CONFIRM</text>
      <text x="780" y="338" fill="#1e293b" font-size="9" text-anchor="middle">status = 'confirmed'</text>
      <text x="780" y="352" fill="#94a3b8" font-size="8" text-anchor="middle">Mark dates unavailable</text>

      <!-- Step 8 -->
      <text x="860" y="332" fill="#94a3b8" font-size="18">&#8594;</text>
      <rect x="880" y="300" width="140" height="65" rx="10" fill="#f8fafc" stroke="#f59e0b" stroke-width="2"/>
      <text x="950" y="322" fill="#f59e0b" font-size="10" font-weight="600" text-anchor="middle">8. NOTIFY</text>
      <text x="950" y="338" fill="#1e293b" font-size="9" text-anchor="middle">Emit BookingConfirmed</text>
      <text x="950" y="352" fill="#94a3b8" font-size="8" text-anchor="middle">Email + Push to both</text>

      <!-- Payment fail path -->
      <line x1="600" y1="365" x2="600" y2="395" stroke="#ef4444" stroke-width="1.5"/>
      <rect x="530" y="390" width="140" height="30" rx="8" fill="rgba(239,68,68,0.2)" stroke="#ef4444"/>
      <text x="600" y="410" fill="#ef4444" font-size="9" text-anchor="middle">Payment Failed &rarr; Release Hold</text>
    </svg>
  </div>

  <h3>Reservation State Machine</h3>
  <div class="diagram-box">
    <svg viewBox="0 0 900 200" xmlns="http://www.w3.org/2000/svg" style="font-family:Segoe UI,sans-serif;">
      <!-- States -->
      <rect x="10" y="70" width="110" height="45" rx="22" fill="rgba(245,158,11,0.2)" stroke="#f59e0b" stroke-width="2"/>
      <text x="65" y="97" fill="#f59e0b" font-size="12" font-weight="600" text-anchor="middle">PENDING</text>

      <text x="135" y="92" fill="#94a3b8" font-size="14">&#8594;</text>
      <text x="135" y="108" fill="#94a3b8" font-size="7" text-anchor="middle">payment ok</text>

      <rect x="160" y="70" width="120" height="45" rx="22" fill="rgba(16,185,129,0.2)" stroke="#10b981" stroke-width="2"/>
      <text x="220" y="97" fill="#10b981" font-size="12" font-weight="600" text-anchor="middle">CONFIRMED</text>

      <text x="295" y="92" fill="#94a3b8" font-size="14">&#8594;</text>
      <text x="295" y="108" fill="#94a3b8" font-size="7" text-anchor="middle">check-in</text>

      <rect x="320" y="70" width="120" height="45" rx="22" fill="rgba(66,139,249,0.2)" stroke="#428BF9" stroke-width="2"/>
      <text x="380" y="97" fill="#428BF9" font-size="12" font-weight="600" text-anchor="middle">ACTIVE</text>

      <text x="455" y="92" fill="#94a3b8" font-size="14">&#8594;</text>
      <text x="455" y="108" fill="#94a3b8" font-size="7" text-anchor="middle">check-out</text>

      <rect x="480" y="70" width="130" height="45" rx="22" fill="rgba(123,47,247,0.2)" stroke="#7B2FF7" stroke-width="2"/>
      <text x="545" y="97" fill="#7B2FF7" font-size="12" font-weight="600" text-anchor="middle">COMPLETED</text>

      <!-- Cancelled state -->
      <rect x="650" y="70" width="130" height="45" rx="22" fill="rgba(239,68,68,0.2)" stroke="#ef4444" stroke-width="2"/>
      <text x="715" y="97" fill="#ef4444" font-size="12" font-weight="600" text-anchor="middle">CANCELLED</text>

      <!-- Cancel arrows -->
      <path d="M65 115 L65 160 L715 160 L715 115" fill="none" stroke="#ef4444" stroke-width="1" stroke-dasharray="4,3"/>
      <text x="400" y="175" fill="#ef4444" font-size="8" text-anchor="middle">Can be cancelled from PENDING, CONFIRMED, or ACTIVE (with penalties)</text>

      <!-- Expired from pending -->
      <path d="M65 70 L65 25 L715 25 L715 70" fill="none" stroke="#94a3b8" stroke-width="1" stroke-dasharray="4,3"/>
      <text x="400" y="18" fill="#94a3b8" font-size="8" text-anchor="middle">PENDING auto-expires after 5 min &rarr; EXPIRED (dates released)</text>

      <rect x="810" y="70" width="80" height="45" rx="22" fill="rgba(100,116,139,0.2)" stroke="#94a3b8" stroke-width="1"/>
      <text x="850" y="97" fill="#94a3b8" font-size="11" font-weight="600" text-anchor="middle">EXPIRED</text>
    </svg>
  </div>
</section>

<!-- ==================== SECTION 8: SEARCH ==================== -->
<section id="search">
  <h2><span class="icon" style="background:linear-gradient(135deg,var(--secondary),var(--success));">&#128269;</span> Search &amp; Discovery Architecture</h2>

  <h3>Search Pipeline</h3>
  <div class="flow-steps">
    <div class="flow-step" style="border-color:var(--primary);">
      <div style="color:var(--primary);font-weight:700;">Query Input</div>
      <div style="font-size:0.8em;color:var(--text-muted);">location, dates, guests, filters</div>
    </div>
    <div class="flow-arrow">&#8594;</div>
    <div class="flow-step" style="border-color:var(--secondary);">
      <div style="color:var(--secondary);font-weight:700;">Geo Resolution</div>
      <div style="font-size:0.8em;color:var(--text-muted);">Geocode &rarr; lat/lng + bounding box</div>
    </div>
    <div class="flow-arrow">&#8594;</div>
    <div class="flow-step" style="border-color:var(--blue);">
      <div style="color:var(--blue);font-weight:700;">Elasticsearch</div>
      <div style="font-size:0.8em;color:var(--text-muted);">geo_distance + filters + text</div>
    </div>
    <div class="flow-arrow">&#8594;</div>
    <div class="flow-step" style="border-color:var(--purple);">
      <div style="color:var(--purple);font-weight:700;">Availability Filter</div>
      <div style="font-size:0.8em;color:var(--text-muted);">Exclude booked dates from results</div>
    </div>
    <div class="flow-arrow">&#8594;</div>
    <div class="flow-step" style="border-color:var(--accent);">
      <div style="color:var(--accent);font-weight:700;">Ranking / ML</div>
      <div style="font-size:0.8em;color:var(--text-muted);">Personalization, quality score</div>
    </div>
    <div class="flow-arrow">&#8594;</div>
    <div class="flow-step" style="border-color:var(--success);">
      <div style="color:var(--success);font-weight:700;">Response</div>
      <div style="font-size:0.8em;color:var(--text-muted);">Paginated results + facets</div>
    </div>
  </div>

  <h3>Geo-Search Strategies Comparison</h3>
  <div class="comparison">
    <div class="card option-a">
      <div class="card-header" style="color:var(--secondary);">Option A: Geohash</div>
      <ul>
        <li>Encode lat/lng into a string prefix</li>
        <li>Shared prefix = nearby locations</li>
        <li>Easy to implement, works with any DB</li>
        <li>Uneven grid sizes at high latitudes</li>
        <li><strong>Best for:</strong> Simple proximity search</li>
      </ul>
      <div style="margin-top:10px;">
        <span class="badge badge-green">Simple</span>
        <span class="badge badge-blue">Widely Supported</span>
      </div>
    </div>
    <div class="card option-b">
      <div class="card-header" style="color:var(--accent);">Option B: Quadtree / S2 Geometry</div>
      <ul>
        <li>Hierarchical spatial decomposition</li>
        <li>Uniform cell sizes across the globe (S2)</li>
        <li>Better for variable-density regions</li>
        <li>More complex to implement</li>
        <li><strong>Best for:</strong> Production-grade geo-search (Uber, Google)</li>
      </ul>
      <div style="margin-top:10px;">
        <span class="badge badge-orange">Complex</span>
        <span class="badge badge-purple">Production Grade</span>
      </div>
    </div>
  </div>

  <h3>Search Index Sync (CQRS Pattern)</h3>
  <div class="diagram-box">
    <svg viewBox="0 0 900 180" xmlns="http://www.w3.org/2000/svg" style="font-family:Segoe UI,sans-serif;">
      <!-- Write Path -->
      <text x="10" y="25" fill="#94a3b8" font-size="11" font-weight="600">WRITE PATH</text>
      <rect x="10" y="35" width="130" height="40" rx="8" fill="#f8fafc" stroke="#428BF9" stroke-width="1.5"/>
      <text x="75" y="60" fill="#428BF9" font-size="10" text-anchor="middle">Listing Service</text>

      <text x="155" y="55" fill="#94a3b8" font-size="14">&#8594;</text>

      <rect x="180" y="35" width="130" height="40" rx="8" fill="#f8fafc" stroke="#FF5A5F" stroke-width="1.5"/>
      <text x="245" y="60" fill="#FF5A5F" font-size="10" text-anchor="middle">PostgreSQL</text>

      <text x="325" y="55" fill="#94a3b8" font-size="14">&#8594;</text>
      <text x="325" y="30" fill="#94a3b8" font-size="8" text-anchor="middle">WAL / CDC</text>

      <rect x="350" y="35" width="120" height="40" rx="8" fill="#f8fafc" stroke="#ef4444" stroke-width="1.5"/>
      <text x="410" y="55" fill="#ef4444" font-size="10" text-anchor="middle">Debezium</text>
      <text x="410" y="68" fill="#94a3b8" font-size="8" text-anchor="middle">(CDC Connector)</text>

      <text x="485" y="55" fill="#94a3b8" font-size="14">&#8594;</text>

      <rect x="510" y="35" width="120" height="40" rx="8" fill="#f8fafc" stroke="#ef4444" stroke-width="1.5"/>
      <text x="570" y="60" fill="#ef4444" font-size="10" text-anchor="middle">Kafka</text>

      <text x="645" y="55" fill="#94a3b8" font-size="14">&#8594;</text>

      <rect x="670" y="35" width="140" height="40" rx="8" fill="#f8fafc" stroke="#00A699" stroke-width="1.5"/>
      <text x="740" y="55" fill="#00A699" font-size="10" text-anchor="middle">Search Consumer</text>
      <text x="740" y="68" fill="#94a3b8" font-size="8" text-anchor="middle">(Index Updater)</text>

      <text x="825" y="55" fill="#94a3b8" font-size="14">&#8594;</text>

      <rect x="845" y="35" width="130" height="40" rx="8" fill="#f8fafc" stroke="#00A699" stroke-width="1.5"/>
      <text x="910" y="60" fill="#00A699" font-size="10" text-anchor="middle">Elasticsearch</text>

      <!-- Read Path -->
      <text x="10" y="120" fill="#94a3b8" font-size="11" font-weight="600">READ PATH</text>
      <rect x="10" y="130" width="130" height="40" rx="8" fill="#f8fafc" stroke="#FF5A5F" stroke-width="1.5"/>
      <text x="75" y="155" fill="#FF5A5F" font-size="10" text-anchor="middle">Guest (Search)</text>

      <text x="155" y="150" fill="#94a3b8" font-size="14">&#8594;</text>

      <rect x="180" y="130" width="130" height="40" rx="8" fill="#f8fafc" stroke="#00A699" stroke-width="1.5"/>
      <text x="245" y="150" fill="#00A699" font-size="10" text-anchor="middle">Search Service</text>

      <text x="325" y="150" fill="#94a3b8" font-size="14">&#8594;</text>

      <rect x="845" y="130" width="130" height="40" rx="8" fill="#f8fafc" stroke="#00A699" stroke-width="1.5"/>
      <text x="910" y="155" fill="#00A699" font-size="10" text-anchor="middle">Elasticsearch</text>

      <line x1="350" y1="150" x2="845" y2="150" stroke="#00A699" stroke-width="1.5" stroke-dasharray="5,3"/>
      <text x="600" y="145" fill="#00A699" font-size="8" text-anchor="middle">Reads directly from search index (not the DB)</text>
    </svg>
  </div>

  <div class="tip-box tip-success">
    <div class="tip-title" style="color:var(--success);">&#9989; Why CQRS Here?</div>
    <p>Search needs denormalized, pre-computed data for sub-500ms latency. PostgreSQL can't serve complex geo + filter + text queries at 1000+ QPS efficiently. By separating reads (Elasticsearch) from writes (PostgreSQL), each store is optimized for its access pattern. The trade-off: eventual consistency (~1-2s lag) for search results, which is acceptable since availability is confirmed at booking time anyway.</p>
  </div>
</section>

<!-- ==================== SECTION 9: CONCURRENCY ==================== -->
<section id="concurrency">
  <h2><span class="icon" style="background:linear-gradient(135deg,var(--danger),var(--accent));">&#128274;</span> Concurrency &amp; Double-Booking Prevention</h2>

  <p>The <strong>#1 correctness requirement</strong>: two guests must never successfully book the same property for overlapping dates. This is the hardest problem in the system and the most asked about in interviews.</p>

  <h3>Three Approaches Compared</h3>

  <div class="card" style="border-top:3px solid var(--secondary); margin-bottom:20px;">
    <div class="card-header" style="color:var(--secondary);">&#9989; Option 1: Pessimistic Locking (SELECT ... FOR UPDATE) &mdash; RECOMMENDED</div>
    <pre><span class="comment">-- Within a single DB transaction:</span>
<span class="keyword">BEGIN</span>;

<span class="comment">-- 1. Lock the availability rows for the requested date range</span>
<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> availability
<span class="keyword">WHERE</span> listing_id = <span class="string">'lst_abc123'</span>
  <span class="keyword">AND</span> date <span class="keyword">BETWEEN</span> <span class="string">'2025-06-15'</span> <span class="keyword">AND</span> <span class="string">'2025-06-19'</span>
  <span class="keyword">AND</span> is_available = <span class="keyword">true</span>
<span class="keyword">FOR UPDATE</span>;  <span class="comment">-- Row-level lock acquired!</span>

<span class="comment">-- 2. If all dates returned (5 rows for 5 nights), proceed</span>
<span class="comment">-- 3. Insert reservation</span>
<span class="keyword">INSERT INTO</span> reservations (id, guest_id, listing_id, check_in, check_out, status)
<span class="keyword">VALUES</span> (<span class="string">'res_def456'</span>, <span class="string">'usr_guest1'</span>, <span class="string">'lst_abc123'</span>, <span class="string">'2025-06-15'</span>, <span class="string">'2025-06-20'</span>, <span class="string">'confirmed'</span>);

<span class="comment">-- 4. Mark dates as unavailable</span>
<span class="keyword">UPDATE</span> availability <span class="keyword">SET</span> is_available = <span class="keyword">false</span>
<span class="keyword">WHERE</span> listing_id = <span class="string">'lst_abc123'</span>
  <span class="keyword">AND</span> date <span class="keyword">BETWEEN</span> <span class="string">'2025-06-15'</span> <span class="keyword">AND</span> <span class="string">'2025-06-19'</span>;

<span class="keyword">COMMIT</span>;</pre>
    <div style="margin-top:10px;">
      <span class="badge badge-green">Simple</span>
      <span class="badge badge-green">Strong Consistency</span>
      <span class="badge badge-blue">ACID Guaranteed</span>
      <span class="badge badge-orange">Blocks Concurrent Writes</span>
    </div>
    <p style="margin-top:10px;color:var(--text-muted);">At ~17 write TPS, lock contention is minimal. This is the simplest correct solution.</p>
  </div>

  <div class="card" style="border-top:3px solid var(--blue); margin-bottom:20px;">
    <div class="card-header" style="color:var(--blue);">&#128260; Option 2: Optimistic Concurrency Control (OCC)</div>
    <pre><span class="comment">-- 1. Read availability (no lock)</span>
<span class="keyword">SELECT</span> version, is_available <span class="keyword">FROM</span> availability
<span class="keyword">WHERE</span> listing_id = <span class="string">'lst_abc123'</span> <span class="keyword">AND</span> date <span class="keyword">BETWEEN</span> <span class="string">'2025-06-15'</span> <span class="keyword">AND</span> <span class="string">'2025-06-19'</span>;

<span class="comment">-- 2. Process booking logic...</span>

<span class="comment">-- 3. Update with version check (CAS - Compare And Swap)</span>
<span class="keyword">UPDATE</span> availability
<span class="keyword">SET</span> is_available = <span class="keyword">false</span>, version = version + <span class="number">1</span>
<span class="keyword">WHERE</span> listing_id = <span class="string">'lst_abc123'</span>
  <span class="keyword">AND</span> date = <span class="string">'2025-06-15'</span>
  <span class="keyword">AND</span> version = <span class="number">42</span>  <span class="comment">-- Must match read version</span>
  <span class="keyword">AND</span> is_available = <span class="keyword">true</span>;

<span class="comment">-- If rows_affected = 0 &rarr; conflict! Retry or abort.</span></pre>
    <div style="margin-top:10px;">
      <span class="badge badge-blue">No Blocking</span>
      <span class="badge badge-green">Higher Throughput</span>
      <span class="badge badge-orange">Requires Retry Logic</span>
      <span class="badge badge-red">Complex Multi-Row</span>
    </div>
    <p style="margin-top:10px;color:var(--text-muted);">Better for high-contention scenarios. But checking version across multiple rows (multi-night stays) adds complexity.</p>
  </div>

  <div class="card" style="border-top:3px solid var(--purple);">
    <div class="card-header" style="color:var(--purple);">&#128274; Option 3: Distributed Lock (Redis SETNX)</div>
    <pre><span class="comment">// Acquire a distributed lock per listing</span>
<span class="func">SETNX</span> lock:listing:lst_abc123 <span class="string">"res_def456"</span> EX <span class="number">30</span>  <span class="comment">// 30s TTL</span>

<span class="comment">// If acquired &rarr; proceed with booking in DB</span>
<span class="comment">// If not acquired &rarr; return 409 "listing is being booked"</span>

<span class="comment">// After booking completes &rarr; release lock</span>
<span class="func">DEL</span> lock:listing:lst_abc123</pre>
    <div style="margin-top:10px;">
      <span class="badge badge-purple">Distributed</span>
      <span class="badge badge-orange">Extra Infra (Redis)</span>
      <span class="badge badge-red">TTL Edge Cases</span>
      <span class="badge badge-blue">Coarse Locking</span>
    </div>
    <p style="margin-top:10px;color:var(--text-muted);">Locks entire listing even for non-overlapping dates. Use Redlock for multi-node Redis. Over-engineering for our scale.</p>
  </div>

  <div class="tip-box tip-interview">
    <div class="tip-title" style="color:var(--purple);">&#128161; Interview Tip: Pick and Justify</div>
    <p>Mention all three approaches, then <strong>recommend Option 1 (pessimistic locking)</strong> and justify: "At ~17 write TPS, lock contention is negligible. Pessimistic locking gives us strong guarantees with zero retry logic and zero additional infrastructure. I'd switch to Option 2 or 3 only if we hit measurable contention &mdash; which won't happen at this scale." This shows you can evaluate trade-offs rather than defaulting to the most complex solution.</p>
  </div>
</section>

<!-- ==================== SECTION 10: TRADEOFFS ==================== -->
<section id="tradeoffs">
  <h2><span class="icon" style="background:linear-gradient(135deg,var(--warning),var(--accent));">&#9878;</span> Trade-offs &amp; Design Decisions</h2>

  <h3>Critical Trade-off Matrix</h3>
  <table>
    <thead>
      <tr><th>Decision</th><th>Option A</th><th>Option B</th><th>Our Choice</th><th>Why</th></tr>
    </thead>
    <tbody>
      <tr>
        <td><strong>Booking DB</strong></td>
        <td>SQL (PostgreSQL)</td>
        <td>NoSQL (DynamoDB / Cosmos DB)</td>
        <td style="color:var(--success);">PostgreSQL</td>
        <td>ACID for booking integrity; relational joins for reporting; PostGIS for geo</td>
      </tr>
      <tr>
        <td><strong>Consistency</strong></td>
        <td>Strong (CP)</td>
        <td>Eventual (AP)</td>
        <td style="color:var(--success);">Strong for bookings<br>Eventual for search</td>
        <td>Bookings need correctness; search can tolerate 1-2s staleness</td>
      </tr>
      <tr>
        <td><strong>Transactions</strong></td>
        <td>Local ACID</td>
        <td>Distributed (2PC/Saga)</td>
        <td style="color:var(--success);">Local ACID</td>
        <td>17 TPS doesn't justify distributed txn complexity; co-locate booking + availability</td>
      </tr>
      <tr>
        <td><strong>Search Engine</strong></td>
        <td>Elasticsearch</td>
        <td>PostgreSQL full-text</td>
        <td style="color:var(--success);">Elasticsearch</td>
        <td>Superior geo-search, faceting, relevance tuning at scale</td>
      </tr>
      <tr>
        <td><strong>Service Comm</strong></td>
        <td>REST/HTTP</td>
        <td>gRPC</td>
        <td style="color:var(--success);">REST external + gRPC internal</td>
        <td>REST for public APIs (developer friendly); gRPC for inter-service (performance)</td>
      </tr>
      <tr>
        <td><strong>Caching</strong></td>
        <td>Cache-aside (manual)</td>
        <td>Write-through</td>
        <td style="color:var(--success);">Cache-aside</td>
        <td>More control; listings rarely change; TTL-based invalidation is sufficient</td>
      </tr>
      <tr>
        <td><strong>Media Storage</strong></td>
        <td>Self-hosted</td>
        <td>Self-hosted</td>
        <td style="color:var(--success);">S3 / CloudFront <span style="color:#0078D4;">(Azure: Blob + Front Door)</span></td>
        <td>25 TB media; global delivery; infinite scalability; pay-per-use</td>
      </tr>
      <tr>
        <td><strong>Message Queue</strong></td>
        <td>Kafka</td>
        <td>RabbitMQ / SQS / Service Bus</td>
        <td style="color:var(--success);">Kafka <span style="color:#0078D4;">(Azure: Event Hubs)</span></td>
        <td>Event sourcing, replay capability, high throughput, multi-consumer</td>
      </tr>
    </tbody>
  </table>

  <h3>SQL vs NoSQL Deep Comparison</h3>
  <div class="comparison">
    <div class="card option-a">
      <div class="card-header" style="color:var(--secondary);">PostgreSQL (Chosen for Core)</div>
      <div class="bar-chart">
        <div class="bar-row"><span class="bar-label" style="width:120px;">ACID Guarantees</span><div class="bar-track"><div class="bar-fill" style="width:98%;background:var(--success);">98%</div></div></div>
        <div class="bar-row"><span class="bar-label" style="width:120px;">Complex Queries</span><div class="bar-track"><div class="bar-fill" style="width:95%;background:var(--success);">95%</div></div></div>
        <div class="bar-row"><span class="bar-label" style="width:120px;">Horizontal Scale</span><div class="bar-track"><div class="bar-fill" style="width:55%;background:var(--warning);">55%</div></div></div>
        <div class="bar-row"><span class="bar-label" style="width:120px;">Write Throughput</span><div class="bar-track"><div class="bar-fill" style="width:60%;background:var(--warning);">60%</div></div></div>
        <div class="bar-row"><span class="bar-label" style="width:120px;">Schema Flexibility</span><div class="bar-track"><div class="bar-fill" style="width:40%;background:var(--danger);">40%</div></div></div>
      </div>
    </div>
    <div class="card option-b">
      <div class="card-header" style="color:var(--accent);">DynamoDB / Cosmos DB / MongoDB (Alternative)</div>
      <div class="bar-chart">
        <div class="bar-row"><span class="bar-label" style="width:120px;">ACID Guarantees</span><div class="bar-track"><div class="bar-fill" style="width:45%;background:var(--danger);">45%</div></div></div>
        <div class="bar-row"><span class="bar-label" style="width:120px;">Complex Queries</span><div class="bar-track"><div class="bar-fill" style="width:35%;background:var(--danger);">35%</div></div></div>
        <div class="bar-row"><span class="bar-label" style="width:120px;">Horizontal Scale</span><div class="bar-track"><div class="bar-fill" style="width:95%;background:var(--success);">95%</div></div></div>
        <div class="bar-row"><span class="bar-label" style="width:120px;">Write Throughput</span><div class="bar-track"><div class="bar-fill" style="width:92%;background:var(--success);">92%</div></div></div>
        <div class="bar-row"><span class="bar-label" style="width:120px;">Schema Flexibility</span><div class="bar-track"><div class="bar-fill" style="width:90%;background:var(--success);">90%</div></div></div>
      </div>
    </div>
  </div>

  <div class="tip-box tip-warning">
    <div class="tip-title" style="color:var(--warning);">&#9888; Common Mistake</div>
    <p>Don't default to NoSQL just because "it scales." For a booking system, <strong>correctness &gt; scalability</strong>. A single PostgreSQL instance handles 10,000+ TPS. With read replicas, you can serve millions of reads. NoSQL would force you to implement consistency guarantees at the application level &mdash; re-inventing what SQL gives you for free.</p>
  </div>
</section>

<!-- ==================== SECTION 11: DEEP DIVES ==================== -->
<section id="deep-dives">
  <h2><span class="icon" style="background:linear-gradient(135deg,var(--blue),var(--purple));">&#128300;</span> Deep Dives</h2>

  <h3>1. Payment Flow &amp; Escrow Model</h3>
  <div class="card" style="border-left:4px solid var(--purple);">
    <div class="flow-steps">
      <div class="flow-step" style="border-color:var(--primary);">Guest pays<br><small style="color:var(--text-muted);">Stripe charge</small></div>
      <div class="flow-arrow">&#8594;</div>
      <div class="flow-step" style="border-color:var(--warning);">Held in Escrow<br><small style="color:var(--text-muted);">Until check-in + 24h</small></div>
      <div class="flow-arrow">&#8594;</div>
      <div class="flow-step" style="border-color:var(--success);">Payout to Host<br><small style="color:var(--text-muted);">Minus service fee</small></div>
    </div>
    <ul style="margin-top:15px;">
      <li><strong>Idempotent charges:</strong> Use Stripe's <code>idempotency_key</code> to prevent duplicate charges</li>
      <li><strong>Webhook-driven:</strong> Payment status updates via Stripe webhooks (not polling)</li>
      <li><strong>Refund logic:</strong> Cancellation policy determines refund percentage and timing</li>
      <li><strong>Split payments:</strong> Stripe Connect handles automatic splitting (host payout vs. platform fee)</li>
    </ul>
  </div>

  <h3>2. Dynamic Pricing Strategy</h3>
  <div class="card" style="border-left:4px solid var(--accent);">
    <p>Airbnb's Smart Pricing considers multiple signals:</p>
    <div class="card-grid" style="margin-top:10px;">
      <div style="background:rgba(255,90,95,0.05);padding:12px;border-radius:8px;border:1px solid var(--card-border);">
        <strong style="color:var(--primary);">Demand Signals</strong>
        <ul><li>Local events &amp; holidays</li><li>Seasonal patterns</li><li>Search volume for area</li><li>Booking lead time</li></ul>
      </div>
      <div style="background:rgba(0,166,153,0.05);padding:12px;border-radius:8px;border:1px solid var(--card-border);">
        <strong style="color:var(--secondary);">Supply Signals</strong>
        <ul><li>Competitor pricing nearby</li><li>Listing occupancy rate</li><li>Day of week patterns</li><li>Last-minute availability</li></ul>
      </div>
      <div style="background:rgba(66,139,249,0.05);padding:12px;border-radius:8px;border:1px solid var(--card-border);">
        <strong style="color:var(--blue);">Listing Quality</strong>
        <ul><li>Superhost status</li><li>Review scores</li><li>Response rate</li><li>Photo quality score</li></ul>
      </div>
    </div>
  </div>

  <h3>3. Cancellation Policy Engine</h3>
  <table>
    <thead>
      <tr><th>Policy</th><th>Free Cancel Until</th><th>After Deadline</th><th>No-Show</th></tr>
    </thead>
    <tbody>
      <tr><td style="color:var(--success);"><strong>Flexible</strong></td><td>24h before check-in</td><td>100% refund minus service fee</td><td>No refund</td></tr>
      <tr><td style="color:var(--warning);"><strong>Moderate</strong></td><td>5 days before check-in</td><td>50% refund for remaining nights</td><td>No refund</td></tr>
      <tr><td style="color:var(--danger);"><strong>Strict</strong></td><td>14 days before check-in</td><td>50% refund up to 7 days before</td><td>No refund</td></tr>
      <tr><td style="color:var(--primary);"><strong>Super Strict</strong></td><td>30 days before</td><td>No refund</td><td>No refund</td></tr>
    </tbody>
  </table>

  <h3>4. Fault Tolerance &amp; Resilience Patterns</h3>
  <div class="card-grid">
    <div class="card">
      <div class="card-header" style="color:var(--danger);">Circuit Breaker</div>
      <p>If the payment gateway fails 5 times in 30s, open the circuit. Return a "try again later" response. Auto-close after 60s and test with a single request.</p>
      <pre style="font-size:0.8em;"><span class="comment">// States: CLOSED &rarr; OPEN &rarr; HALF-OPEN &rarr; CLOSED</span>
Threshold: <span class="number">5</span> failures in <span class="number">30</span>s
Timeout: <span class="number">60</span>s before retry
Half-open: allow <span class="number">1</span> test request</pre>
    </div>
    <div class="card">
      <div class="card-header" style="color:var(--warning);">Retry with Exponential Backoff</div>
      <p>For transient failures (network timeouts, 503s), retry with increasing delays to avoid thundering herd.</p>
      <pre style="font-size:0.8em;">Attempt <span class="number">1</span>: wait <span class="number">100</span>ms
Attempt <span class="number">2</span>: wait <span class="number">200</span>ms
Attempt <span class="number">3</span>: wait <span class="number">400</span>ms + jitter
Max retries: <span class="number">3</span>
<span class="comment">// Always use with idempotency keys!</span></pre>
    </div>
    <div class="card">
      <div class="card-header" style="color:var(--success);">Graceful Degradation</div>
      <ul>
        <li>Search down? Show cached/popular listings</li>
        <li>Reviews down? Show listing without reviews</li>
        <li>Pricing service down? Use base price</li>
        <li>Notifications down? Queue for later delivery</li>
      </ul>
    </div>
    <div class="card">
      <div class="card-header" style="color:var(--blue);">Database Failover</div>
      <ul>
        <li>Primary-Replica setup with auto-failover</li>
        <li>PostgreSQL streaming replication</li>
        <li>RPO: 0 (synchronous replica)</li>
        <li>RTO: &lt;30 seconds (automatic promotion)</li>
      </ul>
    </div>
  </div>

  <h3>5. Monitoring &amp; Observability</h3>
  <div class="card" style="border-left:4px solid var(--blue);">
    <div class="card-grid">
      <div>
        <h4 style="border:none;padding:0;margin:0 0 8px 0;">Key Metrics (RED Method)</h4>
        <ul>
          <li><strong style="color:var(--primary);">Rate</strong> &mdash; Requests/sec per service</li>
          <li><strong style="color:var(--danger);">Errors</strong> &mdash; Error rate (5xx, 4xx breakdown)</li>
          <li><strong style="color:var(--warning);">Duration</strong> &mdash; Latency p50, p95, p99</li>
        </ul>
      </div>
      <div>
        <h4 style="border:none;padding:0;margin:0 0 8px 0;">Business Metrics</h4>
        <ul>
          <li>Booking conversion rate (search &rarr; book)</li>
          <li>Double-booking incidents (should be 0!)</li>
          <li>Payment failure rate</li>
          <li>Search result relevance (click-through)</li>
        </ul>
      </div>
    </div>
    <p style="margin-top:10px;color:var(--text-muted);">Stack: <strong>Prometheus</strong> (metrics) + <strong>Grafana</strong> (dashboards) + <strong>Jaeger</strong> (distributed tracing) + <strong>ELK</strong> (logs)</p>
  </div>
</section>

<!-- ==================== SECTION 12: PEAK EVENTS ==================== -->
<section id="peak-events">
  <h2><span class="icon" style="background:linear-gradient(135deg,#f59e0b,#ef4444);">&#127941;</span> Handling Peak Events: Paris Olympics Case Study</h2>

  <p>The ultimate stress test for a booking system: <strong>the 2024 Paris Olympics</strong> drove Airbnb search traffic up <strong>9x in four days</strong>, bookings up <strong>400%</strong>, and average nightly rates from &euro;141 to &euro;706. This is the kind of scenario interviewers love to explore &mdash; and where principal engineers prove their worth.</p>

  <!-- Real Numbers -->
  <h3>Real-World Numbers: Paris Olympics 2024</h3>
  <div class="metric-grid">
    <div class="metric-card" style="border-top:3px solid var(--primary);">
      <div class="metric-value">9x</div>
      <div class="metric-label">Search Spike in 4 Days</div>
      <div style="color:var(--text-muted);font-size:0.75em;margin-top:4px;">After ticket sales opened</div>
    </div>
    <div class="metric-card" style="border-top:3px solid var(--secondary);">
      <div class="metric-value">400%</div>
      <div class="metric-label">YoY Booking Increase</div>
      <div style="color:var(--text-muted);font-size:0.75em;margin-top:4px;">Paris region during Games</div>
    </div>
    <div class="metric-card" style="border-top:3px solid var(--accent);">
      <div class="metric-value">5x</div>
      <div class="metric-label">Price Surge (ADR)</div>
      <div style="color:var(--text-muted);font-size:0.75em;margin-top:4px;">&euro;141 &rarr; &euro;706 per night</div>
    </div>
    <div class="metric-card" style="border-top:3px solid var(--purple);">
      <div class="metric-value">700K</div>
      <div class="metric-label">Visitors via Airbnb</div>
      <div style="color:var(--text-muted);font-size:0.75em;margin-top:4px;">Across 99% of Paris postal codes</div>
    </div>
    <div class="metric-card" style="border-top:3px solid var(--blue);">
      <div class="metric-value">60K+</div>
      <div class="metric-label">Active Listings (Peak)</div>
      <div style="color:var(--text-muted);font-size:0.75em;margin-top:4px;">Nearly 2x from two years prior</div>
    </div>
    <div class="metric-card" style="border-top:3px solid var(--success);">
      <div class="metric-value">160+</div>
      <div class="metric-label">Countries Booking</div>
      <div style="color:var(--text-muted);font-size:0.75em;margin-top:4px;">US led with 20% of stays</div>
    </div>
  </div>

  <!-- The Challenge -->
  <h3>The Scaling Challenge: What Changes at 10x Load?</h3>
  <div class="diagram-box">
    <svg viewBox="0 0 1000 300" xmlns="http://www.w3.org/2000/svg" style="font-family:Segoe UI,sans-serif;">
      <!-- Normal baseline -->
      <text x="20" y="25" fill="#94a3b8" font-size="11" font-weight="600">TRAFFIC PATTERN: Paris Olympics Booking Surge</text>

      <!-- Y axis -->
      <line x1="60" y1="40" x2="60" y2="250" stroke="#334155" stroke-width="1.5"/>
      <text x="15" y="60" fill="#94a3b8" font-size="8">10x</text>
      <line x1="55" y1="60" x2="60" y2="60" stroke="#334155" stroke-width="1"/>
      <text x="15" y="100" fill="#94a3b8" font-size="8">7x</text>
      <line x1="55" y1="100" x2="60" y2="100" stroke="#334155" stroke-width="1"/>
      <text x="15" y="150" fill="#94a3b8" font-size="8">4x</text>
      <line x1="55" y1="150" x2="60" y2="150" stroke="#334155" stroke-width="1"/>
      <text x="15" y="210" fill="#94a3b8" font-size="8">1x</text>
      <line x1="55" y1="210" x2="960" y2="210" stroke="#334155" stroke-width="1" stroke-dasharray="4,4"/>

      <!-- X axis -->
      <line x1="60" y1="250" x2="960" y2="250" stroke="#334155" stroke-width="1.5"/>

      <!-- Time labels -->
      <text x="100" y="270" fill="#94a3b8" font-size="8" text-anchor="middle">Jan</text>
      <text x="200" y="270" fill="#94a3b8" font-size="8" text-anchor="middle">Feb</text>
      <text x="280" y="270" fill="#f59e0b" font-size="8" text-anchor="middle" font-weight="600">Ticket Sale 1</text>
      <text x="420" y="270" fill="#ef4444" font-size="8" text-anchor="middle" font-weight="600">Ticket Sale 2</text>
      <text x="560" y="270" fill="#94a3b8" font-size="8" text-anchor="middle">Jun</text>
      <text x="700" y="270" fill="#FF5A5F" font-size="9" text-anchor="middle" font-weight="700">OLYMPICS</text>
      <text x="850" y="270" fill="#94a3b8" font-size="8" text-anchor="middle">Sep</text>
      <text x="940" y="270" fill="#94a3b8" font-size="8" text-anchor="middle">Oct</text>

      <!-- Normal baseline traffic -->
      <path d="M60,210 L100,210 L150,208 L200,207 L240,206" fill="none" stroke="#94a3b8" stroke-width="2"/>

      <!-- First ticket sale spike -->
      <path d="M240,206 L260,180 L280,120 L300,140 L330,170 L370,190" fill="none" stroke="#f59e0b" stroke-width="2.5"/>
      <circle cx="280" cy="120" r="4" fill="#f59e0b"/>
      <text x="280" y="110" fill="#f59e0b" font-size="8" text-anchor="middle" font-weight="600">6x search spike</text>

      <!-- Between sales -->
      <path d="M370,190 L400,195" fill="none" stroke="#94a3b8" stroke-width="2"/>

      <!-- Second ticket sale mega spike -->
      <path d="M400,195 L410,160 L420,70 L430,65 L440,72 L460,110 L500,160 L540,185" fill="none" stroke="#ef4444" stroke-width="3"/>
      <circle cx="430" cy="65" r="5" fill="#ef4444"/>
      <text x="430" y="52" fill="#ef4444" font-size="9" text-anchor="middle" font-weight="700">9x in 4 days!</text>

      <!-- Build up to Olympics -->
      <path d="M540,185 L580,180 L620,165 L650,140" fill="none" stroke="#FF5A5F" stroke-width="2"/>

      <!-- Olympics sustained peak -->
      <rect x="650" y="45" width="100" height="210" rx="0" fill="rgba(255,90,95,0.08)"/>
      <path d="M650,140 L660,90 L680,75 L700,68 L720,72 L740,80 L750,85" fill="none" stroke="#FF5A5F" stroke-width="3"/>
      <circle cx="700" cy="68" r="5" fill="#FF5A5F"/>
      <text x="700" y="55" fill="#FF5A5F" font-size="9" text-anchor="middle" font-weight="700">PEAK: 400% bookings</text>

      <!-- Post Olympics drop -->
      <path d="M750,85 L780,150 L820,190 L860,205 L900,208 L960,210" fill="none" stroke="#94a3b8" stroke-width="2"/>

      <!-- Capacity line -->
      <line x1="60" y1="80" x2="960" y2="80" stroke="#10b981" stroke-width="1.5" stroke-dasharray="8,4"/>
      <text x="970" y="84" fill="#10b981" font-size="8" font-weight="600">Auto-scaled capacity</text>

      <!-- Fixed capacity line -->
      <line x1="60" y1="155" x2="960" y2="155" stroke="#ef4444" stroke-width="1" stroke-dasharray="4,4"/>
      <text x="970" y="159" fill="#ef4444" font-size="8">Fixed capacity (failure zone &uarr;)</text>
    </svg>
  </div>

  <!-- Back of envelope for peak -->
  <h3>Back-of-Envelope: Olympics Peak Load</h3>
  <table>
    <thead>
      <tr><th>Metric</th><th>Normal Day</th><th>Olympics Peak (10x)</th><th>Impact</th></tr>
    </thead>
    <tbody>
      <tr><td><strong>Search QPS</strong></td><td>~580</td><td style="color:var(--primary);font-weight:700;">~5,800</td><td>Elasticsearch cluster must scale 10x</td></tr>
      <tr><td><strong>Listing Views QPS</strong></td><td>~1,160</td><td style="color:var(--primary);font-weight:700;">~11,600</td><td>Redis cache hit rate becomes critical</td></tr>
      <tr><td><strong>Booking TPS</strong></td><td>~17</td><td style="color:var(--primary);font-weight:700;">~170</td><td>Still manageable with PostgreSQL! ACID holds.</td></tr>
      <tr><td><strong>Concurrent Users</strong></td><td>~100K</td><td style="color:var(--primary);font-weight:700;">~1M</td><td>API Gateway &amp; session store under pressure</td></tr>
      <tr><td><strong>Paris Listings Searched</strong></td><td>~30K</td><td style="color:var(--primary);font-weight:700;">~60K</td><td>2x listings = bigger search index for Paris shard</td></tr>
      <tr><td><strong>Contention (same listing)</strong></td><td>Rare</td><td style="color:var(--danger);font-weight:700;">High</td><td>Multiple guests racing for same dates &mdash; lock contention rises</td></tr>
    </tbody>
  </table>

  <div class="tip-box tip-warning">
    <div class="tip-title" style="color:var(--warning);">&#9888; The Critical Insight</div>
    <p>Even at 10x traffic, booking writes only reach ~170 TPS. PostgreSQL handles 10,000+ TPS easily. <strong>The bottleneck is NOT the database &mdash; it's the read path</strong> (search, listing views, availability checks). This shapes our entire scaling strategy: scale reads aggressively, keep writes simple.</p>
  </div>

  <!-- Strategy cards -->
  <h3>7-Layer Scaling Strategy for Peak Events</h3>

  <div class="card" style="border-left:4px solid var(--primary);margin-bottom:15px;">
    <div class="card-header" style="color:var(--primary);">&#9312; Pre-Event Capacity Planning (Weeks Before)</div>
    <div class="card-grid" style="margin-top:8px;">
      <div>
        <h4 style="border:none;padding:0;margin:0 0 6px;">Predictive Scaling</h4>
        <ul>
          <li>Analyze ticket sale dates &rarr; pre-scale 3 days before each sale window</li>
          <li>Use historical data: World Cup, Super Bowl, prior Olympics patterns</li>
          <li>Pre-warm Elasticsearch with Paris-region index replicas</li>
          <li>Increase Redis cluster to handle 10x cache reads</li>
        </ul>
      </div>
      <div>
        <h4 style="border:none;padding:0;margin:0 0 6px;">Infrastructure Pre-provisioning</h4>
        <pre style="font-size:0.8em;margin:0;"><span class="comment"># Kubernetes HPA won't react fast enough for 9x spikes</span>
<span class="comment"># Pre-scale pods BEFORE the event</span>
kubectl scale deployment search-svc --replicas=<span class="number">60</span>
kubectl scale deployment booking-svc --replicas=<span class="number">20</span>
kubectl scale deployment listing-svc --replicas=<span class="number">30</span>

<span class="comment"># Add Elasticsearch replicas for Paris index</span>
<span class="keyword">PUT</span> /listings-paris/_settings
{ <span class="string">"number_of_replicas"</span>: <span class="number">5</span> }  <span class="comment">// normally 2</span></pre>
      </div>
    </div>
  </div>

  <div class="card" style="border-left:4px solid var(--secondary);margin-bottom:15px;">
    <div class="card-header" style="color:var(--secondary);">&#9313; Multi-Layer Caching (The Read Shield)</div>
    <div class="diagram-box" style="margin:10px 0;padding:15px;">
      <svg viewBox="0 0 900 120" xmlns="http://www.w3.org/2000/svg" style="font-family:Segoe UI,sans-serif;">
        <text x="15" y="20" fill="#94a3b8" font-size="10" font-weight="600">CACHING LAYERS (left absorbs most traffic, right sees least)</text>

        <rect x="15" y="35" width="150" height="55" rx="8" fill="rgba(255,90,95,0.15)" stroke="#FF5A5F" stroke-width="1.5"/>
        <text x="90" y="55" fill="#FF5A5F" font-size="10" font-weight="700" text-anchor="middle">CDN Edge Cache</text>
        <text x="90" y="70" fill="#94a3b8" font-size="8" text-anchor="middle">Static assets + listing photos</text>
        <text x="90" y="82" fill="#10b981" font-size="9" font-weight="600" text-anchor="middle">Absorbs ~60% reads</text>

        <text x="175" y="62" fill="#94a3b8" font-size="14">&#8594;</text>

        <rect x="195" y="35" width="160" height="55" rx="8" fill="rgba(0,166,153,0.15)" stroke="#00A699" stroke-width="1.5"/>
        <text x="275" y="55" fill="#00A699" font-size="10" font-weight="700" text-anchor="middle">Application Cache (Redis)</text>
        <text x="275" y="70" fill="#94a3b8" font-size="8" text-anchor="middle">Listing details, pricing, reviews</text>
        <text x="275" y="82" fill="#10b981" font-size="9" font-weight="600" text-anchor="middle">Absorbs ~25% reads</text>

        <text x="365" y="62" fill="#94a3b8" font-size="14">&#8594;</text>

        <rect x="385" y="35" width="160" height="55" rx="8" fill="rgba(66,139,249,0.15)" stroke="#428BF9" stroke-width="1.5"/>
        <text x="465" y="55" fill="#428BF9" font-size="10" font-weight="700" text-anchor="middle">Search Cache (ES)</text>
        <text x="465" y="70" fill="#94a3b8" font-size="8" text-anchor="middle">Popular Paris queries cached</text>
        <text x="465" y="82" fill="#10b981" font-size="9" font-weight="600" text-anchor="middle">Absorbs ~10% reads</text>

        <text x="555" y="62" fill="#94a3b8" font-size="14">&#8594;</text>

        <rect x="575" y="35" width="140" height="55" rx="8" fill="rgba(123,47,247,0.15)" stroke="#7B2FF7" stroke-width="1.5"/>
        <text x="645" y="55" fill="#7B2FF7" font-size="10" font-weight="700" text-anchor="middle">Database (PostgreSQL)</text>
        <text x="645" y="70" fill="#94a3b8" font-size="8" text-anchor="middle">Source of truth</text>
        <text x="645" y="82" fill="#f59e0b" font-size="9" font-weight="600" text-anchor="middle">Only ~5% reaches DB</text>

        <!-- Funnel visualization -->
        <rect x="760" y="30" width="120" height="65" rx="8" fill="#f8fafc" stroke="#334155"/>
        <text x="820" y="48" fill="#1e293b" font-size="8" font-weight="600" text-anchor="middle">TRAFFIC FUNNEL</text>
        <text x="820" y="62" fill="#FF5A5F" font-size="8" text-anchor="middle">11,600 QPS in</text>
        <text x="820" y="74" fill="#10b981" font-size="8" text-anchor="middle">&#8595; 95% absorbed</text>
        <text x="820" y="86" fill="#7B2FF7" font-size="8" text-anchor="middle">580 QPS to DB</text>
      </svg>
    </div>
    <ul>
      <li><strong>Stale-while-revalidate:</strong> Serve cached listing data (even if 30s stale) while fetching fresh. Users don't notice 30s-old pricing during browsing.</li>
      <li><strong>Query result caching:</strong> Cache top 100 Paris search queries in Redis (key = hash of filters). TTL = 60s. Covers 80% of searches.</li>
      <li><strong>Availability bitmap cache:</strong> Cache per-listing availability as a Redis bitmap. 1 bit per day for 365 days = 46 bytes per listing. 60K Paris listings = ~3 MB total!</li>
    </ul>
  </div>

  <div class="card" style="border-left:4px solid var(--blue);margin-bottom:15px;">
    <div class="card-header" style="color:var(--blue);">&#9314; Booking Queue &amp; Virtual Waiting Room</div>
    <p>When thousands compete for the same listing on the same dates, a <strong>virtual waiting room</strong> prevents thundering herd:</p>
    <div class="diagram-box" style="margin:10px 0;padding:15px;">
      <svg viewBox="0 0 900 130" xmlns="http://www.w3.org/2000/svg" style="font-family:Segoe UI,sans-serif;">
        <!-- Users -->
        <text x="50" y="20" fill="#94a3b8" font-size="10" font-weight="600" text-anchor="middle">500 users want</text>
        <text x="50" y="32" fill="#94a3b8" font-size="10" font-weight="600" text-anchor="middle">same listing</text>
        <rect x="10" y="45" width="80" height="40" rx="6" fill="rgba(255,90,95,0.2)" stroke="#FF5A5F"/>
        <text x="50" y="63" fill="#FF5A5F" font-size="20" text-anchor="middle">&#128101;</text>
        <text x="50" y="75" fill="#FF5A5F" font-size="8" text-anchor="middle">500 requests</text>
        <text x="100" y="65" fill="#94a3b8" font-size="14">&#8594;</text>

        <!-- Queue -->
        <rect x="120" y="40" width="180" height="50" rx="8" fill="rgba(245,158,11,0.15)" stroke="#f59e0b" stroke-width="1.5"/>
        <text x="210" y="58" fill="#f59e0b" font-size="10" font-weight="700" text-anchor="middle">Booking Queue</text>
        <text x="210" y="72" fill="#94a3b8" font-size="8" text-anchor="middle">FIFO | Rate: 10 req/sec per listing</text>
        <text x="210" y="83" fill="#94a3b8" font-size="7" text-anchor="middle">Users see: "Processing... position #42"</text>
        <text x="310" y="65" fill="#94a3b8" font-size="14">&#8594;</text>

        <!-- Processing -->
        <rect x="330" y="40" width="150" height="50" rx="8" fill="rgba(66,139,249,0.15)" stroke="#428BF9" stroke-width="1.5"/>
        <text x="405" y="58" fill="#428BF9" font-size="10" font-weight="700" text-anchor="middle">Sequential Processing</text>
        <text x="405" y="72" fill="#94a3b8" font-size="8" text-anchor="middle">SELECT...FOR UPDATE</text>
        <text x="405" y="83" fill="#94a3b8" font-size="7" text-anchor="middle">One at a time per listing</text>

        <!-- Outcomes -->
        <line x1="480" y1="55" x2="530" y2="45" stroke="#10b981" stroke-width="1.5"/>
        <line x1="480" y1="75" x2="530" y2="85" stroke="#ef4444" stroke-width="1.5"/>

        <rect x="535" y="30" width="120" height="30" rx="6" fill="rgba(16,185,129,0.15)" stroke="#10b981"/>
        <text x="595" y="50" fill="#10b981" font-size="9" font-weight="600" text-anchor="middle">&#10003; 1 Winner booked!</text>

        <rect x="535" y="70" width="160" height="30" rx="6" fill="rgba(239,68,68,0.15)" stroke="#ef4444"/>
        <text x="615" y="90" fill="#ef4444" font-size="9" font-weight="600" text-anchor="middle">&#10007; 499 get "Sold out" + alternatives</text>

        <!-- Smart redirect -->
        <line x1="700" y1="85" x2="740" y2="85" stroke="#7B2FF7" stroke-width="1.5"/>
        <rect x="745" y="70" width="140" height="35" rx="6" fill="rgba(123,47,247,0.15)" stroke="#7B2FF7"/>
        <text x="815" y="85" fill="#7B2FF7" font-size="8" font-weight="600" text-anchor="middle">&#127968; Show similar listings</text>
        <text x="815" y="97" fill="#94a3b8" font-size="7" text-anchor="middle">nearby + same dates + avail</text>
      </svg>
    </div>
    <pre style="font-size:0.85em;"><span class="comment">// Booking rate limiter per listing (Token Bucket)</span>
<span class="keyword">const</span> rateLimiter = {
  key: <span class="string">`booking:rate:${listingId}`</span>,
  maxTokens: <span class="number">10</span>,           <span class="comment">// 10 concurrent booking attempts per listing</span>
  refillRate: <span class="number">2</span>,           <span class="comment">// 2 tokens/sec</span>
  windowMs: <span class="number">5000</span>           <span class="comment">// 5 second window</span>
};

<span class="comment">// If rate limit exceeded &rarr; user enters virtual queue</span>
<span class="comment">// WebSocket pushes position updates: "You're #42 in line..."</span>
<span class="comment">// When their turn comes, they get a 60-second reservation hold</span></pre>
  </div>

  <div class="card" style="border-left:4px solid var(--purple);margin-bottom:15px;">
    <div class="card-header" style="color:var(--purple);">&#9315; Geo-Sharded Search Index</div>
    <p>During the Olympics, 80%+ of searches target Paris. A single Elasticsearch index becomes a hotspot. Solution: <strong>geo-shard the index</strong>.</p>
    <div class="comparison">
      <div class="card option-a" style="margin:0;">
        <div class="card-header" style="color:var(--secondary);">Before: Single Global Index</div>
        <ul>
          <li>All 7M listings in one index</li>
          <li>Paris queries = 80% of load on all shards</li>
          <li>Hot shard problem</li>
        </ul>
      </div>
      <div class="card option-b" style="margin:0;">
        <div class="card-header" style="color:var(--accent);">After: Regional Indexes</div>
        <ul>
          <li><code>listings-paris</code> &rarr; 5 replicas, dedicated nodes</li>
          <li><code>listings-europe</code> &rarr; 3 replicas</li>
          <li><code>listings-global</code> &rarr; 2 replicas (fallback)</li>
          <li>Route by detected search region</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="card" style="border-left:4px solid var(--accent);margin-bottom:15px;">
    <div class="card-header" style="color:var(--accent);">&#9316; Dynamic Pricing Under Surge</div>
    <p>Prices rose <strong>5x</strong> during the Olympics (&euro;141 &rarr; &euro;706). The pricing engine must handle rapid recalculation:</p>
    <div class="card-grid" style="margin-top:8px;">
      <div style="background:rgba(255,90,95,0.05);padding:12px;border-radius:8px;border:1px solid var(--card-border);">
        <strong style="color:var(--primary);">Real-Time Signals</strong>
        <ul>
          <li>Search-to-book ratio per neighborhood</li>
          <li>Remaining inventory for date range</li>
          <li>Competitor pricing (hotels, Booking.com)</li>
          <li>Event schedule (opening ceremony, finals)</li>
        </ul>
      </div>
      <div style="background:rgba(0,166,153,0.05);padding:12px;border-radius:8px;border:1px solid var(--card-border);">
        <strong style="color:var(--secondary);">Pricing Strategy</strong>
        <ul>
          <li><strong>Event multiplier:</strong> 2x-5x base for Olympics dates</li>
          <li><strong>Proximity boost:</strong> +30% within 2km of venues</li>
          <li><strong>Scarcity surge:</strong> Last 10% inventory = +50%</li>
          <li><strong>Advance booking discount:</strong> -15% if booked 6mo early</li>
        </ul>
      </div>
      <div style="background:rgba(66,139,249,0.05);padding:12px;border-radius:8px;border:1px solid var(--card-border);">
        <strong style="color:var(--blue);">Anti-Gouging Guardrails</strong>
        <ul>
          <li>Price cap: Max 8x the 90-day average</li>
          <li>Host notifications when price exceeds 3x</li>
          <li>Regulatory compliance (Paris cap laws)</li>
          <li>Price transparency: "X% higher than usual"</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="card" style="border-left:4px solid var(--success);margin-bottom:15px;">
    <div class="card-header" style="color:var(--success);">&#9317; Graceful Degradation Playbook</div>
    <p>When load exceeds capacity, degrade non-critical features to protect the booking path:</p>
    <table>
      <thead>
        <tr><th>Priority</th><th>Feature</th><th>Normal Mode</th><th>Degraded Mode (Olympics Peak)</th></tr>
      </thead>
      <tbody>
        <tr>
          <td><span class="badge badge-red" style="margin:0;">P0</span></td>
          <td><strong>Booking &amp; Payment</strong></td>
          <td>Full functionality</td>
          <td style="color:var(--success);">Never degraded &mdash; this is revenue</td>
        </tr>
        <tr>
          <td><span class="badge badge-orange" style="margin:0;">P1</span></td>
          <td><strong>Search</strong></td>
          <td>Real-time availability</td>
          <td>Cached results (30s stale), simplified ranking</td>
        </tr>
        <tr>
          <td><span class="badge badge-blue" style="margin:0;">P2</span></td>
          <td><strong>Reviews</strong></td>
          <td>Load all reviews, pagination</td>
          <td>Show top 5 reviews only, no pagination</td>
        </tr>
        <tr>
          <td><span class="badge badge-purple" style="margin:0;">P3</span></td>
          <td><strong>Recommendations</strong></td>
          <td>ML-powered personalization</td>
          <td>Simple "popular in area" fallback</td>
        </tr>
        <tr>
          <td><span class="badge badge-purple" style="margin:0;">P3</span></td>
          <td><strong>Messaging</strong></td>
          <td>Real-time WebSocket</td>
          <td>Polling every 30s, delayed delivery</td>
        </tr>
        <tr>
          <td><span class="badge badge-green" style="margin:0;">P4</span></td>
          <td><strong>Host Analytics</strong></td>
          <td>Real-time dashboard</td>
          <td>Disabled entirely, show "temporarily unavailable"</td>
        </tr>
      </tbody>
    </table>
    <pre style="font-size:0.8em;margin-top:10px;"><span class="comment">// Feature flag-driven degradation (LaunchDarkly / custom)</span>
<span class="keyword">if</span> (featureFlags.get(<span class="string">'olympics-peak-mode'</span>)) {
  searchService.useCache({ ttl: <span class="number">30</span>, staleWhileRevalidate: <span class="keyword">true</span> });
  reviewsService.limitTo(<span class="number">5</span>);
  recommendationService.useFallback(<span class="string">'popular-nearby'</span>);
  messagingService.switchToPolling({ intervalMs: <span class="number">30000</span> });
  analyticsService.disable();
}</pre>
  </div>

  <div class="card" style="border-left:4px solid var(--danger);margin-bottom:15px;">
    <div class="card-header" style="color:var(--danger);">&#9318; Lock Contention Management at Scale</div>
    <p>During the Olympics, 500 users might try booking the same Eiffel Tower apartment on the same dates. The <code>SELECT ... FOR UPDATE</code> approach faces contention.</p>
    <div class="comparison">
      <div class="card option-a" style="margin:0;">
        <div class="card-header" style="color:var(--secondary);">Solution: Two-Phase Booking</div>
        <ol style="padding-left:18px;">
          <li><strong>Soft Hold (Redis, 60s TTL):</strong> First user to click "Reserve" gets a soft hold. Others see "This listing is being booked..."</li>
          <li><strong>Hard Lock (PostgreSQL):</strong> Only when payment is initiated, acquire the DB lock. Reduces DB contention by 99%.</li>
        </ol>
        <pre style="font-size:0.8em;margin-top:8px;"><span class="comment">// Phase 1: Redis soft hold</span>
<span class="func">SETNX</span> hold:lst_abc123:2025-07-26 <span class="string">"user_42"</span> EX <span class="number">60</span>
<span class="comment">// If acquired &rarr; show payment form</span>
<span class="comment">// If NOT &rarr; "Being booked, try similar listings"</span>

<span class="comment">// Phase 2: DB lock only during payment</span>
<span class="keyword">BEGIN</span>;
<span class="keyword">SELECT</span> ... <span class="keyword">FOR UPDATE</span>; <span class="comment">// brief lock</span>
<span class="keyword">INSERT</span> reservation;
<span class="keyword">COMMIT</span>; <span class="comment">// ~50ms total</span></pre>
      </div>
      <div class="card option-b" style="margin:0;">
        <div class="card-header" style="color:var(--accent);">Impact on Contention</div>
        <div class="bar-chart">
          <div class="bar-row"><span class="bar-label" style="width:140px;">Without soft hold</span><div class="bar-track"><div class="bar-fill" style="width:90%;background:var(--danger);">500 DB locks/sec</div></div></div>
          <div class="bar-row"><span class="bar-label" style="width:140px;">With soft hold</span><div class="bar-track"><div class="bar-fill" style="width:8%;background:var(--success);">~5 DB locks/sec</div></div></div>
        </div>
        <p style="margin-top:10px;font-size:0.9em;">Redis SETNX handles <strong>100,000+ ops/sec</strong>. It filters 99% of contending requests before they reach PostgreSQL, keeping the critical path fast and lock-free for most users.</p>
      </div>
    </div>
  </div>

  <div class="card" style="border-left:4px solid var(--warning);margin-bottom:15px;">
    <div class="card-header" style="color:var(--warning);">&#9319; Post-Booking: Oversupply &amp; Market Rebalancing</div>
    <p>The Paris Olympics also revealed a <strong>cautionary tale</strong>: listings increased 87%, but occupancy dropped below 50% &mdash; oversupply.</p>
    <div class="card-grid" style="margin-top:8px;">
      <div>
        <h4 style="border:none;padding:0;margin:0 0 6px;color:var(--warning);">What Happened</h4>
        <ul>
          <li>Listings in Saint-Denis multiplied <strong>5x</strong> in two years</li>
          <li>First-time hosts flooded the market expecting huge returns</li>
          <li>ADR dropped as supply outpaced demand</li>
          <li>Many hosts earned less than expected despite the Olympics</li>
        </ul>
      </div>
      <div>
        <h4 style="border:none;padding:0;margin:0 0 6px;color:var(--success);">System Design Lessons</h4>
        <ul>
          <li><strong>Supply-side rate limiting:</strong> Cap new listing approvals in saturated zones</li>
          <li><strong>Host pricing guidance:</strong> "Your area has 3x more listings than demand &mdash; consider lowering price"</li>
          <li><strong>Demand redistribution:</strong> Promote under-served neighborhoods in search ranking</li>
          <li><strong>Data pipeline:</strong> Real-time supply/demand heatmaps for dynamic market balancing</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="tip-box tip-interview">
    <div class="tip-title" style="color:var(--purple);">&#128161; Interview Tip: The Olympics Question</div>
    <p>If asked "How would you handle Olympics-level traffic?", <strong>don't just say 'auto-scale'</strong>. Walk through this framework:</p>
    <ol style="padding-left:20px;">
      <li><strong>Quantify</strong>: "9x search spike means ~5,800 QPS; but booking writes only go to ~170 TPS"</li>
      <li><strong>Identify the bottleneck</strong>: "Reads are the problem, not writes. My scaling strategy targets reads."</li>
      <li><strong>Layer the solution</strong>: "CDN absorbs 60%, Redis absorbs 25%, only 5% hits the DB"</li>
      <li><strong>Handle contention</strong>: "Two-phase booking: Redis soft hold filters 99% before DB locks"</li>
      <li><strong>Degrade gracefully</strong>: "Feature flags disable reviews, analytics, personalization to protect booking flow"</li>
      <li><strong>Mention the real lesson</strong>: "The oversupply problem shows system design isn't just about scaling &mdash; it's about market dynamics too"</li>
    </ol>
    <p style="margin-top:8px;">This demonstrates you think about <em>real production systems</em>, not textbook answers.</p>
  </div>

  <p style="color:var(--text-muted);font-size:0.85em;margin-top:15px;">
    Source: <a href="https://news.airbnb.com/bookings-in-the-paris-region-during-the-olympic-games-up-400/" target="_blank" style="color:var(--blue);">Airbnb Newsroom &mdash; Paris Olympics 400% booking increase</a> |
    <a href="https://www.lodgify.com/blog/report-olympic-games-paris/" target="_blank" style="color:var(--blue);">Lodgify &mdash; STR Price Report</a> |
    <a href="https://skift.com/2024/05/15/short-term-rental-platforms-are-seeing-a-paris-olympics-spike/" target="_blank" style="color:var(--blue);">Skift &mdash; Olympics Spike Analysis</a>
  </p>
</section>

<!-- ==================== SECTION 13: INTERVIEW TIPS ==================== -->
<section id="interview-tips">
  <h2><span class="icon" style="background:linear-gradient(135deg,var(--purple),var(--primary));">&#127891;</span> Interview Tips &amp; Strategy</h2>

  <h3>The 4-Phase Framework (45 min interview)</h3>
  <div class="card-grid">
    <div class="card" style="border-top:3px solid var(--primary);">
      <div class="card-header" style="color:var(--primary);">Phase 1: Scope (3-5 min)</div>
      <ul>
        <li>Clarify: "Full Airbnb or reservation subsystem?"</li>
        <li>Define core features (search, book, pay)</li>
        <li>State non-functional requirements explicitly</li>
        <li>Set scale numbers (users, QPS, storage)</li>
      </ul>
      <div class="tip-box tip-success" style="margin:10px 0 0 0;padding:10px;">
        <strong>Say:</strong> "Let me focus on the booking and search flows as the core. I'll design for 150M users, ~1K read QPS, and ~17 write TPS."
      </div>
    </div>
    <div class="card" style="border-top:3px solid var(--secondary);">
      <div class="card-header" style="color:var(--secondary);">Phase 2: High-Level Design (10-15 min)</div>
      <ul>
        <li>Draw the architecture diagram on the whiteboard</li>
        <li>Name the services and their responsibilities</li>
        <li>Show the data flow for key operations</li>
        <li>Mention the database choices with brief justification</li>
      </ul>
      <div class="tip-box tip-success" style="margin:10px 0 0 0;padding:10px;">
        <strong>Say:</strong> "I'll use PostgreSQL for bookings because ACID matters, Elasticsearch for search because we need geo + filter, and Kafka for async event processing."
      </div>
    </div>
    <div class="card" style="border-top:3px solid var(--blue);">
      <div class="card-header" style="color:var(--blue);">Phase 3: Deep Dive (15-20 min)</div>
      <ul>
        <li>Dive into double-booking prevention</li>
        <li>Walk through the booking sequence diagram</li>
        <li>Explain the search pipeline and CQRS</li>
        <li>Discuss failure scenarios and mitigation</li>
      </ul>
      <div class="tip-box tip-success" style="margin:10px 0 0 0;padding:10px;">
        <strong>Say:</strong> "The critical problem is double-booking. At our scale, pessimistic locking is perfect because..." then show the SQL.
      </div>
    </div>
    <div class="card" style="border-top:3px solid var(--purple);">
      <div class="card-header" style="color:var(--purple);">Phase 4: Scale &amp; Trade-offs (5-10 min)</div>
      <ul>
        <li>Discuss how the system handles 10x growth</li>
        <li>Mention caching strategy and invalidation</li>
        <li>Talk about multi-region deployment</li>
        <li>Proactively discuss trade-offs you made</li>
      </ul>
      <div class="tip-box tip-success" style="margin:10px 0 0 0;padding:10px;">
        <strong>Say:</strong> "I chose local ACID over distributed transactions because our write TPS doesn't justify the complexity. If we grew to 10K TPS, I'd consider sharding by region."
      </div>
    </div>
  </div>

  <h3>Common Interviewer Questions &amp; Killer Answers</h3>
  <table>
    <thead>
      <tr><th style="width:40%;">Question</th><th>Principal-Level Answer</th></tr>
    </thead>
    <tbody>
      <tr>
        <td><strong>"How do you prevent double booking?"</strong></td>
        <td>Use <code>SELECT ... FOR UPDATE</code> within an ACID transaction. At 17 TPS, lock contention is negligible. Mention you'd use optimistic locking or distributed locks only if you measure contention. Always mention the <strong>idempotency key</strong> pattern for client retries.</td>
      </tr>
      <tr>
        <td><strong>"What if two users see the listing as available but one has already booked?"</strong></td>
        <td>Search results are <strong>eventually consistent</strong> (ES index ~1-2s lag). Availability is confirmed at booking time with a strong consistency check against PostgreSQL. The user who loses the race gets a <code>409 Conflict</code>. This is acceptable &mdash; Airbnb itself works this way.</td>
      </tr>
      <tr>
        <td><strong>"Why not use a NoSQL database?"</strong></td>
        <td>Booking is a <strong>financial transaction</strong> that requires ACID guarantees. NoSQL databases sacrifice consistency for availability. I'd rather have a booking fail than a double booking. PostgreSQL handles our write volume easily, and read replicas cover read scaling.</td>
      </tr>
      <tr>
        <td><strong>"How do you handle peak traffic?"</strong></td>
        <td>Auto-scale stateless services (K8s HPA). Cache hot listings in Redis. Search is served from Elasticsearch (independent scaling). Booking writes are naturally throttled by payment gateway latency. Use a queue (Kafka) to buffer notification spikes.</td>
      </tr>
      <tr>
        <td><strong>"How would you shard the database?"</strong></td>
        <td>Shard by <code>listing_id</code> (hash-based). This ensures all booking writes for a listing go to the same shard, maintaining ACID within the shard. Cross-shard queries (user's booking history) are served via a separate read-optimized store or async materialization.</td>
      </tr>
      <tr>
        <td><strong>"What metrics would you monitor?"</strong></td>
        <td>RED method: Rate, Errors, Duration per service. Business metrics: booking conversion rate, double-booking incidents (must be zero), payment failure rate, search latency p99. Use distributed tracing (Jaeger) to debug cross-service latency spikes.</td>
      </tr>
    </tbody>
  </table>

  <h3>What Separates Senior from Principal</h3>
  <div class="comparison">
    <div class="card option-a">
      <div class="card-header" style="color:var(--secondary);">Senior Engineer</div>
      <ul>
        <li>Picks the right tech for each component</li>
        <li>Knows how microservices work</li>
        <li>Can design a working system</li>
        <li>Handles one deep-dive well</li>
      </ul>
    </div>
    <div class="card option-b">
      <div class="card-header" style="color:var(--accent);">Principal Engineer</div>
      <ul>
        <li>Explains <em>why</em> each choice matters AND what the trade-off is</li>
        <li>Knows when NOT to use microservices</li>
        <li>Designs for failure &mdash; graceful degradation by default</li>
        <li>Connects tech decisions to business impact</li>
        <li>Discusses <strong>observability and operability</strong> proactively</li>
        <li>Knows the numbers &mdash; can estimate QPS, storage, costs</li>
      </ul>
    </div>
  </div>

  <div class="tip-box tip-interview">
    <div class="tip-title" style="color:var(--purple);">&#128161; Golden Rules for System Design Interviews</div>
    <ol style="padding-left:20px;">
      <li><strong>Start simple, add complexity with justification.</strong> Don't open with Kafka + Redis + Elasticsearch. Start with a monolith and evolve.</li>
      <li><strong>Numbers matter.</strong> Back-of-envelope estimates show you understand scale.</li>
      <li><strong>Trade-offs over absolutes.</strong> Never say "X is the best." Say "X is best for our use case because Y, but if Z changed, I'd consider W."</li>
      <li><strong>Failure is the default.</strong> Everything fails. Discuss how your system handles it.</li>
      <li><strong>Don't over-engineer.</strong> If 17 TPS works with a single DB, don't propose a 10-node CockroachDB cluster. Match the solution to the problem.</li>
    </ol>
  </div>
</section>

<!-- ==================== SECTION 13: SOURCES ==================== -->
<section id="sources">
  <h2><span class="icon" style="background:linear-gradient(135deg,var(--success),var(--secondary));">&#128218;</span> Sources &amp; Further Reading</h2>

  <div class="card-grid">
    <div class="card">
      <div class="card-header" style="color:var(--primary);">System Design References</div>
      <ul>
        <li><a href="https://www.geeksforgeeks.org/system-design/system-design-of-airbnb-hotel-reservation-system/" target="_blank" style="color:var(--blue);text-decoration:none;">GeeksforGeeks &mdash; System Design of Airbnb</a></li>
        <li><a href="https://newsletter.systemdesign.one/p/airbnb-system-design" target="_blank" style="color:var(--blue);text-decoration:none;">System Design One &mdash; Airbnb System Design Newsletter</a></li>
        <li><a href="https://grokkingthesystemdesign.com/guides/airbnb-system-design/" target="_blank" style="color:var(--blue);text-decoration:none;">Grokking the System Design &mdash; Airbnb Step-by-Step</a></li>
        <li><a href="https://www.systemdesignhandbook.com/guides/airbnb-system-design-interview/" target="_blank" style="color:var(--blue);text-decoration:none;">System Design Handbook &mdash; Airbnb Interview Guide</a></li>
        <li><a href="https://www.codekarle.com/system-design/Airbnb-system-design.html" target="_blank" style="color:var(--blue);text-decoration:none;">CodeKarle &mdash; Airbnb / Booking.com System Design</a></li>
      </ul>
    </div>
    <div class="card">
      <div class="card-header" style="color:var(--secondary);">Deep Dive Topics</div>
      <ul>
        <li><a href="https://itnext.io/solving-double-booking-at-scale-system-design-patterns-from-top-tech-companies-4c5a3311d8ea" target="_blank" style="color:var(--blue);text-decoration:none;">ITNext &mdash; Solving Double Booking at Scale</a></li>
        <li><a href="https://github.com/puncsky/system-design-and-architecture/blob/master/en/177-designing-Airbnb-or-a-hotel-booking-system.md" target="_blank" style="color:var(--blue);text-decoration:none;">GitHub &mdash; System Design &amp; Architecture</a></li>
        <li><a href="https://drawsql.app/templates/airbnb" target="_blank" style="color:var(--blue);text-decoration:none;">DrawSQL &mdash; Airbnb Database Schema Template</a></li>
        <li><a href="https://medium.com/towards-data-engineering/data-modelling-design-a-data-model-for-a-hotel-booking-system-like-airbnb-2110a6d079c6" target="_blank" style="color:var(--blue);text-decoration:none;">Medium &mdash; Data Modeling for Hotel Booking</a></li>
        <li><a href="https://github.com/raisaat/Airbnb-Database" target="_blank" style="color:var(--blue);text-decoration:none;">GitHub &mdash; Airbnb Database Reverse-Engineered</a></li>
      </ul>
    </div>
  </div>
</section>

</div><!-- end container -->

<!-- ==================== FOOTER ==================== -->
<footer>
  <p style="font-size:1.1em;margin-bottom:8px;"><strong>Airbnb Reservation System Design</strong> &mdash; Principal Engineer Level</p>
  <p>Built for system design interviews and architecture review. Covers search, booking, payments, concurrency, and operational excellence.</p>
  <p style="margin-top:10px;">
    Sources:
    <a href="https://newsletter.systemdesign.one/p/airbnb-system-design">System Design One</a> &bull;
    <a href="https://www.geeksforgeeks.org/system-design/system-design-of-airbnb-hotel-reservation-system/">GeeksforGeeks</a> &bull;
    <a href="https://grokkingthesystemdesign.com/guides/airbnb-system-design/">Grokking SD</a> &bull;
    <a href="https://itnext.io/solving-double-booking-at-scale-system-design-patterns-from-top-tech-companies-4c5a3311d8ea">ITNext</a>
  </p>
</footer>

<script>
(function(){
  document.querySelectorAll(".diagram-box").forEach(function(box){
    var svg=box.querySelector("svg");
    if(!svg) return;
    var zoom=1, minZ=0.5, maxZ=3;
    var ctrl=document.createElement("div");
    ctrl.className="diagram-zoom-controls";
    ctrl.innerHTML='<button class="zoom-out" title="Zoom Out"></button><span class="zoom-level">100%</span><button class="zoom-in" title="Zoom In">+</button><button class="zoom-reset" title="Reset"></button><button class="zoom-fs" title="Fullscreen"></button>';
    box.insertBefore(ctrl,box.firstChild);
    var lvl=ctrl.querySelector(".zoom-level");
    function apply(){svg.style.transform="scale("+zoom+")";lvl.textContent=Math.round(zoom*100)+"%";}
    ctrl.querySelector(".zoom-in").onclick=function(){zoom=Math.min(maxZ,zoom+0.25);apply();};
    ctrl.querySelector(".zoom-out").onclick=function(){zoom=Math.max(minZ,zoom-0.25);apply();};
    ctrl.querySelector(".zoom-reset").onclick=function(){zoom=1;apply();};
    ctrl.querySelector(".zoom-fs").onclick=function(){
      box.classList.toggle("fullscreen");
      if(box.classList.contains("fullscreen")){this.textContent="";zoom=1.2;}else{this.textContent="";zoom=1;}
      apply();
    };
    box.addEventListener("wheel",function(e){
      if(e.ctrlKey){e.preventDefault();zoom=e.deltaY<0?Math.min(maxZ,zoom+0.1):Math.max(minZ,zoom-0.1);apply();}
    },{passive:false});
  });
})();
</script>
</body>
</html>
