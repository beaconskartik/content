<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Airbnb Subscription Model - Principal Engineer System Design</title>
<style>
  :root {
    --primary: #FF5A5F;
    --primary-dark: #E04850;
    --secondary: #00A699;
    --accent: #FC642D;
    --purple: #7B2FF7;
    --blue: #428BF9;
    --dark: #ffffff;
    --darker: #f1f5f9;
    --card-bg: #ffffff;
    --card-border: #e2e8f0;
    --text: #1e293b;
    --text-muted: #4b5563;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--dark);
    color: var(--text);
    line-height: 1.7;
    scroll-behavior: smooth;
  }

  /* ===== HERO ===== */
  .hero {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #6B73FF 100%);
    padding: 60px 40px 50px;
    text-align: center;
    border-bottom: 3px solid var(--primary);
    position: relative;
    overflow: hidden;
  }
  .hero::before {
    content: '';
    position: absolute;
    top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: radial-gradient(circle at 30% 50%, rgba(255,90,95,0.15) 0%, transparent 50%),
                radial-gradient(circle at 70% 50%, rgba(0,166,153,0.15) 0%, transparent 50%);
    animation: pulse 8s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
  .hero h1 {
    font-size: 2.6em;
    background: linear-gradient(135deg, #ffffff, #e0e7ff, #ffffff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    position: relative;
    margin-bottom: 10px;
  }
  .hero .subtitle {
    font-size: 1.15em;
    color: rgba(255,255,255,0.9);
    position: relative;
    margin-bottom: 8px;
  }
  .hero .topic-badges { position: relative; margin-top: 15px; }
  .hero .back-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-top: 18px;
    color: #ffffff;
    text-decoration: none;
    font-size: 0.95em;
    font-weight: 600;
    position: relative;
    border: 1px solid rgba(255,255,255,0.4);
    background: rgba(255,255,255,0.15);
    padding: 10px 24px;
    border-radius: 10px;
    transition: all 0.3s;
  }
  .hero .back-link:hover {
    background: rgba(255,255,255,0.25);
    border-color: #e5e7eb;
    transform: translateX(-3px);
  }
  .hero .stats-row {
    position: relative;
    display: flex;
    justify-content: center;
    gap: 40px;
    margin-top: 25px;
    flex-wrap: wrap;
  }
  .hero .stat-item { text-align: center; }
  .hero .stat-value {
    font-size: 1.8em;
    font-weight: 800;
    color: var(--primary);
  }
  .hero .stat-label {
    font-size: 0.78em;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1.5px;
  }

  /* ===== BADGES ===== */
  .badge {
    display: inline-block;
    padding: 4px 14px;
    border-radius: 20px;
    font-size: 0.78em;
    font-weight: 600;
    margin: 3px 2px;
    white-space: nowrap;
  }
  .badge-red { background: rgba(255,255,255,0.15); color: #ffffff; border: 1px solid rgba(255,255,255,0.3); }
  .badge-green { background: rgba(0,166,153,0.2); color: #ffffff; border: 1px solid var(--secondary); }
  .badge-blue { background: rgba(255,255,255,0.15); color: #ffffff; border: 1px solid rgba(255,255,255,0.3); }
  .badge-purple { background: rgba(255,255,255,0.15); color: #ffffff; border: 1px solid rgba(255,255,255,0.3); }
  .badge-orange { background: rgba(255,255,255,0.15); color: #ffffff; border: 1px solid rgba(255,255,255,0.3); }

  /* ===== STICKY NAV ===== */
  .toc {
    background: #f8fafc;
    padding: 20px 40px;
    border-bottom: 1px solid var(--card-border);
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(10px);
  }
  .toc h2 {
    color: var(--secondary);
    margin-bottom: 10px;
    font-size: 0.85em;
    text-transform: uppercase;
    letter-spacing: 2px;
  }
  .toc-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  .toc a {
    color: var(--text-muted);
    text-decoration: none;
    padding: 6px 16px;
    border-radius: 8px;
    font-size: 0.82em;
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    background: var(--card-bg);
    transition: all 0.3s;
    white-space: nowrap;
  }
  .toc a:hover {
    color: var(--primary);
    border-color: var(--primary);
    background: rgba(255,90,95,0.1);
  }

  /* ===== CONTAINER ===== */
  .container { max-width: 1200px; margin: 0 auto; padding: 30px 40px; }
  section { margin-bottom: 55px; }
  section > h2 {
    font-size: 1.7em;
    margin-bottom: 25px;
    padding-bottom: 12px;
    border-bottom: 2px solid #e5e7eb;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .section-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 42px; height: 42px;
    border-radius: 10px;
    font-size: 1.2em;
    flex-shrink: 0;
  }
  h3 {
    font-size: 1.25em;
    color: var(--blue);
    margin: 25px 0 14px;
  }
  h4 {
    font-size: 1.05em;
    color: var(--text);
    margin: 18px 0 10px;
  }
  p { margin-bottom: 12px; }
  ul, ol { margin: 10px 0 16px 24px; }
  li { margin-bottom: 6px; }

  /* ===== CARDS ===== */
  .card {
    background: var(--card-bg);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 20px;
    transition: border-color 0.3s;
  }
  .card:hover { border-color: rgba(255,90,95,0.3); }
  .card h4 {
    font-size: 1.1em;
    margin-bottom: 12px;
    margin-top: 0;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .card-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
  }
  .card-grid-3 {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
  }

  /* ===== TABLES ===== */
  .table-wrap {
    overflow-x: auto;
    border-radius: 12px;
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    margin-bottom: 20px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.88em;
  }
  th {
    background: #f8fafc;
    padding: 13px 16px;
    text-align: left;
    font-weight: 600;
    color: #1e293b;
    border-bottom: 2px solid #e5e7eb;
    white-space: nowrap;
  }
  td {
    padding: 11px 16px;
    border-bottom: 1px solid var(--card-border);
    vertical-align: top;
  }
  tr:hover td { background: rgba(66,139,249,0.04); }
  tr:last-child td { border-bottom: none; }

  /* ===== CODE BLOCKS ===== */
  pre {
    background: #f6f8fa;
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 10px;
    padding: 20px;
    overflow-x: auto;
    margin: 14px 0 20px;
    font-size: 0.85em;
    line-height: 1.6;
  }
  code {
    font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
    color: #24292f;
  }
  :not(pre) > code {
    background: rgba(66,139,249,0.1);
    padding: 2px 7px;
    border-radius: 5px;
    font-size: 0.88em;
    color: var(--blue);
  }
  .keyword { color: #cf222e; }
  .string { color: #0a3069; }
  .comment { color: #6e7781; font-style: italic; }
  .type { color: #8250df; }
  .number { color: #0550ae; }
  .func { color: #953800; }

  /* ===== TIP / WARNING / INFO BOXES ===== */
  .tip-box {
    border-radius: 10px;
    padding: 18px 22px;
    margin: 16px 0 20px;
    font-size: 0.92em;
    border-left: 4px solid;
  }
  .tip-box.tip {
    background: rgba(255,255,255,0.15);
    border-color: #e5e7eb;
  }
  .tip-box.warning {
    background: rgba(245,158,11,0.06);
    border-color: var(--warning);
  }
  .tip-box.danger {
    background: rgba(239,68,68,0.06);
    border-color: var(--danger);
  }
  .tip-box.info {
    background: rgba(66,139,249,0.08);
    border-color: var(--blue);
  }
  .tip-box.purple {
    background: rgba(123,47,247,0.08);
    border-color: var(--purple);
  }
  .tip-box strong { display: block; margin-bottom: 6px; }

  /* ===== STATE MACHINE ===== */
  .state-machine {
    background: #f6f8fa;
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 12px;
    padding: 30px;
    margin: 16px 0 20px;
    overflow-x: auto;
    text-align: center;
  }
  .state-machine .states {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 12px;
    align-items: center;
  }
  .state-node {
    display: inline-flex;
    align-items: center;
    padding: 12px 22px;
    border-radius: 10px;
    font-weight: 700;
    font-size: 0.88em;
    letter-spacing: 0.5px;
  }
  .state-node.trial { background: rgba(123,47,247,0.2); border: 2px solid var(--purple); color: var(--purple); }
  .state-node.active { background: rgba(16,185,129,0.2); border: 2px solid var(--success); color: var(--success); }
  .state-node.past-due { background: rgba(245,158,11,0.2); border: 2px solid var(--warning); color: var(--warning); }
  .state-node.cancelled { background: rgba(239,68,68,0.2); border: 2px solid var(--danger); color: var(--danger); }
  .state-node.expired { background: rgba(148,163,184,0.2); border: 2px solid var(--text-muted); color: var(--text-muted); }
  .state-node.paused { background: rgba(66,139,249,0.2); border: 2px solid var(--blue); color: var(--blue); }
  .arrow {
    font-size: 1.4em;
    color: var(--text-muted);
    padding: 0 4px;
  }

  /* ===== PRICING CARDS ===== */
  .pricing-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 20px;
    margin: 20px 0;
  }
  .pricing-card {
    background: var(--card-bg);
    border: 2px solid var(--card-border);
    border-radius: 16px;
    padding: 30px 25px;
    text-align: center;
    transition: all 0.3s;
    position: relative;
  }
  .pricing-card:hover { border-color: var(--primary); transform: translateY(-4px); }
  .pricing-card.featured {
    border-color: var(--primary);
    background: linear-gradient(180deg, rgba(255,90,95,0.15) 0%, var(--card-bg) 100%);
  }
  .pricing-card.featured::before {
    content: 'MOST POPULAR';
    position: absolute;
    top: -12px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--primary);
    color: white;
    padding: 4px 16px;
    border-radius: 20px;
    font-size: 0.7em;
    font-weight: 700;
    letter-spacing: 1px;
  }
  .pricing-card .tier-name {
    font-size: 1.3em;
    font-weight: 700;
    margin-bottom: 8px;
  }
  .pricing-card .price {
    font-size: 2.4em;
    font-weight: 800;
    color: var(--primary);
    margin: 12px 0;
  }
  .pricing-card .price span {
    font-size: 0.4em;
    color: var(--text-muted);
    font-weight: 400;
  }
  .pricing-card ul {
    list-style: none;
    margin: 16px 0;
    padding: 0;
    text-align: left;
  }
  .pricing-card ul li {
    padding: 6px 0;
    font-size: 0.9em;
    color: var(--text-muted);
    border-bottom: 1px solid rgba(51,65,85,0.5);
  }
  .pricing-card ul li::before {
    content: '\2713 ';
    color: var(--success);
    font-weight: 700;
    margin-right: 6px;
  }

  /* ===== FLOW DIAGRAM ===== */
  .flow-diagram {
    background: #f6f8fa;
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 12px;
    padding: 30px;
    margin: 16px 0 20px;
    overflow-x: auto;
  }
  .flow-row {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    gap: 14px;
    margin: 10px 0;
  }
  .flow-box {
    padding: 12px 20px;
    border-radius: 10px;
    font-size: 0.85em;
    font-weight: 600;
    text-align: center;
    min-width: 130px;
  }
  .flow-box.client { background: rgba(66,139,249,0.08); border: 2px solid var(--blue); color: var(--blue); }
  .flow-box.service { background: rgba(0,166,153,0.06); border: 2px solid var(--secondary); color: var(--secondary); }
  .flow-box.db { background: rgba(123,47,247,0.15); border: 2px solid var(--purple); color: var(--purple); }
  .flow-box.external { background: rgba(252,100,45,0.15); border: 2px solid var(--accent); color: var(--accent); }
  .flow-box.queue { background: rgba(245,158,11,0.15); border: 2px solid var(--warning); color: var(--warning); }
  .flow-box.cache { background: rgba(255,90,95,0.15); border: 2px solid var(--primary); color: var(--primary); }

  /* ===== FOOTER ===== */
  footer {
    text-align: center;
    padding: 40px;
    border-top: 1px solid #e5e7eb;
    color: var(--text-muted);
    font-size: 0.85em;
  }

    /* ===== RESPONSIVE ===== */
  @media (max-width: 768px) {
    .hero { padding: 36px 16px 30px; }
    .hero h1 { font-size: 1.7em; }
    .hero .subtitle { font-size: 0.95em; }
    .hero .back-link { font-size: 0.85em; padding: 8px 16px; }
    .hero .stats-row { gap: 16px; margin-top: 18px; }
    .hero .stat-value { font-size: 1.4em; }
    .hero .stat-label { font-size: 0.7em; }
    .toc { padding: 14px 16px; }
    .toc-grid { gap: 6px; }
    .toc a { padding: 5px 12px; font-size: 0.78em; }
    .container { padding: 16px 12px; }
    .card-grid, .card-grid-3, .pricing-grid, .comparison { grid-template-columns: 1fr; gap: 14px; }
    section { padding: 24px 0; }
    section > h2 { font-size: 1.25em; }
    table { font-size: 0.82em; display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    th, td { padding: 8px 10px; white-space: nowrap; }
    pre { font-size: 0.82em; padding: 14px; overflow-x: auto; }
    .diagram-box { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .diagram-box svg { min-width: 600px; }
    footer { padding: 24px 16px; font-size: 0.8em; }
  }
  @media (max-width: 480px) {
    .hero { padding: 28px 12px 22px; }
    .hero h1 { font-size: 1.35em; line-height: 1.3; }
    .hero .subtitle { font-size: 0.85em; }
    .hero .back-link { font-size: 0.78em; padding: 6px 12px; }
    .hero .stats-row { gap: 8px; }
    .hero .stat-value { font-size: 1.15em; }
    .container { padding: 14px 10px; }
    .toc a { padding: 4px 10px; font-size: 0.72em; }
    section > h2 { font-size: 1.1em; }
    .badge { padding: 3px 10px; font-size: 0.7em; }
    pre { font-size: 0.75em; padding: 10px; }
    table { font-size: 0.75em; }
    th, td { padding: 6px 8px; }
    footer { padding: 18px 12px; }
  }
  @media (max-width: 360px) {
    .hero h1 { font-size: 1.15em; }
    .hero .stat-value { font-size: 1em; }
    .container { padding: 10px 8px; }
  }

  /* === DIAGRAM ZOOM CONTROLS === */
  .diagram-box { position: relative; }
  .diagram-zoom-controls {
    position: absolute; top: 12px; right: 12px; z-index: 10;
    display: flex; gap: 4px; opacity: 0.5; transition: opacity 0.3s;
  }
  .diagram-box:hover .diagram-zoom-controls { opacity: 1; }
  .diagram-zoom-controls button {
    width: 32px; height: 32px; border-radius: 8px; border: 1px solid #e5e7eb;
    background: #ffffff; color: #1e293b; cursor: pointer; font-size: 16px;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.2s;
    font-family: system-ui; line-height: 1; padding: 0;
  }
  .diagram-zoom-controls button:hover { background: #f1f5f9; border-color: var(--blue); color: var(--blue); }
  .diagram-zoom-controls button:active { transform: scale(0.95); }
  .diagram-zoom-controls .zoom-level {
    font-size: 11px; color: #64748b; display: flex; align-items: center;
    padding: 0 6px; font-weight: 600; min-width: 40px; justify-content: center;
  }
  .diagram-box svg { transition: transform 0.3s ease; transform-origin: center center; }
  .diagram-box.fullscreen {
    position: fixed !important; top: 0; left: 0; width: 100vw; height: 100vh;
    z-index: 9999; background: #ffffff; border-radius: 0; padding: 20px;
    display: flex; align-items: center; justify-content: center;
    overflow: auto;
  }
  .diagram-box.fullscreen .diagram-zoom-controls { opacity: 1; top: 20px; right: 20px; }

  /* ===== COLLAPSIBLE SECTIONS ===== */
  details { margin-bottom: 0; }
  details summary {
    cursor: pointer;
    list-style: none;
    user-select: none;
    padding: 0;
  }
  details summary::-webkit-details-marker { display: none; }
  details summary::marker { display: none; content: ''; }
  details summary h2 { display: inline-flex; }
  details summary h2::before {
    content: '\25B6';
    display: inline-flex;
    align-items: center;
    margin-right: 8px;
    transition: transform 0.2s;
    font-size: 0.5em;
    color: var(--text-muted);
  }
  details[open] summary h2::before {
    transform: rotate(90deg);
  }
  .toggle-controls {
    display: flex;
    gap: 8px;
    margin-top: 10px;
  }
  .toggle-controls button {
    padding: 5px 14px;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    background: var(--card-bg);
    color: var(--text-muted);
    font-size: 0.78em;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  }
  .toggle-controls button:hover {
    color: var(--purple);
    border-color: var(--purple);
    background: rgba(123,47,247,0.1);
  }
</style>
</head>
<body>

<!-- ============================= HERO ============================= -->
<div class="hero">
  <h1>Airbnb Subscription Model</h1>
  <p class="subtitle">Principal Engineer System Design -- Monthly Subscription for Premium Listing Access</p>
  <div class="topic-badges">
    <span class="badge badge-red">Payments</span>
    <span class="badge badge-green">Billing</span>
    <span class="badge badge-blue">Entitlements</span>
    <span class="badge badge-purple">State Machines</span>
    <span class="badge badge-orange">Stripe Integration</span>
  </div>
  <div class="stats-row">
    <div class="stat-item">
      <div class="stat-value">150M</div>
      <div class="stat-label">Total Users</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">7.5M</div>
      <div class="stat-label">Target Subscribers</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">3 TPS</div>
      <div class="stat-label">Avg Billing</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">99.99%</div>
      <div class="stat-label">Billing SLA</div>
    </div>
  </div>
  <a href="index.html" class="back-link">&#8592; Back to All Topics</a>
</div>

<!-- ============================= STICKY NAV ============================= -->
<nav class="toc">
  <h2>Navigation</h2>
  <div class="toc-grid">
    <a href="#overview">Overview</a>
    <a href="#requirements">Requirements</a>
    <a href="#capacity">Capacity</a>
    <a href="#architecture">Architecture</a>
    <a href="#api-design">API Design</a>
    <a href="#data-model">Data Model</a>
    <a href="#state-machine">State Machine</a>
    <a href="#billing">Billing Deep Dive</a>
    <a href="#entitlements">Entitlements</a>
    <a href="#tradeoffs">Trade-offs</a>
    <a href="#interview-tips">Interview Tips</a>
  </div>
  <div class="toggle-controls">
    <button onclick="document.querySelectorAll('.container details').forEach(d=>d.open=true)">Expand All</button>
    <button onclick="document.querySelectorAll('.container details').forEach(d=>d.open=false)">Collapse All</button>
  </div>
</nav>

<!-- ============================= MAIN CONTENT ============================= -->
<div class="container">

<!-- ============================= 1. OVERVIEW ============================= -->
<section id="overview">
  <details open>
  <summary><h2>
    <span class="section-icon" style="background:rgba(255,90,95,0.15); color:var(--primary);">1</span>
    Overview
  </h2></summary>
  <p>
    Design a subscription service for Airbnb that allows guests and hosts to subscribe to monthly or annual plans with tiered pricing. Subscribers gain access to premium listings, booking discounts, priority customer support, and exclusive concierge experiences. The system must handle billing lifecycle management, entitlement gating, multi-currency support, and integrate with third-party payment processors like Stripe.
  </p>

  <div class="tip-box info">
    <strong>Why This Problem Matters at PE Level</strong>
    A subscription system cuts across payments, identity, entitlements, and user experience. At principal engineer scope, you must reason about distributed state machines, payment webhook reliability, eventual consistency in entitlement propagation, and cross-team API contracts. This is not a CRUD problem -- it is a financial-grade distributed system.
  </div>

  <h3>Subscription Tiers</h3>
  <div class="pricing-grid">
    <div class="pricing-card">
      <div class="tier-name" style="color:var(--blue);">Explorer</div>
      <div class="price">$29.99<span>/month</span></div>
      <ul>
        <li>Access to premium-tagged listings</li>
        <li>5% discount on all bookings</li>
        <li>Priority search placement</li>
        <li>Early access to new listings</li>
        <li>Basic travel insurance included</li>
      </ul>
    </div>
    <div class="pricing-card featured">
      <div class="tier-name" style="color:var(--primary);">Adventurer</div>
      <div class="price">$49.99<span>/month</span></div>
      <ul>
        <li>Everything in Explorer</li>
        <li>12% discount on all bookings</li>
        <li>Free cancellation (48h window)</li>
        <li>Concierge chat support</li>
        <li>Premium travel insurance</li>
        <li>Family plan: add 2 members</li>
      </ul>
    </div>
    <div class="pricing-card">
      <div class="tier-name" style="color:var(--secondary);">Nomad</div>
      <div class="price">$99.99<span>/month</span></div>
      <ul>
        <li>Everything in Adventurer</li>
        <li>20% discount on all bookings</li>
        <li>Dedicated concierge agent</li>
        <li>Airport lounge access</li>
        <li>Family plan: add 5 members</li>
        <li>Exclusive luxury listings</li>
        <li>Complimentary upgrades</li>
      </ul>
    </div>
  </div>
  </details>
</section>

<!-- ============================= 2. REQUIREMENTS ============================= -->
<section id="requirements">
  <details open>
  <summary><h2>
    <span class="section-icon" style="background:rgba(0,166,153,0.15); color:var(--secondary);">2</span>
    Requirements
  </h2></summary>

  <div class="card-grid">
    <div class="card">
      <h4 style="color:var(--success);">Functional Requirements</h4>
      <ul>
        <li><strong>Subscribe/Unsubscribe:</strong> Subscribe to any tier, upgrade, downgrade, or cancel with prorated billing.</li>
        <li><strong>Premium Access Control:</strong> Gate premium listings, discounts, and features by active entitlement.</li>
        <li><strong>Billing Cycles:</strong> Monthly/annual auto-renewal via Stripe. Support coupons and free trials.</li>
        <li><strong>Entitlement Checks:</strong> Every page load verifies subscriber access in &lt;10ms via cached entitlements.</li>
        <li><strong>Invoices:</strong> Generate PDF invoices, email receipts, expose billing history via API.</li>
      </ul>
    </div>
    <div class="card">
      <h4 style="color:var(--warning);">Non-Functional Requirements</h4>
      <ul>
        <li><strong>Zero Double-Charges:</strong> Idempotency on all payment mutations. No duplicate billing ever.</li>
        <li><strong>State Consistency:</strong> Subscription state must not diverge between our DB and Stripe. Hourly reconciliation.</li>
        <li><strong>Grace Periods:</strong> 7-day grace on failed payments before entitlement revocation + dunning emails.</li>
        <li><strong>Auditability:</strong> Every state transition and payment event immutably logged.</li>
        <li><strong>Scalability:</strong> Handle 10x billing spikes on renewal days without degradation.</li>
      </ul>
    </div>
  </div>

  <div class="tip-box warning">
    <strong>PE Signal: Requirement Prioritization</strong>
    In an interview, explicitly state which requirements you would build in V1 vs V2. For V1: subscribe, cancel, billing, entitlement checks. For V2: family plans, pause, coupons, annual billing. This shows you can scope incrementally while keeping the architecture extensible.
  </div>
</section>

<!-- ============================= 3. CAPACITY ============================= -->
<section id="capacity">
  <details>
  <summary><h2>
    <span class="section-icon" style="background:rgba(66,139,249,0.08); color:var(--blue);">3</span>
    Capacity Estimation
  </h2></summary>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Metric</th>
          <th>Estimate</th>
          <th>Derivation</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Total Airbnb Users</td>
          <td><strong>150M</strong></td>
          <td>Based on public data for registered accounts</td>
        </tr>
        <tr>
          <td>Subscription Conversion Rate</td>
          <td><strong>5%</strong></td>
          <td>Industry benchmark for freemium-to-paid in travel</td>
        </tr>
        <tr>
          <td>Total Subscribers</td>
          <td><strong>7.5M</strong></td>
          <td>150M x 5%</td>
        </tr>
        <tr>
          <td>Monthly Billing Events</td>
          <td><strong>~7.5M</strong></td>
          <td>Each subscriber billed once/month (simplified)</td>
        </tr>
        <tr>
          <td>Average Billing TPS</td>
          <td><strong>~2.9 TPS</strong></td>
          <td>7.5M / 30 days / 86,400 sec</td>
        </tr>
        <tr>
          <td>Peak Billing TPS (Renewal Day)</td>
          <td><strong>~30 TPS</strong></td>
          <td>10x spike; many users started on same day</td>
        </tr>
        <tr>
          <td>Entitlement Checks QPS</td>
          <td><strong>~50,000 QPS</strong></td>
          <td>Every search/listing page checks entitlement. 150M DAU / 86,400 x avg 30 pages</td>
        </tr>
        <tr>
          <td>Subscription Record Size</td>
          <td><strong>~2 KB</strong></td>
          <td>JSON metadata, plan info, billing refs</td>
        </tr>
        <tr>
          <td>Total Storage (Subscriptions)</td>
          <td><strong>~15 GB</strong></td>
          <td>7.5M x 2KB</td>
        </tr>
        <tr>
          <td>Billing Events Storage (1 yr)</td>
          <td><strong>~180 GB</strong></td>
          <td>90M events/yr x 2KB per event</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="card">
    <h4 style="color:var(--accent);">Key Capacity Insights</h4>
    <ul>
      <li><strong>Billing is low-throughput, high-correctness:</strong> At ~3 TPS average, the challenge is not scale but reliability. Every missed charge is lost revenue; every double charge is a chargeback.</li>
      <li><strong>Entitlement checks are high-throughput:</strong> At 50K QPS, we must cache aggressively in Redis. Cannot hit the DB for every page load.</li>
      <li><strong>Renewal day spikes:</strong> If many subscribers sign up on the 1st of the month, renewal day can see 10x burst. Solution: stagger billing anchors or use a billing queue with rate limiting.</li>
      <li><strong>Storage is trivial:</strong> Subscription data is small. The real storage concern is the immutable billing event log for audit purposes.</li>
    </ul>
  </div>
  </details>
</section>

<!-- ============================= 4. ARCHITECTURE ============================= -->
<section id="architecture">
  <details>
  <summary><h2>
    <span class="section-icon" style="background:rgba(123,47,247,0.15); color:var(--purple);">4</span>
    High-Level Architecture
  </h2></summary>

  <div class="diagram-box" style="background: rgba(0,0,0,0.05); border-radius: 12px; padding: 20px; overflow-x: auto;">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 650" font-family="Segoe UI, sans-serif" style="width:100%; height:auto;">
      <defs>
        <!-- Arrow markers -->
        <marker id="arr" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
          <path d="M0,0 L8,3 L0,6 Z" fill="#94a3b8"/>
        </marker>
        <marker id="arrRed" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
          <path d="M0,0 L8,3 L0,6 Z" fill="#ef4444"/>
        </marker>
        <!-- Shadow filter -->
        <filter id="shadow" x="-4%" y="-4%" width="108%" height="112%">
          <feDropShadow dx="0" dy="2" stdDeviation="4" flood-color="#000" flood-opacity="0.4"/>
        </filter>
        <!-- Service gradients -->
        <linearGradient id="gSub" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#7b2ff7"/><stop offset="100%" stop-color="#6d28d9"/></linearGradient>
        <linearGradient id="gBill" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#f59e0b"/><stop offset="100%" stop-color="#d97706"/></linearGradient>
        <linearGradient id="gEntitle" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#428BF9"/><stop offset="100%" stop-color="#2563eb"/></linearGradient>
        <linearGradient id="gNotif" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#00A699"/><stop offset="100%" stop-color="#059669"/></linearGradient>
        <linearGradient id="gConsumer" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#334155"/><stop offset="100%" stop-color="#1e293b"/></linearGradient>
      </defs>

      <!-- Column headers -->
      <text x="80" y="28" fill="#64748b" font-size="11" font-weight="700" letter-spacing="2" text-anchor="middle">CLIENTS</text>
      <text x="370" y="28" fill="#64748b" font-size="11" font-weight="700" letter-spacing="2" text-anchor="middle">SERVICES</text>
      <text x="700" y="28" fill="#64748b" font-size="11" font-weight="700" letter-spacing="2" text-anchor="middle">DATA LAYER</text>

      <!-- ===== CLIENTS ===== -->
      <!-- Web -->
      <rect x="20" y="80" width="120" height="50" rx="10" fill="#f8fafc" stroke="#428BF9" stroke-width="1.5" filter="url(#shadow)"/>
      <text x="80" y="101" fill="#428BF9" font-size="11" font-weight="700" text-anchor="middle">Web Browser</text>
      <text x="80" y="117" fill="#64748b" font-size="9" text-anchor="middle">React SPA</text>
      <!-- Mobile -->
      <rect x="20" y="150" width="120" height="50" rx="10" fill="#f8fafc" stroke="#428BF9" stroke-width="1.5" filter="url(#shadow)"/>
      <text x="80" y="171" fill="#428BF9" font-size="11" font-weight="700" text-anchor="middle">Mobile App</text>
      <text x="80" y="187" fill="#64748b" font-size="9" text-anchor="middle">iOS / Android</text>

      <!-- ===== API GATEWAY ===== -->
      <g transform="translate(190, 105)">
        <rect x="0" y="0" width="140" height="55" rx="10" fill="#f8fafc" stroke="#FF5A5F" stroke-width="1.5" filter="url(#shadow)"/>
        <!-- Shield icon -->
        <path d="M14,4 L14,22 Q14,28 24,32 Q34,28 34,22 L34,4 Q24,0 14,4 Z" fill="none" stroke="#FF5A5F" stroke-width="1.2" transform="scale(0.55) translate(8,22)"/>
        <text x="24" y="30" fill="#FF5A5F" font-size="8" text-anchor="middle" transform="translate(0,0)">&#10003;</text>
        <text x="82" y="22" fill="#FF5A5F" font-size="11" font-weight="700" text-anchor="middle">API Gateway</text>
        <text x="82" y="38" fill="#64748b" font-size="9" text-anchor="middle">Auth + Rate Limit</text>
      </g>

      <!-- Client to API GW -->
      <line x1="140" y1="105" x2="188" y2="125" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arr)"/>
      <line x1="140" y1="175" x2="188" y2="145" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arr)"/>

      <!-- ===== SERVICES ===== -->
      <!-- Subscription Service (star icon) -->
      <g transform="translate(390, 60)">
        <rect x="0" y="0" width="170" height="55" rx="10" fill="url(#gSub)" filter="url(#shadow)"/>
        <text x="20" y="33" fill="rgba(255,255,255,0.9)" font-size="14" text-anchor="middle">&#9733;</text>
        <text x="100" y="22" fill="white" font-size="12" font-weight="700" text-anchor="middle">Subscription Svc</text>
        <text x="100" y="38" fill="rgba(255,255,255,0.8)" font-size="9" text-anchor="middle">Lifecycle Orchestrator</text>
      </g>
      <!-- Billing Service (dollar icon) -->
      <g transform="translate(390, 140)">
        <rect x="0" y="0" width="170" height="55" rx="10" fill="url(#gBill)" filter="url(#shadow)"/>
        <text x="20" y="33" fill="rgba(255,255,255,0.9)" font-size="14" text-anchor="middle">$</text>
        <text x="100" y="22" fill="white" font-size="12" font-weight="700" text-anchor="middle">Billing Service</text>
        <text x="100" y="38" fill="rgba(255,255,255,0.8)" font-size="9" text-anchor="middle">Invoices + Dunning</text>
      </g>
      <!-- Entitlement Service (key icon) -->
      <g transform="translate(390, 220)">
        <rect x="0" y="0" width="170" height="55" rx="10" fill="url(#gEntitle)" filter="url(#shadow)"/>
        <text x="20" y="33" fill="rgba(255,255,255,0.9)" font-size="14" text-anchor="middle">&#128273;</text>
        <text x="100" y="22" fill="white" font-size="12" font-weight="700" text-anchor="middle">Entitlement Svc</text>
        <text x="100" y="38" fill="rgba(255,255,255,0.8)" font-size="9" text-anchor="middle">Access / Feature Flags</text>
      </g>
      <!-- Notification Service (bell icon) -->
      <g transform="translate(390, 300)">
        <rect x="0" y="0" width="170" height="55" rx="10" fill="url(#gNotif)" filter="url(#shadow)"/>
        <text x="20" y="33" fill="rgba(255,255,255,0.9)" font-size="14" text-anchor="middle">&#128276;</text>
        <text x="100" y="22" fill="white" font-size="12" font-weight="700" text-anchor="middle">Notification Svc</text>
        <text x="100" y="38" fill="rgba(255,255,255,0.8)" font-size="9" text-anchor="middle">Email / Push / SMS</text>
      </g>

      <!-- API GW to Subscription Service -->
      <line x1="330" y1="132" x2="388" y2="95" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arr)"/>

      <!-- ===== EXTERNAL: STRIPE ===== -->
      <g transform="translate(190, 220)">
        <rect x="0" y="0" width="140" height="55" rx="10" fill="#f8fafc" stroke="#f59e0b" stroke-width="1.5" filter="url(#shadow)"/>
        <!-- Cloud + Lock icon -->
        <path d="M14,30 Q8,30 8,24 Q8,18 16,18 Q16,12 24,12 Q32,12 32,18 Q40,18 40,24 Q40,30 34,30 Z" fill="none" stroke="#f59e0b" stroke-width="1" transform="scale(0.6) translate(8,16)"/>
        <text x="82" y="22" fill="#f59e0b" font-size="11" font-weight="700" text-anchor="middle">Stripe</text>
        <text x="82" y="38" fill="#64748b" font-size="9" text-anchor="middle">Billing API + Webhooks</text>
      </g>

      <!-- Subscription Svc to Stripe (solid - sync call) -->
      <line x1="390" y1="95" x2="332" y2="235" stroke="#f59e0b" stroke-width="1.5" marker-end="url(#arr)"/>
      <text x="350" y="170" fill="#f59e0b" font-size="8" transform="rotate(-55, 350, 170)">payment</text>

      <!-- ===== DATA LAYER ===== -->
      <!-- PostgreSQL (Subscriptions DB) -->
      <g transform="translate(640, 50)">
        <rect x="0" y="0" width="150" height="55" rx="10" fill="#f8fafc" stroke="#428BF9" stroke-width="1.5" filter="url(#shadow)"/>
        <!-- PG cylinder -->
        <ellipse cx="24" cy="18" rx="10" ry="4" fill="#428BF9" opacity="0.8"/>
        <rect x="14" y="18" width="20" height="16" fill="#428BF9" opacity="0.3"/>
        <line x1="14" y1="18" x2="14" y2="34" stroke="#428BF9" stroke-width="1"/>
        <line x1="34" y1="18" x2="34" y2="34" stroke="#428BF9" stroke-width="1"/>
        <ellipse cx="24" cy="34" rx="10" ry="4" fill="#428BF9" opacity="0.6"/>
        <text x="90" y="23" fill="#428BF9" font-size="11" font-weight="700" text-anchor="middle">PostgreSQL</text>
        <text x="90" y="39" fill="#64748b" font-size="9" text-anchor="middle">Subscriptions DB</text>
      </g>

      <!-- Redis (Entitlement Cache) -->
      <g transform="translate(640, 210)">
        <rect x="0" y="0" width="150" height="55" rx="10" fill="#f8fafc" stroke="#ef4444" stroke-width="1.5" filter="url(#shadow)"/>
        <!-- Redis diamond -->
        <polygon points="24,10 34,27 24,44 14,27" fill="none" stroke="#ef4444" stroke-width="1.5" transform="scale(0.55) translate(10,8)"/>
        <polygon points="24,16 30,27 24,38 18,27" fill="#ef4444" opacity="0.3" transform="scale(0.55) translate(10,8)"/>
        <text x="90" y="23" fill="#ef4444" font-size="11" font-weight="700" text-anchor="middle">Redis</text>
        <text x="90" y="39" fill="#64748b" font-size="9" text-anchor="middle">Entitlement Cache</text>
      </g>

      <!-- Subscription Svc to PostgreSQL (dashed) -->
      <line x1="560" y1="82" x2="638" y2="68" stroke="#428BF9" stroke-width="1.2" stroke-dasharray="6,3" marker-end="url(#arr)"/>
      <text x="598" y="64" fill="#428BF9" font-size="7">sub state</text>

      <!-- Billing Svc to PostgreSQL (dashed) -->
      <line x1="560" y1="160" x2="638" y2="85" stroke="#428BF9" stroke-width="1.2" stroke-dasharray="6,3" marker-end="url(#arr)"/>
      <text x="608" y="112" fill="#f59e0b" font-size="7">invoices</text>

      <!-- Entitlement Svc to PostgreSQL (dashed) -->
      <line x1="560" y1="238" x2="638" y2="100" stroke="#428BF9" stroke-width="1.2" stroke-dasharray="6,3" marker-end="url(#arr)"/>
      <text x="612" y="162" fill="#428BF9" font-size="7">entitlements</text>

      <!-- Entitlement Svc to Redis (dashed) -->
      <line x1="560" y1="250" x2="638" y2="240" stroke="#ef4444" stroke-width="1.2" stroke-dasharray="6,3" marker-end="url(#arr)"/>
      <text x="600" y="235" fill="#ef4444" font-size="7">cache</text>

      <!-- ===== KAFKA EVENT BUS ===== -->
      <g transform="translate(80, 420)">
        <rect x="0" y="0" width="720" height="55" rx="10" fill="#f8fafc" stroke="#ef4444" stroke-width="1.5" filter="url(#shadow)"/>
        <!-- Kafka cluster nodes -->
        <circle cx="24" cy="18" r="5" fill="#ef4444" opacity="0.9"/>
        <circle cx="24" cy="38" r="5" fill="#ef4444" opacity="0.7"/>
        <circle cx="42" cy="28" r="5" fill="#ef4444" opacity="0.8"/>
        <line x1="29" y1="18" x2="37" y2="24" stroke="#ef4444" stroke-width="1.2" opacity="0.6"/>
        <line x1="29" y1="38" x2="37" y2="32" stroke="#ef4444" stroke-width="1.2" opacity="0.6"/>
        <text x="360" y="23" fill="#ef4444" font-size="13" font-weight="700" text-anchor="middle">Apache Kafka Event Bus</text>
        <text x="360" y="42" fill="#64748b" font-size="10" text-anchor="middle">subscription.created | subscription.renewed | payment.failed | entitlement.changed</text>
      </g>

      <!-- Subscription Svc to Kafka (dashed red) -->
      <line x1="475" y1="115" x2="440" y2="418" stroke="#ef4444" stroke-width="1.2" stroke-dasharray="5,3" marker-end="url(#arrRed)" opacity="0.6"/>
      <text x="445" y="280" fill="#ef4444" font-size="8" transform="rotate(-80, 445, 280)">events</text>

      <!-- Kafka to Billing (dashed) -->
      <line x1="350" y1="420" x2="450" y2="197" stroke="#94a3b8" stroke-width="1.2" stroke-dasharray="4,3" marker-end="url(#arr)"/>
      <!-- Kafka to Entitlement (dashed) -->
      <line x1="440" y1="420" x2="475" y2="277" stroke="#94a3b8" stroke-width="1.2" stroke-dasharray="4,3" marker-end="url(#arr)"/>
      <!-- Kafka to Notification (dashed) -->
      <line x1="520" y1="420" x2="500" y2="357" stroke="#94a3b8" stroke-width="1.2" stroke-dasharray="4,3" marker-end="url(#arr)"/>

      <!-- ===== FLOW ANNOTATIONS ===== -->
      <!-- Stripe webhooks to Kafka -->
      <path d="M260,275 L260,420" stroke="#f59e0b" stroke-width="1.2" stroke-dasharray="5,3" marker-end="url(#arrRed)" fill="none"/>
      <text x="266" y="360" fill="#f59e0b" font-size="8">webhooks</text>

      <!-- ===== NUMBERED STEP CIRCLES ===== -->
      <!-- Step 1: Client -> API Gateway -->
      <circle cx="165" cy="115" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/>
      <text x="165" y="119" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">1</text>

      <!-- Step 2: API Gateway -> Subscription Service -->
      <circle cx="358" cy="110" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/>
      <text x="358" y="114" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">2</text>

      <!-- Step 3: Subscription Svc -> PostgreSQL -->
      <circle cx="600" cy="78" r="10" fill="#428BF9" stroke="#fff" stroke-width="1.5"/>
      <text x="600" y="82" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">3</text>

      <!-- Step 4: Subscription Svc -> Stripe -->
      <circle cx="360" cy="170" r="10" fill="#f59e0b" stroke="#fff" stroke-width="1.5"/>
      <text x="360" y="174" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">4</text>

      <!-- Step 5: Stripe -> Kafka via Webhook -->
      <circle cx="260" cy="348" r="10" fill="#f59e0b" stroke="#fff" stroke-width="1.5"/>
      <text x="260" y="352" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">5</text>

      <!-- Step 6: Kafka -> Billing Service -->
      <circle cx="395" cy="310" r="10" fill="#ef4444" stroke="#fff" stroke-width="1.5"/>
      <text x="395" y="314" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">6</text>

      <!-- Step 7: Kafka -> Entitlement Service -->
      <circle cx="458" cy="350" r="10" fill="#ef4444" stroke="#fff" stroke-width="1.5"/>
      <text x="458" y="354" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">7</text>

      <!-- Step 8: Entitlement Svc -> Redis -->
      <circle cx="600" cy="242" r="10" fill="#ef4444" stroke="#fff" stroke-width="1.5"/>
      <text x="600" y="246" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">8</text>

      <!-- Step 9: Kafka -> Notification Service -->
      <circle cx="510" cy="388" r="10" fill="#00A699" stroke="#fff" stroke-width="1.5"/>
      <text x="510" y="392" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">9</text>

      <!-- ===== LEGEND ===== -->
      <g transform="translate(640, 420)">
        <rect x="0" y="0" width="190" height="110" rx="8" fill="#f1f5f9" stroke="#334155" stroke-width="1"/>
        <text x="95" y="18" fill="rgba(255,255,255,0.7)" font-size="10" font-weight="700" text-anchor="middle">LEGEND</text>
        <line x1="12" y1="32" x2="42" y2="32" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arr)"/>
        <text x="52" y="36" fill="#64748b" font-size="9">Sync request</text>
        <line x1="12" y1="50" x2="42" y2="50" stroke="#94a3b8" stroke-width="1.5" stroke-dasharray="5,3"/>
        <text x="52" y="54" fill="#64748b" font-size="9">Async / DB query</text>
        <line x1="12" y1="68" x2="42" y2="68" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="5,3"/>
        <text x="52" y="72" fill="#64748b" font-size="9">Event stream (Kafka)</text>
        <line x1="12" y1="86" x2="42" y2="86" stroke="#f59e0b" stroke-width="1.5" marker-end="url(#arr)"/>
        <text x="52" y="90" fill="#64748b" font-size="9">External (Stripe)</text>
      </g>
    </svg>
  </div>

  <!-- ===== REQUEST FLOW REFERENCE ===== -->
  <h3>Request Flow Reference</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Step</th>
          <th>From &rarr; To</th>
          <th>Protocol</th>
          <th>What Happens</th>
          <th>Latency</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#FF5A5F;color:#fff;font-weight:800;font-size:11px;">1</span></td>
          <td>Client &rarr; API Gateway</td>
          <td><code>HTTPS</code></td>
          <td>Authenticate request (JWT/OAuth2), enforce rate limits, route to downstream service</td>
          <td>~5-15 ms</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#FF5A5F;color:#fff;font-weight:800;font-size:11px;">2</span></td>
          <td>API Gateway &rarr; Subscription Service</td>
          <td><code>gRPC</code></td>
          <td>Create or manage subscription: validate plan, check eligibility, initiate subscription lifecycle</td>
          <td>~10-25 ms</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#428BF9;color:#fff;font-weight:800;font-size:11px;">3</span></td>
          <td>Subscription Service &rarr; PostgreSQL</td>
          <td><code>TCP</code></td>
          <td>Persist subscription state (INSERT/UPDATE with ACID guarantees), store plan, status, billing cycle</td>
          <td>~2-8 ms</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#f59e0b;color:#fff;font-weight:800;font-size:11px;">4</span></td>
          <td>Subscription Service &rarr; Stripe</td>
          <td><code>HTTPS</code></td>
          <td>Create payment intent or Stripe subscription, attach payment method, set billing anchor</td>
          <td>~200-600 ms</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#f59e0b;color:#fff;font-weight:800;font-size:11px;">5</span></td>
          <td>Stripe &rarr; Kafka (via Webhook)</td>
          <td><code>HTTPS &rarr; Kafka</code></td>
          <td>Stripe fires webhook (payment_intent.succeeded / failed), webhook handler publishes to Kafka topic</td>
          <td>~1-5 s (async)</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#ef4444;color:#fff;font-weight:800;font-size:11px;">6</span></td>
          <td>Kafka &rarr; Billing Service</td>
          <td><code>Consumer</code></td>
          <td>Process billing events: create invoice record, update payment status, trigger dunning if failed</td>
          <td>~50-200 ms</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#ef4444;color:#fff;font-weight:800;font-size:11px;">7</span></td>
          <td>Kafka &rarr; Entitlement Service</td>
          <td><code>Consumer</code></td>
          <td>Update access grants: activate feature flags, set entitlement TTL, persist to DB + cache</td>
          <td>~50-200 ms</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#ef4444;color:#fff;font-weight:800;font-size:11px;">8</span></td>
          <td>Entitlement Service &rarr; PostgreSQL + Redis</td>
          <td><code>TCP</code></td>
          <td>Persist entitlements to PG (source of truth), then cache in Redis with TTL for fast &lt;3ms lookups</td>
          <td>~5-10 ms</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#00A699;color:#fff;font-weight:800;font-size:11px;">9</span></td>
          <td>Kafka &rarr; Notification Service</td>
          <td><code>Consumer</code></td>
          <td>Send confirmation email, push notification, or SMS. Render template, apply user preferences, dispatch</td>
          <td>~100-500 ms</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ===== FAILURE PATHS ===== -->
  <h3>Failure Paths</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Fails At</th>
          <th>Failure Scenario</th>
          <th>Impact</th>
          <th>Recovery Strategy</th>
          <th>User Sees</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#FF5A5F;color:#fff;font-weight:800;font-size:11px;">1</span> API Gateway</td>
          <td>Auth token expired or rate limit exceeded</td>
          <td>Request rejected before reaching any service</td>
          <td>Client retries with refreshed token; backoff on 429</td>
          <td>"Session expired, please log in again" or "Too many requests, try again shortly"</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#FF5A5F;color:#fff;font-weight:800;font-size:11px;">2</span> Subscription Svc</td>
          <td>Service down or gRPC timeout</td>
          <td>Cannot create subscription, no side effects yet</td>
          <td>Circuit breaker trips; client retries with exponential backoff; idempotency key prevents duplicates</td>
          <td>"Something went wrong. Please try again."</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#428BF9;color:#fff;font-weight:800;font-size:11px;">3</span> PostgreSQL</td>
          <td>DB connection pool exhausted or write failure</td>
          <td>Subscription state not persisted; Stripe call not yet made</td>
          <td>Connection pool auto-recovers; PgBouncer failover; retry at service level</td>
          <td>"Unable to process subscription. Please try again."</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#f59e0b;color:#fff;font-weight:800;font-size:11px;">4</span> Stripe API</td>
          <td>Stripe down (503) or payment declined by card network</td>
          <td>Subscription saved as PENDING, no charge made</td>
          <td><strong>Stripe down:</strong> retry with exponential backoff (Stripe is idempotent). <strong>Declined:</strong> prompt user to update payment method, enter dunning flow</td>
          <td>"Payment failed. Please check your card details." or "Payment processing delayed, we'll notify you."</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#f59e0b;color:#fff;font-weight:800;font-size:11px;">5</span> Webhook Delivery</td>
          <td>Webhook endpoint down or Stripe cannot deliver event</td>
          <td>Payment succeeded at Stripe but downstream services unaware</td>
          <td>Stripe retries webhooks for up to 72 hours; reconciliation cron job polls Stripe API every 5 min for missed events</td>
          <td>User charged but may see delayed activation (minutes). "Your subscription is being activated..."</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#ef4444;color:#fff;font-weight:800;font-size:11px;">6</span> Kafka &rarr; Billing</td>
          <td>Consumer lag or Billing Service crash</td>
          <td>Invoice generation delayed; payment already captured</td>
          <td>Kafka retains events (7d retention); consumer restarts from last committed offset; dead letter queue for poison messages</td>
          <td>No immediate user impact; invoice email arrives late</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#ef4444;color:#fff;font-weight:800;font-size:11px;">7</span> Kafka &rarr; Entitlement</td>
          <td>Consumer lag or Entitlement Service crash</td>
          <td>User paid but entitlement not yet granted &mdash; premium features inaccessible</td>
          <td>Consumer auto-restarts; manual replay from Kafka offset; support can force-grant via admin API</td>
          <td>"Your payment was received. Access will be activated shortly." (polling UI with spinner)</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#ef4444;color:#fff;font-weight:800;font-size:11px;">8</span> Redis</td>
          <td>Redis cluster down or cache miss (eviction/TTL expired)</td>
          <td>Entitlement lookups slower; falls back to DB</td>
          <td>Automatic fallback to PostgreSQL query; Redis Sentinel triggers failover in &lt;30s; cache re-warmed on recovery</td>
          <td>Slightly slower page loads (~50ms instead of ~3ms), but no feature loss</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#00A699;color:#fff;font-weight:800;font-size:11px;">9</span> Notification Svc</td>
          <td>Email provider down or template rendering error</td>
          <td>User does not receive confirmation email</td>
          <td>Kafka retry with backoff; fallback to secondary email provider (SES &rarr; SendGrid); DLQ for manual review</td>
          <td>No email received; subscription still active. User can check status in-app.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h3>Service Responsibilities</h3>
  <div class="card-grid">
    <div class="card">
      <h4 style="color:var(--secondary);">Subscription Service</h4>
      <p>Owns the subscription lifecycle: create, upgrade, downgrade, cancel, pause, resume. Orchestrates calls to Stripe for customer and subscription creation. Publishes domain events to Kafka on every state transition.</p>
      <p><strong>Tech:</strong> Java/Kotlin, Spring Boot, PostgreSQL</p>
    </div>
    <div class="card">
      <h4 style="color:var(--accent);">Billing Service</h4>
      <p>Consumes Kafka events from Stripe webhooks. Manages invoice records, payment status, retry logic, and dunning workflows. Generates PDF invoices and stores in S3. Handles refunds and prorations.</p>
      <p><strong>Tech:</strong> Java/Kotlin, Spring Boot, PostgreSQL, S3</p>
    </div>
    <div class="card">
      <h4 style="color:var(--blue);">Entitlement Service</h4>
      <p>Maps active subscriptions to feature flags and access rights. Maintains a Redis cache for ultra-low-latency lookups. Listens to subscription state change events and updates entitlements. Exposes a gRPC API for internal services.</p>
      <p><strong>Tech:</strong> Go, Redis, PostgreSQL, gRPC</p>
    </div>
    <div class="card">
      <h4 style="color:var(--purple);">Notification Service</h4>
      <p>Sends transactional emails (welcome, receipt, dunning, cancellation) and push notifications. Consumes Kafka events. Manages templates and user communication preferences. Rate limits to prevent spam.</p>
      <p><strong>Tech:</strong> Python, Kafka, SES, FCM/APNs</p>
    </div>
  </div>

  <div class="tip-box tip">
    <strong>PE Signal: Service Boundaries</strong>
    A strong answer separates Subscription (lifecycle), Billing (money), and Entitlement (access) into distinct services. This allows independent scaling, separate on-call rotations, and clear ownership. The Subscription Service is the orchestrator; Billing and Entitlement are reactive consumers of its events.
  </div>
  </details>
</section>

<!-- ============================= 5. API DESIGN ============================= -->
<section id="api-design">
  <details>
  <summary><h2>
    <span class="section-icon" style="background:rgba(252,100,45,0.15); color:var(--accent);">5</span>
    API Design
  </h2></summary>

  <h3>Subscription CRUD Endpoints</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Method</th>
          <th>Endpoint</th>
          <th>Description</th>
          <th>Auth</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><code>POST</code></td>
          <td><code>/api/v1/subscriptions</code></td>
          <td>Create a new subscription (with optional trial)</td>
          <td>User JWT</td>
        </tr>
        <tr>
          <td><code>GET</code></td>
          <td><code>/api/v1/subscriptions/{id}</code></td>
          <td>Get subscription details</td>
          <td>User JWT</td>
        </tr>
        <tr>
          <td><code>PATCH</code></td>
          <td><code>/api/v1/subscriptions/{id}</code></td>
          <td>Upgrade/downgrade plan, pause, resume</td>
          <td>User JWT</td>
        </tr>
        <tr>
          <td><code>DELETE</code></td>
          <td><code>/api/v1/subscriptions/{id}</code></td>
          <td>Cancel subscription (end of billing period)</td>
          <td>User JWT</td>
        </tr>
        <tr>
          <td><code>GET</code></td>
          <td><code>/api/v1/subscriptions/{id}/invoices</code></td>
          <td>List all invoices for a subscription</td>
          <td>User JWT</td>
        </tr>
        <tr>
          <td><code>POST</code></td>
          <td><code>/api/v1/subscriptions/{id}/family-members</code></td>
          <td>Invite a family member to the plan</td>
          <td>User JWT</td>
        </tr>
        <tr>
          <td><code>GET</code></td>
          <td><code>/api/v1/entitlements/check</code></td>
          <td>Check if user has a specific entitlement</td>
          <td>Internal / User JWT</td>
        </tr>
        <tr>
          <td><code>POST</code></td>
          <td><code>/api/v1/webhooks/stripe</code></td>
          <td>Stripe webhook receiver</td>
          <td>Stripe Signature</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h3>Create Subscription -- Request</h3>
<pre><code><span class="comment">// POST /api/v1/subscriptions</span>
<span class="comment">// Headers: Authorization: Bearer &lt;jwt&gt;</span>
<span class="comment">// Headers: Idempotency-Key: &lt;uuid&gt;</span>
{
  <span class="string">"plan_id"</span>: <span class="string">"plan_adventurer_monthly"</span>,
  <span class="string">"payment_method_id"</span>: <span class="string">"pm_1N2abc3def4ghi"</span>,
  <span class="string">"trial"</span>: <span class="keyword">true</span>,
  <span class="string">"currency"</span>: <span class="string">"USD"</span>
}</code></pre>

  <h3>Create Subscription -- Response</h3>
<pre><code><span class="comment">// 201 Created</span>
{
  <span class="string">"id"</span>: <span class="string">"sub_8f3a2b1c"</span>,
  <span class="string">"plan_id"</span>: <span class="string">"plan_adventurer_monthly"</span>,
  <span class="string">"status"</span>: <span class="string">"trialing"</span>,
  <span class="string">"trial_end"</span>: <span class="string">"2025-02-14T00:00:00Z"</span>,
  <span class="string">"current_period_end"</span>: <span class="string">"2025-02-28T00:00:00Z"</span>
}</code></pre>

  <h3>Entitlement Check Endpoint</h3>
<pre><code><span class="comment">// GET /api/v1/entitlements/check?user_id=usr_7c9e4d2a&amp;entitlement=premium_listings</span>
<span class="comment">// Response: 200 OK (cached in Redis, &lt;5ms p99)</span>
{
  <span class="string">"entitlement"</span>: <span class="string">"premium_listings"</span>,
  <span class="string">"granted"</span>: <span class="keyword">true</span>,
  <span class="string">"expires_at"</span>: <span class="string">"2025-02-28T00:00:00Z"</span>
}</code></pre>

  <div class="tip-box danger">
    <strong>Critical: Idempotency-Key Header</strong>
    All mutation endpoints (POST, PATCH, DELETE) require an <code>Idempotency-Key</code> header. This prevents double-charges on network retries. The server stores the idempotency key and its response in Redis with a 24h TTL. If the same key is received again, the cached response is returned without re-executing the operation.
  </div>
  </details>
</section>

<!-- ============================= 6. DATA MODEL ============================= -->
<section id="data-model">
  <details>
  <summary><h2>
    <span class="section-icon" style="background:rgba(0,166,153,0.15); color:var(--secondary);">6</span>
    Data Model
  </h2></summary>

  <h3>plans</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr><th>Column</th><th>Type</th><th>Constraints</th><th>Notes</th></tr>
      </thead>
      <tbody>
        <tr><td><code>id</code></td><td>VARCHAR(64)</td><td>PK</td><td>e.g., plan_adventurer_monthly</td></tr>
        <tr><td><code>name</code></td><td>VARCHAR(128)</td><td>NOT NULL</td><td>Display name</td></tr>
        <tr><td><code>tier</code></td><td>ENUM</td><td>NOT NULL</td><td>explorer, adventurer, nomad</td></tr>
        <tr><td><code>price_cents</code></td><td>INTEGER</td><td>NOT NULL</td><td>Smallest currency unit (cents)</td></tr>
        <tr><td><code>currency</code></td><td>CHAR(3)</td><td>NOT NULL</td><td>ISO 4217</td></tr>
        <tr><td><code>interval</code></td><td>ENUM</td><td>NOT NULL</td><td>month, year</td></tr>
        <tr><td><code>stripe_price_id</code></td><td>VARCHAR(128)</td><td>NOT NULL</td><td>Stripe Price object ref</td></tr>
        <tr><td><code>entitlements</code></td><td>JSONB</td><td>NOT NULL</td><td>Array of entitlement keys</td></tr>
        <tr><td><code>is_active</code></td><td>BOOLEAN</td><td>DEFAULT true</td><td>Soft-deactivate old plans</td></tr>
        <tr><td><code>version</code></td><td>INTEGER</td><td>NOT NULL</td><td>Grandfathering on price changes</td></tr>
      </tbody>
    </table>
  </div>

  <h3>subscriptions</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr><th>Column</th><th>Type</th><th>Constraints</th><th>Notes</th></tr>
      </thead>
      <tbody>
        <tr><td><code>id</code></td><td>UUID</td><td>PK</td><td>Internal subscription ID</td></tr>
        <tr><td><code>user_id</code></td><td>UUID</td><td>NOT NULL, INDEX</td><td>FK to users table</td></tr>
        <tr><td><code>plan_id</code></td><td>VARCHAR(64)</td><td>NOT NULL, FK</td><td>References plans.id</td></tr>
        <tr><td><code>status</code></td><td>ENUM</td><td>NOT NULL, INDEX</td><td>trialing, active, past_due, cancelled, expired</td></tr>
        <tr><td><code>stripe_subscription_id</code></td><td>VARCHAR(128)</td><td>UNIQUE</td><td>Stripe reference for reconciliation</td></tr>
        <tr><td><code>current_period_end</code></td><td>TIMESTAMPTZ</td><td>NOT NULL</td><td>When current billing period ends</td></tr>
        <tr><td><code>trial_end</code></td><td>TIMESTAMPTZ</td><td>NULLABLE</td><td>NULL if no trial</td></tr>
        <tr><td><code>cancel_at_period_end</code></td><td>BOOLEAN</td><td>DEFAULT false</td><td>If true, expires at period end</td></tr>
      </tbody>
    </table>
  </div>

  <h3>billing_events</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr><th>Column</th><th>Type</th><th>Constraints</th><th>Notes</th></tr>
      </thead>
      <tbody>
        <tr><td><code>id</code></td><td>UUID</td><td>PK</td><td>Event ID</td></tr>
        <tr><td><code>subscription_id</code></td><td>UUID</td><td>NOT NULL, FK, INDEX</td><td>References subscriptions.id</td></tr>
        <tr><td><code>stripe_event_id</code></td><td>VARCHAR(128)</td><td>UNIQUE</td><td>Idempotency / deduplication key</td></tr>
        <tr><td><code>event_type</code></td><td>VARCHAR(64)</td><td>NOT NULL, INDEX</td><td>invoice.paid, payment_failed, etc.</td></tr>
        <tr><td><code>amount_cents</code></td><td>INTEGER</td><td>NOT NULL</td><td>Smallest currency unit</td></tr>
        <tr><td><code>currency</code></td><td>CHAR(3)</td><td>NOT NULL</td><td>ISO 4217</td></tr>
        <tr><td><code>failure_reason</code></td><td>TEXT</td><td>NULLABLE</td><td>Decline code on failure</td></tr>
        <tr><td><code>created_at</code></td><td>TIMESTAMPTZ</td><td>NOT NULL</td><td>Immutable, append-only</td></tr>
      </tbody>
    </table>
  </div>

  <h3>entitlements</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr><th>Column</th><th>Type</th><th>Constraints</th><th>Notes</th></tr>
      </thead>
      <tbody>
        <tr><td><code>id</code></td><td>UUID</td><td>PK</td><td>Entitlement record ID</td></tr>
        <tr><td><code>user_id</code></td><td>UUID</td><td>NOT NULL, INDEX</td><td>User who holds the entitlement</td></tr>
        <tr><td><code>subscription_id</code></td><td>UUID</td><td>NOT NULL, FK</td><td>Source subscription</td></tr>
        <tr><td><code>entitlement_key</code></td><td>VARCHAR(128)</td><td>NOT NULL</td><td>e.g., premium_listings</td></tr>
        <tr><td><code>is_active</code></td><td>BOOLEAN</td><td>NOT NULL, INDEX</td><td>Active flag</td></tr>
        <tr><td><code>expires_at</code></td><td>TIMESTAMPTZ</td><td>NOT NULL</td><td>Mirrors period_end + grace</td></tr>
      </tbody>
    </table>
  </div>

  <h3>Key Indexes</h3>
  <ul>
    <li><strong>UNIQUE partial index</strong> on <code>subscriptions(user_id)</code> WHERE status IN (trialing, active, past_due) &mdash; enforces one active sub per user</li>
    <li><strong>Composite index</strong> on <code>subscriptions(status, current_period_end)</code> &mdash; batch jobs find expiring subs</li>
    <li><strong>UNIQUE partial index</strong> on <code>entitlements(user_id, entitlement_key)</code> WHERE is_active = true &mdash; fast lookups, no duplicates</li>
  </ul>

  <div class="tip-box purple">
    <strong>PE Signal: Why Plan Versioning?</strong>
    When prices change, existing subscribers should be grandfathered at their original price. The <code>plan_version</code> column in subscriptions captures the exact plan terms at subscription time. The plans table uses soft-deactivation (<code>is_active</code>) so old plans remain queryable for existing subscribers but are hidden from new sign-ups.
  </div>
  </details>
</section>

<!-- ============================= 7. STATE MACHINE ============================= -->
<section id="state-machine">
  <details>
  <summary><h2>
    <span class="section-icon" style="background:rgba(245,158,11,0.15); color:var(--warning);">7</span>
    Subscription State Machine
  </h2></summary>

  <div class="state-machine">
    <div class="states">
      <div class="state-node trial">TRIALING</div>
      <div class="arrow">&#8594;</div>
      <div class="state-node active">ACTIVE</div>
      <div class="arrow">&#8594;</div>
      <div class="state-node past-due">PAST_DUE</div>
      <div class="arrow">&#8594;</div>
      <div class="state-node cancelled">CANCELLED</div>
      <div class="arrow">&#8594;</div>
      <div class="state-node expired">EXPIRED</div>
    </div>
    <div style="margin-top:20px;">
      <div class="state-node paused" style="display:inline-flex;">PAUSED</div>
    </div>
  </div>

  <h3>State Transition Rules</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>From</th>
          <th>To</th>
          <th>Trigger</th>
          <th>Side Effects</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><code>TRIALING</code></td>
          <td><code>ACTIVE</code></td>
          <td>Trial ends + first payment succeeds</td>
          <td>Grant full entitlements, send welcome email, start billing cycle</td>
        </tr>
        <tr>
          <td><code>TRIALING</code></td>
          <td><code>CANCELLED</code></td>
          <td>User cancels during trial</td>
          <td>Revoke entitlements immediately, no charge, send cancellation email</td>
        </tr>
        <tr>
          <td><code>TRIALING</code></td>
          <td><code>PAST_DUE</code></td>
          <td>Trial ends + first payment fails</td>
          <td>Keep entitlements for grace period, start dunning sequence</td>
        </tr>
        <tr>
          <td><code>ACTIVE</code></td>
          <td><code>ACTIVE</code></td>
          <td>Renewal payment succeeds</td>
          <td>Extend period_end, emit billing event, send receipt</td>
        </tr>
        <tr>
          <td><code>ACTIVE</code></td>
          <td><code>PAST_DUE</code></td>
          <td>Renewal payment fails</td>
          <td>Begin grace period (7 days), start dunning emails, keep entitlements</td>
        </tr>
        <tr>
          <td><code>ACTIVE</code></td>
          <td><code>CANCELLED</code></td>
          <td>User initiates cancel</td>
          <td>Set cancel_at_period_end=true, keep entitlements until period end</td>
        </tr>
        <tr>
          <td><code>ACTIVE</code></td>
          <td><code>PAUSED</code></td>
          <td>User requests pause</td>
          <td>Stop billing, keep limited entitlements, schedule resume_at</td>
        </tr>
        <tr>
          <td><code>PAST_DUE</code></td>
          <td><code>ACTIVE</code></td>
          <td>Retry payment succeeds</td>
          <td>Restore full entitlements, send recovery email, reset retry count</td>
        </tr>
        <tr>
          <td><code>PAST_DUE</code></td>
          <td><code>CANCELLED</code></td>
          <td>All retries exhausted (day 7)</td>
          <td>Revoke entitlements, send final dunning email, offer resubscribe link</td>
        </tr>
        <tr>
          <td><code>PAUSED</code></td>
          <td><code>ACTIVE</code></td>
          <td>User resumes or resume_at date arrives</td>
          <td>Resume billing, restore full entitlements</td>
        </tr>
        <tr>
          <td><code>CANCELLED</code></td>
          <td><code>EXPIRED</code></td>
          <td>Billing period ends (for cancel_at_period_end)</td>
          <td>Revoke all entitlements, final cleanup</td>
        </tr>
        <tr>
          <td><code>CANCELLED</code></td>
          <td><code>ACTIVE</code></td>
          <td>User resubscribes within 30 days</td>
          <td>Create new subscription, carry over loyalty benefits</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h3>7-Day Dunning Sequence</h3>
  <div class="table-wrap">
    <table>
      <thead><tr><th>Day</th><th>Action</th><th>Entitlements</th></tr></thead>
      <tbody>
        <tr><td><strong>0</strong></td><td>Payment fails &rarr; status = PAST_DUE. Email + push: "update your card"</td><td>Still active (grace)</td></tr>
        <tr><td><strong>1</strong></td><td>Stripe Smart Retry #1. If success &rarr; ACTIVE</td><td>Still active</td></tr>
        <tr><td><strong>3</strong></td><td>Retry #2. Email + in-app banner</td><td>Still active</td></tr>
        <tr><td><strong>5</strong></td><td>Retry #3. Email: "subscription at risk"</td><td>Still active</td></tr>
        <tr><td><strong>7</strong></td><td>Final retry. If fail &rarr; CANCELLED. Revoke entitlements.</td><td>Revoked</td></tr>
      </tbody>
    </table>
  </div>
  <p style="color:var(--text-muted); font-size:0.9rem; margin-top:8px;">Grace period recovers 60-80% of failed payments. Never revoke on first failure &mdash; most are recoverable (expired card, insufficient funds).</p>
  </details>
</section>

<!-- ============================= 8. BILLING DEEP DIVE ============================= -->
<section id="billing">
  <details>
  <summary><h2>
    <span class="section-icon" style="background:rgba(255,90,95,0.15); color:var(--primary);">8</span>
    Billing Deep Dive
  </h2></summary>

  <h3>Stripe Responsibility Split</h3>
  <div class="card">
    <ul>
      <li><strong>Stripe owns:</strong> Charge scheduling, Smart Retries, card network comms, PCI compliance</li>
      <li><strong>We own:</strong> Subscription lifecycle, entitlements, dunning UX, plan catalog, reconciliation</li>
      <li><strong>Source of truth:</strong> Stripe for payment state, our DB for entitlements. Reconcile hourly.</li>
    </ul>
  </div>

  <h3>Webhook Processing (Pseudocode)</h3>
<pre><code>HANDLE_STRIPE_WEBHOOK(raw_body, signature):

  1. VERIFY signature using webhook secret
     &rarr; reject if invalid (return 400)

  2. CHECK idempotency: lookup stripe_event_id in billing_events
     &rarr; if already exists, return 200 (skip duplicate)

  3. BEGIN DB TRANSACTION:
     &rarr; INSERT billing_event (stripe_event_id = idempotency guard)
     &rarr; UPDATE subscription state based on event type
       - invoice.paid       &rarr; status = ACTIVE, extend period_end
       - payment_failed     &rarr; status = PAST_DUE, start dunning
       - subscription.deleted &rarr; status = CANCELLED
  4. COMMIT transaction

  5. PUBLISH to Kafka (outside transaction):
     &rarr; topic: billing.events { type, subscription_id, timestamp }
     &rarr; Downstream: Entitlement Svc, Notification Svc consume</code></pre>

  <div class="tip-box warning">
    <strong>Reconciliation is Non-Negotiable</strong>
    Webhooks can be lost or arrive out of order. A cron job runs hourly, pulls subscription state from Stripe API, compares with our DB. Any discrepancy triggers alert + auto-correction.
  </div>
  </details>
</section>

<!-- ============================= 9. ENTITLEMENT SYSTEM ============================= -->
<section id="entitlements">
  <details>
  <summary><h2>
    <span class="section-icon" style="background:rgba(66,139,249,0.08); color:var(--blue);">9</span>
    Entitlement System
  </h2></summary>

  <h3>How Premium Listings are Gated</h3>
  <div class="flow-diagram">
    <h4 style="color:var(--text); margin-bottom:18px;">Entitlement Check Flow (Listing Page Load)</h4>
    <div class="flow-row">
      <div class="flow-box client">Client: Fetch<br>Listing Page</div>
      <div class="arrow">&#8594;</div>
      <div class="flow-box service">Listing<br>Service</div>
      <div class="arrow">&#8594;</div>
      <div class="flow-box service">Entitlement<br>Service (gRPC)</div>
      <div class="arrow">&#8594;</div>
      <div class="flow-box cache">Redis<br>Cache</div>
    </div>
    <div class="flow-row" style="margin-top: 15px;">
      <div class="flow-box cache">Cache HIT<br>(&lt;2ms)</div>
      <div class="arrow">&#8594;</div>
      <div class="flow-box service">Return<br>Entitlement</div>
      <div class="arrow" style="visibility:hidden;">&#8594;</div>
      <div class="flow-box cache" style="border-color:var(--warning); color:var(--warning);">Cache MISS</div>
      <div class="arrow">&#8594;</div>
      <div class="flow-box db">PostgreSQL<br>Lookup</div>
    </div>
  </div>

  <h3>Entitlement Check (Pseudocode)</h3>
<pre><code>CHECK_ENTITLEMENT(user_id, entitlement_key):

  1. Redis lookup: HGET entitlement:{user_id} {entitlement_key}
     &rarr; HIT: return { granted: expires_at > NOW }     &lt;2ms

  2. Cache MISS: query PostgreSQL
     &rarr; SELECT FROM entitlements WHERE user_id, key, is_active=true

  3. If found: batch-load ALL user entitlements into Redis hash
     &rarr; HMSET entitlement:{user_id} { key1: expiry, key2: expiry, ... }
     &rarr; EXPIRE 300s (5 min TTL)

  4. Return { granted, expires_at }

Redis key: entitlement:{user_id}  (Hash: entitlement_key &rarr; expiry)
TTL: 5 min  |  Invalidation: Kafka event + TTL fallback</code></pre>

  <h3>Consistency on State Changes</h3>
  <div class="card">
    <ul>
      <li><strong>T+0ms:</strong> Subscription Svc updates PG, publishes event to Kafka</li>
      <li><strong>T+50ms:</strong> Entitlement Svc consumes event, updates PG, invalidates Redis cache</li>
      <li><strong>T+100ms:</strong> Next check triggers cache miss &rarr; repopulates with new entitlements</li>
      <li><strong>Worst case:</strong> Cache invalidation fails &rarr; stale for up to 5 min (TTL self-heals)</li>
    </ul>
  </div>

  <div class="tip-box danger">
    <strong>Fail Open for Upgrades, Fail Closed for Downgrades</strong>
    On upgrade, propagation delay is safe (user keeps old lesser access). On cancellation/downgrade, proactively invalidate cache immediately. If Redis is down, fall back to PostgreSQL. Never fail open on revocation.
  </div>
  </details>
</section>

<!-- ============================= 10. TRADE-OFFS ============================= -->
<section id="tradeoffs">
  <details>
  <summary><h2>
    <span class="section-icon" style="background:rgba(252,100,45,0.15); color:var(--accent);">10</span>
    Trade-offs Analysis
  </h2></summary>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Decision</th>
          <th>Option A</th>
          <th>Option B</th>
          <th>Our Choice</th>
          <th>Rationale</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Build vs Buy Billing</strong></td>
          <td>Build custom billing engine</td>
          <td>Use Stripe Billing</td>
          <td style="color:var(--success);">Stripe Billing</td>
          <td>PCI compliance, retry logic, tax handling, and card updater are exceptionally complex. Stripe handles this at scale. Build our own entitlement layer on top.</td>
        </tr>
        <tr>
          <td><strong>Entitlement: Sync vs Async</strong></td>
          <td>Synchronous DB check on every request</td>
          <td>Async event-driven with Redis cache</td>
          <td style="color:var(--success);">Async + Redis</td>
          <td>50K QPS cannot hit PostgreSQL directly. Redis gives &lt;2ms lookups. Accept 5-min eventual consistency. Use event-driven invalidation for faster convergence.</td>
        </tr>
        <tr>
          <td><strong>Consistency Model</strong></td>
          <td>Strong consistency (two-phase commit with Stripe)</td>
          <td>Eventual consistency with reconciliation</td>
          <td style="color:var(--success);">Eventual + Reconciliation</td>
          <td>2PC across Stripe boundary is impractical. Use idempotent event processing + hourly reconciliation. Stripe is source of truth for payments; we are source of truth for entitlements.</td>
        </tr>
        <tr>
          <td><strong>Entitlement Checks: Centralized vs Distributed</strong></td>
          <td>Central Entitlement Service (all checks go through one service)</td>
          <td>Distributed (embed entitlement SDK in each service)</td>
          <td style="color:var(--success);">Centralized + gRPC</td>
          <td>Centralized gives single source of truth, easier auditing, and simpler cache invalidation. gRPC keeps latency under 5ms. SDK approach creates cache coherency nightmares at scale.</td>
        </tr>
        <tr>
          <td><strong>State Machine: Application vs DB</strong></td>
          <td>Enforce state transitions in application code</td>
          <td>Use DB constraints and triggers</td>
          <td style="color:var(--success);">Application Code</td>
          <td>Application-level state machine is testable, loggable, and can emit events. DB triggers are opaque and hard to debug. Use partial unique indexes for safety nets.</td>
        </tr>
        <tr>
          <td><strong>Billing Anchor: Fixed vs Staggered</strong></td>
          <td>Bill everyone on 1st of month</td>
          <td>Bill on subscription anniversary date</td>
          <td style="color:var(--success);">Anniversary Date</td>
          <td>Fixed billing creates massive renewal spikes. Anniversary billing distributes load evenly. Stripe supports this natively with billing_cycle_anchor.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="tip-box info">
    <strong>Vendor Lock-in Mitigation</strong>
    Design a <code>PaymentProvider</code> adapter interface. Subscription Service calls the adapter, not Stripe directly. Swap to Adyen/Braintree without changing business logic.
  </div>
  </details>
</section>

<!-- ============================= 11. INTERVIEW TIPS ============================= -->
<section id="interview-tips">
  <details>
  <summary><h2>
    <span class="section-icon" style="background:rgba(16,185,129,0.15); color:var(--success);">11</span>
    Interview Tips and Calibration
  </h2></summary>

  <h3>Key Signals Interviewers Look For</h3>
  <div class="card-grid-3">
    <div class="card">
      <h4 style="color:var(--success);">Strong Hire Signals</h4>
      <ul>
        <li>Separates billing, subscription, and entitlement into distinct services with clear ownership</li>
        <li>Discusses idempotency for all payment mutations</li>
        <li>Proposes webhook reliability pattern with deduplication and reconciliation</li>
        <li>Designs a state machine with explicit transitions and side effects</li>
        <li>Considers grace periods and dunning as first-class concerns</li>
        <li>Caches entitlements in Redis with event-driven invalidation</li>
        <li>Discusses proration, multi-currency, and tax without being prompted</li>
      </ul>
    </div>
    <div class="card">
      <h4 style="color:var(--warning);">Common Mistakes</h4>
      <ul>
        <li>Treating subscription as a CRUD problem without a state machine</li>
        <li>No discussion of payment failure handling or retries</li>
        <li>Checking entitlements directly from the database at 50K QPS</li>
        <li>Missing idempotency on webhook handler (double-processing events)</li>
        <li>No reconciliation strategy between local DB and Stripe</li>
        <li>Over-engineering: building custom payment processing instead of using Stripe</li>
        <li>Ignoring eventual consistency and its implications for entitlement checks</li>
      </ul>
    </div>
    <div class="card">
      <h4 style="color:var(--blue);">Follow-Up Questions to Expect</h4>
      <ul>
        <li>"How do you handle a user who upgrades mid-cycle? Walk me through the proration."</li>
        <li>"What happens if Stripe is down for 2 hours?"</li>
        <li>"How would you migrate from Stripe to Adyen?"</li>
        <li>"A user claims they were double-charged. How do you investigate?"</li>
        <li>"How do you test the billing system? Can you charge real cards in staging?"</li>
        <li>"What metrics would you monitor on the subscription dashboard?"</li>
        <li>"How does the family plan work technically?"</li>
      </ul>
    </div>
  </div>

  <h3>Calibration by Level</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Level</th>
          <th>Expected Depth</th>
          <th>Key Differentiator</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><span class="badge badge-green">Mid-Level (L4)</span></td>
          <td>CRUD APIs, basic DB schema, "use Stripe" without detail</td>
          <td>Can describe the happy path end-to-end</td>
        </tr>
        <tr>
          <td><span class="badge badge-blue">Senior (L5)</span></td>
          <td>State machine, webhook handling, Redis caching, retry logic</td>
          <td>Considers failure modes, discusses idempotency</td>
        </tr>
        <tr>
          <td><span class="badge badge-purple">Staff (L6)</span></td>
          <td>Service decomposition, event-driven architecture, reconciliation, multi-currency</td>
          <td>Designs for operational excellence, discusses monitoring and alerting</td>
        </tr>
        <tr>
          <td><span class="badge badge-red">Principal (L7+)</span></td>
          <td>Full system including trade-offs, vendor lock-in mitigation, proration engine, tax compliance, GDPR, capacity planning with renewal spikes</td>
          <td>Makes and defends architectural trade-offs, considers business impact of every technical decision</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h3>Suggested Interview Timeline (45 min)</h3>
  <div class="card">
    <h4 style="color:var(--accent);">Time Allocation</h4>
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>Phase</th><th>Time</th><th>Focus</th></tr>
        </thead>
        <tbody>
          <tr><td>Requirements Gathering</td><td>5 min</td><td>Clarify scope, tiers, V1 vs V2 features</td></tr>
          <tr><td>High-Level Design</td><td>10 min</td><td>Service topology, Stripe integration, Kafka events</td></tr>
          <tr><td>API + Data Model</td><td>10 min</td><td>Key endpoints, schema, indexes</td></tr>
          <tr><td>State Machine + Billing</td><td>10 min</td><td>Transitions, webhooks, retry, dunning</td></tr>
          <tr><td>Entitlement Deep Dive</td><td>5 min</td><td>Redis caching, consistency, invalidation</td></tr>
          <tr><td>Trade-offs + Extensions</td><td>5 min</td><td>Build vs buy, consistency model, monitoring</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="tip-box purple">
    <strong>Final PE Advice</strong>
    The subscription problem is deceptively simple on the surface. What separates a principal engineer answer is the depth on <em>failure modes</em>: What happens when payments fail? When webhooks are lost? When Redis is down? When a user upgrades and immediately checks entitlements before the event propagates? Show that you have built and operated these systems, not just designed them on a whiteboard. Every design decision should connect back to a user experience or business outcome.
  </div>
  </details>
</section>

</div>

<!-- ============================= FOOTER ============================= -->
<footer>
  <p>Airbnb Subscription Model -- Principal Engineer System Design Reference</p>
  <p style="margin-top:8px; color:var(--text-muted);">Comprehensive coverage: Billing, Entitlements, State Machines, Stripe Integration, and Operational Excellence</p>
</footer>

<script>
// Auto-open collapsed section when clicking TOC link
document.querySelectorAll('.toc a[href^="#"]').forEach(function(link) {
  link.addEventListener('click', function() {
    var id = this.getAttribute('href').slice(1);
    var section = document.getElementById(id);
    if (section) {
      var details = section.querySelector('details');
      if (details) details.open = true;
    }
  });
});

(function(){
  document.querySelectorAll(".diagram-box").forEach(function(box){
    var svg=box.querySelector("svg");
    if(!svg) return;
    var zoom=1, minZ=0.5, maxZ=3;
    var ctrl=document.createElement("div");
    ctrl.className="diagram-zoom-controls";
    ctrl.innerHTML='<button class="zoom-out" title="Zoom Out"></button><span class="zoom-level">100%</span><button class="zoom-in" title="Zoom In">+</button><button class="zoom-reset" title="Reset"></button><button class="zoom-fs" title="Fullscreen"></button>';
    box.insertBefore(ctrl,box.firstChild);
    var lvl=ctrl.querySelector(".zoom-level");
    function apply(){svg.style.transform="scale("+zoom+")";lvl.textContent=Math.round(zoom*100)+"%";}
    ctrl.querySelector(".zoom-in").onclick=function(){zoom=Math.min(maxZ,zoom+0.25);apply();};
    ctrl.querySelector(".zoom-out").onclick=function(){zoom=Math.max(minZ,zoom-0.25);apply();};
    ctrl.querySelector(".zoom-reset").onclick=function(){zoom=1;apply();};
    ctrl.querySelector(".zoom-fs").onclick=function(){
      box.classList.toggle("fullscreen");
      if(box.classList.contains("fullscreen")){this.textContent="";zoom=1.2;}else{this.textContent="";zoom=1;}
      apply();
    };
    box.addEventListener("wheel",function(e){
      if(e.ctrlKey){e.preventDefault();zoom=e.deltaY<0?Math.min(maxZ,zoom+0.1):Math.max(minZ,zoom-0.1);apply();}
    },{passive:false});
  });
})();
</script>
</body>
</html>
