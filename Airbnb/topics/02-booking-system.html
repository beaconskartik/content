<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Airbnb Booking System - Principal Engineer System Design</title>
<style>
  :root {
    --primary: #FF5A5F;
    --primary-dark: #E04850;
    --secondary: #00A699;
    --accent: #FC642D;
    --purple: #7B2FF7;
    --blue: #428BF9;
    --dark: #ffffff;
    --darker: #f1f5f9;
    --card-bg: #ffffff;
    --card-border: #e2e8f0;
    --text: #1e293b;
    --text-muted: #4b5563;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--dark);
    color: var(--text);
    line-height: 1.7;
    scroll-behavior: smooth;
  }
  .hero {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #6B73FF 100%);
    padding: 60px 40px 50px;
    text-align: center;
    border-bottom: 3px solid var(--primary);
    position: relative;
    overflow: hidden;
  }
  .hero::before {
    content: '';
    position: absolute;
    top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: radial-gradient(circle at 30% 50%, rgba(255,90,95,0.15) 0%, transparent 50%),
                radial-gradient(circle at 70% 50%, rgba(0,166,153,0.15) 0%, transparent 50%);
    animation: pulse 8s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
  .hero h1 {
    font-size: 2.6em;
    background: linear-gradient(135deg, #ffffff, #e0e7ff, #ffffff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    position: relative;
    margin-bottom: 10px;
  }
  .hero .subtitle {
    font-size: 1.15em;
    color: rgba(255,255,255,0.9);
    position: relative;
    margin-bottom: 8px;
  }
  .hero .topic-badges { position: relative; margin-top: 15px; }
  .hero .back-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-top: 18px;
    color: #ffffff;
    text-decoration: none;
    font-size: 0.95em;
    font-weight: 600;
    position: relative;
    border: 1px solid rgba(255,255,255,0.4);
    background: rgba(255,255,255,0.15);
    padding: 10px 24px;
    border-radius: 10px;
    transition: all 0.3s;
  }
  .hero .back-link:hover {
    background: rgba(255,255,255,0.25);
    border-color: #e5e7eb;
    transform: translateX(-3px);
  }
  .hero .stats-row {
    position: relative;
    display: flex;
    justify-content: center;
    gap: 40px;
    margin-top: 25px;
    flex-wrap: wrap;
  }
  .hero .stat-item { text-align: center; }
  .hero .stat-value { font-size: 1.8em; font-weight: 800; color: #ffffff; }
  .hero .stat-label { font-size: 0.78em; color: rgba(255,255,255,0.8); text-transform: uppercase; letter-spacing: 1.5px; }
  .badge {
    display: inline-block;
    padding: 4px 14px;
    border-radius: 20px;
    font-size: 0.78em;
    font-weight: 600;
    margin: 3px 2px;
    white-space: nowrap;
  }
  .badge-red { background: rgba(255,255,255,0.15); color: #ffffff; border: 1px solid rgba(255,255,255,0.3); }
  .badge-green { background: rgba(0,166,153,0.2); color: #ffffff; border: 1px solid var(--secondary); }
  .badge-blue { background: rgba(255,255,255,0.15); color: #ffffff; border: 1px solid rgba(255,255,255,0.3); }
  .badge-purple { background: rgba(255,255,255,0.15); color: #ffffff; border: 1px solid rgba(255,255,255,0.3); }
  .badge-orange { background: rgba(255,255,255,0.15); color: #ffffff; border: 1px solid rgba(255,255,255,0.3); }
  .toc {
    background: #f8fafc;
    padding: 20px 40px;
    border-bottom: 1px solid var(--card-border);
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(10px);
  }
  .toc h2 {
    color: var(--secondary);
    margin-bottom: 10px;
    font-size: 0.85em;
    text-transform: uppercase;
    letter-spacing: 2px;
  }
  .toc-grid { display: flex; flex-wrap: wrap; gap: 8px; }
  .toc a {
    color: var(--text-muted);
    text-decoration: none;
    padding: 6px 16px;
    border-radius: 8px;
    font-size: 0.82em;
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    background: var(--card-bg);
    transition: all 0.3s;
    white-space: nowrap;
  }
  .toc a:hover { color: var(--primary); border-color: var(--primary); background: rgba(255,90,95,0.1); }
  .container { max-width: 1200px; margin: 0 auto; padding: 30px 40px; }
  section { margin-bottom: 55px; }
  section > h2 {
    font-size: 1.7em;
    margin-bottom: 25px;
    padding-bottom: 12px;
    border-bottom: 2px solid #e5e7eb;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .section-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 42px; height: 42px;
    border-radius: 10px;
    font-size: 1.2em;
    flex-shrink: 0;
  }
  h3 { font-size: 1.25em; color: var(--blue); margin: 25px 0 14px; }
  h4 { font-size: 1.05em; color: var(--blue); margin: 18px 0 10px; }
  p { margin-bottom: 12px; }
  ul, ol { margin: 10px 0 16px 24px; }
  li { margin-bottom: 6px; }
  .card {
    background: var(--card-bg);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 20px;
    transition: border-color 0.3s;
  }
  .card:hover { border-color: rgba(255,90,95,0.3); }
  .card h4 { font-size: 1.1em; margin-bottom: 12px; margin-top: 0; display: flex; align-items: center; gap: 8px; }
  .card-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
  }
  .table-wrap {
    overflow-x: auto;
    border-radius: 12px;
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    margin-bottom: 20px;
  }
  table { width: 100%; border-collapse: collapse; font-size: 0.88em; }
  th {
    background: #f8fafc;
    padding: 13px 16px;
    text-align: left;
    font-weight: 600;
    color: #1e293b;
    border-bottom: 2px solid #e5e7eb;
    white-space: nowrap;
  }
  td { padding: 11px 16px; border-bottom: 1px solid var(--card-border); vertical-align: top; }
  tr:hover td { background: rgba(66,139,249,0.04); }
  tr:last-child td { border-bottom: none; }
  pre {
    background: #f6f8fa;
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 10px;
    padding: 20px;
    overflow-x: auto;
    margin: 14px 0 20px;
    font-size: 0.85em;
    line-height: 1.6;
  }
  code { font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace; color: #24292f; }
  :not(pre) > code {
    background: rgba(66,139,249,0.1);
    padding: 2px 7px;
    border-radius: 5px;
    font-size: 0.88em;
    color: var(--blue);
  }
  .keyword { color: #cf222e; }
  .string { color: #0a3069; }
  .comment { color: #6e7781; font-style: italic; }
  .type { color: #8250df; }
  .number { color: #0550ae; }
  .func { color: #953800; }
  .tip-box {
    border-radius: 10px;
    padding: 18px 22px;
    margin: 16px 0 20px;
    font-size: 0.92em;
    border-left: 4px solid;
  }
  .tip-box.tip { background: rgba(16,185,129,0.06); border-color: var(--success); }
  .tip-box.warning { background: rgba(245,158,11,0.06); border-color: var(--warning); }
  .tip-box.danger { background: rgba(239,68,68,0.06); border-color: var(--danger); }
  .tip-box.info { background: rgba(66,139,249,0.08); border-color: var(--blue); }
  .tip-box.purple { background: rgba(123,47,247,0.08); border-color: var(--purple); }
  .tip-box strong { display: block; margin-bottom: 6px; }
  .diagram {
    background: #f6f8fa;
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 12px;
    padding: 25px;
    margin: 16px 0 20px;
    font-family: 'Cascadia Code', 'Fira Code', monospace;
    font-size: 0.82em;
    line-height: 1.5;
    overflow-x: auto;
    white-space: pre;
    color: var(--text-muted);
  }
  .diagram-box {
    background: rgba(0,0,0,0.05);
    border-radius: 12px;
    padding: 20px;
    overflow-x: auto;
    margin: 16px 0 20px;
  }
  .compare-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin: 16px 0 20px;
  }
  .compare-card {
    background: var(--card-bg);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 12px;
    padding: 22px;
  }
  .compare-card.opt-a { border-top: 3px solid var(--blue); }
  .compare-card.opt-b { border-top: 3px solid var(--secondary); }
  .compare-card h4 { margin-top: 0; }
  .er-table {
    background: var(--card-bg);
    border: 2px solid var(--card-border);
    border-radius: 10px;
    overflow: hidden;
    margin: 12px 0;
    min-width: 260px;
  }
  .er-table .er-header {
    background: #f8fafc;
    padding: 10px 16px;
    font-weight: 700;
    font-size: 0.95em;
    border-bottom: 2px solid #e5e7eb;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .er-table .er-row {
    padding: 6px 16px;
    font-size: 0.85em;
    border-bottom: 1px solid rgba(51,65,85,0.5);
    display: flex;
    justify-content: space-between;
    gap: 12px;
  }
  .er-table .er-row:last-child { border-bottom: none; }
  .er-col { color: var(--text); }
  .er-type { color: var(--text-muted); font-family: monospace; font-size: 0.92em; }
  .er-pk { color: var(--warning); font-weight: 600; }
  .er-fk { color: var(--purple); }
  .er-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin: 20px 0;
  }
  .flow-steps {
    display: flex;
    flex-wrap: wrap;
    gap: 0;
    margin: 20px 0;
    align-items: center;
  }
  .flow-step {
    background: var(--card-bg);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 10px;
    padding: 14px 20px;
    text-align: center;
    font-size: 0.88em;
    font-weight: 600;
    min-width: 130px;
  }
  .flow-step .step-label {
    font-size: 0.72em;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    display: block;
    margin-bottom: 4px;
    font-weight: 400;
  }
  .flow-arrow { color: var(--primary); font-size: 1.4em; padding: 0 8px; flex-shrink: 0; }
  .calibration { margin: 20px 0; }
  .calibration-row { display: flex; align-items: center; gap: 16px; margin-bottom: 14px; }
  .calibration-label { min-width: 130px; font-weight: 700; font-size: 0.9em; text-align: right; }
  .calibration-bar {
    flex: 1;
    height: 32px;
    background: rgba(255,255,255,0.05);
    border-radius: 8px;
    overflow: hidden;
    position: relative;
  }
  .calibration-fill {
    height: 100%;
    border-radius: 8px;
    display: flex;
    align-items: center;
    padding-left: 14px;
    font-size: 0.78em;
    font-weight: 600;
    color: #fff;
    transition: width 0.5s ease;
  }
  .cal-baseline { background: linear-gradient(90deg, #64748b, #94a3b8); width: 35%; }
  .cal-good { background: linear-gradient(90deg, var(--blue), #60a5fa); width: 55%; }
  .cal-yes { background: linear-gradient(90deg, var(--secondary), #34d399); width: 78%; }
  .cal-strong { background: linear-gradient(90deg, var(--success), #6ee7b7); width: 95%; }
  .footer {
    text-align: center;
    padding: 40px 30px;
    color: var(--text-muted);
    font-size: 0.85em;
    border-top: 1px solid #e5e7eb;
  }
  .footer a { color: var(--secondary); text-decoration: none; }
  .footer a:hover { color: var(--primary); }
  @media (max-width: 768px) {
    .hero { padding: 40px 20px 35px; }
    .hero h1 { font-size: 1.7em; }
    .toc { padding: 14px 20px; }
    .container { padding: 20px 16px; }
    .card-grid { grid-template-columns: 1fr; }
    .compare-grid { grid-template-columns: 1fr; }
    .er-grid { grid-template-columns: 1fr; }
    section > h2 { font-size: 1.3em; }
    .hero .stats-row { gap: 20px; }
    .flow-steps { flex-direction: column; }
    .flow-arrow { transform: rotate(90deg); }
    .calibration-row { flex-direction: column; gap: 6px; }
    .calibration-label { text-align: left; min-width: unset; }
  }
  @media (max-width: 480px) {
    .hero h1 { font-size: 1.4em; }
    pre { font-size: 0.75em; padding: 14px; }
  }
  /* === DIAGRAM ZOOM CONTROLS === */
  .diagram-box { position: relative; }
  .diagram-zoom-controls {
    position: absolute; top: 12px; right: 12px; z-index: 10;
    display: flex; gap: 4px; opacity: 0.5; transition: opacity 0.3s;
  }
  .diagram-box:hover .diagram-zoom-controls { opacity: 1; }
  .diagram-zoom-controls button {
    width: 32px; height: 32px; border-radius: 8px; border: 1px solid #e5e7eb;
    background: #ffffff; color: #1e293b; cursor: pointer; font-size: 16px;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.2s;
    font-family: system-ui; line-height: 1; padding: 0;
  }
  .diagram-zoom-controls button:hover { background: #f1f5f9; border-color: var(--blue); color: var(--blue); }
  .diagram-zoom-controls button:active { transform: scale(0.95); }
  .diagram-zoom-controls .zoom-level {
    font-size: 11px; color: #64748b; display: flex; align-items: center;
    padding: 0 6px; font-weight: 600; min-width: 40px; justify-content: center;
  }
  .diagram-box svg { transition: transform 0.3s ease; transform-origin: center center; }
  .diagram-box.fullscreen {
    position: fixed !important; top: 0; left: 0; width: 100vw; height: 100vh;
    z-index: 9999; background: #ffffff; border-radius: 0; padding: 20px;
    display: flex; align-items: center; justify-content: center;
    overflow: auto;
  }
  .diagram-box.fullscreen .diagram-zoom-controls { opacity: 1; top: 20px; right: 20px; }
</style>
</head>
<body>

<!-- ================================================================== -->
<!-- HERO + STICKY NAV                                                   -->
<!-- ================================================================== -->
<div class="hero">
  <a href="index.html" class="back-link">&#8592; Back to All Topics</a>
  <h1>Airbnb Booking System</h1>
  <p class="subtitle">Search, Reserve, View History, Update/Cancel &mdash; End-to-End Platform Design</p>
  <div class="topic-badges">
    <span class="badge badge-red">Principal Engineer</span>
    <span class="badge badge-purple">Hard</span>
    <span class="badge badge-green">CQRS</span>
    <span class="badge badge-blue">Microservices</span>
    <span class="badge badge-orange">Distributed Locks</span>
  </div>
  <div class="stats-row">
    <div class="stat-item">
      <div class="stat-value">10M</div>
      <div class="stat-label">Daily Active Users</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">~580</div>
      <div class="stat-label">Search QPS</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">99.99%</div>
      <div class="stat-label">Availability SLA</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">0</div>
      <div class="stat-label">Double Bookings</div>
    </div>
  </div>
</div>

<nav class="toc">
  <h2>Navigation</h2>
  <div class="toc-grid">
    <a href="#overview">Overview</a>
    <a href="#requirements">Requirements</a>
    <a href="#capacity">Capacity Estimates</a>
    <a href="#architecture">Architecture</a>
    <a href="#api">API Design</a>
    <a href="#data-model">Data Model</a>
    <a href="#booking-flow">Booking Flow</a>
    <a href="#search">Search Deep Dive</a>
    <a href="#tradeoffs">Trade-offs</a>
    <a href="#scalability">Scalability</a>
    <a href="#interview">Interview Tips</a>
  </div>
</nav>

<div class="container">

<!-- ================================================================== -->
<!-- SECTION 1: OVERVIEW                                                 -->
<!-- ================================================================== -->
<section id="overview">
  <h2>
    <span class="section-icon" style="background:rgba(255,90,95,0.15); color:var(--primary);">&#127968;</span>
    Overview
  </h2>
  <p>
    The Airbnb Booking System is the transactional heart of the platform. It orchestrates the entire lifecycle from the moment a guest searches for a listing through reservation, stay, and post-checkout. At 10M DAU and millions of active listings across 220+ countries, this system must deliver sub-200ms search latency, guarantee zero double-bookings, and maintain 99.99% uptime -- all while handling complex pricing models (seasonal rates, cleaning fees, service fees, multi-currency) and coordinating with payment processors, notification systems, and host calendars in real time.
  </p>
  <div class="card-grid">
    <div class="card">
      <h4 style="color:var(--primary);">&#128269; Search</h4>
      <p>Guests search by location (geo-bounding box), check-in/check-out dates, guest count, and dozens of filters (price range, amenities, property type, Superhost). Results are ranked by relevance, price, and personalization signals.</p>
    </div>
    <div class="card">
      <h4 style="color:var(--secondary);">&#128221; Reserve</h4>
      <p>Once a guest selects a listing, the system atomically checks availability, calculates the total price (nightly rate x nights + fees + taxes), holds the dates, and initiates payment capture. The entire flow must be idempotent to handle retries.</p>
    </div>
    <div class="card">
      <h4 style="color:var(--blue);">&#128197; View History</h4>
      <p>Both guests and hosts need paginated access to their booking history with filtering by status (upcoming, completed, cancelled), date range, and listing. This read-heavy path is served from a denormalized read store via CQRS.</p>
    </div>
    <div class="card">
      <h4 style="color:var(--purple);">&#9999;&#65039; Update / Cancel</h4>
      <p>Guests can modify dates or cancel (subject to the host's cancellation policy). Hosts can cancel (with penalties). Each mutation triggers recalculation of pricing, refund processing, calendar release, and notifications to all parties.</p>
    </div>
  </div>

  <div class="tip-box info">
    <strong>&#128161; Why This Problem Is PE-Level</strong>
    The booking system sits at the intersection of distributed transactions (no double booking), financial correctness (payments), search relevance, and multi-region availability. A strong answer must address consistency vs. availability trade-offs across every layer.
  </div>
</section>

<!-- ================================================================== -->
<!-- SECTION 2: REQUIREMENTS                                             -->
<!-- ================================================================== -->
<section id="requirements">
  <h2>
    <span class="section-icon" style="background:rgba(0,166,153,0.15); color:var(--secondary);">&#128203;</span>
    Requirements
  </h2>

  <h3>Functional Requirements</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr><th>#</th><th>Requirement</th><th>Details</th></tr>
      </thead>
      <tbody>
        <tr><td>FR-1</td><td><strong>Search Listings</strong></td><td>Search by geo-location (lat/lng bounding box or radius), check-in/check-out dates, number of guests, price range, property type, amenities, Superhost, instant book, and more.</td></tr>
        <tr><td>FR-2</td><td><strong>Create Booking</strong></td><td>Guest selects listing + dates, system verifies availability, calculates total price, creates reservation, and initiates payment. Must be atomic -- no partial bookings.</td></tr>
        <tr><td>FR-3</td><td><strong>View Booking History</strong></td><td>Paginated list of bookings for guest (my trips) and host (my reservations). Filterable by status, date range, listing.</td></tr>
        <tr><td>FR-4</td><td><strong>Update Booking</strong></td><td>Modify dates (subject to availability), guest count, or special requests. Triggers price recalculation and differential payment/refund.</td></tr>
        <tr><td>FR-5</td><td><strong>Cancel Booking</strong></td><td>Guest or host initiates cancellation. Refund amount determined by cancellation policy (Flexible, Moderate, Strict, Super Strict). Calendar dates released.</td></tr>
        <tr><td>FR-6</td><td><strong>Availability Management</strong></td><td>Hosts set blocked dates, minimum/maximum stay, custom pricing per night. Calendar syncs with external platforms (iCal).</td></tr>
        <tr><td>FR-7</td><td><strong>Price Calculation</strong></td><td>Nightly rate (may vary per night) x number of nights + cleaning fee + service fee (guest) + host fee + occupancy taxes. Multi-currency with FX at time of booking.</td></tr>
      </tbody>
    </table>
  </div>

  <h3>Non-Functional Requirements</h3>
  <div class="card-grid">
    <div class="card" style="border-left: 3px solid var(--primary);">
      <h4 style="color:var(--primary);">&#9889; Latency</h4>
      <ul>
        <li>Search P99 &lt; 200ms</li>
        <li>Booking creation P99 &lt; 500ms</li>
        <li>History retrieval P99 &lt; 150ms</li>
      </ul>
    </div>
    <div class="card" style="border-left: 3px solid var(--secondary);">
      <h4 style="color:var(--secondary);">&#128737;&#65039; Availability</h4>
      <ul>
        <li>99.99% uptime (52 min downtime/year)</li>
        <li>Multi-region active-active for search</li>
        <li>Single-leader for bookings (consistency)</li>
      </ul>
    </div>
    <div class="card" style="border-left: 3px solid var(--purple);">
      <h4 style="color:var(--purple);">&#128274; Consistency</h4>
      <ul>
        <li>Zero double-bookings (strong consistency)</li>
        <li>Idempotent booking creation (client retries)</li>
        <li>Exactly-once payment capture</li>
      </ul>
    </div>
    <div class="card" style="border-left: 3px solid var(--blue);">
      <h4 style="color:var(--blue);">&#128200; Scale</h4>
      <ul>
        <li>10M DAU, 7M+ active listings</li>
        <li>~50M searches/day</li>
        <li>~1.5M bookings/day</li>
      </ul>
    </div>
  </div>

  <div class="tip-box warning">
    <strong>&#9888;&#65039; Idempotency is Critical</strong>
    Mobile clients on unreliable networks will retry booking requests. Without idempotency keys, a single tap could produce duplicate charges. Every mutating API must accept a client-generated <code>idempotency_key</code> (UUID v4) and return the cached result on replay.
  </div>
</section>

<!-- ================================================================== -->
<!-- SECTION 3: CAPACITY ESTIMATES                                       -->
<!-- ================================================================== -->
<section id="capacity">
  <h2>
    <span class="section-icon" style="background:rgba(66,139,249,0.08); color:var(--blue);">&#128202;</span>
    Capacity Estimates
  </h2>

  <h3>Traffic Estimates</h3>
  <div class="card">
    <h4 style="color:var(--blue);">&#128290; Search QPS</h4>
<pre><code><span class="comment">// Search traffic estimation</span>
DAU                = 10,000,000
Searches per user  = 5 (average across browse sessions)
Total searches/day = 10M x 5 = <span class="number">50,000,000</span>

Peak multiplier    = 3x (evenings, weekends, holiday planning)
Average QPS        = 50M / 86,400 = <span class="number">~578 QPS</span>
Peak QPS           = 578 x 3     = <span class="number">~1,736 QPS</span>
</code></pre>
  </div>

  <div class="card">
    <h4 style="color:var(--secondary);">&#128290; Booking TPS</h4>
<pre><code><span class="comment">// Booking traffic estimation</span>
DAU                  = 10,000,000
Conversion rate      = 1.5% (industry benchmark for travel)
Bookings/day         = 10M x 0.015 = <span class="number">150,000</span>

<span class="comment">// But ~10x booking ATTEMPTS per success (browsing, abandoned carts)</span>
Booking attempts/day = 150,000 x 10 = <span class="number">1,500,000</span>

Average TPS          = 1.5M / 86,400 = <span class="number">~17 TPS</span>
Peak TPS             = 17 x 5        = <span class="number">~85 TPS</span>
</code></pre>
  </div>

  <div class="card">
    <h4 style="color:var(--accent);">&#128290; Storage Estimates</h4>
<pre><code><span class="comment">// Storage estimation (5-year horizon)</span>
Listings:
  7M listings x 5 KB avg    = <span class="number">~35 GB</span> (PostgreSQL)
  7M listings x 2 KB index  = <span class="number">~14 GB</span> (Elasticsearch)

Bookings:
  150K/day x 365 x 5 years  = <span class="number">~274M rows</span>
  274M x 1 KB avg            = <span class="number">~274 GB</span> (PostgreSQL)

Availability Calendar:
  7M listings x 365 days x 50 bytes = <span class="number">~128 GB</span>

Booking History (denormalized read store):
  274M x 2 KB (enriched)    = <span class="number">~548 GB</span> (Redis/Cassandra)

Total Hot Storage:  ~200 GB (Redis cache layers)
Total Warm Storage: ~1 TB   (PostgreSQL primary)
Total Cold Storage: ~5 TB   (S3/archival over 5 years)
</code></pre>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr><th>Metric</th><th>Value</th><th>Formula</th></tr>
      </thead>
      <tbody>
        <tr><td>Search QPS (avg)</td><td><strong>~580</strong></td><td>10M DAU x 5 searches / 86,400s</td></tr>
        <tr><td>Search QPS (peak)</td><td><strong>~1,740</strong></td><td>580 x 3 (peak multiplier)</td></tr>
        <tr><td>Booking TPS (avg)</td><td><strong>~17</strong></td><td>1.5M attempts / 86,400s</td></tr>
        <tr><td>Booking TPS (peak)</td><td><strong>~85</strong></td><td>17 x 5 (flash sales, holidays)</td></tr>
        <tr><td>Read:Write ratio</td><td><strong>~33:1</strong></td><td>580 search / 17 booking</td></tr>
        <tr><td>Bandwidth (search)</td><td><strong>~87 MB/s peak</strong></td><td>1,740 QPS x 50KB response</td></tr>
        <tr><td>DB connections needed</td><td><strong>~500</strong></td><td>85 TPS x 6 queries/txn (pooled)</td></tr>
      </tbody>
    </table>
  </div>
</section>

<!-- ================================================================== -->
<!-- SECTION 4: HIGH-LEVEL ARCHITECTURE                                  -->
<!-- ================================================================== -->
<section id="architecture">
  <h2>
    <span class="section-icon" style="background:rgba(123,47,247,0.15); color:var(--purple);">&#127959;&#65039;</span>
    High-Level Architecture
  </h2>

  <p>We adopt a <strong>microservices architecture</strong> with <strong>CQRS</strong> (Command Query Responsibility Segregation) to independently scale the read-heavy search path and the write-heavy booking path. An event bus (Kafka) decouples services and enables eventual consistency for non-critical paths.</p>

  <div class="diagram-box">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1100 720" font-family="Segoe UI, sans-serif" style="width:100%; height:auto;">
      <defs>
        <!-- Arrow marker -->
        <marker id="arr" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
          <path d="M0,0 L8,3 L0,6 Z" fill="#94a3b8"/>
        </marker>
        <marker id="arrRed" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
          <path d="M0,0 L8,3 L0,6 Z" fill="#ef4444"/>
        </marker>
        <!-- Shadow filter -->
        <filter id="shadow" x="-4%" y="-4%" width="108%" height="112%">
          <feDropShadow dx="0" dy="2" stdDeviation="4" flood-color="#000" flood-opacity="0.4"/>
        </filter>
        <!-- Service gradients -->
        <linearGradient id="gSearch" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#428BF9"/><stop offset="100%" stop-color="#2563eb"/></linearGradient>
        <linearGradient id="gBooking" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#00A699"/><stop offset="100%" stop-color="#059669"/></linearGradient>
        <linearGradient id="gListing" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#7b2ff7"/><stop offset="100%" stop-color="#6d28d9"/></linearGradient>
        <linearGradient id="gPayment" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#f59e0b"/><stop offset="100%" stop-color="#d97706"/></linearGradient>
        <linearGradient id="gUser" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#FF5A5F"/><stop offset="100%" stop-color="#dc2626"/></linearGradient>
        <linearGradient id="gPricing" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#10b981"/><stop offset="100%" stop-color="#047857"/></linearGradient>
        <linearGradient id="gConsumer" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#334155"/><stop offset="100%" stop-color="#1e293b"/></linearGradient>
      </defs>

      <!-- Column headers -->
      <text x="80" y="28" fill="#64748b" font-size="11" font-weight="700" letter-spacing="2" text-anchor="middle">CLIENTS</text>
      <text x="550" y="28" fill="#64748b" font-size="11" font-weight="700" letter-spacing="2" text-anchor="middle">SERVICES</text>
      <text x="960" y="28" fill="#64748b" font-size="11" font-weight="700" letter-spacing="2" text-anchor="middle">DATA LAYER</text>

      <!-- ===== CLIENTS ===== -->
      <!-- Web Browser -->
      <rect x="20" y="80" width="120" height="50" rx="10" fill="#f8fafc" stroke="#428BF9" stroke-width="1.5" filter="url(#shadow)"/>
      <text x="80" y="101" fill="#428BF9" font-size="11" font-weight="700" text-anchor="middle">Web Browser</text>
      <text x="80" y="117" fill="#64748b" font-size="9" text-anchor="middle">React SPA</text>
      <!-- Mobile App -->
      <rect x="20" y="150" width="120" height="50" rx="10" fill="#f8fafc" stroke="#428BF9" stroke-width="1.5" filter="url(#shadow)"/>
      <text x="80" y="171" fill="#428BF9" font-size="11" font-weight="700" text-anchor="middle">Mobile App</text>
      <text x="80" y="187" fill="#64748b" font-size="9" text-anchor="middle">iOS / Android</text>

      <!-- ===== GATEWAY LAYER ===== -->
      <!-- CDN -->
      <g transform="translate(220, 60)">
        <rect x="0" y="0" width="130" height="50" rx="10" fill="#f8fafc" stroke="#f59e0b" stroke-width="1.5" filter="url(#shadow)"/>
        <!-- CDN globe icon -->
        <circle cx="22" cy="25" r="10" fill="none" stroke="#f59e0b" stroke-width="1.2"/>
        <ellipse cx="22" cy="25" rx="5" ry="10" fill="none" stroke="#f59e0b" stroke-width="0.8"/>
        <line x1="12" y1="22" x2="32" y2="22" stroke="#f59e0b" stroke-width="0.6"/>
        <line x1="12" y1="28" x2="32" y2="28" stroke="#f59e0b" stroke-width="0.6"/>
        <text x="75" y="22" fill="#f59e0b" font-size="11" font-weight="700" text-anchor="middle">CDN / Edge</text>
        <text x="75" y="37" fill="#64748b" font-size="9" text-anchor="middle">Static Assets</text>
      </g>
      <!-- Load Balancer -->
      <g transform="translate(220, 130)">
        <rect x="0" y="0" width="130" height="50" rx="10" fill="#f8fafc" stroke="#10b981" stroke-width="1.5" filter="url(#shadow)"/>
        <!-- LB split arrows icon -->
        <line x1="12" y1="25" x2="22" y2="25" stroke="#10b981" stroke-width="2"/>
        <line x1="22" y1="25" x2="32" y2="18" stroke="#10b981" stroke-width="2"/>
        <line x1="22" y1="25" x2="32" y2="32" stroke="#10b981" stroke-width="2"/>
        <text x="78" y="22" fill="#10b981" font-size="11" font-weight="700" text-anchor="middle">Load Balancer</text>
        <text x="78" y="37" fill="#64748b" font-size="9" text-anchor="middle">L7 / Nginx</text>
      </g>
      <!-- API Gateway -->
      <g transform="translate(220, 200)">
        <rect x="0" y="0" width="130" height="50" rx="10" fill="#f8fafc" stroke="#FF5A5F" stroke-width="1.5" filter="url(#shadow)"/>
        <!-- Shield icon -->
        <path d="M17,12 L17,30 Q17,36 27,40 Q37,36 37,30 L37,12 Q27,8 17,12 Z" fill="none" stroke="#FF5A5F" stroke-width="1.2" transform="scale(0.55) translate(8,14)"/>
        <text x="75" y="22" fill="#FF5A5F" font-size="11" font-weight="700" text-anchor="middle">API Gateway</text>
        <text x="75" y="37" fill="#64748b" font-size="9" text-anchor="middle">Auth + Rate Limit</text>
      </g>

      <!-- Client to CDN -->
      <line x1="140" y1="105" x2="218" y2="85" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arr)"/>
      <line x1="140" y1="175" x2="218" y2="160" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arr)"/>
      <!-- CDN to LB -->
      <line x1="285" y1="110" x2="285" y2="128" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arr)"/>
      <!-- LB to API GW -->
      <line x1="285" y1="180" x2="285" y2="198" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arr)"/>

      <!-- ===== SERVICES (Middle Column) ===== -->
      <!-- Search Service -->
      <g transform="translate(410, 80)">
        <rect x="0" y="0" width="160" height="55" rx="10" fill="url(#gSearch)" filter="url(#shadow)"/>
        <text x="80" y="22" fill="white" font-size="12" font-weight="700" text-anchor="middle">Search Service</text>
        <text x="80" y="38" fill="rgba(255,255,255,0.8)" font-size="9" text-anchor="middle">Read Path / Geo + Text</text>
      </g>
      <!-- Booking Service -->
      <g transform="translate(410, 155)">
        <rect x="0" y="0" width="160" height="55" rx="10" fill="url(#gBooking)" filter="url(#shadow)"/>
        <text x="80" y="22" fill="white" font-size="12" font-weight="700" text-anchor="middle">Booking Service</text>
        <text x="80" y="38" fill="rgba(255,255,255,0.8)" font-size="9" text-anchor="middle">Write Path / ACID Txn</text>
      </g>
      <!-- Listing Service -->
      <g transform="translate(410, 230)">
        <rect x="0" y="0" width="160" height="55" rx="10" fill="url(#gListing)" filter="url(#shadow)"/>
        <text x="80" y="22" fill="white" font-size="12" font-weight="700" text-anchor="middle">Listing Service</text>
        <text x="80" y="38" fill="rgba(255,255,255,0.8)" font-size="9" text-anchor="middle">Catalog / CRUD</text>
      </g>
      <!-- Payment Service -->
      <g transform="translate(410, 305)">
        <rect x="0" y="0" width="160" height="55" rx="10" fill="url(#gPayment)" filter="url(#shadow)"/>
        <text x="80" y="22" fill="white" font-size="12" font-weight="700" text-anchor="middle">Payment Service</text>
        <text x="80" y="38" fill="rgba(255,255,255,0.8)" font-size="9" text-anchor="middle">Stripe / Adyen</text>
      </g>
      <!-- User Service -->
      <g transform="translate(410, 380)">
        <rect x="0" y="0" width="160" height="55" rx="10" fill="url(#gUser)" filter="url(#shadow)"/>
        <text x="80" y="22" fill="white" font-size="12" font-weight="700" text-anchor="middle">User Service</text>
        <text x="80" y="38" fill="rgba(255,255,255,0.8)" font-size="9" text-anchor="middle">Auth / Profile</text>
      </g>
      <!-- Pricing Service -->
      <g transform="translate(410, 455)">
        <rect x="0" y="0" width="160" height="55" rx="10" fill="url(#gPricing)" filter="url(#shadow)"/>
        <text x="80" y="22" fill="white" font-size="12" font-weight="700" text-anchor="middle">Pricing Service</text>
        <text x="80" y="38" fill="rgba(255,255,255,0.8)" font-size="9" text-anchor="middle">Rate Engine</text>
      </g>

      <!-- API GW to Services (solid lines) -->
      <line x1="350" y1="225" x2="408" y2="107" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arr)"/>
      <line x1="350" y1="225" x2="408" y2="182" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arr)"/>
      <line x1="350" y1="225" x2="408" y2="257" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arr)"/>
      <line x1="350" y1="225" x2="408" y2="332" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arr)"/>
      <line x1="350" y1="225" x2="408" y2="407" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arr)"/>
      <line x1="350" y1="225" x2="408" y2="482" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arr)"/>

      <!-- ===== DATA LAYER ===== -->
      <!-- Elasticsearch -->
      <g transform="translate(680, 70)">
        <rect x="0" y="0" width="140" height="55" rx="10" fill="#f8fafc" stroke="#00A699" stroke-width="1.5" filter="url(#shadow)"/>
        <!-- ES icon -->
        <circle cx="24" cy="28" r="9" fill="none" stroke="#00A699" stroke-width="1.2" opacity="0.4"/>
        <circle cx="24" cy="28" r="5" fill="none" stroke="#00A699" stroke-width="1.2" opacity="0.7"/>
        <circle cx="24" cy="28" r="2" fill="#00A699"/>
        <text x="82" y="23" fill="#00A699" font-size="11" font-weight="700" text-anchor="middle">Elasticsearch</text>
        <text x="82" y="39" fill="#64748b" font-size="9" text-anchor="middle">Search Index</text>
      </g>
      <!-- PostgreSQL - Bookings DB -->
      <g transform="translate(680, 145)">
        <rect x="0" y="0" width="140" height="55" rx="10" fill="#f8fafc" stroke="#428BF9" stroke-width="1.5" filter="url(#shadow)"/>
        <!-- PG cylinder -->
        <ellipse cx="24" cy="18" rx="10" ry="4" fill="#428BF9" opacity="0.8"/>
        <rect x="14" y="18" width="20" height="16" fill="#428BF9" opacity="0.3"/>
        <line x1="14" y1="18" x2="14" y2="34" stroke="#428BF9" stroke-width="1"/>
        <line x1="34" y1="18" x2="34" y2="34" stroke="#428BF9" stroke-width="1"/>
        <ellipse cx="24" cy="34" rx="10" ry="4" fill="#428BF9" opacity="0.6"/>
        <text x="82" y="23" fill="#428BF9" font-size="11" font-weight="700" text-anchor="middle">PostgreSQL</text>
        <text x="82" y="39" fill="#64748b" font-size="9" text-anchor="middle">Bookings DB</text>
      </g>
      <!-- PostgreSQL - Listings DB -->
      <g transform="translate(680, 220)">
        <rect x="0" y="0" width="140" height="55" rx="10" fill="#f8fafc" stroke="#428BF9" stroke-width="1.5" filter="url(#shadow)"/>
        <ellipse cx="24" cy="18" rx="10" ry="4" fill="#428BF9" opacity="0.8"/>
        <rect x="14" y="18" width="20" height="16" fill="#428BF9" opacity="0.3"/>
        <line x1="14" y1="18" x2="14" y2="34" stroke="#428BF9" stroke-width="1"/>
        <line x1="34" y1="18" x2="34" y2="34" stroke="#428BF9" stroke-width="1"/>
        <ellipse cx="24" cy="34" rx="10" ry="4" fill="#428BF9" opacity="0.6"/>
        <text x="82" y="23" fill="#428BF9" font-size="11" font-weight="700" text-anchor="middle">PostgreSQL</text>
        <text x="82" y="39" fill="#64748b" font-size="9" text-anchor="middle">Listings DB</text>
      </g>
      <!-- PostgreSQL - Users DB -->
      <g transform="translate(680, 370)">
        <rect x="0" y="0" width="140" height="55" rx="10" fill="#f8fafc" stroke="#428BF9" stroke-width="1.5" filter="url(#shadow)"/>
        <ellipse cx="24" cy="18" rx="10" ry="4" fill="#428BF9" opacity="0.8"/>
        <rect x="14" y="18" width="20" height="16" fill="#428BF9" opacity="0.3"/>
        <line x1="14" y1="18" x2="14" y2="34" stroke="#428BF9" stroke-width="1"/>
        <line x1="34" y1="18" x2="34" y2="34" stroke="#428BF9" stroke-width="1"/>
        <ellipse cx="24" cy="34" rx="10" ry="4" fill="#428BF9" opacity="0.6"/>
        <text x="82" y="23" fill="#428BF9" font-size="11" font-weight="700" text-anchor="middle">PostgreSQL</text>
        <text x="82" y="39" fill="#64748b" font-size="9" text-anchor="middle">Users DB</text>
      </g>
      <!-- Payment Gateway -->
      <g transform="translate(680, 295)">
        <rect x="0" y="0" width="140" height="55" rx="10" fill="#f8fafc" stroke="#f59e0b" stroke-width="1.5" filter="url(#shadow)"/>
        <!-- Cloud + Lock icon -->
        <path d="M14,30 Q8,30 8,24 Q8,18 16,18 Q16,12 24,12 Q32,12 32,18 Q40,18 40,24 Q40,30 34,30 Z" fill="none" stroke="#f59e0b" stroke-width="1" transform="scale(0.6) translate(8,12)"/>
        <text x="82" y="23" fill="#f59e0b" font-size="11" font-weight="700" text-anchor="middle">Payment GW</text>
        <text x="82" y="39" fill="#64748b" font-size="9" text-anchor="middle">External (Stripe)</text>
      </g>
      <!-- Redis Cluster -->
      <g transform="translate(860, 145)">
        <rect x="0" y="0" width="140" height="55" rx="10" fill="#f8fafc" stroke="#ef4444" stroke-width="1.5" filter="url(#shadow)"/>
        <!-- Redis diamond -->
        <polygon points="24,10 34,27 24,44 14,27" fill="none" stroke="#ef4444" stroke-width="1.5" transform="scale(0.55) translate(10,6)"/>
        <polygon points="24,16 30,27 24,38 18,27" fill="#ef4444" opacity="0.3" transform="scale(0.55) translate(10,6)"/>
        <text x="82" y="23" fill="#ef4444" font-size="11" font-weight="700" text-anchor="middle">Redis Cluster</text>
        <text x="82" y="39" fill="#64748b" font-size="9" text-anchor="middle">Cache + Rate Limit</text>
      </g>

      <!-- Service to Data connections (dashed lines) -->
      <!-- Search -> Elasticsearch -->
      <line x1="570" y1="107" x2="678" y2="97" stroke="#00A699" stroke-width="1.2" stroke-dasharray="6,3" marker-end="url(#arr)"/>
      <!-- Booking -> Bookings DB -->
      <line x1="570" y1="182" x2="678" y2="172" stroke="#428BF9" stroke-width="1.2" stroke-dasharray="6,3" marker-end="url(#arr)"/>
      <!-- Listing -> Listings DB -->
      <line x1="570" y1="257" x2="678" y2="247" stroke="#428BF9" stroke-width="1.2" stroke-dasharray="6,3" marker-end="url(#arr)"/>
      <!-- Payment -> Payment GW -->
      <line x1="570" y1="332" x2="678" y2="322" stroke="#f59e0b" stroke-width="1.2" stroke-dasharray="6,3" marker-end="url(#arr)"/>
      <!-- User -> Users DB -->
      <line x1="570" y1="407" x2="678" y2="397" stroke="#428BF9" stroke-width="1.2" stroke-dasharray="6,3" marker-end="url(#arr)"/>
      <!-- Services -> Redis -->
      <line x1="570" y1="155" x2="858" y2="167" stroke="#ef4444" stroke-width="1" stroke-dasharray="4,3" opacity="0.5"/>
      <line x1="570" y1="230" x2="858" y2="172" stroke="#ef4444" stroke-width="1" stroke-dasharray="4,3" opacity="0.5"/>

      <!-- ===== KAFKA EVENT BUS ===== -->
      <g transform="translate(60, 540)">
        <rect x="0" y="0" width="860" height="55" rx="10" fill="#f8fafc" stroke="#ef4444" stroke-width="1.5" filter="url(#shadow)"/>
        <!-- Kafka cluster nodes -->
        <circle cx="24" cy="18" r="5" fill="#ef4444" opacity="0.9"/>
        <circle cx="24" cy="38" r="5" fill="#ef4444" opacity="0.7"/>
        <circle cx="42" cy="28" r="5" fill="#ef4444" opacity="0.8"/>
        <line x1="29" y1="18" x2="37" y2="24" stroke="#ef4444" stroke-width="1.2" opacity="0.6"/>
        <line x1="29" y1="38" x2="37" y2="32" stroke="#ef4444" stroke-width="1.2" opacity="0.6"/>
        <text x="430" y="23" fill="#ef4444" font-size="13" font-weight="700" text-anchor="middle">Apache Kafka Event Bus</text>
        <text x="430" y="42" fill="#64748b" font-size="10" text-anchor="middle">booking.created | booking.confirmed | payment.captured | listing.updated</text>
      </g>

      <!-- Services to Kafka (dashed red) -->
      <line x1="490" y1="210" x2="490" y2="538" stroke="#ef4444" stroke-width="1.2" stroke-dasharray="5,3" marker-end="url(#arrRed)" opacity="0.6"/>
      <line x1="440" y1="285" x2="200" y2="538" stroke="#ef4444" stroke-width="1" stroke-dasharray="5,3" marker-end="url(#arrRed)" opacity="0.5"/>
      <line x1="540" y1="360" x2="700" y2="538" stroke="#ef4444" stroke-width="1" stroke-dasharray="5,3" marker-end="url(#arrRed)" opacity="0.5"/>
      <line x1="490" y1="435" x2="490" y2="538" stroke="#ef4444" stroke-width="0.8" stroke-dasharray="5,3" opacity="0.3"/>

      <!-- ===== DOWNSTREAM CONSUMERS ===== -->
      <text x="550" y="620" fill="#64748b" font-size="11" font-weight="700" letter-spacing="2" text-anchor="middle">DOWNSTREAM CONSUMERS</text>
      <!-- Notification -->
      <g transform="translate(60, 635)">
        <rect x="0" y="0" width="140" height="45" rx="8" fill="url(#gConsumer)" stroke="#94a3b8" stroke-width="1" filter="url(#shadow)"/>
        <text x="70" y="18" fill="#94a3b8" font-size="10" font-weight="700" text-anchor="middle">Notification</text>
        <text x="70" y="33" fill="rgba(255,255,255,0.4)" font-size="8" text-anchor="middle">Email / Push / SMS</text>
      </g>
      <!-- Calendar Sync -->
      <g transform="translate(220, 635)">
        <rect x="0" y="0" width="140" height="45" rx="8" fill="url(#gConsumer)" stroke="#94a3b8" stroke-width="1" filter="url(#shadow)"/>
        <text x="70" y="18" fill="#94a3b8" font-size="10" font-weight="700" text-anchor="middle">Calendar Sync</text>
        <text x="70" y="33" fill="rgba(255,255,255,0.4)" font-size="8" text-anchor="middle">iCal / Google</text>
      </g>
      <!-- Analytics -->
      <g transform="translate(380, 635)">
        <rect x="0" y="0" width="140" height="45" rx="8" fill="url(#gConsumer)" stroke="#94a3b8" stroke-width="1" filter="url(#shadow)"/>
        <text x="70" y="18" fill="#94a3b8" font-size="10" font-weight="700" text-anchor="middle">Analytics</text>
        <text x="70" y="33" fill="rgba(255,255,255,0.4)" font-size="8" text-anchor="middle">Pipeline / BI</text>
      </g>
      <!-- History Denorm -->
      <g transform="translate(540, 635)">
        <rect x="0" y="0" width="140" height="45" rx="8" fill="url(#gConsumer)" stroke="#94a3b8" stroke-width="1" filter="url(#shadow)"/>
        <text x="70" y="18" fill="#94a3b8" font-size="10" font-weight="700" text-anchor="middle">History Denorm</text>
        <text x="70" y="33" fill="rgba(255,255,255,0.4)" font-size="8" text-anchor="middle">Cassandra / Redis</text>
      </g>
      <!-- Fraud Detection -->
      <g transform="translate(700, 635)">
        <rect x="0" y="0" width="160" height="45" rx="8" fill="url(#gConsumer)" stroke="#94a3b8" stroke-width="1" filter="url(#shadow)"/>
        <text x="80" y="18" fill="#94a3b8" font-size="10" font-weight="700" text-anchor="middle">Fraud Detection</text>
        <text x="80" y="33" fill="rgba(255,255,255,0.4)" font-size="8" text-anchor="middle">ML Scoring / Rules</text>
      </g>

      <!-- Kafka to Consumers (dashed lines) -->
      <line x1="130" y1="595" x2="130" y2="633" stroke="#94a3b8" stroke-width="1.2" stroke-dasharray="4,3" marker-end="url(#arr)"/>
      <line x1="290" y1="595" x2="290" y2="633" stroke="#94a3b8" stroke-width="1.2" stroke-dasharray="4,3" marker-end="url(#arr)"/>
      <line x1="450" y1="595" x2="450" y2="633" stroke="#94a3b8" stroke-width="1.2" stroke-dasharray="4,3" marker-end="url(#arr)"/>
      <line x1="610" y1="595" x2="610" y2="633" stroke="#94a3b8" stroke-width="1.2" stroke-dasharray="4,3" marker-end="url(#arr)"/>
      <line x1="780" y1="595" x2="780" y2="633" stroke="#94a3b8" stroke-width="1.2" stroke-dasharray="4,3" marker-end="url(#arr)"/>

      <!-- ===== NUMBERED STEP CIRCLES ===== -->
      <!-- Step 1: Client -> CDN -->
      <circle cx="180" cy="92" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/>
      <text x="180" y="96" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">1</text>

      <!-- Step 2: CDN -> Load Balancer -->
      <circle cx="272" cy="119" r="10" fill="#f59e0b" stroke="#fff" stroke-width="1.5"/>
      <text x="272" y="123" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">2</text>

      <!-- Step 3: Load Balancer -> API Gateway -->
      <circle cx="272" cy="190" r="10" fill="#10b981" stroke="#fff" stroke-width="1.5"/>
      <text x="272" y="194" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">3</text>

      <!-- Step 4: API Gateway -> Search Service -->
      <circle cx="380" cy="160" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/>
      <text x="380" y="164" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">4</text>

      <!-- Step 5: Search Service -> Elasticsearch -->
      <circle cx="625" cy="100" r="10" fill="#00A699" stroke="#fff" stroke-width="1.5"/>
      <text x="625" y="104" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">5</text>

      <!-- Step 6: API Gateway -> Booking Service -->
      <circle cx="380" cy="200" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/>
      <text x="380" y="204" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">6</text>

      <!-- Step 7: Booking Service -> PostgreSQL -->
      <circle cx="625" cy="175" r="10" fill="#428BF9" stroke="#fff" stroke-width="1.5"/>
      <text x="625" y="179" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">7</text>

      <!-- Step 8: Booking Service -> Payment Service -->
      <circle cx="490" cy="280" r="10" fill="#00A699" stroke="#fff" stroke-width="1.5"/>
      <text x="490" y="284" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">8</text>

      <!-- Step 9: Payment Service -> Stripe/Payment GW -->
      <circle cx="625" cy="325" r="10" fill="#f59e0b" stroke="#fff" stroke-width="1.5"/>
      <text x="625" y="329" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">9</text>

      <!-- Step 10: Booking Service -> Kafka -->
      <circle cx="490" cy="490" r="10" fill="#ef4444" stroke="#fff" stroke-width="1.5"/>
      <text x="490" y="494" fill="#fff" font-size="9" font-weight="800" text-anchor="middle">10</text>

      <!-- Step 11: Kafka -> Notification Service -->
      <circle cx="130" cy="614" r="10" fill="#ef4444" stroke="#fff" stroke-width="1.5"/>
      <text x="130" y="618" fill="#fff" font-size="9" font-weight="800" text-anchor="middle">11</text>

      <!-- Step 12: Kafka -> Elasticsearch via CDC (Debezium) -->
      <circle cx="780" cy="614" r="10" fill="#ef4444" stroke="#fff" stroke-width="1.5"/>
      <text x="780" y="618" fill="#fff" font-size="9" font-weight="800" text-anchor="middle">12</text>

      <!-- ===== LEGEND ===== -->
      <g transform="translate(870, 440)">
        <rect x="0" y="0" width="180" height="90" rx="8" fill="#f1f5f9" stroke="#334155" stroke-width="1"/>
        <text x="90" y="18" fill="rgba(255,255,255,0.7)" font-size="10" font-weight="700" text-anchor="middle">LEGEND</text>
        <line x1="12" y1="30" x2="42" y2="30" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arr)"/>
        <text x="52" y="34" fill="#64748b" font-size="9">Sync request</text>
        <line x1="12" y1="48" x2="42" y2="48" stroke="#94a3b8" stroke-width="1.5" stroke-dasharray="5,3"/>
        <text x="52" y="52" fill="#64748b" font-size="9">Async / DB query</text>
        <line x1="12" y1="66" x2="42" y2="66" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="5,3"/>
        <text x="52" y="70" fill="#64748b" font-size="9">Event stream (Kafka)</text>
      </g>
    </svg>
  </div>

  <!-- ===== REQUEST FLOW REFERENCE ===== -->
  <h3>Request Flow Reference</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Step</th>
          <th>From &rarr; To</th>
          <th>Protocol</th>
          <th>What Happens</th>
          <th>Latency</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#FF5A5F;color:#fff;font-weight:800;font-size:11px;">1</span></td>
          <td>Client &rarr; CDN</td>
          <td><code>HTTPS</code></td>
          <td>Serve static assets (JS/CSS bundles, images) and cached search results from edge nodes</td>
          <td>~5-20 ms</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#f59e0b;color:#fff;font-weight:800;font-size:11px;">2</span></td>
          <td>CDN &rarr; Load Balancer</td>
          <td><code>HTTPS</code></td>
          <td>Cache miss forwarded to origin; LB distributes across API Gateway instances (round-robin / least-conn)</td>
          <td>~5-15 ms</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#10b981;color:#fff;font-weight:800;font-size:11px;">3</span></td>
          <td>Load Balancer &rarr; API Gateway</td>
          <td><code>HTTPS</code></td>
          <td>Authenticate request (JWT/OAuth2), enforce rate limits, route to correct microservice</td>
          <td>~5-10 ms</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#FF5A5F;color:#fff;font-weight:800;font-size:11px;">4</span></td>
          <td>API Gateway &rarr; Search Service</td>
          <td><code>gRPC</code></td>
          <td>Forward search query with geo coordinates, date range, filters (guests, price, amenities)</td>
          <td>~10-20 ms</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#00A699;color:#fff;font-weight:800;font-size:11px;">5</span></td>
          <td>Search Service &rarr; Elasticsearch</td>
          <td><code>HTTP</code></td>
          <td>Execute geo_distance + bool query with filters; return ranked listings with availability scores</td>
          <td>~15-50 ms</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#FF5A5F;color:#fff;font-weight:800;font-size:11px;">6</span></td>
          <td>API Gateway &rarr; Booking Service</td>
          <td><code>gRPC</code></td>
          <td>Create reservation: validate listing, check availability window, acquire lock on date range</td>
          <td>~10-25 ms</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#428BF9;color:#fff;font-weight:800;font-size:11px;">7</span></td>
          <td>Booking Service &rarr; PostgreSQL</td>
          <td><code>TCP</code></td>
          <td><code>SELECT FOR UPDATE</code> on availability rows + <code>INSERT</code> booking record in same transaction (pessimistic lock)</td>
          <td>~5-15 ms</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#00A699;color:#fff;font-weight:800;font-size:11px;">8</span></td>
          <td>Booking Service &rarr; Payment Service</td>
          <td><code>gRPC</code></td>
          <td>Authorize charge: validate amount, create hold on payment method, return authorization ID</td>
          <td>~15-30 ms</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#f59e0b;color:#fff;font-weight:800;font-size:11px;">9</span></td>
          <td>Payment Service &rarr; Stripe/Payment GW</td>
          <td><code>HTTPS</code></td>
          <td>Create payment intent with capture_method=manual (authorize only), validate card, return client_secret</td>
          <td>~200-500 ms</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#ef4444;color:#fff;font-weight:800;font-size:11px;">10</span></td>
          <td>Booking Service &rarr; Kafka</td>
          <td><code>TCP</code></td>
          <td>Emit <code>BookingConfirmed</code> event with booking ID, listing, dates, guest, payment ref; fan out to consumers</td>
          <td>~5-15 ms</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#ef4444;color:#fff;font-weight:800;font-size:11px;">11</span></td>
          <td>Kafka &rarr; Notification Service</td>
          <td><code>Consumer</code></td>
          <td>Send confirmation email to guest + host, push notification, calendar invite attachment</td>
          <td>~100-500 ms</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#ef4444;color:#fff;font-weight:800;font-size:11px;">12</span></td>
          <td>Kafka &rarr; Elasticsearch (CDC/Debezium)</td>
          <td><code>Debezium</code></td>
          <td>CDC captures booking INSERT &rarr; updates Elasticsearch availability index so search reflects booked dates</td>
          <td>~1-5 s (async)</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ===== HAPPY PATH ===== -->
  <h3>Happy Path: Booking Success Flow</h3>
  <div class="card" style="border-left: 3px solid var(--success);">
    <p style="margin-bottom:16px;">The complete success flow when a guest books a listing:</p>
    <div style="display:flex; flex-direction:column; gap:10px;">
      <div style="display:flex; align-items:center; gap:12px;">
        <span style="display:inline-flex;align-items:center;justify-content:center;min-width:26px;height:26px;border-radius:50%;background:#FF5A5F;color:#fff;font-weight:800;font-size:12px;">1</span>
        <span>Guest opens Airbnb &rarr; <strong>CDN</strong> serves React SPA bundle + cached homepage listings from edge</span>
      </div>
      <div style="display:flex; align-items:center; gap:12px;">
        <span style="display:inline-flex;align-items:center;justify-content:center;min-width:26px;height:26px;border-radius:50%;background:#f59e0b;color:#fff;font-weight:800;font-size:12px;">2</span>
        <span>Search request cache miss at CDN &rarr; forwarded to <strong>Load Balancer</strong> for origin resolution</span>
      </div>
      <div style="display:flex; align-items:center; gap:12px;">
        <span style="display:inline-flex;align-items:center;justify-content:center;min-width:26px;height:26px;border-radius:50%;background:#10b981;color:#fff;font-weight:800;font-size:12px;">3</span>
        <span>LB routes to <strong>API Gateway</strong> &rarr; JWT validated, rate limit passed, request authorized</span>
      </div>
      <div style="display:flex; align-items:center; gap:12px;">
        <span style="display:inline-flex;align-items:center;justify-content:center;min-width:26px;height:26px;border-radius:50%;background:#FF5A5F;color:#fff;font-weight:800;font-size:12px;">4</span>
        <span>API Gateway fans search query to <strong>Search Service</strong> via gRPC</span>
      </div>
      <div style="display:flex; align-items:center; gap:12px;">
        <span style="display:inline-flex;align-items:center;justify-content:center;min-width:26px;height:26px;border-radius:50%;background:#00A699;color:#fff;font-weight:800;font-size:12px;">5</span>
        <span>Search Service queries <strong>Elasticsearch</strong> with geo + date + filter &rarr; returns ranked listing results to user</span>
      </div>
      <div style="display:flex; align-items:center; gap:12px;">
        <span style="display:inline-flex;align-items:center;justify-content:center;min-width:26px;height:26px;border-radius:50%;background:#FF5A5F;color:#fff;font-weight:800;font-size:12px;">6</span>
        <span>Guest selects listing and clicks "Reserve" &rarr; API Gateway routes to <strong>Booking Service</strong></span>
      </div>
      <div style="display:flex; align-items:center; gap:12px;">
        <span style="display:inline-flex;align-items:center;justify-content:center;min-width:26px;height:26px;border-radius:50%;background:#428BF9;color:#fff;font-weight:800;font-size:12px;">7</span>
        <span>Booking Service runs <code>SELECT FOR UPDATE</code> + <code>INSERT</code> in <strong>PostgreSQL</strong> &rarr; dates locked, booking created</span>
      </div>
      <div style="display:flex; align-items:center; gap:12px;">
        <span style="display:inline-flex;align-items:center;justify-content:center;min-width:26px;height:26px;border-radius:50%;background:#00A699;color:#fff;font-weight:800;font-size:12px;">8</span>
        <span>Booking Service calls <strong>Payment Service</strong> to authorize the charge (hold on card)</span>
      </div>
      <div style="display:flex; align-items:center; gap:12px;">
        <span style="display:inline-flex;align-items:center;justify-content:center;min-width:26px;height:26px;border-radius:50%;background:#f59e0b;color:#fff;font-weight:800;font-size:12px;">9</span>
        <span>Payment Service calls <strong>Stripe</strong> &rarr; payment authorized, hold placed &rarr; booking status = <code>CONFIRMED</code></span>
      </div>
      <div style="display:flex; align-items:center; gap:12px;">
        <span style="display:inline-flex;align-items:center;justify-content:center;min-width:26px;height:26px;border-radius:50%;background:#ef4444;color:#fff;font-weight:800;font-size:12px;">10</span>
        <span>Booking Service emits <code>BookingConfirmed</code> event to <strong>Kafka</strong> &rarr; fans out to all downstream consumers</span>
      </div>
      <div style="display:flex; align-items:center; gap:12px;">
        <span style="display:inline-flex;align-items:center;justify-content:center;min-width:26px;height:26px;border-radius:50%;background:#ef4444;color:#fff;font-weight:800;font-size:12px;">11</span>
        <span><strong>Notification Service</strong> sends confirmation email to guest + host with booking details and calendar invite</span>
      </div>
      <div style="display:flex; align-items:center; gap:12px;">
        <span style="display:inline-flex;align-items:center;justify-content:center;min-width:26px;height:26px;border-radius:50%;background:#ef4444;color:#fff;font-weight:800;font-size:12px;">12</span>
        <span><strong>Debezium CDC</strong> captures booking in PG WAL &rarr; updates <strong>Elasticsearch</strong> availability index so booked dates disappear from search</span>
      </div>
    </div>
    <p style="margin-top:16px; color:var(--success); font-weight:600;">Result: Guest sees confirmation page, both guest and host receive emails, dates blocked in search within seconds.</p>
  </div>

  <!-- ===== FAILURE PATHS ===== -->
  <h3>Failure Paths</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Fails At</th>
          <th>Failure Scenario</th>
          <th>Impact</th>
          <th>Recovery Strategy</th>
          <th>User Sees</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#FF5A5F;color:#fff;font-weight:800;font-size:11px;">1</span> CDN</td>
          <td>CDN edge node failure or cache corruption</td>
          <td>Static assets fail to load or stale search results served</td>
          <td>CDN auto-failover to next PoP; cache purge + revalidation; fallback to origin server</td>
          <td>Slow page load or brief white screen; auto-recovers on refresh</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#00A699;color:#fff;font-weight:800;font-size:11px;">5</span> Elasticsearch</td>
          <td>ES cluster down or degraded (red/yellow status)</td>
          <td>Search unavailable or slow; no listings shown</td>
          <td>Fallback to PostgreSQL read replica with simplified geo query (degraded but functional); circuit breaker on ES</td>
          <td>"Fewer results available" banner; slower search response (~500ms vs ~50ms)</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#428BF9;color:#fff;font-weight:800;font-size:11px;">7</span> PostgreSQL (Race)</td>
          <td>Two guests book same dates simultaneously (race condition)</td>
          <td>One booking must fail; <code>SELECT FOR UPDATE</code> serializes access</td>
          <td>Pessimistic locking ensures only one wins; loser gets HTTP 409 Conflict; client retries with new dates suggestion</td>
          <td>"These dates were just booked. Try nearby dates." with alternative suggestions</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#428BF9;color:#fff;font-weight:800;font-size:11px;">7</span> PostgreSQL (Down)</td>
          <td>Primary DB down or connection pool exhausted</td>
          <td>All write operations fail; bookings cannot be created</td>
          <td>Automatic failover to standby (Patroni/pg_auto_failover, ~10s); connection pool drains and reconnects</td>
          <td>"Booking temporarily unavailable. Please try again in a moment."</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#f59e0b;color:#fff;font-weight:800;font-size:11px;">9</span> Payment Declined</td>
          <td>Card declined by issuing bank or insufficient funds</td>
          <td>Booking cannot be confirmed; dates must be released</td>
          <td>Rollback: release date lock (compensating transaction), mark booking as FAILED, prompt user to retry with different card</td>
          <td>"Payment declined. Please use a different payment method." with retry option</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#f59e0b;color:#fff;font-weight:800;font-size:11px;">9</span> Stripe Down</td>
          <td>Stripe API returns 503 or times out</td>
          <td>Payment authorization fails; booking in limbo</td>
          <td>Hold booking for 10 min with status PENDING_PAYMENT; retry Stripe with exponential backoff; release dates if all retries fail</td>
          <td>"Processing your payment..." (loading state) then either success or "Payment service unavailable, dates held for 10 minutes"</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#ef4444;color:#fff;font-weight:800;font-size:11px;">10</span> Kafka</td>
          <td>Kafka broker down or producer timeout</td>
          <td>Event not published; downstream consumers unaware of booking</td>
          <td>Transactional outbox pattern: booking + event stored in same DB transaction; separate relay publishes to Kafka; at-least-once delivery guaranteed</td>
          <td>No immediate user impact; booking is confirmed. Notifications delayed.</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#ef4444;color:#fff;font-weight:800;font-size:11px;">11</span> Notifications</td>
          <td>Kafka consumer lag or email provider failure</td>
          <td>Guest/host does not receive confirmation email or push</td>
          <td>Kafka retry from last offset; fallback email provider (SES &rarr; SendGrid); DLQ for manual review; user can view booking in-app</td>
          <td>No email received, but booking visible in "My Trips" immediately</td>
        </tr>
        <tr>
          <td><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#ef4444;color:#fff;font-weight:800;font-size:11px;">12</span> CDC / Debezium</td>
          <td>Debezium connector lag or Elasticsearch indexing failure</td>
          <td>Search index stale: booked dates still appear available in search results</td>
          <td>Booking Service double-checks availability at write time (source of truth is PG); stale reads cause failed booking attempts (safe). Debezium auto-reconnects; manual reindex as fallback</td>
          <td>Guest may see "available" listing that fails at booking step with "Dates no longer available"</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h3>CQRS Pattern: Separating Reads and Writes</h3>
  <div class="compare-grid">
    <div class="compare-card opt-a">
      <h4 style="color:var(--blue);">Command Side (Writes)</h4>
      <ul>
        <li><strong>Booking Service</strong> owns all mutations: create, update, cancel</li>
        <li>Writes to <strong>PostgreSQL</strong> (strong consistency, ACID transactions)</li>
        <li>Publishes domain events to Kafka after commit</li>
        <li>Uses <code>SELECT FOR UPDATE</code> for availability checks</li>
        <li>Validates idempotency keys before processing</li>
      </ul>
    </div>
    <div class="compare-card opt-b">
      <h4 style="color:var(--secondary);">Query Side (Reads)</h4>
      <ul>
        <li><strong>Search Service</strong> reads from Elasticsearch (geo + text)</li>
        <li><strong>History Service</strong> reads from denormalized store (Cassandra/Redis)</li>
        <li>Materialized views updated via Kafka consumers</li>
        <li>Eventually consistent (lag &lt; 2 seconds typical)</li>
        <li>Independently scalable -- add read replicas as needed</li>
      </ul>
    </div>
  </div>

  <div class="tip-box tip">
    <strong>&#128161; PE Insight: Why CQRS Here?</strong>
    The read:write ratio is ~33:1. Search and history reads have fundamentally different data shapes (denormalized, ranked) than the normalized write model. CQRS lets us optimize each independently: PostgreSQL for ACID writes, Elasticsearch for search, Cassandra for time-series history. The trade-off is eventual consistency on the read side (acceptable for search results, not for availability checks which hit the write DB directly).
  </div>
</section>

<!-- ================================================================== -->
<!-- SECTION 5: API DESIGN                                               -->
<!-- ================================================================== -->
<section id="api">
  <h2>
    <span class="section-icon" style="background:rgba(252,100,45,0.15); color:var(--accent);">&#128279;</span>
    API Design
  </h2>

  <h3>1. Search Listings</h3>
<pre><code><span class="comment">// GET /api/v1/search/listings</span>
<span class="comment">// Query Parameters (simplified to JSON for clarity)</span>

<span class="keyword">Request:</span>
{
  <span class="string">"location"</span>: {
    <span class="string">"lat"</span>: <span class="number">37.7749</span>,
    <span class="string">"lng"</span>: <span class="number">-122.4194</span>,
    <span class="string">"radius_km"</span>: <span class="number">25</span>
  },
  <span class="string">"check_in"</span>:  <span class="string">"2025-07-01"</span>,
  <span class="string">"check_out"</span>: <span class="string">"2025-07-05"</span>,
  <span class="string">"guests"</span>:    <span class="number">2</span>,
  <span class="string">"filters"</span>: {
    <span class="string">"price_min"</span>: <span class="number">50</span>,
    <span class="string">"price_max"</span>: <span class="number">300</span>,
    <span class="string">"property_type"</span>: [<span class="string">"entire_home"</span>, <span class="string">"private_room"</span>],
    <span class="string">"amenities"</span>: [<span class="string">"wifi"</span>, <span class="string">"pool"</span>],
    <span class="string">"superhost"</span>: <span class="keyword">true</span>,
    <span class="string">"instant_book"</span>: <span class="keyword">true</span>
  },
  <span class="string">"sort"</span>: <span class="string">"relevance"</span>,
  <span class="string">"page"</span>: <span class="number">1</span>,
  <span class="string">"page_size"</span>: <span class="number">20</span>
}

<span class="keyword">Response:</span> <span class="number">200 OK</span>
{
  <span class="string">"results"</span>: [
    {
      <span class="string">"listing_id"</span>: <span class="string">"lst_abc123"</span>,
      <span class="string">"title"</span>: <span class="string">"Sunny Loft in SOMA"</span>,
      <span class="string">"host"</span>: { <span class="string">"name"</span>: <span class="string">"Alice"</span>, <span class="string">"is_superhost"</span>: <span class="keyword">true</span>, <span class="string">"avatar_url"</span>: <span class="string">"..."</span> },
      <span class="string">"location"</span>: { <span class="string">"lat"</span>: <span class="number">37.78</span>, <span class="string">"lng"</span>: <span class="number">-122.41</span>, <span class="string">"city"</span>: <span class="string">"San Francisco"</span> },
      <span class="string">"price"</span>: { <span class="string">"nightly"</span>: <span class="number">149</span>, <span class="string">"total"</span>: <span class="number">695</span>, <span class="string">"currency"</span>: <span class="string">"USD"</span> },
      <span class="string">"rating"</span>: <span class="number">4.92</span>,
      <span class="string">"review_count"</span>: <span class="number">287</span>,
      <span class="string">"thumbnail_url"</span>: <span class="string">"https://cdn.airbnb.com/..."</span>,
      <span class="string">"instant_book"</span>: <span class="keyword">true</span>
    }
  ],
  <span class="string">"pagination"</span>: { <span class="string">"page"</span>: <span class="number">1</span>, <span class="string">"page_size"</span>: <span class="number">20</span>, <span class="string">"total_results"</span>: <span class="number">342</span> },
  <span class="string">"search_id"</span>: <span class="string">"srch_xyz789"</span>  <span class="comment">// for analytics attribution</span>
}
</code></pre>

  <h3>2. Create Booking</h3>
<pre><code><span class="comment">// POST /api/v1/bookings</span>

<span class="keyword">Request:</span>
{
  <span class="string">"idempotency_key"</span>: <span class="string">"550e8400-e29b-41d4-a716-446655440000"</span>,
  <span class="string">"listing_id"</span>:      <span class="string">"lst_abc123"</span>,
  <span class="string">"check_in"</span>:        <span class="string">"2025-07-01"</span>,
  <span class="string">"check_out"</span>:       <span class="string">"2025-07-05"</span>,
  <span class="string">"guests"</span>:          <span class="number">2</span>,
  <span class="string">"special_requests"</span>: <span class="string">"Late check-in around 10pm"</span>,
  <span class="string">"payment_method_id"</span>: <span class="string">"pm_stripe_xyz"</span>,
  <span class="string">"currency"</span>:        <span class="string">"USD"</span>
}

<span class="keyword">Response:</span> <span class="number">201 Created</span>
{
  <span class="string">"booking_id"</span>:    <span class="string">"bk_def456"</span>,
  <span class="string">"status"</span>:        <span class="string">"PENDING"</span>,
  <span class="string">"listing_id"</span>:    <span class="string">"lst_abc123"</span>,
  <span class="string">"check_in"</span>:      <span class="string">"2025-07-01"</span>,
  <span class="string">"check_out"</span>:     <span class="string">"2025-07-05"</span>,
  <span class="string">"nights"</span>:        <span class="number">4</span>,
  <span class="string">"price_breakdown"</span>: {
    <span class="string">"nightly_rates"</span>:  [<span class="number">149</span>, <span class="number">149</span>, <span class="number">179</span>, <span class="number">179</span>],
    <span class="string">"subtotal"</span>:       <span class="number">656</span>,
    <span class="string">"cleaning_fee"</span>:   <span class="number">75</span>,
    <span class="string">"service_fee"</span>:    <span class="number">104</span>,
    <span class="string">"occupancy_tax"</span>:  <span class="number">97</span>,
    <span class="string">"total"</span>:          <span class="number">932</span>,
    <span class="string">"currency"</span>:       <span class="string">"USD"</span>
  },
  <span class="string">"payment_status"</span>: <span class="string">"AUTHORIZED"</span>,
  <span class="string">"created_at"</span>:     <span class="string">"2025-06-15T14:30:00Z"</span>
}
</code></pre>

  <h3>3. Booking History</h3>
<pre><code><span class="comment">// GET /api/v1/users/{user_id}/bookings?status=upcoming&page=1&page_size=10</span>

<span class="keyword">Response:</span> <span class="number">200 OK</span>
{
  <span class="string">"bookings"</span>: [
    {
      <span class="string">"booking_id"</span>: <span class="string">"bk_def456"</span>,
      <span class="string">"status"</span>:     <span class="string">"CONFIRMED"</span>,
      <span class="string">"listing"</span>: {
        <span class="string">"id"</span>: <span class="string">"lst_abc123"</span>,
        <span class="string">"title"</span>: <span class="string">"Sunny Loft in SOMA"</span>,
        <span class="string">"thumbnail"</span>: <span class="string">"https://cdn.airbnb.com/..."</span>,
        <span class="string">"city"</span>: <span class="string">"San Francisco"</span>
      },
      <span class="string">"check_in"</span>:   <span class="string">"2025-07-01"</span>,
      <span class="string">"check_out"</span>:  <span class="string">"2025-07-05"</span>,
      <span class="string">"total_price"</span>: <span class="number">932</span>,
      <span class="string">"currency"</span>:   <span class="string">"USD"</span>
    }
  ],
  <span class="string">"pagination"</span>: { <span class="string">"page"</span>: <span class="number">1</span>, <span class="string">"total_pages"</span>: <span class="number">3</span> }
}
</code></pre>

  <h3>4. Update Booking</h3>
<pre><code><span class="comment">// PATCH /api/v1/bookings/{booking_id}</span>

<span class="keyword">Request:</span>
{
  <span class="string">"idempotency_key"</span>: <span class="string">"660e8400-e29b-41d4-a716-446655440001"</span>,
  <span class="string">"check_in"</span>:  <span class="string">"2025-07-02"</span>,   <span class="comment">// shifting one day later</span>
  <span class="string">"check_out"</span>: <span class="string">"2025-07-06"</span>,
  <span class="string">"guests"</span>:    <span class="number">3</span>
}

<span class="keyword">Response:</span> <span class="number">200 OK</span>
{
  <span class="string">"booking_id"</span>:     <span class="string">"bk_def456"</span>,
  <span class="string">"status"</span>:         <span class="string">"CONFIRMED"</span>,
  <span class="string">"previous_total"</span>: <span class="number">932</span>,
  <span class="string">"new_total"</span>:      <span class="number">978</span>,
  <span class="string">"difference"</span>:     <span class="number">46</span>,
  <span class="string">"payment_action"</span>: <span class="string">"ADDITIONAL_CHARGE"</span>
}
</code></pre>

  <h3>5. Cancel Booking</h3>
<pre><code><span class="comment">// POST /api/v1/bookings/{booking_id}/cancel</span>

<span class="keyword">Request:</span>
{
  <span class="string">"idempotency_key"</span>: <span class="string">"770e8400-e29b-41d4-a716-446655440002"</span>,
  <span class="string">"reason"</span>: <span class="string">"change_of_plans"</span>
}

<span class="keyword">Response:</span> <span class="number">200 OK</span>
{
  <span class="string">"booking_id"</span>:        <span class="string">"bk_def456"</span>,
  <span class="string">"status"</span>:            <span class="string">"CANCELLED"</span>,
  <span class="string">"cancellation_policy"</span>: <span class="string">"MODERATE"</span>,
  <span class="string">"refund"</span>: {
    <span class="string">"amount"</span>:    <span class="number">832</span>,
    <span class="string">"penalty"</span>:   <span class="number">100</span>,
    <span class="string">"currency"</span>:  <span class="string">"USD"</span>,
    <span class="string">"method"</span>:    <span class="string">"original_payment"</span>,
    <span class="string">"eta_days"</span>:  <span class="number">5</span>
  }
}
</code></pre>
</section>

<!-- ================================================================== -->
<!-- SECTION 6: DATA MODEL                                               -->
<!-- ================================================================== -->
<section id="data-model">
  <h2>
    <span class="section-icon" style="background:rgba(245,158,11,0.15); color:var(--warning);">&#128451;&#65039;</span>
    Data Model
  </h2>

  <p>The relational schema uses PostgreSQL for ACID guarantees on the booking path. Each table is designed for the specific access patterns of the booking system, with carefully chosen indexes to support both OLTP workloads and the availability check hot path.</p>

  <div class="er-grid">
    <!-- Users Table -->
    <div class="er-table">
      <div class="er-header" style="color:var(--primary);">&#128100; users</div>
      <div class="er-row"><span class="er-col er-pk">id</span><span class="er-type">UUID PK</span></div>
      <div class="er-row"><span class="er-col">email</span><span class="er-type">VARCHAR(255) UNIQUE</span></div>
      <div class="er-row"><span class="er-col">full_name</span><span class="er-type">VARCHAR(200)</span></div>
      <div class="er-row"><span class="er-col">phone</span><span class="er-type">VARCHAR(20)</span></div>
      <div class="er-row"><span class="er-col">avatar_url</span><span class="er-type">TEXT</span></div>
      <div class="er-row"><span class="er-col">is_superhost</span><span class="er-type">BOOLEAN DEFAULT false</span></div>
      <div class="er-row"><span class="er-col">identity_verified</span><span class="er-type">BOOLEAN DEFAULT false</span></div>
      <div class="er-row"><span class="er-col">preferred_currency</span><span class="er-type">CHAR(3) DEFAULT 'USD'</span></div>
      <div class="er-row"><span class="er-col">created_at</span><span class="er-type">TIMESTAMPTZ</span></div>
      <div class="er-row"><span class="er-col">updated_at</span><span class="er-type">TIMESTAMPTZ</span></div>
    </div>

    <!-- Listings Table -->
    <div class="er-table">
      <div class="er-header" style="color:var(--secondary);">&#127968; listings</div>
      <div class="er-row"><span class="er-col er-pk">id</span><span class="er-type">UUID PK</span></div>
      <div class="er-row"><span class="er-col er-fk">host_id</span><span class="er-type">UUID FK &rarr; users</span></div>
      <div class="er-row"><span class="er-col">title</span><span class="er-type">VARCHAR(200)</span></div>
      <div class="er-row"><span class="er-col">description</span><span class="er-type">TEXT</span></div>
      <div class="er-row"><span class="er-col">property_type</span><span class="er-type">ENUM(entire_home, private_room, shared_room)</span></div>
      <div class="er-row"><span class="er-col">latitude</span><span class="er-type">DECIMAL(10,7)</span></div>
      <div class="er-row"><span class="er-col">longitude</span><span class="er-type">DECIMAL(10,7)</span></div>
      <div class="er-row"><span class="er-col">city</span><span class="er-type">VARCHAR(100)</span></div>
      <div class="er-row"><span class="er-col">country</span><span class="er-type">CHAR(2)</span></div>
      <div class="er-row"><span class="er-col">max_guests</span><span class="er-type">SMALLINT</span></div>
      <div class="er-row"><span class="er-col">bedrooms</span><span class="er-type">SMALLINT</span></div>
      <div class="er-row"><span class="er-col">base_price_cents</span><span class="er-type">INTEGER</span></div>
      <div class="er-row"><span class="er-col">cleaning_fee_cents</span><span class="er-type">INTEGER</span></div>
      <div class="er-row"><span class="er-col">currency</span><span class="er-type">CHAR(3)</span></div>
      <div class="er-row"><span class="er-col">min_nights</span><span class="er-type">SMALLINT DEFAULT 1</span></div>
      <div class="er-row"><span class="er-col">max_nights</span><span class="er-type">SMALLINT DEFAULT 365</span></div>
      <div class="er-row"><span class="er-col">instant_book</span><span class="er-type">BOOLEAN</span></div>
      <div class="er-row"><span class="er-col">cancellation_policy</span><span class="er-type">ENUM(flexible, moderate, strict, super_strict)</span></div>
      <div class="er-row"><span class="er-col">amenities</span><span class="er-type">TEXT[]</span></div>
      <div class="er-row"><span class="er-col">status</span><span class="er-type">ENUM(active, inactive, delisted)</span></div>
      <div class="er-row"><span class="er-col">avg_rating</span><span class="er-type">DECIMAL(3,2)</span></div>
      <div class="er-row"><span class="er-col">review_count</span><span class="er-type">INTEGER DEFAULT 0</span></div>
      <div class="er-row"><span class="er-col">created_at</span><span class="er-type">TIMESTAMPTZ</span></div>
    </div>

    <!-- Availability Table -->
    <div class="er-table">
      <div class="er-header" style="color:var(--blue);">&#128197; availability</div>
      <div class="er-row"><span class="er-col er-pk">id</span><span class="er-type">BIGSERIAL PK</span></div>
      <div class="er-row"><span class="er-col er-fk">listing_id</span><span class="er-type">UUID FK &rarr; listings</span></div>
      <div class="er-row"><span class="er-col">date</span><span class="er-type">DATE</span></div>
      <div class="er-row"><span class="er-col">is_available</span><span class="er-type">BOOLEAN DEFAULT true</span></div>
      <div class="er-row"><span class="er-col">price_cents</span><span class="er-type">INTEGER</span></div>
      <div class="er-row"><span class="er-col">min_nights</span><span class="er-type">SMALLINT</span></div>
      <div class="er-row"><span class="er-col">booking_id</span><span class="er-type">UUID FK &rarr; bookings (nullable)</span></div>
      <div class="er-row"><span class="er-col">version</span><span class="er-type">INTEGER DEFAULT 0</span></div>
    </div>

    <!-- Bookings Table -->
    <div class="er-table">
      <div class="er-header" style="color:var(--accent);">&#128221; bookings</div>
      <div class="er-row"><span class="er-col er-pk">id</span><span class="er-type">UUID PK</span></div>
      <div class="er-row"><span class="er-col er-fk">guest_id</span><span class="er-type">UUID FK &rarr; users</span></div>
      <div class="er-row"><span class="er-col er-fk">listing_id</span><span class="er-type">UUID FK &rarr; listings</span></div>
      <div class="er-row"><span class="er-col er-fk">host_id</span><span class="er-type">UUID FK &rarr; users</span></div>
      <div class="er-row"><span class="er-col">check_in</span><span class="er-type">DATE</span></div>
      <div class="er-row"><span class="er-col">check_out</span><span class="er-type">DATE</span></div>
      <div class="er-row"><span class="er-col">guests</span><span class="er-type">SMALLINT</span></div>
      <div class="er-row"><span class="er-col">status</span><span class="er-type">ENUM(pending, confirmed, active, completed, cancelled)</span></div>
      <div class="er-row"><span class="er-col">subtotal_cents</span><span class="er-type">INTEGER</span></div>
      <div class="er-row"><span class="er-col">cleaning_fee_cents</span><span class="er-type">INTEGER</span></div>
      <div class="er-row"><span class="er-col">service_fee_cents</span><span class="er-type">INTEGER</span></div>
      <div class="er-row"><span class="er-col">tax_cents</span><span class="er-type">INTEGER</span></div>
      <div class="er-row"><span class="er-col">total_cents</span><span class="er-type">INTEGER</span></div>
      <div class="er-row"><span class="er-col">currency</span><span class="er-type">CHAR(3)</span></div>
      <div class="er-row"><span class="er-col">special_requests</span><span class="er-type">TEXT</span></div>
      <div class="er-row"><span class="er-col">idempotency_key</span><span class="er-type">UUID UNIQUE</span></div>
      <div class="er-row"><span class="er-col">cancellation_policy</span><span class="er-type">ENUM</span></div>
      <div class="er-row"><span class="er-col">cancelled_at</span><span class="er-type">TIMESTAMPTZ</span></div>
      <div class="er-row"><span class="er-col">cancelled_by</span><span class="er-type">ENUM(guest, host, system)</span></div>
      <div class="er-row"><span class="er-col">created_at</span><span class="er-type">TIMESTAMPTZ</span></div>
      <div class="er-row"><span class="er-col">updated_at</span><span class="er-type">TIMESTAMPTZ</span></div>
    </div>

    <!-- Payments Table -->
    <div class="er-table">
      <div class="er-header" style="color:var(--purple);">&#128179; payments</div>
      <div class="er-row"><span class="er-col er-pk">id</span><span class="er-type">UUID PK</span></div>
      <div class="er-row"><span class="er-col er-fk">booking_id</span><span class="er-type">UUID FK &rarr; bookings</span></div>
      <div class="er-row"><span class="er-col er-fk">payer_id</span><span class="er-type">UUID FK &rarr; users</span></div>
      <div class="er-row"><span class="er-col">type</span><span class="er-type">ENUM(charge, refund, payout)</span></div>
      <div class="er-row"><span class="er-col">amount_cents</span><span class="er-type">INTEGER</span></div>
      <div class="er-row"><span class="er-col">currency</span><span class="er-type">CHAR(3)</span></div>
      <div class="er-row"><span class="er-col">status</span><span class="er-type">ENUM(pending, authorized, captured, failed, refunded)</span></div>
      <div class="er-row"><span class="er-col">provider</span><span class="er-type">VARCHAR(50)</span></div>
      <div class="er-row"><span class="er-col">provider_txn_id</span><span class="er-type">VARCHAR(255)</span></div>
      <div class="er-row"><span class="er-col">idempotency_key</span><span class="er-type">UUID UNIQUE</span></div>
      <div class="er-row"><span class="er-col">created_at</span><span class="er-type">TIMESTAMPTZ</span></div>
    </div>
  </div>

  <h3>Key Indexes</h3>
<pre><code><span class="comment">-- Availability hot-path: check if dates are available for a listing</span>
<span class="keyword">CREATE UNIQUE INDEX</span> idx_availability_listing_date
  <span class="keyword">ON</span> availability (listing_id, date);

<span class="comment">-- Booking history: guest's trips sorted by date</span>
<span class="keyword">CREATE INDEX</span> idx_bookings_guest_checkin
  <span class="keyword">ON</span> bookings (guest_id, check_in <span class="keyword">DESC</span>);

<span class="comment">-- Booking history: host's reservations sorted by date</span>
<span class="keyword">CREATE INDEX</span> idx_bookings_host_checkin
  <span class="keyword">ON</span> bookings (host_id, check_in <span class="keyword">DESC</span>);

<span class="comment">-- Idempotency: fast lookup by idempotency key</span>
<span class="keyword">CREATE UNIQUE INDEX</span> idx_bookings_idempotency
  <span class="keyword">ON</span> bookings (idempotency_key);

<span class="comment">-- Listing search by location (PostGIS extension)</span>
<span class="keyword">CREATE INDEX</span> idx_listings_geo
  <span class="keyword">ON</span> listings <span class="keyword">USING</span> GIST (
    ST_MakePoint(longitude, latitude)::geography
  );

<span class="comment">-- Payments by booking (for refund lookups)</span>
<span class="keyword">CREATE INDEX</span> idx_payments_booking
  <span class="keyword">ON</span> payments (booking_id, type);
</code></pre>

  <div class="tip-box purple">
    <strong>&#128161; PE Insight: Availability Table Design</strong>
    The <code>availability</code> table uses one row per listing per date (day-level granularity). This enables <code>SELECT FOR UPDATE WHERE listing_id = ? AND date BETWEEN ? AND ? AND is_available = true</code> as the atomic availability check. The <code>version</code> column supports optimistic locking as an alternative. The UNIQUE constraint on <code>(listing_id, date)</code> serves as a database-level guard against double-booking even if application logic has bugs.
  </div>
</section>

<!-- ================================================================== -->
<!-- SECTION 7: BOOKING FLOW                                             -->
<!-- ================================================================== -->
<section id="booking-flow">
  <h2>
    <span class="section-icon" style="background:rgba(16,185,129,0.15); color:var(--success);">&#128260;</span>
    Booking Flow &amp; State Machine
  </h2>

  <h3>Booking State Machine</h3>
  <div class="flow-steps">
    <div class="flow-step" style="border-color:var(--warning); color:var(--warning);">
      <span class="step-label">Initial</span>
      PENDING
    </div>
    <span class="flow-arrow">&#8594;</span>
    <div class="flow-step" style="border-color:var(--blue); color:var(--blue);">
      <span class="step-label">Payment OK</span>
      CONFIRMED
    </div>
    <span class="flow-arrow">&#8594;</span>
    <div class="flow-step" style="border-color:var(--secondary); color:var(--secondary);">
      <span class="step-label">Check-in Date</span>
      ACTIVE
    </div>
    <span class="flow-arrow">&#8594;</span>
    <div class="flow-step" style="border-color:var(--success); color:var(--success);">
      <span class="step-label">Check-out Date</span>
      COMPLETED
    </div>
  </div>
  <div class="flow-steps" style="margin-top:10px;">
    <div class="flow-step" style="border-color:var(--text-muted); color:var(--text-muted);">
      <span class="step-label">Any State</span>
      PENDING / CONFIRMED / ACTIVE
    </div>
    <span class="flow-arrow" style="color:var(--danger);">&#8594;</span>
    <div class="flow-step" style="border-color:var(--danger); color:var(--danger);">
      <span class="step-label">Cancellation</span>
      CANCELLED
    </div>
  </div>

  <h3>Happy Path: Create Booking Sequence</h3>
  <div class="diagram">
Guest App          API Gateway        Booking Svc       PostgreSQL         Payment Svc       Kafka
   |                    |                  |                 |                  |               |
   |--- POST /bookings -&gt;                 |                 |                  |               |
   |                    |--- validate ----&gt;|                 |                  |               |
   |                    |                  |                 |                  |               |
   |                    |                  |-- BEGIN TXN ---&gt;|                  |               |
   |                    |                  |                 |                  |               |
   |                    |                  |-- SELECT FOR ---|                  |               |
   |                    |                  |   UPDATE avail  |                  |               |
   |                    |                  |&lt;-- rows locked --|                  |               |
   |                    |                  |                 |                  |               |
   |                    |                  |-- Check: all    |                  |               |
   |                    |                  |   dates avail?  |                  |               |
   |                    |                  |   YES           |                  |               |
   |                    |                  |                 |                  |               |
   |                    |                  |-- INSERT booking|                  |               |
   |                    |                  |-- UPDATE avail  |                  |               |
   |                    |                  |   is_available  |                  |               |
   |                    |                  |   = false       |                  |               |
   |                    |                  |                 |                  |               |
   |                    |                  |-- COMMIT ------&gt;|                  |               |
   |                    |                  |                 |                  |               |
   |                    |                  |--- authorize payment -------------&gt;|               |
   |                    |                  |&lt;-- payment_authorized -------------|               |
   |                    |                  |                 |                  |               |
   |                    |                  |-- UPDATE booking|                  |               |
   |                    |                  |   status=       |                  |               |
   |                    |                  |   CONFIRMED     |                  |               |
   |                    |                  |                 |                  |               |
   |                    |                  |--- publish booking.confirmed -----&gt;|               |
   |                    |                  |                 |                  |      (fanout) |
   |&lt;-- 201 Created ----|&lt;--- response ---|                 |                  |               |
   |                    |                  |                 |                  |               |
  </div>

  <h3>Double-Booking Prevention: Three Approaches</h3>

  <div class="card" style="border-left: 3px solid var(--primary);">
    <h4 style="color:var(--primary);">Approach 1: Pessimistic Locking (SELECT FOR UPDATE)</h4>
<pre><code><span class="keyword">BEGIN</span>;

<span class="comment">-- Lock availability rows for the requested date range</span>
<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> availability
<span class="keyword">WHERE</span> listing_id = <span class="string">'lst_abc123'</span>
  <span class="keyword">AND</span> date <span class="keyword">BETWEEN</span> <span class="string">'2025-07-01'</span> <span class="keyword">AND</span> <span class="string">'2025-07-04'</span>
  <span class="keyword">AND</span> is_available = <span class="keyword">true</span>
<span class="keyword">FOR UPDATE</span>;

<span class="comment">-- Verify row count matches expected nights (4 nights)</span>
<span class="comment">-- If count &lt; 4, some dates are unavailable &rarr; ROLLBACK</span>

<span class="comment">-- Insert booking and mark dates as unavailable</span>
<span class="keyword">INSERT INTO</span> bookings (...) <span class="keyword">VALUES</span> (...);
<span class="keyword">UPDATE</span> availability <span class="keyword">SET</span> is_available = <span class="keyword">false</span>, booking_id = <span class="string">'bk_...'</span>
<span class="keyword">WHERE</span> listing_id = <span class="string">'lst_abc123'</span>
  <span class="keyword">AND</span> date <span class="keyword">BETWEEN</span> <span class="string">'2025-07-01'</span> <span class="keyword">AND</span> <span class="string">'2025-07-04'</span>;

<span class="keyword">COMMIT</span>;
</code></pre>
    <p><strong>Pros:</strong> Simple, guarantees correctness, built into PostgreSQL.<br>
    <strong>Cons:</strong> Row-level locks held during transaction. If payment authorization is inside the transaction, lock duration increases. Can deadlock with concurrent bookings on overlapping dates.</p>
  </div>

  <div class="card" style="border-left: 3px solid var(--secondary);">
    <h4 style="color:var(--secondary);">Approach 2: Optimistic Locking (Version Column)</h4>
<pre><code><span class="comment">-- Read current versions</span>
<span class="keyword">SELECT</span> date, version <span class="keyword">FROM</span> availability
<span class="keyword">WHERE</span> listing_id = <span class="string">'lst_abc123'</span>
  <span class="keyword">AND</span> date <span class="keyword">BETWEEN</span> <span class="string">'2025-07-01'</span> <span class="keyword">AND</span> <span class="string">'2025-07-04'</span>
  <span class="keyword">AND</span> is_available = <span class="keyword">true</span>;

<span class="comment">-- Application checks count, calculates price, etc.</span>

<span class="comment">-- Attempt atomic update with version check</span>
<span class="keyword">UPDATE</span> availability
<span class="keyword">SET</span> is_available = <span class="keyword">false</span>, booking_id = <span class="string">'bk_...'</span>, version = version + <span class="number">1</span>
<span class="keyword">WHERE</span> listing_id = <span class="string">'lst_abc123'</span>
  <span class="keyword">AND</span> date <span class="keyword">BETWEEN</span> <span class="string">'2025-07-01'</span> <span class="keyword">AND</span> <span class="string">'2025-07-04'</span>
  <span class="keyword">AND</span> is_available = <span class="keyword">true</span>
  <span class="keyword">AND</span> version = <span class="number">{expected_version}</span>;

<span class="comment">-- Check affected rows. If &lt; 4 &rarr; conflict, retry or fail</span>
</code></pre>
    <p><strong>Pros:</strong> No locks held between read and write. Higher throughput under low contention.<br>
    <strong>Cons:</strong> Requires retry logic. Under high contention (popular listings on New Year's Eve), retry storms can degrade performance.</p>
  </div>

  <div class="card" style="border-left: 3px solid var(--purple);">
    <h4 style="color:var(--purple);">Approach 3: Distributed Lock (Redis/ZooKeeper)</h4>
<pre><code><span class="comment">// Acquire distributed lock on listing+dates</span>
lock_key = <span class="string">"booking_lock:lst_abc123:2025-07-01:2025-07-04"</span>

<span class="keyword">if</span> redis.SET(lock_key, request_id, NX, EX, <span class="number">30</span>):
    <span class="keyword">try</span>:
        <span class="comment"># Check availability in DB (no FOR UPDATE needed)</span>
        <span class="comment"># Create booking</span>
        <span class="comment"># Mark dates unavailable</span>
        <span class="comment"># Authorize payment</span>
    <span class="keyword">finally</span>:
        redis.DEL(lock_key)  <span class="comment"># or Redlock for multi-node</span>
<span class="keyword">else</span>:
    <span class="keyword">return</span> <span class="number">409</span> Conflict  <span class="comment"># Another booking in progress</span>
</code></pre>
    <p><strong>Pros:</strong> Moves contention out of the database. Lock granularity can be tuned. Good for cross-service coordination.<br>
    <strong>Cons:</strong> Redis locks are not perfectly safe (Redlock debate). Clock skew issues. Extra infrastructure. Must handle lock expiry edge cases.</p>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr><th>Criterion</th><th>Pessimistic (SELECT FOR UPDATE)</th><th>Optimistic (Version)</th><th>Distributed Lock (Redis)</th></tr>
      </thead>
      <tbody>
        <tr><td><strong>Correctness</strong></td><td style="color:var(--success);">Strongest (DB guarantees)</td><td style="color:var(--success);">Strong (CAS semantics)</td><td style="color:var(--warning);">Weaker (lock expiry gaps)</td></tr>
        <tr><td><strong>Throughput</strong></td><td style="color:var(--warning);">Lower (lock contention)</td><td style="color:var(--success);">Higher (no locks)</td><td style="color:var(--success);">High (fast Redis ops)</td></tr>
        <tr><td><strong>Complexity</strong></td><td style="color:var(--success);">Low</td><td style="color:var(--warning);">Medium (retry logic)</td><td style="color:var(--danger);">High (distributed systems)</td></tr>
        <tr><td><strong>Deadlock risk</strong></td><td style="color:var(--warning);">Yes (mitigate with ordering)</td><td style="color:var(--success);">None</td><td style="color:var(--success);">None</td></tr>
        <tr><td><strong>Best for</strong></td><td>Single-DB deployments</td><td>Low-contention listings</td><td>Multi-DB / cross-service</td></tr>
      </tbody>
    </table>
  </div>

  <div class="tip-box tip">
    <strong>&#128161; PE Recommendation</strong>
    Use <strong>pessimistic locking (SELECT FOR UPDATE)</strong> as the primary mechanism -- it is battle-tested, simple, and PostgreSQL handles deadlock detection. Keep the critical section tight: lock dates, insert booking, mark unavailable, commit. Move payment authorization <em>after</em> the commit (two-phase approach: reserve first, then charge). For the rare ultra-popular listings, add a distributed lock as a coarse-grained guard to reduce DB lock contention.
  </div>
</section>

<!-- ================================================================== -->
<!-- SECTION 8: SEARCH DEEP DIVE                                         -->
<!-- ================================================================== -->
<section id="search">
  <h2>
    <span class="section-icon" style="background:rgba(66,139,249,0.08); color:var(--blue);">&#128269;</span>
    Search Deep Dive
  </h2>

  <h3>Elasticsearch Integration</h3>
  <p>Search is powered by Elasticsearch for its native support of geo-queries, full-text search, and complex aggregations. The search index is a <strong>denormalized projection</strong> of listing data, kept in sync via Change Data Capture (CDC) from PostgreSQL.</p>

  <div class="card">
    <h4 style="color:var(--blue);">ES Index Mapping (Simplified)</h4>
<pre><code>{
  <span class="string">"mappings"</span>: {
    <span class="string">"properties"</span>: {
      <span class="string">"listing_id"</span>:      { <span class="string">"type"</span>: <span class="string">"keyword"</span> },
      <span class="string">"title"</span>:           { <span class="string">"type"</span>: <span class="string">"text"</span>, <span class="string">"analyzer"</span>: <span class="string">"standard"</span> },
      <span class="string">"location"</span>:        { <span class="string">"type"</span>: <span class="string">"geo_point"</span> },
      <span class="string">"property_type"</span>:   { <span class="string">"type"</span>: <span class="string">"keyword"</span> },
      <span class="string">"amenities"</span>:       { <span class="string">"type"</span>: <span class="string">"keyword"</span> },
      <span class="string">"max_guests"</span>:      { <span class="string">"type"</span>: <span class="string">"short"</span> },
      <span class="string">"base_price"</span>:      { <span class="string">"type"</span>: <span class="string">"integer"</span> },
      <span class="string">"avg_rating"</span>:      { <span class="string">"type"</span>: <span class="string">"float"</span> },
      <span class="string">"review_count"</span>:    { <span class="string">"type"</span>: <span class="string">"integer"</span> },
      <span class="string">"is_superhost"</span>:    { <span class="string">"type"</span>: <span class="string">"boolean"</span> },
      <span class="string">"instant_book"</span>:    { <span class="string">"type"</span>: <span class="string">"boolean"</span> },
      <span class="string">"available_dates"</span>: { <span class="string">"type"</span>: <span class="string">"date_range"</span> },
      <span class="string">"city"</span>:            { <span class="string">"type"</span>: <span class="string">"keyword"</span> },
      <span class="string">"country"</span>:         { <span class="string">"type"</span>: <span class="string">"keyword"</span> }
    }
  }
}
</code></pre>
  </div>

  <div class="card">
    <h4 style="color:var(--secondary);">Geo Query Example</h4>
<pre><code>{
  <span class="string">"query"</span>: {
    <span class="string">"bool"</span>: {
      <span class="string">"must"</span>: [
        {
          <span class="string">"geo_distance"</span>: {
            <span class="string">"distance"</span>: <span class="string">"25km"</span>,
            <span class="string">"location"</span>: { <span class="string">"lat"</span>: <span class="number">37.7749</span>, <span class="string">"lon"</span>: <span class="number">-122.4194</span> }
          }
        },
        {
          <span class="string">"range"</span>: {
            <span class="string">"available_dates"</span>: {
              <span class="string">"gte"</span>: <span class="string">"2025-07-01"</span>,
              <span class="string">"lte"</span>: <span class="string">"2025-07-04"</span>,
              <span class="string">"relation"</span>: <span class="string">"contains"</span>
            }
          }
        },
        { <span class="string">"range"</span>: { <span class="string">"max_guests"</span>: { <span class="string">"gte"</span>: <span class="number">2</span> } } },
        { <span class="string">"range"</span>: { <span class="string">"base_price"</span>: { <span class="string">"gte"</span>: <span class="number">5000</span>, <span class="string">"lte"</span>: <span class="number">30000</span> } } }
      ],
      <span class="string">"filter"</span>: [
        { <span class="string">"terms"</span>: { <span class="string">"amenities"</span>: [<span class="string">"wifi"</span>, <span class="string">"pool"</span>] } },
        { <span class="string">"term"</span>:  { <span class="string">"is_superhost"</span>: <span class="keyword">true</span> } },
        { <span class="string">"term"</span>:  { <span class="string">"instant_book"</span>: <span class="keyword">true</span> } }
      ]
    }
  },
  <span class="string">"sort"</span>: [
    { <span class="string">"_score"</span>: <span class="string">"desc"</span> },
    { <span class="string">"avg_rating"</span>: <span class="string">"desc"</span> }
  ]
}
</code></pre>
  </div>

  <h3>Search Ranking Signals</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr><th>Signal</th><th>Weight</th><th>Description</th></tr>
      </thead>
      <tbody>
        <tr><td>Geo proximity</td><td style="color:var(--primary);">High</td><td>Closer to search center scores higher. Uses decay function on geo_distance.</td></tr>
        <tr><td>Price match</td><td style="color:var(--primary);">High</td><td>Listings within the guest's implicit/explicit budget score higher.</td></tr>
        <tr><td>Review quality</td><td style="color:var(--warning);">Medium</td><td>Combination of avg_rating and review_count (Bayesian average).</td></tr>
        <tr><td>Conversion history</td><td style="color:var(--warning);">Medium</td><td>Listings with higher booking-to-view ratio rank higher.</td></tr>
        <tr><td>Personalization</td><td style="color:var(--warning);">Medium</td><td>ML model scores based on user's past bookings, saved listings, and browsing behavior.</td></tr>
        <tr><td>Superhost status</td><td style="color:var(--blue);">Low</td><td>Slight boost for Superhost-certified listings.</td></tr>
        <tr><td>Photo quality</td><td style="color:var(--blue);">Low</td><td>Listings with professional photos score marginally higher.</td></tr>
        <tr><td>Response rate</td><td style="color:var(--blue);">Low</td><td>Hosts who respond quickly and accept more requests get a boost.</td></tr>
      </tbody>
    </table>
  </div>

  <h3>CDC Sync: PostgreSQL to Elasticsearch</h3>
  <div class="diagram">
PostgreSQL               Debezium CDC            Kafka              ES Consumer          Elasticsearch
    |                        |                     |                     |                    |
    |-- WAL changes --------&gt;|                     |                     |                    |
    |                        |-- listing.updated --&gt;|                     |                    |
    |                        |                     |--- consume ---------&gt;|                    |
    |                        |                     |                     |-- transform -------&gt;|
    |                        |                     |                     |   &amp; upsert doc      |
    |                        |                     |                     |                    |
    |                        |-- avail.changed ---&gt;|                     |                    |
    |                        |                     |--- consume ---------&gt;|                    |
    |                        |                     |                     |-- update avail ----&gt;|
    |                        |                     |                     |   date ranges       |
    |                        |                     |                     |                    |

Typical Lag: &lt; 2 seconds (P99 &lt; 5 seconds)
</div>

  <div class="tip-box info">
    <strong>&#128161; Availability in Search vs. Booking</strong>
    Search uses Elasticsearch's <code>date_range</code> field for approximate availability filtering -- this is eventually consistent (CDC lag ~2s). When a guest proceeds to book, the Booking Service performs a <strong>real-time check</strong> against PostgreSQL with <code>SELECT FOR UPDATE</code>. This two-tier approach balances search speed (ES) with booking correctness (PG). Occasionally a guest sees a listing as available in search but gets a "dates unavailable" error at booking time -- this is an acceptable UX trade-off at scale.
  </div>
</section>

<!-- ================================================================== -->
<!-- SECTION 9: TRADE-OFFS                                               -->
<!-- ================================================================== -->
<section id="tradeoffs">
  <h2>
    <span class="section-icon" style="background:rgba(245,158,11,0.15); color:var(--warning);">&#9878;&#65039;</span>
    Trade-offs
  </h2>

  <h3>1. SQL vs. NoSQL for Bookings</h3>
  <div class="compare-grid">
    <div class="compare-card opt-a">
      <h4 style="color:var(--blue);">PostgreSQL (Chosen)</h4>
      <ul>
        <li>ACID transactions for booking + availability atomicity</li>
        <li>Rich query capabilities (joins, aggregations)</li>
        <li>Mature tooling (pg_dump, logical replication)</li>
        <li>Row-level locking built-in</li>
      </ul>
      <p style="color:var(--warning); margin-top:10px;"><strong>Limitation:</strong> Vertical scaling ceiling; sharding is complex.</p>
    </div>
    <div class="compare-card opt-b">
      <h4 style="color:var(--secondary);">DynamoDB / Cassandra</h4>
      <ul>
        <li>Horizontal scaling out of the box</li>
        <li>Predictable latency at any scale</li>
        <li>Multi-region replication built-in</li>
        <li>No cross-partition transactions (must use Saga)</li>
      </ul>
      <p style="color:var(--warning); margin-top:10px;"><strong>Limitation:</strong> No ACID across items; double-booking prevention requires application-level logic.</p>
    </div>
  </div>
  <div class="tip-box tip">
    <strong>Verdict:</strong> PostgreSQL wins for the booking write path because financial transactions demand ACID. Use NoSQL (Cassandra) for the read-optimized history/denormalized views where eventual consistency is acceptable.
  </div>

  <h3>2. Pessimistic vs. Optimistic Locking</h3>
  <div class="compare-grid">
    <div class="compare-card opt-a">
      <h4 style="color:var(--blue);">Pessimistic (SELECT FOR UPDATE)</h4>
      <ul>
        <li>Simple mental model; database handles conflicts</li>
        <li>Guaranteed no lost updates</li>
        <li>Lock duration = transaction duration</li>
        <li>Can deadlock (mitigate with consistent ordering)</li>
      </ul>
    </div>
    <div class="compare-card opt-b">
      <h4 style="color:var(--secondary);">Optimistic (Version/CAS)</h4>
      <ul>
        <li>No locks held between read and write</li>
        <li>Higher throughput under low contention</li>
        <li>Requires retry logic in application</li>
        <li>Under high contention, retries amplify load</li>
      </ul>
    </div>
  </div>
  <div class="tip-box tip">
    <strong>Verdict:</strong> Use pessimistic for booking creation (correctness is paramount; contention is low per-listing). Use optimistic for availability calendar updates by hosts (high throughput, low contention, acceptable retries).
  </div>

  <h3>3. Synchronous vs. Asynchronous Payment</h3>
  <div class="compare-grid">
    <div class="compare-card opt-a">
      <h4 style="color:var(--blue);">Sync (Authorize in Booking Flow)</h4>
      <ul>
        <li>Guest gets immediate confirmation</li>
        <li>Simple error handling: if payment fails, release dates</li>
        <li>Adds ~500ms to booking latency (payment gateway RTT)</li>
        <li>If payment gateway is down, bookings are blocked</li>
      </ul>
    </div>
    <div class="compare-card opt-b">
      <h4 style="color:var(--secondary);">Async (Reserve Dates, Charge Later)</h4>
      <ul>
        <li>Booking is instant; payment processed asynchronously</li>
        <li>Decoupled from payment gateway availability</li>
        <li>Needs TTL on pending bookings (release dates if payment fails within 15 min)</li>
        <li>More complex: what if guest sees "confirmed" but payment later fails?</li>
      </ul>
    </div>
  </div>
  <div class="tip-box tip">
    <strong>Verdict:</strong> Use a <strong>two-phase approach</strong>. Phase 1 (sync): Reserve dates + authorize payment (hold, not capture). Phase 2 (async): Capture payment after host confirms (for non-instant-book) or immediately (for instant-book). If authorization fails, immediately release dates. Authorization typically takes &lt;300ms and has 99.9%+ success rate.
  </div>

  <h3>4. Monolith vs. Microservices</h3>
  <div class="compare-grid">
    <div class="compare-card opt-a">
      <h4 style="color:var(--blue);">Monolith</h4>
      <ul>
        <li>Simple deployment and debugging</li>
        <li>In-process function calls (no network hops)</li>
        <li>Single database = easy ACID</li>
        <li>Does not scale independently per concern</li>
      </ul>
    </div>
    <div class="compare-card opt-b">
      <h4 style="color:var(--secondary);">Microservices (Chosen)</h4>
      <ul>
        <li>Independent scaling (search vs. booking)</li>
        <li>Independent deployment and team ownership</li>
        <li>Technology diversity (ES for search, PG for booking)</li>
        <li>Distributed transactions, network failures, operational overhead</li>
      </ul>
    </div>
  </div>
  <div class="tip-box tip">
    <strong>Verdict:</strong> At Airbnb's scale (10M DAU), microservices are necessary. The 33:1 read:write ratio demands independent scaling. But start with a "modular monolith" for new features and extract services only when the scaling or team-boundary need is clear. Premature decomposition is the root of many operational nightmares.
  </div>
</section>

<!-- ================================================================== -->
<!-- SECTION 10: SCALABILITY                                             -->
<!-- ================================================================== -->
<section id="scalability">
  <h2>
    <span class="section-icon" style="background:rgba(16,185,129,0.15); color:var(--success);">&#128640;</span>
    Scalability &amp; Reliability
  </h2>

  <h3>Database Sharding Strategy</h3>
  <div class="card">
    <h4 style="color:var(--blue);">Bookings: Shard by listing_id</h4>
    <p>All availability and booking rows for a listing co-locate on the same shard. This ensures <code>SELECT FOR UPDATE</code> on availability rows is a single-shard operation (no distributed locks needed). Range-based sharding by <code>listing_id</code> hash distributes evenly.</p>
<pre><code><span class="comment">// Shard routing</span>
shard_id = hash(listing_id) % num_shards

<span class="comment">// With 16 shards at 274M bookings over 5 years:</span>
<span class="comment">//   ~17M rows per shard (~17 GB)</span>
<span class="comment">//   Well within single-node PG capacity</span>

<span class="comment">// Cross-shard query (guest history) uses scatter-gather</span>
<span class="comment">// or denormalized read store (CQRS query side)</span>
</code></pre>
    <p style="color:var(--text-muted);">Guest history queries (which span multiple listings/shards) are served from the denormalized Cassandra read store, avoiding expensive scatter-gather across shards.</p>
  </div>

  <h3>Caching Strategy</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr><th>Cache Layer</th><th>What</th><th>TTL</th><th>Invalidation</th></tr>
      </thead>
      <tbody>
        <tr><td><strong>CDN Edge</strong></td><td>Listing images, static assets</td><td>24h</td><td>Cache-busting URL hash</td></tr>
        <tr><td><strong>Redis L1</strong></td><td>Listing metadata (title, price, location)</td><td>5 min</td><td>CDC-driven invalidation via Kafka consumer</td></tr>
        <tr><td><strong>Redis L2</strong></td><td>Availability calendar per listing</td><td>60s</td><td>Write-through on booking creation/cancellation</td></tr>
        <tr><td><strong>Redis L3</strong></td><td>Search result pages (by query hash)</td><td>30s</td><td>TTL only (short enough for freshness)</td></tr>
        <tr><td><strong>App-local</strong></td><td>Pricing rules, tax tables, FX rates</td><td>15 min</td><td>Periodic refresh from config service</td></tr>
        <tr><td><strong>Idempotency</strong></td><td>Idempotency key &rarr; response cache</td><td>24h</td><td>TTL-based expiry</td></tr>
      </tbody>
    </table>
  </div>

  <div class="tip-box warning">
    <strong>&#9888;&#65039; Cache Consistency for Availability</strong>
    Availability cache (Redis L2) uses <strong>write-through</strong>: when a booking is created, the Booking Service updates both PostgreSQL and Redis in the same code path (Redis update after DB commit). If Redis write fails, the cache entry is deleted (forcing next read to hit DB). This prevents stale "available" entries from causing ghost listings in search results.
  </div>

  <h3>Circuit Breakers &amp; Graceful Degradation</h3>
  <div class="card-grid">
    <div class="card" style="border-left: 3px solid var(--danger);">
      <h4 style="color:var(--danger);">Payment Gateway Down</h4>
      <ul>
        <li>Circuit breaker trips after 5 consecutive failures</li>
        <li>Booking Service enters <strong>"reserve only"</strong> mode</li>
        <li>Dates are held for 15 minutes with TTL</li>
        <li>Payment retried via async queue when circuit closes</li>
        <li>Guest sees "Booking reserved, payment processing"</li>
      </ul>
    </div>
    <div class="card" style="border-left: 3px solid var(--warning);">
      <h4 style="color:var(--warning);">Elasticsearch Down</h4>
      <ul>
        <li>Search falls back to <strong>PostgreSQL with PostGIS</strong></li>
        <li>Reduced feature set: basic geo + price filter only</li>
        <li>No full-text search, no ranking signals</li>
        <li>Response time degrades from ~100ms to ~800ms</li>
        <li>Acceptable for short outages (&lt; 30 min)</li>
      </ul>
    </div>
    <div class="card" style="border-left: 3px solid var(--blue);">
      <h4 style="color:var(--blue);">Redis Cache Down</h4>
      <ul>
        <li>All reads fall through to PostgreSQL/ES directly</li>
        <li>Rate limiter falls back to local in-memory counter</li>
        <li>Idempotency check falls back to DB unique constraint</li>
        <li>Latency increases but correctness is maintained</li>
      </ul>
    </div>
    <div class="card" style="border-left: 3px solid var(--secondary);">
      <h4 style="color:var(--secondary);">Kafka Down</h4>
      <ul>
        <li>Booking creation still works (synchronous DB path)</li>
        <li>Downstream consumers (notifications, history denorm) lag</li>
        <li>Events buffered in application memory (bounded queue)</li>
        <li>Replayed from DB outbox table when Kafka recovers</li>
        <li>Transactional outbox pattern ensures no lost events</li>
      </ul>
    </div>
  </div>

  <h3>Multi-Region Deployment</h3>
  <div class="diagram">
                     US-WEST (Primary)                    EU-WEST (Secondary)
              +---------------------------+         +---------------------------+
              |  Search Service (R/W)     |         |  Search Service (R/W)     |
              |  ES Cluster (local)       |         |  ES Cluster (local)       |
              +---------------------------+         +---------------------------+
              |  Booking Service (WRITE)  |         |  Booking Service (READ)   |
              |  PG Primary (leader)      |  ------&gt;|  PG Replica (follower)    |
              +---------------------------+  async  +---------------------------+
              |  Redis Cluster            |  repl.  |  Redis Cluster            |
              +---------------------------+         +---------------------------+
              |  Kafka Cluster            |  &lt;----&gt; |  Kafka MirrorMaker        |
              +---------------------------+         +---------------------------+

  Search: Active-Active (each region has local ES)
  Booking Writes: Single-leader in US-WEST (consistency)
  Booking Reads: Served from local replica (eventual consistency)
  Failover: Manual promotion of EU PG replica to primary (~30s RTO)
</div>
</section>

<!-- ================================================================== -->
<!-- SECTION 11: INTERVIEW TIPS                                          -->
<!-- ================================================================== -->
<section id="interview">
  <h2>
    <span class="section-icon" style="background:rgba(123,47,247,0.15); color:var(--purple);">&#127891;</span>
    Interview Tips
  </h2>

  <h3>4-Phase Framework</h3>
  <div class="card-grid">
    <div class="card" style="border-top: 3px solid var(--primary);">
      <h4 style="color:var(--primary);">Phase 1: Requirements (5 min)</h4>
      <ul>
        <li>Clarify scope: "Are we designing search + booking, or just booking?"</li>
        <li>Ask about scale: DAU, geographic distribution</li>
        <li>Confirm the key NFRs: latency targets, consistency model</li>
        <li>State assumptions explicitly: "I'll assume 10M DAU and instant-book as the primary flow"</li>
      </ul>
    </div>
    <div class="card" style="border-top: 3px solid var(--blue);">
      <h4 style="color:var(--blue);">Phase 2: High-Level Design (10 min)</h4>
      <ul>
        <li>Draw the architecture: API Gateway, core services, data stores</li>
        <li>Call out CQRS early: "Read and write paths have different requirements"</li>
        <li>Show the data flow: search query path vs. booking mutation path</li>
        <li>Identify the hardest problem upfront: "Double-booking prevention is the crux"</li>
      </ul>
    </div>
    <div class="card" style="border-top: 3px solid var(--secondary);">
      <h4 style="color:var(--secondary);">Phase 3: Deep Dive (15 min)</h4>
      <ul>
        <li>Walk through the booking flow step-by-step with the state machine</li>
        <li>Show the SQL for availability checking (SELECT FOR UPDATE)</li>
        <li>Discuss idempotency implementation with concrete examples</li>
        <li>Explain the ES query structure for search</li>
        <li>Cover CDC pipeline for keeping search index fresh</li>
      </ul>
    </div>
    <div class="card" style="border-top: 3px solid var(--purple);">
      <h4 style="color:var(--purple);">Phase 4: Scale + Trade-offs (10 min)</h4>
      <ul>
        <li>Discuss sharding: why shard by listing_id, how to handle cross-shard queries</li>
        <li>Cover failure modes: what happens when each dependency goes down?</li>
        <li>Articulate trade-offs: "I chose X over Y because..."</li>
        <li>Mention monitoring: booking success rate, search latency P99, payment failure rate</li>
      </ul>
    </div>
  </div>

  <h3>Common Follow-Up Questions</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr><th>Question</th><th>Key Points for Answer</th></tr>
      </thead>
      <tbody>
        <tr><td>"How do you handle a flash sale where 1000 users try to book the same listing?"</td><td>Distributed lock (Redis) as first gate, then SELECT FOR UPDATE. Only one wins; others get 409 Conflict with suggestion to search similar listings. Queue-based fairness with virtual waiting room for extreme cases.</td></tr>
        <tr><td>"What if the payment succeeds but the DB commit fails?"</td><td>Two-phase: authorize first (hold funds), then commit DB, then capture payment. If DB fails after auth, void the authorization. Idempotency key ensures retry safety. Reconciliation job catches edge cases.</td></tr>
        <tr><td>"How do you ensure the search index is consistent with the DB?"</td><td>CDC via Debezium reads PostgreSQL WAL. Typical lag &lt;2s. Search results are "best effort" availability; real-time check happens at booking time. Accept occasional "dates no longer available" errors.</td></tr>
        <tr><td>"How do you handle multi-currency?"</td><td>All prices stored in listing's native currency (cents). FX rate locked at booking creation time and stored with the booking. Display currency conversion is real-time for search but locked for billing.</td></tr>
        <tr><td>"What about cancellation refunds?"</td><td>Cancellation policy stored on booking (snapshot at creation). Refund amount calculated by policy engine. Refund initiated via Payment Service (async). Host payout adjusted. All events published to Kafka for audit trail.</td></tr>
        <tr><td>"How would you shard the availability table?"</td><td>Co-shard with bookings by listing_id. Availability lookups are always per-listing, so single-shard queries. The UNIQUE constraint on (listing_id, date) per shard prevents double-booking at the DB level.</td></tr>
      </tbody>
    </table>
  </div>

  <h3>Calibration: What Separates Each Level</h3>
  <div class="calibration">
    <div class="calibration-row">
      <span class="calibration-label">Baseline</span>
      <div class="calibration-bar">
        <div class="calibration-fill cal-baseline">REST APIs + single DB + basic CRUD</div>
      </div>
    </div>
    <div class="calibration-row">
      <span class="calibration-label">Good</span>
      <div class="calibration-bar">
        <div class="calibration-fill cal-good">+ ES for search, + availability checks, + caching</div>
      </div>
    </div>
    <div class="calibration-row">
      <span class="calibration-label">Strong Hire</span>
      <div class="calibration-bar">
        <div class="calibration-fill cal-yes">+ CQRS, + SELECT FOR UPDATE, + idempotency, + state machine</div>
      </div>
    </div>
    <div class="calibration-row">
      <span class="calibration-label">PE Level</span>
      <div class="calibration-bar">
        <div class="calibration-fill cal-strong">+ Sharding strategy, + CDC pipeline, + circuit breakers, + multi-region, + trade-off articulation</div>
      </div>
    </div>
  </div>

  <div class="tip-box purple">
    <strong>&#128161; The PE Differentiator</strong>
    At the Principal Engineer level, interviewers expect you to <strong>drive the discussion proactively</strong>. Do not wait for prompts. Identify the hardest problem (double-booking), propose multiple solutions (pessimistic, optimistic, distributed lock), compare them on correctness/throughput/complexity axes, and justify your choice with the specific workload characteristics. Then extend to failure scenarios: "What if Redis goes down? What if the DB leader fails mid-transaction?" This demonstrates systems thinking -- the ability to reason about emergent behavior across distributed components.
  </div>
</section>

</div><!-- /container -->

<div class="footer">
  <p>Airbnb Booking System &mdash; Principal Engineer System Design Reference</p>
  <p style="margin-top:8px;"><a href="index.html">&#8592; Back to All Topics</a></p>
</div>

<script>
(function(){
  document.querySelectorAll(".diagram-box").forEach(function(box){
    var svg=box.querySelector("svg");
    if(!svg) return;
    var zoom=1, minZ=0.5, maxZ=3;
    var ctrl=document.createElement("div");
    ctrl.className="diagram-zoom-controls";
    ctrl.innerHTML='<button class="zoom-out" title="Zoom Out"></button><span class="zoom-level">100%</span><button class="zoom-in" title="Zoom In">+</button><button class="zoom-reset" title="Reset"></button><button class="zoom-fs" title="Fullscreen"></button>';
    box.insertBefore(ctrl,box.firstChild);
    var lvl=ctrl.querySelector(".zoom-level");
    function apply(){svg.style.transform="scale("+zoom+")";lvl.textContent=Math.round(zoom*100)+"%";}
    ctrl.querySelector(".zoom-in").onclick=function(){zoom=Math.min(maxZ,zoom+0.25);apply();};
    ctrl.querySelector(".zoom-out").onclick=function(){zoom=Math.max(minZ,zoom-0.25);apply();};
    ctrl.querySelector(".zoom-reset").onclick=function(){zoom=1;apply();};
    ctrl.querySelector(".zoom-fs").onclick=function(){
      box.classList.toggle("fullscreen");
      if(box.classList.contains("fullscreen")){this.textContent="";zoom=1.2;}else{this.textContent="";zoom=1;}
      apply();
    };
    box.addEventListener("wheel",function(e){
      if(e.ctrlKey){e.preventDefault();zoom=e.deltaY<0?Math.min(maxZ,zoom+0.1):Math.max(minZ,zoom-0.1);apply();}
    },{passive:false});
  });
})();
</script>
</body>
</html>
