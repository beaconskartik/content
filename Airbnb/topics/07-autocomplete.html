<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Autocomplete / Type-Ahead System - Airbnb System Design</title>
<style>
  :root {
    --primary: #FF5A5F;
    --primary-dark: #E04850;
    --secondary: #00A699;
    --accent: #FC642D;
    --purple: #7B2FF7;
    --blue: #428BF9;
    --dark: #ffffff;
    --darker: #f1f5f9;
    --card-bg: #ffffff;
    --card-border: #e2e8f0;
    --text: #1e293b;
    --text-muted: #4b5563;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--dark);
    color: var(--text);
    line-height: 1.7;
    scroll-behavior: smooth;
  }

  /* ===== HERO ===== */
  .hero {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #6B73FF 100%);
    padding: 60px 40px 50px;
    text-align: center;
    border-bottom: 3px solid var(--accent);
    position: relative;
    overflow: hidden;
  }
  .hero::before {
    content: '';
    position: absolute;
    top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: radial-gradient(circle at 30% 50%, rgba(252,100,45,0.08) 0%, transparent 50%),
                radial-gradient(circle at 70% 50%, rgba(0,166,153,0.15) 0%, transparent 50%);
    animation: pulse 8s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
  .hero h1 {
    font-size: 2.6em;
    background: linear-gradient(135deg, var(--accent), var(--primary), var(--purple));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    position: relative;
    margin-bottom: 10px;
  }
  .hero .subtitle {
    font-size: 1.15em;
    color: rgba(255,255,255,0.9);
    position: relative;
    margin-bottom: 8px;
  }
  .hero .topic-number {
    position: relative;
    display: inline-block;
    background: rgba(252,100,45,0.2);
    color: var(--accent);
    border: 1px solid var(--accent);
    padding: 4px 16px;
    border-radius: 20px;
    font-size: 0.85em;
    font-weight: 600;
    margin-bottom: 15px;
  }
  .hero .back-link {
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: #ffffff;
    text-decoration: none;
    font-size: 0.95em;
    font-weight: 600;
    padding: 10px 24px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.4);
    background: rgba(255,255,255,0.15);
    transition: all 0.3s;
    margin-top: 10px;
  }
  .hero .back-link:hover {
    background: rgba(255,255,255,0.25);
    border-color: #e5e7eb;
    transform: translateX(-3px);
  }
  .hero .stats-row {
    position: relative;
    display: flex;
    justify-content: center;
    gap: 40px;
    margin-top: 25px;
    flex-wrap: wrap;
  }
  .hero .stat-item { text-align: center; }
  .hero .stat-value {
    font-size: 1.8em;
    font-weight: 800;
    color: var(--accent);
  }
  .hero .stat-label {
    font-size: 0.75em;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1.5px;
  }

  /* ===== BADGES ===== */
  .badge {
    display: inline-block;
    padding: 4px 14px;
    border-radius: 20px;
    font-size: 0.78em;
    font-weight: 600;
    margin: 3px 2px;
    white-space: nowrap;
  }
  .badge-red { background: rgba(255,255,255,0.15); color: #ffffff; border: 1px solid rgba(255,255,255,0.3); }
  .badge-green { background: rgba(0,166,153,0.2); color: #ffffff; border: 1px solid var(--secondary); }
  .badge-blue { background: rgba(255,255,255,0.15); color: #ffffff; border: 1px solid rgba(255,255,255,0.3); }
  .badge-purple { background: rgba(255,255,255,0.15); color: #ffffff; border: 1px solid rgba(255,255,255,0.3); }
  .badge-orange { background: rgba(255,255,255,0.15); color: #ffffff; border: 1px solid rgba(255,255,255,0.3); }
  .badge-yellow { background: rgba(245,158,11,0.2); color: var(--warning); border: 1px solid var(--warning); }

  /* ===== STICKY NAV ===== */
  .toc {
    background: #f8fafc;
    padding: 20px 40px;
    border-bottom: 1px solid var(--card-border);
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(10px);
  }
  .toc h2 {
    color: var(--accent);
    margin-bottom: 10px;
    font-size: 0.85em;
    text-transform: uppercase;
    letter-spacing: 2px;
  }
  .toc-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  .toc a {
    color: var(--text-muted);
    text-decoration: none;
    padding: 6px 16px;
    border-radius: 8px;
    font-size: 0.82em;
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    background: var(--card-bg);
    transition: all 0.3s;
    white-space: nowrap;
  }
  .toc a:hover {
    color: var(--accent);
    border-color: var(--accent);
    background: rgba(252,100,45,0.1);
  }

  /* ===== CONTAINER ===== */
  .container { max-width: 1200px; margin: 0 auto; padding: 30px 40px; }

  /* ===== SECTIONS ===== */
  section { margin-bottom: 55px; }
  section > h2 {
    font-size: 1.7em;
    margin-bottom: 22px;
    padding-bottom: 12px;
    border-bottom: 2px solid #e5e7eb;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 40px; height: 40px;
    border-radius: 10px;
    font-size: 1.2em;
    flex-shrink: 0;
  }
  h3 {
    font-size: 1.25em;
    color: var(--blue);
    margin: 22px 0 12px;
  }
  h4 {
    font-size: 1.05em;
    color: #ffffff;
    margin: 16px 0 10px;
  }
  p { margin-bottom: 12px; }
  ul, ol {
    margin: 10px 0 16px 24px;
  }
  li { margin-bottom: 6px; }

  /* ===== CARDS ===== */
  .card {
    background: var(--card-bg);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 20px;
    transition: border-color 0.3s;
  }
  .card:hover { border-color: rgba(252,100,45,0.4); }
  .card h4 {
    font-size: 1.1em;
    margin-bottom: 12px;
    margin-top: 0;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .card-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
  }
  .card-grid-3 {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
  }

  /* ===== TABLES ===== */
  .table-wrap {
    overflow-x: auto;
    border-radius: 12px;
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    margin-bottom: 20px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.88em;
  }
  th {
    background: #f8fafc;
    padding: 13px 16px;
    text-align: left;
    font-weight: 600;
    color: var(--accent);
    border-bottom: 2px solid #e5e7eb;
    white-space: nowrap;
  }
  td {
    padding: 11px 16px;
    border-bottom: 1px solid var(--card-border);
    vertical-align: top;
  }
  tr:hover td { background: rgba(252,100,45,0.04); }
  tr:last-child td { border-bottom: none; }

  /* ===== CODE BLOCKS ===== */
  pre {
    background: #f6f8fa;
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 10px;
    padding: 20px;
    overflow-x: auto;
    font-size: 0.85em;
    line-height: 1.6;
    margin-bottom: 20px;
    position: relative;
  }
  pre .code-label {
    position: absolute;
    top: 8px;
    right: 12px;
    font-size: 0.72em;
    color: var(--text-muted);
    background: rgba(255,255,255,0.06);
    padding: 2px 10px;
    border-radius: 4px;
  }
  code {
    font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
    color: var(--text);
  }
  .kw { color: #cf222e; }
  .fn { color: #8250df; }
  .str { color: #a5d6ff; }
  .cm { color: #6e7781; font-style: italic; }
  .num { color: #0550ae; }
  .type { color: #7ee787; }
  .param { color: #953800; }
  .op { color: #cf222e; }
  .sym { color: #6e7781; }

  /* ===== CALLOUTS ===== */
  .callout {
    border-radius: 12px;
    padding: 20px 24px;
    margin-bottom: 20px;
    border-left: 4px solid;
  }
  .callout-orange {
    background: rgba(252,100,45,0.08);
    border-color: var(--accent);
  }
  .callout-green {
    background: rgba(255,255,255,0.15);
    border-color: #e5e7eb;
  }
  .callout-blue {
    background: rgba(66,139,249,0.08);
    border-color: var(--blue);
  }
  .callout-purple {
    background: rgba(123,47,247,0.08);
    border-color: var(--purple);
  }
  .callout-red {
    background: rgba(255,90,95,0.15);
    border-color: var(--primary);
  }
  .callout-yellow {
    background: rgba(245,158,11,0.06);
    border-color: var(--warning);
  }
  .callout strong:first-child {
    display: block;
    margin-bottom: 6px;
    font-size: 1.05em;
  }

  /* ===== LATENCY BAR ===== */
  .latency-bar-container {
    margin-bottom: 20px;
  }
  .latency-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 10px;
  }
  .latency-label {
    font-weight: 600;
    font-size: 0.9em;
    min-width: 100px;
    color: var(--text-muted);
  }
  .latency-track {
    flex: 1;
    height: 28px;
    background: rgba(255,255,255,0.05);
    border-radius: 6px;
    overflow: hidden;
    position: relative;
  }
  .latency-fill {
    height: 100%;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 10px;
    font-size: 0.78em;
    font-weight: 700;
    color: #fff;
    transition: width 0.6s ease;
  }
  .latency-fill.green { background: linear-gradient(90deg, var(--success), #059669); }
  .latency-fill.yellow { background: linear-gradient(90deg, var(--warning), #d97706); }
  .latency-fill.red { background: linear-gradient(90deg, var(--danger), #dc2626); }
  .latency-marker {
    position: absolute;
    top: 0;
    height: 100%;
    width: 2px;
    background: var(--text-muted);
    opacity: 0.5;
  }
  .latency-marker span {
    position: absolute;
    top: -18px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 0.65em;
    color: var(--text-muted);
    white-space: nowrap;
  }

  /* ===== ARCHITECTURE DIAGRAM ===== */
  .arch-diagram {
    background: #f6f8fa;
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 12px;
    padding: 30px;
    margin: 20px 0;
    overflow-x: auto;
    font-family: 'Cascadia Code', 'Fira Code', monospace;
    font-size: 0.82em;
    line-height: 1.5;
    color: var(--text-muted);
    white-space: pre;
  }
  .diagram-box {
    background: rgba(0,0,0,0.05);
    border-radius: 12px;
    padding: 20px;
    overflow-x: auto;
    margin: 20px 0;
  }

  /* ===== FLOW STEPS ===== */
  .flow-steps {
    display: flex;
    flex-wrap: wrap;
    gap: 0;
    align-items: center;
    margin: 20px 0;
  }
  .flow-step {
    background: var(--card-bg);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 10px;
    padding: 14px 20px;
    text-align: center;
    min-width: 120px;
    transition: border-color 0.3s;
  }
  .flow-step:hover { border-color: var(--accent); }
  .flow-step .step-num {
    display: block;
    font-size: 0.7em;
    color: var(--accent);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 4px;
  }
  .flow-step .step-label {
    font-size: 0.85em;
    font-weight: 600;
    color: var(--text);
  }
  .flow-arrow {
    font-size: 1.2em;
    color: var(--accent);
    padding: 0 6px;
    flex-shrink: 0;
  }

  /* ===== RANKING WEIGHTS ===== */
  .weight-bar {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
  }
  .weight-label {
    min-width: 140px;
    font-size: 0.85em;
    font-weight: 600;
    color: var(--text-muted);
  }
  .weight-track {
    flex: 1;
    height: 22px;
    background: rgba(255,255,255,0.05);
    border-radius: 4px;
    overflow: hidden;
  }
  .weight-fill {
    height: 100%;
    border-radius: 4px;
    display: flex;
    align-items: center;
    padding-left: 10px;
    font-size: 0.72em;
    font-weight: 700;
    color: #fff;
  }

  /* ===== COMPARISON GRID ===== */
  .compare-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-bottom: 20px;
  }
  @media (max-width: 900px) {
    .compare-grid { grid-template-columns: 1fr; }
  }
  .compare-card {
    background: var(--card-bg);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 12px;
    padding: 24px;
    transition: all 0.3s;
    position: relative;
  }
  .compare-card:hover { border-color: var(--accent); transform: translateY(-2px); }
  .compare-card.recommended {
    border-color: var(--success);
    box-shadow: 0 0 20px rgba(16,185,129,0.1);
  }
  .compare-card.recommended::before {
    content: 'RECOMMENDED';
    position: absolute;
    top: -10px;
    left: 20px;
    background: var(--success);
    color: #fff;
    font-size: 0.68em;
    font-weight: 700;
    letter-spacing: 1px;
    padding: 3px 12px;
    border-radius: 4px;
  }
  .compare-card h4 {
    font-size: 1.15em;
    margin-bottom: 14px;
    margin-top: 0;
    color: var(--accent);
  }
  .compare-card .pros, .compare-card .cons {
    margin-bottom: 12px;
  }
  .compare-card .pros strong { color: var(--success); }
  .compare-card .cons strong { color: var(--danger); }
  .compare-card ul { margin-left: 16px; }
  .compare-card li { font-size: 0.88em; margin-bottom: 4px; }

  /* ===== INTERVIEW TIP BOX ===== */
  .interview-box {
    background: linear-gradient(135deg, rgba(252,100,45,0.1), rgba(123,47,247,0.1));
    border: 2px solid var(--accent);
    border-radius: 14px;
    padding: 28px;
    margin: 24px 0;
  }
  .interview-box h3 {
    color: var(--accent);
    margin-top: 0;
    margin-bottom: 14px;
    font-size: 1.2em;
  }

  /* ===== CALIBRATION LEVELS ===== */
  .calibration-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 16px;
    margin-top: 16px;
  }
  .calibration-card {
    border-radius: 10px;
    padding: 18px;
    text-align: center;
  }
  .calibration-card.level-lean-no {
    background: rgba(239,68,68,0.1);
    border: 1px solid var(--danger);
  }
  .calibration-card.level-lean-yes {
    background: rgba(245,158,11,0.1);
    border: 1px solid var(--warning);
  }
  .calibration-card.level-yes {
    background: rgba(16,185,129,0.1);
    border: 1px solid var(--success);
  }
  .calibration-card.level-strong {
    background: rgba(123,47,247,0.1);
    border: 1px solid var(--purple);
  }
  .calibration-card .level-title {
    font-weight: 700;
    font-size: 0.95em;
    margin-bottom: 8px;
  }
  .calibration-card .level-desc {
    font-size: 0.82em;
    color: var(--text-muted);
  }

  /* ===== PIPELINE VISUAL ===== */
  .pipeline-visual {
    display: flex;
    align-items: stretch;
    gap: 0;
    margin: 20px 0;
    flex-wrap: wrap;
  }
  .pipeline-stage {
    flex: 1;
    min-width: 130px;
    background: var(--card-bg);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    padding: 18px 14px;
    text-align: center;
    position: relative;
  }
  .pipeline-stage:first-child { border-radius: 10px 0 0 10px; }
  .pipeline-stage:last-child { border-radius: 0 10px 10px 0; }
  .pipeline-stage .stage-icon { font-size: 1.6em; display: block; margin-bottom: 6px; }
  .pipeline-stage .stage-title { font-weight: 700; font-size: 0.85em; color: var(--accent); display: block; margin-bottom: 4px; }
  .pipeline-stage .stage-desc { font-size: 0.75em; color: var(--text-muted); }
  .pipeline-connector {
    display: flex;
    align-items: center;
    color: var(--accent);
    font-size: 1.4em;
    padding: 0 2px;
  }

  /* ===== FOOTER ===== */
  .footer {
    text-align: center;
    padding: 40px;
    border-top: 1px solid #e5e7eb;
    color: var(--text-muted);
    font-size: 0.85em;
  }
  .footer a { color: var(--accent); text-decoration: none; }
  .footer a:hover { text-decoration: underline; }

    /* ===== RESPONSIVE ===== */
  @media (max-width: 768px) {
    .hero { padding: 36px 16px 30px; }
    .hero h1 { font-size: 1.7em; }
    .hero .subtitle { font-size: 0.95em; }
    .hero .back-link { font-size: 0.85em; padding: 8px 16px; }
    .hero .stats-row { gap: 16px; margin-top: 18px; }
    .hero .stat-value { font-size: 1.4em; }
    .hero .stat-label { font-size: 0.7em; }
    .toc { padding: 14px 16px; }
    .toc-grid { gap: 6px; }
    .toc a { padding: 5px 12px; font-size: 0.78em; }
    .container { padding: 16px 12px; }
    .card-grid, .card-grid-3, .pricing-grid, .comparison { grid-template-columns: 1fr; gap: 14px; }
    section { padding: 24px 0; }
    section > h2 { font-size: 1.25em; }
    table { font-size: 0.82em; display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    th, td { padding: 8px 10px; white-space: nowrap; }
    pre { font-size: 0.82em; padding: 14px; overflow-x: auto; }
    .diagram-box { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .diagram-box svg { min-width: 600px; }
    footer { padding: 24px 16px; font-size: 0.8em; }
  }
  @media (max-width: 480px) {
    .hero { padding: 28px 12px 22px; }
    .hero h1 { font-size: 1.35em; line-height: 1.3; }
    .hero .subtitle { font-size: 0.85em; }
    .hero .back-link { font-size: 0.78em; padding: 6px 12px; }
    .hero .stats-row { gap: 8px; }
    .hero .stat-value { font-size: 1.15em; }
    .container { padding: 14px 10px; }
    .toc a { padding: 4px 10px; font-size: 0.72em; }
    section > h2 { font-size: 1.1em; }
    .badge { padding: 3px 10px; font-size: 0.7em; }
    pre { font-size: 0.75em; padding: 10px; }
    table { font-size: 0.75em; }
    th, td { padding: 6px 8px; }
    footer { padding: 18px 12px; }
  }
  @media (max-width: 360px) {
    .hero h1 { font-size: 1.15em; }
    .hero .stat-value { font-size: 1em; }
    .container { padding: 10px 8px; }
  }

  /* === DIAGRAM ZOOM CONTROLS === */
  .diagram-box { position: relative; }
  .diagram-zoom-controls {
    position: absolute; top: 12px; right: 12px; z-index: 10;
    display: flex; gap: 4px; opacity: 0.5; transition: opacity 0.3s;
  }
  .diagram-box:hover .diagram-zoom-controls { opacity: 1; }
  .diagram-zoom-controls button {
    width: 32px; height: 32px; border-radius: 8px; border: 1px solid #e5e7eb;
    background: #ffffff; color: #1e293b; cursor: pointer; font-size: 16px;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.2s;
    font-family: system-ui; line-height: 1; padding: 0;
  }
  .diagram-zoom-controls button:hover { background: #f1f5f9; border-color: var(--blue); color: var(--blue); }
  .diagram-zoom-controls button:active { transform: scale(0.95); }
  .diagram-zoom-controls .zoom-level {
    font-size: 11px; color: #64748b; display: flex; align-items: center;
    padding: 0 6px; font-weight: 600; min-width: 40px; justify-content: center;
  }
  .diagram-box svg { transition: transform 0.3s ease; transform-origin: center center; }
  .diagram-box.fullscreen {
    position: fixed !important; top: 0; left: 0; width: 100vw; height: 100vh;
    z-index: 9999; background: #ffffff; border-radius: 0; padding: 20px;
    display: flex; align-items: center; justify-content: center;
    overflow: auto;
  }
  .diagram-box.fullscreen .diagram-zoom-controls { opacity: 1; top: 20px; right: 20px; }

  /* ===== COLLAPSIBLE SECTIONS ===== */
  details { margin-bottom: 0; }
  details summary { cursor: pointer; list-style: none; user-select: none; padding: 0; }
  details summary::-webkit-details-marker { display: none; }
  details summary::marker { display: none; content: ''; }
  details summary h2 { display: inline-flex; }
  details summary h2::before {
    content: '\25B6'; display: inline-flex; align-items: center;
    margin-right: 8px; transition: transform 0.2s; font-size: 0.5em; color: var(--text-muted);
  }
  details[open] summary h2::before { transform: rotate(90deg); }
  .toggle-controls { display: flex; gap: 8px; margin-top: 10px; }
  .toggle-controls button {
    padding: 5px 14px; border-radius: 8px; border: 1px solid #e5e7eb;
    background: var(--card-bg); color: var(--text-muted); font-size: 0.78em;
    cursor: pointer; transition: all 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  }
  .toggle-controls button:hover { color: var(--purple); border-color: var(--purple); background: rgba(123,47,247,0.1); }
</style>
</head>
<body>

<!-- ===== HERO ===== -->
<div class="hero">
  <a href="index.html" class="back-link">&#8592; Back to All Topics</a>
  <div class="topic-number">Topic 07</div>
  <h1>Autocomplete / Type-Ahead System</h1>
  <p class="subtitle">Real-time prefix search across locations, listings, verticals &amp; help center at Airbnb scale</p>
  <div style="position:relative; margin-top: 10px;">
    <span class="badge badge-orange">Search Infrastructure</span>
    <span class="badge badge-green">Low Latency</span>
    <span class="badge badge-blue">Trie / ES</span>
    <span class="badge badge-purple">CDN Caching</span>
    <span class="badge badge-red">i18n / CJK</span>
    <span class="badge badge-yellow">Ranking</span>
  </div>
  <div class="stats-row">
    <div class="stat-item">
      <div class="stat-value">400K</div>
      <div class="stat-label">Locations</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">8M</div>
      <div class="stat-label">Listings</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">&lt;50ms</div>
      <div class="stat-label">P50 Latency</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">~100GB</div>
      <div class="stat-label">Index Size</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">60-80%</div>
      <div class="stat-label">CDN Hit Rate</div>
    </div>
  </div>
</div>

<!-- ===== STICKY NAV ===== -->
<nav class="toc">
  <h2>Navigation</h2>
  <div class="toc-grid">
    <a href="#overview">Overview</a>
    <a href="#api-design">API Design</a>
    <a href="#latency">Latency Requirements</a>
    <a href="#index-size">Index Size</a>
    <a href="#architecture">Architecture Options</a>
    <a href="#caching">Caching Strategy</a>
    <a href="#ranking">Ranking Model</a>
    <a href="#data-pipeline">Data Pipeline</a>
    <a href="#scaling">Scaling &amp; Fan-Out</a>
    <a href="#tradeoffs">Trade-Offs</a>
    <a href="#interview-tips">Interview Tips</a>
  </div>
  <div class="toggle-controls">
    <button onclick="document.querySelectorAll('.container details').forEach(d=>d.open=true)">Expand All</button>
    <button onclick="document.querySelectorAll('.container details').forEach(d=>d.open=false)">Collapse All</button>
  </div>
</nav>

<div class="container">

<!-- ===== SECTION 1: OVERVIEW ===== -->
<section id="overview">
  <details open>
  <summary><h2><span class="icon" style="background:rgba(252,100,45,0.15); color:var(--accent);">&#128269;</span> Overview</h2></summary>

  <p>The autocomplete system is the <strong>very first interaction</strong> most users have with Airbnb's search stack. When a user types into the search bar, the system must return ranked suggestions within a tight latency budget. The challenge is serving suggestions across <strong>multiple verticals</strong> (locations, listings, experiences, help articles) while keeping tail latency under 100ms, supporting 50+ locales including CJK languages, and gracefully handling A/B experiments over CDN-cached responses.</p>

  <div class="callout callout-orange">
    <strong>Why This Question Matters at Airbnb</strong>
    Autocomplete touches search conversion directly. A slow or irrelevant suggestion dropdown means users type more, search more broadly, and convert at lower rates. At Airbnb's scale, even a 10ms regression in autocomplete latency can measurably impact booking funnel metrics. This is a PE-level question because it requires reasoning about indexing strategies, CDN caching semantics, cross-vertical ranking, and i18n tokenization -- all within strict latency SLAs.
  </div>

  <div class="card-grid">
    <div class="card">
      <h4 style="color:var(--accent);">&#127758; Corpus &amp; Verticals</h4>
      <ul>
        <li><strong>Locations:</strong> ~400K cities, regions, neighborhoods, airports, POIs</li>
        <li><strong>Listings:</strong> ~8M active listings (titles, property names)</li>
        <li><strong>Experiences:</strong> ~50K activities, tours, events</li>
        <li><strong>Help Center:</strong> ~10K articles, FAQs</li>
        <li><strong>Recent Searches:</strong> per-user, session-scoped</li>
      </ul>
    </div>
    <div class="card">
      <h4 style="color:var(--secondary);">&#9889; Core Requirements</h4>
      <ul>
        <li>Interactive latency: p50 &lt; 50ms, p95 &lt; 100ms</li>
        <li>Support 50+ locales, including CJK tokenization</li>
        <li>Cross-category merged ranking</li>
        <li>Resilient to index rebuild failures</li>
        <li>Debounced client calls (150-300ms after last keystroke)</li>
        <li>A/B experiment support despite CDN caching</li>
      </ul>
    </div>
  </div>

  <h3>Request Flow (High Level)</h3>
  <div class="flow-steps">
    <div class="flow-step">
      <span class="step-num">Step 1</span>
      <span class="step-label">User Types<br>"san fr"</span>
    </div>
    <span class="flow-arrow">&#8594;</span>
    <div class="flow-step">
      <span class="step-num">Step 2</span>
      <span class="step-label">Client<br>Debounce</span>
    </div>
    <span class="flow-arrow">&#8594;</span>
    <div class="flow-step">
      <span class="step-num">Step 3</span>
      <span class="step-label">CDN Edge<br>Cache Check</span>
    </div>
    <span class="flow-arrow">&#8594;</span>
    <div class="flow-step">
      <span class="step-num">Step 4</span>
      <span class="step-label">API Gateway<br>Rate Limit</span>
    </div>
    <span class="flow-arrow">&#8594;</span>
    <div class="flow-step">
      <span class="step-num">Step 5</span>
      <span class="step-label">Autocomplete<br>Service</span>
    </div>
    <span class="flow-arrow">&#8594;</span>
    <div class="flow-step">
      <span class="step-num">Step 6</span>
      <span class="step-label">Index Lookup<br>+ Rank</span>
    </div>
    <span class="flow-arrow">&#8594;</span>
    <div class="flow-step">
      <span class="step-num">Step 7</span>
      <span class="step-label">Merged<br>Response</span>
    </div>
  </div>
  </details>
</section>

<!-- ===== SECTION 2: API DESIGN ===== -->
<section id="api-design">
  <details open>
  <summary><h2><span class="icon" style="background:rgba(66,139,249,0.08); color:var(--blue);">&#128268;</span> API Design</h2></summary>

  <h3>GET /api/v1/autocomplete</h3>
  <p>Single endpoint that serves all verticals. The API is designed to be CDN-cacheable by making the cache key a composite of the query parameters.</p>

  <h4>Request Parameters</h4>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Parameter</th>
          <th>Type</th>
          <th>Required</th>
          <th>Description</th>
          <th>Example</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><code>user_input</code></td>
          <td>string</td>
          <td>Yes</td>
          <td>Raw prefix typed by user (URL-encoded)</td>
          <td><code>"san fr"</code></td>
        </tr>
        <tr>
          <td><code>country</code></td>
          <td>string</td>
          <td>No</td>
          <td>ISO 3166-1 alpha-2 country code for bias</td>
          <td><code>"US"</code></td>
        </tr>
        <tr>
          <td><code>locale</code></td>
          <td>string</td>
          <td>No</td>
          <td>BCP-47 locale tag for display + tokenization</td>
          <td><code>"en-US"</code>, <code>"ja-JP"</code></td>
        </tr>
        <tr>
          <td><code>region</code></td>
          <td>string</td>
          <td>No</td>
          <td>Continent / sub-region for geo-boosting</td>
          <td><code>"NA"</code>, <code>"APAC"</code></td>
        </tr>
        <tr>
          <td><code>num_results</code></td>
          <td>int</td>
          <td>No</td>
          <td>Max suggestions to return (default 8, max 20)</td>
          <td><code>10</code></td>
        </tr>
        <tr>
          <td><code>verticals</code></td>
          <td>string[]</td>
          <td>No</td>
          <td>Filter to specific types (default: all)</td>
          <td><code>["location","listing"]</code></td>
        </tr>
      </tbody>
    </table>
  </div>

  <h4>Response Schema</h4>
<pre><code><span class="sym">{</span>
  <span class="str">"query"</span>: <span class="str">"san fr"</span>,
  <span class="str">"suggestions"</span>: <span class="sym">[</span>
    <span class="sym">{</span>
      <span class="str">"suggestion_type"</span>: <span class="str">"location"</span>,          <span class="cm">// location | listing | experience | help</span>
      <span class="str">"display_text"</span>: <span class="str">"San Francisco, CA"</span>,    <span class="cm">// localized display string</span>
      <span class="str">"subtitle"</span>: <span class="str">"California, United States"</span>, <span class="cm">// secondary line</span>
      <span class="str">"icon"</span>: <span class="str">"location_pin"</span>,               <span class="cm">// icon identifier for client</span>
      <span class="str">"highlight_ranges"</span>: <span class="sym">[[</span><span class="num">0</span>,<span class="num">6</span><span class="sym">]]</span>,          <span class="cm">// character ranges to bold</span>
      <span class="str">"entity_id"</span>: <span class="str">"loc_sf_001"</span>,
      <span class="str">"metadata"</span>: <span class="sym">{</span>
        <span class="str">"lat"</span>: <span class="num">37.7749</span>,
        <span class="str">"lng"</span>: <span class="num">-122.4194</span>,
        <span class="str">"listing_count"</span>: <span class="num">12450</span>
      <span class="sym">}</span>,
      <span class="str">"terms"</span>: <span class="sym">[</span><span class="str">"san"</span>, <span class="str">"francisco"</span><span class="sym">]</span>          <span class="cm">// tokenized terms (critical for CJK)</span>
    <span class="sym">}</span>,
    <span class="sym">{</span>
      <span class="str">"suggestion_type"</span>: <span class="str">"location"</span>,
      <span class="str">"display_text"</span>: <span class="str">"San Fernando Valley, CA"</span>,
      <span class="str">"subtitle"</span>: <span class="str">"Los Angeles, California"</span>,
      <span class="str">"icon"</span>: <span class="str">"location_pin"</span>,
      <span class="str">"highlight_ranges"</span>: <span class="sym">[[</span><span class="num">0</span>,<span class="num">6</span><span class="sym">]]</span>,
      <span class="str">"entity_id"</span>: <span class="str">"loc_sfv_002"</span>,
      <span class="str">"metadata"</span>: <span class="sym">{}</span>,
      <span class="str">"terms"</span>: <span class="sym">[</span><span class="str">"san"</span>, <span class="str">"fernando"</span>, <span class="str">"valley"</span><span class="sym">]</span>
    <span class="sym">}</span>,
    <span class="sym">{</span>
      <span class="str">"suggestion_type"</span>: <span class="str">"listing"</span>,
      <span class="str">"display_text"</span>: <span class="str">"San Francisco Loft with Bay View"</span>,
      <span class="str">"subtitle"</span>: <span class="str">"Entire home - 2 beds"</span>,
      <span class="str">"icon"</span>: <span class="str">"home"</span>,
      <span class="str">"highlight_ranges"</span>: <span class="sym">[[</span><span class="num">0</span>,<span class="num">13</span><span class="sym">]]</span>,
      <span class="str">"entity_id"</span>: <span class="str">"lst_8827341"</span>,
      <span class="str">"metadata"</span>: <span class="sym">{</span>
        <span class="str">"image_url"</span>: <span class="str">"https://..."</span>,
        <span class="str">"price"</span>: <span class="str">"$185/night"</span>
      <span class="sym">}</span>,
      <span class="str">"terms"</span>: <span class="sym">[</span><span class="str">"san"</span>, <span class="str">"francisco"</span>, <span class="str">"loft"</span><span class="sym">]</span>
    <span class="sym">}</span>
  <span class="sym">]</span>,
  <span class="str">"request_id"</span>: <span class="str">"ac-uuid-7f3e..."</span>,
  <span class="str">"latency_ms"</span>: <span class="num">23</span>
<span class="sym">}</span></code><span class="code-label">JSON Response</span></pre>

  <div class="callout callout-blue">
    <strong>Why the <code>terms</code> Array?</strong>
    For CJK languages (Chinese, Japanese, Korean), there are no whitespace word boundaries. The <code>terms</code> array provides the server-side tokenization result so the client can correctly bold-highlight matching segments. For Japanese, "&#26481;&#20140;" input might tokenize to ["&#26481;&#20140;"] while "&#26481;&#20140;&#12479;&#12527;&#12540;" tokenizes to ["&#26481;&#20140;", "&#12479;&#12527;&#12540;"]. Without this, the client would need its own tokenizer.
  </div>
  </details>
</section>

<!-- ===== SECTION 3: LATENCY REQUIREMENTS ===== -->
<section id="latency">
  <details>
  <summary><h2><span class="icon" style="background:rgba(16,185,129,0.15); color:var(--success);">&#9201;</span> Latency Requirements</h2></summary>

  <p>Autocomplete is the most latency-sensitive read path at Airbnb. Users perceive &gt;100ms delays as "laggy" -- the system must feel instantaneous. The latency budget includes network round trip to the nearest edge/origin, index lookup, ranking, and serialization.</p>

  <h3>Target SLAs</h3>
  <div class="latency-bar-container">
    <div class="latency-bar">
      <span class="latency-label">p50 Target</span>
      <div class="latency-track">
        <div class="latency-fill green" style="width: 25%;">&lt; 50ms</div>
        <div class="latency-marker" style="left: 50%;"><span>100ms</span></div>
        <div class="latency-marker" style="left: 75%;"><span>150ms</span></div>
      </div>
    </div>
    <div class="latency-bar">
      <span class="latency-label">p95 Target</span>
      <div class="latency-track">
        <div class="latency-fill yellow" style="width: 50%;">&lt; 100ms</div>
        <div class="latency-marker" style="left: 50%;"><span>100ms</span></div>
        <div class="latency-marker" style="left: 75%;"><span>150ms</span></div>
      </div>
    </div>
    <div class="latency-bar">
      <span class="latency-label">p99 Budget</span>
      <div class="latency-track">
        <div class="latency-fill red" style="width: 75%;">&lt; 150ms</div>
        <div class="latency-marker" style="left: 50%;"><span>100ms</span></div>
        <div class="latency-marker" style="left: 75%;"><span>150ms</span></div>
      </div>
    </div>
  </div>

  <h3>Latency Budget Breakdown</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Component</th>
          <th>CDN Hit</th>
          <th>Origin (Warm)</th>
          <th>Origin (Cold)</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Client debounce</td>
          <td>150-300ms</td>
          <td>150-300ms</td>
          <td>150-300ms</td>
          <td>Not counted in server SLA</td>
        </tr>
        <tr>
          <td>Network RTT (edge)</td>
          <td>5-15ms</td>
          <td>5-15ms</td>
          <td>5-15ms</td>
          <td>CDN PoP or regional DC</td>
        </tr>
        <tr>
          <td>CDN cache lookup</td>
          <td style="color:var(--success);font-weight:700;">&lt;1ms</td>
          <td>MISS</td>
          <td>MISS</td>
          <td>Varnish / CloudFront</td>
        </tr>
        <tr>
          <td>Gateway + routing</td>
          <td>--</td>
          <td>2-5ms</td>
          <td>2-5ms</td>
          <td>Service mesh overhead</td>
        </tr>
        <tr>
          <td>Index lookup</td>
          <td>--</td>
          <td style="color:var(--success);font-weight:700;">5-15ms</td>
          <td>15-40ms</td>
          <td>ES / Trie / Inverted Index</td>
        </tr>
        <tr>
          <td>Ranking + merge</td>
          <td>--</td>
          <td>3-8ms</td>
          <td>5-15ms</td>
          <td>Cross-vertical score + sort</td>
        </tr>
        <tr>
          <td>Serialization</td>
          <td>--</td>
          <td>1-2ms</td>
          <td>1-2ms</td>
          <td>JSON / Protobuf</td>
        </tr>
        <tr style="font-weight:700; background: rgba(252,100,45,0.06);">
          <td>Total Server</td>
          <td style="color:var(--success);">&lt;16ms</td>
          <td style="color:var(--success);">16-45ms</td>
          <td style="color:var(--warning);">28-77ms</td>
          <td>Must stay under 100ms p95</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="callout callout-green">
    <strong>CDN Caching is Critical</strong>
    With 60-80% CDN hit rate on common prefixes, the majority of requests never touch origin servers. This is how we achieve sub-50ms p50 -- most popular queries like "new y", "par", "lon" are served directly from edge cache with &lt;16ms total latency. The CDN cache key is: <code>{locale}:{country}:{normalized_input}:{num_results}</code>.
  </div>
  </details>
</section>

<!-- ===== SECTION 4: INDEX SIZE ===== -->
<section id="index-size">
  <details>
  <summary><h2><span class="icon" style="background:rgba(123,47,247,0.15); color:var(--purple);">&#128202;</span> Index Size Estimation</h2></summary>

  <p>A critical insight for this problem: the total index size is manageable enough to fit on a single machine, which dramatically simplifies the architecture. Let's do the math.</p>

  <div class="card-grid">
    <div class="card">
      <h4 style="color:var(--purple);">&#128200; Document Count</h4>
      <div class="table-wrap" style="margin-bottom:0;">
        <table>
          <thead>
            <tr><th>Vertical</th><th>Documents</th><th>Avg Size</th><th>Total</th></tr>
          </thead>
          <tbody>
            <tr><td>Locations</td><td>400K</td><td>~5KB</td><td>~2GB</td></tr>
            <tr><td>Listings</td><td>8M</td><td>~10KB</td><td>~80GB</td></tr>
            <tr><td>Experiences</td><td>50K</td><td>~8KB</td><td>~0.4GB</td></tr>
            <tr><td>Help Articles</td><td>10K</td><td>~12KB</td><td>~0.12GB</td></tr>
            <tr style="font-weight:700; background:rgba(123,47,247,0.06);">
              <td>Total</td><td>~10M</td><td>~10KB avg</td><td>~100GB</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="card">
      <h4 style="color:var(--blue);">&#128187; Single-Machine Feasibility</h4>
      <ul>
        <li><strong>RAM:</strong> 100GB fits in a single high-memory instance (e.g., r6g.4xlarge with 128GB)</li>
        <li><strong>Trie index:</strong> Compressed prefix trie for 10M entries ~ 15-25GB RAM</li>
        <li><strong>ES index:</strong> With completion suggesters, ~60-80GB on disk, ~30-40GB in heap</li>
        <li><strong>Replication:</strong> 3 replicas per shard for availability</li>
        <li><strong>Key insight:</strong> No need for distributed index -- sharding adds latency, not value</li>
      </ul>
      <div class="callout callout-purple" style="margin-bottom:0;">
        <strong>Interview Signal</strong>
        Candidates who immediately jump to "shard the index across 100 machines" without doing the math miss a critical insight. The index fits on one box. The challenge is replication and multi-region deployment, not sharding.
      </div>
    </div>
  </div>

  <h3>Per-Document Schema (What Gets Indexed)</h3>
<pre><code><span class="sym">{</span>
  <span class="str">"entity_id"</span>:        <span class="str">"loc_sf_001"</span>,
  <span class="str">"type"</span>:              <span class="str">"location"</span>,
  <span class="str">"canonical_name"</span>:    <span class="str">"San Francisco"</span>,
  <span class="str">"display_names"</span>:     <span class="sym">{</span>                         <span class="cm">// localized</span>
    <span class="str">"en"</span>: <span class="str">"San Francisco, CA"</span>,
    <span class="str">"ja"</span>: <span class="str">"&#12469;&#12531;&#12501;&#12521;&#12531;&#12471;&#12473;&#12467;"</span>,
    <span class="str">"ko"</span>: <span class="str">"&#49380;&#54532;&#46976;&#49884;&#49828;&#53076;"</span>,
    <span class="str">"zh"</span>: <span class="str">"&#26087;&#37329;&#23665;"</span>
  <span class="sym">}</span>,
  <span class="str">"aliases"</span>:           <span class="sym">[</span><span class="str">"SF"</span>, <span class="str">"San Fran"</span>, <span class="str">"The City"</span><span class="sym">]</span>,
  <span class="str">"tokens"</span>:            <span class="sym">{</span>                         <span class="cm">// pre-tokenized per locale</span>
    <span class="str">"en"</span>: <span class="sym">[</span><span class="str">"san"</span>, <span class="str">"francisco"</span><span class="sym">]</span>,
    <span class="str">"ja"</span>: <span class="sym">[</span><span class="str">"&#12469;&#12531;&#12501;&#12521;&#12531;&#12471;&#12473;&#12467;"</span><span class="sym">]</span>
  <span class="sym">}</span>,
  <span class="str">"click_count"</span>:       <span class="num">1584200</span>,
  <span class="str">"booking_count"</span>:     <span class="num">892000</span>,
  <span class="str">"region"</span>:            <span class="str">"NA"</span>,
  <span class="str">"country"</span>:           <span class="str">"US"</span>,
  <span class="str">"geo"</span>:               <span class="sym">{</span> <span class="str">"lat"</span>: <span class="num">37.7749</span>, <span class="str">"lng"</span>: <span class="num">-122.4194</span> <span class="sym">}</span>,
  <span class="str">"listing_count"</span>:     <span class="num">12450</span>,
  <span class="str">"updated_at"</span>:        <span class="str">"2025-01-15T08:00:00Z"</span>
<span class="sym">}</span></code><span class="code-label">Index Document</span></pre>
  </details>
</section>

<!-- ===== SECTION 5: ARCHITECTURE OPTIONS ===== -->
<section id="architecture">
  <details>
  <summary><h2><span class="icon" style="background:rgba(252,100,45,0.15); color:var(--accent);">&#127959;</span> Architecture Options</h2></summary>

  <p>There are three viable approaches for the core autocomplete index. Each has distinct trade-offs around latency, operational complexity, and feature richness. A strong answer discusses all three and makes a justified choice.</p>

  <div class="compare-grid">
    <!-- Option A: Elasticsearch -->
    <div class="compare-card recommended">
      <h4>A. Elasticsearch<br>Completion Suggester</h4>
      <p style="font-size:0.85em; color:var(--text-muted); margin-bottom:14px;">Use ES <code>completion</code> field type with FST-based in-memory data structure. Prefix queries hit the completion suggester; infix/fuzzy use standard analyzers.</p>
      <div class="pros">
        <strong>Pros</strong>
        <ul>
          <li>Built-in completion suggester optimized for prefix lookup (sub-10ms)</li>
          <li>Rich query DSL: prefix, regex, fuzzy, context filtering</li>
          <li>Built-in replication, snapshotting, monitoring</li>
          <li>Analyzer chain for i18n: ICU, kuromoji (JP), nori (KR)</li>
          <li>Hot-warm architecture for cost optimization</li>
          <li>Battle-tested at Airbnb scale</li>
        </ul>
      </div>
      <div class="cons">
        <strong>Cons</strong>
        <ul>
          <li>JVM heap pressure at scale (GC pauses = p99 spikes)</li>
          <li>Completion suggester does not natively support infix matching</li>
          <li>Index rebuild = full reindex (can take 30-60 min)</li>
          <li>Operational overhead of managing ES cluster</li>
        </ul>
      </div>
    </div>

    <!-- Option B: Trie -->
    <div class="compare-card">
      <h4>B. In-Memory<br>Trie / Prefix Tree</h4>
      <p style="font-size:0.85em; color:var(--text-muted); margin-bottom:14px;">Custom compressed trie loaded entirely in RAM. Each node stores character transitions; leaf nodes point to ranked suggestion lists. Rebuilt periodically from source data.</p>
      <div class="pros">
        <strong>Pros</strong>
        <ul>
          <li>Fastest possible prefix lookup: O(L) where L = query length</li>
          <li>No external dependency, no network hop</li>
          <li>Predictable latency: no GC, no disk I/O</li>
          <li>Extremely simple to reason about</li>
          <li>Compressed trie (Patricia/Radix) saves memory</li>
        </ul>
      </div>
      <div class="cons">
        <strong>Cons</strong>
        <ul>
          <li>No fuzzy matching without additional structures (BK-tree)</li>
          <li>CJK support requires custom tokenizer integration</li>
          <li>Must build and manage your own replication</li>
          <li>Memory-only = data loss on restart (need rebuild)</li>
          <li>Harder to add new features (facets, filters)</li>
        </ul>
      </div>
    </div>

    <!-- Option C: Custom Inverted Index -->
    <div class="compare-card">
      <h4>C. Custom<br>Inverted Index</h4>
      <p style="font-size:0.85em; color:var(--text-muted); margin-bottom:14px;">Build a purpose-built inverted index: token &rarr; posting list of (doc_id, score). Support prefix, infix, and fuzzy via n-gram indexing. Store on local SSD with mmap.</p>
      <div class="pros">
        <strong>Pros</strong>
        <ul>
          <li>Full control over scoring and ranking</li>
          <li>Can combine prefix + infix + fuzzy in single structure</li>
          <li>N-gram indexing enables efficient substring match</li>
          <li>Can be mmapped: larger than RAM is fine</li>
          <li>No external dependencies</li>
        </ul>
      </div>
      <div class="cons">
        <strong>Cons</strong>
        <ul>
          <li>Significant engineering investment to build and maintain</li>
          <li>Must implement analyzers, tokenizers, scoring from scratch</li>
          <li>No ecosystem tooling (monitoring, snapshots)</li>
          <li>Harder to hire engineers who can maintain</li>
          <li>Risk of reimplementing Lucene poorly</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="callout callout-orange">
    <strong>Recommended: Elasticsearch (Option A) for most teams</strong>
    ES provides the best balance of features, operational maturity, and latency. The completion suggester uses an FST (Finite State Transducer) that lives entirely in heap memory, giving sub-10ms prefix lookups. For Airbnb's scale (~100GB), a 3-node ES cluster with 64GB heap each is sufficient. Use a separate <code>completion</code> field for prefix matching and standard <code>text</code> fields for infix/fuzzy as fallback.
  </div>

  <h3>Architecture Diagram</h3>
  <div class="diagram-box">
  <svg viewBox="0 0 1100 620" xmlns="http://www.w3.org/2000/svg" font-family="Segoe UI, system-ui, sans-serif">
    <defs>
      <filter id="shadow1" x="-4%" y="-4%" width="108%" height="112%">
        <feDropShadow dx="1" dy="2" stdDeviation="3" flood-color="#000" flood-opacity="0.5"/>
      </filter>
      <linearGradient id="g1" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#FF5A5F"/><stop offset="100%" stop-color="#E04850"/></linearGradient>
      <linearGradient id="g2" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#428BF9"/><stop offset="100%" stop-color="#2d6fd9"/></linearGradient>
      <linearGradient id="g3" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#00A699"/><stop offset="100%" stop-color="#008578"/></linearGradient>
      <linearGradient id="g4" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#7B2FF7"/><stop offset="100%" stop-color="#5a1dbf"/></linearGradient>
      <linearGradient id="g5" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#f59e0b"/><stop offset="100%" stop-color="#d97706"/></linearGradient>
      <marker id="ah1" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8"/></marker>
      <marker id="ah1d" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#f59e0b"/></marker>
    </defs>

    <!-- ===== TITLE ===== -->
    <text x="550" y="28" text-anchor="middle" fill="#f59e0b" font-size="15" font-weight="700" letter-spacing="2">AUTOCOMPLETE SYSTEM &#8212; HIGH-LEVEL ARCHITECTURE</text>

    <!-- ===== CLIENTS (left) ===== -->
    <rect x="30" y="70" width="130" height="68" rx="10" fill="url(#g2)" filter="url(#shadow1)" opacity="0.92"/>
    <!-- mobile icon -->
    <rect x="70" y="80" width="20" height="30" rx="4" fill="none" stroke="#fff" stroke-width="1.5"/>
    <line x1="76" y1="104" x2="84" y2="104" stroke="#fff" stroke-width="1"/>
    <text x="95" y="98" fill="#fff" font-size="11" font-weight="700">Browser /</text>
    <text x="95" y="112" fill="#fff" font-size="11" font-weight="700">Mobile</text>
    <text x="95" y="126" fill="rgba(255,255,255,0.8)" font-size="8">debounce 300ms</text>

    <!-- Arrow: Client â†’ CDN -->
    <line x1="160" y1="104" x2="238" y2="104" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#ah1)"/>
    <text x="199" y="98" text-anchor="middle" fill="#94a3b8" font-size="8">HTTPS</text>

    <!-- ===== CDN EDGE ===== -->
    <rect x="245" y="60" width="160" height="88" rx="10" fill="url(#g5)" filter="url(#shadow1)" opacity="0.92"/>
    <!-- globe icon -->
    <circle cx="280" cy="92" r="14" fill="none" stroke="#fff" stroke-width="1.5"/>
    <ellipse cx="280" cy="92" rx="8" ry="14" fill="none" stroke="#fff" stroke-width="1"/>
    <line x1="266" y1="92" x2="294" y2="92" stroke="#fff" stroke-width="1"/>
    <line x1="268" y1="82" x2="292" y2="82" stroke="#fff" stroke-width="0.7"/>
    <line x1="268" y1="102" x2="292" y2="102" stroke="#fff" stroke-width="0.7"/>
    <text x="300" y="88" fill="#fff" font-size="12" font-weight="700">CDN Edge</text>
    <text x="300" y="102" fill="rgba(255,255,255,0.9)" font-size="9">CloudFront / Fastly</text>
    <text x="280" y="136" fill="#fff" font-size="9" font-weight="600" text-anchor="middle">60-80% cache hit</text>
    <rect x="258" y="126" width="104" height="16" rx="8" fill="rgba(0,0,0,0.3)"/>
    <text x="310" y="138" fill="#10b981" font-size="9" font-weight="600" text-anchor="middle">60-80% cache hit</text>

    <!-- Arrow: CDN miss â†’ API GW -->
    <line x1="405" y1="104" x2="478" y2="104" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#ah1)"/>
    <text x="442" y="96" text-anchor="middle" fill="#ef4444" font-size="8" font-weight="600">cache MISS</text>

    <!-- ===== API GATEWAY ===== -->
    <rect x="485" y="60" width="160" height="88" rx="10" fill="url(#g1)" filter="url(#shadow1)" opacity="0.92"/>
    <!-- shield icon -->
    <path d="M518,80 L518,98 Q518,108 530,112 Q542,108 542,98 L542,80 L530,74 Z" fill="none" stroke="#fff" stroke-width="1.5"/>
    <polyline points="524,94 528,98 536,88" fill="none" stroke="#fff" stroke-width="1.5"/>
    <text x="548" y="90" fill="#fff" font-size="12" font-weight="700">API Gateway</text>
    <text x="548" y="104" fill="rgba(255,255,255,0.9)" font-size="9">Rate limit, Auth</text>
    <text x="548" y="117" fill="rgba(255,255,255,0.9)" font-size="9">A/B routing</text>

    <!-- ===== FAN-OUT ARROWS from API GW to 4 indices ===== -->
    <line x1="565" y1="148" x2="565" y2="175" stroke="#94a3b8" stroke-width="1.5"/>
    <text x="575" y="168" fill="#94a3b8" font-size="8" font-style="italic">fan-out</text>
    <!-- horizontal spread line -->
    <line x1="175" y1="175" x2="955" y2="175" stroke="#94a3b8" stroke-width="1"/>
    <!-- vertical drops -->
    <line x1="175" y1="175" x2="175" y2="195" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#ah1)"/>
    <line x1="435" y1="175" x2="435" y2="195" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#ah1)"/>
    <line x1="695" y1="175" x2="695" y2="195" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#ah1)"/>
    <line x1="955" y1="175" x2="955" y2="195" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#ah1)"/>

    <!-- ===== LOCATION INDEX (ES) ===== -->
    <g filter="url(#shadow1)">
      <rect x="110" y="200" width="130" height="90" rx="10" fill="#f8fafc" stroke="#00A699" stroke-width="1.5"/>
      <!-- pin icon -->
      <circle cx="140" cy="222" r="7" fill="none" stroke="#00A699" stroke-width="1.5"/>
      <circle cx="140" cy="222" r="2.5" fill="#00A699"/>
      <path d="M140,229 L140,238" stroke="#00A699" stroke-width="1.5"/>
      <text x="152" y="226" fill="#00A699" font-size="11" font-weight="700">Location</text>
      <text x="152" y="240" fill="#00A699" font-size="11" font-weight="700">Index</text>
      <!-- ES icon: concentric circles -->
      <circle cx="145" cy="265" r="8" fill="none" stroke="#00A699" stroke-width="1" opacity="0.6"/>
      <circle cx="145" cy="265" r="5" fill="none" stroke="#00A699" stroke-width="1" opacity="0.8"/>
      <circle cx="145" cy="265" r="2" fill="#00A699"/>
      <text x="158" y="269" fill="#94a3b8" font-size="9">Elasticsearch</text>
    </g>

    <!-- ===== LISTING INDEX (ES) ===== -->
    <g filter="url(#shadow1)">
      <rect x="370" y="200" width="130" height="90" rx="10" fill="#f8fafc" stroke="#00A699" stroke-width="1.5"/>
      <!-- house icon -->
      <polygon points="405,232 395,222 405,212 415,222" fill="none" stroke="#00A699" stroke-width="1.5"/>
      <rect x="400" y="222" width="10" height="10" fill="none" stroke="#00A699" stroke-width="1"/>
      <text x="422" y="226" fill="#00A699" font-size="11" font-weight="700">Listing</text>
      <text x="422" y="240" fill="#00A699" font-size="11" font-weight="700">Index</text>
      <circle cx="405" cy="265" r="8" fill="none" stroke="#00A699" stroke-width="1" opacity="0.6"/>
      <circle cx="405" cy="265" r="5" fill="none" stroke="#00A699" stroke-width="1" opacity="0.8"/>
      <circle cx="405" cy="265" r="2" fill="#00A699"/>
      <text x="418" y="269" fill="#94a3b8" font-size="9">Elasticsearch</text>
    </g>

    <!-- ===== EXPERIENCE INDEX (ES) ===== -->
    <g filter="url(#shadow1)">
      <rect x="630" y="200" width="130" height="90" rx="10" fill="#f8fafc" stroke="#00A699" stroke-width="1.5"/>
      <!-- star icon -->
      <polygon points="665,212 668,220 676,220 669,226 672,234 665,229 658,234 661,226 654,220 662,220" fill="#00A699" opacity="0.8"/>
      <text x="680" y="226" fill="#00A699" font-size="11" font-weight="700">Experience</text>
      <text x="680" y="240" fill="#00A699" font-size="11" font-weight="700">Index</text>
      <circle cx="665" cy="265" r="8" fill="none" stroke="#00A699" stroke-width="1" opacity="0.6"/>
      <circle cx="665" cy="265" r="5" fill="none" stroke="#00A699" stroke-width="1" opacity="0.8"/>
      <circle cx="665" cy="265" r="2" fill="#00A699"/>
      <text x="678" y="269" fill="#94a3b8" font-size="9">Elasticsearch</text>
    </g>

    <!-- ===== HELP CENTER INDEX (ES) ===== -->
    <g filter="url(#shadow1)">
      <rect x="890" y="200" width="130" height="90" rx="10" fill="#f8fafc" stroke="#00A699" stroke-width="1.5"/>
      <!-- question mark icon -->
      <circle cx="925" cy="222" r="10" fill="none" stroke="#00A699" stroke-width="1.5"/>
      <text x="925" y="227" text-anchor="middle" fill="#00A699" font-size="13" font-weight="700">?</text>
      <text x="940" y="226" fill="#00A699" font-size="11" font-weight="700">Help Ctr</text>
      <text x="940" y="240" fill="#00A699" font-size="11" font-weight="700">Index</text>
      <circle cx="925" cy="265" r="8" fill="none" stroke="#00A699" stroke-width="1" opacity="0.6"/>
      <circle cx="925" cy="265" r="5" fill="none" stroke="#00A699" stroke-width="1" opacity="0.8"/>
      <circle cx="925" cy="265" r="2" fill="#00A699"/>
      <text x="938" y="269" fill="#94a3b8" font-size="9">Elasticsearch</text>
    </g>

    <!-- ===== ARROWS: indices â†’ merger ===== -->
    <line x1="175" y1="290" x2="175" y2="320" stroke="#94a3b8" stroke-width="1"/>
    <line x1="435" y1="290" x2="435" y2="320" stroke="#94a3b8" stroke-width="1"/>
    <line x1="695" y1="290" x2="695" y2="320" stroke="#94a3b8" stroke-width="1"/>
    <line x1="955" y1="290" x2="955" y2="320" stroke="#94a3b8" stroke-width="1"/>
    <line x1="175" y1="320" x2="955" y2="320" stroke="#94a3b8" stroke-width="1"/>
    <line x1="565" y1="320" x2="565" y2="340" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#ah1)"/>

    <!-- ===== RESULTS MERGER / RANKER ===== -->
    <rect x="460" y="345" width="210" height="60" rx="10" fill="url(#g4)" filter="url(#shadow1)" opacity="0.92"/>
    <text x="565" y="372" text-anchor="middle" fill="#fff" font-size="12" font-weight="700">Results Merger / Ranker</text>
    <text x="565" y="390" text-anchor="middle" fill="rgba(255,255,255,0.9)" font-size="9">Combine, dedupe, score, sort</text>

    <!-- Arrow: merger â†’ response back -->
    <line x1="460" y1="375" x2="170" y2="375" stroke="#94a3b8" stroke-width="1.5"/>
    <line x1="170" y1="375" x2="95" y2="375" stroke="#94a3b8" stroke-width="1.5"/>
    <line x1="95" y1="375" x2="95" y2="145" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#ah1)" transform="rotate(180,95,145)"/>
    <text x="200" y="368" fill="#10b981" font-size="8" font-weight="600">JSON response &lt;100ms</text>

    <!-- ======================================================================== -->
    <!-- DATA PIPELINE SECTION (bottom) -->
    <!-- ======================================================================== -->
    <line x1="0" y1="430" x2="1100" y2="430" stroke="#334155" stroke-width="1" stroke-dasharray="5,5"/>
    <text x="550" y="450" text-anchor="middle" fill="#f59e0b" font-size="12" font-weight="700" letter-spacing="2">DATA INGESTION PIPELINE</text>

    <!-- ===== PostgreSQL (Listings DB) ===== -->
    <g filter="url(#shadow1)">
      <rect x="50" y="470" width="130" height="70" rx="0" fill="#f8fafc" stroke="#428BF9" stroke-width="1.5"/>
      <!-- DB cylinder -->
      <ellipse cx="85" cy="482" rx="14" ry="5" fill="#428BF9" opacity="0.3" stroke="#428BF9" stroke-width="1"/>
      <rect x="71" y="482" width="28" height="18" fill="#f8fafc" stroke="#428BF9" stroke-width="1" stroke-dasharray="0,28,18,0,0,28" />
      <line x1="71" y1="482" x2="71" y2="500" stroke="#428BF9" stroke-width="1"/>
      <line x1="99" y1="482" x2="99" y2="500" stroke="#428BF9" stroke-width="1"/>
      <ellipse cx="85" cy="500" rx="14" ry="5" fill="none" stroke="#428BF9" stroke-width="1"/>
      <text x="108" y="496" fill="#428BF9" font-size="10" font-weight="700">PostgreSQL</text>
      <text x="108" y="510" fill="#94a3b8" font-size="8">Listings DB</text>
    </g>

    <!-- ===== Hive/S3 (Click logs) ===== -->
    <g filter="url(#shadow1)">
      <rect x="50" y="555" width="130" height="55" rx="0" fill="#f8fafc" stroke="#4caf50" stroke-width="1.5"/>
      <!-- S3 bucket icon -->
      <path d="M78,570 L72,595 Q80,600 88,595 L82,570 Z" fill="none" stroke="#4caf50" stroke-width="1.5"/>
      <text x="96" y="582" fill="#4caf50" font-size="10" font-weight="700">Hive / S3</text>
      <text x="96" y="596" fill="#94a3b8" font-size="8">Click logs</text>
    </g>

    <!-- ===== Airflow (gear) ===== -->
    <g filter="url(#shadow1)">
      <rect x="260" y="475" width="130" height="55" rx="10" fill="#f8fafc" stroke="#7B2FF7" stroke-width="1.5"/>
      <!-- gear icon -->
      <circle cx="292" cy="502" r="8" fill="none" stroke="#7B2FF7" stroke-width="1.5"/>
      <circle cx="292" cy="502" r="3" fill="#7B2FF7"/>
      <line x1="292" y1="491" x2="292" y2="494" stroke="#7B2FF7" stroke-width="2"/>
      <line x1="292" y1="510" x2="292" y2="513" stroke="#7B2FF7" stroke-width="2"/>
      <line x1="281" y1="502" x2="284" y2="502" stroke="#7B2FF7" stroke-width="2"/>
      <line x1="300" y1="502" x2="303" y2="502" stroke="#7B2FF7" stroke-width="2"/>
      <text x="310" y="500" fill="#7B2FF7" font-size="11" font-weight="700">Airflow</text>
      <text x="310" y="514" fill="#94a3b8" font-size="8">Nightly build</text>
    </g>

    <!-- ===== Spark (processing) ===== -->
    <g filter="url(#shadow1)">
      <rect x="460" y="475" width="130" height="55" rx="10" fill="#f8fafc" stroke="#FC642D" stroke-width="1.5"/>
      <!-- processing icon (overlapping rectangles) -->
      <rect x="485" y="492" width="14" height="14" rx="2" fill="none" stroke="#FC642D" stroke-width="1.5"/>
      <rect x="492" y="486" width="14" height="14" rx="2" fill="none" stroke="#FC642D" stroke-width="1.5"/>
      <text x="512" y="500" fill="#FC642D" font-size="11" font-weight="700">Spark</text>
      <text x="512" y="514" fill="#94a3b8" font-size="8">ETL Processing</text>
    </g>

    <!-- ===== Kafka (real-time) ===== -->
    <g filter="url(#shadow1)">
      <rect x="660" y="475" width="140" height="55" rx="10" fill="#f8fafc" stroke="#ef4444" stroke-width="1.5"/>
      <!-- Kafka icon: 3 circles with lines -->
      <circle cx="690" cy="495" r="4" fill="#ef4444"/>
      <circle cx="690" cy="510" r="4" fill="#ef4444"/>
      <circle cx="703" cy="502" r="4" fill="#ef4444"/>
      <line x1="694" y1="495" x2="699" y2="502" stroke="#ef4444" stroke-width="1.2"/>
      <line x1="694" y1="510" x2="699" y2="502" stroke="#ef4444" stroke-width="1.2"/>
      <text x="712" y="500" fill="#ef4444" font-size="11" font-weight="700">Kafka</text>
      <text x="712" y="514" fill="#94a3b8" font-size="8">Real-time updates</text>
    </g>

    <!-- Pipeline arrows (solid = batch, dashed = stream) -->
    <line x1="180" y1="502" x2="255" y2="502" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#ah1)"/>
    <line x1="180" y1="580" x2="240" y2="502" stroke="#94a3b8" stroke-width="1.2" marker-end="url(#ah1)" stroke-dasharray="4,3"/>
    <line x1="390" y1="502" x2="455" y2="502" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#ah1)"/>
    <line x1="590" y1="502" x2="655" y2="502" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#ah1)"/>

    <!-- Kafka â†’ ES indices (dashed upward) -->
    <line x1="730" y1="475" x2="730" y2="420" stroke="#f59e0b" stroke-width="1.2" stroke-dasharray="5,3"/>
    <line x1="730" y1="420" x2="175" y2="420" stroke="#f59e0b" stroke-width="1" stroke-dasharray="5,3"/>
    <line x1="730" y1="420" x2="435" y2="420" stroke="#f59e0b" stroke-width="1" stroke-dasharray="5,3"/>
    <line x1="730" y1="420" x2="695" y2="420" stroke="#f59e0b" stroke-width="1" stroke-dasharray="5,3"/>
    <line x1="730" y1="420" x2="955" y2="420" stroke="#f59e0b" stroke-width="1" stroke-dasharray="5,3"/>
    <line x1="175" y1="420" x2="175" y2="295" stroke="#f59e0b" stroke-width="1" stroke-dasharray="5,3" marker-end="url(#ah1d)"/>
    <line x1="435" y1="420" x2="435" y2="295" stroke="#f59e0b" stroke-width="1" stroke-dasharray="5,3" marker-end="url(#ah1d)"/>
    <line x1="695" y1="420" x2="695" y2="295" stroke="#f59e0b" stroke-width="1" stroke-dasharray="5,3" marker-end="url(#ah1d)"/>
    <line x1="955" y1="420" x2="955" y2="295" stroke="#f59e0b" stroke-width="1" stroke-dasharray="5,3" marker-end="url(#ah1d)"/>
    <text x="850" y="415" fill="#f59e0b" font-size="8" font-style="italic">async index updates</text>

    <!-- ===== LEGEND ===== -->
    <rect x="870" y="540" width="210" height="70" rx="8" fill="rgba(30,41,59,0.9)" stroke="#334155" stroke-width="1"/>
    <text x="885" y="558" fill="#1e293b" font-size="9" font-weight="700">LEGEND</text>
    <line x1="885" y1="570" x2="910" y2="570" stroke="#94a3b8" stroke-width="1.5"/>
    <text x="916" y="574" fill="#94a3b8" font-size="8">Sync request</text>
    <line x1="885" y1="585" x2="910" y2="585" stroke="#f59e0b" stroke-width="1.2" stroke-dasharray="5,3"/>
    <text x="916" y="589" fill="#94a3b8" font-size="8">Async / streaming</text>
    <circle cx="892" cy="600" r="4" fill="#00A699"/>
    <text x="900" y="603" fill="#94a3b8" font-size="8">Elasticsearch index</text>

    <!-- ===== NUMBERED STEP CIRCLES ===== -->
    <!-- Step 1: User types â†’ Client sends to CDN -->
    <circle cx="199" cy="114" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="199" y="118" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">1</text>
    <!-- Step 2: CDN cache hit â†’ return cached suggestions -->
    <circle cx="325" cy="55" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="325" y="59" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">2</text>
    <!-- Step 3: CDN miss â†’ forward to API Gateway -->
    <circle cx="442" cy="114" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="442" y="118" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">3</text>
    <!-- Step 4: API Gateway â†’ fan-out to 4 index backends -->
    <circle cx="565" cy="160" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="565" y="164" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">4</text>
    <!-- Step 5: Location Index query -->
    <circle cx="118" cy="205" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="118" y="209" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">5</text>
    <!-- Step 6: Listing Index query -->
    <circle cx="378" cy="205" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="378" y="209" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">6</text>
    <!-- Step 7: Experience + Help Center Index queries -->
    <circle cx="812" cy="205" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="812" y="209" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">7</text>
    <!-- Step 8: Results Merger/Ranker -->
    <circle cx="455" cy="350" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="455" y="354" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">8</text>
    <!-- Step 9: Response returned through CDN -->
    <circle cx="82" cy="260" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="82" y="264" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">9</text>
    <!-- Step 10: Data Pipeline updates ES indices -->
    <circle cx="550" cy="460" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="550" y="464" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">10</text>
  </svg>
  </div>

  <!-- ===== REQUEST FLOW REFERENCE ===== -->
  <div class="card" style="margin-top:24px;">
    <h4 style="color:var(--accent);">&#128204; Request Flow Reference (Numbered Steps on Diagram)</h4>
    <div style="overflow-x:auto;">
      <table style="width:100%; border-collapse:collapse; margin-top:10px; font-size:0.92em;">
        <thead>
          <tr style="border-bottom:2px solid var(--card-border);">
            <th style="padding:10px 12px; text-align:center; color:var(--primary); width:55px;">Step</th>
            <th style="padding:10px 12px; text-align:left; color:var(--accent);">Description</th>
            <th style="padding:10px 12px; text-align:left; color:var(--secondary);">Protocol / Detail</th>
          </tr>
        </thead>
        <tbody>
          <tr style="border-bottom:1px solid var(--card-border);">
            <td style="padding:8px 12px; text-align:center; font-weight:800; color:var(--primary);">1</td>
            <td style="padding:8px 12px;">User types in search box &rarr; Client sends request to CDN</td>
            <td style="padding:8px 12px; color:var(--text-muted);">HTTPS, debounce 300 ms</td>
          </tr>
          <tr style="border-bottom:1px solid var(--card-border); background:rgba(255,255,255,0.02);">
            <td style="padding:8px 12px; text-align:center; font-weight:800; color:var(--primary);">2</td>
            <td style="padding:8px 12px;">CDN cache hit &rarr; return cached suggestions</td>
            <td style="padding:8px 12px; color:var(--text-muted);">60-80% of requests served here</td>
          </tr>
          <tr style="border-bottom:1px solid var(--card-border);">
            <td style="padding:8px 12px; text-align:center; font-weight:800; color:var(--primary);">3</td>
            <td style="padding:8px 12px;">CDN miss &rarr; forward to API Gateway</td>
            <td style="padding:8px 12px; color:var(--text-muted);">HTTPS, rate limit + auth</td>
          </tr>
          <tr style="border-bottom:1px solid var(--card-border); background:rgba(255,255,255,0.02);">
            <td style="padding:8px 12px; text-align:center; font-weight:800; color:var(--primary);">4</td>
            <td style="padding:8px 12px;">API Gateway &rarr; fan-out to 4 index backends in parallel</td>
            <td style="padding:8px 12px; color:var(--text-muted);">gRPC, parallel scatter</td>
          </tr>
          <tr style="border-bottom:1px solid var(--card-border);">
            <td style="padding:8px 12px; text-align:center; font-weight:800; color:var(--primary);">5</td>
            <td style="padding:8px 12px;">Location Index query</td>
            <td style="padding:8px 12px; color:var(--text-muted);">Elasticsearch prefix / completion suggester</td>
          </tr>
          <tr style="border-bottom:1px solid var(--card-border); background:rgba(255,255,255,0.02);">
            <td style="padding:8px 12px; text-align:center; font-weight:800; color:var(--primary);">6</td>
            <td style="padding:8px 12px;">Listing Index query</td>
            <td style="padding:8px 12px; color:var(--text-muted);">Elasticsearch</td>
          </tr>
          <tr style="border-bottom:1px solid var(--card-border);">
            <td style="padding:8px 12px; text-align:center; font-weight:800; color:var(--primary);">7</td>
            <td style="padding:8px 12px;">Experience + Help Center Index queries</td>
            <td style="padding:8px 12px; color:var(--text-muted);">Elasticsearch (parallel with steps 5-6)</td>
          </tr>
          <tr style="border-bottom:1px solid var(--card-border); background:rgba(255,255,255,0.02);">
            <td style="padding:8px 12px; text-align:center; font-weight:800; color:var(--primary);">8</td>
            <td style="padding:8px 12px;">Results Merger / Ranker combines and scores results</td>
            <td style="padding:8px 12px; color:var(--text-muted);">Combine, dedupe, ML scoring, sort</td>
          </tr>
          <tr style="border-bottom:1px solid var(--card-border);">
            <td style="padding:8px 12px; text-align:center; font-weight:800; color:var(--primary);">9</td>
            <td style="padding:8px 12px;">Response returned through CDN (cached for next request)</td>
            <td style="padding:8px 12px; color:var(--text-muted);">JSON, &lt;100 ms p95</td>
          </tr>
          <tr>
            <td style="padding:8px 12px; text-align:center; font-weight:800; color:var(--primary);">10</td>
            <td style="padding:8px 12px;">Data Pipeline: Airflow &rarr; Spark &rarr; Kafka &rarr; updates ES indices</td>
            <td style="padding:8px 12px; color:var(--text-muted);">Nightly batch + real-time streaming</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ===== HAPPY PATH ===== -->
  <div class="card" style="margin-top:18px; border-left:4px solid var(--success);">
    <h4 style="color:var(--success);">&#9989; Happy Path</h4>
    <p style="margin-top:8px; line-height:1.8;">
      <strong>Keystroke</strong> &rarr; CDN hit <span style="color:var(--success);">(~5 ms)</span> or CDN miss &rarr; fan-out to ES indices (Location, Listing, Experience, Help Center in parallel) &rarr; merge + rank results &rarr; respond <span style="color:var(--success);">(&lt;100 ms p95)</span>.
    </p>
    <p style="margin-top:6px; color:var(--text-muted); font-size:0.9em;">
      Steps <strong>1 &rarr; 2</strong> (cache hit) or <strong>1 &rarr; 3 &rarr; 4 &rarr; 5/6/7 &rarr; 8 &rarr; 9</strong> (cache miss). Data freshness maintained via step <strong>10</strong> (pipeline).
    </p>
  </div>

  <!-- ===== FAILURE PATHS ===== -->
  <div class="card" style="margin-top:18px; border-left:4px solid var(--danger);">
    <h4 style="color:var(--danger);">&#9888; Failure Paths</h4>
    <div style="overflow-x:auto;">
      <table style="width:100%; border-collapse:collapse; margin-top:10px; font-size:0.92em;">
        <thead>
          <tr style="border-bottom:2px solid var(--card-border);">
            <th style="padding:10px 12px; text-align:left; color:var(--danger);">Failure Scenario</th>
            <th style="padding:10px 12px; text-align:left; color:var(--warning);">Impact</th>
            <th style="padding:10px 12px; text-align:left; color:var(--success);">Mitigation</th>
          </tr>
        </thead>
        <tbody>
          <tr style="border-bottom:1px solid var(--card-border);">
            <td style="padding:8px 12px; font-weight:600;">CDN Down</td>
            <td style="padding:8px 12px; color:var(--text-muted);">All requests hit origin; latency spikes</td>
            <td style="padding:8px 12px; color:var(--text-muted);">Bypass to origin directly; multi-CDN failover</td>
          </tr>
          <tr style="border-bottom:1px solid var(--card-border); background:rgba(255,255,255,0.02);">
            <td style="padding:8px 12px; font-weight:600;">ES Node Failure</td>
            <td style="padding:8px 12px; color:var(--text-muted);">One shard unavailable</td>
            <td style="padding:8px 12px; color:var(--text-muted);">Replica shard serves reads; automatic failover</td>
          </tr>
          <tr style="border-bottom:1px solid var(--card-border);">
            <td style="padding:8px 12px; font-weight:600;">One Index Slow / Timeout</td>
            <td style="padding:8px 12px; color:var(--text-muted);">Partial results only (e.g., no experiences)</td>
            <td style="padding:8px 12px; color:var(--text-muted);">Per-index timeout (50 ms); return partial results from fast indices</td>
          </tr>
          <tr style="border-bottom:1px solid var(--card-border); background:rgba(255,255,255,0.02);">
            <td style="padding:8px 12px; font-weight:600;">Ranking Model Error</td>
            <td style="padding:8px 12px; color:var(--text-muted);">Results unscored / misordered</td>
            <td style="padding:8px 12px; color:var(--text-muted);">Fallback to click-count sort (popularity-based ranking)</td>
          </tr>
          <tr>
            <td style="padding:8px 12px; font-weight:600;">Stale Index Data</td>
            <td style="padding:8px 12px; color:var(--text-muted);">New/updated listings not appearing</td>
            <td style="padding:8px 12px; color:var(--text-muted);">Nightly full rebuild catches up; real-time Kafka stream fills gap</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  </details>
</section>

<!-- ===== SECTION 6: CACHING ===== -->
<section id="caching">
  <details>
  <summary><h2><span class="icon" style="background:rgba(0,166,153,0.15); color:var(--secondary);">&#128230;</span> Caching Strategy</h2></summary>

  <p>Caching is the single most impactful optimization for autocomplete. The distribution of search prefixes follows a power law: a small number of popular prefixes ("new y", "paris", "london", "tokyo") account for the majority of traffic.</p>

  <div class="card-grid">
    <div class="card">
      <h4 style="color:var(--secondary);">&#127760; CDN Edge Caching</h4>
      <ul>
        <li><strong>Cache key:</strong> <code>{locale}:{country}:{normalized_prefix}:{num_results}</code></li>
        <li><strong>TTL:</strong> 5-15 minutes for hot paths, 1 hour for long-tail</li>
        <li><strong>Hit rate:</strong> 60-80% for common 1-3 character prefixes</li>
        <li><strong>Normalization:</strong> lowercase, trim whitespace, collapse accents</li>
        <li><strong>Invalidation:</strong> Soft -- rely on TTL expiry, not active purge</li>
        <li><strong>Vary header:</strong> <code>Vary: Accept-Language</code> for locale-aware caching</li>
      </ul>
    </div>
    <div class="card">
      <h4 style="color:var(--blue);">&#128203; Application-Level Cache</h4>
      <ul>
        <li><strong>L1 (In-process):</strong> LRU cache per pod, 500MB, 30s TTL</li>
        <li><strong>L2 (Redis/Memcached):</strong> Shared across pods, 2GB, 5 min TTL</li>
        <li><strong>Key insight:</strong> Short prefixes (1-2 chars) generate huge result sets -- cache these aggressively</li>
        <li><strong>Warm-up:</strong> Pre-populate cache on deploy with top-1000 prefixes per locale</li>
      </ul>
    </div>
  </div>

  <h3>CDN Hit Rate by Prefix Length</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Prefix Length</th>
          <th>Example</th>
          <th>Unique Prefixes</th>
          <th>CDN Hit Rate</th>
          <th>% of Traffic</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>1 character</td>
          <td>"s", "n", "p"</td>
          <td>~36</td>
          <td style="color:var(--success);font-weight:700;">~95%</td>
          <td>~5%</td>
        </tr>
        <tr>
          <td>2 characters</td>
          <td>"sa", "ne", "pa"</td>
          <td>~1,000</td>
          <td style="color:var(--success);font-weight:700;">~90%</td>
          <td>~15%</td>
        </tr>
        <tr>
          <td>3 characters</td>
          <td>"san", "new", "par"</td>
          <td>~15,000</td>
          <td style="color:var(--success);">~75%</td>
          <td>~30%</td>
        </tr>
        <tr>
          <td>4-6 characters</td>
          <td>"san f", "new yo"</td>
          <td>~200K</td>
          <td style="color:var(--warning);">~45%</td>
          <td>~35%</td>
        </tr>
        <tr>
          <td>7+ characters</td>
          <td>"san francisco"</td>
          <td>~2M+</td>
          <td style="color:var(--danger);">~10%</td>
          <td>~15%</td>
        </tr>
        <tr style="font-weight:700; background: rgba(0,166,153,0.06);">
          <td>Weighted Average</td>
          <td>--</td>
          <td>--</td>
          <td style="color:var(--success);">60-80%</td>
          <td>100%</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="callout callout-red">
    <strong>A/B Testing Over CDN: The Hard Problem</strong>
    <p>CDN caching fundamentally conflicts with A/B experiments. If user A gets a cached response meant for experiment group B, the experiment is contaminated. Solutions:</p>
    <ol>
      <li><strong>Segment in cache key:</strong> Add experiment bucket to cache key -- <code>{locale}:{country}:{prefix}:{experiment_id}</code>. Doubles/triples cache size but preserves correctness.</li>
      <li><strong>CDN bypass for experiments:</strong> Route experiment traffic directly to origin via <code>Cache-Control: no-cache</code> header. Increases origin load but gives full control.</li>
      <li><strong>Sticky experiment assignment:</strong> Assign experiment group at CDN edge using edge compute (Cloudflare Workers / Lambda@Edge). Cache per-bucket responses separately.</li>
      <li><strong>Airbnb's approach:</strong> Typically option 1 or 3. Accept the cache fragmentation cost for the statistical rigor of clean experiments.</li>
    </ol>
  </div>
  </details>
</section>

<!-- ===== SECTION 7: RANKING ===== -->
<section id="ranking">
  <details>
  <summary><h2><span class="icon" style="background:rgba(245,158,11,0.15); color:var(--warning);">&#127942;</span> Ranking Model</h2></summary>

  <p>Ranking is what separates a "working" autocomplete from a great one. The system must merge suggestions from multiple verticals and rank them in a way that maximizes user intent satisfaction. This is a multi-signal scoring problem.</p>

  <h3>Match Type Priority</h3>
  <div class="card-grid-3">
    <div class="card" style="border-color: var(--success);">
      <h4 style="color:var(--success);">&#9989; PREFIX Match</h4>
      <p style="font-size:0.88em;">Query is an exact prefix of the suggestion. Highest confidence.</p>
      <p style="font-size:0.82em; color:var(--text-muted);">Example: "san fr" &rarr; "<strong>San Fr</strong>ancisco"</p>
      <div style="text-align:center; margin-top:10px;">
        <span class="badge badge-green">Weight: 1.0x (baseline)</span>
      </div>
    </div>
    <div class="card" style="border-color: var(--warning);">
      <h4 style="color:var(--warning);">&#128260; INFIX Match</h4>
      <p style="font-size:0.88em;">Query matches within a word or between words. Medium confidence.</p>
      <p style="font-size:0.82em; color:var(--text-muted);">Example: "francisco" &rarr; "San <strong>Francisco</strong>"</p>
      <div style="text-align:center; margin-top:10px;">
        <span class="badge badge-yellow">Weight: 0.6x</span>
      </div>
    </div>
    <div class="card" style="border-color: var(--danger);">
      <h4 style="color:var(--danger);">&#128295; FUZZY Match</h4>
      <p style="font-size:0.88em;">Query has typos; matched via edit distance. Lowest confidence.</p>
      <p style="font-size:0.82em; color:var(--text-muted);">Example: "san fransico" &rarr; "San Fran<strong>cisco</strong>"</p>
      <div style="text-align:center; margin-top:10px;">
        <span class="badge badge-red">Weight: 0.3x</span>
      </div>
    </div>
  </div>

  <h3>Scoring Formula</h3>
<pre><code><span class="cm">// Final score for each suggestion candidate</span>
<span class="kw">score</span> = <span class="param">match_type_weight</span>           <span class="cm">// PREFIX=1.0, INFIX=0.6, FUZZY=0.3</span>
      * <span class="fn">log</span>(<span class="param">click_count</span> + <span class="num">1</span>)        <span class="cm">// popularity signal (log-dampened)</span>
      * <span class="param">locale_boost</span>                  <span class="cm">// 1.5x if suggestion locale matches user locale</span>
      * <span class="param">region_boost</span>                  <span class="cm">// 1.3x if suggestion region matches user region</span>
      * <span class="fn">decay</span>(<span class="param">edit_distance</span>)          <span class="cm">// 1.0 for exact, 0.8 for dist=1, 0.5 for dist=2</span>
      * <span class="param">category_weight</span>               <span class="cm">// location=1.0, listing=0.8, experience=0.6, help=0.4</span>

<span class="cm">// Cross-category allocation (before ranking):</span>
<span class="cm">// locations:  ~5-6 slots  (dominate ~70-90% of shown suggestions)</span>
<span class="cm">// listings:   ~1-2 slots</span>
<span class="cm">// experiences: ~0-1 slots</span>
<span class="cm">// help:       ~0-1 slots (only if high-confidence match)</span></code><span class="code-label">Ranking</span></pre>

  <h3>Ranking Signal Weights</h3>
  <div style="max-width: 700px;">
    <div class="weight-bar">
      <span class="weight-label">Match Type</span>
      <div class="weight-track">
        <div class="weight-fill" style="width:100%; background: linear-gradient(90deg, var(--accent), var(--primary));">35%</div>
      </div>
    </div>
    <div class="weight-bar">
      <span class="weight-label">Popularity (clicks)</span>
      <div class="weight-track">
        <div class="weight-fill" style="width:71%; background: linear-gradient(90deg, var(--warning), #d97706);">25%</div>
      </div>
    </div>
    <div class="weight-bar">
      <span class="weight-label">Locale Match</span>
      <div class="weight-track">
        <div class="weight-fill" style="width:43%; background: linear-gradient(90deg, var(--secondary), #059669);">15%</div>
      </div>
    </div>
    <div class="weight-bar">
      <span class="weight-label">Region Proximity</span>
      <div class="weight-track">
        <div class="weight-fill" style="width:29%; background: linear-gradient(90deg, var(--blue), #2563eb);">10%</div>
      </div>
    </div>
    <div class="weight-bar">
      <span class="weight-label">Edit Distance</span>
      <div class="weight-track">
        <div class="weight-fill" style="width:29%; background: linear-gradient(90deg, var(--purple), #6d28d9);">10%</div>
      </div>
    </div>
    <div class="weight-bar">
      <span class="weight-label">Category Weight</span>
      <div class="weight-track">
        <div class="weight-fill" style="width:14%; background: linear-gradient(90deg, #64748b, #475569);">5%</div>
      </div>
    </div>
  </div>

  <div class="callout callout-yellow">
    <strong>Cross-Category Ranking: Locations Dominate (~90%)</strong>
    <p>In practice, location suggestions dominate the autocomplete dropdown. When a user types "paris", they almost always mean the city, not a listing called "Paris Apartment". The system allocates ~5-6 of 8 slots to locations by default. Listings and experiences only appear when they have very high-confidence prefix matches <em>and</em> the location results are weak (e.g., typing a specific listing name like "Treehouse in Ubud").</p>
    <p style="margin-bottom:0;">This is controlled by a <strong>category budget</strong> system: each category has a max slot allocation that can be tuned per-experiment. The final ranking merges all categories, but categories with exhausted budgets are filtered out before the merge.</p>
  </div>
  </details>
</section>

<!-- ===== SECTION 8: DATA PIPELINE ===== -->
<section id="data-pipeline">
  <details>
  <summary><h2><span class="icon" style="background:rgba(66,139,249,0.08); color:var(--blue);">&#128640;</span> Data Pipeline</h2></summary>

  <p>The autocomplete index is built from multiple source systems and must be kept fresh without disrupting serving. This requires both batch (nightly) and streaming (real-time) pipelines.</p>

  <h3>Pipeline Architecture</h3>
  <div class="pipeline-visual">
    <div class="pipeline-stage">
      <span class="stage-icon">&#128451;</span>
      <span class="stage-title">Source Data</span>
      <span class="stage-desc">Locations DB, Listings DB, Experiences DB, Help CMS</span>
    </div>
    <div class="pipeline-connector">&#8594;</div>
    <div class="pipeline-stage">
      <span class="stage-icon">&#9881;</span>
      <span class="stage-title">ETL / Spark</span>
      <span class="stage-desc">Join, clean, tokenize, compute popularity</span>
    </div>
    <div class="pipeline-connector">&#8594;</div>
    <div class="pipeline-stage">
      <span class="stage-icon">&#127891;</span>
      <span class="stage-title">Tokenizer</span>
      <span class="stage-desc">ICU, kuromoji (JP), nori (KR), jieba (ZH)</span>
    </div>
    <div class="pipeline-connector">&#8594;</div>
    <div class="pipeline-stage">
      <span class="stage-icon">&#128230;</span>
      <span class="stage-title">Index Builder</span>
      <span class="stage-desc">ES bulk API / Trie serialization</span>
    </div>
    <div class="pipeline-connector">&#8594;</div>
    <div class="pipeline-stage">
      <span class="stage-icon">&#9989;</span>
      <span class="stage-title">Validation</span>
      <span class="stage-desc">Diff check, canary deploy, rollback gate</span>
    </div>
    <div class="pipeline-connector">&#8594;</div>
    <div class="pipeline-stage">
      <span class="stage-icon">&#127760;</span>
      <span class="stage-title">Serve</span>
      <span class="stage-desc">Blue-green swap to live replicas</span>
    </div>
  </div>

  <div class="card-grid">
    <div class="card">
      <h4 style="color:var(--blue);">&#127747; Nightly Batch Build</h4>
      <ul>
        <li><strong>Schedule:</strong> Run at 02:00 UTC daily via Airflow DAG</li>
        <li><strong>Input:</strong> Full snapshot of all source tables (Hive/Spark)</li>
        <li><strong>Processing:</strong>
          <ul>
            <li>Join location + listing + experience data</li>
            <li>Compute 7-day rolling click counts per entity</li>
            <li>Generate localized display names for all 50+ locales</li>
            <li>Run CJK tokenizers (kuromoji, nori, jieba)</li>
            <li>Build completion suggester payloads</li>
          </ul>
        </li>
        <li><strong>Output:</strong> ES bulk index file (~100GB), or serialized Trie binary</li>
        <li><strong>Duration:</strong> ~45-90 minutes end-to-end</li>
        <li><strong>Deployment:</strong> Blue-green index swap (build into offline index, then alias swap)</li>
      </ul>
    </div>
    <div class="card">
      <h4 style="color:var(--success);">&#9889; Real-Time Updates via Kafka</h4>
      <ul>
        <li><strong>Source events:</strong>
          <ul>
            <li>New listing created / published</li>
            <li>Listing deactivated / deleted</li>
            <li>Location name change / new location added</li>
            <li>Click count threshold crossed (popularity spike)</li>
          </ul>
        </li>
        <li><strong>Kafka topic:</strong> <code>autocomplete-updates</code> (partitioned by entity_type)</li>
        <li><strong>Consumer:</strong> Flink job processes events, applies to live ES index via update API</li>
        <li><strong>Latency:</strong> Event &rarr; searchable in ~30-60 seconds</li>
        <li><strong>Safety:</strong> Real-time only <em>appends</em> and <em>updates</em>; never deletes (handled by nightly rebuild with validation)</li>
      </ul>
    </div>
  </div>

  <h3>CJK Tokenization Deep Dive</h3>
  <div class="callout callout-purple">
    <strong>Why CJK is Hard for Autocomplete</strong>
    <p>In English, words are separated by spaces: "San Francisco" &rarr; ["san", "francisco"]. Prefix matching on word boundaries is trivial. In CJK languages, there are no spaces:</p>
    <ul>
      <li><strong>Japanese:</strong> "&#26481;&#20140;&#12479;&#12527;&#12540;" (Tokyo Tower) -- must be tokenized by a morphological analyzer (kuromoji) into ["&#26481;&#20140;", "&#12479;&#12527;&#12540;"]</li>
      <li><strong>Chinese:</strong> "&#19978;&#28023;&#22806;&#28393;" (Shanghai Bund) -- jieba segments into ["&#19978;&#28023;", "&#22806;&#28393;"]</li>
      <li><strong>Korean:</strong> "&#49436;&#50872;&#53440;&#50892;" (Seoul Tower) -- nori segments into ["&#49436;&#50872;", "&#53440;&#50892;"]</li>
    </ul>
    <p style="margin-bottom:0;">Without proper tokenization, typing "&#26481;&#20140;" would not match "&#26481;&#20140;&#12479;&#12527;&#12540;" because there is no word boundary to do prefix matching on. The tokenizer must run both at <strong>index time</strong> (to create searchable tokens) and at <strong>query time</strong> (to tokenize user input). The <code>terms</code> array in the API response sends these tokens to the client for highlight rendering.</p>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Language</th>
          <th>Tokenizer</th>
          <th>Input</th>
          <th>Tokens</th>
          <th>Challenge</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Japanese</td>
          <td>kuromoji</td>
          <td>&#26481;&#20140;&#12479;&#12527;&#12540;</td>
          <td>["&#26481;&#20140;", "&#12479;&#12527;&#12540;"]</td>
          <td>Mixed scripts (kanji + katakana + hiragana)</td>
        </tr>
        <tr>
          <td>Chinese</td>
          <td>jieba / ICU</td>
          <td>&#19978;&#28023;&#22806;&#28393;</td>
          <td>["&#19978;&#28023;", "&#22806;&#28393;"]</td>
          <td>Ambiguous segmentation, simplified vs traditional</td>
        </tr>
        <tr>
          <td>Korean</td>
          <td>nori</td>
          <td>&#49436;&#50872;&#53440;&#50892;</td>
          <td>["&#49436;&#50872;", "&#53440;&#50892;"]</td>
          <td>Jamo decomposition for partial matching</td>
        </tr>
        <tr>
          <td>Thai</td>
          <td>ICU</td>
          <td>&#3585;&#3619;&#3640;&#3591;&#3648;&#3607;&#3614;</td>
          <td>["&#3585;&#3619;&#3640;&#3591;&#3648;&#3607;&#3614;"]</td>
          <td>No spaces, dictionary-based segmentation</td>
        </tr>
      </tbody>
    </table>
  </div>
  </details>
</section>

<!-- ===== SECTION 9: SCALING ===== -->
<section id="scaling">
  <details>
  <summary><h2><span class="icon" style="background:rgba(255,90,95,0.15); color:var(--primary);">&#128640;</span> Scaling &amp; Fan-Out</h2></summary>

  <p>While the index fits a single machine, the system needs replication for availability, multi-region deployment for latency, and fan-out to multiple backends when serving cross-vertical suggestions.</p>

  <h3>Multi-Region Deployment</h3>
  <div class="arch-diagram">
                  +------------------------------------------+
                  |              <span style="color:var(--accent);">Global CDN</span>                    |
                  |  (CloudFront / Fastly / Cloudflare)      |
                  +-----+----------+----------+--------------+
                        |          |          |
                   US-West    EU-West     APAC
                        |          |          |
                        v          v          v
                  +-----+--+ +----+---+ +----+---+
                  |<span style="color:var(--blue);">Regional</span> | |<span style="color:var(--blue);">Regional</span>| |<span style="color:var(--blue);">Regional</span>|
                  |<span style="color:var(--blue);">Cluster</span>  | |<span style="color:var(--blue);">Cluster</span> | |<span style="color:var(--blue);">Cluster</span> |
                  |3x ES    | |3x ES   | |3x ES   |
                  |replica  | |replica  | |replica  |
                  +----+----+ +----+----+ +----+----+
                       |           |           |
                       +-----+-----+-----+-----+
                             |           |
                       +-----+----+ +----+-----+
                       |<span style="color:var(--warning);">Kafka MR</span>  | |<span style="color:var(--warning);">Nightly</span>   |
                       |Replicate | |Index Sync |
                       +----------+ +----------+</div>

  <h3>Fan-Out Strategy</h3>
  <p>When serving a single autocomplete request, the service may fan out to multiple backends in parallel. The key constraint is the <strong>latency budget</strong>: all backends must respond within the overall p95 target.</p>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Backend</th>
          <th>Index Type</th>
          <th>Timeout</th>
          <th>Fallback on Timeout</th>
          <th>Priority</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Location Index</td>
          <td>ES Completion Suggester</td>
          <td>60ms</td>
          <td>Return partial results without locations</td>
          <td style="color:var(--success);font-weight:700;">P0 (critical)</td>
        </tr>
        <tr>
          <td>Listing Index</td>
          <td>ES Completion Suggester</td>
          <td>60ms</td>
          <td>Omit listings from response</td>
          <td style="color:var(--warning);">P1 (important)</td>
        </tr>
        <tr>
          <td>Experience Index</td>
          <td>ES Text Query</td>
          <td>40ms</td>
          <td>Omit experiences from response</td>
          <td>P2 (nice to have)</td>
        </tr>
        <tr>
          <td>Help Center</td>
          <td>In-Memory Trie</td>
          <td>30ms</td>
          <td>Omit help articles from response</td>
          <td>P2 (nice to have)</td>
        </tr>
        <tr>
          <td>Recent Searches</td>
          <td>Redis per-user</td>
          <td>20ms</td>
          <td>Omit recents from response</td>
          <td>P1 (personalization)</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="callout callout-orange">
    <strong>Fan-Out with Latency Budget Pattern</strong>
    <p>The autocomplete service sends all backend requests in parallel. It collects responses with a <strong>global timeout of 80ms</strong>. When the timeout fires:</p>
    <ul>
      <li>If Location Index responded: merge whatever other results arrived and return</li>
      <li>If Location Index did NOT respond: return degraded response (recent searches only, or empty)</li>
    </ul>
    <p style="margin-bottom:0;">This ensures we always respond within budget. The ranking/merge step adds ~3-8ms on top of the slowest backend response. Backends that respond after the timeout are simply discarded.</p>
  </div>

  <h3>Capacity Planning</h3>
  <div class="card-grid-3">
    <div class="card">
      <h4 style="color:var(--primary);">&#128200; Traffic Estimates</h4>
      <ul>
        <li>Peak QPS: ~50K autocomplete requests/sec</li>
        <li>After CDN (70% hit): ~15K QPS to origin</li>
        <li>Per region: ~5K QPS</li>
        <li>Per ES node: ~1.5K QPS (well within limits)</li>
      </ul>
    </div>
    <div class="card">
      <h4 style="color:var(--blue);">&#128187; Compute</h4>
      <ul>
        <li>3 regions x 3 ES nodes = 9 total ES nodes</li>
        <li>r6g.4xlarge (16 vCPU, 128GB RAM) per node</li>
        <li>6 autocomplete service pods per region</li>
        <li>Redis cluster: 3 nodes, 32GB each for recents</li>
      </ul>
    </div>
    <div class="card">
      <h4 style="color:var(--success);">&#128176; Cost Estimate</h4>
      <ul>
        <li>ES nodes: 9 x ~$600/mo = ~$5,400/mo</li>
        <li>Service pods: 18 x ~$200/mo = ~$3,600/mo</li>
        <li>Redis: 9 x ~$150/mo = ~$1,350/mo</li>
        <li>CDN: ~$2,000/mo at this traffic</li>
        <li><strong>Total: ~$12,350/mo</strong></li>
      </ul>
    </div>
  </div>
  </details>
</section>

<!-- ===== SECTION 10: TRADE-OFFS ===== -->
<section id="tradeoffs">
  <details>
  <summary><h2><span class="icon" style="background:rgba(123,47,247,0.15); color:var(--purple);">&#9878;</span> Trade-Offs Table</h2></summary>

  <p>Every design decision in this system involves trade-offs. A PE-level candidate should be able to articulate these clearly and justify their choices.</p>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Decision</th>
          <th>Option A</th>
          <th>Option B</th>
          <th>Trade-Off</th>
          <th>Recommendation</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Index Technology</strong></td>
          <td>Elasticsearch</td>
          <td>Custom Trie</td>
          <td>Feature richness vs. raw latency. ES gives analyzers, fuzzy, monitoring out of the box. Trie gives sub-ms prefix lookups but no fuzzy.</td>
          <td style="color:var(--success);">ES for most teams; Trie if you need sub-5ms and have eng capacity</td>
        </tr>
        <tr>
          <td><strong>CDN Caching</strong></td>
          <td>Aggressive (5-15 min TTL)</td>
          <td>Conservative (30s TTL)</td>
          <td>Staleness vs. latency. Longer TTL = higher hit rate + lower origin load, but suggestions lag behind real-time data changes.</td>
          <td style="color:var(--success);">Aggressive TTL. Autocomplete data changes slowly; 15 min staleness is acceptable.</td>
        </tr>
        <tr>
          <td><strong>A/B over CDN</strong></td>
          <td>Bucket in cache key</td>
          <td>CDN bypass for experiments</td>
          <td>Cache fragmentation vs. origin load. Bucketing reduces hit rate by ~Nx (N = number of buckets). Bypass increases origin QPS proportional to experiment traffic.</td>
          <td style="color:var(--success);">Bucket in cache key for small experiments (&lt;4 buckets). Bypass for complex multi-arm experiments.</td>
        </tr>
        <tr>
          <td><strong>Cross-Category Ranking</strong></td>
          <td>Fixed slot allocation</td>
          <td>Unified score-based</td>
          <td>Predictability vs. relevance. Fixed slots guarantee locations always appear. Unified scoring might let a popular listing outrank a location.</td>
          <td style="color:var(--success);">Fixed allocation with flex. Reserve 5 slots for locations, let remaining 3 compete across categories.</td>
        </tr>
        <tr>
          <td><strong>Index Freshness</strong></td>
          <td>Nightly batch only</td>
          <td>Batch + real-time Kafka</td>
          <td>Simplicity vs. freshness. Nightly is simple but new listings take 24h to appear. Kafka adds complexity but sub-minute freshness.</td>
          <td style="color:var(--success);">Batch + Kafka. New listing appearing in search quickly is a core business requirement.</td>
        </tr>
        <tr>
          <td><strong>Fuzzy Matching</strong></td>
          <td>Always enabled</td>
          <td>Only after no prefix/infix results</td>
          <td>Recall vs. precision. Always-on fuzzy can surface irrelevant results for common prefixes. Conditional fuzzy adds a round-trip if prefix returns nothing.</td>
          <td style="color:var(--success);">Conditional. Only trigger fuzzy when prefix + infix return &lt; 3 results. Avoids confusing suggestions.</td>
        </tr>
        <tr>
          <td><strong>Personalization</strong></td>
          <td>Recent searches only</td>
          <td>Full ML-based personalization</td>
          <td>Latency vs. relevance. ML model adds 10-20ms inference time. Recent searches are fast (Redis lookup) and cover 80% of the personalization value.</td>
          <td style="color:var(--success);">Start with recents. Add lightweight ML re-ranking as a later optimization.</td>
        </tr>
        <tr>
          <td><strong>Sharding Strategy</strong></td>
          <td>Single index per region</td>
          <td>Sharded by vertical</td>
          <td>Simplicity vs. isolation. Single index is simpler but a bad listing index rebuild could affect location queries. Sharding isolates blast radius.</td>
          <td style="color:var(--success);">Shard by vertical. Location, listing, experience each get independent ES indices.</td>
        </tr>
      </tbody>
    </table>
  </div>
  </details>
</section>

<!-- ===== SECTION 11: INTERVIEW TIPS ===== -->
<section id="interview-tips">
  <details>
  <summary><h2><span class="icon" style="background:rgba(252,100,45,0.15); color:var(--accent);">&#127919;</span> Interview Tips &amp; Calibration</h2></summary>

  <div class="interview-box">
    <h3>What Makes a STRONG YES</h3>
    <p>A Strong Yes candidate covers <strong>all six pillars</strong> in a cohesive 45-minute design session, showing depth in at least 2-3 areas and breadth across all:</p>
    <div class="table-wrap" style="margin-bottom:0;">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Pillar</th>
            <th>What to Cover</th>
            <th>Deep-Dive Signal</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>1</td>
            <td><strong>Indexing Strategy</strong></td>
            <td>ES completion suggester vs. Trie vs. custom inverted index; justify choice; explain FST data structure</td>
            <td>Explains why completion suggester uses FSTs, how they differ from standard inverted index queries</td>
          </tr>
          <tr>
            <td>2</td>
            <td><strong>API Design</strong></td>
            <td>Clean REST endpoint; cache-friendly parameters; CJK terms array; highlight ranges</td>
            <td>Discusses CDN cache key design and how API parameters affect cacheability</td>
          </tr>
          <tr>
            <td>3</td>
            <td><strong>Latency Management</strong></td>
            <td>p50/p95 targets; latency budget breakdown; debounce strategy; fan-out with timeout</td>
            <td>Walks through end-to-end latency accounting; discusses degraded response on backend timeout</td>
          </tr>
          <tr>
            <td>4</td>
            <td><strong>Ranking</strong></td>
            <td>Multi-signal scoring; match type priority; cross-category allocation; location dominance</td>
            <td>Proposes concrete formula with weights; explains why locations should dominate; discusses offline vs. online ranking</td>
          </tr>
          <tr>
            <td>5</td>
            <td><strong>CDN + Caching</strong></td>
            <td>Edge caching for common prefixes; hit rate by prefix length; A/B experiment challenges</td>
            <td>Identifies and solves the A/B-over-CDN conflict; discusses cache key design and fragmentation trade-offs</td>
          </tr>
          <tr>
            <td>6</td>
            <td><strong>Data Pipeline</strong></td>
            <td>Nightly batch + Kafka real-time; CJK tokenization; blue-green index swap; validation</td>
            <td>Discusses rollback strategy if new index has regressions; explains CJK tokenizer selection per locale</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <h3>Calibration Levels</h3>
  <div class="calibration-grid">
    <div class="calibration-card level-lean-no">
      <div class="level-title" style="color:var(--danger);">Lean No</div>
      <div class="level-desc">
        <ul style="text-align:left; font-size:0.88em; list-style:none; padding:0; margin:0;">
          <li>Only describes basic Trie with no ranking</li>
          <li>No latency analysis or CDN discussion</li>
          <li>Ignores CJK / localization entirely</li>
          <li>Cannot articulate trade-offs between approaches</li>
          <li>No data pipeline consideration</li>
        </ul>
      </div>
    </div>
    <div class="calibration-card level-lean-yes">
      <div class="level-title" style="color:var(--warning);">Lean Yes</div>
      <div class="level-desc">
        <ul style="text-align:left; font-size:0.88em; list-style:none; padding:0; margin:0;">
          <li>Covers API + indexing + basic caching</li>
          <li>Mentions but doesn't deep-dive latency</li>
          <li>Simple ranking (popularity only)</li>
          <li>Aware of CJK challenges but hand-waves solution</li>
          <li>Basic batch pipeline, no real-time</li>
        </ul>
      </div>
    </div>
    <div class="calibration-card level-yes">
      <div class="level-title" style="color:var(--success);">Yes</div>
      <div class="level-desc">
        <ul style="text-align:left; font-size:0.88em; list-style:none; padding:0; margin:0;">
          <li>Covers all 6 pillars with reasonable depth</li>
          <li>Latency budget breakdown with numbers</li>
          <li>Multi-signal ranking with cross-category logic</li>
          <li>CDN caching with hit rate estimates</li>
          <li>Batch + streaming pipeline</li>
        </ul>
      </div>
    </div>
    <div class="calibration-card level-strong">
      <div class="level-title" style="color:var(--purple);">Strong Yes</div>
      <div class="level-desc">
        <ul style="text-align:left; font-size:0.88em; list-style:none; padding:0; margin:0;">
          <li>All 6 pillars + deep-dives on 2-3</li>
          <li>A/B over CDN solution with trade-offs</li>
          <li>CJK tokenizer selection per language</li>
          <li>Fan-out with latency budget + degradation</li>
          <li>Index size math proving single-machine feasibility</li>
          <li>Proactively discusses what they would NOT build</li>
        </ul>
      </div>
    </div>
  </div>

  <h3>Common Pitfalls to Avoid</h3>
  <div class="card-grid">
    <div class="card" style="border-color: var(--danger);">
      <h4 style="color:var(--danger);">&#10060; Don't Do This</h4>
      <ul>
        <li>Jumping to "shard across 100 machines" without doing index size math</li>
        <li>Designing a Trie and calling it done -- no ranking, no CDN, no pipeline</li>
        <li>Ignoring localization in a global product like Airbnb</li>
        <li>Proposing ML ranking without addressing the latency cost</li>
        <li>Treating all verticals equally in ranking (locations should dominate)</li>
        <li>Forgetting about A/B testing challenges with CDN caching</li>
        <li>No client-side debounce discussion</li>
      </ul>
    </div>
    <div class="card" style="border-color: var(--success);">
      <h4 style="color:var(--success);">&#9989; Do This Instead</h4>
      <ul>
        <li>Start with back-of-envelope: 10M docs x 10KB = 100GB = fits one machine</li>
        <li>Present 2-3 architecture options with trade-offs, then choose one</li>
        <li>Walk through a concrete query end-to-end with latency at each hop</li>
        <li>Show you understand CDN caching is the key to meeting latency SLAs</li>
        <li>Discuss cross-category ranking as a product decision, not just engineering</li>
        <li>Mention CJK tokenization proactively -- shows global product thinking</li>
        <li>Propose concrete ranking formula with weights and explain each signal</li>
      </ul>
    </div>
  </div>

  <h3>Suggested 45-Minute Timeline</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Time</th>
          <th>Phase</th>
          <th>What to Cover</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>0-5 min</td>
          <td><strong>Requirements</strong></td>
          <td>Clarify verticals, latency targets, scale (QPS, corpus size), localization needs</td>
        </tr>
        <tr>
          <td>5-10 min</td>
          <td><strong>API + Schema</strong></td>
          <td>Define the autocomplete endpoint, request/response schema, CDN cache key</td>
        </tr>
        <tr>
          <td>10-15 min</td>
          <td><strong>Index Size Math</strong></td>
          <td>Back-of-envelope calculation proving single-machine feasibility</td>
        </tr>
        <tr>
          <td>15-25 min</td>
          <td><strong>Architecture</strong></td>
          <td>Present options (ES/Trie/Custom), choose one, draw the system diagram with CDN + multi-region</td>
        </tr>
        <tr>
          <td>25-32 min</td>
          <td><strong>Ranking</strong></td>
          <td>Scoring formula, cross-category allocation, match type priority</td>
        </tr>
        <tr>
          <td>32-38 min</td>
          <td><strong>Caching + Latency</strong></td>
          <td>CDN strategy, hit rates, A/B challenges, latency budget breakdown</td>
        </tr>
        <tr>
          <td>38-45 min</td>
          <td><strong>Pipeline + Extensions</strong></td>
          <td>Batch + streaming pipeline, CJK, scaling discussion, trade-off summary</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="callout callout-green" style="margin-top:20px;">
    <strong>Final Advice</strong>
    <p style="margin-bottom:0;">The autocomplete problem is deceptively simple on the surface -- "just build a Trie" -- but the depth comes from CDN caching semantics, cross-vertical ranking, i18n tokenization, and operational concerns (pipeline, validation, rollback). The best candidates treat this as a <strong>product-engineering hybrid problem</strong>: they think about what the user sees in the dropdown, not just the data structures behind it.</p>
  </div>
  </details>
</section>

</div><!-- end container -->

<!-- ===== FOOTER ===== -->
<div class="footer">
  <p><a href="index.html">&#8592; Back to All Topics</a></p>
  <p style="margin-top: 10px;">Autocomplete / Type-Ahead System &mdash; Airbnb PE-Level System Design Reference</p>
  <p style="margin-top: 5px; font-size: 0.8em; color: var(--text-muted);">Covers indexing, API design, latency management, ranking, CDN caching, data pipeline, and scaling</p>
</div>

<script>
document.querySelectorAll('.toc a[href^="#"], nav a[href^="#"]').forEach(function(link) {
  link.addEventListener('click', function() {
    var id = this.getAttribute('href').slice(1);
    var section = document.getElementById(id);
    if (section) { var d = section.querySelector('details'); if (d) d.open = true; }
  });
});
</script>

<script>
(function(){
  document.querySelectorAll(".diagram-box").forEach(function(box){
    var svg=box.querySelector("svg");
    if(!svg) return;
    var zoom=1, minZ=0.5, maxZ=3;
    var ctrl=document.createElement("div");
    ctrl.className="diagram-zoom-controls";
    ctrl.innerHTML='<button class="zoom-out" title="Zoom Out">âˆ’</button><span class="zoom-level">100%</span><button class="zoom-in" title="Zoom In">+</button><button class="zoom-reset" title="Reset">â†º</button><button class="zoom-fs" title="Fullscreen">â¤¢</button>';
    box.insertBefore(ctrl,box.firstChild);
    var lvl=ctrl.querySelector(".zoom-level");
    function apply(){svg.style.transform="scale("+zoom+")";lvl.textContent=Math.round(zoom*100)+"%";}
    ctrl.querySelector(".zoom-in").onclick=function(){zoom=Math.min(maxZ,zoom+0.25);apply();};
    ctrl.querySelector(".zoom-out").onclick=function(){zoom=Math.max(minZ,zoom-0.25);apply();};
    ctrl.querySelector(".zoom-reset").onclick=function(){zoom=1;apply();};
    ctrl.querySelector(".zoom-fs").onclick=function(){
      box.classList.toggle("fullscreen");
      if(box.classList.contains("fullscreen")){this.textContent="âœ–";zoom=1.2;}else{this.textContent="â¤¢";zoom=1;}
      apply();
    };
    box.addEventListener("wheel",function(e){
      if(e.ctrlKey){e.preventDefault();zoom=e.deltaY<0?Math.min(maxZ,zoom+0.1):Math.max(minZ,zoom-0.1);apply();}
    },{passive:false});
  });
})();
</script>
</body>
</html>