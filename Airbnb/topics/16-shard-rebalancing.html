<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shard Rebalancing for Payment Systems - Airbnb System Design</title>
<style>
  :root {
    --primary: #FF5A5F;
    --primary-dark: #E04850;
    --secondary: #00A699;
    --accent: #FC642D;
    --purple: #7B2FF7;
    --blue: #428BF9;
    --dark: #ffffff;
    --darker: #f1f5f9;
    --card-bg: #ffffff;
    --card-border: #e2e8f0;
    --text: #1e293b;
    --text-muted: #4b5563;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--dark);
    color: var(--text);
    line-height: 1.7;
    scroll-behavior: smooth;
  }
  .hero {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #6B73FF 100%);
    padding: 70px 40px 60px;
    text-align: center;
    border-bottom: 3px solid var(--primary);
    position: relative;
    overflow: hidden;
  }
  .hero::before {
    content: '';
    position: absolute;
    top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: radial-gradient(circle at 30% 50%, rgba(255,90,95,0.15) 0%, transparent 50%),
                radial-gradient(circle at 70% 50%, rgba(0,166,153,0.15) 0%, transparent 50%);
    animation: pulse 8s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
  .hero .back-link {
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: #ffffff;
    text-decoration: none;
    font-size: 0.95em;
    font-weight: 600;
    padding: 10px 24px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.4);
    background: rgba(255,255,255,0.15);
    transition: all 0.3s;
    margin-bottom: 20px;
  }
  .hero .back-link:hover {
    background: rgba(255,255,255,0.25);
    border-color: #e5e7eb;
    transform: translateX(-3px);
  }
  .hero .topic-number {
    position: relative;
    display: inline-block;
    font-size: 1rem;
    font-weight: 700;
    color: var(--accent);
    background: rgba(252,100,45,0.12);
    border: 1px solid rgba(252,100,45,0.3);
    padding: 6px 20px;
    border-radius: 25px;
    margin-bottom: 18px;
    letter-spacing: 1px;
    text-transform: uppercase;
  }
  .hero h1 {
    position: relative;
    font-size: 2.8rem;
    font-weight: 800;
    margin-bottom: 14px;
    background: linear-gradient(135deg, #FF5A5F, #FC642D, #f59e0b);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .hero .subtitle {
    position: relative;
    font-size: 1.2rem;
    color: rgba(255,255,255,0.9);
    max-width: 750px;
    margin: 0 auto 28px;
  }
  .hero .tags {
    position: relative;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
  }
  .hero .tag {
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 0.82rem;
    font-weight: 600;
    border: 1px solid;
  }
  .tag-red { color: var(--primary); border-color: rgba(255,90,95,0.3); background: rgba(255,90,95,0.1); }
  .tag-teal { color: var(--secondary); border-color: rgba(0,166,153,0.3); background: rgba(0,166,153,0.1); }
  .tag-orange { color: var(--accent); border-color: rgba(252,100,45,0.3); background: rgba(252,100,45,0.1); }
  .tag-purple { color: var(--purple); border-color: rgba(123,47,247,0.3); background: rgba(123,47,247,0.1); }
  .tag-blue { color: var(--blue); border-color: rgba(66,139,249,0.3); background: rgba(66,139,249,0.08); }

  .container { max-width: 1100px; margin: 0 auto; padding: 40px 24px; }

  .nav-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 10px;
    margin-bottom: 50px;
  }
  .nav-card {
    background: var(--card-bg);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 10px;
    padding: 12px 14px;
    text-decoration: none;
    color: var(--text-muted);
    font-size: 0.8rem;
    font-weight: 600;
    transition: all 0.3s;
    text-align: center;
  }
  .nav-card:hover {
    border-color: var(--primary);
    color: var(--primary);
    background: rgba(255,90,95,0.06);
    transform: translateY(-2px);
  }

  .section { margin-bottom: 55px; }
  .section-label {
    display: inline-block;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 2px;
    padding: 4px 14px;
    border-radius: 6px;
    margin-bottom: 12px;
  }
  .label-red { color: var(--primary); background: rgba(255,90,95,0.1); }
  .label-teal { color: var(--secondary); background: rgba(0,166,153,0.1); }
  .label-orange { color: var(--accent); background: rgba(252,100,45,0.1); }
  .label-purple { color: var(--purple); background: rgba(123,47,247,0.1); }
  .label-blue { color: var(--blue); background: rgba(66,139,249,0.08); }
  .label-yellow { color: var(--warning); background: rgba(245,158,11,0.1); }
  .label-green { color: var(--success); background: rgba(16,185,129,0.1); }
  .label-danger { color: var(--danger); background: rgba(239,68,68,0.1); }

  .section h2 {
    font-size: 1.9rem;
    font-weight: 700;
    margin-bottom: 20px;
    color: var(--text);
  }
  .section h3 {
    font-size: 1.35rem;
    font-weight: 700;
    margin: 28px 0 14px;
    color: var(--text);
  }
  .section p, .section li {
    color: var(--text-muted);
    font-size: 1rem;
    line-height: 1.8;
  }
  .section ul, .section ol {
    padding-left: 24px;
    margin: 12px 0;
  }
  .section li { margin-bottom: 6px; }

  .card {
    background: var(--card-bg);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 14px;
    padding: 28px;
    margin: 18px 0;
  }
  .card-accent-red { border-left: 4px solid var(--primary); }
  .card-accent-teal { border-left: 4px solid var(--secondary); }
  .card-accent-orange { border-left: 4px solid var(--accent); }
  .card-accent-purple { border-left: 4px solid var(--purple); }
  .card-accent-blue { border-left: 4px solid var(--blue); }
  .card-accent-green { border-left: 4px solid var(--success); }
  .card-accent-yellow { border-left: 4px solid var(--warning); }
  .card-accent-danger { border-left: 4px solid var(--danger); }

  .card h4 {
    font-size: 1.15rem;
    font-weight: 700;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 18px; }
  @media (max-width: 768px) {
    .grid-2, .grid-3 { grid-template-columns: 1fr; }
    .hero h1 { font-size: 2rem; }
  }

  .code-block {
    background: #f6f8fa;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 22px;
    margin: 16px 0;
    overflow-x: auto;
    font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
    font-size: 0.88rem;
    line-height: 1.7;
    color: #24292f;
  }
  .code-block .kw { color: #cf222e; }
  .code-block .fn { color: #8250df; }
  .code-block .str { color: #0a3069; }
  .code-block .cm { color: #6e7781; font-style: italic; }
  .code-block .type { color: #0550ae; }
  .code-block .num { color: #f59e0b; }
  .code-block .op { color: #cf222e; }

  .diagram-box {
    background: rgba(0,0,0,0.05);
    border-radius: 12px;
    padding: 20px;
    overflow-x: auto;
    margin: 20px 0;
  }
  .flow-diagram {
    background: #f6f8fa;
    border: 1px solid #e5e7eb;
    border-radius: 14px;
    padding: 30px;
    margin: 20px 0;
    text-align: center;
    font-family: 'Cascadia Code', 'Fira Code', monospace;
    overflow-x: auto;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  }
  .flow-diagram .flow-title {
    font-size: 0.85rem;
    color: var(--purple);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 18px;
  }
  .flow-diagram pre {
    color: var(--text-muted);
    font-size: 0.82rem;
    line-height: 1.6;
    display: inline-block;
    text-align: left;
  }

  .step-flow {
    display: flex;
    align-items: center;
    gap: 0;
    flex-wrap: wrap;
    margin: 18px 0;
    justify-content: center;
  }
  .step-box {
    background: var(--card-bg);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 10px;
    padding: 12px 18px;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text);
    text-align: center;
    min-width: 120px;
  }
  .step-arrow {
    color: var(--accent);
    font-size: 1.3rem;
    padding: 0 6px;
    font-weight: 700;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin: 16px 0;
    font-size: 0.92rem;
  }
  th {
    background: rgba(255,90,95,0.1);
    color: var(--primary);
    font-weight: 700;
    text-align: left;
    padding: 14px 16px;
    border-bottom: 2px solid var(--primary);
  }
  td {
    padding: 12px 16px;
    border-bottom: 1px solid var(--card-border);
    color: var(--text-muted);
  }
  tr:hover td { background: rgba(123,47,247,0.04); }

  .badge {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 6px;
    font-size: 0.78rem;
    font-weight: 700;
  }
  .badge-green { color: var(--success); background: rgba(16,185,129,0.15); }
  .badge-yellow { color: var(--warning); background: rgba(245,158,11,0.15); }
  .badge-red { color: var(--danger); background: rgba(239,68,68,0.15); }
  .badge-blue { color: var(--blue); background: rgba(66,139,249,0.08); }
  .badge-purple { color: var(--purple); background: rgba(123,47,247,0.15); }

  .callout {
    border-radius: 12px;
    padding: 20px 24px;
    margin: 18px 0;
    display: flex;
    gap: 14px;
    align-items: flex-start;
  }
  .callout-warn {
    background: rgba(245,158,11,0.06);
    border: 1px solid rgba(245,158,11,0.25);
  }
  .callout-danger {
    background: rgba(239,68,68,0.06);
    border: 1px solid rgba(239,68,68,0.25);
  }
  .callout-info {
    background: rgba(66,139,249,0.08);
    border: 1px solid rgba(66,139,249,0.25);
  }
  .callout-success {
    background: rgba(16,185,129,0.06);
    border: 1px solid rgba(16,185,129,0.25);
  }
  .callout .callout-icon { font-size: 1.4rem; flex-shrink: 0; }
  .callout .callout-text { font-size: 0.95rem; color: var(--text-muted); line-height: 1.7; }
  .callout .callout-text strong { color: var(--text); }

  .metric-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 14px;
    margin: 18px 0;
  }
  .metric-box {
    background: var(--card-bg);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
  }
  .metric-box .metric-val {
    font-size: 1.8rem;
    font-weight: 800;
    margin-bottom: 4px;
  }
  .metric-box .metric-label {
    font-size: 0.82rem;
    color: var(--text-muted);
    font-weight: 600;
  }

  .tip-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
    margin-top: 14px;
  }
  @media (max-width: 768px) { .tip-grid { grid-template-columns: 1fr; } }
  .tip-item {
    background: var(--card-bg);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 10px;
    padding: 18px;
  }
  .tip-item .tip-q {
    font-size: 0.9rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 8px;
  }
  .tip-item .tip-a {
    font-size: 0.88rem;
    color: var(--text-muted);
    line-height: 1.7;
  }

  .compare-header {
    text-align: center;
    padding: 16px;
    border-radius: 12px 12px 0 0;
    font-weight: 700;
    font-size: 1.05rem;
    letter-spacing: 0.5px;
  }

  .progress-bar {
    height: 8px;
    border-radius: 4px;
    background: var(--card-border);
    overflow: hidden;
    margin: 8px 0;
  }
  .progress-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.5s;
  }

  .timeline {
    position: relative;
    padding-left: 32px;
    margin: 18px 0;
  }
  .timeline::before {
    content: '';
    position: absolute;
    left: 12px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: linear-gradient(to bottom, var(--primary), var(--secondary), var(--purple));
  }
  .timeline-item {
    position: relative;
    margin-bottom: 22px;
    padding: 16px 20px;
    background: var(--card-bg);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 10px;
  }
  .timeline-item::before {
    content: '';
    position: absolute;
    left: -26px;
    top: 20px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--primary);
    border: 2px solid var(--dark);
  }
  .timeline-item .step-num {
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--accent);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 4px;
  }
  .timeline-item h4 {
    font-size: 1rem;
    color: var(--text);
    margin-bottom: 6px;
  }
  .timeline-item p {
    font-size: 0.9rem;
    color: var(--text-muted);
  }
  /* ===== RESPONSIVE ===== */
  @media (max-width: 768px) {
    .hero { padding: 36px 16px 30px; }
    .hero h1 { font-size: 1.7em; }
    .hero .subtitle { font-size: 0.95em; }
    .hero .back-link { font-size: 0.85em; padding: 8px 16px; }
    .hero .stats-row { gap: 16px; margin-top: 18px; }
    .hero .stat-value { font-size: 1.4em; }
    .hero .stat-label { font-size: 0.7em; }
    .toc { padding: 14px 16px; }
    .toc-grid { gap: 6px; }
    .toc a { padding: 5px 12px; font-size: 0.78em; }
    .container { padding: 16px 12px; }
    .card-grid, .card-grid-3, .pricing-grid, .comparison { grid-template-columns: 1fr; gap: 14px; }
    section { padding: 24px 0; }
    section > h2 { font-size: 1.25em; }
    table { font-size: 0.82em; display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    th, td { padding: 8px 10px; white-space: nowrap; }
    pre { font-size: 0.82em; padding: 14px; overflow-x: auto; }
    .diagram-box { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .diagram-box svg { min-width: 600px; }
    footer { padding: 24px 16px; font-size: 0.8em; }
  }
  @media (max-width: 480px) {
    .hero { padding: 28px 12px 22px; }
    .hero h1 { font-size: 1.35em; line-height: 1.3; }
    .hero .subtitle { font-size: 0.85em; }
    .hero .back-link { font-size: 0.78em; padding: 6px 12px; }
    .hero .stats-row { gap: 8px; }
    .hero .stat-value { font-size: 1.15em; }
    .container { padding: 14px 10px; }
    .toc a { padding: 4px 10px; font-size: 0.72em; }
    section > h2 { font-size: 1.1em; }
    .badge { padding: 3px 10px; font-size: 0.7em; }
    pre { font-size: 0.75em; padding: 10px; }
    table { font-size: 0.75em; }
    th, td { padding: 6px 8px; }
    footer { padding: 18px 12px; }
  }
  @media (max-width: 360px) {
    .hero h1 { font-size: 1.15em; }
    .hero .stat-value { font-size: 1em; }
    .container { padding: 10px 8px; }
  }

  /* === DIAGRAM ZOOM CONTROLS === */
  .diagram-box { position: relative; }
  .diagram-zoom-controls {
    position: absolute; top: 12px; right: 12px; z-index: 10;
    display: flex; gap: 4px; opacity: 0.5; transition: opacity 0.3s;
  }
  .diagram-box:hover .diagram-zoom-controls { opacity: 1; }
  .diagram-zoom-controls button {
    width: 32px; height: 32px; border-radius: 8px; border: 1px solid #e5e7eb;
    background: #ffffff; color: #1e293b; cursor: pointer; font-size: 16px;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.2s;
    font-family: system-ui; line-height: 1; padding: 0;
  }
  .diagram-zoom-controls button:hover { background: #f1f5f9; border-color: var(--blue); color: var(--blue); }
  .diagram-zoom-controls button:active { transform: scale(0.95); }
  .diagram-zoom-controls .zoom-level {
    font-size: 11px; color: #64748b; display: flex; align-items: center;
    padding: 0 6px; font-weight: 600; min-width: 40px; justify-content: center;
  }
  .diagram-box svg { transition: transform 0.3s ease; transform-origin: center center; }
  .diagram-box.fullscreen {
    position: fixed !important; top: 0; left: 0; width: 100vw; height: 100vh;
    z-index: 9999; background: #ffffff; border-radius: 0; padding: 20px;
    display: flex; align-items: center; justify-content: center;
    overflow: auto;
  }
  .diagram-box.fullscreen .diagram-zoom-controls { opacity: 1; top: 20px; right: 20px; }

  /* ===== COLLAPSIBLE SECTIONS ===== */
  details { margin-bottom: 0; }
  details summary { cursor: pointer; list-style: none; user-select: none; padding: 0; }
  details summary::-webkit-details-marker { display: none; }
  details summary::marker { display: none; content: ''; }
  details summary h2 { display: inline-flex; }
  details summary h2::before {
    content: '\25B6'; display: inline-flex; align-items: center;
    margin-right: 8px; transition: transform 0.2s; font-size: 0.5em; color: var(--text-muted);
  }
  details[open] summary h2::before { transform: rotate(90deg); }
  .toggle-controls { display: flex; gap: 8px; margin-top: 10px; }
  .toggle-controls button {
    padding: 5px 14px; border-radius: 8px; border: 1px solid #e5e7eb;
    background: var(--card-bg); color: var(--text-muted); font-size: 0.78em;
    cursor: pointer; transition: all 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  }
  .toggle-controls button:hover { color: var(--purple); border-color: var(--purple); background: rgba(123,47,247,0.1); }
</style>
</head>
<body>

<!-- ============ HERO + NAV ============ -->
<div class="hero">
  <a href="index.html" class="back-link">&#8592; Back to All Topics</a>
  <div class="topic-number">Topic 16</div>
  <h1>Shard Rebalancing for Payment Systems</h1>
  <p class="subtitle">Rebalance payment data across shards without compromising consistency -- zero downtime, zero data loss, no double-charges.</p>
  <div class="tags">
    <span class="tag tag-red">Sharding</span>
    <span class="tag tag-teal">Payments</span>
    <span class="tag tag-orange">Consistency</span>
    <span class="tag tag-purple">Data Migration</span>
    <span class="tag tag-blue">PE-Level</span>
  </div>
</div>

<div class="container">

  <!-- NAV CARDS -->
  <div class="nav-cards">
    <a href="#overview" class="nav-card">Overview</a>
    <a href="#requirements" class="nav-card">Requirements</a>
    <a href="#why-hard" class="nav-card">Why It's Hard</a>
    <a href="#strategies" class="nav-card">Sharding Strategies</a>
    <a href="#approaches" class="nav-card">3 Approaches</a>
    <a href="#routing" class="nav-card">Routing Layer</a>
    <a href="#consistency" class="nav-card">Consistency</a>
    <a href="#verification" class="nav-card">Verification</a>
    <a href="#data-model" class="nav-card">Data Model</a>
    <a href="#tradeoffs" class="nav-card">Trade-offs</a>
    <a href="#monitoring" class="nav-card">Monitoring</a>
    <a href="#interview" class="nav-card">Interview Tips</a>
  </div>
  <div class="toggle-controls">
    <button onclick="document.querySelectorAll('.container details').forEach(d=>d.open=true)">Expand All</button>
    <button onclick="document.querySelectorAll('.container details').forEach(d=>d.open=false)">Collapse All</button>
  </div>

  <!-- ============ 1. OVERVIEW ============ -->
  <div class="section" id="overview">
<details open>
    <span class="section-label label-red">Section 1</span>
    <summary><h2>Overview: The Problem</h2></summary>
    <p>Airbnb processes millions of payments daily across a sharded PostgreSQL cluster. Over time, organic growth creates <strong>hot shards</strong> -- two shards now handle 60% of all payment traffic while four others sit nearly idle. We need to add new shards and redistribute data without any downtime, zero data loss, and absolutely no double-charges.</p>

    <div class="metric-row">
      <div class="metric-box">
        <div class="metric-val" style="color: var(--danger);">2</div>
        <div class="metric-label">Hot Shards (overloaded)</div>
      </div>
      <div class="metric-box">
        <div class="metric-val" style="color: var(--warning);">60%</div>
        <div class="metric-label">Traffic on Hot Shards</div>
      </div>
      <div class="metric-box">
        <div class="metric-val" style="color: #1e293b;">8</div>
        <div class="metric-label">Target Shard Count</div>
      </div>
      <div class="metric-box">
        <div class="metric-val" style="color: var(--success);">0</div>
        <div class="metric-label">Acceptable Data Loss</div>
      </div>
    </div>

    <div class="diagram-box">
      <svg viewBox="0 0 1100 550" xmlns="http://www.w3.org/2000/svg" font-family="Segoe UI, system-ui, sans-serif">
        <defs>
          <filter id="shadow2" x="-4%" y="-4%" width="108%" height="116%">
            <feDropShadow dx="0" dy="2" stdDeviation="3" flood-color="#000" flood-opacity="0.5"/>
          </filter>
          <linearGradient id="routerGrad" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#FF5A5F"/>
            <stop offset="100%" stop-color="#E04850"/>
          </linearGradient>
          <linearGradient id="appGrad" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#6366f1"/>
            <stop offset="100%" stop-color="#4f46e5"/>
          </linearGradient>
          <linearGradient id="gearGrad" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#FC642D"/>
            <stop offset="100%" stop-color="#e05520"/>
          </linearGradient>
          <linearGradient id="migrWorkerGrad" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#7B2FF7"/>
            <stop offset="100%" stop-color="#6320d0"/>
          </linearGradient>
          <linearGradient id="verifyGrad" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#10b981"/>
            <stop offset="100%" stop-color="#059669"/>
          </linearGradient>
          <marker id="arr2" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
            <polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8"/>
          </marker>
          <marker id="arr2a" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
            <polygon points="0 0, 10 3.5, 0 7" fill="#f59e0b"/>
          </marker>
          <marker id="arr2g" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
            <polygon points="0 0, 10 3.5, 0 7" fill="#10b981"/>
          </marker>
          <marker id="arr2r" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
            <polygon points="0 0, 10 3.5, 0 7" fill="#ef4444"/>
          </marker>
        </defs>

        <!-- ===== TOP: Application Layer ===== -->
        <g filter="url(#shadow2)">
          <rect x="80" y="10" width="140" height="50" rx="10" fill="url(#appGrad)" stroke="#818cf8" stroke-width="1.5"/>
          <text x="150" y="33" text-anchor="middle" fill="#fff" font-size="11" font-weight="700">Application</text>
          <text x="150" y="48" text-anchor="middle" fill="#c7d2fe" font-size="9">Layer</text>
        </g>

        <!-- Shard Router (load-balancer icon) -->
        <g filter="url(#shadow2)">
          <rect x="290" y="10" width="160" height="50" rx="10" fill="url(#routerGrad)" stroke="#FF5A5F" stroke-width="1.5"/>
          <!-- load balancer icon: circle with arrows spreading -->
          <circle cx="318" cy="35" r="12" fill="none" stroke="#fff" stroke-width="1.2"/>
          <line x1="318" y1="23" x2="318" y2="28" stroke="#fff" stroke-width="1.2"/>
          <line x1="318" y1="42" x2="318" y2="47" stroke="#fff" stroke-width="1.2"/>
          <line x1="306" y1="35" x2="311" y2="35" stroke="#fff" stroke-width="1.2"/>
          <line x1="325" y1="35" x2="330" y2="35" stroke="#fff" stroke-width="1.2"/>
          <text x="395" y="33" text-anchor="middle" fill="#fff" font-size="11" font-weight="700">Shard Router</text>
          <text x="395" y="48" text-anchor="middle" fill="#fecaca" font-size="8">routes by vShard</text>
        </g>
        <!-- Arrow: App -> Router -->
        <line x1="220" y1="35" x2="287" y2="35" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arr2)"/>

        <!-- etcd / ZooKeeper config box -->
        <g filter="url(#shadow2)">
          <rect x="510" y="10" width="130" height="50" rx="8" fill="#f8fafc" stroke="#f59e0b" stroke-width="1.5"/>
          <text x="575" y="30" text-anchor="middle" fill="#f59e0b" font-size="10" font-weight="700">etcd / ZooKeeper</text>
          <text x="575" y="44" text-anchor="middle" fill="#94a3b8" font-size="8">vShard -> node map</text>
          <text x="575" y="54" text-anchor="middle" fill="#94a3b8" font-size="7">Raft consensus</text>
        </g>
        <!-- Arrow: Router reads from etcd -->
        <line x1="450" y1="35" x2="507" y2="35" stroke="#f59e0b" stroke-width="1.2" stroke-dasharray="5,3" marker-end="url(#arr2a)"/>
        <text x="478" y="28" text-anchor="middle" fill="#94a3b8" font-size="7">reads config</text>

        <!-- ===== BEFORE STATE (left) ===== -->
        <rect x="20" y="80" width="230" height="195" rx="10" fill="rgba(239,68,68,0.05)" stroke="rgba(239,68,68,0.3)" stroke-width="1"/>
        <text x="135" y="100" text-anchor="middle" fill="#ef4444" font-size="12" font-weight="700">BEFORE (Unbalanced)</text>

        <!-- Shard A (hot) - DB cylinder -->
        <g filter="url(#shadow2)" transform="translate(40, 110)">
          <rect x="0" y="8" width="80" height="40" fill="#1a2744" stroke="#ef4444" stroke-width="1.5"/>
          <ellipse cx="40" cy="8" rx="40" ry="8" fill="#1a2744" stroke="#ef4444" stroke-width="1.5"/>
          <ellipse cx="40" cy="48" rx="40" ry="8" fill="#1a2744" stroke="#ef4444" stroke-width="1.5"/>
          <text x="40" y="30" text-anchor="middle" fill="#ef4444" font-size="9" font-weight="700">Shard A</text>
          <text x="40" y="42" text-anchor="middle" fill="#fca5a5" font-size="8">HOT!</text>
        </g>
        <text x="130" y="142" fill="#f59e0b" font-size="14">&#128293;</text>
        <text x="145" y="150" fill="#ef4444" font-size="10" font-weight="700">60%</text>
        <text x="145" y="162" fill="#94a3b8" font-size="8">traffic</text>

        <!-- Shard B (hot) -->
        <g filter="url(#shadow2)" transform="translate(40, 185)">
          <rect x="0" y="8" width="80" height="40" fill="#1a2744" stroke="#ef4444" stroke-width="1.5"/>
          <ellipse cx="40" cy="8" rx="40" ry="8" fill="#1a2744" stroke="#ef4444" stroke-width="1.5"/>
          <ellipse cx="40" cy="48" rx="40" ry="8" fill="#1a2744" stroke="#ef4444" stroke-width="1.5"/>
          <text x="40" y="30" text-anchor="middle" fill="#ef4444" font-size="9" font-weight="700">Shard B</text>
          <text x="40" y="42" text-anchor="middle" fill="#fca5a5" font-size="8">HOT!</text>
        </g>
        <text x="130" y="217" fill="#f59e0b" font-size="14">&#128293;</text>
        <text x="145" y="225" fill="#ef4444" font-size="10" font-weight="700">40%</text>
        <text x="145" y="237" fill="#94a3b8" font-size="8">traffic</text>

        <!-- ===== MIGRATION FLOW (center) ===== -->
        <rect x="270" y="80" width="240" height="260" rx="10" fill="rgba(252,100,45,0.05)" stroke="rgba(252,100,45,0.3)" stroke-width="1"/>
        <text x="390" y="100" text-anchor="middle" fill="#FC642D" font-size="12" font-weight="700">MIGRATION</text>

        <!-- CDC/Debezium (gear icon) -->
        <g filter="url(#shadow2)" transform="translate(290, 110)">
          <rect x="0" y="0" width="100" height="50" rx="8" fill="url(#gearGrad)" stroke="#FC642D" stroke-width="1.5"/>
          <!-- Gear icon -->
          <circle cx="25" cy="25" r="10" fill="none" stroke="#fff" stroke-width="1.2"/>
          <circle cx="25" cy="25" r="4" fill="none" stroke="#fff" stroke-width="1"/>
          <!-- Gear teeth -->
          <line x1="25" y1="13" x2="25" y2="17" stroke="#fff" stroke-width="2"/>
          <line x1="25" y1="33" x2="25" y2="37" stroke="#fff" stroke-width="2"/>
          <line x1="13" y1="25" x2="17" y2="25" stroke="#fff" stroke-width="2"/>
          <line x1="33" y1="25" x2="37" y2="25" stroke="#fff" stroke-width="2"/>
          <text x="68" y="22" text-anchor="middle" fill="#fff" font-size="9" font-weight="700">CDC</text>
          <text x="68" y="35" text-anchor="middle" fill="#ffe4d6" font-size="8">Debezium</text>
          <text x="68" y="46" text-anchor="middle" fill="#ffe4d6" font-size="7">reads WAL</text>
        </g>
        <!-- Arrow: Hot shards -> CDC -->
        <line x1="165" y1="150" x2="287" y2="135" stroke="#ef4444" stroke-width="1.5" marker-end="url(#arr2r)"/>
        <line x1="165" y1="225" x2="287" y2="145" stroke="#ef4444" stroke-width="1.2" marker-end="url(#arr2r)"/>

        <!-- Kafka (migration) -->
        <g filter="url(#shadow2)" transform="translate(290, 180)">
          <rect x="0" y="0" width="100" height="45" rx="8" fill="#f8fafc" stroke="#ef4444" stroke-width="1.5"/>
          <circle cx="18" cy="14" r="4" fill="none" stroke="#ef4444" stroke-width="1"/>
          <circle cx="18" cy="26" r="4" fill="none" stroke="#ef4444" stroke-width="1"/>
          <circle cx="18" cy="38" r="4" fill="none" stroke="#ef4444" stroke-width="1"/>
          <line x1="22" y1="14" x2="28" y2="14" stroke="#ef4444" stroke-width="0.8"/>
          <line x1="22" y1="26" x2="28" y2="26" stroke="#ef4444" stroke-width="0.8"/>
          <line x1="22" y1="38" x2="28" y2="38" stroke="#ef4444" stroke-width="0.8"/>
          <text x="62" y="22" text-anchor="middle" fill="#ef4444" font-size="9" font-weight="700">Kafka</text>
          <text x="62" y="36" text-anchor="middle" fill="#94a3b8" font-size="7">CDC stream</text>
        </g>
        <!-- Arrow: CDC -> Kafka -->
        <line x1="340" y1="160" x2="340" y2="177" stroke="#f59e0b" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arr2a)"/>

        <!-- Migration Workers -->
        <g filter="url(#shadow2)" transform="translate(410, 180)">
          <rect x="0" y="0" width="85" height="45" rx="8" fill="url(#migrWorkerGrad)" stroke="#a78bfa" stroke-width="1.5"/>
          <text x="42" y="19" text-anchor="middle" fill="#fff" font-size="9" font-weight="700">Migration</text>
          <text x="42" y="33" text-anchor="middle" fill="#ddd6fe" font-size="9" font-weight="700">Workers</text>
        </g>
        <!-- Arrow: Kafka -> Workers -->
        <line x1="390" y1="202" x2="407" y2="202" stroke="#f59e0b" stroke-width="1.2" stroke-dasharray="5,3" marker-end="url(#arr2a)"/>

        <!-- Numbered Steps (along migration) -->
        <g>
          <circle cx="287" cy="120" r="9" fill="#FC642D"/>
          <text x="287" y="124" text-anchor="middle" fill="#fff" font-size="8" font-weight="700">1</text>
          <text x="267" y="113" fill="#f59e0b" font-size="7" font-weight="600">Snapshot</text>
        </g>
        <g>
          <circle cx="340" cy="172" r="9" fill="#FC642D"/>
          <text x="340" y="176" text-anchor="middle" fill="#fff" font-size="8" font-weight="700">2</text>
          <text x="360" y="170" fill="#f59e0b" font-size="7" font-weight="600">CDC stream</text>
        </g>
        <g>
          <circle cx="452" cy="172" r="9" fill="#FC642D"/>
          <text x="452" y="176" text-anchor="middle" fill="#fff" font-size="8" font-weight="700">3</text>
          <text x="470" y="170" fill="#f59e0b" font-size="7" font-weight="600">Replay</text>
        </g>

        <!-- ===== AFTER STATE (right) ===== -->
        <rect x="530" y="80" width="280" height="260" rx="10" fill="rgba(16,185,129,0.05)" stroke="rgba(16,185,129,0.3)" stroke-width="1"/>
        <text x="670" y="100" text-anchor="middle" fill="#10b981" font-size="12" font-weight="700">AFTER (Balanced)</text>

        <!-- Shard 1 -->
        <g filter="url(#shadow2)" transform="translate(545, 108)">
          <rect x="0" y="6" width="55" height="34" fill="#1a2744" stroke="#428BF9" stroke-width="1.2"/>
          <ellipse cx="27" cy="6" rx="27.5" ry="6" fill="#1a2744" stroke="#428BF9" stroke-width="1.2"/>
          <ellipse cx="27" cy="40" rx="27.5" ry="6" fill="#1a2744" stroke="#428BF9" stroke-width="1.2"/>
          <text x="27" y="26" text-anchor="middle" fill="#428BF9" font-size="8" font-weight="700">Shard 1</text>
        </g>
        <text x="610" y="132" fill="#10b981" font-size="9" font-weight="600">25%</text>

        <!-- Shard 2 -->
        <g filter="url(#shadow2)" transform="translate(640, 108)">
          <rect x="0" y="6" width="55" height="34" fill="#1a2744" stroke="#428BF9" stroke-width="1.2"/>
          <ellipse cx="27" cy="6" rx="27.5" ry="6" fill="#1a2744" stroke="#428BF9" stroke-width="1.2"/>
          <ellipse cx="27" cy="40" rx="27.5" ry="6" fill="#1a2744" stroke="#428BF9" stroke-width="1.2"/>
          <text x="27" y="26" text-anchor="middle" fill="#428BF9" font-size="8" font-weight="700">Shard 2</text>
        </g>
        <text x="705" y="132" fill="#10b981" font-size="9" font-weight="600">25%</text>

        <!-- Shard 3 -->
        <g filter="url(#shadow2)" transform="translate(735, 108)">
          <rect x="0" y="6" width="55" height="34" fill="#1a2744" stroke="#428BF9" stroke-width="1.2"/>
          <ellipse cx="27" cy="6" rx="27.5" ry="6" fill="#1a2744" stroke="#428BF9" stroke-width="1.2"/>
          <ellipse cx="27" cy="40" rx="27.5" ry="6" fill="#1a2744" stroke="#428BF9" stroke-width="1.2"/>
          <text x="27" y="26" text-anchor="middle" fill="#428BF9" font-size="8" font-weight="700">Shard 3</text>
        </g>

        <!-- Shard 4 -->
        <g filter="url(#shadow2)" transform="translate(545, 170)">
          <rect x="0" y="6" width="55" height="34" fill="#1a2744" stroke="#428BF9" stroke-width="1.2"/>
          <ellipse cx="27" cy="6" rx="27.5" ry="6" fill="#1a2744" stroke="#428BF9" stroke-width="1.2"/>
          <ellipse cx="27" cy="40" rx="27.5" ry="6" fill="#1a2744" stroke="#428BF9" stroke-width="1.2"/>
          <text x="27" y="26" text-anchor="middle" fill="#428BF9" font-size="8" font-weight="700">Shard 4</text>
        </g>
        <text x="610" y="194" fill="#10b981" font-size="9" font-weight="600">25%</text>

        <!-- Arrow: Workers -> new shards -->
        <path d="M 495 202 Q 515 202 530 170" fill="none" stroke="#10b981" stroke-width="1.5" marker-end="url(#arr2g)"/>

        <!-- Label: evenly balanced -->
        <rect x="640" y="175" width="150" height="22" rx="6" fill="rgba(16,185,129,0.1)" stroke="rgba(16,185,129,0.3)" stroke-width="1"/>
        <text x="715" y="190" text-anchor="middle" fill="#10b981" font-size="8" font-weight="600">Evenly balanced at 25% each</text>

        <!-- ===== VERIFICATION ===== -->
        <g filter="url(#shadow2)" transform="translate(290, 250)">
          <rect x="0" y="0" width="120" height="50" rx="8" fill="url(#verifyGrad)" stroke="#10b981" stroke-width="1.5"/>
          <!-- Checkmark icon -->
          <polyline points="18,22 26,32 40,15" fill="none" stroke="#fff" stroke-width="2"/>
          <text x="80" y="22" text-anchor="middle" fill="#fff" font-size="9" font-weight="700">Checksum</text>
          <text x="80" y="36" text-anchor="middle" fill="#d1fae5" font-size="9" font-weight="700">Verifier</text>
          <text x="80" y="46" text-anchor="middle" fill="#d1fae5" font-size="7">src vs target</text>
        </g>
        <circle cx="285" cy="265" r="9" fill="#FC642D"/>
        <text x="285" y="269" text-anchor="middle" fill="#fff" font-size="8" font-weight="700">4</text>
        <text x="265" y="258" fill="#f59e0b" font-size="7" font-weight="600">Verify</text>

        <!-- Arrow: Verifier -> left (source comparison) -->
        <line x1="290" y1="287" x2="170" y2="255" stroke="#94a3b8" stroke-width="1" stroke-dasharray="4,3" marker-end="url(#arr2)"/>
        <!-- Arrow: Verifier -> right (target comparison) -->
        <line x1="410" y1="275" x2="540" y2="200" stroke="#94a3b8" stroke-width="1" stroke-dasharray="4,3" marker-end="url(#arr2)"/>

        <!-- ===== ROUTING (bottom) ===== -->
        <rect x="20" y="350" width="790" height="90" rx="10" fill="rgba(245,158,11,0.05)" stroke="rgba(245,158,11,0.3)" stroke-width="1"/>
        <text x="415" y="370" text-anchor="middle" fill="#f59e0b" font-size="11" font-weight="700">ROUTING LAYER</text>

        <!-- etcd (in routing section) -->
        <g filter="url(#shadow2)" transform="translate(40, 380)">
          <rect x="0" y="0" width="160" height="45" rx="8" fill="#f8fafc" stroke="#f59e0b" stroke-width="1.5"/>
          <text x="80" y="18" text-anchor="middle" fill="#f59e0b" font-size="10" font-weight="700">etcd Cluster</text>
          <text x="80" y="32" text-anchor="middle" fill="#94a3b8" font-size="8">virtual_shard -> physical_node</text>
          <text x="80" y="42" text-anchor="middle" fill="#94a3b8" font-size="7">atomic metadata updates</text>
        </g>

        <!-- Shard Router (in routing section) -->
        <g filter="url(#shadow2)" transform="translate(260, 380)">
          <rect x="0" y="0" width="160" height="45" rx="8" fill="url(#routerGrad)" stroke="#FF5A5F" stroke-width="1.5"/>
          <text x="80" y="18" text-anchor="middle" fill="#fff" font-size="10" font-weight="700">Shard Router</text>
          <text x="80" y="32" text-anchor="middle" fill="#fecaca" font-size="8">consults etcd</text>
          <text x="80" y="42" text-anchor="middle" fill="#fecaca" font-size="7">cached lookup + watch</text>
        </g>
        <!-- Arrow: etcd -> Router -->
        <line x1="200" y1="402" x2="257" y2="402" stroke="#f59e0b" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arr2a)"/>

        <!-- Step 5: Switch routing -->
        <circle cx="460" cy="395" r="9" fill="#FC642D"/>
        <text x="460" y="399" text-anchor="middle" fill="#fff" font-size="8" font-weight="700">5</text>
        <text x="500" y="392" fill="#f59e0b" font-size="8" font-weight="600">Switch</text>
        <text x="500" y="404" fill="#f59e0b" font-size="8" font-weight="600">routing</text>

        <!-- Step 6: Cleanup -->
        <g filter="url(#shadow2)" transform="translate(560, 380)">
          <rect x="0" y="0" width="120" height="45" rx="8" fill="#f8fafc" stroke="#94a3b8" stroke-width="1.5"/>
          <text x="60" y="18" text-anchor="middle" fill="#94a3b8" font-size="10" font-weight="700">Cleanup</text>
          <text x="60" y="32" text-anchor="middle" fill="#94a3b8" font-size="8">delete old shard data</text>
          <text x="60" y="42" text-anchor="middle" fill="#94a3b8" font-size="7">after 7-day safety</text>
        </g>
        <circle cx="555" cy="395" r="9" fill="#FC642D"/>
        <text x="555" y="399" text-anchor="middle" fill="#fff" font-size="8" font-weight="700">6</text>
        <text x="543" y="387" fill="#f59e0b" font-size="7" font-weight="600">Cleanup</text>

        <!-- Connection: Router to top Router -->
        <path d="M 340 380 L 340 340 L 370 60" fill="none" stroke="rgba(255,90,95,0.3)" stroke-width="1" stroke-dasharray="3,3"/>

        <!-- ===== LEGEND ===== -->
        <g transform="translate(830, 20)">
          <rect x="0" y="0" width="250" height="170" rx="10" fill="rgba(30,41,59,0.8)" stroke="#334155" stroke-width="1"/>
          <text x="125" y="20" text-anchor="middle" fill="#1e293b" font-size="10" font-weight="700">Migration Steps</text>

          <circle cx="20" cy="40" r="8" fill="#FC642D"/>
          <text x="20" y="44" text-anchor="middle" fill="#fff" font-size="7" font-weight="700">1</text>
          <text x="38" y="44" fill="#94a3b8" font-size="9">Snapshot hot shards</text>

          <circle cx="20" cy="62" r="8" fill="#FC642D"/>
          <text x="20" y="66" text-anchor="middle" fill="#fff" font-size="7" font-weight="700">2</text>
          <text x="38" y="66" fill="#94a3b8" font-size="9">CDC stream via Kafka</text>

          <circle cx="20" cy="84" r="8" fill="#FC642D"/>
          <text x="20" y="88" text-anchor="middle" fill="#fff" font-size="7" font-weight="700">3</text>
          <text x="38" y="88" fill="#94a3b8" font-size="9">Replay to new shards</text>

          <circle cx="20" cy="106" r="8" fill="#FC642D"/>
          <text x="20" y="110" text-anchor="middle" fill="#fff" font-size="7" font-weight="700">4</text>
          <text x="38" y="110" fill="#94a3b8" font-size="9">Verify checksums</text>

          <circle cx="20" cy="128" r="8" fill="#FC642D"/>
          <text x="20" y="132" text-anchor="middle" fill="#fff" font-size="7" font-weight="700">5</text>
          <text x="38" y="132" fill="#94a3b8" font-size="9">Switch routing (atomic)</text>

          <circle cx="20" cy="150" r="8" fill="#FC642D"/>
          <text x="20" y="154" text-anchor="middle" fill="#fff" font-size="7" font-weight="700">6</text>
          <text x="38" y="154" fill="#94a3b8" font-size="9">Cleanup old data</text>
        </g>

        <!-- Legend line styles -->
        <g transform="translate(830, 210)">
          <rect x="0" y="0" width="250" height="70" rx="8" fill="rgba(30,41,59,0.8)" stroke="#334155" stroke-width="1"/>
          <line x1="15" y1="20" x2="50" y2="20" stroke="#94a3b8" stroke-width="1.5"/>
          <text x="60" y="24" fill="#94a3b8" font-size="9">Sync flow (solid)</text>
          <line x1="15" y1="42" x2="50" y2="42" stroke="#f59e0b" stroke-width="1.5" stroke-dasharray="5,3"/>
          <text x="60" y="46" fill="#94a3b8" font-size="9">Async / config read (dashed)</text>
          <line x1="15" y1="60" x2="50" y2="60" stroke="#ef4444" stroke-width="1.5"/>
          <text x="60" y="64" fill="#94a3b8" font-size="9">Data migration flow</text>
        </g>

        <!-- ===== 10-STEP NUMBERED CIRCLES ===== -->
        <!-- Step 1: Application -> Shard Router -->
        <circle cx="255" cy="22" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/>
        <text x="255" y="26" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">1</text>

        <!-- Step 2: Shard Router -> etcd/ZooKeeper lookup -->
        <circle cx="480" cy="22" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/>
        <text x="480" y="26" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">2</text>

        <!-- Step 3: Migration starts: Snapshot hot shard data -->
        <circle cx="230" cy="142" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/>
        <text x="230" y="146" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">3</text>

        <!-- Step 4: Debezium CDC reads WAL from source shard -->
        <circle cx="370" cy="118" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/>
        <text x="370" y="122" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">4</text>

        <!-- Step 5: CDC events -> Kafka stream -->
        <circle cx="325" cy="172" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/>
        <text x="325" y="176" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">5</text>

        <!-- Step 6: Migration Workers consume Kafka -> write to target -->
        <circle cx="430" cy="172" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/>
        <text x="430" y="176" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">6</text>

        <!-- Step 7: Checksum Verifier compares source vs target -->
        <circle cx="395" cy="253" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/>
        <text x="395" y="257" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">7</text>

        <!-- Step 8: Brief write pause (circuit breaker) -->
        <circle cx="340" cy="335" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/>
        <text x="340" y="339" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">8</text>

        <!-- Step 9: etcd routing table updated atomically -->
        <circle cx="215" cy="395" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/>
        <text x="215" y="399" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">9</text>

        <!-- Step 10: Old shard data cleaned up -->
        <circle cx="695" cy="395" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/>
        <text x="695" y="399" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">10</text>

        <!-- Title watermark -->
        <text x="550" y="540" text-anchor="middle" fill="rgba(148,163,184,0.3)" font-size="14" font-weight="700" letter-spacing="3">SHARD REBALANCING ARCHITECTURE</text>
      </svg>
    </div>

    <!-- ===== REQUEST FLOW REFERENCE ===== -->
    <h3 style="margin-top: 28px;">Request Flow Reference</h3>
    <table>
      <thead>
        <tr><th>Step</th><th>From</th><th>To</th><th>Action</th><th>Protocol / Notes</th></tr>
      </thead>
      <tbody>
        <tr><td><strong>1</strong></td><td>Application</td><td>Shard Router</td><td>Every request routed</td><td>Routed by virtual shard (vShard) key</td></tr>
        <tr><td><strong>2</strong></td><td>Shard Router</td><td>etcd / ZooKeeper</td><td>Lookup mapping</td><td>vShard &rarr; physical node mapping (Raft consensus)</td></tr>
        <tr><td><strong>3</strong></td><td>Orchestrator</td><td>Source Shard</td><td>Snapshot hot shard data</td><td>Consistent snapshot before CDC begins</td></tr>
        <tr><td><strong>4</strong></td><td>Debezium CDC</td><td>Source Shard WAL</td><td>Read WAL changes</td><td>Captures every write from source shard</td></tr>
        <tr><td><strong>5</strong></td><td>CDC</td><td>Kafka</td><td>Stream CDC events</td><td>Real-time change stream to Kafka topic</td></tr>
        <tr><td><strong>6</strong></td><td>Kafka</td><td>Migration Workers</td><td>Consume &amp; replay</td><td>Workers write changes to target shard</td></tr>
        <tr><td><strong>7</strong></td><td>Checksum Verifier</td><td>Source &amp; Target</td><td>Compare data</td><td>Row count + CRC checksum verification</td></tr>
        <tr><td><strong>8</strong></td><td>Orchestrator</td><td>All Writers</td><td>Brief write pause</td><td>Circuit breaker, &lt;500 ms pause window</td></tr>
        <tr><td><strong>9</strong></td><td>Orchestrator</td><td>etcd Cluster</td><td>Atomic routing switch</td><td>Update vShard &rarr; new node mapping atomically</td></tr>
        <tr><td><strong>10</strong></td><td>Cleanup Job</td><td>Old Shard</td><td>Delete old data</td><td>After 7-day safety verification period</td></tr>
      </tbody>
    </table>

    <!-- ===== HAPPY PATH ===== -->
    <h3 style="margin-top: 28px;">Happy Path</h3>
    <div class="card" style="border-left: 4px solid var(--success);">
      <p style="color: var(--text); font-size: 0.95rem; line-height: 1.8;">
        Plan migration &rarr; snapshot hot shard &rarr; Debezium CDC streams WAL to Kafka &rarr; Migration Workers replay to target shard &rarr; Checksum Verifier confirms row count + CRC match &rarr; brief write pause (&lt;500 ms circuit breaker) &rarr; etcd routing table updated atomically (vShards point to new nodes) &rarr; cleanup old shard data after verification period &rarr; <strong style="color: var(--success);">balanced shards, zero data loss, zero double-processing</strong>.
      </p>
    </div>

    <!-- ===== FAILURE PATHS ===== -->
    <h3 style="margin-top: 28px;">Failure Paths</h3>
    <table>
      <thead>
        <tr><th>Failure Scenario</th><th>Impact</th><th>Mitigation</th></tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>CDC lag too high</strong></td>
          <td style="color: var(--warning);">Migration stalls, target falls behind</td>
          <td>Pause migration, let CDC catch up. Resume when lag &lt; threshold.</td>
        </tr>
        <tr>
          <td><strong>Checksum mismatch</strong></td>
          <td style="color: var(--danger);">Data integrity at risk</td>
          <td>Halt migration immediately. Investigate source vs target divergence. Do NOT switch routing.</td>
        </tr>
        <tr>
          <td><strong>Routing switch failure</strong></td>
          <td style="color: var(--danger);">Requests may hit wrong shard</td>
          <td>Rollback to old mapping in etcd. Old shards still have all data.</td>
        </tr>
        <tr>
          <td><strong>Target shard disk full</strong></td>
          <td style="color: var(--danger);">Writes to target fail</td>
          <td>Abort migration + alert ops. Expand target storage before retry.</td>
        </tr>
        <tr>
          <td><strong>Application timeout during pause</strong></td>
          <td style="color: var(--warning);">Client sees transient error</td>
          <td>Retry with same idempotency key. Pause window is &lt;500 ms; most clients tolerate this.</td>
        </tr>
      </tbody>
    </table>

    <div class="callout callout-danger">
      <span class="callout-icon">&#9888;</span>
      <div class="callout-text"><strong>Critical Constraint:</strong> A double-charge on a $5,000 booking is a legal liability, a PCI compliance violation, and an instant customer trust destroyer. Every design decision must prevent this scenario.</div>
    </div>
</details>
  </div>

  <!-- ============ 2. REQUIREMENTS ============ -->
  <div class="section" id="requirements">
<details open>
    <span class="section-label label-teal">Section 2</span>
    <summary><h2>Requirements</h2></summary>

    <div class="grid-2">
      <div class="card card-accent-teal">
        <h4>&#9889; Functional Requirements</h4>
        <ul>
          <li><strong>Zero downtime</strong> -- payment processing must never stop</li>
          <li><strong>Zero data loss</strong> -- every payment record must be accounted for</li>
          <li><strong>No duplicate payments</strong> -- idempotency must be preserved across migration</li>
          <li><strong>Strong consistency</strong> -- reads after migration must reflect latest state</li>
          <li><strong>Rollback support</strong> -- ability to revert if migration goes wrong</li>
          <li><strong>Incremental migration</strong> -- move data in batches, not all-at-once</li>
        </ul>
      </div>
      <div class="card card-accent-blue">
        <h4>&#128202; Non-Functional Requirements</h4>
        <ul>
          <li><strong>Latency impact &lt; 5ms</strong> at p99 during migration</li>
          <li><strong>Migration speed</strong> -- 1TB moved in &lt; 4 hours</li>
          <li><strong>Automation</strong> -- minimal human intervention</li>
          <li><strong>Observability</strong> -- real-time progress + health metrics</li>
          <li><strong>PCI DSS compliance</strong> -- encrypted at rest and in transit</li>
          <li><strong>Audit trail</strong> -- every row move logged immutably</li>
        </ul>
      </div>
    </div>
</details>
  </div>

  <!-- ============ 3. WHY SHARDING PAYMENTS IS HARD ============ -->
  <div class="section" id="why-hard">
<details>
    <span class="section-label label-danger">Section 3</span>
    <summary><h2>Why Sharding Payments Is Hard</h2></summary>
    <p>Payment systems are not like social feeds or analytics pipelines. The stakes are fundamentally different.</p>

    <div class="grid-3">
      <div class="card card-accent-red">
        <h4>&#128274; ACID Requirements</h4>
        <p style="color:var(--text-muted); font-size:0.92rem;">Every payment is a financial transaction. Partial writes mean money appears or disappears. You cannot do eventual consistency on someone's bank account. Isolation is non-negotiable -- concurrent charges to the same user must serialize.</p>
      </div>
      <div class="card card-accent-danger">
        <h4>&#9888; Double-Charge = Legal Liability</h4>
        <p style="color:var(--text-muted); font-size:0.92rem;">If a row exists on both old and new shard simultaneously and both are writable, a payment processor could charge a card twice. This is a PCI violation, triggers chargebacks, and can result in regulatory fines. The migration protocol must make this <em>impossible</em>, not just unlikely.</p>
      </div>
      <div class="card card-accent-orange">
        <h4>&#128279; FK Relationships</h4>
        <p style="color:var(--text-muted); font-size:0.92rem;">A payment references a booking, which references a user and a listing. If payment moves to shard-7 but booking stays on shard-2, cross-shard joins become necessary. Shard key selection must keep related data co-located, or we must denormalize.</p>
      </div>
    </div>

    <div class="callout callout-warn">
      <span class="callout-icon">&#128161;</span>
      <div class="callout-text"><strong>Key Insight:</strong> Unlike read-heavy systems, payment systems are <em>write-heavy with strict ordering</em>. You cannot simply replicate and eventually converge. Every write must land on exactly one authoritative shard at any point in time.</div>
    </div>

    <div class="card">
      <h4>Comparison: Payments vs Other Domains</h4>
      <table>
        <thead>
          <tr>
            <th>Dimension</th>
            <th>Social Feed</th>
            <th>Analytics</th>
            <th>Payments</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Consistency</td>
            <td><span class="badge badge-yellow">Eventual OK</span></td>
            <td><span class="badge badge-yellow">Eventual OK</span></td>
            <td><span class="badge badge-red">Strong Required</span></td>
          </tr>
          <tr>
            <td>Duplicate Tolerance</td>
            <td><span class="badge badge-green">Tolerable</span></td>
            <td><span class="badge badge-yellow">Dedup Later</span></td>
            <td><span class="badge badge-red">Zero Tolerance</span></td>
          </tr>
          <tr>
            <td>Data Loss Impact</td>
            <td><span class="badge badge-yellow">User Annoyance</span></td>
            <td><span class="badge badge-yellow">Metric Gap</span></td>
            <td><span class="badge badge-red">Financial Loss</span></td>
          </tr>
          <tr>
            <td>Ordering</td>
            <td><span class="badge badge-green">Relaxed</span></td>
            <td><span class="badge badge-green">Relaxed</span></td>
            <td><span class="badge badge-red">Strict Causal</span></td>
          </tr>
        </tbody>
      </table>
    </div>
</details>
  </div>

  <!-- ============ 4. SHARDING STRATEGIES ============ -->
  <div class="section" id="strategies">
<details>
    <span class="section-label label-purple">Section 4</span>
    <summary><h2>Sharding Strategies Compared</h2></summary>
    <p>Choosing the right shard key is the most consequential decision. It determines data locality, query patterns, and how painful rebalancing will be.</p>

    <div class="grid-2">
      <div class="card card-accent-purple">
        <h4>&#9312; By user_id (Range)</h4>
        <p style="color:var(--text-muted); font-size:0.92rem; margin-bottom:10px;">Shard assignment: <code>user_id / range_size</code></p>
        <ul style="font-size:0.9rem;">
          <li><span class="badge badge-green">Pro</span> All user data co-located</li>
          <li><span class="badge badge-green">Pro</span> Simple user-scoped queries</li>
          <li><span class="badge badge-red">Con</span> Hot users create hot shards</li>
          <li><span class="badge badge-red">Con</span> Range splits are expensive</li>
        </ul>
      </div>
      <div class="card card-accent-blue">
        <h4>&#9313; By payment_id (Hash)</h4>
        <p style="color:var(--text-muted); font-size:0.92rem; margin-bottom:10px;">Shard assignment: <code>hash(payment_id) % N</code></p>
        <ul style="font-size:0.9rem;">
          <li><span class="badge badge-green">Pro</span> Even distribution</li>
          <li><span class="badge badge-green">Pro</span> No hot spots</li>
          <li><span class="badge badge-red">Con</span> User queries hit all shards (scatter-gather)</li>
          <li><span class="badge badge-red">Con</span> Changing N requires full rehash</li>
        </ul>
      </div>
      <div class="card card-accent-orange">
        <h4>&#9314; By hash(user_id) % N</h4>
        <p style="color:var(--text-muted); font-size:0.92rem; margin-bottom:10px;">Shard assignment: <code>hash(user_id) % N</code></p>
        <ul style="font-size:0.9rem;">
          <li><span class="badge badge-green">Pro</span> User data co-located</li>
          <li><span class="badge badge-green">Pro</span> Better distribution than range</li>
          <li><span class="badge badge-red">Con</span> Changing N moves ~(N-1)/N of data</li>
          <li><span class="badge badge-red">Con</span> Consistent hashing helps but adds complexity</li>
        </ul>
      </div>
      <div class="card card-accent-green" style="border: 2px solid var(--success);">
        <h4>&#9314; Virtual Shards (2^16) &#11088; Recommended</h4>
        <p style="color:var(--text-muted); font-size:0.92rem; margin-bottom:10px;">Shard assignment: <code>hash(user_id) % 65536 -> vShard -> physical node</code></p>
        <ul style="font-size:0.9rem;">
          <li><span class="badge badge-green">Pro</span> Rebalancing = reassigning vShards (metadata only)</li>
          <li><span class="badge badge-green">Pro</span> Granular control over load distribution</li>
          <li><span class="badge badge-green">Pro</span> Add nodes without rehashing any data</li>
          <li><span class="badge badge-green">Pro</span> User data stays co-located</li>
          <li><span class="badge badge-yellow">Con</span> Requires vShard mapping layer</li>
        </ul>
      </div>
    </div>

    <div class="flow-diagram">
      <div class="flow-title">Virtual Shard Architecture (65,536 logical partitions)</div>
<pre>
  user_id = 98234571
       |
       v
  hash(user_id) % 65536 = vShard <span style="color:#f59e0b;">42187</span>
       |
       v
  +---------------------+       +--------------------------+
  |   vShard Mapping     |       |   Physical Node Map      |
  |   (etcd / ZooKeeper) |       |                          |
  |                     |       |   vShard 0-8191    -> N1  |
  |   42187 -> Node 6   |------>|   vShard 8192-16383 -> N2 |
  |                     |       |   vShard 16384-24575-> N3 |
  +---------------------+       |   vShard 24576-32767-> N4 |
                                |   vShard 32768-40959-> N5 |
                                |   vShard 40960-49151-> <span style="color:#f59e0b;">N6</span> |
                                |   vShard 49152-57343-> N7 |
                                |   vShard 57344-65535-> N8 |
                                +--------------------------+
</pre>
    </div>
</details>
  </div>

  <!-- ============ 5. THREE REBALANCING APPROACHES ============ -->
  <div class="section" id="approaches">
<details>
    <span class="section-label label-orange">Section 5</span>
    <summary><h2>Three Rebalancing Approaches</h2></summary>

    <!-- Approach A -->
    <h3>Approach A: Double-Write Migration</h3>
    <p>Write to both old and new shard simultaneously during the transition window, then switch reads and stop old writes.</p>

    <div class="timeline">
      <div class="timeline-item">
        <div class="step-num">Phase 1</div>
        <h4>Enable Double-Writes</h4>
        <p>Application writes every new payment to <strong>both</strong> the source shard and the target shard. Old shard remains the authoritative read source.</p>
      </div>
      <div class="timeline-item">
        <div class="step-num">Phase 2</div>
        <h4>Backfill Historical Data</h4>
        <p>Background job copies existing rows from source to target in batches (e.g., 5000 rows/batch). Uses <code>WHERE updated_at &lt; migration_start</code> to avoid conflicts with double-writes.</p>
      </div>
      <div class="timeline-item">
        <div class="step-num">Phase 3</div>
        <h4>Verify Checksums</h4>
        <p>Run <code>MD5(CONCAT(col1, col2, ...))</code> checksums on both shards for the migrated range. Row count must match exactly. Mismatch triggers alert and halt.</p>
      </div>
      <div class="timeline-item">
        <div class="step-num">Phase 4</div>
        <h4>Switch Reads to New Shard</h4>
        <p>Update routing layer to read from new shard. Double-writes continue. Shadow-read old shard for comparison (fire-and-forget).</p>
      </div>
      <div class="timeline-item">
        <div class="step-num">Phase 5</div>
        <h4>Stop Old Writes + Cleanup</h4>
        <p>Disable writes to old shard for migrated ranges. After 7-day safety window, archive and delete old data.</p>
      </div>
    </div>

    <div class="callout callout-warn">
      <span class="callout-icon">&#128161;</span>
      <div class="callout-text"><strong>Double-Write Pitfall:</strong> If the write to the new shard fails but the old shard succeeds, you have divergence. Mitigation: wrap in a coordinator that retries the failed write, or use a write-ahead log as an intermediary.</div>
    </div>

    <!-- Approach B -->
    <h3>Approach B: CDC-Based Migration (Debezium)</h3>
    <p>Use Change Data Capture to stream changes from source to target, achieving near-real-time replication before switching over.</p>

    <div class="flow-diagram">
      <div class="flow-title">CDC Migration Pipeline</div>
<pre>
  Source Shard (PG)            Debezium Connector           Target Shard (PG)
  +----------------+          +------------------+          +----------------+
  |                |  WAL ---> |   CDC Stream     | -------> |                |
  |  payment_txns  |          |   (Kafka Topic)  |          |  payment_txns  |
  |                |          |                  |          |                |
  +----------------+          +------------------+          +----------------+
        |                            |                             |
        |   Phase 1: Initial         |   Phase 2: Streaming       |   Phase 3: Cutover
        |   Snapshot (pg_dump)       |   Real-time CDC replay     |   Brief write pause
        |                            |   Lag target: &lt; 100ms      |   Switch routing
        |                            |                             |   Resume writes
        +----------------------------+-----------------------------+
</pre>
    </div>

    <div class="card card-accent-teal">
      <h4>&#9889; CDC Cutover Sequence</h4>
      <div class="step-flow">
        <div class="step-box" style="border-color:var(--primary);">Snapshot Complete</div>
        <span class="step-arrow">&#10132;</span>
        <div class="step-box" style="border-color:var(--warning);">CDC Lag &lt; 100ms</div>
        <span class="step-arrow">&#10132;</span>
        <div class="step-box" style="border-color:var(--danger);">Pause Writes (200ms)</div>
        <span class="step-arrow">&#10132;</span>
        <div class="step-box" style="border-color:var(--blue);">Drain CDC Queue</div>
        <span class="step-arrow">&#10132;</span>
        <div class="step-box" style="border-color:var(--success);">Switch Routing</div>
        <span class="step-arrow">&#10132;</span>
        <div class="step-box" style="border-color:var(--secondary);">Resume Writes</div>
      </div>
      <p style="color:var(--text-muted); font-size:0.9rem; margin-top:12px;">Total write pause: <strong>~200-500ms</strong>. Payments queue in a Kafka buffer during pause and replay immediately after routing switch. No client-visible error.</p>
    </div>

    <!-- Approach C -->
    <h3>Approach C: Virtual Shard Reassignment</h3>
    <p>With 65,536 logical partitions pre-allocated, rebalancing is primarily a metadata operation. Data moves happen in the background while the routing layer handles the transition transparently.</p>

    <div class="card card-accent-green">
      <h4>&#9889; How It Works</h4>
      <ol style="font-size:0.92rem;">
        <li><strong>Compute new assignment:</strong> Algorithm distributes 65,536 vShards evenly across N+2 nodes (N existing + 2 new).</li>
        <li><strong>Mark vShards as MIGRATING:</strong> Routing layer sets state for affected vShards (typically 25-30% of total).</li>
        <li><strong>Background data copy:</strong> Worker threads copy data for each MIGRATING vShard from old to new node. Writes continue to old node.</li>
        <li><strong>Catchup phase:</strong> After bulk copy, replay any writes that occurred during copy (CDC on the vShard range).</li>
        <li><strong>Atomic switch:</strong> Single etcd transaction flips vShard ownership. Takes &lt; 10ms.</li>
        <li><strong>Cleanup:</strong> Old node deletes data for reassigned vShards after safety period.</li>
      </ol>
    </div>

    <div class="flow-diagram">
      <div class="flow-title">vShard Reassignment: Before and After</div>
<pre>
  BEFORE (6 nodes, 65536 vShards)          AFTER (8 nodes, 65536 vShards)
  ================================          ================================
  Node-1: vShards  0    - 10922            Node-1: vShards  0    - 8191
  Node-2: vShards  10923 - 21845           Node-2: vShards  8192  - 16383
  Node-3: vShards  21846 - 32767           Node-3: vShards  16384 - 24575
  Node-4: vShards  32768 - 43690           Node-4: vShards  24576 - 32767
  Node-5: vShards  43691 - 54613           Node-5: vShards  32768 - 40959
  Node-6: vShards  54614 - 65535           Node-6: vShards  40960 - 49151
                                           <span style="color: var(--success);">Node-7: vShards  49152 - 57343  NEW</span>
                                           <span style="color: var(--success);">Node-8: vShards  57344 - 65535  NEW</span>

  Moved: ~16,384 vShards (25%)   |   Untouched: ~49,152 vShards (75%)
</pre>
    </div>

    <!-- APPROACH COMPARISON TABLE -->
    <h3>Approach Comparison</h3>
    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Criteria</th>
            <th>A: Double-Write</th>
            <th>B: CDC-Based</th>
            <th>C: Virtual Shard</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Downtime</strong></td>
            <td><span class="badge badge-green">Zero</span></td>
            <td><span class="badge badge-yellow">~200-500ms</span></td>
            <td><span class="badge badge-green">&lt; 10ms</span></td>
          </tr>
          <tr>
            <td><strong>Complexity</strong></td>
            <td><span class="badge badge-yellow">Medium</span></td>
            <td><span class="badge badge-yellow">Medium</span></td>
            <td><span class="badge badge-red">High (upfront)</span></td>
          </tr>
          <tr>
            <td><strong>Data Moved</strong></td>
            <td>Full copy of migrating rows</td>
            <td>Full copy + CDC stream</td>
            <td>Only reassigned vShards (~25%)</td>
          </tr>
          <tr>
            <td><strong>Consistency Risk</strong></td>
            <td><span class="badge badge-yellow">Divergence possible</span></td>
            <td><span class="badge badge-green">WAL-based, strong</span></td>
            <td><span class="badge badge-green">Atomic metadata swap</span></td>
          </tr>
          <tr>
            <td><strong>Rollback</strong></td>
            <td><span class="badge badge-green">Easy (old data intact)</span></td>
            <td><span class="badge badge-yellow">Re-snapshot needed</span></td>
            <td><span class="badge badge-green">Flip metadata back</span></td>
          </tr>
          <tr>
            <td><strong>Best For</strong></td>
            <td>Small-scale, infrequent</td>
            <td>One-time large migrations</td>
            <td><span class="badge badge-purple">Ongoing, frequent rebalancing</span></td>
          </tr>
        </tbody>
      </table>
    </div>
</details>
  </div>

  <!-- ============ 6. ROUTING LAYER ============ -->
  <div class="section" id="routing">
<details>
    <span class="section-label label-blue">Section 6</span>
    <summary><h2>Routing Layer</h2></summary>
    <p>The shard router is the critical intermediary that maps every payment request to the correct physical shard. It must be fast, consistent, and migration-aware.</p>

    <div class="flow-diagram">
      <div class="flow-title">Shard Routing Architecture</div>
<pre>
                           +---------------------------+
                           |    Payment API Gateway     |
                           +-------------+-------------+
                                         |
                                         v
                           +---------------------------+
                           |      Shard Router          |
                           |                           |
                           |  1. Extract user_id       |
                           |  2. hash(user_id) % 65536 |
                           |  3. Lookup vShard -> Node  |
                           |  4. Check migration state  |
                           +--+----------+----------+--+
                              |          |          |
                     +--------+   +------+------+   +--------+
                     v            v             v            v
               +---------+  +---------+  +---------+  +---------+
               | Node 1  |  | Node 2  |  | Node 3  |  | Node 4  |
               |  PG     |  |  PG     |  |  PG     |  |  PG     |
               +---------+  +---------+  +---------+  +---------+

  Mapping Store: etcd cluster (3 nodes, Raft consensus)
  Cache: Local in-memory with 5s TTL, invalidated by etcd watch
  Dual-Read: During migration, read from BOTH shards, prefer new
</pre>
    </div>

    <div class="grid-2">
      <div class="card card-accent-blue">
        <h4>&#128268; Mapping Storage (etcd / ZooKeeper)</h4>
        <ul style="font-size:0.9rem;">
          <li><strong>Key:</strong> <code>/shards/vshard/{id}</code></li>
          <li><strong>Value:</strong> <code>{"node": "pg-node-6", "state": "ACTIVE|MIGRATING", "target": "pg-node-8"}</code></li>
          <li>Raft consensus ensures all routers see same mapping</li>
          <li>Watch-based invalidation pushes changes in &lt; 50ms</li>
          <li>Versioned updates prevent stale-write races</li>
        </ul>
      </div>
      <div class="card card-accent-purple">
        <h4>&#128640; Client Caching with TTL</h4>
        <ul style="font-size:0.9rem;">
          <li><strong>Local cache TTL:</strong> 5 seconds (non-migration), 500ms (during migration)</li>
          <li>etcd watch triggers immediate cache invalidation</li>
          <li>Cache miss = synchronous etcd lookup (~2ms)</li>
          <li>Stale cache during migration = dual-read safety net catches it</li>
          <li>Jittered TTL prevents thundering herd on cache expiry</li>
        </ul>
      </div>
    </div>

    <div class="card card-accent-orange">
      <h4>&#128260; Dual-Read During Migration</h4>
      <p style="color:var(--text-muted); font-size:0.92rem; margin-bottom:12px;">When a vShard is in <code>MIGRATING</code> state, the router reads from both source and target shards:</p>
      <div class="code-block">
<span class="kw">async function</span> <span class="fn">routeRead</span>(userId, paymentId) {
  <span class="kw">const</span> vShard = hash(userId) % <span class="num">65536</span>;
  <span class="kw">const</span> mapping = <span class="kw">await</span> <span class="fn">getMapping</span>(vShard);

  <span class="kw">if</span> (mapping.state === <span class="str">'ACTIVE'</span>) {
    <span class="kw">return</span> <span class="kw">await</span> <span class="fn">queryNode</span>(mapping.node, paymentId);
  }

  <span class="kw">if</span> (mapping.state === <span class="str">'MIGRATING'</span>) {
    <span class="cm">// Try target first (most up-to-date if data already moved)</span>
    <span class="kw">const</span> result = <span class="kw">await</span> <span class="fn">queryNode</span>(mapping.target, paymentId);
    <span class="kw">if</span> (result) <span class="kw">return</span> result;

    <span class="cm">// Fallback to source (data not yet migrated)</span>
    <span class="kw">return</span> <span class="kw">await</span> <span class="fn">queryNode</span>(mapping.node, paymentId);
  }
}
</div>
    </div>
</details>
  </div>

  <!-- ============ 7. CONSISTENCY DURING MIGRATION ============ -->
  <div class="section" id="consistency">
<details>
    <span class="section-label label-danger">Section 7</span>
    <summary><h2>Consistency During Migration</h2></summary>
    <p>This is the hardest part. During migration, the same logical data exists (partially) on two physical nodes. We must guarantee that exactly one node is authoritative for writes at any moment.</p>

    <div class="grid-2">
      <div class="card card-accent-red">
        <h4>&#128274; Write Fence</h4>
        <p style="color:var(--text-muted); font-size:0.92rem;">Before a vShard ownership transfer, place a <strong>write fence</strong> on the source node:</p>
        <div class="code-block" style="font-size:0.82rem;">
<span class="cm">-- On source node, block writes for vShard range</span>
<span class="kw">INSERT INTO</span> write_fences (vshard_id, fenced_at, fence_token)
<span class="kw">VALUES</span> (<span class="num">42187</span>, <span class="fn">NOW</span>(), <span class="str">'migration-batch-2024-abc'</span>);

<span class="cm">-- Application write path checks fence</span>
<span class="kw">SELECT</span> fence_token <span class="kw">FROM</span> write_fences
<span class="kw">WHERE</span> vshard_id = <span class="num">42187</span> <span class="kw">AND</span> released_at <span class="kw">IS NULL</span>;
<span class="cm">-- If row exists, reject write with RETRY-AFTER header</span>
</div>
      </div>
      <div class="card card-accent-purple">
        <h4>&#128275; Distributed Lock on Migrating Ranges</h4>
        <p style="color:var(--text-muted); font-size:0.92rem;">Use etcd distributed locks to ensure only one writer per vShard range:</p>
        <div class="code-block" style="font-size:0.82rem;">
<span class="cm">// Acquire lock before vShard ownership transfer</span>
<span class="kw">const</span> lock = <span class="kw">await</span> etcd.<span class="fn">lock</span>(<span class="str">`/migrate/vshard/42187`</span>);
<span class="kw">try</span> {
  <span class="kw">await</span> <span class="fn">drainInFlightWrites</span>(vshard: <span class="num">42187</span>);
  <span class="kw">await</span> <span class="fn">replayPendingCDC</span>(vshard: <span class="num">42187</span>);
  <span class="kw">await</span> etcd.<span class="fn">put</span>(<span class="str">`/shards/vshard/42187`</span>,
    { node: <span class="str">'pg-node-8'</span>, state: <span class="str">'ACTIVE'</span> });
} <span class="kw">finally</span> {
  <span class="kw">await</span> lock.<span class="fn">release</span>();
}
</div>
      </div>
    </div>

    <div class="card card-accent-yellow">
      <h4>&#128256; 2PC for Cross-Shard Transactions</h4>
      <p style="color:var(--text-muted); font-size:0.92rem; margin-bottom:12px;">When a transaction spans shards (e.g., refund on shard-3 references payment on shard-7), use Two-Phase Commit:</p>
      <div class="step-flow">
        <div class="step-box" style="border-color:var(--warning);">Coordinator: PREPARE</div>
        <span class="step-arrow">&#10132;</span>
        <div class="step-box" style="border-color:var(--blue);">Shard-3: PREPARE OK</div>
        <span class="step-arrow">&#10132;</span>
        <div class="step-box" style="border-color:var(--blue);">Shard-7: PREPARE OK</div>
        <span class="step-arrow">&#10132;</span>
        <div class="step-box" style="border-color:var(--success);">Coordinator: COMMIT</div>
      </div>
      <p style="color:var(--text-muted); font-size:0.88rem; margin-top:10px;">PostgreSQL supports <code>PREPARE TRANSACTION</code> natively. Timeout: 5s. If any participant fails to PREPARE, coordinator sends ROLLBACK to all.</p>
    </div>

    <div class="card card-accent-green">
      <h4>&#128273; Idempotency Keys</h4>
      <p style="color:var(--text-muted); font-size:0.92rem; margin-bottom:12px;">Every payment carries a client-generated idempotency key. This is the ultimate defense against double-charges:</p>
      <div class="code-block" style="font-size:0.82rem;">
<span class="kw">CREATE TABLE</span> idempotency_keys (
  idempotency_key  <span class="type">UUID</span> <span class="kw">PRIMARY KEY</span>,
  payment_id       <span class="type">BIGINT</span> <span class="kw">NOT NULL</span>,
  created_at       <span class="type">TIMESTAMPTZ</span> <span class="kw">DEFAULT NOW</span>(),
  response_code    <span class="type">INT</span>,
  response_body    <span class="type">JSONB</span>
);

<span class="cm">-- On every payment write attempt:</span>
<span class="kw">INSERT INTO</span> idempotency_keys (idempotency_key, payment_id)
<span class="kw">VALUES</span> (:key, :pid)
<span class="kw">ON CONFLICT</span> (idempotency_key) <span class="kw">DO NOTHING</span>
<span class="kw">RETURNING</span> *;
<span class="cm">-- If no row returned, payment already processed -> return cached response</span>
</div>
      <p style="color:var(--text-muted); font-size:0.88rem; margin-top:10px;">The idempotency table is replicated to BOTH source and target shards during migration. Even if a stale router sends a duplicate write, the <code>ON CONFLICT</code> clause prevents double-processing.</p>
    </div>
</details>
  </div>

  <!-- ============ 8. VERIFICATION & ROLLBACK ============ -->
  <div class="section" id="verification">
<details>
    <span class="section-label label-green">Section 8</span>
    <summary><h2>Verification & Rollback</h2></summary>
    <p>Trust but verify. Every migration batch goes through multi-layer verification before being declared complete.</p>

    <div class="grid-2">
      <div class="card card-accent-green">
        <h4>&#9989; Row Count + Checksum</h4>
        <div class="code-block" style="font-size:0.82rem;">
<span class="cm">-- Source shard</span>
<span class="kw">SELECT COUNT</span>(*) <span class="kw">AS</span> row_count,
       <span class="fn">MD5</span>(<span class="fn">STRING_AGG</span>(
         <span class="fn">MD5</span>(<span class="fn">ROW</span>(id, amount, currency, status,
             user_id, updated_at)::<span class="type">TEXT</span>),
         <span class="str">''</span> <span class="kw">ORDER BY</span> id
       )) <span class="kw">AS</span> checksum
<span class="kw">FROM</span> payment_transactions
<span class="kw">WHERE</span> vshard_id = <span class="num">42187</span>;

<span class="cm">-- Compare with identical query on target shard</span>
<span class="cm">-- MUST match exactly: row_count AND checksum</span>
</div>
      </div>
      <div class="card card-accent-blue">
        <h4>&#128065; Shadow Reads</h4>
        <p style="color:var(--text-muted); font-size:0.92rem;">After switching reads to the new shard, continue shadow-reading from the old shard for comparison:</p>
        <ul style="font-size:0.9rem;">
          <li>Sample 5% of reads for shadow comparison</li>
          <li>Log any mismatches to a dedicated audit table</li>
          <li>Alert if mismatch rate exceeds 0.01%</li>
          <li>Shadow reads are fire-and-forget (no latency impact)</li>
          <li>Run for 72 hours post-migration</li>
        </ul>
      </div>
    </div>

    <div class="card card-accent-danger">
      <h4>&#128680; Mismatch Threshold and Halt</h4>
      <p style="color:var(--text-muted); font-size:0.92rem; margin-bottom:12px;">Automatic halt conditions that stop migration immediately:</p>
      <table>
        <thead>
          <tr>
            <th>Condition</th>
            <th>Threshold</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Row count mismatch</td>
            <td><span class="badge badge-red">> 0 rows</span></td>
            <td>HALT + alert on-call</td>
          </tr>
          <tr>
            <td>Checksum mismatch</td>
            <td><span class="badge badge-red">Any</span></td>
            <td>HALT + diff analysis</td>
          </tr>
          <tr>
            <td>Shadow read mismatch rate</td>
            <td><span class="badge badge-yellow">> 0.01%</span></td>
            <td>HALT + investigation</td>
          </tr>
          <tr>
            <td>CDC replication lag</td>
            <td><span class="badge badge-yellow">> 5 seconds</span></td>
            <td>Pause migration, wait</td>
          </tr>
          <tr>
            <td>Error rate on target shard</td>
            <td><span class="badge badge-yellow">> 0.1%</span></td>
            <td>HALT + rollback evaluation</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="card card-accent-orange">
      <h4>&#8634; Rollback Procedure</h4>
      <div class="timeline">
        <div class="timeline-item">
          <div class="step-num">Step 1</div>
          <h4>Halt All In-Progress Migrations</h4>
          <p>Set all MIGRATING vShards back to ACTIVE on source node in etcd (single atomic transaction).</p>
        </div>
        <div class="timeline-item">
          <div class="step-num">Step 2</div>
          <h4>Redirect All Traffic to Source</h4>
          <p>Router cache invalidation propagates in &lt; 500ms. All new reads/writes go to original shards.</p>
        </div>
        <div class="timeline-item">
          <div class="step-num">Step 3</div>
          <h4>Reconcile Target-Only Writes</h4>
          <p>Any writes that landed on the target after the last sync point must be replayed to the source. Use the CDC log in reverse.</p>
        </div>
        <div class="timeline-item">
          <div class="step-num">Step 4</div>
          <h4>Verify Source Integrity</h4>
          <p>Run full checksum verification on source. Confirm zero data loss. Generate incident report.</p>
        </div>
      </div>
    </div>
</details>
  </div>

  <!-- ============ 9. DATA MODEL ============ -->
  <div class="section" id="data-model">
<details>
    <span class="section-label label-purple">Section 9</span>
    <summary><h2>Data Model</h2></summary>

    <div class="card card-accent-purple">
      <h4>&#128451; shard_routing</h4>
      <p style="color:var(--text-muted); font-size:0.88rem; margin-bottom:12px;">Mapping from virtual shard to physical node. Stored in etcd, cached locally.</p>
      <div class="code-block">
<span class="kw">CREATE TABLE</span> shard_routing (
  vshard_id       <span class="type">INT</span> <span class="kw">PRIMARY KEY</span>,          <span class="cm">-- 0 to 65535</span>
  physical_node   <span class="type">VARCHAR(64)</span> <span class="kw">NOT NULL</span>,      <span class="cm">-- e.g., 'pg-node-6'</span>
  state           <span class="type">VARCHAR(16)</span> <span class="kw">NOT NULL</span>       <span class="cm">-- ACTIVE | MIGRATING | DRAINING</span>
                  <span class="kw">DEFAULT</span> <span class="str">'ACTIVE'</span>,
  target_node     <span class="type">VARCHAR(64)</span>,               <span class="cm">-- set during migration</span>
  migration_id    <span class="type">UUID</span>,                      <span class="cm">-- FK to migration_tasks</span>
  version         <span class="type">BIGINT</span> <span class="kw">NOT NULL DEFAULT</span> <span class="num">1</span>, <span class="cm">-- optimistic concurrency</span>
  updated_at      <span class="type">TIMESTAMPTZ</span> <span class="kw">DEFAULT NOW</span>()
);

<span class="kw">CREATE INDEX</span> idx_routing_state <span class="kw">ON</span> shard_routing(state);
<span class="kw">CREATE INDEX</span> idx_routing_node <span class="kw">ON</span> shard_routing(physical_node);
</div>
    </div>

    <div class="card card-accent-blue">
      <h4>&#128451; migration_tasks</h4>
      <p style="color:var(--text-muted); font-size:0.88rem; margin-bottom:12px;">Tracks each migration batch for audit and rollback.</p>
      <div class="code-block">
<span class="kw">CREATE TABLE</span> migration_tasks (
  id               <span class="type">UUID</span> <span class="kw">PRIMARY KEY DEFAULT</span> <span class="fn">gen_random_uuid</span>(),
  vshard_start     <span class="type">INT</span> <span class="kw">NOT NULL</span>,              <span class="cm">-- start of vShard range</span>
  vshard_end       <span class="type">INT</span> <span class="kw">NOT NULL</span>,              <span class="cm">-- end of vShard range</span>
  source_node      <span class="type">VARCHAR(64)</span> <span class="kw">NOT NULL</span>,
  target_node      <span class="type">VARCHAR(64)</span> <span class="kw">NOT NULL</span>,
  state            <span class="type">VARCHAR(20)</span> <span class="kw">NOT NULL</span>       <span class="cm">-- PENDING | SNAPSHOTTING | STREAMING</span>
                   <span class="kw">DEFAULT</span> <span class="str">'PENDING'</span>,          <span class="cm">-- | VERIFYING | SWITCHING | COMPLETE</span>
                                               <span class="cm">-- | FAILED | ROLLED_BACK</span>
  rows_copied      <span class="type">BIGINT</span> <span class="kw">DEFAULT</span> <span class="num">0</span>,
  rows_total       <span class="type">BIGINT</span>,
  checksum_source  <span class="type">VARCHAR(32)</span>,
  checksum_target  <span class="type">VARCHAR(32)</span>,
  started_at       <span class="type">TIMESTAMPTZ</span>,
  completed_at     <span class="type">TIMESTAMPTZ</span>,
  error_message    <span class="type">TEXT</span>,
  created_at       <span class="type">TIMESTAMPTZ</span> <span class="kw">DEFAULT NOW</span>()
);

<span class="kw">CREATE INDEX</span> idx_migration_state <span class="kw">ON</span> migration_tasks(state);
</div>
    </div>

    <div class="card card-accent-teal">
      <h4>&#128451; payment_transactions</h4>
      <p style="color:var(--text-muted); font-size:0.88rem; margin-bottom:12px;">The actual payment data, partitioned by vShard on each physical node.</p>
      <div class="code-block">
<span class="kw">CREATE TABLE</span> payment_transactions (
  id               <span class="type">BIGINT</span> <span class="kw">PRIMARY KEY</span>,
  idempotency_key  <span class="type">UUID</span> <span class="kw">UNIQUE NOT NULL</span>,
  user_id          <span class="type">BIGINT</span> <span class="kw">NOT NULL</span>,
  booking_id       <span class="type">BIGINT</span> <span class="kw">NOT NULL</span>,
  amount           <span class="type">NUMERIC(12,2)</span> <span class="kw">NOT NULL</span>,
  currency         <span class="type">VARCHAR(3)</span> <span class="kw">NOT NULL</span>,
  status           <span class="type">VARCHAR(20)</span> <span class="kw">NOT NULL</span>,     <span class="cm">-- PENDING | AUTHORIZED | CAPTURED</span>
                                              <span class="cm">-- | REFUNDED | FAILED</span>
  payment_method   <span class="type">VARCHAR(20)</span> <span class="kw">NOT NULL</span>,
  processor_ref    <span class="type">VARCHAR(128)</span>,             <span class="cm">-- Stripe/Adyen reference</span>
  vshard_id        <span class="type">INT</span> <span class="kw">NOT NULL</span>,              <span class="cm">-- hash(user_id) % 65536</span>
  created_at       <span class="type">TIMESTAMPTZ</span> <span class="kw">DEFAULT NOW</span>(),
  updated_at       <span class="type">TIMESTAMPTZ</span> <span class="kw">DEFAULT NOW</span>()
) <span class="kw">PARTITION BY RANGE</span> (vshard_id);

<span class="cm">-- Each physical node hosts partitions for its assigned vShard range</span>
<span class="kw">CREATE TABLE</span> payment_transactions_p0 <span class="kw">PARTITION OF</span> payment_transactions
  <span class="kw">FOR VALUES FROM</span> (<span class="num">0</span>) <span class="kw">TO</span> (<span class="num">8192</span>);
<span class="kw">CREATE TABLE</span> payment_transactions_p1 <span class="kw">PARTITION OF</span> payment_transactions
  <span class="kw">FOR VALUES FROM</span> (<span class="num">8192</span>) <span class="kw">TO</span> (<span class="num">16384</span>);
<span class="cm">-- ... 6 more partitions</span>

<span class="kw">CREATE INDEX</span> idx_payment_user <span class="kw">ON</span> payment_transactions(user_id);
<span class="kw">CREATE INDEX</span> idx_payment_booking <span class="kw">ON</span> payment_transactions(booking_id);
<span class="kw">CREATE INDEX</span> idx_payment_vshard <span class="kw">ON</span> payment_transactions(vshard_id);
</div>
    </div>
</details>
  </div>

  <!-- ============ 10. TRADE-OFFS TABLE ============ -->
  <div class="section" id="tradeoffs">
<details>
    <span class="section-label label-yellow">Section 10</span>
    <summary><h2>Trade-offs</h2></summary>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Decision</th>
            <th>Trade-off</th>
            <th>Chosen Approach</th>
            <th>Why</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Shard key</strong></td>
            <td>user_id co-location vs even distribution</td>
            <td><span class="badge badge-purple">hash(user_id) % 65536</span></td>
            <td>Co-locates all user payments; vShards enable fine-grained rebalancing</td>
          </tr>
          <tr>
            <td><strong>Migration method</strong></td>
            <td>Simplicity vs flexibility</td>
            <td><span class="badge badge-green">Virtual Shard Reassignment</span></td>
            <td>Pays upfront complexity cost but enables ongoing, near-zero-downtime rebalancing</td>
          </tr>
          <tr>
            <td><strong>Consistency model</strong></td>
            <td>Availability vs correctness</td>
            <td><span class="badge badge-red">Strong consistency + write fence</span></td>
            <td>Payments require correctness over availability (CP over AP)</td>
          </tr>
          <tr>
            <td><strong>Routing cache TTL</strong></td>
            <td>Latency vs freshness</td>
            <td><span class="badge badge-blue">5s normal / 500ms migration</span></td>
            <td>Shorter TTL during migration reduces stale routing; dual-read catches remainder</td>
          </tr>
          <tr>
            <td><strong>Write pause on cutover</strong></td>
            <td>Zero-downtime vs simplicity</td>
            <td><span class="badge badge-yellow">~10ms atomic swap</span></td>
            <td>Sub-10ms pause is invisible to clients; dramatically simplifies correctness proof</td>
          </tr>
          <tr>
            <td><strong>Cross-shard transactions</strong></td>
            <td>Performance vs correctness</td>
            <td><span class="badge badge-red">2PC (PostgreSQL PREPARE TRANSACTION)</span></td>
            <td>Correctness is non-negotiable for refunds referencing payments on other shards</td>
          </tr>
          <tr>
            <td><strong>Shadow reads duration</strong></td>
            <td>Cost vs confidence</td>
            <td><span class="badge badge-yellow">72 hours post-migration</span></td>
            <td>3 days covers weekday+weekend patterns; catches edge cases in payment cycles</td>
          </tr>
          <tr>
            <td><strong>Rollback strategy</strong></td>
            <td>Speed vs safety</td>
            <td><span class="badge badge-green">Metadata flip + CDC reverse replay</span></td>
            <td>Metadata flip takes &lt;10ms; CDC reverse replay reconciles any target-only writes</td>
          </tr>
        </tbody>
      </table>
    </div>
</details>
  </div>

  <!-- ============ 11. MONITORING ============ -->
  <div class="section" id="monitoring">
<details>
    <span class="section-label label-green">Section 11</span>
    <summary><h2>Monitoring & Observability</h2></summary>
    <p>A migration without observability is a migration in the dark. Every phase must be instrumented.</p>

    <div class="grid-2">
      <div class="card card-accent-green">
        <h4>&#128200; Migration Progress Dashboard</h4>
        <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:14px;">Real-time view of all active migrations:</p>
        <div style="margin-bottom:12px;">
          <div style="display:flex; justify-content:space-between; font-size:0.85rem; margin-bottom:4px;">
            <span style="color:var(--text);">vShard 40960-42000 (Node-5 -> Node-7)</span>
            <span style="color:var(--success); font-weight:700;">87%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width:87%; background: linear-gradient(90deg, var(--secondary), var(--success));"></div>
          </div>
        </div>
        <div style="margin-bottom:12px;">
          <div style="display:flex; justify-content:space-between; font-size:0.85rem; margin-bottom:4px;">
            <span style="color:var(--text);">vShard 42001-44000 (Node-5 -> Node-7)</span>
            <span style="color:var(--warning); font-weight:700;">42%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width:42%; background: linear-gradient(90deg, var(--warning), var(--accent));"></div>
          </div>
        </div>
        <div>
          <div style="display:flex; justify-content:space-between; font-size:0.85rem; margin-bottom:4px;">
            <span style="color:var(--text);">vShard 44001-46000 (Node-6 -> Node-8)</span>
            <span style="color:var(--text-muted); font-weight:700;">Queued</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width:0%; background: var(--card-border);"></div>
          </div>
        </div>
      </div>
      <div class="card card-accent-blue">
        <h4>&#128202; Key Metrics</h4>
        <div class="metric-row" style="grid-template-columns: 1fr 1fr;">
          <div class="metric-box">
            <div class="metric-val" style="color:var(--success); font-size:1.3rem;">23ms</div>
            <div class="metric-label">CDC Replication Lag</div>
          </div>
          <div class="metric-box">
            <div class="metric-val" style="color:var(--success); font-size:1.3rem;">0</div>
            <div class="metric-label">Checksum Mismatches</div>
          </div>
          <div class="metric-box">
            <div class="metric-val" style="color:var(--warning); font-size:1.3rem;">+2.1ms</div>
            <div class="metric-label">p99 Latency Impact</div>
          </div>
          <div class="metric-box">
            <div class="metric-val" style="color:var(--success); font-size:1.3rem;">0.00%</div>
            <div class="metric-label">Error Rate</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card card-accent-orange">
      <h4>&#128680; Alerting Rules</h4>
      <table>
        <thead>
          <tr>
            <th>Alert</th>
            <th>Condition</th>
            <th>Severity</th>
            <th>Response</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>CDC Lag Spike</td>
            <td>Replication lag > 5s for 30s</td>
            <td><span class="badge badge-yellow">WARNING</span></td>
            <td>Pause migration, investigate source load</td>
          </tr>
          <tr>
            <td>Checksum Failure</td>
            <td>Any batch checksum mismatch</td>
            <td><span class="badge badge-red">CRITICAL</span></td>
            <td>Halt migration, page on-call, initiate diff analysis</td>
          </tr>
          <tr>
            <td>Shadow Read Divergence</td>
            <td>Mismatch rate > 0.01%</td>
            <td><span class="badge badge-red">CRITICAL</span></td>
            <td>Halt, evaluate rollback</td>
          </tr>
          <tr>
            <td>Write Fence Timeout</td>
            <td>Fence held > 30s</td>
            <td><span class="badge badge-yellow">WARNING</span></td>
            <td>Check for stuck migration worker, force-release if dead</td>
          </tr>
          <tr>
            <td>Target Shard Error Rate</td>
            <td>> 0.1% errors on target</td>
            <td><span class="badge badge-red">CRITICAL</span></td>
            <td>Rollback, investigate target health</td>
          </tr>
          <tr>
            <td>Latency Impact</td>
            <td>p99 increase > 10ms</td>
            <td><span class="badge badge-yellow">WARNING</span></td>
            <td>Throttle migration batch size</td>
          </tr>
        </tbody>
      </table>
    </div>


</details>
  </div>

  <!-- ============ 12. INTERVIEW TIPS ============ -->
  <div class="section" id="interview">
<details>
    <span class="section-label label-red">Section 12</span>
    <summary><h2>Interview Tips</h2></summary>
    <p>How to navigate this topic in a PE-level system design interview.</p>

    <div class="tip-grid">
      <div class="tip-item">
        <div class="tip-q">"How do you handle rebalancing without downtime?"</div>
        <div class="tip-a">Start with virtual shards. Explain 65,536 logical partitions mapped to physical nodes via a routing layer in etcd. Rebalancing is primarily a metadata operation. Background data copy with CDC catch-up. Atomic switch takes &lt;10ms. Client sees no interruption.</div>
      </div>
      <div class="tip-item">
        <div class="tip-q">"How do you prevent double-charges?"</div>
        <div class="tip-a">Three layers of defense: (1) Idempotency keys with UNIQUE constraint, checked on every write. (2) Write fences that block writes on source during ownership transfer. (3) Single-writer guarantee -- only one node is writable for a vShard at any point, enforced by distributed lock.</div>
      </div>
      <div class="tip-item">
        <div class="tip-q">"What if the migration fails halfway?"</div>
        <div class="tip-a">Rollback is a metadata flip in etcd -- set all MIGRATING vShards back to ACTIVE on source. Takes &lt;10ms. Then reconcile any writes that landed on the target using reverse CDC replay. Source data was never deleted (7-day safety window), so no data loss.</div>
      </div>
      <div class="tip-item">
        <div class="tip-q">"How do you verify correctness?"</div>
        <div class="tip-a">Multi-layer: (1) Per-batch row count + MD5 checksums, must match exactly. (2) Post-switch shadow reads comparing both shards for 72 hours. (3) Automated mismatch detection with 0.01% threshold triggering halt. (4) Orphaned idempotency key detection.</div>
      </div>
      <div class="tip-item">
        <div class="tip-q">"Why not just use consistent hashing?"</div>
        <div class="tip-a">Consistent hashing still moves ~K/N keys when adding a node, and you cannot control which keys move. Virtual shards give you explicit control -- you decide exactly which vShards move where, can prioritize hot vShards, and can pause/resume at vShard granularity.</div>
      </div>
      <div class="tip-item">
        <div class="tip-q">"How do you handle cross-shard queries?"</div>
        <div class="tip-a">User-scoped queries stay within one shard (shard key = user_id). Cross-shard operations like refunds referencing payments on another shard use PostgreSQL 2PC (PREPARE TRANSACTION). Scatter-gather for admin queries with parallel fanout and streaming merge.</div>
      </div>
      <div class="tip-item">
        <div class="tip-q">"What is the latency impact during migration?"</div>
        <div class="tip-a">Target: &lt;5ms p99 increase. Achieved by: throttling batch size, running migration during low-traffic windows, rate-limiting CDC replay to 10K rows/sec, and dual-read adding only 1-2ms (parallel query to both shards, take first response).</div>
      </div>
      <div class="tip-item">
        <div class="tip-q">"How would you scale this to 100 shards?"</div>
        <div class="tip-a">Virtual shards scale naturally -- 65,536 vShards across 100 nodes means ~655 vShards per node. Migration planner computes optimal assignment using bin-packing algorithm minimizing data movement. Parallel migration workers handle multiple vShard ranges concurrently with per-range throttling.</div>
      </div>
    </div>

    <div class="callout callout-success" style="margin-top:24px;">
      <span class="callout-icon">&#127919;</span>
      <div class="callout-text"><strong>PE-Level Differentiator:</strong> Junior candidates describe sharding. Senior candidates describe migration. PE candidates describe how to <em>prove correctness</em> -- checksums, shadow reads, idempotency invariants, write fences, and formal reasoning about why double-charges are impossible in this design. Lead with the invariants, then show the mechanisms that enforce them.</div>
    </div>
</details>
  </div>

</div>

<!-- FOOTER -->
<div style="background: #f8fafc; border-top: 2px solid var(--card-border); padding: 40px 24px; text-align: center;">
  <p style="color: var(--text-muted); font-size: 0.9rem;">Shard Rebalancing for Payment Systems -- Airbnb System Design Collection</p>
  <p style="color: var(--text-muted); font-size: 0.82rem; margin-top: 8px;">Topic 16 of 18 | PE-Level Depth</p>
  <a href="index.html" style="display:inline-block; margin-top:16px; color:var(--secondary); text-decoration:none; font-weight:600; padding:10px 28px; border:1px solid rgba(0,166,153,0.3); border-radius:10px; background:rgba(0,166,153,0.15); transition: all 0.3s;">&#8592; Back to All Topics</a>
</div>

<script>
document.querySelectorAll('.toc a[href^="#"], nav a[href^="#"]').forEach(function(link) {
  link.addEventListener('click', function() {
    var id = this.getAttribute('href').slice(1);
    var section = document.getElementById(id);
    if (section) { var d = section.querySelector('details'); if (d) d.open = true; }
  });
});
</script>

<script>
(function(){
  document.querySelectorAll(".diagram-box").forEach(function(box){
    var svg=box.querySelector("svg");
    if(!svg) return;
    var zoom=1, minZ=0.5, maxZ=3;
    var ctrl=document.createElement("div");
    ctrl.className="diagram-zoom-controls";
    ctrl.innerHTML='<button class="zoom-out" title="Zoom Out"></button><span class="zoom-level">100%</span><button class="zoom-in" title="Zoom In">+</button><button class="zoom-reset" title="Reset"></button><button class="zoom-fs" title="Fullscreen"></button>';
    box.insertBefore(ctrl,box.firstChild);
    var lvl=ctrl.querySelector(".zoom-level");
    function apply(){svg.style.transform="scale("+zoom+")";lvl.textContent=Math.round(zoom*100)+"%";}
    ctrl.querySelector(".zoom-in").onclick=function(){zoom=Math.min(maxZ,zoom+0.25);apply();};
    ctrl.querySelector(".zoom-out").onclick=function(){zoom=Math.max(minZ,zoom-0.25);apply();};
    ctrl.querySelector(".zoom-reset").onclick=function(){zoom=1;apply();};
    ctrl.querySelector(".zoom-fs").onclick=function(){
      box.classList.toggle("fullscreen");
      if(box.classList.contains("fullscreen")){this.textContent="";zoom=1.2;}else{this.textContent="";zoom=1;}
      apply();
    };
    box.addEventListener("wheel",function(e){
      if(e.ctrlKey){e.preventDefault();zoom=e.deltaY<0?Math.min(maxZ,zoom+0.1):Math.max(minZ,zoom-0.1);apply();}
    },{passive:false});
  });
})();
</script>
</body>
</html>