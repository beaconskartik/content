<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Distributed Job Scheduler - Airbnb System Design</title>
<style>
  :root {
    --primary: #FF5A5F;
    --primary-dark: #E04850;
    --secondary: #00A699;
    --accent: #FC642D;
    --purple: #7B2FF7;
    --blue: #428BF9;
    --dark: #ffffff;
    --darker: #f1f5f9;
    --card-bg: #ffffff;
    --card-border: #e2e8f0;
    --text: #1e293b;
    --text-muted: #4b5563;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--dark);
    color: var(--text);
    line-height: 1.7;
    scroll-behavior: smooth;
  }

  /* ===== HERO ===== */
  .hero {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #6B73FF 100%);
    padding: 60px 40px 50px;
    text-align: center;
    border-bottom: 3px solid var(--purple);
    position: relative;
    overflow: hidden;
  }
  .hero::before {
    content: '';
    position: absolute;
    top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: radial-gradient(circle at 30% 50%, rgba(123,47,247,0.08) 0%, transparent 50%),
                radial-gradient(circle at 70% 50%, rgba(0,166,153,0.15) 0%, transparent 50%);
    animation: pulse 8s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
  .hero h1 {
    font-size: 2.6em;
    background: linear-gradient(135deg, var(--purple), var(--blue), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    position: relative;
    margin-bottom: 10px;
  }
  .hero .subtitle {
    font-size: 1.15em;
    color: rgba(255,255,255,0.9);
    position: relative;
    margin-bottom: 8px;
  }
  .hero .topic-number {
    position: relative;
    display: inline-block;
    background: rgba(123,47,247,0.2);
    color: var(--purple);
    border: 1px solid var(--purple);
    padding: 4px 16px;
    border-radius: 20px;
    font-size: 0.85em;
    font-weight: 600;
    margin-bottom: 15px;
  }
  .hero .back-link {
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: #ffffff;
    text-decoration: none;
    font-size: 0.95em;
    font-weight: 600;
    padding: 10px 24px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.4);
    background: rgba(255,255,255,0.15);
    transition: all 0.3s;
    margin-top: 10px;
  }
  .hero .back-link:hover {
    background: rgba(255,255,255,0.25);
    border-color: #e5e7eb;
    transform: translateX(-3px);
  }
  .hero .stats-row {
    position: relative;
    display: flex;
    justify-content: center;
    gap: 40px;
    margin-top: 25px;
    flex-wrap: wrap;
  }
  .hero .stat-item { text-align: center; }
  .hero .stat-value {
    font-size: 1.8em;
    font-weight: 800;
    color: #ffffff;
  }
  .hero .stat-label {
    font-size: 0.75em;
    color: rgba(255,255,255,0.75);
    text-transform: uppercase;
    letter-spacing: 1.5px;
  }

  /* ===== BADGES ===== */
  .badge {
    display: inline-block;
    padding: 4px 14px;
    border-radius: 20px;
    font-size: 0.78em;
    font-weight: 600;
    margin: 3px 2px;
    white-space: nowrap;
  }
  .badge-red { background: #ef4444; color: #ffffff; border: 1px solid #dc2626; }
  .badge-green { background: #10b981; color: #ffffff; border: 1px solid #059669; }
  .badge-blue { background: #428BF9; color: #ffffff; border: 1px solid #2563eb; }
  .badge-purple { background: #7B2FF7; color: #ffffff; border: 1px solid #6d28d9; }
  .badge-orange { background: #f59e0b; color: #ffffff; border: 1px solid #d97706; }
  .badge-yellow { background: rgba(245,158,11,0.2); color: var(--warning); border: 1px solid var(--warning); }

  /* ===== STICKY NAV ===== */
  .toc {
    background: #f8fafc;
    padding: 20px 40px;
    border-bottom: 1px solid var(--card-border);
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(10px);
  }
  .toc h2 {
    color: var(--purple);
    margin-bottom: 10px;
    font-size: 0.85em;
    text-transform: uppercase;
    letter-spacing: 2px;
  }
  .toc-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  .toc a {
    color: var(--text-muted);
    text-decoration: none;
    padding: 6px 16px;
    border-radius: 8px;
    font-size: 0.82em;
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    background: var(--card-bg);
    transition: all 0.3s;
    white-space: nowrap;
  }
  .toc a:hover {
    color: var(--purple);
    border-color: var(--purple);
    background: rgba(123,47,247,0.1);
  }

  /* ===== CONTAINER ===== */
  .container { max-width: 1200px; margin: 0 auto; padding: 30px 40px; }

  /* ===== SECTIONS ===== */
  section { margin-bottom: 55px; }
  section > h2,
  section > details > summary > h2 {
    font-size: 1.7em;
    margin-bottom: 22px;
    padding-bottom: 12px;
    border-bottom: 2px solid #e5e7eb;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 40px; height: 40px;
    border-radius: 10px;
    font-size: 1.2em;
    flex-shrink: 0;
  }
  h3 {
    font-size: 1.25em;
    color: var(--blue);
    margin: 22px 0 12px;
  }
  h4 {
    font-size: 1.05em;
    color: var(--text);
    margin: 16px 0 10px;
  }
  p { margin-bottom: 12px; }
  ul, ol {
    margin: 10px 0 16px 24px;
  }
  li { margin-bottom: 6px; }

  /* ===== CARDS ===== */
  .card {
    background: var(--card-bg);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 20px;
    transition: border-color 0.3s;
  }
  .card:hover { border-color: rgba(123,47,247,0.4); }
  .card h4 {
    font-size: 1.1em;
    margin-bottom: 12px;
    margin-top: 0;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .card-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
  }
  .card-grid-3 {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
  }

  /* ===== TABLES ===== */
  .table-wrap {
    overflow-x: auto;
    border-radius: 12px;
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    margin-bottom: 20px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.88em;
  }
  th {
    background: #f8fafc;
    padding: 13px 16px;
    text-align: left;
    font-weight: 600;
    color: var(--purple);
    border-bottom: 2px solid #e5e7eb;
    white-space: nowrap;
  }
  td {
    padding: 11px 16px;
    border-bottom: 1px solid var(--card-border);
    vertical-align: top;
  }
  tr:hover td { background: rgba(123,47,247,0.04); }
  tr:last-child td { border-bottom: none; }

  /* ===== CODE BLOCKS ===== */
  pre {
    background: #f6f8fa;
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 10px;
    padding: 20px;
    overflow-x: auto;
    font-size: 0.85em;
    line-height: 1.6;
    margin-bottom: 20px;
    position: relative;
  }
  pre .code-label {
    position: absolute;
    top: 8px;
    right: 12px;
    font-size: 0.72em;
    color: var(--text-muted);
    background: rgba(123,47,247,0.08);
    padding: 2px 10px;
    border-radius: 4px;
    font-family: 'Segoe UI', system-ui, sans-serif;
  }
  code {
    font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
    color: #24292f;
  }
  .inline-code {
    background: rgba(123,47,247,0.15);
    color: var(--purple);
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.88em;
    font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
  }
  .kw { color: #cf222e; }
  .str { color: #0a3069; }
  .cm { color: #6e7781; }
  .fn { color: #8250df; }
  .num { color: #0550ae; }
  .type { color: #953800; }
  .op { color: #cf222e; }

  /* ===== TIP / INFO / WARNING BOXES ===== */
  .tip-box {
    border-radius: 10px;
    padding: 18px 22px;
    margin-bottom: 20px;
    display: flex;
    gap: 14px;
    align-items: flex-start;
    font-size: 0.92em;
    line-height: 1.6;
  }
  .tip-box .tip-icon {
    font-size: 1.3em;
    flex-shrink: 0;
    margin-top: 2px;
  }
  .tip-box-info {
    background: rgba(66,139,249,0.08);
    border: 1px solid rgba(66,139,249,0.3);
    color: #1e40af;
  }
  .tip-box-success {
    background: rgba(16,185,129,0.08);
    border: 1px solid rgba(16,185,129,0.3);
    color: #065f46;
  }
  .tip-box-warning {
    background: rgba(245,158,11,0.08);
    border: 1px solid rgba(245,158,11,0.3);
    color: #92400e;
  }
  .tip-box-danger {
    background: rgba(239,68,68,0.08);
    border: 1px solid rgba(239,68,68,0.3);
    color: #991b1b;
  }
  .tip-box-purple {
    background: rgba(123,47,247,0.08);
    border: 1px solid rgba(123,47,247,0.3);
    color: #5b21b6;
  }

  /* ===== ARCHITECTURE DIAGRAM ===== */
  .arch-diagram {
    background: #f6f8fa;
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 12px;
    padding: 30px;
    margin: 20px 0;
    overflow-x: auto;
    font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
    font-size: 0.78em;
    line-height: 1.5;
    color: var(--text-muted);
    white-space: pre;
  }
  .diagram-box {
    background: rgba(0,0,0,0.05);
    border-radius: 12px;
    padding: 20px;
    overflow-x: auto;
    margin: 20px 0;
  }
  .arch-diagram .comp {
    color: var(--purple);
    font-weight: 700;
  }
  .arch-diagram .store {
    color: #1e293b;
    font-weight: 700;
  }
  .arch-diagram .flow {
    color: var(--blue);
  }
  .arch-diagram .label {
    color: var(--warning);
  }
  .arch-diagram .highlight {
    color: var(--primary);
    font-weight: 700;
  }

  /* ===== STATE DIAGRAM ===== */
  .state-diagram {
    background: #f6f8fa;
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 12px;
    padding: 24px;
    margin: 20px 0;
    overflow-x: auto;
    font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
    font-size: 0.82em;
    line-height: 1.4;
    color: var(--text-muted);
    white-space: pre;
    text-align: center;
  }
  .state-diagram .state { color: var(--blue); font-weight: 700; }
  .state-diagram .arrow { color: var(--text-muted); }
  .state-diagram .action { color: var(--warning); }
  .state-diagram .fail { color: var(--danger); font-weight: 700; }
  .state-diagram .ok { color: var(--success); font-weight: 700; }

  /* ===== COMPARISON LIST ===== */
  .comparison {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }
  .comparison .side {
    background: var(--card-bg);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 12px;
    padding: 20px;
  }
  .comparison .side h4 {
    margin-top: 0;
    margin-bottom: 12px;
  }
  .comparison .side.pro { border-left: 3px solid var(--success); }
  .comparison .side.con { border-left: 3px solid var(--danger); }

  /* ===== METRIC HIGHLIGHT ===== */
  .metric {
    display: inline-block;
    color: var(--warning);
    font-weight: 700;
    font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
    font-size: 0.95em;
  }

  /* ===== FOOTER ===== */
  .footer {
    text-align: center;
    padding: 40px 30px;
    color: var(--text-muted);
    font-size: 0.85em;
    border-top: 1px solid #e5e7eb;
  }
  .footer a {
    color: var(--purple);
    text-decoration: none;
  }
  .footer a:hover { color: var(--primary); }

  /* ===== RESPONSIVE ===== */
  @media (max-width: 768px) {
    .hero { padding: 40px 20px 35px; }
    .hero h1 { font-size: 1.7em; }
    .toc { padding: 14px 20px; }
    .container { padding: 20px 16px; }
    .card-grid, .card-grid-3 { grid-template-columns: 1fr; }
    .comparison { grid-template-columns: 1fr; }
    section > h2 { font-size: 1.3em; }
    .arch-diagram { font-size: 0.65em; padding: 16px; }
    table { font-size: 0.82em; display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .diagram-box { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .diagram-box svg { min-width: 600px; }
  }
  @media (max-width: 480px) {
    .hero h1 { font-size: 1.4em; }
    .hero .stats-row { gap: 20px; }
    .hero .stat-value { font-size: 1.4em; }
  }
  @media (max-width: 360px) {
    .hero h1 { font-size: 1.15em; }
    .hero .stat-value { font-size: 1em; }
    .container { padding: 10px 8px; }
  }
  /* === DIAGRAM ZOOM CONTROLS === */
  .diagram-box { position: relative; }
  .diagram-zoom-controls {
    position: absolute; top: 12px; right: 12px; z-index: 10;
    display: flex; gap: 4px; opacity: 0.5; transition: opacity 0.3s;
  }
  .diagram-box:hover .diagram-zoom-controls { opacity: 1; }
  .diagram-zoom-controls button {
    width: 32px; height: 32px; border-radius: 8px; border: 1px solid #e5e7eb;
    background: #ffffff; color: #1e293b; cursor: pointer; font-size: 16px;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.2s;
    font-family: system-ui; line-height: 1; padding: 0;
  }
  .diagram-zoom-controls button:hover { background: #f1f5f9; border-color: var(--blue); color: var(--blue); }
  .diagram-zoom-controls button:active { transform: scale(0.95); }
  .diagram-zoom-controls .zoom-level {
    font-size: 11px; color: #64748b; display: flex; align-items: center;
    padding: 0 6px; font-weight: 600; min-width: 40px; justify-content: center;
  }
  .diagram-box svg { transition: transform 0.3s ease; transform-origin: center center; }
  .diagram-box.fullscreen {
    position: fixed !important; top: 0; left: 0; width: 100vw; height: 100vh;
    z-index: 9999; background: #ffffff; border-radius: 0; padding: 20px;
    display: flex; align-items: center; justify-content: center;
    overflow: auto;
  }
  .diagram-box.fullscreen .diagram-zoom-controls { opacity: 1; top: 20px; right: 20px; }

  /* ===== COLLAPSIBLE SECTIONS ===== */
  details { margin-bottom: 0; }
  details summary {
    cursor: pointer;
    list-style: none;
    user-select: none;
    padding: 0;
  }
  details summary::-webkit-details-marker { display: none; }
  details summary::marker { display: none; content: ''; }
  details summary h2 { display: inline-flex; }
  details summary h2::before {
    content: '\25B6';
    display: inline-flex;
    align-items: center;
    margin-right: 8px;
    transition: transform 0.2s;
    font-size: 0.5em;
    color: var(--text-muted);
  }
  details[open] summary h2::before {
    transform: rotate(90deg);
  }
  .toggle-controls {
    display: flex;
    gap: 8px;
    margin-top: 10px;
  }
  .toggle-controls button {
    padding: 5px 14px;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    background: var(--card-bg);
    color: var(--text-muted);
    font-size: 0.78em;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  }
  .toggle-controls button:hover {
    color: var(--purple);
    border-color: var(--purple);
    background: rgba(123,47,247,0.1);
  }
</style>
</head>
<body>

<!-- ============================================================ -->
<!--  HERO                                                         -->
<!-- ============================================================ -->
<div class="hero">
  <a href="index.html" class="back-link">&#8592; Back to All Topics</a>
  <div class="topic-number">Topic 08 &mdash; Infrastructure</div>
  <h1>Distributed Job Scheduler</h1>
  <p class="subtitle">Airflow-like DAG Execution Engine &mdash; Principal Engineer Level</p>
  <div class="stats-row">
    <div class="stat-item">
      <div class="stat-value">100K+</div>
      <div class="stat-label">Jobs / Day</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">500K</div>
      <div class="stat-label">Task Executions</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">&lt;1s</div>
      <div class="stat-label">Schedule Latency</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">99.99%</div>
      <div class="stat-label">Uptime SLA</div>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!--  TABLE OF CONTENTS                                            -->
<!-- ============================================================ -->
<nav class="toc">
  <h2>Sections</h2>
  <div class="toc-grid">
    <a href="#overview">Overview</a>
    <a href="#requirements">Requirements</a>
    <a href="#capacity">Capacity Estimates</a>
    <a href="#architecture">Architecture</a>
    <a href="#dag-model">DAG Model</a>
    <a href="#scheduling-engine">Scheduling Engine</a>
    <a href="#execution-model">Execution Model</a>
    <a href="#fault-tolerance">Fault Tolerance</a>
    <a href="#scalability">Scalability</a>
    <a href="#tradeoffs">Trade-offs</a>
    <a href="#deep-dives">Deep Dives</a>
    <a href="#interview-tips">Interview Tips</a>
  </div>
  <div class="toggle-controls">
    <button onclick="document.querySelectorAll('.container details').forEach(d=>d.open=true)">Expand All</button>
    <button onclick="document.querySelectorAll('.container details').forEach(d=>d.open=false)">Collapse All</button>
  </div>
</nav>

<div class="container">

<!-- ============================================================ -->
<!--  1. OVERVIEW                                                  -->
<!-- ============================================================ -->
<section id="overview">
  <details open>
  <summary><h2><span class="icon" style="background:rgba(123,47,247,0.15); color:var(--purple);">&#9881;</span> Overview</h2></summary>

  <p>Design a <strong>distributed job scheduler</strong> comparable to Apache Airflow. The system orchestrates complex computational workflows expressed as <strong>Directed Acyclic Graphs (DAGs)</strong>, where each node represents a task and edges encode dependencies. It must support cron-based schedules, event-triggered execution, retries with exponential backoff, and priority-based queuing.</p>

  <div class="card-grid">
    <div class="card">
      <h4>&#128640; Primary Use Cases</h4>
      <ul>
        <li><strong>ETL Pipelines</strong> &mdash; Extract data from production DBs, transform, load into data warehouse</li>
        <li><strong>ML Training Pipelines</strong> &mdash; Feature engineering, model training, evaluation, deployment</li>
        <li><strong>Data Backfills</strong> &mdash; Reprocess historical data windows when logic changes</li>
        <li><strong>Report Generation</strong> &mdash; Nightly revenue reports, host payouts, compliance exports</li>
        <li><strong>Infrastructure Automation</strong> &mdash; Database maintenance, log rotation, cache warming</li>
      </ul>
    </div>
    <div class="card">
      <h4>&#127919; Key Design Challenges</h4>
      <ul>
        <li><strong>Exactly-once execution</strong> &mdash; No duplicate task runs even under failures</li>
        <li><strong>Dependency resolution</strong> &mdash; Complex DAG topologies with fan-in/fan-out</li>
        <li><strong>Scheduler HA</strong> &mdash; Crash recovery without losing in-flight state</li>
        <li><strong>Multi-tenant isolation</strong> &mdash; Prevent noisy neighbors from starving others</li>
        <li><strong>Horizontal scalability</strong> &mdash; Scale to 100K+ jobs per day</li>
      </ul>
    </div>
  </div>

  <div class="tip-box tip-box-purple">
    <span class="tip-icon">&#128161;</span>
    <div><strong>Why Airbnb needs this:</strong> Airbnb runs thousands of data pipelines daily for pricing optimization, search ranking, fraud detection, financial reconciliation, and experimentation analysis. A reliable job scheduler is foundational infrastructure that powers every data-driven decision.</div>
  </div>
  </details>
</section>

<!-- ============================================================ -->
<!--  2. REQUIREMENTS                                              -->
<!-- ============================================================ -->
<section id="requirements">
  <details open>
  <summary><h2><span class="icon" style="background:rgba(66,139,249,0.08); color:var(--blue);">&#128203;</span> Requirements</h2></summary>

  <div class="card-grid">
    <div class="card">
      <h4 style="color:var(--secondary);">&#9989; Functional Requirements</h4>
      <ol>
        <li><strong>DAG Definition</strong> &mdash; Define jobs as DAGs of tasks with typed operators</li>
        <li><strong>Scheduling</strong> &mdash; Cron-based, one-time, and event-triggered execution</li>
        <li><strong>Dependency Management</strong> &mdash; Tasks execute only when all upstream deps succeed</li>
        <li><strong>Retry with Backoff</strong> &mdash; Configurable retries with exponential backoff</li>
        <li><strong>Priority Queues</strong> &mdash; Multiple priority levels for task ordering</li>
      </ol>
    </div>
    <div class="card">
      <h4 style="color:var(--primary);">&#9888; Non-Functional Requirements</h4>
      <ol>
        <li><strong>Exactly-once Execution</strong> &mdash; No duplicate task runs even under failover</li>
        <li><strong>Fault Tolerance</strong> &mdash; Scheduler crash recovery with zero data loss</li>
        <li><strong>Scalability</strong> &mdash; 100K+ jobs/day with horizontal scaling</li>
        <li><strong>Availability</strong> &mdash; 99.99% uptime for the scheduling control plane</li>
      </ol>
    </div>
  </div>
  </details>
</section>

<!-- ============================================================ -->
<!--  3. CAPACITY ESTIMATES                                        -->
<!-- ============================================================ -->
<section id="capacity">
  <details>
  <summary><h2><span class="icon" style="background:rgba(245,158,11,0.15); color:var(--warning);">&#128200;</span> Capacity Estimates</h2></summary>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Metric</th>
          <th>Value</th>
          <th>Derivation</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Total DAG Runs / Day</strong></td>
          <td><span class="metric">100,000</span></td>
          <td>Based on all teams: data eng, ML, analytics, ops</td>
        </tr>
        <tr>
          <td><strong>Avg Tasks per DAG</strong></td>
          <td><span class="metric">5</span></td>
          <td>Typical ETL: extract + transform + validate + load + notify</td>
        </tr>
        <tr>
          <td><strong>Task Executions / Day</strong></td>
          <td><span class="metric">500,000</span></td>
          <td>100K DAGs x 5 tasks</td>
        </tr>
        <tr>
          <td><strong>Avg Task Throughput</strong></td>
          <td><span class="metric">~6 TPS</span></td>
          <td>500K / 86,400 seconds</td>
        </tr>
        <tr>
          <td><strong>Peak Throughput</strong></td>
          <td><span class="metric">~50 TPS</span></td>
          <td>Midnight batch schedules (8-10x average)</td>
        </tr>
        <tr>
          <td><strong>Metadata Storage / Day</strong></td>
          <td><span class="metric">~1 GB</span></td>
          <td>500K task instances x 2 KB avg per record</td>
        </tr>
        <tr>
          <td><strong>Log Storage / Day</strong></td>
          <td><span class="metric">~50 GB</span></td>
          <td>500K tasks x 100 KB avg log output</td>
        </tr>
        <tr>
          <td><strong>Metadata DB Size (1 year)</strong></td>
          <td><span class="metric">~365 GB</span></td>
          <td>1 GB/day x 365 (with archival for older data)</td>
        </tr>
        <tr>
          <td><strong>Log Storage (1 year)</strong></td>
          <td><span class="metric">~18 TB</span></td>
          <td>50 GB/day x 365 (tiered: hot 30d, warm 90d, cold archive)</td>
        </tr>
        <tr>
          <td><strong>Concurrent Workers</strong></td>
          <td><span class="metric">200-500</span></td>
          <td>To handle peak 50 TPS with avg 10s task duration</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="tip-box tip-box-info">
    <span class="tip-icon">&#128202;</span>
    <div><strong>Key insight:</strong> The scheduling control plane is relatively low throughput (50 TPS peak) compared to user-facing services. The real challenge is <strong>state management correctness</strong> (exactly-once semantics) and <strong>worker orchestration</strong> (scaling to handle variable task durations from seconds to hours).</div>
  </div>
  </details>
</section>

<!-- ============================================================ -->
<!--  4. HIGH-LEVEL ARCHITECTURE                                   -->
<!-- ============================================================ -->
<section id="architecture">
  <details>
  <summary><h2><span class="icon" style="background:rgba(123,47,247,0.15); color:var(--purple);">&#127959;</span> High-Level Architecture</h2></summary>

  <div class="diagram-box">
  <svg viewBox="0 0 1300 460" xmlns="http://www.w3.org/2000/svg" font-family="Segoe UI, system-ui, sans-serif">
    <defs>
      <filter id="shadow2" x="-4%" y="-4%" width="108%" height="112%">
        <feDropShadow dx="1" dy="2" stdDeviation="3" flood-color="#000" flood-opacity="0.5"/>
      </filter>
      <linearGradient id="g2a" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#FF5A5F"/><stop offset="100%" stop-color="#E04850"/></linearGradient>
      <linearGradient id="g2b" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#428BF9"/><stop offset="100%" stop-color="#2d6fd9"/></linearGradient>
      <linearGradient id="g2c" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#00A699"/><stop offset="100%" stop-color="#008578"/></linearGradient>
      <linearGradient id="g2d" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#7B2FF7"/><stop offset="100%" stop-color="#5a1dbf"/></linearGradient>
      <linearGradient id="g2e" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#f59e0b"/><stop offset="100%" stop-color="#d97706"/></linearGradient>
      <marker id="ah2" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8"/></marker>
      <marker id="ah2d" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#ef4444"/></marker>
    </defs>

    <!-- ===== TITLE ===== -->
    <text x="650" y="25" text-anchor="middle" fill="#f59e0b" font-size="15" font-weight="700" letter-spacing="2">DISTRIBUTED JOB SCHEDULER &#8212; SYSTEM ARCHITECTURE</text>

    <!-- ======================================================================== -->
    <!-- MAIN PIPELINE (left → right)                                             -->
    <!-- ======================================================================== -->

    <!-- ===== 1. CLIENTS (Web UI + CLI/SDK) ===== -->
    <rect x="20" y="55" width="130" height="100" rx="10" fill="url(#g2b)" filter="url(#shadow2)" opacity="0.92"/>
    <rect x="48" y="65" width="20" height="14" rx="2" fill="none" stroke="#fff" stroke-width="1.3"/>
    <line x1="58" y1="79" x2="58" y2="84" stroke="#fff" stroke-width="1.3"/>
    <line x1="52" y1="84" x2="64" y2="84" stroke="#fff" stroke-width="1.3"/>
    <text x="73" y="77" fill="#fff" font-size="10" font-weight="700">Web UI /</text>
    <text x="73" y="89" fill="#fff" font-size="10" font-weight="700">Dashboard</text>
    <line x1="35" y1="100" x2="135" y2="100" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>
    <rect x="40" y="108" width="18" height="13" rx="2" fill="none" stroke="#fff" stroke-width="1.2"/>
    <text x="44" y="119" fill="#fff" font-size="8" font-weight="700">&gt;_</text>
    <text x="65" y="119" fill="#fff" font-size="10" font-weight="700">CLI / SDK</text>
    <text x="85" y="143" text-anchor="middle" fill="rgba(255,255,255,0.7)" font-size="7">Python / Java</text>

    <!-- Arrow: Clients → API Gateway -->
    <line x1="150" y1="105" x2="195" y2="105" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#ah2)"/>

    <!-- ===== 2. API GATEWAY ===== -->
    <rect x="200" y="65" width="140" height="80" rx="10" fill="url(#g2a)" filter="url(#shadow2)" opacity="0.92"/>
    <path d="M226,76 L226,92 Q226,100 236,103 Q246,100 246,92 L246,76 L236,71 Z" fill="none" stroke="#fff" stroke-width="1.3"/>
    <polyline points="231,90 235,94 241,84" fill="none" stroke="#fff" stroke-width="1.3"/>
    <text x="252" y="88" fill="#fff" font-size="11" font-weight="700">API Gateway</text>
    <text x="252" y="102" fill="rgba(255,255,255,0.9)" font-size="8">REST / gRPC</text>
    <text x="270" y="130" text-anchor="middle" fill="rgba(255,255,255,0.7)" font-size="7">Auth, routing, rate limit</text>

    <!-- Arrow: API GW → Scheduler -->
    <line x1="340" y1="105" x2="390" y2="105" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#ah2)"/>

    <!-- ===== 3. SCHEDULER ===== -->
    <rect x="395" y="50" width="170" height="95" rx="10" fill="#f8fafc" stroke="#7B2FF7" stroke-width="2" filter="url(#shadow2)"/>
    <circle cx="425" cy="82" r="10" fill="none" stroke="#7B2FF7" stroke-width="1.5"/>
    <line x1="425" y1="82" x2="425" y2="76" stroke="#7B2FF7" stroke-width="1.5"/>
    <line x1="425" y1="82" x2="430" y2="85" stroke="#7B2FF7" stroke-width="1.5"/>
    <circle cx="425" cy="82" r="1.5" fill="#7B2FF7"/>
    <text x="441" y="81" fill="#7B2FF7" font-size="11" font-weight="700">SCHEDULER</text>
    <text x="441" y="94" fill="#94a3b8" font-size="8">Leader-elected</text>
    <rect x="412" y="110" width="56" height="14" rx="7" fill="rgba(123,47,247,0.2)" stroke="#7B2FF7" stroke-width="0.5"/>
    <text x="440" y="121" text-anchor="middle" fill="#7B2FF7" font-size="7" font-weight="600">tick loop</text>
    <text x="474" y="121" fill="#94a3b8" font-size="7">dep resolve</text>
    <text x="474" y="132" fill="#94a3b8" font-size="7">task queue</text>

    <!-- Arrow: Scheduler → Executor -->
    <line x1="565" y1="100" x2="615" y2="100" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#ah2)"/>

    <!-- ===== 4. EXECUTOR ===== -->
    <rect x="620" y="65" width="140" height="80" rx="10" fill="#f8fafc" stroke="#FC642D" stroke-width="1.5" filter="url(#shadow2)"/>
    <polygon points="648,76 643,90 651,88 646,104 656,86 650,88" fill="none" stroke="#FC642D" stroke-width="1.1"/>
    <text x="662" y="92" fill="#FC642D" font-size="11" font-weight="700">Executor</text>
    <text x="662" y="106" fill="#94a3b8" font-size="8">Task dispatch</text>
    <text x="690" y="130" text-anchor="middle" fill="#94a3b8" font-size="7">Kafka / K8s / Local</text>

    <!-- Arrow: Executor → Queue -->
    <line x1="760" y1="105" x2="810" y2="105" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#ah2)"/>

    <!-- ===== 5. MESSAGE QUEUE ===== -->
    <rect x="815" y="65" width="150" height="80" rx="10" fill="#f8fafc" stroke="#ef4444" stroke-width="1.5" filter="url(#shadow2)"/>
    <polygon points="843,100 851,91 859,100 851,109" fill="none" stroke="#ef4444" stroke-width="1.3"/>
    <polygon points="851,94 854,100 851,106 848,100" fill="#ef4444" opacity="0.4"/>
    <text x="867" y="97" fill="#ef4444" font-size="10" font-weight="700">Kafka</text>
    <text x="867" y="111" fill="#94a3b8" font-size="8">Task Topics</text>
    <text x="890" y="130" text-anchor="middle" fill="#94a3b8" font-size="7">Priority topics, DLQ</text>

    <!-- Arrow: Queue → Workers -->
    <line x1="965" y1="105" x2="1015" y2="105" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#ah2)"/>

    <!-- ===== 6. WORKER POOL ===== -->
    <rect x="1020" y="50" width="150" height="110" rx="10" fill="#f8fafc" stroke="#7B2FF7" stroke-width="1.5" filter="url(#shadow2)"/>
    <text x="1095" y="70" text-anchor="middle" fill="#FF5A5F" font-size="10" font-weight="700">Worker Pool</text>
    <rect x="1035" y="78" width="120" height="18" rx="5" fill="rgba(123,47,247,0.08)" stroke="#7B2FF7" stroke-width="0.5"/>
    <text x="1095" y="91" text-anchor="middle" fill="#7B2FF7" font-size="8">Worker 1</text>
    <rect x="1035" y="100" width="120" height="18" rx="5" fill="rgba(123,47,247,0.08)" stroke="#7B2FF7" stroke-width="0.5"/>
    <text x="1095" y="113" text-anchor="middle" fill="#7B2FF7" font-size="8">Worker 2</text>
    <rect x="1035" y="122" width="120" height="18" rx="5" fill="rgba(123,47,247,0.08)" stroke="#7B2FF7" stroke-width="0.5"/>
    <text x="1095" y="135" text-anchor="middle" fill="#7B2FF7" font-size="8">Worker N</text>
    <text x="1095" y="153" text-anchor="middle" fill="#94a3b8" font-size="7">Heartbeat, Execute</text>

    <!-- ======================================================================== -->
    <!-- SECOND ROW: SUPPORTING SERVICES                                          -->
    <!-- ======================================================================== -->

    <!-- Arrow: API GW → DAG Processor (vertical) -->
    <line x1="270" y1="145" x2="270" y2="200" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#ah2)"/>

    <!-- ===== 7. DAG PROCESSOR ===== -->
    <rect x="200" y="205" width="140" height="65" rx="10" fill="#f8fafc" stroke="#00A699" stroke-width="2" filter="url(#shadow2)"/>
    <circle cx="228" cy="226" r="3.5" fill="#00A699"/>
    <circle cx="220" cy="240" r="3.5" fill="#00A699"/>
    <circle cx="236" cy="240" r="3.5" fill="#00A699"/>
    <line x1="228" y1="229" x2="220" y2="237" stroke="#00A699" stroke-width="1"/>
    <line x1="228" y1="229" x2="236" y2="237" stroke="#00A699" stroke-width="1"/>
    <text x="246" y="230" fill="#00A699" font-size="10" font-weight="700">DAG Processor</text>
    <text x="246" y="244" fill="#94a3b8" font-size="8">Parse &amp; serialize</text>
    <text x="246" y="256" fill="#94a3b8" font-size="7">Validate, version ctrl</text>

    <!-- Arrow: DAG Proc → PostgreSQL (horizontal) -->
    <line x1="340" y1="237" x2="390" y2="237" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#ah2)"/>
    <text x="365" y="231" text-anchor="middle" fill="#94a3b8" font-size="7">write</text>

    <!-- Arrow: Scheduler → PostgreSQL (vertical) -->
    <line x1="480" y1="145" x2="480" y2="200" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#ah2)"/>

    <!-- ===== 8. POSTGRESQL ===== -->
    <rect x="395" y="205" width="375" height="55" rx="10" fill="#f8fafc" stroke="#428BF9" stroke-width="2" filter="url(#shadow2)"/>
    <ellipse cx="425" cy="222" rx="13" ry="5" fill="#428BF9" opacity="0.3" stroke="#428BF9" stroke-width="1"/>
    <rect x="412" y="222" width="26" height="16" fill="#f8fafc"/>
    <line x1="412" y1="222" x2="412" y2="238" stroke="#428BF9" stroke-width="1"/>
    <line x1="438" y1="222" x2="438" y2="238" stroke="#428BF9" stroke-width="1"/>
    <ellipse cx="425" cy="238" rx="13" ry="5" fill="none" stroke="#428BF9" stroke-width="1"/>
    <text x="450" y="228" fill="#428BF9" font-size="12" font-weight="700">PostgreSQL</text>
    <text x="450" y="244" fill="#94a3b8" font-size="8">Metadata DB + Read Replicas</text>
    <text x="620" y="244" fill="#94a3b8" font-size="7">dag | task | dag_run | task_instance</text>

    <!-- Workers → S3 (vertical) -->
    <line x1="1095" y1="160" x2="1095" y2="295" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#ah2)"/>

    <!-- ===== 9. S3 LOG STORAGE ===== -->
    <rect x="1030" y="300" width="130" height="45" rx="10" fill="#f8fafc" stroke="#4caf50" stroke-width="1.5" filter="url(#shadow2)"/>
    <path d="M1052,307 L1048,337 Q1054,342 1060,337 L1056,307 Z" fill="none" stroke="#4caf50" stroke-width="1.2"/>
    <text x="1068" y="320" fill="#4caf50" font-size="10" font-weight="700">S3 Log Storage</text>
    <text x="1068" y="334" fill="#94a3b8" font-size="7">stdout/stderr, artifacts</text>

    <!-- Workers → PostgreSQL (dashed status update, routed below main row) -->
    <polyline points="1020,155 1020,185 770,185 770,205" fill="none" stroke="#94a3b8" stroke-width="1" stroke-dasharray="4,3" marker-end="url(#ah2)"/>

    <!-- ======================================================================== -->
    <!-- THIRD ROW: EVENT LAYER                                                   -->
    <!-- ======================================================================== -->

    <!-- Arrow: PostgreSQL → Event Bus (vertical) -->
    <line x1="500" y1="260" x2="500" y2="325" stroke="#ef4444" stroke-width="1.2" stroke-dasharray="4,3" marker-end="url(#ah2d)"/>

    <!-- ===== 10. EVENT BUS ===== -->
    <rect x="430" y="330" width="140" height="55" rx="10" fill="#f8fafc" stroke="#ef4444" stroke-width="1.5" filter="url(#shadow2)"/>
    <circle cx="456" cy="349" r="3.5" fill="#ef4444"/>
    <circle cx="456" cy="362" r="3.5" fill="#ef4444"/>
    <circle cx="468" cy="355" r="3.5" fill="#ef4444"/>
    <line x1="459" y1="349" x2="465" y2="355" stroke="#ef4444" stroke-width="1"/>
    <line x1="459" y1="362" x2="465" y2="355" stroke="#ef4444" stroke-width="1"/>
    <text x="478" y="352" fill="#ef4444" font-size="10" font-weight="700">Event Bus</text>
    <text x="478" y="365" fill="#94a3b8" font-size="8">Kafka</text>
    <text x="478" y="378" fill="#94a3b8" font-size="7">Triggers, callbacks, audit</text>

    <!-- Arrow: Event Bus → Alerting -->
    <line x1="570" y1="357" x2="615" y2="357" stroke="#ef4444" stroke-width="1.2" stroke-dasharray="4,3" marker-end="url(#ah2d)"/>

    <!-- ===== 11. ALERTING ===== -->
    <rect x="620" y="330" width="140" height="55" rx="10" fill="#f8fafc" stroke="#f59e0b" stroke-width="1.5" filter="url(#shadow2)"/>
    <path d="M646,342 Q646,334 654,334 Q662,334 662,342 L664,349 L644,349 Z" fill="none" stroke="#f59e0b" stroke-width="1"/>
    <circle cx="654" cy="352" r="1.5" fill="#f59e0b"/>
    <text x="670" y="348" fill="#f59e0b" font-size="10" font-weight="700">Alerting</text>
    <text x="670" y="362" fill="#94a3b8" font-size="8">PagerDuty, Slack</text>
    <text x="670" y="374" fill="#94a3b8" font-size="7">SLA breach, failures</text>

    <!-- ===== LEGEND ===== -->
    <rect x="1030" y="385" width="195" height="65" rx="8" fill="rgba(30,41,59,0.9)" stroke="#334155" stroke-width="1"/>
    <text x="1045" y="402" fill="#e2e8f0" font-size="9" font-weight="700">LEGEND</text>
    <line x1="1045" y1="414" x2="1070" y2="414" stroke="#94a3b8" stroke-width="1.5"/>
    <text x="1076" y="418" fill="#94a3b8" font-size="8">Sync flow</text>
    <line x1="1045" y1="429" x2="1070" y2="429" stroke="#ef4444" stroke-width="1.2" stroke-dasharray="4,3"/>
    <text x="1076" y="433" fill="#94a3b8" font-size="8">Async / event</text>
    <circle cx="1052" cy="444" r="4" fill="#428BF9"/>
    <text x="1060" y="447" fill="#94a3b8" font-size="8">PostgreSQL (metadata)</text>

    <!-- ===== NUMBERED STEP CIRCLES (every circle on a visible arrow) ===== -->
    <!-- Step 1: Clients → API Gateway -->
    <circle cx="173" cy="105" r="9" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="173" y="109" fill="#fff" font-size="9" font-weight="800" text-anchor="middle">1</text>
    <!-- Step 2: API Gateway → Scheduler -->
    <circle cx="365" cy="105" r="9" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="365" y="109" fill="#fff" font-size="9" font-weight="800" text-anchor="middle">2</text>
    <!-- Step 3: Scheduler ↔ PostgreSQL -->
    <circle cx="480" cy="172" r="9" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="480" y="176" fill="#fff" font-size="9" font-weight="800" text-anchor="middle">3</text>
    <!-- Step 4: Scheduler → Executor -->
    <circle cx="590" cy="100" r="9" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="590" y="104" fill="#fff" font-size="9" font-weight="800" text-anchor="middle">4</text>
    <!-- Step 5: Executor → Message Queue -->
    <circle cx="785" cy="105" r="9" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="785" y="109" fill="#fff" font-size="9" font-weight="800" text-anchor="middle">5</text>
    <!-- Step 6: Queue → Workers -->
    <circle cx="990" cy="105" r="9" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="990" y="109" fill="#fff" font-size="9" font-weight="800" text-anchor="middle">6</text>
    <!-- Step 7: Workers → S3 + status → PG -->
    <circle cx="1095" cy="230" r="9" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="1095" y="234" fill="#fff" font-size="9" font-weight="800" text-anchor="middle">7</text>
    <!-- Step 8: Event Bus → Alerting -->
    <circle cx="593" cy="357" r="9" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="593" y="361" fill="#fff" font-size="9" font-weight="800" text-anchor="middle">8</text>
  </svg>
  </div>

  <!-- ===== REQUEST FLOW REFERENCE ===== -->
  <div class="card" style="margin-top:24px;">
    <h4 style="color:var(--accent);">&#128204; Request Flow Reference (Numbered Steps on Diagram)</h4>
    <div style="overflow-x:auto;">
      <table style="width:100%; border-collapse:collapse; margin-top:10px; font-size:0.92em;">
        <thead>
          <tr style="border-bottom:2px solid var(--card-border);">
            <th style="padding:10px 12px; text-align:center; color:var(--primary); width:55px;">Step</th>
            <th style="padding:10px 12px; text-align:left; color:var(--accent);">Description</th>
            <th style="padding:10px 12px; text-align:left; color:var(--secondary);">Protocol / Detail</th>
          </tr>
        </thead>
        <tbody>
          <tr style="border-bottom:1px solid var(--card-border);">
            <td style="padding:8px 12px; text-align:center; font-weight:800; color:var(--primary);">1</td>
            <td style="padding:8px 12px;">User defines DAG via Web UI / CLI / SDK &rarr; API Gateway</td>
            <td style="padding:8px 12px; color:var(--text-muted);">REST / gRPC, authenticated</td>
          </tr>
          <tr style="border-bottom:1px solid var(--card-border); background:rgba(255,255,255,0.02);">
            <td style="padding:8px 12px; text-align:center; font-weight:800; color:var(--primary);">2</td>
            <td style="padding:8px 12px;">API Gateway &rarr; Scheduler &amp; DAG Processor</td>
            <td style="padding:8px 12px; color:var(--text-muted);">DAG parsed, validated, serialized to metadata DB</td>
          </tr>
          <tr style="border-bottom:1px solid var(--card-border);">
            <td style="padding:8px 12px; text-align:center; font-weight:800; color:var(--primary);">3</td>
            <td style="padding:8px 12px;">Scheduler &harr; PostgreSQL (tick loop reads PG, creates DAG Runs + Task Instances)</td>
            <td style="padding:8px 12px; color:var(--text-muted);">Leader-elected, row-level locking, dependency resolution</td>
          </tr>
          <tr style="border-bottom:1px solid var(--card-border); background:rgba(255,255,255,0.02);">
            <td style="padding:8px 12px; text-align:center; font-weight:800; color:var(--primary);">4</td>
            <td style="padding:8px 12px;">Scheduler dispatches ready tasks &rarr; Executor</td>
            <td style="padding:8px 12px; color:var(--text-muted);">Kafka / K8s / Local executor selection</td>
          </tr>
          <tr style="border-bottom:1px solid var(--card-border);">
            <td style="padding:8px 12px; text-align:center; font-weight:800; color:var(--primary);">5</td>
            <td style="padding:8px 12px;">Executor pushes tasks to Message Queue</td>
            <td style="padding:8px 12px; color:var(--text-muted);">Kafka, priority queues, DLQ</td>
          </tr>
          <tr style="border-bottom:1px solid var(--card-border); background:rgba(255,255,255,0.02);">
            <td style="padding:8px 12px; text-align:center; font-weight:800; color:var(--primary);">6</td>
            <td style="padding:8px 12px;">Workers pull tasks from Queue and execute</td>
            <td style="padding:8px 12px; color:var(--text-muted);">Heartbeat-monitored, concurrent execution</td>
          </tr>
          <tr style="border-bottom:1px solid var(--card-border);">
            <td style="padding:8px 12px; text-align:center; font-weight:800; color:var(--primary);">7</td>
            <td style="padding:8px 12px;">Workers write logs to S3, update task status in PostgreSQL</td>
            <td style="padding:8px 12px; color:var(--text-muted);">Durable logs to S3; async status callback to PG via dashed path</td>
          </tr>
          <tr>
            <td style="padding:8px 12px; text-align:center; font-weight:800; color:var(--primary);">8</td>
            <td style="padding:8px 12px;">Event Bus (Kafka) &rarr; Alerting Service (on failure / SLA breach)</td>
            <td style="padding:8px 12px; color:var(--text-muted);">PagerDuty, Slack notifications</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ===== HAPPY PATH ===== -->
  <div class="card" style="margin-top:18px; border-left:4px solid var(--success);">
    <h4 style="color:var(--success);">&#9989; Happy Path</h4>
    <p style="margin-top:8px; line-height:1.8;">
      <strong>Define DAG</strong> &rarr; Scheduler picks up on tick loop &rarr; tasks queued to Kafka &rarr; workers pull and execute &rarr; logs stored in S3 &rarr; status updated in PostgreSQL &rarr; downstream tasks triggered automatically.
    </p>
    <p style="margin-top:6px; color:var(--text-muted); font-size:0.9em;">
      Steps <strong>1 &rarr; 2 &rarr; 3 &rarr; 4 &rarr; 5 &rarr; 6 &rarr; 7</strong> (repeat for downstream). Alerting via step <strong>8</strong> only on failure/SLA breach.
    </p>
  </div>

  <!-- ===== FAILURE PATHS ===== -->
  <div class="card" style="margin-top:18px; border-left:4px solid var(--danger);">
    <h4 style="color:var(--danger);">&#9888; Failure Paths</h4>
    <div style="overflow-x:auto;">
      <table style="width:100%; border-collapse:collapse; margin-top:10px; font-size:0.92em;">
        <thead>
          <tr style="border-bottom:2px solid var(--card-border);">
            <th style="padding:10px 12px; text-align:left; color:var(--danger);">Failure Scenario</th>
            <th style="padding:10px 12px; text-align:left; color:var(--warning);">Impact</th>
            <th style="padding:10px 12px; text-align:left; color:var(--success);">Mitigation</th>
          </tr>
        </thead>
        <tbody>
          <tr style="border-bottom:1px solid var(--card-border);">
            <td style="padding:8px 12px; font-weight:600;">Scheduler Crash</td>
            <td style="padding:8px 12px; color:var(--text-muted);">No new DAG runs triggered; running tasks unaffected</td>
            <td style="padding:8px 12px; color:var(--text-muted);">Leader election failover; standby scheduler promotes within seconds</td>
          </tr>
          <tr style="border-bottom:1px solid var(--card-border); background:rgba(255,255,255,0.02);">
            <td style="padding:8px 12px; font-weight:600;">Worker Crash</td>
            <td style="padding:8px 12px; color:var(--text-muted);">In-flight task lost; status stuck as "running"</td>
            <td style="padding:8px 12px; color:var(--text-muted);">Heartbeat timeout detection &rarr; task marked failed &rarr; automatic retry</td>
          </tr>
          <tr style="border-bottom:1px solid var(--card-border);">
            <td style="padding:8px 12px; font-weight:600;">Task Timeout (Zombie)</td>
            <td style="padding:8px 12px; color:var(--text-muted);">Task runs beyond expected duration</td>
            <td style="padding:8px 12px; color:var(--text-muted);">Zombie detection via scheduler; task killed + retry or marked failed</td>
          </tr>
          <tr style="border-bottom:1px solid var(--card-border); background:rgba(255,255,255,0.02);">
            <td style="padding:8px 12px; font-weight:600;">DB Connection Pool Exhaustion</td>
            <td style="padding:8px 12px; color:var(--text-muted);">Scheduler and workers cannot read/write metadata</td>
            <td style="padding:8px 12px; color:var(--text-muted);">PgBouncer connection pooling; read replicas; circuit breaker pattern</td>
          </tr>
          <tr>
            <td style="padding:8px 12px; font-weight:600;">Poison Task (Repeated Failure)</td>
            <td style="padding:8px 12px; color:var(--text-muted);">Task fails on every retry, blocks downstream</td>
            <td style="padding:8px 12px; color:var(--text-muted);">Dead Letter Queue (DLQ) after max retries; alert via step 8</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="card-grid">
    <div class="card">
      <h4>&#128205; Component Responsibilities</h4>
      <ul>
        <li><strong>Scheduler</strong> &mdash; Leader-elected process that runs the tick loop, checks for DAGs due for execution, resolves dependencies, and enqueues ready tasks</li>
        <li><strong>DAG Processor</strong> &mdash; Parses DAG definition files (Python/YAML), validates structure, serializes to metadata DB</li>
        <li><strong>Executor</strong> &mdash; Dispatches tasks to the appropriate execution backend (Kafka consumers, Kubernetes, Local)</li>
        <li><strong>Worker Pool</strong> &mdash; Stateless processes that consume tasks from Kafka, execute them, report status, and push logs</li>
      </ul>
    </div>
    <div class="card">
      <h4>&#128451; Storage Layer</h4>
      <ul>
        <li><strong>Metadata DB (PostgreSQL)</strong> &mdash; Source of truth for DAG definitions, run states, task instance states. Uses row-level locking for consistency</li>
        <li><strong>Kafka</strong> &mdash; Unified messaging backbone: priority task topics (decouples scheduler from workers, DLQ), event-triggered scheduling, status callbacks, and audit logging</li>
        <li><strong>Log Storage (S3)</strong> &mdash; Durable log storage for task stdout/stderr. Hot tier (30d) in fast storage, cold archive for compliance</li>
      </ul>
    </div>
  </div>
  </details>
</section>

<!-- ============================================================ -->
<!--  5. DAG MODEL                                                 -->
<!-- ============================================================ -->
<section id="dag-model">
  <details>
  <summary><h2><span class="icon" style="background:rgba(0,166,153,0.15); color:var(--secondary);">&#128209;</span> DAG Model &amp; Schema</h2></summary>

  <h3>Entity Relationship</h3>

  <p>The entity relationship diagram below shows the five core database tables and how they relate. A <strong>dag</strong> (workflow definition) contains many <strong>tasks</strong> (individual steps), and each task can declare upstream dependencies in the <strong>task_dependency</strong> junction table. When the scheduler triggers a DAG, it creates a <strong>dag_run</strong> (one execution of the workflow for a specific date). Each dag_run fans out into <strong>task_instances</strong> &mdash; one per task &mdash; which track the real-time state, retry count, assigned worker, and log location for that particular execution.</p>

  <div class="arch-diagram"><span class="label">                              DAG MODEL - ENTITY RELATIONSHIPS</span>

    <span class="comp">+------------------+</span>       <span class="comp">+--------------------+</span>       <span class="comp">+---------------------+</span>
    <span class="comp">|      dag         |</span><span class="flow">------&gt;</span><span class="comp">|      task          |</span><span class="flow">------&gt;</span><span class="comp">|  task_dependency    |</span>
    <span class="comp">|------------------|</span>  <span class="label">1:N</span>  <span class="comp">|--------------------|</span>  <span class="label">1:N</span>  <span class="comp">|---------------------|</span>
    <span class="comp">| id           PK  |</span>       <span class="comp">| id             PK  |</span>       <span class="comp">| task_id         FK  |</span>
    <span class="comp">| name             |</span>       <span class="comp">| dag_id         FK  |</span>       <span class="comp">| upstream_task_id FK |</span>
    <span class="comp">| schedule_expr    |</span>       <span class="comp">| operator_type      |</span>       <span class="comp">+---------------------+</span>
    <span class="comp">| owner            |</span>       <span class="comp">| retries            |</span>
    <span class="comp">| is_paused        |</span>       <span class="comp">| priority_weight    |</span>
    <span class="comp">+--------+---------+</span>       <span class="comp">+----------+---------+</span>
             <span class="flow">|</span>                            <span class="flow">|</span>
             <span class="flow">|</span> <span class="label">1:N</span>                        <span class="flow">|</span> <span class="label">1:N</span>
             <span class="flow">v</span>                            <span class="flow">v</span>
    <span class="comp">+------------------+</span>       <span class="comp">+--------------------+</span>
    <span class="comp">|    dag_run       |</span><span class="flow">------&gt;</span><span class="comp">|   task_instance    |</span>
    <span class="comp">|------------------|</span>  <span class="label">1:N</span>  <span class="comp">|--------------------|</span>
    <span class="comp">| id           PK  |</span>       <span class="comp">| id             PK  |</span>
    <span class="comp">| dag_id       FK  |</span>       <span class="comp">| dag_run_id     FK  |</span>
    <span class="comp">| execution_date   |</span>       <span class="comp">| task_id        FK  |</span>
    <span class="comp">| state            |</span>       <span class="comp">| state              |</span>
    <span class="comp">| run_type         |</span>       <span class="comp">| try_number         |</span>
    <span class="comp">+------------------+</span>       <span class="comp">| worker_id          |</span>
                               <span class="comp">+--------------------+</span></div>

  <h3>Schema DDL</h3>

  <pre><code><span class="code-label">SQL</span>
<span class="kw">CREATE TABLE</span> <span class="type">dag</span> (
    <span class="fn">id</span>              <span class="type">UUID</span> <span class="kw">PRIMARY KEY DEFAULT</span> gen_random_uuid(),
    <span class="fn">name</span>            <span class="type">VARCHAR(255)</span> <span class="kw">UNIQUE NOT NULL</span>,
    <span class="fn">schedule_expr</span>   <span class="type">VARCHAR(128)</span>,          <span class="cm">-- cron expression or NULL for manual/event</span>
    <span class="fn">owner</span>           <span class="type">VARCHAR(128)</span> <span class="kw">NOT NULL</span>, <span class="cm">-- team or user identifier</span>
    <span class="fn">config</span>          <span class="type">JSONB</span>,                  <span class="cm">-- default_args, tags, description</span>
    <span class="fn">is_paused</span>       <span class="type">BOOLEAN</span> <span class="kw">DEFAULT</span> <span class="num">false</span>,
    <span class="fn">concurrency</span>     <span class="type">INT</span> <span class="kw">DEFAULT</span> <span class="num">16</span>,        <span class="cm">-- max parallel task instances per DAG</span>
    <span class="fn">version</span>         <span class="type">INT</span> <span class="kw">DEFAULT</span> <span class="num">1</span>,
    <span class="fn">created_at</span>      <span class="type">TIMESTAMPTZ</span> <span class="kw">DEFAULT</span> now(),
    <span class="fn">updated_at</span>      <span class="type">TIMESTAMPTZ</span> <span class="kw">DEFAULT</span> now()
);

<span class="kw">CREATE TABLE</span> <span class="type">task</span> (
    <span class="fn">id</span>              <span class="type">UUID</span> <span class="kw">PRIMARY KEY DEFAULT</span> gen_random_uuid(),
    <span class="fn">dag_id</span>          <span class="type">UUID</span> <span class="kw">REFERENCES</span> dag(id) <span class="kw">ON DELETE CASCADE</span>,
    <span class="fn">task_key</span>        <span class="type">VARCHAR(255)</span> <span class="kw">NOT NULL</span>, <span class="cm">-- unique within DAG</span>
    <span class="fn">operator_type</span>   <span class="type">VARCHAR(128)</span> <span class="kw">NOT NULL</span>, <span class="cm">-- PythonOperator, BashOperator, etc.</span>
    <span class="fn">params</span>          <span class="type">JSONB</span>,                    <span class="cm">-- operator-specific configuration</span>
    <span class="fn">retries</span>         <span class="type">INT</span> <span class="kw">DEFAULT</span> <span class="num">3</span>,
    <span class="fn">retry_delay_sec</span> <span class="type">INT</span> <span class="kw">DEFAULT</span> <span class="num">300</span>,        <span class="cm">-- base delay, exponential backoff</span>
    <span class="fn">priority_weight</span> <span class="type">INT</span> <span class="kw">DEFAULT</span> <span class="num">1</span>,          <span class="cm">-- higher = more important</span>
    <span class="fn">pool</span>            <span class="type">VARCHAR(64)</span> <span class="kw">DEFAULT</span> <span class="str">'default'</span>,
    <span class="fn">timeout_sec</span>     <span class="type">INT</span> <span class="kw">DEFAULT</span> <span class="num">3600</span>,
    <span class="kw">UNIQUE</span>(dag_id, task_key)
);

<span class="kw">CREATE TABLE</span> <span class="type">task_dependency</span> (
    <span class="fn">task_id</span>          <span class="type">UUID</span> <span class="kw">REFERENCES</span> task(id) <span class="kw">ON DELETE CASCADE</span>,
    <span class="fn">upstream_task_id</span> <span class="type">UUID</span> <span class="kw">REFERENCES</span> task(id) <span class="kw">ON DELETE CASCADE</span>,
    <span class="kw">PRIMARY KEY</span>(task_id, upstream_task_id)
);

<span class="kw">CREATE TABLE</span> <span class="type">dag_run</span> (
    <span class="fn">id</span>              <span class="type">UUID</span> <span class="kw">PRIMARY KEY DEFAULT</span> gen_random_uuid(),
    <span class="fn">dag_id</span>          <span class="type">UUID</span> <span class="kw">REFERENCES</span> dag(id),
    <span class="fn">execution_date</span>  <span class="type">TIMESTAMPTZ</span> <span class="kw">NOT NULL</span>,
    <span class="fn">state</span>           <span class="type">VARCHAR(20)</span> <span class="kw">DEFAULT</span> <span class="str">'running'</span>,
        <span class="cm">-- running | success | failed</span>
    <span class="fn">run_type</span>        <span class="type">VARCHAR(20)</span> <span class="kw">DEFAULT</span> <span class="str">'scheduled'</span>,
        <span class="cm">-- scheduled | manual | backfill | event_triggered</span>
    <span class="fn">started_at</span>      <span class="type">TIMESTAMPTZ</span>,
    <span class="fn">ended_at</span>        <span class="type">TIMESTAMPTZ</span>,
    <span class="fn">external_trigger</span> <span class="type">JSONB</span>,     <span class="cm">-- trigger metadata for event-based runs</span>
    <span class="kw">UNIQUE</span>(dag_id, execution_date, run_type)
);

<span class="kw">CREATE TABLE</span> <span class="type">task_instance</span> (
    <span class="fn">id</span>              <span class="type">UUID</span> <span class="kw">PRIMARY KEY DEFAULT</span> gen_random_uuid(),
    <span class="fn">dag_run_id</span>      <span class="type">UUID</span> <span class="kw">REFERENCES</span> dag_run(id),
    <span class="fn">task_id</span>         <span class="type">UUID</span> <span class="kw">REFERENCES</span> task(id),
    <span class="fn">state</span>           <span class="type">VARCHAR(20)</span> <span class="kw">DEFAULT</span> <span class="str">'none'</span>,
        <span class="cm">-- none | scheduled | queued | running | success | failed | up_for_retry | skipped</span>
    <span class="fn">try_number</span>      <span class="type">INT</span> <span class="kw">DEFAULT</span> <span class="num">0</span>,
    <span class="fn">max_tries</span>       <span class="type">INT</span> <span class="kw">DEFAULT</span> <span class="num">3</span>,
    <span class="fn">started_at</span>      <span class="type">TIMESTAMPTZ</span>,
    <span class="fn">ended_at</span>        <span class="type">TIMESTAMPTZ</span>,
    <span class="fn">queued_at</span>       <span class="type">TIMESTAMPTZ</span>,
    <span class="fn">worker_id</span>       <span class="type">VARCHAR(128)</span>,
    <span class="fn">log_url</span>         <span class="type">TEXT</span>,
    <span class="kw">UNIQUE</span>(dag_run_id, task_id)
);

<span class="cm">-- Critical indexes for scheduler performance</span>
<span class="kw">CREATE INDEX</span> idx_ti_state <span class="kw">ON</span> task_instance(state) <span class="kw">WHERE</span> state <span class="kw">IN</span> (<span class="str">'scheduled'</span>, <span class="str">'queued'</span>, <span class="str">'running'</span>);
<span class="kw">CREATE INDEX</span> idx_dr_state <span class="kw">ON</span> dag_run(state, dag_id) <span class="kw">WHERE</span> state = <span class="str">'running'</span>;
<span class="kw">CREATE INDEX</span> idx_dag_schedule <span class="kw">ON</span> dag(is_paused, schedule_expr) <span class="kw">WHERE</span> is_paused = <span class="num">false</span>;</code></pre>

  <div class="tip-box tip-box-warning">
    <span class="tip-icon">&#9888;</span>
    <div><strong>UNIQUE constraint on (dag_id, execution_date, run_type)</strong> is the first line of defense for exactly-once execution. It prevents duplicate DAG runs even if the scheduler crashes and restarts mid-cycle. The partial indexes on active states keep the scheduler tick loop queries fast even as historical data grows.</div>
  </div>
  </details>
</section>

<!-- ============================================================ -->
<!--  6. SCHEDULING ENGINE                                         -->
<!-- ============================================================ -->
<section id="scheduling-engine">
  <details>
  <summary><h2><span class="icon" style="background:rgba(252,100,45,0.15); color:var(--accent);">&#9200;</span> Scheduling Engine</h2></summary>

  <h3>Tick-Based Scheduler Loop</h3>
  <p>The scheduler runs a continuous <strong>tick loop</strong> every N seconds (configurable, typically 1-5s). Each tick performs three phases:</p>

  <pre><code><span class="code-label">Pseudocode</span>
<span class="cm">// Scheduler Tick — runs every N seconds (typically 1–5s)</span>

<span class="fn">SCHEDULER_TICK</span>():

    <span class="cm">── PHASE 1: Create new DAG Runs ──</span>
    <span class="fn">due_dags</span> = <span class="fn">FIND_DAGS_DUE_FOR_EXECUTION</span>()
        <span class="cm">→ Query: active DAGs (not paused, has schedule) with no existing</span>
        <span class="cm">  dag_run at the next computed execution_date</span>

    <span class="kw">FOR EACH</span> dag <span class="kw">IN</span> due_dags:
        next_exec = <span class="fn">COMPUTE_NEXT_EXECUTION_DATE</span>(dag.schedule_expr)
        <span class="kw">TRY</span>:
            dag_run = <span class="fn">INSERT</span> dag_run(dag, next_exec)  <span class="cm">← UNIQUE constraint prevents duplicates</span>
            <span class="fn">CREATE_TASK_INSTANCES</span>(dag_run)
        <span class="kw">ON</span> <span class="type">UniqueViolation</span>: <span class="cm">skip — already created (idempotent)</span>

    <span class="cm">── PHASE 2: Schedule tasks whose dependencies are met ──</span>
    <span class="fn">schedulable</span> = <span class="fn">FIND_SCHEDULABLE_TASK_INSTANCES</span>()
        <span class="cm">→ Query: task_instances in 'scheduled' state, in 'running' dag_runs</span>
        <span class="cm">  ORDER BY priority DESC, queued_at ASC</span>
        <span class="cm">  Use FOR UPDATE SKIP LOCKED (prevents duplicate claims)</span>

    <span class="kw">FOR EACH</span> ti <span class="kw">IN</span> schedulable:
        <span class="kw">IF</span> <span class="fn">ALL_UPSTREAM_SUCCEEDED</span>(ti) <span class="kw">AND</span> <span class="fn">CONCURRENCY_LIMITS_OK</span>(ti):
            ti.state = <span class="str">'queued'</span>
            ti.queued_at = <span class="fn">NOW</span>()
            <span class="fn">ENQUEUE_TO_EXECUTOR</span>(ti)   <span class="cm">← push to message queue</span>

    <span class="cm">── PHASE 3: Handle timed-out and zombie tasks ──</span>
    <span class="fn">DETECT_ZOMBIE_TASKS</span>()      <span class="cm">← tasks marked 'running' but worker heartbeat stale</span>
    <span class="fn">CHECK_SLA_VIOLATIONS</span>()     <span class="cm">← dag_runs exceeding their SLA deadline</span></code></pre>

  <h3>Topological Sort for Task Ordering</h3>
  <p>When a DAG run is created, tasks are ordered using <strong>Kahn's algorithm</strong> (BFS-based topological sort). Tasks with no upstream dependencies are immediately set to <span class="inline-code">scheduled</span> state. Others remain in <span class="inline-code">none</span> until their upstream tasks complete.</p>

  <pre><code><span class="code-label">Pseudocode</span>
<span class="cm">// Kahn's Algorithm — BFS-based topological sort, O(V+E)</span>

<span class="fn">TOPOLOGICAL_SORT</span>(tasks, dependencies):
    <span class="cm">1.</span> Build in-degree map: count incoming edges for each task
    <span class="cm">2.</span> Build adjacency list: upstream → [downstream tasks]

    <span class="cm">3.</span> Initialize queue with all tasks having in-degree = <span class="num">0</span>
       <span class="cm">→ These are root tasks (no upstream dependencies)</span>
       <span class="cm">→ Set their state to 'scheduled' immediately</span>

    <span class="cm">4.</span> <span class="kw">WHILE</span> queue is not empty:
         task = <span class="fn">DEQUEUE</span>()
         <span class="fn">ADD</span> task to ordered result
         <span class="kw">FOR EACH</span> downstream of task:
             decrement in-degree of downstream
             <span class="kw">IF</span> in-degree reaches <span class="num">0</span> → <span class="fn">ENQUEUE</span>(downstream)

    <span class="cm">5.</span> <span class="kw">IF</span> result length ≠ total tasks → <span class="type">CycleDetectedError</span>
       <span class="cm">→ Graph contains a cycle, reject the DAG definition</span>

    <span class="kw">RETURN</span> ordered list of task IDs</code></pre>

  <h3>Concurrency Limits</h3>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Limit Type</th>
          <th>Scope</th>
          <th>Purpose</th>
          <th>Implementation</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Per-DAG concurrency</strong></td>
          <td>dag.concurrency = 16</td>
          <td>Limit parallel tasks within one DAG run</td>
          <td>COUNT running task_instances WHERE dag_run_id = X</td>
        </tr>
        <tr>
          <td><strong>Per-task concurrency</strong></td>
          <td>task.max_active_tis = 1</td>
          <td>Prevent same task from running across multiple DAG runs</td>
          <td>COUNT running TIs WHERE task_id = X across all dag_runs</td>
        </tr>
        <tr>
          <td><strong>Pool limits</strong></td>
          <td>pool.slots = 128</td>
          <td>Shared resource pools (e.g., "db_connections")</td>
          <td>COUNT running TIs WHERE pool = "db_connections"</td>
        </tr>
        <tr>
          <td><strong>Global limit</strong></td>
          <td>parallelism = 512</td>
          <td>Total cluster-wide concurrent tasks</td>
          <td>COUNT all running TIs across cluster</td>
        </tr>
        <tr>
          <td><strong>Per-tenant limit</strong></td>
          <td>tenant.quota = 100</td>
          <td>Multi-tenant isolation, prevent noisy neighbor</td>
          <td>COUNT running TIs WHERE owner = tenant_id</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="tip-box tip-box-success">
    <span class="tip-icon">&#9989;</span>
    <div><strong>FOR UPDATE SKIP LOCKED</strong> is the critical PostgreSQL feature that enables multiple scheduler instances to safely process task instances concurrently without conflicts. It acquires row-level locks and skips rows that are already locked by another scheduler, providing natural work distribution.</div>
  </div>
  </details>
</section>

<!-- ============================================================ -->
<!--  7. EXECUTION MODEL                                           -->
<!-- ============================================================ -->
<section id="execution-model">
  <details>
  <summary><h2><span class="icon" style="background:rgba(16,185,129,0.15); color:var(--success);">&#9654;</span> Execution Model</h2></summary>

  <h3>Task Lifecycle State Machine</h3>

  <div class="state-diagram">
<span class="state">[ NONE ]</span> <span class="arrow">---</span><span class="action"> scheduler creates TI </span><span class="arrow">---&gt;</span> <span class="state">[ SCHEDULED ]</span>
                                                       <span class="arrow">|</span>
                                        <span class="action"> deps met + concurrency OK </span>
                                                       <span class="arrow">|</span>
                                                       <span class="arrow">v</span>
                                                 <span class="state">[ QUEUED ]</span>
                                                       <span class="arrow">|</span>
                                          <span class="action"> worker picks up task </span>
                                                       <span class="arrow">|</span>
                                                       <span class="arrow">v</span>
                                                 <span class="state">[ RUNNING ]</span>
                                              <span class="arrow">/</span>        <span class="arrow">|</span>        <span class="arrow">\</span>
                                   <span class="action"> success </span><span class="arrow">/</span>         <span class="arrow">|</span>         <span class="arrow">\</span><span class="action"> failure</span>
                                          <span class="arrow">/</span>            <span class="arrow">|</span>            <span class="arrow">\</span>
                                         <span class="arrow">v</span>             <span class="arrow">v</span>             <span class="arrow">v</span>
                                  <span class="ok">[ SUCCESS ]</span>   <span class="state">[ SKIPPED ]</span>   <span class="fail">[ FAILED ]</span>
                                                                       <span class="arrow">|</span>
                                                          <span class="action"> retries remaining? </span>
                                                           <span class="arrow">/</span>            <span class="arrow">\</span>
                                                     <span class="action"> yes </span><span class="arrow">/</span>              <span class="arrow">\</span><span class="action"> no</span>
                                                         <span class="arrow">v</span>                <span class="arrow">v</span>
                                               <span class="state">[ UP_FOR_RETRY ]</span>   <span class="fail">[ FAILED ]</span><span class="action"> (terminal)</span>
                                                         <span class="arrow">|</span>
                                            <span class="action"> after backoff delay </span>
                                                         <span class="arrow">|</span>
                                                         <span class="arrow">v</span>
                                                   <span class="state">[ SCHEDULED ]</span> <span class="action"> (retry loop)</span></div>

  <h3>State Transition Walkthrough</h3>
  <p>The table below traces exactly <strong>who</strong> changes each state, <strong>what</strong> triggers the transition, and the <strong>DB update</strong> that persists it.</p>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>From</th>
          <th>To</th>
          <th>Triggered By</th>
          <th>What Happens</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>1</strong></td>
          <td>&mdash;</td>
          <td><span class="badge badge-blue">NONE</span></td>
          <td>Scheduler</td>
          <td>DAG run created &rarr; scheduler inserts one <span class="inline-code">task_instance</span> row per task with state = <span class="inline-code">none</span></td>
        </tr>
        <tr>
          <td><strong>2</strong></td>
          <td><span class="badge badge-blue">NONE</span></td>
          <td><span class="badge badge-blue">SCHEDULED</span></td>
          <td>Scheduler</td>
          <td>Topological sort identifies root tasks (in-degree = 0) &rarr; sets their state to <span class="inline-code">scheduled</span>. Non-root tasks stay in <span class="inline-code">none</span> until all upstreams succeed.</td>
        </tr>
        <tr>
          <td><strong>3</strong></td>
          <td><span class="badge badge-blue">SCHEDULED</span></td>
          <td><span class="badge badge-purple">QUEUED</span></td>
          <td>Scheduler</td>
          <td>Tick loop finds <span class="inline-code">scheduled</span> tasks with all deps met + concurrency OK &rarr; updates state to <span class="inline-code">queued</span>, sets <span class="inline-code">queued_at</span>, publishes task message to Kafka topic.</td>
        </tr>
        <tr>
          <td><strong>4</strong></td>
          <td><span class="badge badge-purple">QUEUED</span></td>
          <td><span class="badge badge-orange">RUNNING</span></td>
          <td>Worker</td>
          <td>Worker consumes task from Kafka &rarr; updates state to <span class="inline-code">running</span>, sets <span class="inline-code">started_at</span> and <span class="inline-code">worker_id</span>. Begins heartbeating.</td>
        </tr>
        <tr>
          <td><strong>5a</strong></td>
          <td><span class="badge badge-orange">RUNNING</span></td>
          <td><span class="badge badge-green">SUCCESS</span></td>
          <td>Worker</td>
          <td>Task completes without error &rarr; worker updates state to <span class="inline-code">success</span>, sets <span class="inline-code">ended_at</span>. Scheduler then evaluates downstream tasks (back to step 2 for them).</td>
        </tr>
        <tr>
          <td><strong>5b</strong></td>
          <td><span class="badge badge-orange">RUNNING</span></td>
          <td><span class="badge badge-red">FAILED</span></td>
          <td>Worker</td>
          <td>Task throws exception or exceeds timeout &rarr; worker updates state to <span class="inline-code">failed</span>, records error. If retries remaining &rarr; goes to step 6. Otherwise terminal failure &rarr; DLQ + alert.</td>
        </tr>
        <tr>
          <td><strong>5c</strong></td>
          <td><span class="badge badge-orange">RUNNING</span></td>
          <td><span class="badge badge-blue">SKIPPED</span></td>
          <td>Worker</td>
          <td>Branch operator decides this path is not needed &rarr; state set to <span class="inline-code">skipped</span>. Downstream tasks of the skipped branch are also skipped.</td>
        </tr>
        <tr>
          <td><strong>6</strong></td>
          <td><span class="badge badge-red">FAILED</span></td>
          <td><span class="badge badge-orange">UP_FOR_RETRY</span></td>
          <td>Scheduler</td>
          <td>Retry count not exhausted &rarr; scheduler sets state to <span class="inline-code">up_for_retry</span>, computes backoff delay, sets <span class="inline-code">next_retry_at</span>.</td>
        </tr>
        <tr>
          <td><strong>7</strong></td>
          <td><span class="badge badge-orange">UP_FOR_RETRY</span></td>
          <td><span class="badge badge-blue">SCHEDULED</span></td>
          <td>Scheduler</td>
          <td>Backoff delay elapsed &rarr; scheduler sets state back to <span class="inline-code">scheduled</span>, increments <span class="inline-code">try_number</span>. Flow resumes from step 3.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="tip-box tip-box-info">
    <span class="tip-icon">&#128270;</span>
    <div><strong>Key invariant:</strong> Every state transition is a <strong>single UPDATE to PostgreSQL</strong> guarded by the current state (<span class="inline-code">WHERE state = 'old_state'</span>). This prevents race conditions &mdash; if two processes try to transition the same task, only one succeeds. The metadata DB is always the source of truth; Kafka is a delivery mechanism, not a state store.</div>
  </div>

  <h3>Executor Comparison</h3>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Executor</th>
          <th>Mechanism</th>
          <th>Isolation</th>
          <th>Scaling</th>
          <th>Latency</th>
          <th>Best For</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>KafkaExecutor</strong></td>
          <td>Distributed workers via Kafka message queue</td>
          <td>Process-level</td>
          <td>Pre-provisioned worker pool, manual scaling</td>
          <td>Low (~50ms dispatch)</td>
          <td>Steady, predictable workloads</td>
        </tr>
        <tr>
          <td><strong>KubernetesExecutor</strong></td>
          <td>Spins up a new Pod for each task</td>
          <td>Container-level (strong)</td>
          <td>Elastic, auto-scales with cluster</td>
          <td>Higher (~5-30s pod startup)</td>
          <td>Variable workloads, mixed resource needs</td>
        </tr>
        <tr>
          <td><strong>LocalExecutor</strong></td>
          <td>Subprocess on scheduler machine</td>
          <td>Process-level (weak)</td>
          <td>Single machine, limited</td>
          <td>Lowest (~10ms)</td>
          <td>Development, small deployments</td>
        </tr>
        <tr>
          <td><strong>KafkaKubernetesExecutor</strong></td>
          <td>Hybrid: Kafka default + K8s for specific tasks</td>
          <td>Mixed</td>
          <td>Best of both worlds</td>
          <td>Variable</td>
          <td>Production at scale</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="card-grid">
    <div class="card">
      <h4 style="color:var(--blue);">&#128230; KafkaExecutor Deep Dive</h4>
      <pre><code><span class="code-label">Architecture</span>
<span class="cm">Scheduler</span> <span class="op">--&gt;</span> <span class="cm">Kafka Topic (priority)</span> <span class="op">--&gt;</span> <span class="cm">Worker Pool</span>
                  <span class="op">|</span>                            <span class="op">|</span>
          <span class="cm">priority_0 (critical)</span>        <span class="cm">Worker heartbeat</span>
          <span class="cm">priority_1 (high)</span>            <span class="cm">every 10s to DB</span>
          <span class="cm">priority_2 (normal)</span>
          <span class="cm">priority_3 (low)</span>
          <span class="cm">dead_letter_queue</span></code></pre>
      <ul>
        <li>Workers consume from Kafka topic partitions</li>
        <li>Consumer groups for automatic load balancing</li>
        <li>Configurable concurrency per consumer</li>
        <li>Failed tasks retried via DLQ topic</li>
      </ul>
    </div>
    <div class="card">
      <h4 style="color:var(--secondary);">&#9781; KubernetesExecutor Deep Dive</h4>
      <pre><code><span class="code-label">Architecture</span>
<span class="cm">Scheduler</span> <span class="op">--&gt;</span> <span class="cm">K8s API Server</span> <span class="op">--&gt;</span> <span class="cm">Pod per Task</span>
                  <span class="op">|</span>                         <span class="op">|</span>
          <span class="cm">Pod template spec</span>           <span class="cm">Sidecar for</span>
          <span class="cm">per operator type</span>           <span class="cm">log streaming</span>
          <span class="cm">Resource requests/limits</span>
          <span class="cm">Node affinity/tolerations</span></code></pre>
      <ul>
        <li>Perfect resource isolation per task</li>
        <li>Custom Docker images per task type</li>
        <li>Leverages K8s autoscaling (HPA/VPA)</li>
        <li>Pod startup latency is the main trade-off</li>
      </ul>
    </div>
  </div>

  <h3>Retry with Exponential Backoff</h3>

  <pre><code><span class="code-label">Pseudocode</span>
<span class="cm">// Compute retry delay with exponential backoff + jitter</span>

<span class="fn">COMPUTE_RETRY_DELAY</span>(task, try_number):
    base_delay   = task.retry_delay_sec            <span class="cm">← e.g., 300s (5 min)</span>
    exponential  = base_delay × <span class="num">2</span>^try_number       <span class="cm">← 300, 600, 1200, 2400…</span>
    max_delay    = <span class="num">3600</span>                             <span class="cm">← cap at 1 hour</span>
    jitter       = random(<span class="num">0</span>, base_delay × <span class="num">0.1</span>)     <span class="cm">← 10% jitter prevents thundering herd</span>
    <span class="kw">RETURN</span> min(exponential + jitter, max_delay)

<span class="cm">// Handle a failed task execution</span>

<span class="fn">HANDLE_TASK_FAILURE</span>(task_instance):
    <span class="kw">IF</span> task_instance.try_number &lt; task_instance.max_tries:
        set state → <span class="str">'up_for_retry'</span>
        increment try_number
        delay = <span class="fn">COMPUTE_RETRY_DELAY</span>(task, try_number)
        set next_retry_at = <span class="fn">NOW</span>() + delay
        <span class="fn">LOG_WARNING</span>(<span class="str">"Task failed, retry #N in {delay}s"</span>)
    <span class="kw">ELSE</span>:
        set state → <span class="str">'failed'</span> (terminal)
        <span class="fn">CHECK_DAG_RUN_COMPLETION</span>(dag_run_id)
        <span class="fn">SEND_FAILURE_ALERT</span>(task_instance)</code></pre>
  </details>
</section>

<!-- ============================================================ -->
<!--  8. FAULT TOLERANCE                                           -->
<!-- ============================================================ -->
<section id="fault-tolerance">
  <details>
  <summary><h2><span class="icon" style="background:rgba(239,68,68,0.15); color:var(--danger);">&#128737;</span> Fault Tolerance</h2></summary>

  <div class="card-grid">
    <div class="card">
      <h4 style="color:var(--primary);">&#9888; Scheduler HA: Leader Election</h4>
      <p>The scheduler runs in an <strong>active-passive</strong> configuration using leader election via <strong>ZooKeeper or etcd</strong>.</p>
      <pre><code><span class="code-label">Architecture</span>
<span class="cm">+---Scheduler-1 (ACTIVE/LEADER)---+</span>
<span class="cm">|  - Runs tick loop                |</span>
<span class="cm">|  - Holds ephemeral ZK lock       |</span>
<span class="cm">+----------------------------------+</span>
         <span class="op">|</span> <span class="cm">heartbeat / lease renewal</span>
         <span class="op">v</span>
<span class="cm">+---------ZooKeeper/etcd----------+</span>
<span class="cm">|  /scheduler/leader = sched-1     |</span>
<span class="cm">|  TTL: 30 seconds                 |</span>
<span class="cm">+---------------------------------+</span>
         <span class="op">^</span>
         <span class="op">|</span> <span class="cm">watches for leader loss</span>
<span class="cm">+---Scheduler-2 (STANDBY)----------+</span>
<span class="cm">|  - Watches leader lock            |</span>
<span class="cm">|  - Promotes self if lock expires  |</span>
<span class="cm">|  - Resumes from last DB state     |</span>
<span class="cm">+-----------------------------------+</span></code></pre>
      <p>On failover, the new leader recovers state entirely from PostgreSQL &mdash; no in-memory state is lost because all state transitions are persisted before acknowledgment.</p>
    </div>
    <div class="card">
      <h4 style="color:var(--warning);">&#128123; Zombie Task Detection</h4>
      <p>A "zombie" task is one marked as <span class="inline-code">running</span> in the database but whose worker has died without reporting back.</p>
      <pre><code><span class="code-label">SQL</span>
<span class="cm">-- Find zombie tasks: running but no</span>
<span class="cm">-- worker heartbeat in last 5 minutes</span>
<span class="kw">SELECT</span> ti.* <span class="kw">FROM</span> task_instance ti
<span class="kw">LEFT JOIN</span> worker_heartbeat wh
  <span class="kw">ON</span> ti.worker_id = wh.worker_id
<span class="kw">WHERE</span> ti.state = <span class="str">'running'</span>
  <span class="kw">AND</span> (
    wh.last_heartbeat &lt; now() - <span class="str">interval '5 min'</span>
    <span class="kw">OR</span> wh.worker_id <span class="kw">IS NULL</span>
  );</code></pre>
      <p>Zombies are re-queued for retry or marked as failed if max retries exceeded.</p>
    </div>
  </div>

  <div class="card-grid">
    <div class="card">
      <h4 style="color:var(--secondary);">&#128260; Worker Crash Recovery</h4>
      <ul>
        <li><strong>Heartbeat mechanism</strong> &mdash; Workers send heartbeat every 10 seconds to metadata DB</li>
        <li><strong>Timeout detection</strong> &mdash; Scheduler checks for workers with stale heartbeats (>5 min)</li>
        <li><strong>Task recovery</strong> &mdash; Orphaned tasks are set to <span class="inline-code">up_for_retry</span> (if retries left) or <span class="inline-code">failed</span></li>
        <li><strong>Graceful shutdown</strong> &mdash; Workers drain current tasks on SIGTERM, update state to <span class="inline-code">success</span>/<span class="inline-code">failed</span> before exit</li>
      </ul>
    </div>
    <div class="card">
      <h4 style="color:var(--purple);">&#128274; Idempotent Task Execution</h4>
      <ul>
        <li><strong>Execution key</strong> &mdash; Each task instance has a unique key: <span class="inline-code">(dag_id, task_key, execution_date, try_number)</span></li>
        <li><strong>Upsert semantics</strong> &mdash; Tasks should use INSERT ... ON CONFLICT DO UPDATE for output writes</li>
        <li><strong>Checkpoint mechanism</strong> &mdash; Long-running tasks checkpoint progress to resume on retry</li>
        <li><strong>Deterministic outputs</strong> &mdash; Same input + execution_date = same output (no non-deterministic operations)</li>
      </ul>
    </div>
  </div>

  <div class="card">
    <h4 style="color:var(--danger);">&#128165; Dead Letter Queue for Poison Tasks</h4>
    <p>Tasks that repeatedly fail despite retries are "poison tasks" that can clog the system. After exhausting all retries, these tasks are routed to a <strong>Dead Letter Queue (DLQ)</strong>.</p>
    <pre><code><span class="code-label">Pseudocode</span>
<span class="cm">// Move permanently failed task to DLQ for manual investigation</span>

<span class="fn">ROUTE_TO_DLQ</span>(task_instance):
    <span class="cm">1.</span> Build DLQ entry with:
       <span class="cm">→</span> task_instance_id, dag_id, task_key
       <span class="cm">→</span> execution_date, final_try_number
       <span class="cm">→</span> error_message, failed_at timestamp

    <span class="cm">2.</span> <span class="fn">PUSH</span> entry to Kafka DLQ topic <span class="str">'dlq.tasks'</span>

    <span class="cm">3.</span> <span class="fn">ALERT_ONCALL</span>(
         severity: <span class="str">'P2'</span>,
         message: <span class="str">"Task {task_key} permanently failed after {N} attempts"</span>
       )</code></pre>
  </div>

  <div class="tip-box tip-box-danger">
    <span class="tip-icon">&#128680;</span>
    <div><strong>Critical failure scenario:</strong> If the metadata database goes down, the entire scheduling system halts. Mitigation: PostgreSQL with synchronous replication to a hot standby, automated failover via Patroni/pg_auto_failover, and a circuit breaker in the scheduler that pauses new DAG runs rather than creating inconsistent state.</div>
  </div>
  </details>
</section>

<!-- ============================================================ -->
<!--  9. SCALABILITY                                               -->
<!-- ============================================================ -->
<section id="scalability">
  <details>
  <summary><h2><span class="icon" style="background:rgba(66,139,249,0.08); color:var(--blue);">&#128640;</span> Scalability</h2></summary>

  <div class="card-grid">
    <div class="card">
      <h4 style="color:var(--blue);">&#127793; DAG Sharding Across Schedulers</h4>
      <p>For very large deployments (>100K DAGs), a single scheduler becomes a bottleneck. Shard DAGs across multiple scheduler instances:</p>
      <pre><code><span class="code-label">Strategy</span>
<span class="cm">Approach 1: Hash-based partitioning</span>
  shard_id = hash(dag_id) % num_schedulers
  <span class="cm">+ Simple, even distribution</span>
  <span class="cm">- Rebalancing needed when adding schedulers</span>

<span class="cm">Approach 2: Consistent hashing</span>
  shard_id = consistent_hash_ring.get(dag_id)
  <span class="cm">+ Minimal rebalancing on scale events</span>
  <span class="cm">- More complex implementation</span>

<span class="cm">Approach 3: Claim-based (preferred)</span>
  <span class="cm">Each scheduler claims DAGs using</span>
  <span class="cm">SELECT ... FOR UPDATE SKIP LOCKED</span>
  <span class="cm">+ Self-balancing, fault-tolerant</span>
  <span class="cm">+ No coordination service needed</span>
  <span class="cm">- Requires careful lock timeout tuning</span></code></pre>
    </div>
    <div class="card">
      <h4 style="color:var(--secondary);">&#128200; Worker Auto-Scaling</h4>
      <p>Scale workers dynamically based on consumer lag:</p>
      <pre><code><span class="code-label">Pseudocode</span>
<span class="cm">// Compute desired worker count based on queue pressure</span>

<span class="fn">COMPUTE_DESIRED_WORKERS</span>(metrics):
    queue_depth       = metrics.queue_depth
    avg_task_duration = metrics.avg_duration
    target_drain_time = <span class="num">60</span> seconds

    <span class="cm">// Workers needed to drain queue within target time</span>
    desired = <span class="fn">CEIL</span>( queue_depth × avg_task_duration / target_drain_time )

    <span class="cm">// Clamp to bounds</span>
    min_workers = <span class="num">10</span>,  max_workers = <span class="num">500</span>
    <span class="kw">RETURN</span> <span class="fn">CLAMP</span>(desired, min_workers, max_workers)

<span class="cm">// K8s HPA integration:</span>
<span class="cm">// Scale when custom metric kafka_consumer_lag / workers &gt; 5</span></code></pre>
    </div>
  </div>

  <div class="card-grid">
    <div class="card">
      <h4 style="color:var(--warning);">&#128451; Database Optimization</h4>
      <ul>
        <li><strong>Connection pooling</strong> &mdash; PgBouncer in front of PostgreSQL (max 200 connections from 500+ workers)</li>
        <li><strong>Read replicas</strong> &mdash; Web UI and monitoring queries route to read replicas</li>
        <li><strong>Partitioned tables</strong> &mdash; Partition task_instance and dag_run by execution_date (monthly)</li>
        <li><strong>Archival</strong> &mdash; Move completed runs older than 90 days to archive tables or cold storage</li>
        <li><strong>Partial indexes</strong> &mdash; Only index active states (scheduled, queued, running) for fast scheduler queries</li>
      </ul>
    </div>
    <div class="card">
      <h4 style="color:var(--accent);">&#128640; Kafka Topic Partitioning</h4>
      <ul>
        <li><strong>Priority queues</strong> &mdash; Separate Kafka topics per priority level (0=critical, 1=high, 2=normal, 3=low)</li>
        <li><strong>Pool topics</strong> &mdash; Dedicated Kafka topics per resource pool (e.g., <span class="inline-code">tasks.pool.gpu</span>, <span class="inline-code">tasks.pool.cpu</span>)</li>
        <li><strong>Tenant topics</strong> &mdash; Optionally isolate tenants into separate Kafka topics with weighted fair scheduling</li>
        <li><strong>Topic monitoring</strong> &mdash; Track consumer lag, partition offsets, and age of oldest message for alerting</li>
      </ul>
    </div>
  </div>

  <div class="arch-diagram"><span class="label">                        SCALABILITY - SHARDED SCHEDULER ARCHITECTURE</span>

  <span class="comp">+---------------------+</span>   <span class="comp">+---------------------+</span>   <span class="comp">+---------------------+</span>
  <span class="comp">|  Scheduler Shard 1  |</span>   <span class="comp">|  Scheduler Shard 2  |</span>   <span class="comp">|  Scheduler Shard 3  |</span>
  <span class="comp">|  DAGs: A-H          |</span>   <span class="comp">|  DAGs: I-P          |</span>   <span class="comp">|  DAGs: Q-Z          |</span>
  <span class="comp">+----------+----------+</span>   <span class="comp">+----------+----------+</span>   <span class="comp">+----------+----------+</span>
             <span class="flow">|</span>                          <span class="flow">|</span>                          <span class="flow">|</span>
             <span class="flow">v</span>                          <span class="flow">v</span>                          <span class="flow">v</span>
  <span class="store">+----------------------------------------------------------------------+</span>
  <span class="store">|                    PostgreSQL (Primary + Read Replicas)                |</span>
  <span class="store">|                    PgBouncer connection pool (200 max)                 |</span>
  <span class="store">+----------------------------------------------------------------------+</span>
             <span class="flow">|</span>                          <span class="flow">|</span>                          <span class="flow">|</span>
             <span class="flow">v</span>                          <span class="flow">v</span>                          <span class="flow">v</span>
  <span class="comp">+------------------+</span>   <span class="comp">+--------------------+</span>   <span class="comp">+--------------------+</span>
  <span class="comp">| Topic: priority-0|</span>   <span class="comp">| Topic: priority-1  |</span>   <span class="comp">| Topic: priority-2  |</span>
  <span class="comp">| (critical tasks) |</span>   <span class="comp">| (high priority)    |</span>   <span class="comp">| (normal priority)  |</span>
  <span class="comp">+--------+---------+</span>   <span class="comp">+---------+----------+</span>   <span class="comp">+---------+----------+</span>
           <span class="flow">|</span>                         <span class="flow">|</span>                          <span class="flow">|</span>
           <span class="flow">v</span>                         <span class="flow">v</span>                          <span class="flow">v</span>
  <span class="comp">+----------------------------------------------------------------------+</span>
  <span class="comp">|                WORKER POOL  (Auto-scaling: 10 - 500)                  |</span>
  <span class="comp">|   Worker-1  Worker-2  Worker-3  ...  Worker-N                         |</span>
  <span class="comp">+----------------------------------------------------------------------+</span></div>
  </details>
</section>

<!-- ============================================================ -->
<!--  10. TRADE-OFFS                                               -->
<!-- ============================================================ -->
<section id="tradeoffs">
  <details>
  <summary><h2><span class="icon" style="background:rgba(255,90,95,0.15); color:var(--primary);">&#9878;</span> Trade-offs</h2></summary>

  <h3>1. Push vs Pull Task Distribution</h3>
  <div class="comparison">
    <div class="side pro">
      <h4 style="color:var(--success);">Push Model (Scheduler assigns tasks to workers)</h4>
      <ul>
        <li>Scheduler has full control over placement</li>
        <li>Can implement sophisticated scheduling policies</li>
        <li>Better for resource-aware scheduling</li>
        <li>Lower latency (no polling delay)</li>
      </ul>
      <p style="margin-top:10px;color:var(--text-muted);font-size:0.88em;"><strong>Risk:</strong> Head-of-line blocking if a worker is slow. Requires health tracking of every worker.</p>
    </div>
    <div class="side con">
      <h4 style="color:var(--blue);">Pull Model (Workers consume from Kafka)</h4>
      <ul>
        <li>Natural load balancing - busy workers pull less</li>
        <li>Simpler failure handling - uncommitted offsets re-consumed</li>
        <li>Workers are stateless and interchangeable</li>
        <li>Easier to scale horizontally</li>
      </ul>
      <p style="margin-top:10px;color:var(--text-muted);font-size:0.88em;"><strong>Risk:</strong> Less control over task placement. Priority inversion possible without careful topic/partition design.</p>
    </div>
  </div>

  <div class="tip-box tip-box-purple">
    <span class="tip-icon">&#128161;</span>
    <div><strong>Recommendation:</strong> Use the <strong>pull model</strong> (Kafka consumer) for most workloads. It is simpler, more fault-tolerant, and naturally load-balanced. Reserve push semantics for resource-constrained tasks (GPU, high-memory) where placement matters.</div>
  </div>

  <h3>2. PostgreSQL vs Distributed DB for Metadata</h3>
  <div class="comparison">
    <div class="side pro">
      <h4 style="color:var(--success);">PostgreSQL (Recommended)</h4>
      <ul>
        <li>Strong ACID guarantees for state transitions</li>
        <li><span class="inline-code">FOR UPDATE SKIP LOCKED</span> for safe concurrent access</li>
        <li>Mature tooling (pg_dump, logical replication)</li>
        <li>JSONB for flexible schema evolution</li>
        <li>Sufficient for 100K jobs/day (low TPS)</li>
      </ul>
    </div>
    <div class="side con">
      <h4 style="color:var(--blue);">Distributed DB (CockroachDB / Spanner)</h4>
      <ul>
        <li>Multi-region HA without manual failover</li>
        <li>Horizontal write scaling beyond single-node</li>
        <li>Built-in sharding</li>
        <li>Higher operational complexity</li>
        <li>Overkill for scheduler metadata volumes</li>
      </ul>
    </div>
  </div>

  <h3>3. KafkaExecutor vs KubernetesExecutor</h3>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Dimension</th>
          <th>KafkaExecutor</th>
          <th>KubernetesExecutor</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Startup latency</strong></td>
          <td><span class="badge badge-green">~50ms</span> (workers pre-warmed)</td>
          <td><span class="badge badge-orange">~5-30s</span> (pod creation)</td>
        </tr>
        <tr>
          <td><strong>Resource isolation</strong></td>
          <td>Process-level (weak)</td>
          <td>Container-level (strong)</td>
        </tr>
        <tr>
          <td><strong>Cost efficiency</strong></td>
          <td>Workers idle when no tasks</td>
          <td>Pay only for running tasks</td>
        </tr>
        <tr>
          <td><strong>Dependency management</strong></td>
          <td>All workers share same env</td>
          <td>Custom Docker image per task</td>
        </tr>
        <tr>
          <td><strong>Scaling</strong></td>
          <td>Manual worker pool sizing</td>
          <td>Elastic with K8s autoscaler</td>
        </tr>
        <tr>
          <td><strong>Debugging</strong></td>
          <td>SSH into worker, view logs</td>
          <td>Pod logs + K8s events</td>
        </tr>
        <tr>
          <td><strong>Operational burden</strong></td>
          <td>Moderate (manage Kafka cluster)</td>
          <td>Moderate (manage K8s cluster)</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h3>4. Centralized vs Decentralized Scheduling</h3>
  <div class="comparison">
    <div class="side pro">
      <h4 style="color:var(--success);">Centralized (Single scheduler, recommended)</h4>
      <ul>
        <li>Simpler consistency model</li>
        <li>Global view of all DAGs and resources</li>
        <li>Easier to implement priority and fairness</li>
        <li>Simpler debugging and monitoring</li>
      </ul>
      <p style="margin-top:10px;color:var(--text-muted);font-size:0.88em;"><strong>Scale limit:</strong> ~100K DAG runs/day per scheduler instance. Beyond that, use DAG sharding.</p>
    </div>
    <div class="side con">
      <h4 style="color:var(--blue);">Decentralized (Multiple independent schedulers)</h4>
      <ul>
        <li>No single point of failure</li>
        <li>Linear horizontal scaling</li>
        <li>Tenant isolation by scheduler</li>
        <li>Complex coordination for cross-DAG deps</li>
      </ul>
      <p style="margin-top:10px;color:var(--text-muted);font-size:0.88em;"><strong>Complexity:</strong> Requires distributed locking and consensus for global resource limits.</p>
    </div>
  </div>
  </details>
</section>

<!-- ============================================================ -->
<!--  11. DEEP DIVES                                               -->
<!-- ============================================================ -->
<section id="deep-dives">
  <details>
  <summary><h2><span class="icon" style="background:rgba(123,47,247,0.15); color:var(--purple);">&#128300;</span> Deep Dives</h2></summary>

  <h3>1. Backfill Mechanism</h3>
  <p>Backfill allows retroactive execution of a DAG for historical date ranges. This is essential when pipeline logic changes and historical data needs reprocessing.</p>

  <pre><code><span class="code-label">Pseudocode</span>
<span class="cm">// Create backfill: generate DAG runs for a historical date range</span>
<span class="cm">// Uses batching to limit concurrent runs and avoid overwhelming downstream</span>

<span class="fn">CREATE_BACKFILL</span>(dag_id, start_date, end_date, max_concurrent = <span class="num">5</span>):
    dag = <span class="fn">GET_DAG</span>(dag_id)
    schedule = <span class="fn">PARSE_CRON</span>(dag.schedule_expr)

    <span class="cm">1.</span> exec_dates = <span class="fn">GET_DATES_BETWEEN</span>(schedule, start_date, end_date)
       <span class="cm">→ All execution dates the cron would have triggered</span>

    <span class="cm">2.</span> <span class="kw">FOR EACH</span> batch of max_concurrent dates:
         <span class="kw">FOR EACH</span> exec_date <span class="kw">IN</span> batch:
             <span class="kw">TRY</span>:
                 dag_run = <span class="fn">INSERT</span> dag_run(dag_id, exec_date, run_type=<span class="str">'backfill'</span>)
                 <span class="fn">CREATE_TASK_INSTANCES</span>(dag_run)
             <span class="kw">ON</span> <span class="type">UniqueViolation</span>: <span class="cm">skip — run already exists (idempotent)</span>

         <span class="fn">WAIT_FOR_BATCH_COMPLETION</span>(batch)
         <span class="cm">→ Prevents next batch from starting until current finishes</span>

    <span class="kw">RETURN</span> { total_runs, status: <span class="str">'complete'</span> }</code></pre>

  <div class="tip-box tip-box-warning">
    <span class="tip-icon">&#9888;</span>
    <div><strong>Backfill pitfalls:</strong> (1) Concurrent backfills can overwhelm databases if not rate-limited. (2) Backfill tasks must be idempotent since they may re-process data that already exists. (3) Always use <span class="inline-code">execution_date</span> as the partition key for output data so backfills overwrite the correct partitions.</div>
  </div>

  <h3>2. SLA Monitoring</h3>

  <div class="card">
    <h4 style="color:var(--warning);">&#128276; SLA Definition and Enforcement</h4>
    <p>Each DAG can define an SLA (Service Level Agreement) specifying the maximum allowed time from scheduled start to successful completion.</p>
    <pre><code><span class="code-label">Pseudocode</span>
<span class="cm">// DAG config with SLA</span>
dag_config = {
    sla_seconds: <span class="num">7200</span>,                   <span class="cm">← DAG must complete within 2 hours</span>
    sla_miss_callback: <span class="str">"alert_oncall"</span>,
    sla_alert_channels: [<span class="str">"#data-eng-alerts"</span>, <span class="str">"pagerduty:team-data"</span>]
}

<span class="cm">// Called every scheduler tick</span>
<span class="fn">CHECK_SLA_VIOLATIONS</span>():
    violations = <span class="fn">QUERY</span>:
        <span class="cm">Find running dag_runs WHERE:</span>
        <span class="cm">  - DAG has an sla_seconds configured</span>
        <span class="cm">  - started_at + sla_seconds &lt; NOW (deadline passed)</span>
        <span class="cm">  - No existing sla_miss record (avoid duplicate alerts)</span>

    <span class="kw">FOR EACH</span> violation:
        <span class="fn">RECORD_SLA_MISS</span>(violation)    <span class="cm">← persist to sla_miss table</span>
        <span class="fn">FIRE_SLA_CALLBACK</span>(violation)  <span class="cm">← Slack / PagerDuty notification</span></code></pre>
  </div>

  <h3>3. Task Dependency Patterns</h3>

  <div class="card-grid-3">
    <div class="card">
      <h4 style="color:var(--blue);">Fan-Out</h4>
      <pre><code><span class="cm">        [Extract]
       /    |    \
      v     v     v
  [Transform] [Transform]
   [Region1]   [Region2]
              [Region3]</span></code></pre>
      <p>One task triggers multiple parallel downstream tasks. Used for parallelizing transforms across partitions.</p>
    </div>
    <div class="card">
      <h4 style="color:var(--secondary);">Fan-In</h4>
      <pre><code><span class="cm">[Transform]  [Transform]
 [Region1]    [Region2]
       \         /
        v       v
      [Aggregate]
          |
          v
       [Load]</span></code></pre>
      <p>Multiple tasks must all complete before a single downstream task runs. Used for aggregation after parallel processing.</p>
    </div>
    <div class="card">
      <h4 style="color:var(--accent);">Branching</h4>
      <pre><code><span class="cm">     [Check Data]
      /          \
  (data OK)  (data empty)
     |            |
     v            v
  [Process]   [Send Alert]
     |            |
     v            v
  [Load]      [Skip Load]</span></code></pre>
      <p>Conditional execution based on task outcome. Implemented via <span class="inline-code">BranchOperator</span> that returns downstream task IDs to execute.</p>
    </div>
  </div>

  <h3>4. Dynamic DAG Generation</h3>
  <pre><code><span class="code-label">Pseudocode</span>
<span class="cm">// Dynamic DAGs — programmatic generation based on external config</span>
<span class="cm">// Example: One ETL DAG per Airbnb market (city)</span>

<span class="fn">GENERATE_MARKET_DAGS</span>():
    markets = <span class="fn">CONFIG_SERVICE.GET_ACTIVE_MARKETS</span>()
    <span class="cm">→ Returns: ['san_francisco', 'new_york', 'london', 'paris', …]</span>

    <span class="kw">FOR EACH</span> market <span class="kw">IN</span> markets:
        <span class="cm">1.</span> Create DAG:
             name     = <span class="str">"etl_market_{market}"</span>
             schedule = <span class="str">"0 2 * * *"</span>   <span class="cm">← 2 AM daily</span>
             owner    = <span class="str">"data-eng"</span>
             config   = { market, sla_seconds: <span class="num">3600</span> }

        <span class="cm">2.</span> Define tasks:
             <span class="fn">extract</span>   → SQLOperator:          query bookings for market
             <span class="fn">transform</span> → SparkOperator:        run etl_transform job
             <span class="fn">validate</span>  → DataQualityOperator:  check row_count &gt; 0, null_rate &lt; 1%
             <span class="fn">load</span>      → BigQueryOperator:     write to warehouse.bookings_{market}

        <span class="cm">3.</span> Set dependency chain:
             extract → transform → validate → load

        <span class="cm">4.</span> <span class="fn">REGISTER_DAG</span>(dag)

<span class="cm">// Runs periodically by DAG Processor to pick up config changes</span></code></pre>

  <div class="tip-box tip-box-info">
    <span class="tip-icon">&#128218;</span>
    <div><strong>Dynamic DAG versioning:</strong> When the DAG Processor detects that a dynamically generated DAG has changed (new tasks added, dependencies modified), it increments the DAG version in the metadata DB. In-flight DAG runs continue with the old version; only new runs use the updated definition. This prevents mid-execution schema changes from causing failures.</div>
  </div>
  </details>
</section>

<!-- ============================================================ -->
<!--  12. INTERVIEW TIPS                                           -->
<!-- ============================================================ -->
<section id="interview-tips">
  <details>
  <summary><h2><span class="icon" style="background:rgba(0,166,153,0.15); color:var(--secondary);">&#127919;</span> Interview Tips</h2></summary>

  <div class="card">
    <h4 style="color:var(--primary);">&#128680; Key Signals Interviewers Look For</h4>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Signal</th>
            <th>What to Demonstrate</th>
            <th>Level</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Correctness first</strong></td>
            <td>Exactly-once semantics via DB constraints, idempotent tasks, <span class="inline-code">FOR UPDATE SKIP LOCKED</span></td>
            <td><span class="badge badge-green">Mid-Senior</span></td>
          </tr>
          <tr>
            <td><strong>State machine thinking</strong></td>
            <td>Clear task lifecycle with well-defined transitions and terminal states</td>
            <td><span class="badge badge-green">Mid-Senior</span></td>
          </tr>
          <tr>
            <td><strong>Failure mode analysis</strong></td>
            <td>Scheduler crash, worker crash, DB failure, network partition - and recovery for each</td>
            <td><span class="badge badge-blue">Senior</span></td>
          </tr>
          <tr>
            <td><strong>Separation of concerns</strong></td>
            <td>Scheduler (brain) vs Executor (dispatch) vs Worker (muscle) vs DB (state)</td>
            <td><span class="badge badge-blue">Senior</span></td>
          </tr>
          <tr>
            <td><strong>Scaling strategy</strong></td>
            <td>Identify bottleneck (scheduler vs DB vs workers) and scale each independently</td>
            <td><span class="badge badge-purple">Staff</span></td>
          </tr>
          <tr>
            <td><strong>Multi-tenant isolation</strong></td>
            <td>Per-tenant quotas, priority queues, resource pools preventing noisy neighbor</td>
            <td><span class="badge badge-purple">Staff</span></td>
          </tr>
          <tr>
            <td><strong>Operational excellence</strong></td>
            <td>SLA monitoring, backfill UX, DAG versioning, dead letter queues, observability</td>
            <td><span class="badge badge-red">PE</span></td>
          </tr>
          <tr>
            <td><strong>Trade-off articulation</strong></td>
            <td>Push vs pull, centralized vs decentralized, Kafka vs K8s - with reasoned opinions</td>
            <td><span class="badge badge-red">PE</span></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="card-grid">
    <div class="card">
      <h4 style="color:var(--warning);">&#128172; Common Follow-up Questions</h4>
      <ol>
        <li><strong>"How do you handle a scheduler crash mid-tick?"</strong><br>
          All state is in PostgreSQL. New leader resumes from DB state. In-flight task instances in <span class="inline-code">queued</span> state are already in Kafka and workers will complete them. The new scheduler discovers <span class="inline-code">running</span> dag_runs and continues monitoring.</li>
        <li><strong>"What if Kafka loses messages?"</strong><br>
          Scheduler tick loop will re-discover <span class="inline-code">scheduled</span> tasks whose dependencies are met and re-enqueue them. The DB is the source of truth, not Kafka.</li>
        <li><strong>"How do you prevent the same task from running twice?"</strong><br>
          UNIQUE constraint on (dag_run_id, task_id). <span class="inline-code">FOR UPDATE SKIP LOCKED</span> prevents concurrent schedulers from claiming the same task. Worker-side idempotency key: (dag_id, task_key, execution_date, try_number).</li>
        <li><strong>"How would you implement cross-DAG dependencies?"</strong><br>
          External task sensor: a special operator that polls for the completion of a task in another DAG. Implemented as a task that periodically queries the metadata DB for the upstream task's state. Has a timeout to prevent indefinite blocking.</li>
      </ol>
    </div>
    <div class="card">
      <h4 style="color:var(--purple);">&#127942; Calibration Levels</h4>
      <ul>
        <li><strong style="color:var(--success);">L4 (Mid-level):</strong> Defines DAG model, basic scheduler loop, task states. Misses concurrency control and fault tolerance details.</li>
        <li><strong style="color:var(--blue);">L5 (Senior):</strong> Covers executor types, retry mechanism, dependency resolution. Discusses scheduler HA at a high level. Basic capacity estimates.</li>
        <li><strong style="color:var(--purple);">L6 (Staff):</strong> Deep dives on exactly-once semantics, <span class="inline-code">SKIP LOCKED</span>, zombie detection, pool-based concurrency. Discusses scaling strategy and sharding. Covers backfill mechanism.</li>
        <li><strong style="color:var(--primary);">L7 (Principal):</strong> All of the above plus: dynamic DAG generation, multi-tenant isolation, SLA framework, DAG versioning, cost/efficiency trade-offs (Kafka vs K8s), dead letter queue design, operational runbooks. Can articulate why Airbnb needs each component and what breaks without it.</li>
      </ul>

      <div class="tip-box tip-box-success" style="margin-top:16px;">
        <span class="tip-icon">&#9989;</span>
        <div><strong>Winning strategy:</strong> Start with the DAG model and scheduler loop (5 min), then layer on executor design (5 min), fault tolerance (5 min), and scaling (5 min). Save deep dives (backfill, SLA, dynamic DAGs) for follow-up questions. Always anchor design choices in concrete failure scenarios.</div>
      </div>
    </div>
  </div>

  <h3>Quick Reference: 45-Minute Interview Timeline</h3>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Time</th>
          <th>Phase</th>
          <th>Cover</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><span class="metric">0-5 min</span></td>
          <td>Requirements &amp; Scope</td>
          <td>Clarify: DAG-based? Scale? Multi-tenant? Real-time or batch? Settle on FR/NFR.</td>
        </tr>
        <tr>
          <td><span class="metric">5-10 min</span></td>
          <td>High-Level Design</td>
          <td>Draw the 6 components (Scheduler, Executor, Workers, MetadataDB, Kafka, LogStore). Show data flow.</td>
        </tr>
        <tr>
          <td><span class="metric">10-20 min</span></td>
          <td>Core Design</td>
          <td>DAG schema, scheduler tick loop, task state machine, dependency resolution, retry logic.</td>
        </tr>
        <tr>
          <td><span class="metric">20-30 min</span></td>
          <td>Deep Dive (interviewer-led)</td>
          <td>Fault tolerance (scheduler HA, zombie detection), executor trade-offs, exactly-once semantics.</td>
        </tr>
        <tr>
          <td><span class="metric">30-40 min</span></td>
          <td>Scale &amp; Operations</td>
          <td>DAG sharding, worker auto-scaling, DB optimization, SLA monitoring, backfill.</td>
        </tr>
        <tr>
          <td><span class="metric">40-45 min</span></td>
          <td>Wrap-up &amp; Extensions</td>
          <td>Dynamic DAGs, cross-DAG deps, multi-tenant quotas. Ask thoughtful questions back.</td>
        </tr>
      </tbody>
    </table>
  </div>
  </details>
</section>

</div>

<!-- ============================================================ -->
<!--  FOOTER                                                       -->
<!-- ============================================================ -->
<div class="footer">
  <p><a href="index.html">&#8592; Back to All Topics</a> &nbsp;|&nbsp; Topic 08 of 18 &nbsp;|&nbsp; Distributed Job Scheduler</p>
  <p style="margin-top: 8px;">Airbnb System Design Interview Preparation &mdash; Principal Engineer Level</p>
</div>

<script>
// Auto-open collapsed section when clicking TOC link
document.querySelectorAll('.toc a[href^="#"]').forEach(function(link) {
  link.addEventListener('click', function() {
    var id = this.getAttribute('href').slice(1);
    var section = document.getElementById(id);
    if (section) {
      var details = section.querySelector('details');
      if (details) details.open = true;
    }
  });
});

(function(){
  document.querySelectorAll(".diagram-box").forEach(function(box){
    var svg=box.querySelector("svg");
    if(!svg) return;
    var zoom=1, minZ=0.5, maxZ=3;
    var ctrl=document.createElement("div");
    ctrl.className="diagram-zoom-controls";
    ctrl.innerHTML='<button class="zoom-out" title="Zoom Out">−</button><span class="zoom-level">100%</span><button class="zoom-in" title="Zoom In">+</button><button class="zoom-reset" title="Reset">u21BA</button><button class="zoom-fs" title="Fullscreen">⤢</button>';
    box.insertBefore(ctrl,box.firstChild);
    var lvl=ctrl.querySelector(".zoom-level");
    function apply(){svg.style.transform="scale("+zoom+")";lvl.textContent=Math.round(zoom*100)+"%";}
    ctrl.querySelector(".zoom-in").onclick=function(){zoom=Math.min(maxZ,zoom+0.25);apply();};
    ctrl.querySelector(".zoom-out").onclick=function(){zoom=Math.max(minZ,zoom-0.25);apply();};
    ctrl.querySelector(".zoom-reset").onclick=function(){zoom=1;apply();};
    ctrl.querySelector(".zoom-fs").onclick=function(){
      box.classList.toggle("fullscreen");
      if(box.classList.contains("fullscreen")){this.textContent="✖";zoom=1.2;}else{this.textContent="⤢";zoom=1;}
      apply();
    };
    box.addEventListener("wheel",function(e){
      if(e.ctrlKey){e.preventDefault();zoom=e.deltaY<0?Math.min(maxZ,zoom+0.1):Math.max(minZ,zoom-0.1);apply();}
    },{passive:false});
  });
})();
</script>
</body>
</html>