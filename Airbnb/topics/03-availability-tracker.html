<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Airbnb Listing Availability Tracker - System Design</title>
<style>
  :root {
    --primary: #FF5A5F;
    --primary-dark: #E04850;
    --secondary: #00A699;
    --accent: #FC642D;
    --purple: #7B2FF7;
    --blue: #428BF9;
    --dark: #ffffff;
    --darker: #f1f5f9;
    --card-bg: #ffffff;
    --card-border: #e2e8f0;
    --text: #1e293b;
    --text-muted: #4b5563;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--dark);
    color: var(--text);
    line-height: 1.7;
    scroll-behavior: smooth;
  }

  /* ===== HERO ===== */
  .hero {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #6B73FF 100%);
    padding: 70px 40px 60px;
    text-align: center;
    border-bottom: 3px solid var(--primary);
    position: relative;
    overflow: hidden;
  }
  .hero::before {
    content: '';
    position: absolute;
    top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: radial-gradient(circle at 30% 50%, rgba(255,90,95,0.15) 0%, transparent 50%),
                radial-gradient(circle at 70% 50%, rgba(0,166,153,0.15) 0%, transparent 50%);
    animation: pulse 8s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
  .hero .back-link {
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: #ffffff;
    text-decoration: none;
    font-size: 0.95em;
    font-weight: 600;
    padding: 10px 24px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.4);
    background: rgba(255,255,255,0.15);
    transition: all 0.3s;
    margin-bottom: 20px;
  }
  .hero .back-link:hover {
    background: rgba(255,255,255,0.25);
    border-color: #e5e7eb;
    transform: translateX(-3px);
  }
  .hero .topic-number-hero {
    position: relative;
    display: inline-block;
    font-size: 1em;
    font-weight: 800;
    color: var(--primary);
    background: rgba(255,90,95,0.15);
    border: 1px solid rgba(255,90,95,0.3);
    padding: 4px 18px;
    border-radius: 20px;
    margin-bottom: 14px;
    letter-spacing: 1px;
  }
  .hero h1 {
    font-size: 2.6em;
    background: linear-gradient(135deg, #ffffff, #e0e7ff, #ffffff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    position: relative;
    margin-bottom: 12px;
    line-height: 1.2;
  }
  .hero .subtitle {
    font-size: 1.2em;
    color: rgba(255,255,255,0.9);
    position: relative;
    margin-bottom: 24px;
    max-width: 750px;
    margin-left: auto;
    margin-right: auto;
  }
  .hero .stats-row {
    position: relative;
    display: flex;
    justify-content: center;
    gap: 30px;
    margin-top: 24px;
    flex-wrap: wrap;
  }
  .hero .stat-item { text-align: center; }
  .hero .stat-value {
    font-size: 1.8em;
    font-weight: 800;
    color: var(--primary);
  }
  .hero .stat-label {
    font-size: 0.78em;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1.5px;
  }
  .hero-badges {
    position: relative;
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
  }

  /* ===== BADGES ===== */
  .badge {
    display: inline-block;
    padding: 4px 14px;
    border-radius: 20px;
    font-size: 0.75em;
    font-weight: 600;
    margin: 3px 2px;
    white-space: nowrap;
  }
  .badge-red { background: #ef4444; color: #ffffff; border: 1px solid #dc2626; }
  .badge-green { background: #10b981; color: #ffffff; border: 1px solid #059669; }
  .badge-blue { background: #428BF9; color: #ffffff; border: 1px solid #2563eb; }
  .badge-purple { background: #7B2FF7; color: #ffffff; border: 1px solid #6d28d9; }
  .badge-orange { background: #f59e0b; color: #ffffff; border: 1px solid #d97706; }

  /* ===== NAV BAR (TOC) ===== */
  .nav-bar {
    background: #f8fafc;
    padding: 18px 40px;
    border-bottom: 1px solid var(--card-border);
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(12px);
  }
  .nav-bar h2 {
    color: var(--secondary);
    margin-bottom: 12px;
    font-size: 0.8em;
    text-transform: uppercase;
    letter-spacing: 2px;
  }
  .nav-links {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }
  .nav-links a {
    color: var(--text-muted);
    text-decoration: none;
    padding: 6px 14px;
    border-radius: 8px;
    background: var(--card-bg);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    font-size: 0.8em;
    transition: all 0.3s;
  }
  .nav-links a:hover {
    color: var(--primary);
    border-color: var(--primary);
    background: rgba(255,90,95,0.1);
  }

  /* ===== CONTAINER ===== */
  .container { max-width: 1100px; margin: 0 auto; padding: 0 30px; }

  /* ===== SECTION ===== */
  .section { padding: 50px 0 30px; }
  .section + .section { border-top: 1px solid #e5e7eb; }
  .section-label {
    display: inline-block;
    font-size: 0.72em;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 2.5px;
    color: var(--secondary);
    background: rgba(0,166,153,0.1);
    border: 1px solid rgba(0,166,153,0.25);
    padding: 4px 14px;
    border-radius: 6px;
    margin-bottom: 14px;
  }
  .section h2 {
    font-size: 1.9em;
    color: var(--text);
    margin-bottom: 20px;
    line-height: 1.25;
  }
  .section h3 {
    font-size: 1.3em;
    color: var(--primary);
    margin: 24px 0 12px;
  }
  .section h4 {
    font-size: 1.05em;
    color: var(--blue);
    margin: 18px 0 10px;
  }
  .section p, .section li {
    color: var(--text-muted);
    font-size: 0.95em;
    line-height: 1.75;
  }
  .section ul, .section ol {
    padding-left: 24px;
    margin: 10px 0;
  }
  .section li { margin-bottom: 6px; }
  .section li strong { color: var(--text); }

  /* ===== COLLAPSIBLE SECTIONS ===== */
  details { margin-bottom: 0; }
  details summary { cursor: pointer; list-style: none; user-select: none; padding: 0; }
  details summary::-webkit-details-marker { display: none; }
  details summary::marker { display: none; content: ''; }
  details summary h2 { display: inline-flex; }
  details summary h2::before {
    content: '\25B6'; display: inline-flex; align-items: center;
    margin-right: 8px; transition: transform 0.2s; font-size: 0.5em; color: var(--text-muted);
  }
  details[open] summary h2::before { transform: rotate(90deg); }
  .toggle-controls { display: flex; gap: 8px; margin-top: 10px; }
  .toggle-controls button {
    padding: 5px 14px; border-radius: 8px; border: 1px solid #e5e7eb;
    background: var(--card-bg); color: var(--text-muted); font-size: 0.78em;
    cursor: pointer; transition: all 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  }
  .toggle-controls button:hover { color: var(--purple); border-color: var(--purple); background: rgba(123,47,247,0.1); }

  /* ===== CARDS ===== */
  .card {
    background: var(--card-bg);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 14px;
    padding: 24px 28px;
    margin: 16px 0;
    transition: border-color 0.3s;
  }
  .card:hover { border-color: rgba(255,90,95,0.3); }
  .card h4 { margin-top: 0; }
  .card-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 16px;
    margin: 16px 0;
  }

  /* ===== GRID LAYOUTS ===== */
  .grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin: 16px 0;
  }
  .grid-3 {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 16px;
    margin: 16px 0;
  }
  .grid-4 {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin: 16px 0;
  }

  /* ===== CODE BLOCKS ===== */
  pre {
    background: #f6f8fa;
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 10px;
    padding: 20px 24px;
    overflow-x: auto;
    margin: 14px 0;
    font-size: 0.85em;
    line-height: 1.65;
  }
  code {
    font-family: 'Cascadia Code', 'Fira Code', 'JetBrains Mono', Consolas, monospace;
    color: #24292f;
  }
  :not(pre) > code {
    background: rgba(66,139,249,0.1);
    padding: 2px 7px;
    border-radius: 5px;
    font-size: 0.88em;
    color: var(--blue);
  }
  .kw { color: #cf222e; }
  .fn { color: #8250df; }
  .str { color: #0a3069; }
  .cm { color: #6e7781; font-style: italic; }
  .typ { color: #0550ae; }
  .num { color: #f59e0b; }
  .op { color: #cf222e; }
  .var { color: #953800; }

  /* ===== TABLES ===== */
  .table-wrap {
    overflow-x: auto;
    margin: 14px 0;
    border-radius: 10px;
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.88em;
  }
  th {
    background: rgba(255,90,95,0.1);
    color: var(--primary);
    text-align: left;
    padding: 12px 16px;
    font-weight: 700;
    font-size: 0.85em;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    border-bottom: 2px solid #e5e7eb;
    white-space: nowrap;
  }
  td {
    padding: 11px 16px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    color: var(--text-muted);
    vertical-align: top;
  }
  tr:hover td { background: rgba(255,255,255,0.02); }
  tr:last-child td { border-bottom: none; }
  td strong { color: var(--text); }

  /* ===== ARCHITECTURE DIAGRAM ===== */
  .arch-diagram {
    background: linear-gradient(135deg, #0d1117, #161b22);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 14px;
    padding: 32px;
    margin: 20px 0;
    overflow-x: auto;
    font-family: 'Cascadia Code', 'Fira Code', Consolas, monospace;
    font-size: 0.78em;
    line-height: 1.55;
    color: var(--text-muted);
    white-space: pre;
  }
  .diagram-box {
    background: rgba(0,0,0,0.05);
    border-radius: 12px;
    padding: 20px;
    overflow-x: auto;
    margin: 20px 0;
  }

  /* ===== FLOW STEPS ===== */
  .flow-steps {
    margin: 16px 0;
    counter-reset: step-counter;
  }
  .flow-step {
    display: flex;
    gap: 16px;
    align-items: flex-start;
    margin-bottom: 14px;
    counter-increment: step-counter;
  }
  .flow-step-num {
    min-width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    font-size: 0.85em;
    flex-shrink: 0;
  }
  .flow-step-content {
    flex: 1;
    padding-top: 5px;
  }
  .flow-step-content strong { color: var(--text); }
  .flow-step-content p { margin: 0; color: var(--text-muted); font-size: 0.92em; }

  /* ===== CALLOUT / TIP BOXES ===== */
  .callout {
    border-left: 4px solid var(--secondary);
    background: rgba(0,166,153,0.06);
    padding: 16px 20px;
    border-radius: 0 10px 10px 0;
    margin: 16px 0;
    font-size: 0.92em;
  }
  .callout.warning {
    border-left-color: var(--warning);
    background: rgba(245,158,11,0.06);
  }
  .callout.danger {
    border-left-color: var(--danger);
    background: rgba(239,68,68,0.06);
  }
  .callout.info {
    border-left-color: var(--blue);
    background: rgba(66,139,249,0.06);
  }
  .callout.purple {
    border-left-color: var(--purple);
    background: rgba(123,47,247,0.06);
  }
  .callout strong {
    color: var(--text);
    display: block;
    margin-bottom: 6px;
  }
  .callout p, .callout li { color: var(--text-muted); font-size: 0.93em; }

  /* ===== METRIC BOXES ===== */
  .metric-box {
    background: var(--card-bg);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
  }
  .metric-box .metric-value {
    font-size: 1.8em;
    font-weight: 800;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .metric-box .metric-label {
    font-size: 0.78em;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 4px;
  }

  /* ===== ER TABLE STYLE ===== */
  .er-table {
    background: var(--card-bg);
    border: 2px solid var(--card-border);
    border-radius: 10px;
    overflow: hidden;
    margin: 12px 0;
    min-width: 280px;
  }
  .er-table .er-header {
    background: #f8fafc;
    padding: 10px 16px;
    font-weight: 700;
    font-size: 0.95em;
    border-bottom: 2px solid #e5e7eb;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .er-table .er-row {
    padding: 6px 16px;
    font-size: 0.85em;
    border-bottom: 1px solid rgba(51,65,85,0.5);
    display: flex;
    justify-content: space-between;
    gap: 12px;
  }
  .er-table .er-row:last-child { border-bottom: none; }
  .er-col { color: var(--text); }
  .er-type { color: var(--text-muted); font-family: monospace; font-size: 0.92em; }
  .er-pk { color: var(--warning); font-weight: 600; }
  .er-fk { color: var(--purple); }
  .er-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin: 20px 0;
  }

  /* ===== COMPARE GRID ===== */
  .compare-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin: 16px 0;
  }
  .compare-card {
    background: var(--card-bg);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 12px;
    padding: 22px;
  }
  .compare-card.option-a { border-top: 3px solid var(--blue); }
  .compare-card.option-b { border-top: 3px solid var(--secondary); }
  .compare-card h4 { margin-top: 0; }

  /* ===== PRIORITY TAGS ===== */
  .priority-tag {
    display: inline-block;
    padding: 3px 12px;
    border-radius: 6px;
    font-size: 0.75em;
    font-weight: 700;
    letter-spacing: 0.5px;
  }
  .p0 { background: rgba(239,68,68,0.2); color: var(--danger); border: 1px solid var(--danger); }
  .p1 { background: rgba(252,100,45,0.2); color: var(--accent); border: 1px solid var(--accent); }
  .p2 { background: rgba(245,158,11,0.2); color: var(--warning); border: 1px solid var(--warning); }
  .p3 { background: rgba(66,139,249,0.2); color: var(--blue); border: 1px solid var(--blue); }

  /* ===== LIFECYCLE FLOW ===== */
  .lifecycle-flow {
    display: flex;
    flex-wrap: wrap;
    gap: 0;
    margin: 20px 0;
    align-items: center;
  }
  .lifecycle-step {
    background: var(--card-bg);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 10px;
    padding: 14px 20px;
    text-align: center;
    font-size: 0.88em;
    font-weight: 600;
    min-width: 130px;
  }
  .lifecycle-step .step-label {
    font-size: 0.72em;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    display: block;
    margin-bottom: 4px;
    font-weight: 400;
  }
  .flow-arrow {
    color: var(--primary);
    font-size: 1.4em;
    padding: 0 8px;
    flex-shrink: 0;
  }

  /* ===== RESPONSIVE ===== */
  @media (max-width: 768px) {
    .hero { padding: 40px 20px 35px; }
    .hero h1 { font-size: 1.8em; }
    .container { padding: 0 16px; }
    .grid-2, .grid-3, .grid-4, .compare-grid, .card-grid, .er-grid { grid-template-columns: 1fr; }
    .nav-bar { padding: 14px 16px; }
    .hero .stats-row { gap: 16px; }
    .lifecycle-flow { flex-direction: column; align-items: stretch; }
    .flow-arrow { transform: rotate(90deg); text-align: center; padding: 4px 0; }
    table { font-size: 0.82em; display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .diagram-box { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .diagram-box svg { min-width: 600px; }
  }
  @media (max-width: 480px) {
    .hero h1 { font-size: 1.4em; }
    pre { font-size: 0.75em; padding: 14px; }
  }
  @media (max-width: 360px) {
    .hero h1 { font-size: 1.15em; }
    .hero .stat-value { font-size: 1em; }
    .container { padding: 10px 8px; }
  }
  /* === DIAGRAM ZOOM CONTROLS === */
  .diagram-box { position: relative; }
  .diagram-zoom-controls {
    position: absolute; top: 12px; right: 12px; z-index: 10;
    display: flex; gap: 4px; opacity: 0.5; transition: opacity 0.3s;
  }
  .diagram-box:hover .diagram-zoom-controls { opacity: 1; }
  .diagram-zoom-controls button {
    width: 32px; height: 32px; border-radius: 8px; border: 1px solid #e5e7eb;
    background: #ffffff; color: #1e293b; cursor: pointer; font-size: 16px;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.2s;
    font-family: system-ui; line-height: 1; padding: 0;
  }
  .diagram-zoom-controls button:hover { background: #f1f5f9; border-color: var(--blue); color: var(--blue); }
  .diagram-zoom-controls button:active { transform: scale(0.95); }
  .diagram-zoom-controls .zoom-level {
    font-size: 11px; color: #64748b; display: flex; align-items: center;
    padding: 0 6px; font-weight: 600; min-width: 40px; justify-content: center;
  }
  .diagram-box svg { transition: transform 0.3s ease; transform-origin: center center; }
  .diagram-box.fullscreen {
    position: fixed !important; top: 0; left: 0; width: 100vw; height: 100vh;
    z-index: 9999; background: #ffffff; border-radius: 0; padding: 20px;
    display: flex; align-items: center; justify-content: center;
    overflow: auto;
  }
  .diagram-box.fullscreen .diagram-zoom-controls { opacity: 1; top: 20px; right: 20px; }
  /* ========== NOTES & COMMENTS SYSTEM ========== */
  .notes-fab {
    position: fixed; bottom: 28px; right: 28px; z-index: 10000;
    width: 56px; height: 56px; border-radius: 50%;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    color: #fff; border: none; cursor: pointer;
    font-size: 24px; display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 14px rgba(255,90,95,0.35);
    transition: all 0.3s;
  }
  .notes-fab:hover { transform: scale(1.08); box-shadow: 0 6px 20px rgba(255,90,95,0.45); }
  .notes-fab .note-count {
    position: absolute; top: -4px; right: -4px;
    background: var(--blue); color: #fff; font-size: 11px; font-weight: 800;
    width: 22px; height: 22px; border-radius: 50%; display: flex;
    align-items: center; justify-content: center; border: 2px solid #fff;
  }
  .notes-panel {
    position: fixed; top: 0; right: -440px; width: 420px; height: 100vh;
    background: #ffffff; z-index: 10001;
    box-shadow: -4px 0 24px rgba(0,0,0,0.12);
    transition: right 0.35s cubic-bezier(0.4,0,0.2,1);
    display: flex; flex-direction: column;
    border-left: 1px solid #e5e7eb;
  }
  .notes-panel.open { right: 0; }
  .notes-panel-header {
    padding: 20px 24px; border-bottom: 1px solid #e5e7eb;
    display: flex; align-items: center; gap: 12px;
    background: #f8fafc;
  }
  .notes-panel-header h3 { flex: 1; margin: 0; font-size: 1.1em; color: #1e293b; }
  .notes-panel-header .notes-close {
    width: 32px; height: 32px; border-radius: 8px; border: 1px solid #e5e7eb;
    background: #fff; cursor: pointer; font-size: 18px; color: #64748b;
    display: flex; align-items: center; justify-content: center;
  }
  .notes-panel-header .notes-close:hover { background: #fef2f2; color: var(--primary); border-color: var(--primary); }
  .notes-compose {
    padding: 16px 24px; border-bottom: 1px solid #e5e7eb; background: #fafbfc;
  }
  .notes-compose select {
    width: 100%; padding: 8px 12px; border-radius: 8px; border: 1px solid #e5e7eb;
    font-size: 0.85em; color: #1e293b; background: #fff; margin-bottom: 8px;
    font-family: inherit;
  }
  .notes-compose textarea {
    width: 100%; min-height: 80px; padding: 12px; border-radius: 8px;
    border: 1px solid #e5e7eb; font-size: 0.9em; font-family: inherit;
    color: #1e293b; background: #fff; resize: vertical; line-height: 1.5;
  }
  .notes-compose textarea:focus { outline: none; border-color: var(--blue); box-shadow: 0 0 0 3px rgba(66,139,249,0.12); }
  .notes-compose .notes-actions { display: flex; gap: 8px; margin-top: 10px; align-items: center; }
  .notes-compose .notes-actions select.tag-select {
    width: auto; padding: 6px 10px; font-size: 0.8em; border-radius: 6px; margin: 0;
  }
  .notes-btn {
    padding: 8px 18px; border-radius: 8px; border: none; cursor: pointer;
    font-size: 0.85em; font-weight: 600; font-family: inherit; transition: all 0.2s;
  }
  .notes-btn.primary { background: var(--blue); color: #fff; }
  .notes-btn.primary:hover { background: #3070D0; }
  .notes-btn.danger { background: transparent; color: var(--danger); border: 1px solid rgba(239,68,68,0.3); }
  .notes-btn.danger:hover { background: #fef2f2; }
  .notes-btn.export { background: transparent; color: var(--secondary); border: 1px solid rgba(0,166,153,0.3); margin-left: auto; }
  .notes-btn.export:hover { background: rgba(0,166,153,0.06); }
  .notes-list { flex: 1; overflow-y: auto; padding: 16px 24px; }
  .notes-list:empty::after {
    content: 'No notes yet. Add your first note above!';
    display: block; text-align: center; color: #94a3b8; font-size: 0.9em;
    padding: 40px 0; font-style: italic;
  }
  .note-item {
    background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 10px;
    padding: 14px 16px; margin-bottom: 12px; position: relative;
    transition: border-color 0.2s;
  }
  .note-item:hover { border-color: var(--blue); }
  .note-item .note-meta {
    display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;
  }
  .note-item .note-section-tag {
    font-size: 0.72em; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
    padding: 3px 8px; border-radius: 4px; background: rgba(66,139,249,0.1); color: var(--blue);
  }
  .note-item .note-tag {
    font-size: 0.7em; font-weight: 600; padding: 2px 8px; border-radius: 10px;
  }
  .note-tag.question { background: rgba(245,158,11,0.12); color: #b45309; }
  .note-tag.important { background: rgba(239,68,68,0.1); color: var(--danger); }
  .note-tag.idea { background: rgba(123,47,247,0.1); color: var(--purple); }
  .note-tag.review { background: rgba(0,166,153,0.1); color: var(--secondary); }
  .note-item .note-time {
    font-size: 0.72em; color: #94a3b8; margin-left: auto;
  }
  .note-item .note-text {
    font-size: 0.9em; color: #374151; line-height: 1.6; white-space: pre-wrap; word-break: break-word;
  }
  .note-item .note-delete {
    position: absolute; top: 10px; right: 10px; width: 24px; height: 24px;
    border-radius: 6px; border: none; background: transparent; cursor: pointer;
    color: #cbd5e1; font-size: 14px; display: flex; align-items: center; justify-content: center;
    opacity: 0; transition: all 0.2s;
  }
  .note-item:hover .note-delete { opacity: 1; }
  .note-item .note-delete:hover { background: #fef2f2; color: var(--danger); }
  .note-item.editing .note-text { display: none; }
  .note-item .note-edit-area {
    display: none; width: 100%; min-height: 60px; padding: 8px; border-radius: 6px;
    border: 1px solid var(--blue); font-size: 0.88em; font-family: inherit;
    color: #1e293b; background: #fff; resize: vertical; line-height: 1.5;
  }
  .note-item.editing .note-edit-area { display: block; }
  .note-item .note-edit-actions { display: none; margin-top: 8px; gap: 6px; }
  .note-item.editing .note-edit-actions { display: flex; }
  /* Section-level note button */
  .section-note-btn {
    display: inline-flex; align-items: center; gap: 5px;
    padding: 4px 10px; border-radius: 6px; border: 1px solid #e5e7eb;
    background: #fff; cursor: pointer; font-size: 0.75em; color: #94a3b8;
    font-family: inherit; transition: all 0.2s; margin-left: 12px; vertical-align: middle;
  }
  .section-note-btn:hover { border-color: var(--blue); color: var(--blue); background: rgba(66,139,249,0.04); }
  .notes-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.2); z-index: 10000; opacity: 0;
    transition: opacity 0.3s; pointer-events: none;
  }
  .notes-overlay.open { opacity: 1; pointer-events: auto; }
  .notes-filter { display: flex; gap: 6px; padding: 8px 24px; border-bottom: 1px solid #e5e7eb; background: #fff; flex-wrap: wrap; }
  .notes-filter button {
    padding: 4px 12px; border-radius: 12px; border: 1px solid #e5e7eb;
    background: #fff; cursor: pointer; font-size: 0.78em; font-family: inherit;
    color: #64748b; transition: all 0.2s;
  }
  .notes-filter button.active { background: var(--blue); color: #fff; border-color: var(--blue); }
  .notes-filter button:hover:not(.active) { border-color: var(--blue); color: var(--blue); }
  @media (max-width: 480px) { .notes-panel { width: 100%; right: -100%; } }
</style>
</head>
<body>

<!-- ============================================================ -->
<!--  HERO + NAV                                                   -->
<!-- ============================================================ -->
<div class="hero">
  <a href="index.html" class="back-link">&#8592; Back to All Topics</a>
  <div class="topic-number-hero">TOPIC 03</div>
  <h1>Listing Availability Tracker</h1>
  <p class="subtitle">Waitlist for unavailable Airbnb listings &mdash; notify guests the instant dates open up via cancellation or host calendar changes</p>

  <div class="hero-badges">
    <span class="badge badge-red">Event-Driven</span>
    <span class="badge badge-green">CDC Pipeline</span>
    <span class="badge badge-blue">Notification System</span>
    <span class="badge badge-purple">Thundering Herd</span>
    <span class="badge badge-orange">Priority Queue</span>
  </div>

  <div class="stats-row">
    <div class="stat-item">
      <div class="stat-value">50M</div>
      <div class="stat-label">Active Waitlist Entries</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">2M</div>
      <div class="stat-label">Waitlist Adds / Day</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">5M</div>
      <div class="stat-label">Notifications / Day</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">&lt;5 min</div>
      <div class="stat-label">Notification SLA</div>
    </div>
  </div>
</div>

<!-- ===== STICKY NAV ===== -->
<nav class="nav-bar">
  <h2>Jump To Section</h2>
  <div class="nav-links">
    <a href="#overview">Overview</a>
    <a href="#requirements">Requirements</a>
    <a href="#capacity">Capacity</a>
    <a href="#architecture">Architecture</a>
    <a href="#api">API Design</a>
    <a href="#data-model">Data Model</a>
    <a href="#matching">Matching Algorithm</a>
    <a href="#notification">Notification Strategy</a>
    <a href="#tradeoffs">Trade-Offs</a>
    <a href="#deep-dives">Deep Dives</a>
    <a href="#interview-tips">Interview Tips</a>
  </div>
  <div class="toggle-controls">
    <button onclick="document.querySelectorAll('.container details').forEach(d=>d.open=true)">Expand All</button>
    <button onclick="document.querySelectorAll('.container details').forEach(d=>d.open=false)">Collapse All</button>
  </div>
</nav>

<div class="container">

<!-- ============================================================ -->
<!--  1. OVERVIEW                                                  -->
<!-- ============================================================ -->
<section class="section" id="overview">
<details open>
  <summary>
  <span class="section-label">Section 1</span>
  <h2>System Overview</h2>
  </summary>

  <p>Guests frequently search for specific listings on specific dates only to find them unavailable. Today, the only option is to check back manually and hope dates open up. The <strong>Availability Tracker</strong> introduces a waitlist mechanism: guests register interest in a listing + date range, and the system automatically notifies them when availability changes &mdash; due to booking cancellations, host calendar unblocks, or reservation modifications.</p>

  <h3>User Journey</h3>
  <div class="lifecycle-flow">
    <div class="lifecycle-step" style="border-color: var(--primary);">
      <span class="step-label">Step 1</span>
      Guest Searches
    </div>
    <span class="flow-arrow">&#10132;</span>
    <div class="lifecycle-step" style="border-color: var(--accent);">
      <span class="step-label">Step 2</span>
      Dates Unavailable
    </div>
    <span class="flow-arrow">&#10132;</span>
    <div class="lifecycle-step" style="border-color: var(--purple);">
      <span class="step-label">Step 3</span>
      Joins Waitlist
    </div>
    <span class="flow-arrow">&#10132;</span>
    <div class="lifecycle-step" style="border-color: var(--blue);">
      <span class="step-label">Step 4</span>
      Cancellation Occurs
    </div>
    <span class="flow-arrow">&#10132;</span>
    <div class="lifecycle-step" style="border-color: #e5e7eb;">
      <span class="step-label">Step 5</span>
      Notification Sent
    </div>
    <span class="flow-arrow">&#10132;</span>
    <div class="lifecycle-step" style="border-color: var(--success);">
      <span class="step-label">Step 6</span>
      Guest Books
    </div>
  </div>

  <div class="card-grid">
    <div class="card" style="border-top: 3px solid var(--primary);">
      <h4 style="color: var(--primary);">The Problem</h4>
      <ul>
        <li>Popular listings sell out months in advance</li>
        <li>~8-12% of bookings are cancelled, but guests waiting don't know</li>
        <li>Manual refresh creates poor UX and unnecessary server load</li>
        <li>Hosts lose potential revenue from slow re-booking after cancellations</li>
      </ul>
    </div>
    <div class="card" style="border-top: 3px solid var(--secondary);">
      <h4 style="color: #1e293b;">The Solution</h4>
      <ul>
        <li>Structured waitlist with date-range matching</li>
        <li>CDC-powered real-time detection of availability changes</li>
        <li>Prioritized notification dispatch (FIFO with tier boosts)</li>
        <li>Exclusive booking windows to prevent thundering herd</li>
        <li>Auto-expiry and garbage collection for stale entries</li>
      </ul>
    </div>
  </div>

  <div class="callout info">
    <strong>Why This Matters at Airbnb Scale</strong>
    <p>With 7M+ active listings and 100M+ nights booked per year, even a small percentage improvement in re-booking cancelled dates translates to hundreds of millions in GMV recovery. This system sits at the intersection of search, bookings, and notifications &mdash; a classic cross-cutting PE design challenge.</p>
  </div>
</details>
</section>

<!-- ============================================================ -->
<!--  2. REQUIREMENTS                                              -->
<!-- ============================================================ -->
<section class="section" id="requirements">
<details open>
  <summary>
  <span class="section-label">Section 2</span>
  <h2>Requirements</h2>
  </summary>

  <div class="grid-2">
    <div class="card" style="border-top: 3px solid var(--secondary);">
      <h4 style="color: #1e293b;">Functional Requirements</h4>
      <ul>
        <li><strong>Add/Remove waitlist:</strong> Guest registers interest in listing + date range. Can cancel anytime.</li>
        <li><strong>Notify on availability:</strong> When dates free up (cancellation, host unblock), notify matching waitlist guests.</li>
        <li><strong>Priority + Dedup:</strong> FIFO with tier boosts. Same user can't join twice for overlapping dates.</li>
        <li><strong>Auto-expire:</strong> Entries expire when check-in passes or after TTL (90 days).</li>
      </ul>
    </div>
    <div class="card" style="border-top: 3px solid var(--blue);">
      <h4 style="color: var(--blue);">Non-Functional Requirements</h4>
      <ul>
        <li><strong>Notification &lt;5 min:</strong> From availability change to notification delivery.</li>
        <li><strong>Thundering herd:</strong> Don't blast 10K users simultaneously &mdash; stagger + exclusive booking windows.</li>
        <li><strong>Scale:</strong> 50M active entries, 2M adds/day, 500K availability events/day.</li>
        <li><strong>Idempotency:</strong> Dedup notifications to avoid spamming users.</li>
      </ul>
    </div>
  </div>
</details>
</section>

<!-- ============================================================ -->
<!--  3. CAPACITY ESTIMATION                                       -->
<!-- ============================================================ -->
<section class="section" id="capacity">
<details>
  <summary>
  <span class="section-label">Section 3</span>
  <h2>Capacity Estimation</h2>
  </summary>

  <div class="grid-4">
    <div class="metric-box">
      <div class="metric-value">2M</div>
      <div class="metric-label">Waitlist Adds / Day</div>
    </div>
    <div class="metric-box">
      <div class="metric-value">500K</div>
      <div class="metric-label">Availability Changes / Day</div>
    </div>
    <div class="metric-box">
      <div class="metric-value">5M</div>
      <div class="metric-label">Notifications / Day</div>
    </div>
    <div class="metric-box">
      <div class="metric-value">50M</div>
      <div class="metric-label">Active Entries</div>
    </div>
  </div>

  <h3>Write Path (Waitlist Mutations)</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Metric</th>
          <th>Calculation</th>
          <th>Result</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Waitlist writes/sec</strong></td>
          <td>2M / 86,400s</td>
          <td><strong style="color:var(--primary);">~23 writes/sec</strong> (peak 3x = ~70/s)</td>
        </tr>
        <tr>
          <td><strong>Removes/sec</strong></td>
          <td>~50% of adds = 1M/day / 86,400s</td>
          <td><strong style="color:var(--primary);">~12 writes/sec</strong></td>
        </tr>
        <tr>
          <td><strong>Entry size</strong></td>
          <td>user_id + listing_id + dates + metadata</td>
          <td><strong style="color:var(--primary);">~300 bytes</strong></td>
        </tr>
        <tr>
          <td><strong>Storage (active)</strong></td>
          <td>50M entries x 300 bytes</td>
          <td><strong style="color:var(--primary);">~15 GB</strong></td>
        </tr>
      </tbody>
    </table>
  </div>

  <h3>Read Path (Availability Matching)</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Metric</th>
          <th>Calculation</th>
          <th>Result</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Availability events/sec</strong></td>
          <td>500K / 86,400s</td>
          <td><strong style="color:var(--secondary);">~6 events/sec</strong> (peak 10x = ~60/s)</td>
        </tr>
        <tr>
          <td><strong>Avg waitlist entries per listing</strong></td>
          <td>50M entries / 7M listings (not all have waitlists)</td>
          <td><strong style="color:var(--secondary);">~25 entries/listing</strong> (hot listings: 500+)</td>
        </tr>
        <tr>
          <td><strong>Matching queries/sec</strong></td>
          <td>~6 availability events x 1 query each</td>
          <td><strong style="color:var(--secondary);">~6 queries/sec</strong></td>
        </tr>
        <tr>
          <td><strong>Notifications/sec</strong></td>
          <td>5M / 86,400s</td>
          <td><strong style="color:var(--secondary);">~58/sec</strong> (peak: ~300/s)</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="callout">
    <strong>Key Insight: This is a Write-Heavy, Read-Bursty System</strong>
    <p>The steady-state QPS is modest (the write path is only ~23/s), but availability changes for popular listings trigger burst reads &mdash; one cancellation on a hot listing might match 500+ waitlist entries, all needing notification within the 5-minute SLA. The architecture must handle this burstiness gracefully.</p>
  </div>
</details>
</section>

<!-- ============================================================ -->
<!--  4. HIGH-LEVEL ARCHITECTURE                                   -->
<!-- ============================================================ -->
<section class="section" id="architecture">
<details>
  <summary>
  <span class="section-label">Section 4</span>
  <h2>High-Level Architecture</h2>
  </summary>

  <div class="diagram-box">
<svg viewBox="0 0 1100 680" xmlns="http://www.w3.org/2000/svg" font-family="'Segoe UI', sans-serif" style="width:100%; height:auto;">
  <defs>
    <!-- Gradients -->
    <linearGradient id="at-g1" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#FF5A5F"/><stop offset="100%" stop-color="#FF8A8E"/></linearGradient>
    <linearGradient id="at-g2" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#00A699"/><stop offset="100%" stop-color="#33C1B5"/></linearGradient>
    <linearGradient id="at-g3" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#428BF9"/><stop offset="100%" stop-color="#72ABFF"/></linearGradient>
    <linearGradient id="at-g4" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#7B2FF7"/><stop offset="100%" stop-color="#A66FFF"/></linearGradient>
    <linearGradient id="at-g5" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#FC642D"/><stop offset="100%" stop-color="#FF9966"/></linearGradient>
    <!-- Shadow -->
    <filter id="at-shadow"><feDropShadow dx="2" dy="3" stdDeviation="4" flood-opacity="0.12"/></filter>
    <!-- Arrow markers -->
    <marker id="at-arrowSync" viewBox="0 0 10 7" refX="10" refY="3.5" markerWidth="10" markerHeight="7" orient="auto-start-reverse"><polygon points="0 0, 10 3.5, 0 7" fill="#9ca3af"/></marker>
    <marker id="at-arrowAsync" viewBox="0 0 10 7" refX="10" refY="3.5" markerWidth="10" markerHeight="7" orient="auto-start-reverse"><polygon points="0 0, 10 3.5, 0 7" fill="#ef4444"/></marker>
    <marker id="at-arrowCDC" viewBox="0 0 10 7" refX="10" refY="3.5" markerWidth="10" markerHeight="7" orient="auto-start-reverse"><polygon points="0 0, 10 3.5, 0 7" fill="#f59e0b"/></marker>
  </defs>
  <!-- Light background -->
  <rect width="1100" height="680" rx="12" fill="#f8fafc"/>

  <!-- Section Labels -->
  <text x="65" y="28" fill="#475569" font-size="13" font-weight="700" letter-spacing="2">CLIENTS</text>
  <text x="280" y="28" fill="#475569" font-size="13" font-weight="700" letter-spacing="2">GATEWAY</text>
  <text x="500" y="28" fill="#475569" font-size="13" font-weight="700" letter-spacing="2">SERVICES</text>
  <text x="840" y="28" fill="#475569" font-size="13" font-weight="700" letter-spacing="2">DATA LAYER</text>

  <!-- ======= CLIENTS ======= -->
  <!-- Web Client -->
  <g filter="url(#at-shadow)">
    <rect x="30" y="80" width="120" height="65" rx="10" fill="url(#at-g3)" opacity="0.92"/>
    <rect x="62" y="92" width="28" height="20" rx="3" fill="none" stroke="#fff" stroke-width="1.8"/>
    <line x1="76" y1="112" x2="76" y2="117" stroke="#fff" stroke-width="1.8"/>
    <line x1="69" y1="117" x2="83" y2="117" stroke="#fff" stroke-width="1.8"/>
    <text x="90" y="130" fill="#fff" font-size="12" font-weight="600">Web</text>
  </g>

  <!-- Mobile Client -->
  <g filter="url(#at-shadow)">
    <rect x="30" y="175" width="120" height="65" rx="10" fill="url(#at-g3)" opacity="0.92"/>
    <rect x="70" y="187" width="15" height="24" rx="3" fill="none" stroke="#fff" stroke-width="1.8"/>
    <line x1="75" y1="206" x2="80" y2="206" stroke="#fff" stroke-width="1.5"/>
    <text x="90" y="225" fill="#fff" font-size="12" font-weight="600">Mobile</text>
  </g>

  <!-- ======= EXTERNAL SERVICES (dashed border + cloud) ======= -->
  <!-- Booking Service -->
  <g filter="url(#at-shadow)">
    <rect x="22" y="320" width="145" height="60" rx="8" fill="#f8fafc" stroke="#FC642D" stroke-width="1.8" stroke-dasharray="6,3"/>
    <!-- Cloud icon -->
    <path d="M44,340 Q40,330 50,328 Q52,322 60,324 Q68,320 72,328 Q80,328 78,338 Z" fill="none" stroke="#FC642D" stroke-width="1.3"/>
    <text x="86" y="348" fill="#FC642D" font-size="10" font-weight="600">Booking Svc</text>
    <text x="86" y="362" fill="#94a3b8" font-size="8">(existing)</text>
  </g>

  <!-- Calendar Service -->
  <g filter="url(#at-shadow)">
    <rect x="22" y="405" width="145" height="60" rx="8" fill="#f8fafc" stroke="#FC642D" stroke-width="1.8" stroke-dasharray="6,3"/>
    <path d="M44,425 Q40,415 50,413 Q52,407 60,409 Q68,405 72,413 Q80,413 78,423 Z" fill="none" stroke="#FC642D" stroke-width="1.3"/>
    <text x="86" y="433" fill="#FC642D" font-size="10" font-weight="600">Calendar Svc</text>
    <text x="86" y="447" fill="#94a3b8" font-size="8">(existing)</text>
  </g>

  <!-- ======= GATEWAY ======= -->
  <!-- API Gateway (shield) -->
  <g filter="url(#at-shadow)">
    <rect x="230" y="110" width="145" height="80" rx="10" fill="#f8fafc" stroke="#FF5A5F" stroke-width="2"/>
    <!-- Shield icon -->
    <path d="M258,125 L258,142 Q258,154 270,158 Q282,154 282,142 L282,125 L270,120 Z" fill="none" stroke="#FF5A5F" stroke-width="1.8"/>
    <polyline points="263,136 268,142 277,130" fill="none" stroke="#FF5A5F" stroke-width="1.8"/>
    <text x="290" y="143" fill="#1e293b" font-size="11" font-weight="600">API Gateway</text>
    <text x="290" y="158" fill="#64748b" font-size="9">Auth + Rate Limit</text>
    <text x="290" y="171" fill="#64748b" font-size="9">Throttle</text>
  </g>

  <!-- ======= SERVICES ======= -->
  <!-- Waitlist Service (clock/list icon) -->
  <g filter="url(#at-shadow)">
    <rect x="445" y="65" width="165" height="68" rx="10" fill="url(#at-g2)" opacity="0.9"/>
    <!-- Clock icon -->
    <circle cx="470" cy="92" r="11" fill="none" stroke="#fff" stroke-width="1.5"/>
    <line x1="470" y1="85" x2="470" y2="92" stroke="#fff" stroke-width="1.5"/>
    <line x1="470" y1="92" x2="477" y2="95" stroke="#fff" stroke-width="1.5"/>
    <!-- List lines -->
    <line x1="486" y1="86" x2="498" y2="86" stroke="#fff" stroke-width="1.3"/>
    <line x1="486" y1="92" x2="498" y2="92" stroke="#fff" stroke-width="1.3"/>
    <line x1="486" y1="98" x2="498" y2="98" stroke="#fff" stroke-width="1.3"/>
    <text x="506" y="94" fill="#fff" font-size="11" font-weight="600">Waitlist Service</text>
    <text x="506" y="108" fill="rgba(255,255,255,0.75)" font-size="9">CRUD + Query</text>
  </g>

  <!-- Matching Worker (gear icon) -->
  <g filter="url(#at-shadow)">
    <rect x="445" y="165" width="165" height="68" rx="10" fill="url(#at-g3)" opacity="0.9"/>
    <!-- Gear icon -->
    <circle cx="472" cy="195" r="8" fill="none" stroke="#fff" stroke-width="1.5"/>
    <circle cx="472" cy="195" r="3.5" fill="none" stroke="#fff" stroke-width="1.2"/>
    <line x1="472" y1="183" x2="472" y2="187" stroke="#fff" stroke-width="1.5"/>
    <line x1="472" y1="203" x2="472" y2="207" stroke="#fff" stroke-width="1.5"/>
    <line x1="460" y1="195" x2="464" y2="195" stroke="#fff" stroke-width="1.5"/>
    <line x1="480" y1="195" x2="484" y2="195" stroke="#fff" stroke-width="1.5"/>
    <text x="492" y="196" fill="#fff" font-size="11" font-weight="600">Matching Worker</text>
    <text x="492" y="210" fill="rgba(255,255,255,0.75)" font-size="9">Kafka Consumer</text>
  </g>

  <!-- Notification Dispatcher -->
  <g filter="url(#at-shadow)">
    <rect x="445" y="270" width="165" height="68" rx="10" fill="url(#at-g4)" opacity="0.9"/>
    <text x="465" y="300" fill="#fff" font-size="11" font-weight="600">Notification Dispatcher</text>
    <text x="465" y="316" fill="rgba(255,255,255,0.75)" font-size="9">stagger + dedup + window</text>
  </g>

  <!-- Notification Service (bell) -->
  <g filter="url(#at-shadow)">
    <rect x="445" y="375" width="165" height="68" rx="10" fill="url(#at-g5)" opacity="0.9"/>
    <!-- Bell icon -->
    <path d="M470,392 Q470,384 477,384 Q484,384 484,392 L486,400 L468,400 Z" fill="none" stroke="#fff" stroke-width="1.6"/>
    <circle cx="477" cy="404" r="2.5" fill="#fff"/>
    <text x="492" y="404" fill="#fff" font-size="11" font-weight="600">Notification Svc</text>
    <text x="492" y="418" fill="rgba(255,255,255,0.75)" font-size="9">Push / Email / SMS</text>
  </g>

  <!-- ======= DATA LAYER ======= -->
  <!-- PostgreSQL Cylinder -->
  <g filter="url(#at-shadow)">
    <ellipse cx="775" cy="72" rx="55" ry="14" fill="#dbeafe" stroke="#428BF9" stroke-width="1.5"/>
    <rect x="720" y="72" width="110" height="80" fill="#dbeafe" stroke="none"/>
    <ellipse cx="775" cy="152" rx="55" ry="14" fill="#bfdbfe" stroke="#428BF9" stroke-width="1.5"/>
    <line x1="720" y1="72" x2="720" y2="152" stroke="#428BF9" stroke-width="1.5"/>
    <line x1="830" y1="72" x2="830" y2="152" stroke="#428BF9" stroke-width="1.5"/>
    <text x="775" y="96" text-anchor="middle" fill="#1e40af" font-size="12" font-weight="700">PostgreSQL</text>
    <text x="775" y="112" text-anchor="middle" fill="#3b82f6" font-size="9">waitlist_entries</text>
    <text x="775" y="125" text-anchor="middle" fill="#3b82f6" font-size="9">waitlist_archive</text>
    <text x="775" y="138" text-anchor="middle" fill="#3b82f6" font-size="9">availability</text>
  </g>

  <!-- Redis Diamond -->
  <g filter="url(#at-shadow)">
    <polygon points="775,195 835,240 775,285 715,240" fill="#fef2f2" stroke="#ef4444" stroke-width="2"/>
    <polygon points="775,210 820,240 775,270 730,240" fill="#fee2e2" stroke="#ef4444" stroke-width="1" opacity="0.7"/>
    <text x="775" y="234" text-anchor="middle" fill="#ef4444" font-size="12" font-weight="700">Redis</text>
    <text x="775" y="248" text-anchor="middle" fill="#dc2626" font-size="8">active waitlist cache</text>
    <text x="775" y="259" text-anchor="middle" fill="#dc2626" font-size="8">listing counts</text>
  </g>

  <!-- Kafka Cluster -->
  <g filter="url(#at-shadow)">
    <rect x="870" y="310" width="190" height="145" rx="10" fill="#f8fafc" stroke="#ef4444" stroke-width="1.5"/>
    <!-- Kafka nodes -->
    <circle cx="920" cy="345" r="10" fill="#ef4444" opacity="0.85"/>
    <circle cx="960" cy="330" r="10" fill="#ef4444" opacity="0.85"/>
    <circle cx="1000" cy="345" r="10" fill="#ef4444" opacity="0.85"/>
    <!-- Connecting lines -->
    <line x1="930" y1="345" x2="950" y2="332" stroke="#fca5a5" stroke-width="1.2"/>
    <line x1="970" y1="332" x2="990" y2="345" stroke="#fca5a5" stroke-width="1.2"/>
    <line x1="930" y1="345" x2="990" y2="345" stroke="#fca5a5" stroke-width="1.2"/>
    <!-- Streaming arrows (topics) -->
    <path d="M910,370 L990,370" stroke="#fca5a5" stroke-width="1" stroke-dasharray="4,3"/>
    <polygon points="990,367 997,370 990,373" fill="#dc2626"/>
    <text x="950" y="368" text-anchor="middle" fill="#6b7280" font-size="7">availability.changes</text>
    <path d="M910,390 L990,390" stroke="#fca5a5" stroke-width="1" stroke-dasharray="4,3"/>
    <polygon points="990,387 997,390 990,393" fill="#dc2626"/>
    <text x="950" y="388" text-anchor="middle" fill="#6b7280" font-size="7">waitlist.matched</text>
    <text x="960" y="430" text-anchor="middle" fill="#ef4444" font-size="13" font-weight="700">KAFKA</text>
    <text x="960" y="445" text-anchor="middle" fill="#dc2626" font-size="8">Event Streaming</text>
  </g>

  <!-- ======= CDC: Debezium ======= -->
  <g filter="url(#at-shadow)">
    <rect x="860" y="195" width="120" height="55" rx="8" fill="#f8fafc" stroke="#f59e0b" stroke-width="1.8" stroke-dasharray="5,3"/>
    <!-- CDC arrows -->
    <path d="M878,215 L888,210 L888,220 Z" fill="#f59e0b"/>
    <path d="M893,215 L903,210 L903,220 Z" fill="#f59e0b"/>
    <text x="912" y="220" fill="#f59e0b" font-size="10" font-weight="600">Debezium</text>
    <text x="912" y="234" fill="#64748b" font-size="8">CDC / WAL reader</text>
  </g>

  <!-- Booking DB (small cylinder for CDC source) -->
  <g filter="url(#at-shadow)">
    <ellipse cx="920" cy="145" rx="38" ry="10" fill="#fef3c7" stroke="#D4A574" stroke-width="1.2"/>
    <rect x="882" y="145" width="76" height="30" fill="#fef3c7" stroke="none"/>
    <ellipse cx="920" cy="175" rx="38" ry="10" fill="#fde68a" stroke="#D4A574" stroke-width="1.2"/>
    <line x1="882" y1="145" x2="882" y2="175" stroke="#D4A574" stroke-width="1.2"/>
    <line x1="958" y1="145" x2="958" y2="175" stroke="#D4A574" stroke-width="1.2"/>
    <text x="920" y="165" text-anchor="middle" fill="#92400e" font-size="9" font-weight="600">Booking DB</text>
  </g>

  <!-- ======= CONNECTION LINES ======= -->
  <!-- Clients to API Gateway -->
  <line x1="150" y1="112" x2="230" y2="140" stroke="#9ca3af" stroke-width="1.5" marker-end="url(#at-arrowSync)"/>
  <line x1="150" y1="207" x2="230" y2="168" stroke="#9ca3af" stroke-width="1.5" marker-end="url(#at-arrowSync)"/>

  <!-- API GW to Waitlist Service -->
  <line x1="375" y1="140" x2="445" y2="99" stroke="#9ca3af" stroke-width="1.5" marker-end="url(#at-arrowSync)"/>

  <!-- Waitlist Service to PostgreSQL -->
  <line x1="610" y1="88" x2="720" y2="100" stroke="#9ca3af" stroke-width="1.5" marker-end="url(#at-arrowSync)"/>

  <!-- Waitlist Service to Redis -->
  <line x1="610" y1="110" x2="715" y2="230" stroke="#9ca3af" stroke-width="1.5" marker-end="url(#at-arrowSync)"/>
  <text x="640" y="165" fill="#9ca3af" font-size="8" transform="rotate(40,640,165)">cache write</text>

  <!-- Booking Service -> Kafka (async event) -->
  <line x1="167" y1="350" x2="870" y2="370" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="6,3" marker-end="url(#at-arrowAsync)"/>
  <text x="500" y="355" fill="#ef4444" font-size="8">cancellation / modification event</text>

  <!-- Calendar Service -> Kafka (async event) -->
  <line x1="167" y1="435" x2="870" y2="390" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="6,3" marker-end="url(#at-arrowAsync)"/>
  <text x="480" y="422" fill="#ef4444" font-size="8">host unblock event</text>

  <!-- Booking DB -> Debezium (CDC / WAL) -->
  <line x1="920" y1="175" x2="920" y2="195" stroke="#f59e0b" stroke-width="1.5" marker-end="url(#at-arrowCDC)"/>
  <text x="930" y="188" fill="#f59e0b" font-size="7">WAL</text>

  <!-- Debezium -> Kafka -->
  <line x1="920" y1="250" x2="940" y2="310" stroke="#f59e0b" stroke-width="1.5" marker-end="url(#at-arrowCDC)"/>

  <!-- Kafka -> Matching Worker -->
  <line x1="870" y1="370" x2="610" y2="195" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="6,3" marker-end="url(#at-arrowAsync)"/>
  <text x="730" y="275" fill="#ef4444" font-size="8" transform="rotate(-25,730,275)">availability.changes</text>

  <!-- Matching Worker -> PG/Redis (queries) -->
  <line x1="527" y1="165" x2="720" y2="125" stroke="#9ca3af" stroke-width="1.2" stroke-dasharray="3,2" marker-end="url(#at-arrowSync)"/>
  <text x="620" y="138" fill="#9ca3af" font-size="7">query waitlist</text>

  <line x1="500" y1="165" x2="715" y2="235" stroke="#9ca3af" stroke-width="1.2" stroke-dasharray="3,2" marker-end="url(#at-arrowSync)"/>

  <!-- Matching Worker -> Kafka (produces matched) -->
  <line x1="610" y1="210" x2="870" y2="390" stroke="#ef4444" stroke-width="1.3" stroke-dasharray="6,3" marker-end="url(#at-arrowAsync)"/>
  <text x="735" y="310" fill="#ef4444" font-size="8" transform="rotate(28,735,310)">waitlist.matched</text>

  <!-- Kafka -> Notification Dispatcher -->
  <line x1="870" y1="400" x2="610" y2="304" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="6,3" marker-end="url(#at-arrowAsync)"/>

  <!-- Notification Dispatcher -> Notification Svc -->
  <line x1="527" y1="338" x2="527" y2="375" stroke="#9ca3af" stroke-width="1.5" marker-end="url(#at-arrowSync)"/>

  <!-- Notification Svc -> User (push/email) -->
  <line x1="445" y1="415" x2="150" y2="230" stroke="#00A699" stroke-width="1.3" stroke-dasharray="5,3"/>
  <text x="270" y="335" fill="#00A699" font-size="8" transform="rotate(-30,270,335)">push / email to user</text>

  <!-- ======= NUMBERED STEP CIRCLES ======= -->
  <!-- Step 1: Client -> API Gateway -->
  <circle cx="190" cy="126" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="190" y="130" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">1</text>
  <!-- Step 2: API Gateway -> Waitlist Service -->
  <circle cx="410" cy="118" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="410" y="122" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">2</text>
  <!-- Step 3: Waitlist Service -> PostgreSQL -->
  <circle cx="665" cy="88" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="665" y="92" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">3</text>
  <!-- Step 4: Waitlist Service -> Redis -->
  <circle cx="645" cy="170" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="645" y="174" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">4</text>
  <!-- Step 5: Booking DB -> Debezium CDC -->
  <circle cx="945" cy="185" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="945" y="189" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">5</text>
  <!-- Step 6: Debezium -> Kafka -->
  <circle cx="915" cy="280" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="915" y="284" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">6</text>
  <!-- Step 7: Kafka -> Matching Worker -->
  <circle cx="760" cy="265" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="760" y="269" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">7</text>
  <!-- Step 8: Matching Worker -> PostgreSQL (query) -->
  <circle cx="620" cy="142" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="620" y="146" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">8</text>
  <!-- Step 9: Matching Worker -> Kafka waitlist.matched -->
  <circle cx="720" cy="320" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="720" y="324" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">9</text>
  <!-- Step 10: Kafka -> Notification Dispatcher -->
  <circle cx="750" cy="360" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="750" y="364" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">10</text>

  <!-- ======= LEGEND ======= -->
  <g transform="translate(840,490)">
    <rect x="0" y="0" width="230" height="160" rx="10" fill="#f1f5f9" stroke="#30363d" stroke-width="1"/>
    <text x="15" y="22" fill="#fff" font-size="11" font-weight="700">LEGEND</text>
    <!-- Sync -->
    <line x1="15" y1="42" x2="55" y2="42" stroke="#9ca3af" stroke-width="1.5" marker-end="url(#at-arrowSync)"/>
    <text x="65" y="46" fill="#9ca3af" font-size="10">Synchronous call</text>
    <!-- Async -->
    <line x1="15" y1="62" x2="55" y2="62" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="6,3" marker-end="url(#at-arrowAsync)"/>
    <text x="65" y="66" fill="#9ca3af" font-size="10">Async / Event-driven</text>
    <!-- CDC -->
    <line x1="15" y1="82" x2="55" y2="82" stroke="#f59e0b" stroke-width="1.5" marker-end="url(#at-arrowCDC)"/>
    <text x="65" y="86" fill="#9ca3af" font-size="10">CDC (Debezium WAL)</text>
    <!-- DB -->
    <ellipse cx="25" cy="102" rx="10" ry="5" fill="#428BF9"/>
    <text x="65" y="106" fill="#9ca3af" font-size="10">Database (PostgreSQL)</text>
    <!-- Redis -->
    <polygon points="25,117 35,124 25,131 15,124" fill="#ef4444" opacity="0.7"/>
    <text x="65" y="127" fill="#9ca3af" font-size="10">Cache (Redis)</text>
    <!-- External -->
    <rect x="12" y="135" width="26" height="15" rx="3" fill="none" stroke="#FC642D" stroke-width="1.2" stroke-dasharray="3,2"/>
    <text x="65" y="147" fill="#9ca3af" font-size="10">External service</text>
  </g>
</svg>
  </div>

  <!-- ===== REQUEST FLOW REFERENCE ===== -->
  <h3>Request Flow Reference</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th style="width:5%;">Step</th>
          <th style="width:22%;">From &rarr; To</th>
          <th style="width:13%;">Protocol</th>
          <th style="width:60%;">What Happens</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>1</strong></td>
          <td><strong>Client &rarr; API Gateway</strong></td>
          <td>HTTPS</td>
          <td>Guest submits an &ldquo;add to waitlist&rdquo; request for a listing + date range</td>
        </tr>
        <tr>
          <td><strong>2</strong></td>
          <td><strong>API Gateway &rarr; Waitlist Service</strong></td>
          <td>gRPC</td>
          <td>Gateway authenticates, rate-limits, then forwards to Waitlist Service which validates and creates the entry</td>
        </tr>
        <tr>
          <td><strong>3</strong></td>
          <td><strong>Waitlist Service &rarr; PostgreSQL</strong></td>
          <td>TCP</td>
          <td><code>INSERT INTO waitlist_entries</code> &mdash; persists the new waitlist entry with status <code>active</code></td>
        </tr>
        <tr>
          <td><strong>4</strong></td>
          <td><strong>Waitlist Service &rarr; Redis</strong></td>
          <td>TCP</td>
          <td>Updates the active waitlist cache (per-listing sorted set) so the matching worker has a hot path</td>
        </tr>
        <tr>
          <td><strong>5</strong></td>
          <td><strong>Booking DB &rarr; Debezium CDC</strong></td>
          <td>WAL read</td>
          <td>Debezium tails the Booking DB write-ahead log, capturing any availability change (cancellation, modification, host unblock)</td>
        </tr>
        <tr>
          <td><strong>6</strong></td>
          <td><strong>Debezium &rarr; Kafka <code>availability.changes</code></strong></td>
          <td>CDC event</td>
          <td>Publishes a structured CDC event containing listing_id, old/new date ranges, and change type</td>
        </tr>
        <tr>
          <td><strong>7</strong></td>
          <td><strong>Kafka &rarr; Matching Worker</strong></td>
          <td>Consumer</td>
          <td>Matching Worker consumes <code>availability.changes</code>, determines which waitlist entries overlap the newly-available dates</td>
        </tr>
        <tr>
          <td><strong>8</strong></td>
          <td><strong>Matching Worker &rarr; PostgreSQL</strong></td>
          <td>TCP</td>
          <td>Queries <code>waitlist_entries</code> for active entries matching the listing + overlapping date range</td>
        </tr>
        <tr>
          <td><strong>9</strong></td>
          <td><strong>Matching Worker &rarr; Kafka <code>waitlist.matched</code></strong></td>
          <td>Producer</td>
          <td>Produces one event per matched waitlist entry into the <code>waitlist.matched</code> topic for downstream notification</td>
        </tr>
        <tr>
          <td><strong>10</strong></td>
          <td><strong>Kafka &rarr; Notification Dispatcher</strong></td>
          <td>Consumer</td>
          <td>Dispatcher consumes matched events, applies staggering/dedup window, then triggers push notification or email via Notification Svc</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ===== FAILURE PATHS ===== -->
  <h3>Failure Paths</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th style="width:22%;">Failure</th>
          <th style="width:38%;">Impact</th>
          <th style="width:40%;">Mitigation</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>CDC Lag</strong></td>
          <td>Debezium falls behind the WAL &mdash; availability changes are captured late, delaying notifications beyond the 5-min SLA</td>
          <td>Monitor replication slot lag with alerting at 30s. Debezium supports parallel snapshotting; scale connectors horizontally. Fallback: polling query on <code>reservations</code> table as a secondary trigger.</td>
        </tr>
        <tr>
          <td><strong>Kafka Down</strong></td>
          <td>Notifications are delayed but <strong>not lost</strong> &mdash; CDC events queue in the WAL until Kafka recovers; matched events remain in the topic</td>
          <td>Multi-AZ Kafka cluster with ISR &ge; 2. Producer retries with idempotent writes. Consumer offsets committed only after successful processing. Dead-letter topic for poison pills.</td>
        </tr>
        <tr>
          <td><strong>Matching False Positive</strong></td>
          <td>Worker matches a waitlist entry whose dates don&rsquo;t actually overlap (e.g., edge case with timezone or partial-day bookings), causing a user to receive a notification for unavailable dates</td>
          <td>Double-check availability via a synchronous call to Booking Service before producing the matched event. Use <code>[check_in, check_out)</code> half-open intervals consistently. Include a &ldquo;still available?&rdquo; check on the booking page itself.</td>
        </tr>
        <tr>
          <td><strong>Thundering Herd</strong></td>
          <td>A popular listing frees up and 500+ waitlist entries match simultaneously &mdash; all users rush to book, overwhelming the Booking Service</td>
          <td>Notification Dispatcher applies a stagger window (e.g., notify top-10 first, wait 60s, then next batch). Priority ordering by waitlist position. Use a distributed lock or token-bucket to cap concurrent booking attempts per listing.</td>
        </tr>
        <tr>
          <td><strong>Notification Delivery Failure</strong></td>
          <td>Push notification or email fails to deliver &mdash; user misses the availability window and the dates get booked by someone else</td>
          <td>Multi-channel delivery (push + email + in-app). Retry with exponential backoff (3 attempts over 10 min). Persist notification status in DB for audit. Extend the &ldquo;hold&rdquo; window for matched users if supported.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h3>Data Flow: Cancellation to Notification</h3>
  <div class="flow-steps">
    <div class="flow-step">
      <div class="flow-step-num">1</div>
      <div class="flow-step-content">
        <strong>Booking cancelled</strong>
        <p>Guest or host cancels a reservation. Booking Service updates <code>reservations</code> table, setting <code>status = 'cancelled'</code>.</p>
      </div>
    </div>
    <div class="flow-step">
      <div class="flow-step-num">2</div>
      <div class="flow-step-content">
        <strong>CDC captures change</strong>
        <p>Debezium connector on the Booking DB WAL detects the row change and publishes an <code>availability.changes</code> event to Kafka with <code>{listing_id, freed_dates, event_type: 'cancellation'}</code>.</p>
      </div>
    </div>
    <div class="flow-step">
      <div class="flow-step-num">3</div>
      <div class="flow-step-content">
        <strong>Matching Worker processes event</strong>
        <p>Consumer picks up the event, queries <code>waitlist_entries</code> for all entries where <code>listing_id</code> matches AND <code>[desired_checkin, desired_checkout]</code> overlaps with <code>freed_dates</code>. Results sorted by <code>(priority_tier ASC, created_at ASC)</code>.</p>
      </div>
    </div>
    <div class="flow-step">
      <div class="flow-step-num">4</div>
      <div class="flow-step-content">
        <strong>Notification Dispatcher staggers delivery</strong>
        <p>Top-priority user gets a 15-minute exclusive booking window. Next batch notified after window expires (or if first user doesn't book). Dedup check ensures no repeat notifications for same availability event.</p>
      </div>
    </div>
    <div class="flow-step">
      <div class="flow-step-num">5</div>
      <div class="flow-step-content">
        <strong>Guest receives notification</strong>
        <p>Push notification, email, or SMS delivered via existing Notification Service. Deep link takes guest directly to the listing page with dates pre-filled.</p>
      </div>
    </div>
  </div>
</details>
</section>

<!-- ============================================================ -->
<!--  5. API DESIGN                                                -->
<!-- ============================================================ -->
<section class="section" id="api">
<details>
  <summary>
  <span class="section-label">Section 5</span>
  <h2>API Design</h2>
  </summary>

  <h3>Waitlist CRUD Endpoints</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Method</th>
          <th>Endpoint</th>
          <th>Description</th>
          <th>Auth</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><span class="badge badge-green" style="font-size:0.72em;">POST</span></td>
          <td><code>/v1/waitlist</code></td>
          <td>Add guest to waitlist for a listing + date range</td>
          <td>Bearer token (guest)</td>
        </tr>
        <tr>
          <td><span class="badge badge-red" style="font-size:0.72em;">DELETE</span></td>
          <td><code>/v1/waitlist/{entry_id}</code></td>
          <td>Remove a specific waitlist entry</td>
          <td>Bearer token (owner)</td>
        </tr>
        <tr>
          <td><span class="badge badge-blue" style="font-size:0.72em;">GET</span></td>
          <td><code>/v1/waitlist/me</code></td>
          <td>List all active waitlist entries for current user</td>
          <td>Bearer token (guest)</td>
        </tr>
        <tr>
          <td><span class="badge badge-blue" style="font-size:0.72em;">GET</span></td>
          <td><code>/v1/waitlist/{entry_id}</code></td>
          <td>Get details of a specific waitlist entry</td>
          <td>Bearer token (owner)</td>
        </tr>
        <tr>
          <td><span class="badge badge-purple" style="font-size:0.72em;">GET</span></td>
          <td><code>/v1/listings/{id}/waitlist/count</code></td>
          <td>Get waitlist count for a listing (for UI badge)</td>
          <td>Public (cached)</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h3>POST /v1/waitlist</h3>
  <pre><code><span class="cm">// Headers: Idempotency-Key: &lt;uuid&gt;</span>
<span class="kw">Request:</span>
{ <span class="str">"listing_id"</span>: <span class="str">"lst_8f3a2b1c"</span>, <span class="str">"desired_checkin"</span>: <span class="str">"2025-08-15"</span>,
  <span class="str">"desired_checkout"</span>: <span class="str">"2025-08-20"</span>, <span class="str">"flexibility_days"</span>: <span class="num">2</span> }

<span class="kw">Response:</span> <span class="num">201</span>
{ <span class="str">"entry_id"</span>: <span class="str">"wl_9d4e5f6a"</span>, <span class="str">"position"</span>: <span class="num">12</span>, <span class="str">"status"</span>: <span class="str">"active"</span>,
  <span class="str">"expires_at"</span>: <span class="str">"2025-08-15T00:00:00Z"</span> }</code></pre>
</details>
</section>

<!-- ============================================================ -->
<!--  6. DATA MODEL                                                -->
<!-- ============================================================ -->
<section class="section" id="data-model">
<details>
  <summary>
  <span class="section-label">Section 6</span>
  <h2>Data Model</h2>
  </summary>

  <h3>Core Tables</h3>
  <div class="er-grid">
    <div class="er-table" style="border-top: 3px solid var(--primary);">
      <div class="er-header" style="color: var(--primary);">waitlist_entries</div>
      <div class="er-row"><span class="er-col er-pk">entry_id</span><span class="er-type">UUID PK</span></div>
      <div class="er-row"><span class="er-col er-fk">user_id</span><span class="er-type">UUID FK</span></div>
      <div class="er-row"><span class="er-col er-fk">listing_id</span><span class="er-type">UUID FK</span></div>
      <div class="er-row"><span class="er-col">desired_checkin / checkout</span><span class="er-type">DATE</span></div>
      <div class="er-row"><span class="er-col">effective_checkin / checkout</span><span class="er-type">DATE (with flexibility)</span></div>
      <div class="er-row"><span class="er-col">priority_tier</span><span class="er-type">SMALLINT (0=super, 2=std)</span></div>
      <div class="er-row"><span class="er-col">status</span><span class="er-type">ENUM(active, notified, booked, expired, cancelled)</span></div>
      <div class="er-row"><span class="er-col">idempotency_key</span><span class="er-type">VARCHAR(64) UNIQUE</span></div>
      <div class="er-row"><span class="er-col">expires_at</span><span class="er-type">TIMESTAMPTZ</span></div>
    </div>

    <div class="er-table" style="border-top: 3px solid var(--purple);">
      <div class="er-header" style="color: var(--purple);">availability_events (append-only)</div>
      <div class="er-row"><span class="er-col er-pk">event_id</span><span class="er-type">UUID PK</span></div>
      <div class="er-row"><span class="er-col er-fk">listing_id</span><span class="er-type">UUID</span></div>
      <div class="er-row"><span class="er-col">event_type</span><span class="er-type">ENUM(cancellation, host_unblock)</span></div>
      <div class="er-row"><span class="er-col">freed_checkin / checkout</span><span class="er-type">DATE</span></div>
      <div class="er-row"><span class="er-col">processed</span><span class="er-type">BOOLEAN</span></div>
    </div>
  </div>

  <h3>Key Indexes</h3>
  <ul>
    <li><strong>Partial composite</strong> on <code>waitlist_entries(listing_id, effective_checkin, effective_checkout)</code> WHERE active &mdash; date overlap matching hot path</li>
    <li><strong>UNIQUE partial</strong> on <code>(user_id, listing_id, desired_checkin, desired_checkout)</code> WHERE active &mdash; duplicate prevention</li>
    <li><strong>Partial</strong> on <code>(expires_at)</code> WHERE active &mdash; TTL garbage collection</li>
  </ul>

  <h3>Date Overlap Matching (Pseudocode)</h3>
<pre><code>FIND_MATCHING_WAITLIST(listing_id, freed_checkin, freed_checkout):

  SELECT FROM waitlist_entries
  WHERE listing_id = :listing_id
    AND status = 'active'
    AND effective_checkin  &lt; :freed_checkout    &larr; overlap condition
    AND effective_checkout &gt; :freed_checkin     &larr; overlap condition
  ORDER BY priority_tier ASC, created_at ASC    &larr; superguest first, then FIFO</code></pre>

</details>
</section>

<!-- ============================================================ -->
<!--  7. MATCHING ALGORITHM                                        -->
<!-- ============================================================ -->
<section class="section" id="matching">
<details>
  <summary>
  <span class="section-label">Section 7</span>
  <h2>Matching Algorithm</h2>
  </summary>

  <h3>Date Range Overlap Detection</h3>
  <p>Two date ranges <code>[A_start, A_end)</code> and <code>[B_start, B_end)</code> overlap if and only if:</p>
  <pre><code><span class="var">A_start</span> < <span class="var">B_end</span>  <span class="kw">AND</span>  <span class="var">A_end</span> > <span class="var">B_start</span></code></pre>
  <p>With the <code>flexibility_days</code> feature, we expand the guest's range before comparison:</p>
  <pre><code><span class="var">effective_checkin</span>  = <span class="var">desired_checkin</span>  - <span class="var">flexibility_days</span>
<span class="var">effective_checkout</span> = <span class="var">desired_checkout</span> + <span class="var">flexibility_days</span></code></pre>

  <div class="card" style="border-top: 3px solid var(--purple);">
    <h4 style="color: var(--purple);">Overlap Scenarios Visualized</h4>
    <pre style="font-size:0.82em; background: transparent; border: none; padding: 10px 0;"><code>
<span style="color:var(--primary);">Freed dates:         |=======|               Aug 15 - Aug 20</span>

<span style="color:var(--success);">Match (full):        |=======|               Aug 15 - Aug 20  MATCH</span>
<span style="color:var(--success);">Match (overlap L):  |====|                   Aug 13 - Aug 18  MATCH</span>
<span style="color:var(--success);">Match (overlap R):       |=======|           Aug 17 - Aug 23  MATCH</span>
<span style="color:var(--success);">Match (superset):   |============|           Aug 13 - Aug 23  MATCH</span>
<span style="color:var(--success);">Match (subset):        |===|                 Aug 16 - Aug 19  MATCH</span>

<span style="color:var(--danger);">No match (before): |==|                      Aug 10 - Aug 14  NO MATCH</span>
<span style="color:var(--danger);">No match (after):              |====|         Aug 21 - Aug 25  NO MATCH</span>
<span style="color:var(--danger);">No match (adj):    |===|                     Aug 12 - Aug 15  NO MATCH (boundary)</span>
    </code></pre>
  </div>

  <h3>Batch vs. Real-Time Matching</h3>
  <div class="compare-grid">
    <div class="compare-card option-a">
      <h4 style="color: var(--blue);">Real-Time (Chosen)</h4>
      <ul>
        <li><strong>Trigger:</strong> Each availability change event processed immediately by Kafka consumer</li>
        <li><strong>Latency:</strong> Seconds from event to match list</li>
        <li><strong>Pros:</strong> Meets &lt;5 min SLA easily, fresh results</li>
        <li><strong>Cons:</strong> Bursty load on DB during peak cancellations</li>
        <li><strong>Mitigation:</strong> Read replicas + connection pooling + query result caching for hot listings</li>
      </ul>
    </div>
    <div class="compare-card option-b">
      <h4 style="color: #1e293b;">Micro-Batch (Alternative)</h4>
      <ul>
        <li><strong>Trigger:</strong> Every 30-60 seconds, batch process accumulated events</li>
        <li><strong>Latency:</strong> 30-90 seconds from event to match list</li>
        <li><strong>Pros:</strong> Smoother DB load, can coalesce multiple events for same listing</li>
        <li><strong>Cons:</strong> Added complexity, marginally higher latency</li>
        <li><strong>When to use:</strong> If DB becomes bottleneck at 10x scale</li>
      </ul>
    </div>
  </div>

  <h3>Priority Scoring</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Tier</th>
          <th>Priority Value</th>
          <th>Criteria</th>
          <th>Exclusive Window</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><span class="priority-tag p0">P0 - SUPERGUEST</span></td>
          <td><strong>0</strong></td>
          <td>Airbnb Plus / Superguest status, 10+ stays</td>
          <td>15 minutes</td>
        </tr>
        <tr>
          <td><span class="priority-tag p1">P1 - REPEAT</span></td>
          <td><strong>1</strong></td>
          <td>Previously stayed at this listing or with this host</td>
          <td>10 minutes</td>
        </tr>
        <tr>
          <td><span class="priority-tag p2">P2 - VERIFIED</span></td>
          <td><strong>2</strong></td>
          <td>ID verified, good review history</td>
          <td>5 minutes</td>
        </tr>
        <tr>
          <td><span class="priority-tag p3">P3 - STANDARD</span></td>
          <td><strong>3</strong></td>
          <td>All other users</td>
          <td>0 (batch notification)</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="callout purple">
    <strong>Matching Worker Pseudocode</strong>
    <pre style="background: transparent; border: none; padding: 8px 0; font-size: 0.88em;"><code><span class="kw">def</span> <span class="fn">process_availability_event</span>(event):
    listing_id = event.listing_id
    freed_range = (event.freed_checkin, event.freed_checkout)

    <span class="cm"># 1. Query overlapping waitlist entries</span>
    matches = db.query(<span class="str">"""
        SELECT * FROM waitlist_entries
        WHERE listing_id = %s
          AND status = 'active'
          AND effective_checkin  < %s
          AND effective_checkout > %s
        ORDER BY priority_tier ASC, created_at ASC
    """</span>, [listing_id, freed_range[1], freed_range[0]])

    <span class="cm"># 2. Group by priority tier</span>
    tiers = group_by(matches, <span class="kw">key</span>=<span class="kw">lambda</span> m: m.priority_tier)

    <span class="cm"># 3. Publish to notification topic with stagger metadata</span>
    <span class="kw">for</span> tier, entries <span class="kw">in</span> sorted(tiers.items()):
        kafka.produce(<span class="str">"waitlist.matched"</span>, {
            <span class="str">"event_id"</span>:      event.event_id,
            <span class="str">"listing_id"</span>:    listing_id,
            <span class="str">"freed_range"</span>:   freed_range,
            <span class="str">"tier"</span>:          tier,
            <span class="str">"entry_ids"</span>:     [e.entry_id <span class="kw">for</span> e <span class="kw">in</span> entries],
            <span class="str">"exclusive_window_minutes"</span>: TIER_WINDOWS[tier],
        })</code></pre>
  </div>
</details>
</section>

<!-- ============================================================ -->
<!--  8. NOTIFICATION STRATEGY                                     -->
<!-- ============================================================ -->
<section class="section" id="notification">
<details>
  <summary>
  <span class="section-label">Section 8</span>
  <h2>Notification Strategy</h2>
  </summary>

  <h3>The Thundering Herd Problem</h3>
  <div class="card" style="border-top: 3px solid var(--danger);">
    <h4 style="color: var(--danger);">The Problem</h4>
    <p>A popular beachfront villa in Malibu gets cancelled for Labor Day weekend. There are <strong>800 users</strong> on the waitlist. If we notify all 800 simultaneously:</p>
    <ul>
      <li>800 users rush to book &rarr; 799 get an error &rarr; terrible UX</li>
      <li>Booking service gets hammered with 800 concurrent booking attempts</li>
      <li>Users feel the notification was useless ("I got there in 10 seconds and it was gone!")</li>
      <li>Creates a negative feedback loop where users stop trusting waitlist notifications</li>
    </ul>
  </div>

  <h3>Solution: Tiered Exclusive Booking Windows</h3>
  <div class="flow-steps">
    <div class="flow-step">
      <div class="flow-step-num" style="background: linear-gradient(135deg, var(--danger), var(--primary));">1</div>
      <div class="flow-step-content">
        <strong>T+0 min: Notify P0 (Superguests) &mdash; 1-3 users</strong>
        <p>Highest-priority user gets an exclusive 15-minute booking window. Notification says "You have 15 minutes to book before others are notified." Only 1-3 users notified at this tier.</p>
      </div>
    </div>
    <div class="flow-step">
      <div class="flow-step-num" style="background: linear-gradient(135deg, var(--accent), var(--warning));">2</div>
      <div class="flow-step-content">
        <strong>T+15 min: If not booked, notify P1 (Repeat guests) &mdash; ~10 users</strong>
        <p>Check if availability is still open. If yes, notify next tier with 10-minute window. If P0 user booked it, stop.</p>
      </div>
    </div>
    <div class="flow-step">
      <div class="flow-step-num" style="background: linear-gradient(135deg, var(--warning), var(--success));">3</div>
      <div class="flow-step-content">
        <strong>T+25 min: If not booked, notify P2 (Verified) &mdash; ~50 users</strong>
        <p>Wider batch with 5-minute window. Message says "Dates just opened up &mdash; book now!"</p>
      </div>
    </div>
    <div class="flow-step">
      <div class="flow-step-num" style="background: linear-gradient(135deg, var(--blue), var(--purple));">4</div>
      <div class="flow-step-content">
        <strong>T+30 min: Notify all remaining P3 (Standard) &mdash; ~700+ users</strong>
        <p>Open notification. No exclusive window. First-come-first-served at this point.</p>
      </div>
    </div>
  </div>

  <h3>Fairness: FIFO vs. Tier Priority</h3>
  <div class="compare-grid">
    <div class="compare-card option-a">
      <h4 style="color: var(--blue);">Pure FIFO</h4>
      <ul>
        <li><strong>Logic:</strong> First to join waitlist = first to be notified</li>
        <li><strong>Pro:</strong> Perceived as "fair" by users</li>
        <li><strong>Pro:</strong> Simple implementation</li>
        <li><strong>Con:</strong> No incentive for loyalty program</li>
        <li><strong>Con:</strong> High-value guests treated same as new accounts</li>
      </ul>
    </div>
    <div class="compare-card option-b">
      <h4 style="color: #1e293b;">Tier + FIFO (Chosen)</h4>
      <ul>
        <li><strong>Logic:</strong> Sort by tier first, then FIFO within each tier</li>
        <li><strong>Pro:</strong> Rewards loyalty (Superguest perks)</li>
        <li><strong>Pro:</strong> Higher conversion rate (verified guests more likely to book)</li>
        <li><strong>Con:</strong> Slightly less "fair" for new users</li>
        <li><strong>Mitigation:</strong> New users see their tier and how to upgrade</li>
      </ul>
    </div>
  </div>

  <h3>Notification Deduplication</h3>
  <pre><code><span class="cm">-- Before sending, check if we already sent for this event+entry combo</span>
<span class="kw">INSERT INTO</span> waitlist_notifications (notification_id, entry_id, availability_event_id, channel, status)
<span class="kw">VALUES</span> (<span class="var">:id</span>, <span class="var">:entry_id</span>, <span class="var">:event_id</span>, <span class="var">:channel</span>, <span class="str">'pending'</span>)
<span class="kw">ON CONFLICT</span> (entry_id, availability_event_id)
<span class="kw">DO NOTHING</span>;

<span class="cm">-- If insert succeeded (rows affected = 1), proceed to send</span>
<span class="cm">-- If conflict (rows affected = 0), skip - already sent</span></code></pre>

  <div class="callout warning">
    <strong>Edge Case: Re-cancellation</strong>
    <p>User A gets notified, books the listing. Then User A cancels again. The system must fire a <em>new</em> availability event with a new <code>event_id</code>, which re-triggers the matching pipeline. The dedup is per <code>(entry_id, event_id)</code>, so users who were previously notified for the first cancellation can be notified again for this new one.</p>
  </div>
</details>
</section>

<!-- ============================================================ -->
<!--  9. TRADE-OFFS                                                -->
<!-- ============================================================ -->
<section class="section" id="tradeoffs">
<details>
  <summary>
  <span class="section-label">Section 9</span>
  <h2>Trade-Offs</h2>
  </summary>

  <h3>Decision Matrix</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Decision</th>
          <th>Option A</th>
          <th>Option B</th>
          <th>Choice</th>
          <th>Rationale</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Change Detection</strong></td>
          <td>Poll availability table every N seconds</td>
          <td>CDC (Debezium) on WAL</td>
          <td><span class="badge badge-green">CDC</span></td>
          <td>Lower latency, no wasted queries, decoupled from Booking Service code changes. Trade-off: CDC adds infra complexity (Debezium connector maintenance).</td>
        </tr>
        <tr>
          <td><strong>Waitlist Storage</strong></td>
          <td>Redis sorted sets</td>
          <td>PostgreSQL with indexes</td>
          <td><span class="badge badge-blue">PostgreSQL</span></td>
          <td>Date-range overlap queries are awkward in Redis. PG handles this natively. 50M rows at 15GB fits easily. Redis used as cache layer only.</td>
        </tr>
        <tr>
          <td><strong>Matching Mode</strong></td>
          <td>Batch every 60s</td>
          <td>Real-time per event</td>
          <td><span class="badge badge-green">Real-Time</span></td>
          <td>Keeps latency well under 5-min SLA. Volume is only ~6 events/sec steady state. Micro-batch reserved as fallback if DB load spikes.</td>
        </tr>
        <tr>
          <td><strong>Notification Strategy</strong></td>
          <td>Exclusive window (staggered tiers)</td>
          <td>Open race (notify all at once)</td>
          <td><span class="badge badge-purple">Exclusive Window</span></td>
          <td>Better UX, higher conversion, prevents thundering herd on Booking Service. Trade-off: adds ~30 min total latency for lowest-tier users.</td>
        </tr>
        <tr>
          <td><strong>Event Bus</strong></td>
          <td>Kafka</td>
          <td>SQS + SNS</td>
          <td><span class="badge badge-red">Kafka</span></td>
          <td>Kafka provides ordering guarantees per partition (key by listing_id), replay capability for debugging, and integrates natively with Debezium CDC.</td>
        </tr>
        <tr>
          <td><strong>Expiry Handling</strong></td>
          <td>Cron job sweeps expired entries</td>
          <td>Lazy expiry on read + periodic GC</td>
          <td><span class="badge badge-orange">Lazy + GC</span></td>
          <td>Lazy expiry avoids querying expired entries in matching. Background GC job cleans up every hour to keep indexes lean.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h3>Trade-Off Deep Dive: Exclusive Window vs. Open Race</h3>
  <div class="card-grid">
    <div class="card" style="border-top: 3px solid var(--purple);">
      <h4 style="color: var(--purple);">Exclusive Window (Chosen)</h4>
      <p><strong>Pros:</strong></p>
      <ul>
        <li>Highest-priority user almost guaranteed to book &rarr; ~70% conversion for P0</li>
        <li>Booking Service sees 1 request instead of 800 concurrent</li>
        <li>Users feel the notification is valuable ("I had time to book!")</li>
      </ul>
      <p><strong>Cons:</strong></p>
      <ul>
        <li>P3 users wait up to ~30 min after availability opens</li>
        <li>If P0 user doesn't respond, dates sit idle for 15 min</li>
        <li>More complex state machine (need to track window expiry)</li>
      </ul>
    </div>
    <div class="card" style="border-top: 3px solid var(--blue);">
      <h4 style="color: var(--blue);">Open Race (Alternative)</h4>
      <p><strong>Pros:</strong></p>
      <ul>
        <li>Lowest latency &mdash; all users notified immediately</li>
        <li>Simple implementation &mdash; no state machine</li>
        <li>Perceived as "fair" (everyone gets same chance)</li>
      </ul>
      <p><strong>Cons:</strong></p>
      <ul>
        <li>Thundering herd on Booking Service</li>
        <li>799 out of 800 users get "already booked" &rarr; terrible UX</li>
        <li>Users stop trusting notifications over time</li>
      </ul>
    </div>
  </div>

  <h3>Trade-Off Deep Dive: Waitlist Database Choice</h3>
  <p style="color: var(--text-muted); margin-bottom: 16px;">We need to store ~50M active waitlist entries with fast date-range overlap queries. Which database fits best?</p>

  <div class="card-grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));">

    <!-- Option A: PostgreSQL (Chosen) -->
    <div class="card" style="border-top: 3px solid var(--secondary); position: relative;">
      <div style="position: absolute; top: 12px; right: 16px;">
        <span class="badge badge-green" style="font-size: 0.7em;">&#10003; CHOSEN</span>
      </div>
      <h4 style="color: var(--secondary);">A. PostgreSQL</h4>
      <p><strong>Why chosen:</strong></p>
      <ul>
        <li>Native support for range-overlap queries via <code>GiST</code> indexes &mdash; <code>WHERE [checkin, checkout] &amp;&amp; [freed_start, freed_end]</code></li>
        <li>50M rows &times; ~300 bytes &asymp; <strong>15 GB</strong> &mdash; fits comfortably on a single instance with replicas</li>
        <li>ACID transactions for duplicate prevention (unique partial index on active entries)</li>
        <li>Strong ecosystem: Debezium CDC connector, mature tooling, Airbnb already operates PG clusters</li>
        <li>Composite B-tree indexes on <code>(listing_id, checkin, checkout)</code> give &lt;5ms read latency</li>
      </ul>
      <p style="margin-top: 10px;"><strong>Trade-off:</strong> Vertical scaling ceiling; if entries grow past 500M, requires sharding by <code>listing_id</code> (adds operational complexity).</p>
    </div>

    <!-- Option B: DynamoDB -->
    <div class="card" style="border-top: 3px solid var(--blue);">
      <h4 style="color: var(--blue);">B. DynamoDB</h4>
      <p><strong>Why not:</strong></p>
      <ul>
        <li>No native range-overlap query &mdash; have to scan all entries for a listing and filter in-app, or maintain GSIs that approximate date bucketing</li>
        <li>Hot partition problem: popular listings concentrate all writes on one partition key</li>
        <li>On-demand pricing at 50M items + burst reads gets expensive fast (~$1,200/mo vs ~$300/mo for PG)</li>
      </ul>
      <p style="margin-top: 10px;"><strong>When it would win:</strong> If entries were &gt;500M and queries were purely key-value (no range overlap). Great for the notification delivery log where access is by <code>entry_id</code>.</p>
    </div>

    <!-- Option C: Redis (Sorted Sets) -->
    <div class="card" style="border-top: 3px solid var(--danger);">
      <h4 style="color: var(--danger);">C. Redis Sorted Sets</h4>
      <p><strong>Why not (as primary):</strong></p>
      <ul>
        <li>Date-range overlap is awkward &mdash; requires encoding checkin/checkout as score ranges and doing two <code>ZRANGEBYSCORE</code> calls + intersection</li>
        <li>50M entries &times; ~500 bytes (with member metadata) &asymp; <strong>25 GB RAM</strong> &mdash; expensive to keep entirely in memory</li>
        <li>No durable transactions for duplicate prevention; crash risks data loss (AOF/RDB lag)</li>
      </ul>
      <p style="margin-top: 10px;"><strong>Where we do use it:</strong> As a <em>cache layer</em> in front of PG &mdash; per-listing sorted sets keyed by <code>listing:{id}:waitlist</code> give O(log N) lookups for the matching worker&rsquo;s hot path.</p>
    </div>

    <!-- Option D: Cassandra -->
    <div class="card" style="border-top: 3px solid var(--purple);">
      <h4 style="color: var(--purple);">D. Cassandra</h4>
      <p><strong>Why not:</strong></p>
      <ul>
        <li>Excellent write throughput, but our write rate is only ~23/s (not write-heavy enough to justify Cassandra&rsquo;s operational overhead)</li>
        <li>Range queries require careful partition design; overlap queries across two date columns are not supported natively</li>
        <li>Eventually consistent reads by default &mdash; problematic for duplicate prevention (two users could both appear to &ldquo;not exist&rdquo; and both insert)</li>
      </ul>
      <p style="margin-top: 10px;"><strong>When it would win:</strong> If the system had 100K+ writes/sec (e.g., tracking every search/view, not just explicit waitlist joins) and could tolerate eventual consistency.</p>
    </div>
  </div>

  <div class="card" style="border-left: 4px solid var(--secondary); margin-top: 16px;">
    <h4 style="color: var(--secondary); margin-top: 0;">Summary: Why PostgreSQL?</h4>
    <p style="color: var(--text-muted);">The deciding factors are <strong>(1)</strong> native date-range overlap query support, <strong>(2)</strong> modest data volume (15 GB), and <strong>(3)</strong> low write QPS (23/s). PostgreSQL handles all three effortlessly without the operational complexity of distributed databases. We use Redis as a cache and Kafka + CDC for the async pipeline &mdash; each technology where it excels, rather than forcing one tool to do everything.</p>
  </div>

</details>
</section>

<!-- ============================================================ -->
<!--  10. DEEP DIVES                                               -->
<!-- ============================================================ -->
<section class="section" id="deep-dives">
<details>
  <summary>
  <span class="section-label">Section 10</span>
  <h2>Deep Dives</h2>
  </summary>

  <h3>1. CDC Pipeline (Debezium)</h3>
  <div class="card" style="border-left: 4px solid var(--secondary);">
    <h4 style="color: #1e293b;">How CDC Captures Availability Changes</h4>
    <div class="arch-diagram" style="font-size:0.76em;">
<span style="color:var(--blue);">Booking DB (PostgreSQL)</span>
        |
        | WAL (Write-Ahead Log)
        v
+------------------+        +------------------+        +------------------+
| <span style="color:var(--secondary);">Debezium</span>         |------->| <span style="color:var(--primary);">Kafka</span>            |------->| <span style="color:var(--blue);">Matching Worker</span>  |
| Connector        |        | availability.    |        |                  |
| - Monitors WAL   |        | changes topic    |        | - Filters events |
| - Filters tables |        | - Partitioned by |        | - Queries PG     |
| - Transforms     |        |   listing_id     |        | - Publishes      |
|   to events      |        |                  |        |   matched entries|
+------------------+        +------------------+        +------------------+
    </div>
    <p><strong>Key configuration:</strong></p>
    <ul>
      <li><strong>Tables monitored:</strong> <code>reservations</code> (status changes), <code>calendar_blocks</code> (host manual blocks/unblocks)</li>
      <li><strong>Transforms:</strong> Filter to only <code>status</code> changes that free up dates (cancellation, modification shortening stay). Ignore new bookings.</li>
      <li><strong>Partitioning:</strong> Kafka topic partitioned by <code>listing_id</code> to ensure ordering per listing</li>
      <li><strong>Exactly-once:</strong> Debezium uses PostgreSQL logical replication slots &mdash; WAL is not recycled until confirmed consumed</li>
    </ul>
  </div>

  <h3>2. Redis Caching Layer</h3>
  <div class="card" style="border-left: 4px solid var(--primary);">
    <h4 style="color: var(--primary);">What We Cache (and What We Don't)</h4>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Cache Key Pattern</th>
            <th>Value</th>
            <th>TTL</th>
            <th>Purpose</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><code>wl:user:{user_id}:entries</code></td>
            <td>List of active entry_ids</td>
            <td>10 min</td>
            <td>Fast lookup for GET /v1/waitlist/me</td>
          </tr>
          <tr>
            <td><code>wl:listing:{listing_id}:count</code></td>
            <td>Integer count of active entries</td>
            <td>5 min</td>
            <td>UI badge showing "12 people waiting"</td>
          </tr>
          <tr>
            <td><code>wl:dedup:{user_id}:{listing_id}</code></td>
            <td>entry_id (if active)</td>
            <td>Matches entry TTL</td>
            <td>Fast duplicate detection on POST</td>
          </tr>
          <tr>
            <td><code>wl:window:{event_id}</code></td>
            <td>Current tier + window expiry</td>
            <td>45 min</td>
            <td>Track exclusive booking window state</td>
          </tr>
        </tbody>
      </table>
    </div>
    <p><strong>Not cached:</strong> The matching query itself (date overlap lookup) is NOT cached because availability changes invalidate results immediately. The DB query with proper indexing runs in &lt;10ms for a typical listing.</p>
  </div>

  <h3>3. Dead Letter Queue (DLQ)</h3>
  <div class="card" style="border-left: 4px solid var(--warning);">
    <h4 style="color: var(--warning);">Handling Notification Failures</h4>
    <pre><code><span class="cm">// Notification dispatch with retry + DLQ</span>
<span class="kw">async function</span> <span class="fn">dispatchNotification</span>(matched) {
  <span class="kw">const</span> MAX_RETRIES = <span class="num">3</span>;
  <span class="kw">let</span> attempt = <span class="num">0</span>;

  <span class="kw">while</span> (attempt &lt; MAX_RETRIES) {
    <span class="kw">try</span> {
      <span class="kw">await</span> notificationService.send({
        userId:    matched.userId,
        channel:   matched.channel,
        template:  <span class="str">'waitlist_availability'</span>,
        payload: {
          listingId:   matched.listingId,
          listingName: matched.listingName,
          checkin:     matched.freedCheckin,
          checkout:    matched.freedCheckout,
          deepLink:    buildBookingDeepLink(matched),
          exclusiveUntil: matched.exclusiveWindowUntil,
        }
      });
      <span class="kw">await</span> db.update(<span class="str">'waitlist_notifications'</span>,
        { status: <span class="str">'sent'</span>, sent_at: now() },
        { notification_id: matched.notificationId });
      <span class="kw">return</span>;  <span class="cm">// success</span>
    } <span class="kw">catch</span> (err) {
      attempt++;
      <span class="kw">await</span> sleep(exponentialBackoff(attempt));  <span class="cm">// 1s, 4s, 16s</span>
    }
  }

  <span class="cm">// All retries exhausted -> send to DLQ</span>
  <span class="kw">await</span> kafka.produce(<span class="str">'waitlist.notifications.dlq'</span>, {
    ...matched,
    error: <span class="str">'max_retries_exhausted'</span>,
    failedAt: now(),
  });
}</code></pre>
    <p><strong>DLQ Processing:</strong> A separate consumer monitors the DLQ. Ops team gets alerted if DLQ depth exceeds threshold. Manual replay after root cause is fixed. DLQ messages retained for 7 days.</p>
  </div>

  <h3>4. TTL Garbage Collection</h3>
  <div class="card" style="border-left: 4px solid var(--purple);">
    <h4 style="color: var(--purple);">Expiry Strategy: Lazy + Periodic GC</h4>
    <p>Two complementary mechanisms ensure stale entries don't accumulate:</p>

    <h4 style="color: var(--text); margin-top: 16px;">Lazy Expiry (on read/match)</h4>
    <pre><code><span class="cm">-- During matching, only query non-expired entries</span>
<span class="kw">SELECT</span> * <span class="kw">FROM</span> waitlist_entries
<span class="kw">WHERE</span> listing_id = <span class="var">:listing_id</span>
  <span class="kw">AND</span> status = <span class="str">'active'</span>
  <span class="kw">AND</span> expires_at > <span class="fn">NOW()</span>             <span class="cm">-- lazy expiry filter</span>
  <span class="kw">AND</span> effective_checkin  &lt; <span class="var">:freed_checkout</span>
  <span class="kw">AND</span> effective_checkout &gt; <span class="var">:freed_checkin</span>;</code></pre>

    <h4 style="color: var(--text); margin-top: 16px;">Periodic GC (background job)</h4>
    <pre><code><span class="cm">-- Runs every hour via cron / K8s CronJob</span>
<span class="cm">-- Batch update in chunks of 1000 to avoid long locks</span>
<span class="kw">UPDATE</span> waitlist_entries
<span class="kw">SET</span> status = <span class="str">'expired'</span>, updated_at = <span class="fn">NOW()</span>
<span class="kw">WHERE</span> status = <span class="str">'active'</span>
  <span class="kw">AND</span> expires_at &lt; <span class="fn">NOW()</span>
<span class="kw">LIMIT</span> <span class="num">1000</span>;

<span class="cm">-- Archive entries older than 30 days (for analytics)</span>
<span class="kw">INSERT INTO</span> waitlist_archive <span class="kw">SELECT</span> * <span class="kw">FROM</span> waitlist_entries
<span class="kw">WHERE</span> status <span class="kw">IN</span> (<span class="str">'expired'</span>, <span class="str">'cancelled'</span>, <span class="str">'booked'</span>)
  <span class="kw">AND</span> updated_at &lt; <span class="fn">NOW()</span> - <span class="kw">INTERVAL</span> <span class="str">'30 days'</span>
<span class="kw">LIMIT</span> <span class="num">5000</span>;

<span class="kw">DELETE FROM</span> waitlist_entries
<span class="kw">WHERE</span> entry_id <span class="kw">IN</span> (<span class="cm">/* archived entry_ids */</span>);</code></pre>

    <div class="callout">
      <strong>Why Not Redis TTL?</strong>
      <p>Redis TTL works great for cache eviction, but our source of truth is PostgreSQL. We need the entries to transition to <code>expired</code> status (not just disappear) because: (1) users should see "expired" in their waitlist history, (2) analytics needs the full lifecycle, (3) the GC job needs to archive before deleting.</p>
    </div>
  </div>

  <h3>5. Exclusive Window State Machine</h3>
  <div class="card" style="border-left: 4px solid var(--blue);">
    <h4 style="color: var(--blue);">Window Lifecycle</h4>
    <div class="arch-diagram" style="font-size:0.8em;">
<span style="color:var(--primary);">                  EXCLUSIVE WINDOW STATE MACHINE</span>

  Availability         Notify P0         P0 window          Notify P1
  Event arrives  -----> users      -----> expires?    -----> users
       |                  |                  |                  |
       v                  v                  v                  v
  +----------+     +----------+     +-------------+     +----------+
  | <span style="color:var(--secondary);">MATCHING</span> | --> | <span style="color:var(--warning);">TIER_0</span>   | --> | <span style="color:var(--blue);">CHECK_AVAIL</span> | --> | <span style="color:var(--warning);">TIER_1</span>   |
  +----------+     | WINDOW   |     | Still open? |     | WINDOW   |
                   | 15 min   |     +-------------+     | 10 min   |
                   +----------+       |         |       +----------+
                                     YES        NO            |
                                      |          |           ...
                                      v          v            v
                                 +----------+ +--------+ +----------+
                                 | <span style="color:var(--warning);">TIER_2</span>   | | <span style="color:var(--success);">BOOKED</span> | | <span style="color:var(--warning);">TIER_3</span>   |
                                 | WINDOW   | | (done) | | OPEN     |
                                 | 5 min    | +--------+ | RACE     |
                                 +----------+            +----------+
    </div>
    <p>The state machine is tracked in Redis with key <code>wl:window:{event_id}</code>. A delayed Kafka message (or Redis keyspace notification) triggers the tier advancement after each window expires. Before advancing to the next tier, the system re-checks availability to avoid notifying users for already-booked dates.</p>
  </div>
</details>
</section>

<!-- ============================================================ -->
<!--  11. INTERVIEW TIPS                                           -->
<!-- ============================================================ -->
<section class="section" id="interview-tips">
<details>
  <summary>
  <span class="section-label">Section 11</span>
  <h2>Interview Tips</h2>
  </summary>

  <div class="card-grid">
    <div class="card" style="border-top: 3px solid var(--secondary);">
      <h4 style="color: #1e293b;">Start With the User Story</h4>
      <p>"A guest finds their dream listing but dates are taken. They join a waitlist. When someone cancels, the guest is the first to know." This grounds the entire design in a concrete, relatable scenario. Draw the user flow on the whiteboard first before diving into components.</p>
    </div>
    <div class="card" style="border-top: 3px solid var(--primary);">
      <h4 style="color: var(--primary);">Name the Core Challenge Early</h4>
      <p>"The interesting challenge here is the thundering herd problem. When a hot listing opens up, we can't blast 800 users simultaneously." This signals to your interviewer that you see the non-obvious complexity.</p>
    </div>
    <div class="card" style="border-top: 3px solid var(--blue);">
      <h4 style="color: var(--blue);">Justify CDC Over Polling</h4>
      <p>"I'm choosing CDC because we want to decouple from the Booking Service codebase. They shouldn't need to add a webhook call to their cancellation flow just for our feature. CDC gives us real-time change detection without modifying their code." This shows systems thinking.</p>
    </div>
    <div class="card" style="border-top: 3px solid var(--purple);">
      <h4 style="color: var(--purple);">Show the Math on Scale</h4>
      <p>"50M active entries at 300 bytes each is only 15 GB &mdash; this fits in a single PostgreSQL instance. The query rate is ~6 matching queries/sec, well within PG capacity. We don't need DynamoDB or a distributed database for this scale." This demonstrates you don't over-engineer.</p>
    </div>
    <div class="card" style="border-top: 3px solid var(--accent);">
      <h4 style="color: var(--accent);">Discuss the Priority Trade-Off</h4>
      <p>"There's a fairness question: pure FIFO feels democratic but doesn't incentivize loyalty. Tier + FIFO rewards Superguests but may frustrate new users. I'd start with tier + FIFO because higher-tier users convert at higher rates, which benefits hosts." Interviewers love product-aware trade-offs.</p>
    </div>
    <div class="card" style="border-top: 3px solid var(--warning);">
      <h4 style="color: var(--warning);">Have a V2 Ready</h4>
      <p>Mention future improvements without implementing them: "For V2, I'd add (1) host opt-out per listing, (2) price-drop notifications in addition to availability, (3) ML-based urgency scoring (predict how fast this listing will re-book), (4) similar listing recommendations when the waitlisted listing stays booked."</p>
    </div>
  </div>

  <h3>Common Follow-Up Questions</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Question</th>
          <th>Key Points in Your Answer</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>"What if the CDC pipeline goes down?"</strong></td>
          <td>Debezium uses PG replication slots &mdash; WAL is preserved until consumed. On restart, it replays from where it left off. Add monitoring on consumer lag. Fallback: short-term polling of a <code>last_modified</code> column on the availability table.</td>
        </tr>
        <tr>
          <td><strong>"How do you handle a listing with 10K waitlist entries?"</strong></td>
          <td>Matching query returns all 10K, but notification is staggered across tiers. P0 gets 1-3 users, P1 ~10, P2 ~50 &mdash; most of the 10K are P3 who get batch notification only after ~30 min. If the listing is booked before P3 tier, we skip notification entirely.</td>
        </tr>
        <tr>
          <td><strong>"What if a user is on waitlist for 500 listings?"</strong></td>
          <td>Enforce a per-user limit (max 50 active entries). This prevents abuse and keeps the <code>GET /v1/waitlist/me</code> query fast. Show a clear UI message when limit is reached.</td>
        </tr>
        <tr>
          <td><strong>"How do you prevent the same user from getting spammed?"</strong></td>
          <td>Dedup by <code>(entry_id, event_id)</code> in the notifications table. Rate limit per user: max 10 waitlist notifications per hour. User can set "quiet hours" in notification preferences.</td>
        </tr>
        <tr>
          <td><strong>"What if dates are only partially freed?"</strong></td>
          <td>A 7-night reservation gets shortened to 4 nights, freeing 3 nights. The CDC event captures the exact freed range. Matching still uses date overlap &mdash; users wanting those specific 3 nights (or overlapping) will match. Users wanting the full 7 won't match (no overlap with the freed portion).</td>
        </tr>
        <tr>
          <td><strong>"How do you test this system?"</strong></td>
          <td>Integration tests: simulate cancellation in test Booking DB, verify CDC picks it up, matching runs, notification lands. Load test: synthetic 10K waitlist entries on one listing, trigger cancellation, measure end-to-end latency. Chaos test: kill Kafka broker, verify reprocessing on recovery.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h3>Time Allocation (45-min Interview)</h3>
  <div class="grid-4" style="margin-top: 16px;">
    <div class="metric-box" style="border-top: 3px solid var(--primary);">
      <div class="metric-value" style="font-size: 1.4em;">5 min</div>
      <div class="metric-label">Requirements + Scope</div>
    </div>
    <div class="metric-box" style="border-top: 3px solid var(--secondary);">
      <div class="metric-value" style="font-size: 1.4em;">5 min</div>
      <div class="metric-label">Capacity + API</div>
    </div>
    <div class="metric-box" style="border-top: 3px solid var(--blue);">
      <div class="metric-value" style="font-size: 1.4em;">15 min</div>
      <div class="metric-label">Architecture + Data</div>
    </div>
    <div class="metric-box" style="border-top: 3px solid var(--purple);">
      <div class="metric-value" style="font-size: 1.4em;">20 min</div>
      <div class="metric-label">Deep Dives + Trade-offs</div>
    </div>
  </div>

  <div class="callout purple" style="margin-top: 24px;">
    <strong>The "One Sentence" Summary</strong>
    <p>"An event-driven waitlist system that uses CDC to detect availability changes, date-range overlap matching to find interested guests, and tiered exclusive booking windows to prevent thundering herd &mdash; all built on PostgreSQL, Kafka, and Redis as a cache, handling 50M active entries with sub-5-minute notification SLA."</p>
  </div>
</details>
</section>

</div><!-- end container -->

<!-- ===== FOOTER ===== -->
<div style="text-align:center; padding: 40px 20px; border-top: 1px solid #e5e7eb; color: var(--text-muted); font-size: 0.82em;">
  <p>Airbnb System Design Series &mdash; Topic 03: Listing Availability Tracker</p>
  <p style="margin-top: 6px;"><a href="index.html" style="color: #ffffff; text-decoration: none;">Back to All Topics</a></p>
</div>

<script>
document.querySelectorAll('.toc a[href^="#"], nav a[href^="#"], .nav-bar a[href^="#"], .nav-links a[href^="#"]').forEach(function(link) {
  link.addEventListener('click', function() {
    var id = this.getAttribute('href').slice(1);
    var section = document.getElementById(id);
    if (section) { var d = section.querySelector('details'); if (d) d.open = true; }
  });
});
</script>

<script>
(function(){
  document.querySelectorAll(".diagram-box").forEach(function(box){
    var svg=box.querySelector("svg");
    if(!svg) return;
    var zoom=1, minZ=0.5, maxZ=3;
    var ctrl=document.createElement("div");
    ctrl.className="diagram-zoom-controls";
    ctrl.innerHTML='<button class="zoom-out" title="Zoom Out"></button><span class="zoom-level">100%</span><button class="zoom-in" title="Zoom In">+</button><button class="zoom-reset" title="Reset"></button><button class="zoom-fs" title="Fullscreen"></button>';
    box.insertBefore(ctrl,box.firstChild);
    var lvl=ctrl.querySelector(".zoom-level");
    function apply(){svg.style.transform="scale("+zoom+")";lvl.textContent=Math.round(zoom*100)+"%";}
    ctrl.querySelector(".zoom-in").onclick=function(){zoom=Math.min(maxZ,zoom+0.25);apply();};
    ctrl.querySelector(".zoom-out").onclick=function(){zoom=Math.max(minZ,zoom-0.25);apply();};
    ctrl.querySelector(".zoom-reset").onclick=function(){zoom=1;apply();};
    ctrl.querySelector(".zoom-fs").onclick=function(){
      box.classList.toggle("fullscreen");
      if(box.classList.contains("fullscreen")){this.textContent="";zoom=1.2;}else{this.textContent="";zoom=1;}
      apply();
    };
    box.addEventListener("wheel",function(e){
      if(e.ctrlKey){e.preventDefault();zoom=e.deltaY<0?Math.min(maxZ,zoom+0.1):Math.max(minZ,zoom-0.1);apply();}
    },{passive:false});
  });
})();
</script>

<!-- ========== NOTES & COMMENTS SYSTEM ========== -->
<div class="notes-overlay" id="notesOverlay"></div>
<button class="notes-fab" id="notesFab" title="My Notes">
  <span style="line-height:1">&#128221;</span>
  <span class="note-count" id="noteCount" style="display:none">0</span>
</button>
<div class="notes-panel" id="notesPanel">
  <div class="notes-panel-header">
    <span style="font-size:1.3em">&#128221;</span>
    <h3>My Notes &amp; Comments</h3>
    <button class="notes-close" id="notesClose" title="Close">&times;</button>
  </div>
  <div class="notes-compose">
    <select id="noteSection">
      <option value="general">General Note</option>
      <option value="Section 1">Section 1  Overview</option>
      <option value="Section 2">Section 2  Requirements</option>
      <option value="Section 3">Section 3  Capacity</option>
      <option value="Section 4">Section 4  Architecture</option>
      <option value="Section 5">Section 5  API Design</option>
      <option value="Section 6">Section 6  Data Model</option>
      <option value="Section 7">Section 7  Matching Algorithm</option>
      <option value="Section 8">Section 8  Notification Strategy</option>
      <option value="Section 9">Section 9  Trade-offs</option>
      <option value="Section 10">Section 10  Deep Dives</option>
      <option value="Section 11">Section 11  Interview Tips</option>
    </select>
    <textarea id="noteText" placeholder="Type your note, comment, or question here..."></textarea>
    <div class="notes-actions">
      <select class="tag-select" id="noteTag">
        <option value="">No tag</option>
        <option value="important">&#128308; Important</option>
        <option value="question">&#10067; Question</option>
        <option value="idea">&#128161; Idea</option>
        <option value="review">&#128270; Review Later</option>
      </select>
      <button class="notes-btn primary" id="noteAdd">Add Note</button>
      <button class="notes-btn export" id="noteExport" title="Export all notes as text">&#128228; Export</button>
    </div>
  </div>
  <div class="notes-filter" id="notesFilter">
    <button class="active" data-filter="all">All</button>
    <button data-filter="important">&#128308; Important</button>
    <button data-filter="question">&#10067; Questions</button>
    <button data-filter="idea">&#128161; Ideas</button>
    <button data-filter="review">&#128270; Review</button>
  </div>
  <div class="notes-list" id="notesList"></div>
</div>

<script>
(function(){
  var PAGE_KEY = 'notes_03_availability_tracker';
  var panel = document.getElementById('notesPanel');
  var overlay = document.getElementById('notesOverlay');
  var fab = document.getElementById('notesFab');
  var closeBtn = document.getElementById('notesClose');
  var addBtn = document.getElementById('noteAdd');
  var exportBtn = document.getElementById('noteExport');
  var textArea = document.getElementById('noteText');
  var sectionSel = document.getElementById('noteSection');
  var tagSel = document.getElementById('noteTag');
  var listEl = document.getElementById('notesList');
  var countEl = document.getElementById('noteCount');
  var filterBtns = document.querySelectorAll('#notesFilter button');
  var currentFilter = 'all';

  function load(){ try{ return JSON.parse(localStorage.getItem(PAGE_KEY)) || []; }catch(e){ return []; } }
  function save(notes){ localStorage.setItem(PAGE_KEY, JSON.stringify(notes)); }

  function timeAgo(ts){
    var d = Date.now() - ts, s=d/1000, m=s/60, h=m/60, dy=h/24;
    if(s<60) return 'just now';
    if(m<60) return Math.floor(m)+'m ago';
    if(h<24) return Math.floor(h)+'h ago';
    if(dy<7) return Math.floor(dy)+'d ago';
    return new Date(ts).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
  }

  function render(){
    var notes = load();
    var count = notes.length;
    countEl.textContent = count;
    countEl.style.display = count > 0 ? 'flex' : 'none';
    listEl.innerHTML = '';
    var filtered = currentFilter === 'all' ? notes : notes.filter(function(n){ return n.tag === currentFilter; });
    if(filtered.length === 0){
      if(currentFilter !== 'all'){
        listEl.innerHTML = '<div style="text-align:center;color:#94a3b8;padding:30px 0;font-style:italic;">No notes with this tag.</div>';
      }
      return;
    }
    filtered.sort(function(a,b){ return b.ts - a.ts; });
    filtered.forEach(function(note){
      var div = document.createElement('div');
      div.className = 'note-item';
      div.dataset.id = note.id;
      var tagHTML = note.tag ? '<span class="note-tag '+note.tag+'">'+(
        note.tag==='important'?'&#128308; Important':
        note.tag==='question'?'&#10067; Question':
        note.tag==='idea'?'&#128161; Idea':
        '&#128270; Review'
      )+'</span>' : '';
      div.innerHTML =
        '<div class="note-meta">' +
          '<span class="note-section-tag">'+note.section+'</span>' +
          tagHTML +
          '<span class="note-time">'+timeAgo(note.ts)+'</span>' +
        '</div>' +
        '<div class="note-text">'+escapeHtml(note.text)+'</div>' +
        '<textarea class="note-edit-area">'+escapeHtml(note.text)+'</textarea>' +
        '<div class="note-edit-actions">' +
          '<button class="notes-btn primary" onclick="saveEdit(\''+note.id+'\',this)" style="padding:5px 12px;font-size:0.8em;">Save</button>' +
          '<button class="notes-btn danger" onclick="cancelEdit(this)" style="padding:5px 12px;font-size:0.8em;">Cancel</button>' +
        '</div>' +
        '<button class="note-delete" title="Delete" onclick="deleteNote(\''+note.id+'\')">&times;</button>';
      div.querySelector('.note-text').addEventListener('dblclick', function(){
        div.classList.add('editing');
        div.querySelector('.note-edit-area').focus();
      });
      listEl.appendChild(div);
    });
  }

  function escapeHtml(t){
    var d=document.createElement('div'); d.textContent=t; return d.innerHTML;
  }

  window.deleteNote = function(id){
    if(!confirm('Delete this note?')) return;
    var notes = load().filter(function(n){ return n.id !== id; });
    save(notes); render();
  };
  window.saveEdit = function(id, btn){
    var item = btn.closest('.note-item');
    var newText = item.querySelector('.note-edit-area').value.trim();
    if(!newText) return;
    var notes = load().map(function(n){ if(n.id===id){ n.text=newText; n.editedAt=Date.now(); } return n; });
    save(notes); item.classList.remove('editing'); render();
  };
  window.cancelEdit = function(btn){
    btn.closest('.note-item').classList.remove('editing');
  };

  function openPanel(){ panel.classList.add('open'); overlay.classList.add('open'); render(); }
  function closePanel(){ panel.classList.remove('open'); overlay.classList.remove('open'); }

  fab.onclick = openPanel;
  closeBtn.onclick = closePanel;
  overlay.onclick = closePanel;

  addBtn.onclick = function(){
    var text = textArea.value.trim();
    if(!text) { textArea.focus(); return; }
    var notes = load();
    notes.push({
      id: 'n_'+Date.now()+'_'+Math.random().toString(36).substr(2,5),
      section: sectionSel.value,
      tag: tagSel.value,
      text: text,
      ts: Date.now()
    });
    save(notes);
    textArea.value = '';
    tagSel.value = '';
    render();
  };

  textArea.addEventListener('keydown', function(e){
    if(e.ctrlKey && e.key === 'Enter'){ addBtn.click(); }
  });

  filterBtns.forEach(function(btn){
    btn.onclick = function(){
      filterBtns.forEach(function(b){ b.classList.remove('active'); });
      btn.classList.add('active');
      currentFilter = btn.dataset.filter;
      render();
    };
  });

  exportBtn.onclick = function(){
    var notes = load();
    if(!notes.length){ alert('No notes to export.'); return; }
    notes.sort(function(a,b){ return a.ts - b.ts; });
    var text = '# Notes: Availability Tracker (Topic 03)\n';
    text += '# Exported: ' + new Date().toLocaleString() + '\n';
    text += '# Total: ' + notes.length + ' notes\n\n';
    notes.forEach(function(n,i){
      text += '---\n';
      text += '## Note ' + (i+1) + ' [' + n.section + ']';
      if(n.tag) text += ' {' + n.tag + '}';
      text += '\n';
      text += 'Date: ' + new Date(n.ts).toLocaleString() + '\n\n';
      text += n.text + '\n\n';
    });
    var blob = new Blob([text], {type:'text/plain'});
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'notes_availability_tracker_' + new Date().toISOString().slice(0,10) + '.txt';
    a.click();
  };

  // Add "Add Note" buttons next to each section header
  document.querySelectorAll('.section-label').forEach(function(label){
    var sectionName = label.textContent.trim();
    var btn = document.createElement('button');
    btn.className = 'section-note-btn';
    btn.innerHTML = '&#128221; Add Note';
    btn.title = 'Add a note for ' + sectionName;
    btn.onclick = function(e){
      e.stopPropagation();
      openPanel();
      sectionSel.value = sectionName;
      textArea.focus();
    };
    var h2 = label.nextElementSibling;
    if(h2 && h2.tagName === 'H2'){
      h2.style.display = 'inline';
      h2.insertAdjacentElement('afterend', btn);
    }
  });

  // Keyboard shortcut: press 'n' to open notes (unless typing in input)
  document.addEventListener('keydown', function(e){
    if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA'||e.target.tagName==='SELECT') return;
    if(e.key === 'n' && !e.ctrlKey && !e.metaKey){
      e.preventDefault();
      if(panel.classList.contains('open')) closePanel(); else openPanel();
    }
    if(e.key === 'Escape' && panel.classList.contains('open')) closePanel();
  });

  // Initialize count badge
  render();
})();
</script>
</body>
</html>