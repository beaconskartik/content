<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Image Ingestion Pipeline - Airbnb System Design</title>
<style>
  :root {
    --primary: #FF5A5F;
    --primary-dark: #E04850;
    --secondary: #00A699;
    --accent: #FC642D;
    --purple: #7B2FF7;
    --blue: #428BF9;
    --dark: #ffffff;
    --darker: #f1f5f9;
    --card-bg: #ffffff;
    --card-border: #e2e8f0;
    --text: #1e293b;
    --text-muted: #4b5563;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--dark);
    color: var(--text);
    line-height: 1.7;
    scroll-behavior: smooth;
  }

  /* ===== HERO ===== */
  .hero {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #6B73FF 100%);
    padding: 70px 40px 60px;
    text-align: center;
    border-bottom: 3px solid var(--accent);
    position: relative;
    overflow: hidden;
  }
  .hero::before {
    content: '';
    position: absolute;
    top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: radial-gradient(circle at 30% 50%, rgba(252,100,45,0.08) 0%, transparent 50%),
                radial-gradient(circle at 70% 50%, rgba(0,166,153,0.15) 0%, transparent 50%);
    animation: pulse 8s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
  .hero .back-link {
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: #ffffff;
    text-decoration: none;
    font-size: 0.95em;
    font-weight: 600;
    padding: 10px 24px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.4);
    background: rgba(255,255,255,0.15);
    transition: all 0.3s;
    margin-bottom: 20px;
  }
  .hero .back-link:hover {
    background: rgba(255,255,255,0.25);
    border-color: #e5e7eb;
    transform: translateX(-3px);
  }
  .hero .topic-number-hero {
    position: relative;
    display: inline-block;
    font-size: 1em;
    font-weight: 800;
    color: var(--accent);
    background: rgba(252,100,45,0.15);
    border: 1px solid rgba(252,100,45,0.3);
    padding: 4px 18px;
    border-radius: 20px;
    margin-bottom: 14px;
    letter-spacing: 1px;
  }
  .hero h1 {
    font-size: 2.8em;
    background: linear-gradient(135deg, var(--accent), var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    position: relative;
    margin-bottom: 12px;
  }
  .hero .subtitle {
    font-size: 1.25em;
    color: rgba(255,255,255,0.9);
    position: relative;
    margin-bottom: 20px;
    max-width: 700px;
    margin-left: auto;
    margin-right: auto;
  }
  .hero .stats-row {
    position: relative;
    display: flex;
    justify-content: center;
    gap: 30px;
    margin-top: 28px;
    flex-wrap: wrap;
  }
  .hero .stat-item { text-align: center; }
  .hero .stat-value {
    font-size: 2em;
    font-weight: 800;
    color: var(--accent);
  }
  .hero .stat-label {
    font-size: 0.8em;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1.5px;
  }

  /* ===== NAV ===== */
  .section-nav {
    background: #f8fafc;
    padding: 20px 40px;
    border-bottom: 1px solid var(--card-border);
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(12px);
    background: rgba(22,33,62,0.92);
  }
  .section-nav-inner {
    max-width: 1200px;
    margin: 0 auto;
  }
  .section-nav h2 {
    color: var(--accent);
    margin-bottom: 12px;
    font-size: 0.8em;
    text-transform: uppercase;
    letter-spacing: 2px;
  }
  .nav-links {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }
  .nav-links a {
    color: var(--text-muted);
    text-decoration: none;
    padding: 6px 14px;
    border-radius: 8px;
    background: var(--card-bg);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    font-size: 0.8em;
    transition: all 0.3s;
    white-space: nowrap;
  }
  .nav-links a:hover {
    color: var(--accent);
    border-color: var(--accent);
    background: rgba(252,100,45,0.1);
  }

  /* ===== CONTAINER ===== */
  .container { max-width: 1200px; margin: 0 auto; padding: 0 30px; }

  /* ===== SECTIONS ===== */
  .content-section {
    padding: 50px 0 30px;
  }
  .content-section + .content-section {
    border-top: 1px solid #e5e7eb;
  }
  .section-anchor {
    display: block;
    position: relative;
    top: -80px;
    visibility: hidden;
  }
  .section-label {
    display: inline-block;
    font-size: 0.72em;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 2px;
    padding: 4px 14px;
    border-radius: 6px;
    margin-bottom: 12px;
  }
  .label-orange { background: rgba(252,100,45,0.15); color: var(--accent); border: 1px solid rgba(252,100,45,0.3); }
  .label-green { background: rgba(16,185,129,0.1); color: var(--success); border: 1px solid rgba(255,255,255,0.4); }
  .label-blue { background: rgba(66,139,249,0.08); color: var(--blue); border: 1px solid rgba(66,139,249,0.3); }
  .label-purple { background: rgba(123,47,247,0.15); color: var(--purple); border: 1px solid rgba(123,47,247,0.3); }
  .label-red { background: rgba(255,90,95,0.15); color: var(--primary); border: 1px solid rgba(255,90,95,0.3); }
  .label-yellow { background: rgba(245,158,11,0.15); color: var(--warning); border: 1px solid rgba(245,158,11,0.3); }
  .label-success { background: rgba(16,185,129,0.15); color: var(--success); border: 1px solid rgba(16,185,129,0.3); }

  .content-section h2 {
    font-size: 1.8em;
    color: var(--text);
    margin-bottom: 20px;
    line-height: 1.3;
  }
  .content-section h3 {
    font-size: 1.25em;
    color: var(--text);
    margin: 28px 0 12px;
    padding-left: 14px;
    border-left: 3px solid var(--accent);
  }
  .content-section h4 {
    font-size: 1.05em;
    color: #ffffff;
    margin: 20px 0 8px;
  }
  .content-section p {
    color: var(--text-muted);
    margin-bottom: 14px;
    font-size: 0.95em;
  }

  /* ===== CARDS ===== */
  .card {
    background: var(--card-bg);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 14px;
    padding: 28px;
    margin-bottom: 20px;
    transition: border-color 0.3s;
  }
  .card:hover {
    border-color: rgba(252,100,45,0.3);
  }
  .card h4 {
    margin-top: 0;
  }

  .card-grid-2 {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
  }
  .card-grid-3 {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 16px;
    margin-bottom: 20px;
  }

  /* ===== LISTS ===== */
  ul, ol {
    padding-left: 24px;
    margin-bottom: 14px;
  }
  li {
    color: var(--text-muted);
    font-size: 0.93em;
    margin-bottom: 6px;
  }
  li strong {
    color: var(--text);
  }

  /* ===== CODE BLOCKS ===== */
  .code-block {
    background: #f6f8fa;
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 10px;
    padding: 22px 26px;
    margin: 16px 0 20px;
    overflow-x: auto;
    font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
    font-size: 0.85em;
    line-height: 1.65;
    color: #24292f;
    position: relative;
  }
  .code-block .code-label {
    position: absolute;
    top: 8px;
    right: 12px;
    font-size: 0.7em;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-muted);
    background: rgba(255,255,255,0.06);
    padding: 2px 10px;
    border-radius: 4px;
    font-family: 'Segoe UI', system-ui, sans-serif;
  }
  .code-block .kw { color: #cf222e; }
  .code-block .fn { color: #8250df; }
  .code-block .str { color: #0a3069; }
  .code-block .cm { color: #6e7781; }
  .code-block .ty { color: #0550ae; }
  .code-block .num { color: #f2cc60; }
  .code-block .op { color: #cf222e; }
  .code-block .param { color: #953800; }

  code {
    background: rgba(255,255,255,0.07);
    padding: 2px 8px;
    border-radius: 4px;
    font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
    font-size: 0.88em;
    color: var(--accent);
  }

  /* ===== TABLES ===== */
  .table-wrapper {
    overflow-x: auto;
    margin: 16px 0 20px;
    border-radius: 10px;
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.88em;
  }
  th {
    background: rgba(252,100,45,0.1);
    color: var(--accent);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    font-size: 0.8em;
    padding: 14px 18px;
    text-align: left;
    border-bottom: 2px solid #e5e7eb;
    white-space: nowrap;
  }
  td {
    padding: 12px 18px;
    border-bottom: 1px solid rgba(51,65,85,0.5);
    color: var(--text-muted);
    vertical-align: top;
  }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: rgba(255,255,255,0.02); }
  td code {
    font-size: 0.9em;
    color: var(--blue);
    background: rgba(66,139,249,0.08);
  }

  /* ===== BADGES ===== */
  .badge {
    display: inline-block;
    padding: 3px 12px;
    border-radius: 20px;
    font-size: 0.73em;
    font-weight: 600;
    margin: 2px 2px;
    white-space: nowrap;
  }
  .badge-red { background: rgba(255,255,255,0.15); color: #ffffff; border: 1px solid rgba(255,255,255,0.3); }
  .badge-green { background: rgba(0,166,153,0.2); color: #ffffff; border: 1px solid var(--secondary); }
  .badge-blue { background: rgba(255,255,255,0.15); color: #ffffff; border: 1px solid rgba(255,255,255,0.3); }
  .badge-purple { background: rgba(255,255,255,0.15); color: #ffffff; border: 1px solid rgba(255,255,255,0.3); }
  .badge-orange { background: rgba(255,255,255,0.15); color: #ffffff; border: 1px solid rgba(255,255,255,0.3); }
  .badge-yellow { background: rgba(245,158,11,0.2); color: var(--warning); border: 1px solid var(--warning); }

  /* ===== DIAGRAM BOX ===== */
  .diagram-box {
    background: rgba(0,0,0,0.3);
    border-radius: 12px;
    padding: 20px;
    overflow-x: auto;
    margin: 20px 0;
  }

  /* ===== FLOW DIAGRAM ===== */
  .flow-diagram {
    background: #f6f8fa;
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 12px;
    padding: 30px;
    margin: 20px 0;
    overflow-x: auto;
    font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
    font-size: 0.82em;
    line-height: 1.6;
    color: var(--text-muted);
  }
  .flow-diagram .node {
    color: var(--blue);
    font-weight: 600;
  }
  .flow-diagram .arrow-flow {
    color: var(--accent);
  }
  .flow-diagram .event {
    color: #ffffff;
  }
  .flow-diagram .storage {
    color: var(--purple);
  }
  .flow-diagram .label {
    color: var(--text-muted);
    font-style: italic;
  }

  /* ===== PIPELINE STEPS ===== */
  .pipeline {
    display: flex;
    flex-wrap: wrap;
    gap: 0;
    margin: 20px 0;
    align-items: stretch;
  }
  .pipeline-step {
    background: var(--card-bg);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 10px;
    padding: 18px 20px;
    flex: 1;
    min-width: 180px;
    position: relative;
    text-align: center;
    margin-right: 32px;
    margin-bottom: 10px;
  }
  .pipeline-step:last-child { margin-right: 0; }
  .pipeline-step::after {
    content: '\2192';
    position: absolute;
    right: -24px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--accent);
    font-size: 1.3em;
    font-weight: 700;
  }
  .pipeline-step:last-child::after { content: ''; }
  .pipeline-step .step-num {
    display: inline-block;
    width: 28px;
    height: 28px;
    line-height: 28px;
    border-radius: 50%;
    background: rgba(252,100,45,0.2);
    color: var(--accent);
    font-size: 0.8em;
    font-weight: 800;
    margin-bottom: 8px;
    border: 1px solid rgba(252,100,45,0.4);
  }
  .pipeline-step .step-title {
    display: block;
    font-weight: 700;
    font-size: 0.85em;
    color: var(--text);
    margin-bottom: 4px;
  }
  .pipeline-step .step-desc {
    font-size: 0.78em;
    color: var(--text-muted);
  }

  /* ===== CALLOUT ===== */
  .callout {
    border-radius: 10px;
    padding: 20px 24px;
    margin: 18px 0;
    font-size: 0.93em;
  }
  .callout-orange {
    background: rgba(252,100,45,0.08);
    border: 1px solid rgba(252,100,45,0.25);
    border-left: 4px solid var(--accent);
  }
  .callout-green {
    background: rgba(255,255,255,0.15);
    border: 1px solid rgba(0,166,153,0.25);
    border-left: 4px solid var(--secondary);
  }
  .callout-blue {
    background: rgba(66,139,249,0.08);
    border: 1px solid rgba(66,139,249,0.25);
    border-left: 4px solid var(--blue);
  }
  .callout-purple {
    background: rgba(123,47,247,0.08);
    border: 1px solid rgba(123,47,247,0.25);
    border-left: 4px solid var(--purple);
  }
  .callout-red {
    background: rgba(255,90,95,0.15);
    border: 1px solid rgba(255,90,95,0.25);
    border-left: 4px solid var(--primary);
  }
  .callout-title {
    font-weight: 700;
    margin-bottom: 6px;
    color: var(--text);
  }
  .callout p { margin-bottom: 6px; }

  /* ===== TRADE-OFF GRID ===== */
  .tradeoff-card {
    background: var(--card-bg);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 16px;
  }
  .tradeoff-card h4 {
    color: var(--text);
    margin-bottom: 12px;
    font-size: 1em;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .tradeoff-card .vs {
    background: rgba(252,100,45,0.2);
    color: var(--accent);
    font-size: 0.7em;
    padding: 2px 10px;
    border-radius: 10px;
    font-weight: 700;
    letter-spacing: 1px;
  }
  .tradeoff-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-top: 10px;
  }
  .tradeoff-option {
    background: rgba(255,255,255,0.03);
    border-radius: 8px;
    padding: 14px;
  }
  .tradeoff-option h5 {
    color: #ffffff;
    font-size: 0.88em;
    margin-bottom: 6px;
  }
  .tradeoff-option.chosen h5 {
    color: var(--accent);
  }
  .tradeoff-option.chosen {
    border: 1px solid rgba(252,100,45,0.3);
    background: rgba(252,100,45,0.04);
  }
  .tradeoff-option ul {
    margin-bottom: 0;
    padding-left: 18px;
  }
  .tradeoff-option li {
    font-size: 0.85em;
  }

  /* ===== INTERVIEW TIP CARDS ===== */
  .tip-card {
    background: linear-gradient(135deg, rgba(252,100,45,0.06), rgba(0,166,153,0.06));
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 16px;
  }
  .tip-card h4 {
    margin-top: 0;
    color: var(--accent);
  }

  /* ===== METRIC BAR ===== */
  .metric-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 8px 0;
  }
  .metric-bar .metric-label {
    font-size: 0.85em;
    color: var(--text-muted);
    min-width: 140px;
  }
  .metric-bar .bar {
    flex: 1;
    height: 8px;
    background: rgba(255,255,255,0.06);
    border-radius: 4px;
    overflow: hidden;
  }
  .metric-bar .bar-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.5s ease;
  }
  .metric-bar .metric-value {
    font-size: 0.82em;
    font-weight: 700;
    color: var(--text);
    min-width: 80px;
    text-align: right;
  }

  /* ===== FOOTER ===== */
  .footer {
    text-align: center;
    padding: 40px 30px;
    color: var(--text-muted);
    font-size: 0.85em;
    border-top: 1px solid #e5e7eb;
  }
  .footer a {
    color: #ffffff;
    text-decoration: none;
  }
  .footer a:hover { color: var(--primary); }

  /* ===== RESPONSIVE ===== */
  @media (max-width: 768px) {
    .hero { padding: 50px 20px 40px; }
    .hero h1 { font-size: 1.8em; }
    .hero .subtitle { font-size: 1em; }
    .hero .stats-row { gap: 20px; }
    .hero .stat-value { font-size: 1.5em; }
    .section-nav { padding: 14px 20px; }
    .container { padding: 0 16px; }
    .content-section { padding: 35px 0 20px; }
    .content-section h2 { font-size: 1.4em; }
    .card-grid-2 { grid-template-columns: 1fr; }
    .card-grid-3 { grid-template-columns: 1fr; }
    .pipeline { flex-direction: column; }
    .pipeline-step { margin-right: 0; }
    .pipeline-step::after { content: '\2193'; right: auto; left: 50%; top: auto; bottom: -18px; transform: translateX(-50%); }
    .tradeoff-row { grid-template-columns: 1fr; }
  }
  @media (max-width: 480px) {
    .hero h1 { font-size: 1.5em; }
    .card { padding: 20px; }
    .code-block { padding: 16px; font-size: 0.78em; }
  }
  /* === DIAGRAM ZOOM CONTROLS === */
  .diagram-box { position: relative; }
  .diagram-zoom-controls {
    position: absolute; top: 12px; right: 12px; z-index: 10;
    display: flex; gap: 4px; opacity: 0.5; transition: opacity 0.3s;
  }
  .diagram-box:hover .diagram-zoom-controls { opacity: 1; }
  .diagram-zoom-controls button {
    width: 32px; height: 32px; border-radius: 8px; border: 1px solid #e5e7eb;
    background: #ffffff; color: #1e293b; cursor: pointer; font-size: 16px;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.2s;
    font-family: system-ui; line-height: 1; padding: 0;
  }
  .diagram-zoom-controls button:hover { background: #f1f5f9; border-color: var(--blue); color: var(--blue); }
  .diagram-zoom-controls button:active { transform: scale(0.95); }
  .diagram-zoom-controls .zoom-level {
    font-size: 11px; color: #64748b; display: flex; align-items: center;
    padding: 0 6px; font-weight: 600; min-width: 40px; justify-content: center;
  }
  .diagram-box svg { transition: transform 0.3s ease; transform-origin: center center; }
  .diagram-box.fullscreen {
    position: fixed !important; top: 0; left: 0; width: 100vw; height: 100vh;
    z-index: 9999; background: #ffffff; border-radius: 0; padding: 20px;
    display: flex; align-items: center; justify-content: center;
    overflow: auto;
  }
  .diagram-box.fullscreen .diagram-zoom-controls { opacity: 1; top: 20px; right: 20px; }
</style>
</head>
<body>

<!-- ================================================================ -->
<!--  HERO                                                            -->
<!-- ================================================================ -->
<div class="hero">
  <a href="index.html" class="back-link">&#8592; Back to All Topics</a>
  <div class="topic-number-hero">TOPIC 12</div>
  <h1>Image Ingestion Pipeline</h1>
  <p class="subtitle">Host uploads images and associates them to a listing, processed through a multi-stage pipeline and served globally via CDN</p>
  <div class="stats-row">
    <div class="stat-item">
      <div class="stat-value">105M</div>
      <div class="stat-label">Total Images</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">50K</div>
      <div class="stat-label">Uploads / Day</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">~2PB</div>
      <div class="stat-label">Total Storage</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">&lt;100ms</div>
      <div class="stat-label">CDN Serve Latency</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">99.99%</div>
      <div class="stat-label">Durability SLA</div>
    </div>
  </div>
</div>

<!-- ================================================================ -->
<!--  SECTION NAV                                                     -->
<!-- ================================================================ -->
<nav class="section-nav">
  <div class="section-nav-inner">
    <h2>Sections</h2>
    <div class="nav-links">
      <a href="#overview">Overview</a>
      <a href="#requirements">Requirements</a>
      <a href="#capacity">Capacity Estimation</a>
      <a href="#upload-flow">Upload Flow</a>
      <a href="#processing-pipeline">Processing Pipeline</a>
      <a href="#data-model">Data Model</a>
      <a href="#cdn-strategy">CDN Strategy</a>
      <a href="#api-design">API Design</a>
      <a href="#content-moderation">Content Moderation</a>
      <a href="#trade-offs">Trade-offs</a>
      <a href="#deep-dives">Deep Dives</a>
      <a href="#interview-tips">Interview Tips</a>
    </div>
  </div>
</nav>

<div class="container">

<!-- ================================================================ -->
<!--  1. OVERVIEW                                                     -->
<!-- ================================================================ -->
<section class="content-section" id="overview-section">
  <span class="section-anchor" id="overview"></span>
  <span class="section-label label-orange">Section 1</span>
  <h2>System Overview</h2>

  <p>Airbnb's image ingestion pipeline is a critical media infrastructure component. Hosts upload photos of their properties -- interiors, exteriors, amenities, and neighborhood -- to make their listings attractive to potential guests. The system must ingest these raw uploads, run them through a multi-stage processing pipeline (resize, compress, moderate, watermark), store the resulting variants durably, associate them with the correct listing in the correct order, and serve them globally with sub-100ms latency via a CDN.</p>

  <div class="card-grid-3">
    <div class="card">
      <h4>Ingest</h4>
      <p>Accept single or bulk uploads (up to 50 per listing) directly from hosts via presigned URLs. Support drag-and-drop, mobile camera roll, and professional photography integrations.</p>
    </div>
    <div class="card">
      <h4>Process</h4>
      <p>Validate, resize to multiple resolutions (thumbnail 150px, medium 600px, large 1200px, original), compress into modern formats (WebP, AVIF), extract EXIF, run content moderation, and optionally watermark.</p>
    </div>
    <div class="card">
      <h4>Store &amp; Serve</h4>
      <p>Durably store all image variants in object storage (S3). Associate with listing metadata. Serve globally via CloudFront CDN with aggressive caching and content negotiation for format optimization.</p>
    </div>
  </div>

  <div class="callout callout-orange">
    <div class="callout-title">Why This Problem is Non-Trivial at Scale</div>
    <p>At 50K uploads/day with 4 variants per image, the pipeline produces <strong>200K image objects daily</strong>. Content moderation must block inappropriate images before they appear in search. CDN invalidation must be instant when hosts reorder or delete photos. The system must handle spikes when professional photographers batch-upload 50 images simultaneously, and gracefully degrade when downstream ML services are under load.</p>
  </div>

  <div class="diagram-box">
    <svg viewBox="0 0 1100 650" xmlns="http://www.w3.org/2000/svg" font-family="Segoe UI, system-ui, sans-serif" font-size="12">
      <defs>
        <filter id="shadow2" x="-4%" y="-4%" width="108%" height="108%">
          <feDropShadow dx="2" dy="2" stdDeviation="3" flood-color="#000" flood-opacity="0.5"/>
        </filter>
        <linearGradient id="ig1" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#FF5A5F"/><stop offset="100%" stop-color="#E04850"/></linearGradient>
        <linearGradient id="ig2" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#00A699"/><stop offset="100%" stop-color="#008F84"/></linearGradient>
        <linearGradient id="ig3" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#7B2FF7"/><stop offset="100%" stop-color="#6320CC"/></linearGradient>
        <linearGradient id="ig4" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#428BF9"/><stop offset="100%" stop-color="#3070D0"/></linearGradient>
        <linearGradient id="ig5" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#f59e0b"/><stop offset="100%" stop-color="#d97706"/></linearGradient>
        <marker id="arrS2" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6" fill="#94a3b8"/></marker>
        <marker id="arrA2" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6" fill="#ef4444"/></marker>
        <marker id="arrG2" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6" fill="#10b981"/></marker>
        <marker id="arrO2" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6" fill="#FC642D"/></marker>
        <marker id="arrB2" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6" fill="#428BF9"/></marker>
      </defs>

      <!-- Title -->
      <text x="550" y="22" text-anchor="middle" fill="#1e293b" font-size="14" font-weight="800" letter-spacing="1">END-TO-END IMAGE INGESTION PIPELINE</text>

      <!-- ======== ROW 1: CLIENT UPLOAD ======== -->

      <!-- Host (person icon + device) -->
      <g filter="url(#shadow2)">
        <rect x="20" y="50" width="110" height="70" rx="10" fill="rgba(252,100,45,0.12)" stroke="#FC642D" stroke-width="1.5"/>
        <circle cx="58" cy="68" r="9" fill="#FC642D" opacity="0.8"/>
        <circle cx="58" cy="61" r="5" fill="#1a1a2e"/>
        <path d="M48,73 Q48,65 58,65 Q68,65 68,73" fill="#1a1a2e"/>
        <!-- phone icon -->
        <rect x="74" y="58" width="14" height="22" rx="2" fill="#94a3b8" opacity="0.5"/>
        <rect x="76" y="62" width="10" height="14" rx="1" fill="#1a1a2e"/>
        <text x="62" y="100" text-anchor="middle" fill="#1e293b" font-size="10" font-weight="700">Host Upload</text>
        <text x="62" y="112" text-anchor="middle" fill="#94a3b8" font-size="8">Web / Mobile</text>
      </g>

      <!-- Arrow: Host -> API Gateway -->
      <line x1="130" y1="80" x2="170" y2="80" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arrS2)"/>
      <text x="150" y="73" text-anchor="middle" fill="#94a3b8" font-size="7">1</text>

      <!-- API Gateway (shield + checkmark) -->
      <g filter="url(#shadow2)">
        <rect x="175" y="52" width="120" height="56" rx="10" fill="url(#ig1)" opacity="0.9"/>
        <!-- shield icon -->
        <path d="M200,68 L200,82 Q200,90 210,93 Q220,90 220,82 L220,68 L210,64 Z" fill="rgba(255,255,255,0.25)" stroke="#fff" stroke-width="0.8"/>
        <polyline points="206,78 210,83 218,72" fill="none" stroke="#fff" stroke-width="1.5"/>
        <text x="258" y="77" text-anchor="middle" fill="#fff" font-size="10" font-weight="700">API Gateway</text>
        <text x="258" y="92" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-size="8">Auth + Presign</text>
      </g>

      <!-- Arrow: API Gateway returns presigned URL (back to Host) -->
      <path d="M235,108 L235,130 L75,130 L75,120" fill="none" stroke="#10b981" stroke-width="1.2" stroke-dasharray="4,3" marker-end="url(#arrG2)"/>
      <text x="155" y="126" text-anchor="middle" fill="#10b981" font-size="8" font-weight="600">2. presigned URL</text>

      <!-- Arrow: Host uploads directly to S3 (big arrow bypassing API) -->
      <path d="M75,130 Q75,160 200,160 L380,160" fill="none" stroke="#FC642D" stroke-width="2" marker-end="url(#arrO2)"/>
      <text x="230" y="154" text-anchor="middle" fill="#FC642D" font-size="8" font-weight="700">3. Direct upload (bypasses app server)</text>

      <!-- S3 Raw Bucket (bucket icon) -->
      <g filter="url(#shadow2)" transform="translate(420,140)">
        <path d="M-30,0 L-25,38 L25,38 L30,0 Z" fill="#4caf50" opacity="0.85"/>
        <ellipse cx="0" cy="0" rx="30" ry="9" fill="#4caf50"/>
        <ellipse cx="0" cy="0" rx="30" ry="9" fill="rgba(255,255,255,0.15)"/>
        <text x="0" y="22" text-anchor="middle" fill="#fff" font-size="9" font-weight="700">S3</text>
        <text x="0" y="33" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-size="7">Raw</text>
      </g>
      <text x="420" y="192" text-anchor="middle" fill="#1e293b" font-size="9" font-weight="600">S3 / Blob Storage</text>

      <!-- ======== ROW 2: EVENT TRIGGER ======== -->

      <!-- Arrow: S3 event -> SQS/Kafka -->
      <line x1="450" y1="170" x2="520" y2="220" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrA2)"/>
      <text x="480" y="190" text-anchor="middle" fill="#ef4444" font-size="8" font-weight="600">4. S3 event</text>

      <!-- SQS/Kafka (kafka nodes icon) -->
      <g filter="url(#shadow2)" transform="translate(560,218)">
        <rect x="-40" y="-16" width="80" height="48" rx="8" fill="rgba(239,68,68,0.15)" stroke="#ef4444" stroke-width="1"/>
        <circle cx="-15" cy="6" r="7" fill="#ef4444"/>
        <circle cx="0" cy="6" r="7" fill="#ef4444" opacity="0.8"/>
        <circle cx="15" cy="6" r="7" fill="#ef4444" opacity="0.6"/>
        <line x1="-8" y1="6" x2="-7" y2="6" stroke="#1a1a2e" stroke-width="2"/>
        <line x1="7" y1="6" x2="8" y2="6" stroke="#1a1a2e" stroke-width="2"/>
        <text x="0" y="24" text-anchor="middle" fill="#ef4444" font-size="7" font-weight="700">SQS / Kafka</text>
      </g>

      <!-- Arrow: SQS -> Processing Workers -->
      <line x1="600" y1="240" x2="640" y2="280" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrA2)"/>
      <text x="630" y="257" text-anchor="middle" fill="#ef4444" font-size="8">5. consume</text>

      <!-- ======== ROW 3: PROCESSING PIPELINE (large box with chain) ======== -->
      <g filter="url(#shadow2)">
        <rect x="30" y="290" width="760" height="120" rx="12" fill="rgba(123,47,247,0.06)" stroke="#7B2FF7" stroke-width="2"/>
        <text x="410" y="310" text-anchor="middle" fill="#7B2FF7" font-size="12" font-weight="800">IMAGE PROCESSING WORKERS</text>

        <!-- Validate -->
        <rect x="50" y="325" width="82" height="40" rx="6" fill="url(#ig2)" opacity="0.85"/>
        <text x="91" y="342" text-anchor="middle" fill="#fff" font-size="9" font-weight="600">Validate</text>
        <text x="91" y="356" text-anchor="middle" fill="rgba(255,255,255,0.7)" font-size="7">format/size</text>

        <!-- Arrow -->
        <line x1="132" y1="345" x2="142" y2="345" stroke="#94a3b8" stroke-width="1" marker-end="url(#arrS2)"/>

        <!-- EXIF Extract -->
        <rect x="148" y="325" width="82" height="40" rx="6" fill="url(#ig4)" opacity="0.85"/>
        <text x="189" y="342" text-anchor="middle" fill="#fff" font-size="9" font-weight="600">EXIF Extract</text>
        <text x="189" y="356" text-anchor="middle" fill="rgba(255,255,255,0.7)" font-size="7">metadata</text>

        <!-- Arrow -->
        <line x1="230" y1="345" x2="240" y2="345" stroke="#94a3b8" stroke-width="1" marker-end="url(#arrS2)"/>

        <!-- Resize -->
        <rect x="246" y="325" width="90" height="40" rx="6" fill="url(#ig5)" opacity="0.85"/>
        <text x="291" y="340" text-anchor="middle" fill="#fff" font-size="9" font-weight="600">Resize</text>
        <text x="291" y="356" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-size="7">150 / 600 / 1200px</text>

        <!-- Arrow -->
        <line x1="336" y1="345" x2="346" y2="345" stroke="#94a3b8" stroke-width="1" marker-end="url(#arrS2)"/>

        <!-- Compress -->
        <rect x="352" y="325" width="84" height="40" rx="6" fill="url(#ig1)" opacity="0.85"/>
        <text x="394" y="340" text-anchor="middle" fill="#fff" font-size="9" font-weight="600">Compress</text>
        <text x="394" y="356" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-size="7">WebP / AVIF</text>

        <!-- Arrow -->
        <line x1="436" y1="345" x2="446" y2="345" stroke="#94a3b8" stroke-width="1" marker-end="url(#arrS2)"/>

        <!-- Content Moderation (ML brain icon) -->
        <rect x="452" y="325" width="110" height="40" rx="6" fill="url(#ig3)" opacity="0.85"/>
        <!-- brain/ML icon -->
        <circle cx="474" cy="340" r="8" fill="rgba(255,255,255,0.2)"/>
        <path d="M470,337 Q472,332 476,334 Q480,332 478,337 Q481,339 478,342 Q480,346 476,344 Q472,346 470,342 Q467,340 470,337" fill="#64748b" stroke="#fff" stroke-width="0.5"/>
        <text x="520" y="342" text-anchor="middle" fill="#fff" font-size="8" font-weight="600">Content Mod</text>
        <text x="520" y="356" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-size="7">(ML)</text>

        <!-- Arrow -->
        <line x1="562" y1="345" x2="572" y2="345" stroke="#94a3b8" stroke-width="1" marker-end="url(#arrS2)"/>

        <!-- Upload Variants -->
        <rect x="578" y="325" width="100" height="40" rx="6" fill="url(#ig2)" opacity="0.85"/>
        <text x="628" y="342" text-anchor="middle" fill="#fff" font-size="9" font-weight="600">Upload Variants</text>
        <text x="628" y="356" text-anchor="middle" fill="rgba(255,255,255,0.7)" font-size="7">back to S3</text>

        <!-- Arrow out to S3 -->
        <line x1="678" y1="345" x2="770" y2="345" stroke="#4caf50" stroke-width="1.5" marker-end="url(#arrG2)"/>
      </g>

      <!-- ======== ROW 4: STORAGE + SERVING ======== -->

      <!-- S3 Origin (processed bucket icon) -->
      <g filter="url(#shadow2)" transform="translate(830,330)">
        <path d="M-28,0 L-23,35 L23,35 L28,0 Z" fill="#4caf50" opacity="0.85"/>
        <ellipse cx="0" cy="0" rx="28" ry="8" fill="#4caf50"/>
        <ellipse cx="0" cy="0" rx="28" ry="8" fill="rgba(255,255,255,0.15)"/>
        <text x="0" y="16" text-anchor="middle" fill="#fff" font-size="8" font-weight="700">S3 Origin</text>
        <text x="0" y="27" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-size="6">orig + 3 variants</text>
      </g>

      <!-- Arrow: S3 Origin -> CDN -->
      <line x1="860" y1="330" x2="920" y2="280" stroke="#f59e0b" stroke-width="1.5" marker-end="url(#arrS2)"/>

      <!-- CDN (globe icon) -->
      <g filter="url(#shadow2)" transform="translate(970,240)">
        <circle cx="0" cy="0" r="28" fill="#f59e0b" opacity="0.85"/>
        <!-- globe lines -->
        <ellipse cx="0" cy="0" rx="28" ry="28" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="0.8"/>
        <ellipse cx="0" cy="0" rx="14" ry="28" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="0.8"/>
        <line x1="-28" y1="0" x2="28" y2="0" stroke="rgba(255,255,255,0.3)" stroke-width="0.8"/>
        <line x1="-24" y1="-14" x2="24" y2="-14" stroke="rgba(255,255,255,0.2)" stroke-width="0.6"/>
        <line x1="-24" y1="14" x2="24" y2="14" stroke="rgba(255,255,255,0.2)" stroke-width="0.6"/>
        <text x="0" y="4" text-anchor="middle" fill="#fff" font-size="9" font-weight="700">CDN</text>
      </g>
      <text x="970" y="278" text-anchor="middle" fill="#1e293b" font-size="9" font-weight="600">CloudFront</text>

      <!-- Arrow: CDN -> Guest -->
      <line x1="998" y1="240" x2="1050" y2="200" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arrS2)"/>

      <!-- Guest (person viewing) -->
      <g filter="url(#shadow2)">
        <rect x="1010" y="145" width="80" height="55" rx="10" fill="rgba(0,166,153,0.12)" stroke="#00A699" stroke-width="1.5"/>
        <circle cx="1040" cy="162" r="8" fill="#00A699" opacity="0.8"/>
        <circle cx="1040" cy="156" r="5" fill="#1a1a2e"/>
        <path d="M1032,167 Q1032,160 1040,160 Q1048,160 1048,167" fill="#1a1a2e"/>
        <text x="1050" y="182" text-anchor="middle" fill="#1e293b" font-size="9" font-weight="700">Guest</text>
        <text x="1050" y="194" text-anchor="middle" fill="#94a3b8" font-size="7">views listing</text>
      </g>

      <!-- ======== METADATA PATH ======== -->

      <!-- PostgreSQL (DB cylinder) -->
      <g filter="url(#shadow2)" transform="translate(830,460)">
        <rect x="-38" y="-6" width="76" height="42" fill="#428BF9" opacity="0.8"/>
        <ellipse cx="0" cy="-6" rx="38" ry="10" fill="#428BF9"/>
        <ellipse cx="0" cy="36" rx="38" ry="10" fill="#428BF9" opacity="0.7"/>
        <text x="0" y="12" text-anchor="middle" fill="#fff" font-size="9" font-weight="700">PostgreSQL</text>
        <text x="0" y="24" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-size="7">images DB</text>
      </g>

      <!-- Arrow: Processing Workers -> PostgreSQL (metadata update) -->
      <line x1="628" y1="410" x2="800" y2="460" stroke="#428BF9" stroke-width="1.5" marker-end="url(#arrB2)"/>
      <text x="700" y="428" text-anchor="middle" fill="#428BF9" font-size="8" font-weight="600">8. update metadata</text>

      <!-- Image Service (service box) connecting API and PG -->
      <g filter="url(#shadow2)">
        <rect x="910" y="440" width="140" height="48" rx="10" fill="url(#ig2)" opacity="0.85"/>
        <text x="980" y="462" text-anchor="middle" fill="#fff" font-size="10" font-weight="700">Image Service</text>
        <text x="980" y="478" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-size="8">metadata + URLs</text>
      </g>

      <!-- Arrow: PG <-> Image Service -->
      <line x1="868" y1="468" x2="908" y2="464" stroke="#94a3b8" stroke-width="1" marker-end="url(#arrS2)"/>

      <!-- API Gateway reference (top-right, connects to Image Service) -->
      <g filter="url(#shadow2)">
        <rect x="930" y="375" width="120" height="42" rx="10" fill="url(#ig1)" opacity="0.7"/>
        <path d="M952,388 L952,400 Q952,406 960,409 Q968,406 968,400 L968,388 L960,384 Z" fill="rgba(255,255,255,0.25)" stroke="#fff" stroke-width="0.6"/>
        <polyline points="956,396 960,400 966,392" fill="none" stroke="#fff" stroke-width="1"/>
        <text x="1005" y="398" text-anchor="middle" fill="#fff" font-size="9" font-weight="600">API Gateway</text>
      </g>
      <line x1="980" y1="417" x2="980" y2="440" stroke="#94a3b8" stroke-width="1" marker-end="url(#arrS2)"/>
      <text x="995" y="432" text-anchor="start" fill="#94a3b8" font-size="7">presigned URL gen</text>

      <!-- ======== FLOW ANNOTATIONS (dotted path showing full flow) ======== -->
      <g>
        <text x="55" y="540" fill="#94a3b8" font-size="10" font-weight="700">FLOW:</text>
        <text x="100" y="540" fill="#FC642D" font-size="9">Host</text>
        <text x="130" y="540" fill="#94a3b8" font-size="9">&rarr; presigned URL &rarr;</text>
        <text x="245" y="540" fill="#4caf50" font-size="9">S3</text>
        <text x="262" y="540" fill="#94a3b8" font-size="9">&rarr; event &rarr;</text>
        <text x="320" y="540" fill="#7B2FF7" font-size="9">Workers</text>
        <text x="372" y="540" fill="#94a3b8" font-size="9">&rarr; processed images &rarr;</text>
        <text x="505" y="540" fill="#4caf50" font-size="9">S3</text>
        <text x="522" y="540" fill="#94a3b8" font-size="9">&rarr;</text>
        <text x="540" y="540" fill="#f59e0b" font-size="9">CDN</text>
        <text x="565" y="540" fill="#94a3b8" font-size="9">&rarr;</text>
        <text x="580" y="540" fill="#00A699" font-size="9">Guest views listing</text>
      </g>

      <!-- Legend -->
      <g transform="translate(40, 580)">
        <text x="0" y="0" fill="#94a3b8" font-size="10" font-weight="700">LEGEND:</text>
        <line x1="70" y1="-3" x2="110" y2="-3" stroke="#94a3b8" stroke-width="1.5"/>
        <text x="115" y="0" fill="#94a3b8" font-size="9">Sync</text>
        <line x1="155" y1="-3" x2="195" y2="-3" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="5,3"/>
        <text x="200" y="0" fill="#94a3b8" font-size="9">Async / Event</text>
        <!-- bucket icon small -->
        <path d="M290,-8 L292,4 L302,4 L304,-8 Z" fill="#4caf50" opacity="0.7"/>
        <ellipse cx="297" cy="-8" rx="7" ry="3" fill="#4caf50" opacity="0.8"/>
        <text x="312" y="0" fill="#94a3b8" font-size="9">S3 / Blob</text>
        <!-- DB icon small -->
        <rect x="370" y="-8" width="14" height="10" fill="#428BF9" opacity="0.7"/>
        <ellipse cx="377" cy="-8" rx="7" ry="3" fill="#428BF9"/>
        <text x="392" y="0" fill="#94a3b8" font-size="9">Database</text>
        <!-- CDN globe small -->
        <circle cx="460" cy="-3" r="7" fill="#f59e0b" opacity="0.7"/>
        <text x="475" y="0" fill="#94a3b8" font-size="9">CDN</text>
        <!-- Kafka small -->
        <circle cx="520" cy="-3" r="5" fill="#ef4444"/><circle cx="530" cy="-3" r="5" fill="#ef4444" opacity="0.7"/>
        <text x="545" y="0" fill="#94a3b8" font-size="9">Kafka / SQS</text>
      </g>

      <!-- ======== NUMBERED STEP CIRCLES ======== -->
      <!-- Step 1: Host -> API Gateway (HTTPS, request presigned URL) -->
      <circle cx="150" cy="68" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="150" y="72" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">1</text>
      <!-- Step 2: API Gateway -> Image Service -> presigned S3 URL -->
      <circle cx="155" cy="126" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="155" y="130" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">2</text>
      <!-- Step 3: Host -> S3 directly (presigned PUT) -->
      <circle cx="300" cy="148" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="300" y="152" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">3</text>
      <!-- Step 4: S3 -> Event trigger to Kafka/SQS -->
      <circle cx="475" cy="198" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="475" y="202" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">4</text>
      <!-- Step 5: Kafka -> Image Processing Worker: Validate -->
      <circle cx="91" cy="318" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="91" y="322" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">5</text>
      <!-- Step 6: EXIF extraction + privacy stripping -->
      <circle cx="189" cy="318" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="189" y="322" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">6</text>
      <!-- Step 7: Resize to 3 resolutions -->
      <circle cx="291" cy="318" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="291" y="322" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">7</text>
      <!-- Step 8: Compress (WebP/AVIF) + Content Moderation (ML) -->
      <circle cx="440" cy="318" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="440" y="322" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">8</text>
      <!-- Step 9: Worker -> S3 (upload processed variants) -->
      <circle cx="730" cy="345" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="730" y="349" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">9</text>
      <!-- Step 10: Worker -> PostgreSQL (update image metadata + status) -->
      <circle cx="740" cy="448" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="740" y="452" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">10</text>
      <!-- Step 11: CDN serves processed images to guests -->
      <circle cx="1020" cy="218" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/><text x="1020" y="222" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">11</text>
    </svg>
  </div>

  <!-- ======== REQUEST FLOW REFERENCE ======== -->
  <h3>Request Flow Reference</h3>
  <div class="table-wrapper">
    <table>
      <thead>
        <tr><th>Step</th><th>From</th><th>To</th><th>Protocol</th><th>Description</th></tr>
      </thead>
      <tbody>
        <tr><td><strong>1</strong></td><td>Host</td><td>API Gateway</td><td>HTTPS</td><td>Request presigned upload URL</td></tr>
        <tr><td><strong>2</strong></td><td>API Gateway</td><td>Image Service</td><td>Internal</td><td>Generate presigned S3 URL and return to host</td></tr>
        <tr><td><strong>3</strong></td><td>Host</td><td>S3</td><td>HTTPS PUT</td><td>Direct upload -- bypasses application server</td></tr>
        <tr><td><strong>4</strong></td><td>S3</td><td>Kafka / SQS</td><td>Event trigger</td><td>Object-created event fires</td></tr>
        <tr><td><strong>5</strong></td><td>Kafka</td><td>Image Processing Worker</td><td>Consumer</td><td>Validate image format and size</td></tr>
        <tr><td><strong>6</strong></td><td colspan="2">Worker</td><td>Internal</td><td>EXIF extraction + privacy stripping</td></tr>
        <tr><td><strong>7</strong></td><td colspan="2">Worker</td><td>Internal</td><td>Resize to 3 resolutions (150px, 600px, 1200px)</td></tr>
        <tr><td><strong>8</strong></td><td colspan="2">Worker</td><td>Internal + ML</td><td>Compress (WebP/AVIF) + Content Moderation</td></tr>
        <tr><td><strong>9</strong></td><td>Worker</td><td>S3</td><td>HTTPS PUT</td><td>Upload processed image variants</td></tr>
        <tr><td><strong>10</strong></td><td>Worker</td><td>PostgreSQL</td><td>TCP</td><td>Update image metadata + processing status</td></tr>
        <tr><td><strong>11</strong></td><td>CDN (CloudFront)</td><td>Guest</td><td>HTTPS</td><td>Serve processed images from S3 origin globally</td></tr>
      </tbody>
    </table>
  </div>

  <!-- ======== HAPPY PATH ======== -->
  <h3>Happy Path</h3>
  <div class="callout callout-green">
    <div class="callout-title" style="color: var(--success);">Successful Image Ingestion Flow</div>
    <div class="pipeline">
      <div class="pipeline-step" style="border-color: var(--accent);">
        <span class="step-num">1</span>
        <span class="step-title">Host uploads</span>
        <span class="step-desc">Presigned URL</span>
      </div>
      <div class="pipeline-step" style="border-color: var(--success);">
        <span class="step-num">2</span>
        <span class="step-title">S3 receives</span>
        <span class="step-desc">Raw image stored</span>
      </div>
      <div class="pipeline-step" style="border-color: var(--purple);">
        <span class="step-num">3</span>
        <span class="step-title">Pipeline runs</span>
        <span class="step-desc">Validate + process</span>
      </div>
      <div class="pipeline-step" style="border-color: var(--blue);">
        <span class="step-num">4</span>
        <span class="step-title">3 variants created</span>
        <span class="step-desc">150 / 600 / 1200px</span>
      </div>
      <div class="pipeline-step" style="border-color: #e5e7eb;">
        <span class="step-num">5</span>
        <span class="step-title">Metadata stored</span>
        <span class="step-desc">PostgreSQL updated</span>
      </div>
      <div class="pipeline-step" style="border-color: var(--warning);">
        <span class="step-num">6</span>
        <span class="step-title">CDN serves</span>
        <span class="step-desc">Globally &lt;100ms</span>
      </div>
    </div>
  </div>

  <!-- ======== FAILURE PATHS ======== -->
  <h3>Failure Paths</h3>
  <div class="table-wrapper">
    <table>
      <thead>
        <tr><th>Failure Scenario</th><th>Impact</th><th>Mitigation</th></tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Upload timeout</strong></td>
          <td>Large image fails to upload completely</td>
          <td>Resumable upload via tus protocol; client retries from last byte offset</td>
        </tr>
        <tr>
          <td><strong>Invalid format</strong></td>
          <td>Unsupported image type submitted</td>
          <td>Reject immediately with descriptive error; validation at step 5 before processing</td>
        </tr>
        <tr>
          <td><strong>Content moderation flag</strong></td>
          <td>Inappropriate image detected by ML</td>
          <td>Image quarantined; queued for human review before publication</td>
        </tr>
        <tr>
          <td><strong>Processing worker crash</strong></td>
          <td>Image stuck in "processing" state</td>
          <td>Kafka retry with exponential backoff; idempotent processing ensures no duplicates</td>
        </tr>
        <tr>
          <td><strong>S3 upload failure (variants)</strong></td>
          <td>Processed images not persisted</td>
          <td>Dead-letter queue (DLQ) captures failed uploads; automatic retry with alerting</td>
        </tr>
        <tr>
          <td><strong>CDN cache miss</strong></td>
          <td>Slower first-load for cold image</td>
          <td>Origin fetch from S3; subsequent requests served from edge cache</td>
        </tr>
      </tbody>
    </table>
  </div>

</section>

<!-- ================================================================ -->
<!--  2. REQUIREMENTS                                                 -->
<!-- ================================================================ -->
<section class="content-section" id="requirements-section">
  <span class="section-anchor" id="requirements"></span>
  <span class="section-label label-green">Section 2</span>
  <h2>Requirements</h2>

  <div class="card-grid-2">
    <div class="card">
      <h4>Functional Requirements</h4>
      <ul>
        <li><strong>Upload:</strong> Single and bulk image uploads (up to 50 images per listing)</li>
        <li><strong>Association:</strong> Associate each image with a specific listing, with explicit ordering (sort_order)</li>
        <li><strong>Multi-Resolution:</strong> Generate thumbnail (150px), medium (600px), large (1200px), and preserve original</li>
        <li><strong>CDN Serving:</strong> Serve all image variants via global CDN with cache headers</li>
        <li><strong>Management:</strong> Delete individual images, reorder images within a listing</li>
        <li><strong>Content Moderation:</strong> Detect and block inappropriate content (nudity, violence, text spam overlay)</li>
        <li><strong>Format Optimization:</strong> Serve WebP/AVIF for modern browsers, JPEG fallback for legacy</li>
        <li><strong>Metadata Extraction:</strong> Extract EXIF data (GPS location, camera model, date) for internal use</li>
      </ul>
    </div>
    <div class="card">
      <h4>Non-Functional Requirements</h4>
      <ul>
        <li><strong>Upload Latency:</strong> &lt; 5 seconds for a 10MB image (presigned URL flow)</li>
        <li><strong>Processing Latency:</strong> &lt; 30 seconds end-to-end for all variants</li>
        <li><strong>Serving Latency:</strong> &lt; 100ms globally via CDN (cache hit)</li>
        <li><strong>Durability:</strong> 99.99% -- zero image loss once confirmed</li>
        <li><strong>Throughput:</strong> 50,000 new uploads per day (~0.58 uploads/sec average, with 10x burst)</li>
        <li><strong>Availability:</strong> 99.9% for upload API, 99.99% for serving (CDN)</li>
        <li><strong>Scalability:</strong> Horizontally scalable processing pipeline</li>
        <li><strong>Security:</strong> Only authenticated hosts can upload to their own listings</li>
      </ul>
    </div>
  </div>

  <div class="callout callout-green">
    <div class="callout-title">Scoping Note for Interviews</div>
    <p>In an interview, clarify these up front: (1) Are we designing the video pipeline too? No -- images only. (2) Do we need real-time processing or can it be async? Async with &lt;30s SLA. (3) Who can upload -- hosts only or guests too (e.g., reviews)? Focus on host listing photos. (4) Do we need to handle 360-degree or virtual tour images? Out of scope for now.</p>
  </div>
</section>

<!-- ================================================================ -->
<!--  3. CAPACITY ESTIMATION                                          -->
<!-- ================================================================ -->
<section class="content-section" id="capacity-section">
  <span class="section-anchor" id="capacity"></span>
  <span class="section-label label-blue">Section 3</span>
  <h2>Capacity Estimation</h2>

  <div class="card">
    <h4>Storage Math</h4>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Metric</th>
            <th>Value</th>
            <th>Derivation</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Total active listings</td>
            <td><strong>7 million</strong></td>
            <td>Given</td>
          </tr>
          <tr>
            <td>Average images per listing</td>
            <td><strong>15</strong></td>
            <td>Given</td>
          </tr>
          <tr>
            <td>Total existing images</td>
            <td><strong>105 million</strong></td>
            <td>7M x 15</td>
          </tr>
          <tr>
            <td>New uploads per day</td>
            <td><strong>50,000</strong></td>
            <td>Given</td>
          </tr>
          <tr>
            <td>Average raw image size</td>
            <td><strong>5 MB</strong></td>
            <td>Smartphone camera average</td>
          </tr>
          <tr>
            <td>Variants per image</td>
            <td><strong>4</strong></td>
            <td>Original + Thumbnail + Medium + Large</td>
          </tr>
          <tr>
            <td>Average total storage per image</td>
            <td><strong>~8 MB</strong></td>
            <td>5MB original + 0.1MB thumb + 0.8MB medium + 2MB large</td>
          </tr>
          <tr>
            <td>Daily new storage</td>
            <td><strong>~400 GB/day</strong></td>
            <td>50K x 8MB</td>
          </tr>
          <tr>
            <td>Annual new storage</td>
            <td><strong>~146 TB/year</strong></td>
            <td>400GB x 365</td>
          </tr>
          <tr>
            <td>Total storage (existing)</td>
            <td><strong>~840 TB</strong></td>
            <td>105M x 8MB</td>
          </tr>
          <tr>
            <td>Total with overhead + replication</td>
            <td><strong>~2 PB</strong></td>
            <td>840TB x ~2.4 (S3 replication, metadata overhead)</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="card-grid-2">
    <div class="card">
      <h4>Throughput Estimation</h4>
      <div class="metric-bar">
        <span class="metric-label">Avg uploads/sec</span>
        <div class="bar"><div class="bar-fill" style="width:6%; background: var(--accent);"></div></div>
        <span class="metric-value">0.58 /sec</span>
      </div>
      <div class="metric-bar">
        <span class="metric-label">Peak uploads/sec</span>
        <div class="bar"><div class="bar-fill" style="width:58%; background: var(--primary);"></div></div>
        <span class="metric-value">~6 /sec (10x)</span>
      </div>
      <div class="metric-bar">
        <span class="metric-label">Processing jobs/sec</span>
        <div class="bar"><div class="bar-fill" style="width:70%; background: var(--secondary);"></div></div>
        <span class="metric-value">~6 /sec peak</span>
      </div>
      <div class="metric-bar">
        <span class="metric-label">CDN reads/sec</span>
        <div class="bar"><div class="bar-fill" style="width:95%; background: var(--blue);"></div></div>
        <span class="metric-value">~100K /sec</span>
      </div>
    </div>
    <div class="card">
      <h4>Bandwidth Estimation</h4>
      <div class="metric-bar">
        <span class="metric-label">Ingest bandwidth</span>
        <div class="bar"><div class="bar-fill" style="width:20%; background: var(--accent);"></div></div>
        <span class="metric-value">~30 MB/s peak</span>
      </div>
      <div class="metric-bar">
        <span class="metric-label">S3 write bandwidth</span>
        <div class="bar"><div class="bar-fill" style="width:35%; background: var(--purple);"></div></div>
        <span class="metric-value">~50 MB/s peak</span>
      </div>
      <div class="metric-bar">
        <span class="metric-label">CDN egress</span>
        <div class="bar"><div class="bar-fill" style="width:90%; background: var(--blue);"></div></div>
        <span class="metric-value">~50 GB/s</span>
      </div>
      <p style="margin-top:12px; font-size:0.82em;">CDN egress dominates costs. This is read-heavy (100K reads/sec vs ~6 writes/sec at peak).</p>
    </div>
  </div>
</section>

<!-- ================================================================ -->
<!--  4. UPLOAD FLOW                                                  -->
<!-- ================================================================ -->
<section class="content-section" id="upload-flow-section">
  <span class="section-anchor" id="upload-flow"></span>
  <span class="section-label label-orange">Section 4</span>
  <h2>Upload Flow (Presigned URLs)</h2>

  <p>The key architectural decision here is using <strong>presigned URLs</strong> to upload directly to object storage, bypassing the application server for binary data transfer. This is the standard pattern for large file uploads at scale.</p>

  <div class="pipeline">
    <div class="pipeline-step">
      <div class="step-num">1</div>
      <span class="step-title">Request URL</span>
      <span class="step-desc">Client calls API with file metadata</span>
    </div>
    <div class="pipeline-step">
      <div class="step-num">2</div>
      <span class="step-title">Generate</span>
      <span class="step-desc">Server creates presigned S3 PUT URL</span>
    </div>
    <div class="pipeline-step">
      <div class="step-num">3</div>
      <span class="step-title">Direct Upload</span>
      <span class="step-desc">Client uploads binary to S3 directly</span>
    </div>
    <div class="pipeline-step">
      <div class="step-num">4</div>
      <span class="step-title">Confirm</span>
      <span class="step-desc">Client notifies API of completion</span>
    </div>
    <div class="pipeline-step">
      <div class="step-num">5</div>
      <span class="step-title">Process</span>
      <span class="step-desc">S3 event triggers async pipeline</span>
    </div>
  </div>

  <div class="card-grid-2">
    <div class="card">
      <h4>Why Presigned URLs?</h4>
      <ul>
        <li><strong>Offloads bandwidth</strong> from application servers -- binary data never touches your API fleet</li>
        <li><strong>Supports large files</strong> without configuring massive request body limits on load balancers</li>
        <li><strong>Resumable uploads</strong> via S3 multipart upload API</li>
        <li><strong>Reduced latency</strong> -- client uploads to nearest S3 edge / transfer acceleration endpoint</li>
        <li><strong>Cost efficient</strong> -- no need for large EC2 instances or high memory to buffer uploads</li>
        <li><strong>Security</strong> -- presigned URL expires after a configurable TTL (e.g., 15 minutes), scoped to specific key</li>
      </ul>
    </div>
    <div class="card">
      <h4>Presigned URL Constraints</h4>
      <ul>
        <li><strong>Content-Type enforcement</strong> -- presign with specific content type (image/jpeg, image/png, image/webp)</li>
        <li><strong>Content-Length limit</strong> -- max 25MB per file enforced in presign conditions</li>
        <li><strong>Key prefix</strong> -- scoped to <code>raw/{listing_id}/{uuid}</code> to prevent namespace collision</li>
        <li><strong>TTL</strong> -- 15-minute expiry to prevent replay or URL sharing</li>
        <li><strong>Auth check</strong> -- server validates host owns the listing before generating URL</li>
      </ul>
    </div>
  </div>

  <div class="code-block">
    <span class="code-label">Upload Flow Sequence</span>
<span class="cm">// Step 1: Client requests presigned URL</span>
<span class="kw">POST</span> /api/v1/listings/<span class="param">:listing_id</span>/images/upload-url
<span class="str">Content-Type: application/json</span>
<span class="str">Authorization: Bearer {host_token}</span>

{
  <span class="str">"file_name"</span>: <span class="str">"living_room.jpg"</span>,
  <span class="str">"content_type"</span>: <span class="str">"image/jpeg"</span>,
  <span class="str">"file_size"</span>: <span class="num">4821504</span>   <span class="cm">// 4.6 MB</span>
}

<span class="cm">// Step 2: Server responds with presigned URL + image record ID</span>
{
  <span class="str">"image_id"</span>: <span class="str">"img_a1b2c3d4"</span>,
  <span class="str">"upload_url"</span>: <span class="str">"https://s3.amazonaws.com/airbnb-raw/raw/lst_123/img_a1b2c3d4?X-Amz-..."</span>,
  <span class="str">"expires_at"</span>: <span class="str">"2024-01-15T10:15:00Z"</span>,
  <span class="str">"max_size_bytes"</span>: <span class="num">26214400</span>
}

<span class="cm">// Step 3: Client uploads directly to S3</span>
<span class="kw">PUT</span> {upload_url}
<span class="str">Content-Type: image/jpeg</span>
<span class="str">Content-Length: 4821504</span>
[binary data]

<span class="cm">// Step 4: Client confirms upload completion</span>
<span class="kw">POST</span> /api/v1/listings/<span class="param">:listing_id</span>/images/confirm
{
  <span class="str">"image_id"</span>: <span class="str">"img_a1b2c3d4"</span>,
  <span class="str">"etag"</span>: <span class="str">"d41d8cd98f00b204e9800998ecf8427e"</span>
}
  </div>

  <div class="callout callout-orange">
    <div class="callout-title">Bulk Upload Optimization</div>
    <p>For bulk uploads (e.g., a host uploading 30 photos at once), the client requests multiple presigned URLs in a single API call. The server returns an array of URLs, and the client uploads in parallel (max 5 concurrent to avoid browser connection limits). Each upload triggers its own processing pipeline event independently.</p>
  </div>
</section>

<!-- ================================================================ -->
<!--  5. PROCESSING PIPELINE                                          -->
<!-- ================================================================ -->
<section class="content-section" id="processing-pipeline-section">
  <span class="section-anchor" id="processing-pipeline"></span>
  <span class="section-label label-purple">Section 5</span>
  <h2>Processing Pipeline</h2>

  <p>Once the raw image lands in S3, an <strong>event-driven, asynchronous pipeline</strong> performs all transformations. The pipeline must be <strong>idempotent</strong> (safe to retry) and <strong>independently scalable</strong> per stage.</p>

  <div class="flow-diagram">
    <span class="label">Processing Pipeline Architecture</span>

    <span class="storage">[S3 Raw Bucket]</span>
      <span class="arrow-flow">--- s3:ObjectCreated --->  </span><span class="event">[SQS Queue / Kafka Topic]</span>

    <span class="event">[SQS Queue]</span>
      <span class="arrow-flow">--- poll --->  </span><span class="node">[Image Processing Worker Fleet]</span>

    <span class="node">[Worker]</span> executes stages in order:
      <span class="arrow-flow">  (1)</span> <span class="node">Validate</span> format, dimensions, file size
      <span class="arrow-flow">  (2)</span> <span class="node">Extract EXIF</span> GPS, camera, orientation, date
      <span class="arrow-flow">  (3)</span> <span class="node">Strip Private EXIF</span> remove GPS for guest-facing URLs
      <span class="arrow-flow">  (4)</span> <span class="node">Auto-Orient</span> apply EXIF rotation to pixel data
      <span class="arrow-flow">  (5)</span> <span class="node">Resize</span> 150px, 600px, 1200px + keep original
      <span class="arrow-flow">  (6)</span> <span class="node">Compress</span> WebP (quality 80) + JPEG fallback (quality 85)
      <span class="arrow-flow">  (7)</span> <span class="node">Content Moderation</span> ML model / AWS Rekognition
      <span class="arrow-flow">  (8)</span> <span class="node">Watermark</span> (optional, for unverified hosts)
      <span class="arrow-flow">  (9)</span> <span class="node">Upload Variants</span> to S3 processed bucket
      <span class="arrow-flow"> (10)</span> <span class="node">Update DB</span> set status=ready, store variant keys

    On <span class="kw">failure</span>: retry up to 3 times, then move to <span class="event">[Dead Letter Queue]</span>
    On moderation <span class="kw">reject</span>: set status=rejected, notify host
  </div>

  <h3>Pipeline Stage Details</h3>

  <div class="card-grid-2">
    <div class="card">
      <h4>Stage 1: Validate</h4>
      <ul>
        <li>Verify magic bytes match declared content type</li>
        <li>Reject non-image files (e.g., renamed .exe)</li>
        <li>Check dimensions: min 600x400, max 10000x10000</li>
        <li>Check file size: max 25MB</li>
        <li>Validate image is not corrupted (can be decoded)</li>
      </ul>
    </div>
    <div class="card">
      <h4>Stage 2-3: EXIF Processing</h4>
      <ul>
        <li>Extract GPS coordinates for geo-enrichment</li>
        <li>Extract camera model and lens data</li>
        <li>Read orientation flag for auto-rotation</li>
        <li><strong>Strip GPS from guest-facing copies</strong> (privacy)</li>
        <li>Store extracted metadata in DB for internal analytics</li>
      </ul>
    </div>
    <div class="card">
      <h4>Stage 5-6: Resize &amp; Compress</h4>
      <ul>
        <li><strong>Thumbnail:</strong> 150px wide, aspect ratio preserved, WebP ~15KB</li>
        <li><strong>Medium:</strong> 600px wide, WebP quality 80 ~80KB</li>
        <li><strong>Large:</strong> 1200px wide, WebP quality 82 ~200KB</li>
        <li><strong>Original:</strong> preserved as-is for host download</li>
        <li>JPEG fallback for each size at quality 85</li>
        <li>Use libvips (not ImageMagick) for speed and memory efficiency</li>
      </ul>
    </div>
    <div class="card">
      <h4>Stage 7: Content Moderation</h4>
      <ul>
        <li>AWS Rekognition or custom ML model</li>
        <li>Detect: nudity, violence, drugs, weapons, offensive text</li>
        <li><strong>Auto-approve:</strong> confidence &lt; 30% on all categories</li>
        <li><strong>Flag for review:</strong> 30-80% confidence</li>
        <li><strong>Auto-reject:</strong> &gt; 80% confidence</li>
        <li>Rejected images never served to CDN</li>
      </ul>
    </div>
  </div>

  <div class="callout callout-purple">
    <div class="callout-title">Idempotency is Critical</div>
    <p>Every pipeline stage must be idempotent. If a worker crashes mid-processing and the message is retried, running the same stages again must produce the exact same result without duplicating S3 objects. Use deterministic S3 keys (derived from image_id + size_label) so re-uploads overwrite the same key. The final DB update uses an atomic <code>UPDATE ... WHERE status = 'processing'</code> to prevent double-completion.</p>
  </div>

  <div class="code-block">
    <span class="code-label">Worker Pseudocode</span>
<span class="kw">async function</span> <span class="fn">processImage</span>(<span class="param">message</span>) {
  <span class="kw">const</span> { imageId, s3Key, listingId } = message;

  <span class="cm">// 1. Download raw image from S3</span>
  <span class="kw">const</span> rawBuffer = <span class="kw">await</span> s3.<span class="fn">getObject</span>(RAW_BUCKET, s3Key);

  <span class="cm">// 2. Validate format and dimensions</span>
  <span class="kw">const</span> metadata = <span class="kw">await</span> sharp(rawBuffer).<span class="fn">metadata</span>();
  <span class="kw">if</span> (!ALLOWED_FORMATS.<span class="fn">includes</span>(metadata.format)) <span class="kw">throw new</span> <span class="ty">ValidationError</span>(<span class="str">'Invalid format'</span>);
  <span class="kw">if</span> (metadata.width < <span class="num">600</span> || metadata.height < <span class="num">400</span>) <span class="kw">throw new</span> <span class="ty">ValidationError</span>(<span class="str">'Too small'</span>);

  <span class="cm">// 3. Extract and strip EXIF</span>
  <span class="kw">const</span> exifData = <span class="kw">await</span> <span class="fn">extractExif</span>(rawBuffer);
  <span class="kw">const</span> oriented = <span class="kw">await</span> sharp(rawBuffer).<span class="fn">rotate</span>().<span class="fn">toBuffer</span>();  <span class="cm">// auto-orient</span>

  <span class="cm">// 4. Generate resized variants</span>
  <span class="kw">const</span> variants = [];
  <span class="kw">for</span> (<span class="kw">const</span> { label, width } <span class="kw">of</span> SIZES) {
    <span class="kw">const</span> webp = <span class="kw">await</span> sharp(oriented).<span class="fn">resize</span>(width).<span class="fn">webp</span>({ quality: <span class="num">80</span> }).<span class="fn">toBuffer</span>();
    <span class="kw">const</span> jpeg = <span class="kw">await</span> sharp(oriented).<span class="fn">resize</span>(width).<span class="fn">jpeg</span>({ quality: <span class="num">85</span> }).<span class="fn">toBuffer</span>();
    variants.<span class="fn">push</span>({ label, webp, jpeg });
  }

  <span class="cm">// 5. Content moderation</span>
  <span class="kw">const</span> modResult = <span class="kw">await</span> rekognition.<span class="fn">detectModerationLabels</span>(oriented);
  <span class="kw">if</span> (modResult.maxConfidence > <span class="num">0.8</span>) {
    <span class="kw">await</span> db.<span class="fn">updateImage</span>(imageId, { status: <span class="str">'rejected'</span>, moderation: modResult });
    <span class="kw">return</span>;  <span class="cm">// Do not upload variants</span>
  }

  <span class="cm">// 6. Upload all variants to processed bucket</span>
  <span class="kw">for</span> (<span class="kw">const</span> v <span class="kw">of</span> variants) {
    <span class="kw">await</span> s3.<span class="fn">putObject</span>(PROCESSED_BUCKET, <span class="str">`</span>${listingId}/${imageId}/${v.label}<span class="str">.webp`</span>, v.webp);
    <span class="kw">await</span> s3.<span class="fn">putObject</span>(PROCESSED_BUCKET, <span class="str">`</span>${listingId}/${imageId}/${v.label}<span class="str">.jpeg`</span>, v.jpeg);
  }

  <span class="cm">// 7. Update database atomically</span>
  <span class="kw">await</span> db.<span class="fn">updateImage</span>(imageId, {
    status: modResult.maxConfidence > <span class="num">0.3</span> ? <span class="str">'in_review'</span> : <span class="str">'ready'</span>,
    exif_data: exifData,
    moderation_status: modResult,
    variants: variants.<span class="fn">map</span>(v => ({ label: v.label, format: <span class="str">'webp'</span>, s3Key: <span class="str">`...`</span> }))
  });
}
  </div>
</section>

<!-- ================================================================ -->
<!--  6. DATA MODEL                                                   -->
<!-- ================================================================ -->
<section class="content-section" id="data-model-section">
  <span class="section-anchor" id="data-model"></span>
  <span class="section-label label-green">Section 6</span>
  <h2>Data Model</h2>

  <h3>Core Tables</h3>

  <div class="code-block">
    <span class="code-label">PostgreSQL DDL</span>
<span class="cm">-- Primary image record</span>
<span class="kw">CREATE TABLE</span> <span class="ty">images</span> (
    <span class="param">id</span>                 <span class="ty">UUID</span>          <span class="kw">PRIMARY KEY DEFAULT</span> <span class="fn">gen_random_uuid</span>(),
    <span class="param">listing_id</span>          <span class="ty">UUID</span>          <span class="kw">NOT NULL REFERENCES</span> listings(id),
    <span class="param">uploader_id</span>         <span class="ty">UUID</span>          <span class="kw">NOT NULL REFERENCES</span> users(id),
    <span class="param">status</span>              <span class="ty">VARCHAR(20)</span>   <span class="kw">NOT NULL DEFAULT</span> <span class="str">'pending'</span>,
                                          <span class="cm">-- pending | processing | ready | in_review | rejected | deleted</span>
    <span class="param">original_s3_key</span>     <span class="ty">VARCHAR(512)</span>  <span class="kw">NOT NULL</span>,
    <span class="param">width</span>               <span class="ty">INTEGER</span>,
    <span class="param">height</span>              <span class="ty">INTEGER</span>,
    <span class="param">size_bytes</span>          <span class="ty">BIGINT</span>,
    <span class="param">content_type</span>        <span class="ty">VARCHAR(50)</span>,
    <span class="param">exif_data</span>           <span class="ty">JSONB</span>,         <span class="cm">-- GPS, camera, lens, date</span>
    <span class="param">moderation_status</span>   <span class="ty">VARCHAR(20)</span>   <span class="kw">DEFAULT</span> <span class="str">'pending'</span>,
                                          <span class="cm">-- pending | approved | flagged | rejected</span>
    <span class="param">moderation_labels</span>   <span class="ty">JSONB</span>,         <span class="cm">-- [{label, confidence}]</span>
    <span class="param">sort_order</span>          <span class="ty">INTEGER</span>       <span class="kw">NOT NULL DEFAULT</span> <span class="num">0</span>,
    <span class="param">created_at</span>          <span class="ty">TIMESTAMPTZ</span>   <span class="kw">NOT NULL DEFAULT</span> <span class="fn">now</span>(),
    <span class="param">updated_at</span>          <span class="ty">TIMESTAMPTZ</span>   <span class="kw">NOT NULL DEFAULT</span> <span class="fn">now</span>(),
    <span class="param">deleted_at</span>          <span class="ty">TIMESTAMPTZ</span>   <span class="cm">-- soft delete</span>
);

<span class="kw">CREATE INDEX</span> idx_images_listing <span class="kw">ON</span> images(listing_id, sort_order) <span class="kw">WHERE</span> deleted_at <span class="kw">IS NULL</span>;
<span class="kw">CREATE INDEX</span> idx_images_status <span class="kw">ON</span> images(status) <span class="kw">WHERE</span> status <span class="kw">IN</span> (<span class="str">'processing'</span>, <span class="str">'in_review'</span>);

<span class="cm">-- Image variants (one per size per format)</span>
<span class="kw">CREATE TABLE</span> <span class="ty">image_versions</span> (
    <span class="param">id</span>                 <span class="ty">UUID</span>          <span class="kw">PRIMARY KEY DEFAULT</span> <span class="fn">gen_random_uuid</span>(),
    <span class="param">image_id</span>           <span class="ty">UUID</span>          <span class="kw">NOT NULL REFERENCES</span> images(id),
    <span class="param">size_label</span>         <span class="ty">VARCHAR(20)</span>   <span class="kw">NOT NULL</span>,
                                          <span class="cm">-- thumbnail | medium | large | original</span>
    <span class="param">format</span>             <span class="ty">VARCHAR(10)</span>   <span class="kw">NOT NULL</span>,  <span class="cm">-- webp | jpeg | avif</span>
    <span class="param">s3_key</span>             <span class="ty">VARCHAR(512)</span>  <span class="kw">NOT NULL</span>,
    <span class="param">width</span>              <span class="ty">INTEGER</span>       <span class="kw">NOT NULL</span>,
    <span class="param">height</span>             <span class="ty">INTEGER</span>       <span class="kw">NOT NULL</span>,
    <span class="param">file_size</span>          <span class="ty">BIGINT</span>        <span class="kw">NOT NULL</span>,
    <span class="param">created_at</span>         <span class="ty">TIMESTAMPTZ</span>   <span class="kw">NOT NULL DEFAULT</span> <span class="fn">now</span>()
);

<span class="kw">CREATE UNIQUE INDEX</span> idx_versions_unique <span class="kw">ON</span> image_versions(image_id, size_label, format);

<span class="cm">-- Listing-Image ordering (denormalized for fast query)</span>
<span class="kw">CREATE TABLE</span> <span class="ty">listing_images</span> (
    <span class="param">listing_id</span>         <span class="ty">UUID</span>          <span class="kw">NOT NULL REFERENCES</span> listings(id),
    <span class="param">image_id</span>           <span class="ty">UUID</span>          <span class="kw">NOT NULL REFERENCES</span> images(id),
    <span class="param">sort_order</span>         <span class="ty">INTEGER</span>       <span class="kw">NOT NULL</span>,
    <span class="kw">PRIMARY KEY</span> (listing_id, image_id)
);

<span class="kw">CREATE INDEX</span> idx_listing_images_order <span class="kw">ON</span> listing_images(listing_id, sort_order);
  </div>

  <h3>Why This Schema?</h3>
  <div class="card-grid-2">
    <div class="card">
      <h4>images Table</h4>
      <ul>
        <li>Single source of truth for image lifecycle state</li>
        <li>Soft delete via <code>deleted_at</code> allows undo and audit</li>
        <li>JSONB for EXIF and moderation labels -- schema-flexible and queryable</li>
        <li>Partial index on <code>status IN ('processing', 'in_review')</code> for fast moderation queue queries</li>
      </ul>
    </div>
    <div class="card">
      <h4>image_versions Table</h4>
      <ul>
        <li>Normalized variant storage -- easy to add new sizes (e.g., 2x retina) or formats (AVIF) later</li>
        <li>Unique constraint prevents duplicate variant rows on retry</li>
        <li>Each row has its own <code>s3_key</code>, <code>width</code>, <code>height</code>, <code>file_size</code></li>
      </ul>
    </div>
  </div>
  <div class="card">
    <h4>listing_images Join Table</h4>
    <ul>
      <li>Separate from <code>images</code> to allow reordering without updating the images table (reduces write contention)</li>
      <li>Composite primary key on <code>(listing_id, image_id)</code></li>
      <li>Index on <code>(listing_id, sort_order)</code> for fast ordered retrieval -- this is the hottest query path</li>
      <li>Reordering is an atomic batch update of <code>sort_order</code> values within a transaction</li>
    </ul>
  </div>
</section>

<!-- ================================================================ -->
<!--  7. CDN STRATEGY                                                 -->
<!-- ================================================================ -->
<section class="content-section" id="cdn-strategy-section">
  <span class="section-anchor" id="cdn-strategy"></span>
  <span class="section-label label-blue">Section 7</span>
  <h2>CDN Strategy</h2>

  <p>Image serving is the highest-throughput path in this system (~100K reads/sec). The CDN is the critical serving layer that sits between S3 and the user's browser.</p>

  <div class="card">
    <h4>URL Pattern</h4>
    <div class="code-block">
<span class="cm">// Deterministic, cache-friendly URL scheme:</span>
<span class="str">https://cdn.airbnb.com/images/{listing_id}/{image_id}/{size}.{format}</span>

<span class="cm">// Examples:</span>
<span class="str">https://cdn.airbnb.com/images/lst_123/img_abc/thumbnail.webp</span>
<span class="str">https://cdn.airbnb.com/images/lst_123/img_abc/medium.webp</span>
<span class="str">https://cdn.airbnb.com/images/lst_123/img_abc/large.jpeg</span>
<span class="str">https://cdn.airbnb.com/images/lst_123/img_abc/original.jpeg</span>

<span class="cm">// With version hash for cache busting (on reprocessing):</span>
<span class="str">https://cdn.airbnb.com/images/lst_123/img_abc/v2/medium.webp</span>
    </div>
  </div>

  <div class="card-grid-2">
    <div class="card">
      <h4>Cache Configuration</h4>
      <div class="code-block">
<span class="cm">Cache-Control Headers:</span>
<span class="kw">Cache-Control:</span> <span class="str">public, max-age=31536000, immutable</span>
<span class="cm">                ^ 1 year -- images are immutable content</span>

<span class="kw">ETag:</span> <span class="str">"d41d8cd98f00b204e9800998ecf8427e"</span>
<span class="kw">Content-Type:</span> <span class="str">image/webp</span>
<span class="kw">Vary:</span> <span class="str">Accept</span>   <span class="cm">// for content negotiation</span>
      </div>
      <ul>
        <li><strong>max-age=31536000:</strong> 1 year cache -- images never change at the same URL</li>
        <li><strong>immutable:</strong> tells browser not to revalidate on reload</li>
        <li><strong>Vary: Accept:</strong> enables format-based content negotiation at CDN edge</li>
      </ul>
    </div>
    <div class="card">
      <h4>Cache Invalidation Strategy</h4>
      <ul>
        <li><strong>URL versioning</strong> over CDN purge -- change the version segment in the URL rather than invalidating cached objects</li>
        <li>When host deletes an image, API returns updated image list with different image IDs -- old CDN entries naturally expire</li>
        <li>When reprocessing (e.g., new compression algo), bump version: <code>/v1/medium.webp</code> to <code>/v2/medium.webp</code></li>
        <li>Emergency purge via CloudFront invalidation API for DMCA takedowns or urgent moderation actions (propagates in &lt;15 min)</li>
      </ul>
    </div>
  </div>

  <h3>Content Negotiation at Edge</h3>
  <div class="card">
    <p>Modern browsers send an <code>Accept: image/webp, image/avif, image/*</code> header. We use CloudFront's <strong>Origin Request Policy</strong> to include the <code>Accept</code> header in the cache key, allowing the edge to serve different formats to different clients from the same logical URL.</p>
    <div class="code-block">
<span class="cm">// CloudFront Lambda@Edge: Origin Request Handler</span>
<span class="kw">exports</span>.handler = <span class="kw">async</span> (<span class="param">event</span>) => {
  <span class="kw">const</span> request = event.Records[<span class="num">0</span>].cf.request;
  <span class="kw">const</span> accept = request.headers[<span class="str">'accept'</span>]?.[<span class="num">0</span>]?.value || <span class="str">''</span>;

  <span class="kw">if</span> (accept.<span class="fn">includes</span>(<span class="str">'image/avif'</span>)) {
    request.uri = request.uri.<span class="fn">replace</span>(<span class="str">/\.webp$/</span>, <span class="str">'.avif'</span>);
  } <span class="kw">else if</span> (!accept.<span class="fn">includes</span>(<span class="str">'image/webp'</span>)) {
    request.uri = request.uri.<span class="fn">replace</span>(<span class="str">/\.webp$/</span>, <span class="str">'.jpeg'</span>);
  }
  <span class="cm">// else: serve .webp as requested</span>

  <span class="kw">return</span> request;
};
    </div>
  </div>

  <div class="callout callout-blue">
    <div class="callout-title">CDN Architecture at Airbnb's Scale</div>
    <p>With ~100K image reads/sec and a 95%+ CDN cache hit ratio, only ~5K requests/sec reach S3 origin. CloudFront's 450+ edge locations ensure sub-100ms delivery globally. For regions with poor CloudFront coverage (e.g., parts of Africa, South Asia), consider a multi-CDN strategy with Cloudflare or Akamai as secondary.</p>
  </div>
</section>

<!-- ================================================================ -->
<!--  8. API DESIGN                                                   -->
<!-- ================================================================ -->
<section class="content-section" id="api-design-section">
  <span class="section-anchor" id="api-design"></span>
  <span class="section-label label-orange">Section 8</span>
  <h2>API Design</h2>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Method</th>
          <th>Endpoint</th>
          <th>Description</th>
          <th>Auth</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><span class="badge badge-green">POST</span></td>
          <td><code>/api/v1/listings/:id/images/upload-url</code></td>
          <td>Generate presigned S3 upload URL(s)</td>
          <td>Host (owner)</td>
        </tr>
        <tr>
          <td><span class="badge badge-green">POST</span></td>
          <td><code>/api/v1/listings/:id/images/confirm</code></td>
          <td>Confirm upload completion, trigger processing</td>
          <td>Host (owner)</td>
        </tr>
        <tr>
          <td><span class="badge badge-blue">GET</span></td>
          <td><code>/api/v1/listings/:id/images</code></td>
          <td>List all images for listing (ordered)</td>
          <td>Public (guests) / Host</td>
        </tr>
        <tr>
          <td><span class="badge badge-yellow">PUT</span></td>
          <td><code>/api/v1/listings/:id/images/reorder</code></td>
          <td>Update sort order for all images</td>
          <td>Host (owner)</td>
        </tr>
        <tr>
          <td><span class="badge badge-red">DELETE</span></td>
          <td><code>/api/v1/listings/:id/images/:image_id</code></td>
          <td>Soft-delete image from listing</td>
          <td>Host (owner)</td>
        </tr>
        <tr>
          <td><span class="badge badge-blue">GET</span></td>
          <td><code>/api/v1/listings/:id/images/:image_id</code></td>
          <td>Get single image metadata + variant URLs</td>
          <td>Public / Host</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h3>Request / Response Examples</h3>

  <div class="card-grid-2">
    <div class="card">
      <h4>GET /api/v1/listings/:id/images</h4>
      <div class="code-block">
<span class="cm">// Response</span>
{
  <span class="str">"listing_id"</span>: <span class="str">"lst_123"</span>,
  <span class="str">"images"</span>: [
    {
      <span class="str">"id"</span>: <span class="str">"img_abc"</span>,
      <span class="str">"sort_order"</span>: <span class="num">0</span>,
      <span class="str">"status"</span>: <span class="str">"ready"</span>,
      <span class="str">"width"</span>: <span class="num">4032</span>,
      <span class="str">"height"</span>: <span class="num">3024</span>,
      <span class="str">"urls"</span>: {
        <span class="str">"thumbnail"</span>: <span class="str">"https://cdn.airbnb.com/images/lst_123/img_abc/thumbnail.webp"</span>,
        <span class="str">"medium"</span>: <span class="str">"https://cdn.airbnb.com/images/lst_123/img_abc/medium.webp"</span>,
        <span class="str">"large"</span>: <span class="str">"https://cdn.airbnb.com/images/lst_123/img_abc/large.webp"</span>
      }
    },
    ...
  ],
  <span class="str">"total"</span>: <span class="num">15</span>
}
      </div>
    </div>
    <div class="card">
      <h4>PUT /api/v1/listings/:id/images/reorder</h4>
      <div class="code-block">
<span class="cm">// Request</span>
{
  <span class="str">"image_order"</span>: [
    { <span class="str">"image_id"</span>: <span class="str">"img_xyz"</span>, <span class="str">"sort_order"</span>: <span class="num">0</span> },
    { <span class="str">"image_id"</span>: <span class="str">"img_abc"</span>, <span class="str">"sort_order"</span>: <span class="num">1</span> },
    { <span class="str">"image_id"</span>: <span class="str">"img_def"</span>, <span class="str">"sort_order"</span>: <span class="num">2</span> }
  ]
}

<span class="cm">// Response</span>
{
  <span class="str">"status"</span>: <span class="str">"ok"</span>,
  <span class="str">"reordered"</span>: <span class="num">3</span>
}

<span class="cm">// Implementation: single transaction</span>
<span class="cm">// UPDATE listing_images</span>
<span class="cm">//   SET sort_order = CASE ...</span>
<span class="cm">//   WHERE listing_id = :id</span>
      </div>
    </div>
  </div>

  <div class="card">
    <h4>POST /api/v1/listings/:id/images/upload-url (Bulk)</h4>
    <div class="code-block">
<span class="cm">// Request: Bulk presigned URL generation</span>
{
  <span class="str">"files"</span>: [
    { <span class="str">"file_name"</span>: <span class="str">"kitchen.jpg"</span>, <span class="str">"content_type"</span>: <span class="str">"image/jpeg"</span>, <span class="str">"file_size"</span>: <span class="num">3200000</span> },
    { <span class="str">"file_name"</span>: <span class="str">"bedroom.jpg"</span>, <span class="str">"content_type"</span>: <span class="str">"image/jpeg"</span>, <span class="str">"file_size"</span>: <span class="num">4100000</span> },
    { <span class="str">"file_name"</span>: <span class="str">"pool.png"</span>,    <span class="str">"content_type"</span>: <span class="str">"image/png"</span>,  <span class="str">"file_size"</span>: <span class="num">6800000</span> }
  ]
}

<span class="cm">// Response</span>
{
  <span class="str">"uploads"</span>: [
    { <span class="str">"image_id"</span>: <span class="str">"img_001"</span>, <span class="str">"upload_url"</span>: <span class="str">"https://s3..."</span>, <span class="str">"expires_at"</span>: <span class="str">"..."</span> },
    { <span class="str">"image_id"</span>: <span class="str">"img_002"</span>, <span class="str">"upload_url"</span>: <span class="str">"https://s3..."</span>, <span class="str">"expires_at"</span>: <span class="str">"..."</span> },
    { <span class="str">"image_id"</span>: <span class="str">"img_003"</span>, <span class="str">"upload_url"</span>: <span class="str">"https://s3..."</span>, <span class="str">"expires_at"</span>: <span class="str">"..."</span> }
  ]
}

<span class="cm">// Validation:</span>
<span class="cm">// - Listing must belong to authenticated host</span>
<span class="cm">// - Total images (existing + new) must not exceed 50</span>
<span class="cm">// - Each file must be an allowed content type</span>
<span class="cm">// - Each file must be under 25MB</span>
    </div>
  </div>
</section>

<!-- ================================================================ -->
<!--  9. CONTENT MODERATION                                           -->
<!-- ================================================================ -->
<section class="content-section" id="content-moderation-section">
  <span class="section-anchor" id="content-moderation"></span>
  <span class="section-label label-red">Section 9</span>
  <h2>Content Moderation</h2>

  <p>Every uploaded image passes through content moderation before being marked as <code>ready</code>. This is a safety-critical component -- serving inappropriate content damages brand trust and may have legal implications.</p>

  <div class="card-grid-2">
    <div class="card">
      <h4>Detection Categories</h4>
      <ul>
        <li><strong>Nudity / Explicit content:</strong> Primary concern for a family-friendly platform</li>
        <li><strong>Violence / Graphic imagery:</strong> Weapons, blood, disturbing scenes</li>
        <li><strong>Text overlay spam:</strong> Phone numbers, URLs, pricing overlays that violate listing policies</li>
        <li><strong>Copyright / Watermarks:</strong> Stock photo watermarks indicating stolen images</li>
        <li><strong>Misleading content:</strong> Images from other listings (detected via perceptual hash)</li>
        <li><strong>Off-topic:</strong> Memes, screenshots, non-property images</li>
      </ul>
    </div>
    <div class="card">
      <h4>Decision Thresholds</h4>
      <div class="table-wrapper" style="margin-top:0;">
        <table>
          <thead>
            <tr><th>Confidence</th><th>Action</th><th>User Impact</th></tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>&lt; 30%</strong></td>
              <td><span class="badge badge-green">Auto-Approve</span></td>
              <td>Image immediately visible on listing</td>
            </tr>
            <tr>
              <td><strong>30% - 80%</strong></td>
              <td><span class="badge badge-yellow">Flag for Review</span></td>
              <td>Image visible but queued for human review</td>
            </tr>
            <tr>
              <td><strong>&gt; 80%</strong></td>
              <td><span class="badge badge-red">Auto-Reject</span></td>
              <td>Image blocked, host notified with reason</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <h3>Human Review Pipeline</h3>
  <div class="card">
    <div class="flow-diagram">
<span class="node">[Flagged Image]</span> <span class="arrow-flow">---></span> <span class="event">[Moderation Queue (SQS)]</span> <span class="arrow-flow">---></span> <span class="node">[Human Review Tool]</span>

<span class="node">[Reviewer]</span> sees:
  - Original image + ML labels with confidence scores
  - Listing context (location, property type, host history)
  - Previous moderation decisions for this host

<span class="node">[Decision]</span>:
  <span class="arrow-flow">--- Approve ---></span> status = <span class="str">'ready'</span>, moderation = <span class="str">'approved'</span>
  <span class="arrow-flow">--- Reject  ---></span> status = <span class="str">'rejected'</span>, notify host with reason + appeal link
  <span class="arrow-flow">--- Escalate --></span> send to senior reviewer for edge cases

<span class="node">[Appeal Process]</span>:
  Host disputes rejection <span class="arrow-flow">---></span> Re-queued with higher priority
  Second reviewer makes final decision (overrides first)
    </div>
  </div>

  <div class="callout callout-red">
    <div class="callout-title">Moderation Latency vs. Safety Trade-off</div>
    <p>Auto-approved images (confidence &lt; 30%) are visible immediately. Flagged images (30-80%) are a design decision: do we show them while awaiting review, or block until approved? Airbnb's approach is to <strong>show flagged images with a slight delay</strong> (they enter the CDN after 5 minutes, giving the ML pipeline time to complete), balancing host experience with safety. Auto-rejected images are never served.</p>
  </div>
</section>

<!-- ================================================================ -->
<!--  10. TRADE-OFFS                                                  -->
<!-- ================================================================ -->
<section class="content-section" id="trade-offs-section">
  <span class="section-anchor" id="trade-offs"></span>
  <span class="section-label label-yellow">Section 10</span>
  <h2>Architecture Trade-offs</h2>

  <div class="tradeoff-card">
    <h4>Presigned URL Upload <span class="vs">VS</span> Proxy Upload Through App Server</h4>
    <div class="tradeoff-row">
      <div class="tradeoff-option chosen">
        <h5>Presigned URL (Chosen)</h5>
        <ul>
          <li>Binary data never touches app servers</li>
          <li>Scales independently -- S3 handles bandwidth</li>
          <li>Supports multipart/resumable uploads natively</li>
          <li>Lower infra cost (no large instances for buffering)</li>
          <li>Adds complexity: 2-step flow (get URL, then upload)</li>
        </ul>
      </div>
      <div class="tradeoff-option">
        <h5>Proxy Upload</h5>
        <ul>
          <li>Simpler client implementation (single POST)</li>
          <li>Easier to validate and transform on-the-fly</li>
          <li>App servers become bandwidth bottleneck</li>
          <li>Requires large instance types and high memory</li>
          <li>Load balancer body size limits become an issue</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="tradeoff-card">
    <h4>Synchronous Processing <span class="vs">VS</span> Asynchronous Pipeline</h4>
    <div class="tradeoff-row">
      <div class="tradeoff-option">
        <h5>Synchronous</h5>
        <ul>
          <li>Immediate feedback to host</li>
          <li>Simpler architecture (no queues)</li>
          <li>Blocking -- ties up server resources</li>
          <li>Cannot scale processing independently</li>
          <li>Timeout issues for large images</li>
        </ul>
      </div>
      <div class="tradeoff-option chosen">
        <h5>Asynchronous (Chosen)</h5>
        <ul>
          <li>Upload completes instantly (host gets confirmation)</li>
          <li>Processing workers scale independently</li>
          <li>Retryable with DLQ for failures</li>
          <li>Can add pipeline stages without changing upload flow</li>
          <li>Host sees "processing" state briefly</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="tradeoff-card">
    <h4>Eager Resizing <span class="vs">VS</span> Lazy (On-Demand) Resizing</h4>
    <div class="tradeoff-row">
      <div class="tradeoff-option chosen">
        <h5>Eager Resizing (Chosen)</h5>
        <ul>
          <li>All variants pre-computed on upload</li>
          <li>CDN serves static files (maximum cache hit ratio)</li>
          <li>Predictable latency -- no compute on read path</li>
          <li>Higher storage cost (store all variants)</li>
          <li>Must reprocess all if resolutions change</li>
        </ul>
      </div>
      <div class="tradeoff-option">
        <h5>Lazy (On-Demand) Resizing</h5>
        <ul>
          <li>Only generate what is actually requested</li>
          <li>Lower storage cost</li>
          <li>First request is slow (compute + cache miss)</li>
          <li>Requires compute at CDN edge or origin proxy</li>
          <li>Thundering herd on cold images (e.g., new search results page)</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="tradeoff-card">
    <h4>WebP Only <span class="vs">VS</span> Multi-Format (WebP + JPEG + AVIF)</h4>
    <div class="tradeoff-row">
      <div class="tradeoff-option">
        <h5>WebP Only</h5>
        <ul>
          <li>Simpler pipeline (one output format)</li>
          <li>~30% smaller than JPEG at same quality</li>
          <li>97%+ browser support in 2024</li>
          <li>Still breaks for very old browsers / embedded webviews</li>
        </ul>
      </div>
      <div class="tradeoff-option chosen">
        <h5>Multi-Format (Chosen)</h5>
        <ul>
          <li>WebP as default, JPEG fallback, AVIF for cutting-edge</li>
          <li>Content negotiation via Accept header at CDN</li>
          <li>3x storage per variant (but thumbnails/medium are tiny)</li>
          <li>Future-proof as AVIF adoption grows</li>
          <li>Best user experience across all devices</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="card-grid-2">
    <div class="tradeoff-card">
      <h4>S3 Direct <span class="vs">VS</span> Dedicated Image Service (e.g., Imgix, Cloudinary)</h4>
      <p style="color: var(--text-muted); font-size: 0.9em;">At Airbnb's scale, a custom pipeline built on S3 gives full control over processing logic, moderation integration, cost optimization, and data sovereignty. Managed services like Imgix are excellent for smaller companies but become expensive at 100M+ images and add a vendor dependency for a core product feature.</p>
    </div>
    <div class="tradeoff-card">
      <h4>Client-Side <span class="vs">VS</span> Server-Side Compression</h4>
      <p style="color: var(--text-muted); font-size: 0.9em;">Client-side compression (e.g., browser-based resize before upload) reduces upload bandwidth but varies across devices and cannot be trusted for quality. Server-side compression ensures consistent quality and allows format-specific optimization (WebP, AVIF). Best approach: light client-side resize for very large images (&gt;15MB) combined with full server-side processing pipeline.</p>
    </div>
  </div>
</section>

<!-- ================================================================ -->
<!--  11. DEEP DIVES                                                  -->
<!-- ================================================================ -->
<section class="content-section" id="deep-dives-section">
  <span class="section-anchor" id="deep-dives"></span>
  <span class="section-label label-purple">Section 11</span>
  <h2>Deep Dives</h2>

  <h3>Resumable Uploads (tus Protocol)</h3>
  <div class="card">
    <p>For mobile users on unreliable networks, large uploads (10MB+) frequently fail mid-transfer. The <strong>tus protocol</strong> (or S3 multipart upload) enables resumable uploads.</p>
    <div class="code-block">
<span class="cm">// tus resumable upload protocol flow:</span>

<span class="cm">1. Client creates upload:</span>
<span class="kw">POST</span> /uploads
<span class="str">Tus-Resumable: 1.0.0</span>
<span class="str">Upload-Length: 10485760</span>      <span class="cm">// 10 MB</span>
<span class="str">Upload-Metadata: filename a2l0Y2hlbi5qcGc=</span>
<span class="arrow-flow">--> 201 Created</span>
<span class="str">Location: /uploads/abc123</span>

<span class="cm">2. Client sends chunks:</span>
<span class="kw">PATCH</span> /uploads/abc123
<span class="str">Upload-Offset: 0</span>
<span class="str">Content-Length: 5242880</span>     <span class="cm">// first 5 MB chunk</span>
[binary data]
<span class="arrow-flow">--> 204 No Content</span>
<span class="str">Upload-Offset: 5242880</span>

<span class="cm">3. On network failure, client queries progress:</span>
<span class="kw">HEAD</span> /uploads/abc123
<span class="arrow-flow">--> 200</span>
<span class="str">Upload-Offset: 5242880</span>      <span class="cm">// resume from 5 MB</span>

<span class="cm">4. Client resumes:</span>
<span class="kw">PATCH</span> /uploads/abc123
<span class="str">Upload-Offset: 5242880</span>
<span class="str">Content-Length: 5242880</span>     <span class="cm">// remaining 5 MB</span>
[binary data]
<span class="arrow-flow">--> 204 No Content</span>
    </div>
    <p>For S3 specifically, use <strong>S3 Multipart Upload</strong>: split file into 5MB parts, upload each part independently, complete multipart upload. Failed parts can be retried without re-uploading successful ones.</p>
  </div>

  <h3>Duplicate Detection (Perceptual Hashing)</h3>
  <div class="card">
    <p>Hosts sometimes upload the same photo multiple times, or copy images from other listings. <strong>Perceptual hashing</strong> (pHash, dHash) generates a fingerprint that is resistant to minor edits (resize, compression, color adjustment).</p>
    <div class="card-grid-2">
      <div>
        <h4>How It Works</h4>
        <ul>
          <li>Resize image to 8x8 grayscale</li>
          <li>Compute DCT (Discrete Cosine Transform)</li>
          <li>Generate 64-bit hash from low-frequency components</li>
          <li>Compare hashes via Hamming distance</li>
          <li>Distance &lt; 5 bits = likely duplicate</li>
        </ul>
      </div>
      <div>
        <h4>Use Cases</h4>
        <ul>
          <li><strong>Same-listing dedup:</strong> Prevent host from uploading identical photo twice</li>
          <li><strong>Cross-listing detection:</strong> Flag if image appears on another listing (fraud indicator)</li>
          <li><strong>Stock photo detection:</strong> Maintain a hash database of known stock photos</li>
          <li>Store pHash in the <code>images</code> table for fast lookups</li>
        </ul>
      </div>
    </div>
  </div>

  <h3>EXIF Privacy Stripping</h3>
  <div class="card">
    <p>Raw photos from smartphones contain EXIF metadata including <strong>GPS coordinates</strong>, device serial numbers, and timestamps. Serving these to guests would expose the exact property location before booking and leak device information.</p>
    <ul>
      <li><strong>Extract before stripping:</strong> Store GPS, camera model, and date in the database for internal use (geo-enrichment, fraud detection, photo quality scoring)</li>
      <li><strong>Strip from all guest-facing variants:</strong> Remove all EXIF tags except orientation (which is baked into pixel data during auto-orient)</li>
      <li><strong>Preserve for host download:</strong> The "original" variant downloaded by the host retains full EXIF</li>
    </ul>
  </div>

  <h3>Progressive JPEG Loading</h3>
  <div class="card">
    <p>For large images (especially the "large" 1200px variant), <strong>progressive JPEG encoding</strong> renders a blurry preview immediately, then sharpens as more data arrives. This dramatically improves perceived performance on slow connections.</p>
    <div class="card-grid-2">
      <div>
        <h4>Baseline JPEG</h4>
        <ul>
          <li>Renders top-to-bottom as data arrives</li>
          <li>User sees blank space until fully loaded</li>
          <li>Smaller file size (~5% less than progressive)</li>
        </ul>
      </div>
      <div>
        <h4>Progressive JPEG (Recommended)</h4>
        <ul>
          <li>Renders full image at low quality immediately</li>
          <li>Quality improves in multiple passes</li>
          <li>Better UX on slow connections</li>
          <li>Slightly larger but compresses better with gzip</li>
        </ul>
      </div>
    </div>
    <p>For WebP, the equivalent is the <strong>alpha channel progressive decode</strong>. For AVIF, progressive rendering is built into the AV1 codec via layered encoding.</p>
  </div>

  <h3>Image Deduplication Across Listings</h3>
  <div class="card">
    <p>At 105M images, significant storage can be saved through content-addressed storage. If two hosts upload the exact same image (bit-for-bit identical), we can store it once and reference it from both listings.</p>
    <div class="code-block">
<span class="cm">// Content-addressed storage approach:</span>
<span class="cm">// 1. On upload, compute SHA-256 of raw file</span>
<span class="kw">const</span> hash = crypto.<span class="fn">createHash</span>(<span class="str">'sha256'</span>).<span class="fn">update</span>(buffer).<span class="fn">digest</span>(<span class="str">'hex'</span>);

<span class="cm">// 2. Check if hash already exists in images table</span>
<span class="kw">const</span> existing = <span class="kw">await</span> db.<span class="fn">query</span>(
  <span class="str">'SELECT id FROM images WHERE content_hash = $1'</span>,
  [hash]
);

<span class="cm">// 3. If exists, create a reference (no re-processing needed)</span>
<span class="kw">if</span> (existing) {
  <span class="kw">await</span> db.<span class="fn">query</span>(
    <span class="str">'INSERT INTO listing_images (listing_id, image_id, sort_order) VALUES ($1, $2, $3)'</span>,
    [listingId, existing.id, nextOrder]
  );
  <span class="kw">return</span>;  <span class="cm">// Skip processing pipeline entirely</span>
}

<span class="cm">// 4. If not, proceed with normal processing</span>
<span class="cm">// Note: This only works for exact duplicates.</span>
<span class="cm">// For near-duplicates, use perceptual hashing (previous section)</span>
    </div>
    <p><strong>Caveat:</strong> At Airbnb's scale, exact duplicates are relatively rare across different hosts. The storage savings (~2-5%) may not justify the added complexity. Perceptual hashing for fraud detection provides more value.</p>
  </div>
</section>

<!-- ================================================================ -->
<!--  12. INTERVIEW TIPS                                              -->
<!-- ================================================================ -->
<section class="content-section" id="interview-tips-section">
  <span class="section-anchor" id="interview-tips"></span>
  <span class="section-label label-success">Section 12</span>
  <h2>Interview Tips &amp; Calibration</h2>

  <h3>Level Calibration</h3>
  <div class="card-grid-3">
    <div class="tip-card">
      <h4>Mid-Level (L4/E4)</h4>
      <ul>
        <li>Identifies presigned URL pattern</li>
        <li>Describes basic upload + resize flow</li>
        <li>Mentions S3 + CDN</li>
        <li>Basic API design</li>
        <li>Simple data model</li>
      </ul>
    </div>
    <div class="tip-card">
      <h4>Senior (L5/E5)</h4>
      <ul>
        <li>Async pipeline with event-driven architecture</li>
        <li>Multi-format strategy (WebP + JPEG fallback)</li>
        <li>Content negotiation at CDN edge</li>
        <li>Idempotent processing with DLQ</li>
        <li>Content moderation integration</li>
        <li>Cache invalidation via URL versioning</li>
      </ul>
    </div>
    <div class="tip-card">
      <h4>Staff/Principal (L6+/E6+)</h4>
      <ul>
        <li>Resumable uploads (tus / multipart)</li>
        <li>Perceptual hashing for dedup + fraud</li>
        <li>EXIF privacy stripping trade-offs</li>
        <li>Progressive JPEG / layered AVIF rendering</li>
        <li>Multi-CDN strategy for global coverage</li>
        <li>Cost analysis at 2PB scale</li>
        <li>Handles edge cases (race conditions in reorder, partial failures in bulk upload)</li>
      </ul>
    </div>
  </div>

  <h3>Key Signals Interviewers Look For</h3>
  <div class="card-grid-2">
    <div class="card">
      <h4>Strong Signals</h4>
      <ul>
        <li><strong>Presigned URL pattern</strong> -- shows you understand not to proxy large binaries through app servers</li>
        <li><strong>Async processing</strong> -- decoupling upload from processing is fundamental</li>
        <li><strong>Immutable URLs + long cache</strong> -- understanding that images are immutable content and should be cached aggressively</li>
        <li><strong>Content negotiation</strong> -- serving the right format for the right browser</li>
        <li><strong>Moderation before serving</strong> -- safety awareness is critical for a platform like Airbnb</li>
        <li><strong>Capacity estimation</strong> -- demonstrating you can reason about storage, bandwidth, and throughput at scale</li>
      </ul>
    </div>
    <div class="card">
      <h4>Red Flags</h4>
      <ul>
        <li><strong>Proxying uploads through app server</strong> -- shows inexperience with large file handling</li>
        <li><strong>Synchronous processing</strong> -- blocks the upload response and does not scale</li>
        <li><strong>No content moderation</strong> -- missing a critical safety requirement</li>
        <li><strong>No CDN discussion</strong> -- ignoring the read-heavy nature of the system</li>
        <li><strong>No cache strategy</strong> -- not thinking about cache headers and invalidation</li>
        <li><strong>Storing images in the database</strong> -- BLOB storage in Postgres is a non-starter at this scale</li>
      </ul>
    </div>
  </div>

  <h3>How to Structure Your Answer (45-min Interview)</h3>
  <div class="card">
    <div class="table-wrapper">
      <table>
        <thead>
          <tr><th>Time</th><th>Phase</th><th>What to Cover</th></tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>0-5 min</strong></td>
            <td>Clarify Requirements</td>
            <td>Scope (images only, not video), who uploads (hosts), scale (50K/day), key SLAs (&lt;5s upload, &lt;30s processing, &lt;100ms CDN serve)</td>
          </tr>
          <tr>
            <td><strong>5-10 min</strong></td>
            <td>High-Level Design</td>
            <td>Draw the end-to-end flow: Client -> Presigned URL -> S3 -> Event -> Processing Workers -> Processed S3 -> CDN -> Guest. Identify key components.</td>
          </tr>
          <tr>
            <td><strong>10-15 min</strong></td>
            <td>Capacity Estimation</td>
            <td>7M listings, 15 images each, 105M total. 50K uploads/day. 4 variants x ~8MB = ~400GB/day. ~2PB total. Read-heavy (100K reads/sec vs 6 writes/sec).</td>
          </tr>
          <tr>
            <td><strong>15-25 min</strong></td>
            <td>Detailed Design</td>
            <td>Upload flow (presigned URLs), processing pipeline stages, data model (images + image_versions + listing_images), CDN strategy (cache headers, content negotiation).</td>
          </tr>
          <tr>
            <td><strong>25-35 min</strong></td>
            <td>Deep Dives</td>
            <td>Content moderation (thresholds, human review), API design, format strategy (WebP/AVIF/JPEG), cache invalidation approach.</td>
          </tr>
          <tr>
            <td><strong>35-45 min</strong></td>
            <td>Trade-offs &amp; Extensions</td>
            <td>Eager vs lazy resizing, resumable uploads, perceptual hashing, EXIF privacy, progressive rendering. Show you can go deeper on any topic the interviewer probes.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="callout callout-green">
    <div class="callout-title">Pro Tips for This Specific Question</div>
    <ul>
      <li><strong>Lead with the presigned URL pattern.</strong> This immediately signals seniority. Explain why: bandwidth offloading, scalability, resumability.</li>
      <li><strong>Draw the async pipeline early.</strong> The S3 event -> Queue -> Worker pattern is the backbone. Make it visible on the whiteboard.</li>
      <li><strong>Don't forget moderation.</strong> Many candidates skip this. Bring it up proactively -- it shows product thinking.</li>
      <li><strong>Discuss the read path, not just the write path.</strong> CDN configuration, cache headers, and content negotiation are where the real scale challenge lies (100K reads/sec).</li>
      <li><strong>Know your image formats.</strong> Being able to discuss WebP vs AVIF vs JPEG trade-offs (compression ratio, browser support, encoding speed) is a differentiator.</li>
      <li><strong>Have a clear opinion on eager vs lazy resizing</strong> and be ready to defend it with data (CDN cache hit ratio, cold-start latency, storage cost).</li>
    </ul>
  </div>
</section>

</div>

<!-- ================================================================ -->
<!--  FOOTER                                                          -->
<!-- ================================================================ -->
<div class="footer">
  <p><a href="index.html">&#8592; Back to All Topics</a> &nbsp;|&nbsp; Topic 12 of 18</p>
  <p style="margin-top: 8px;">Airbnb System Design Interview Preparation &mdash; Image Ingestion Pipeline</p>
</div>

<script>
(function(){
  document.querySelectorAll(".diagram-box").forEach(function(box){
    var svg=box.querySelector("svg");
    if(!svg) return;
    var zoom=1, minZ=0.5, maxZ=3;
    var ctrl=document.createElement("div");
    ctrl.className="diagram-zoom-controls";
    ctrl.innerHTML='<button class="zoom-out" title="Zoom Out"></button><span class="zoom-level">100%</span><button class="zoom-in" title="Zoom In">+</button><button class="zoom-reset" title="Reset"></button><button class="zoom-fs" title="Fullscreen"></button>';
    box.insertBefore(ctrl,box.firstChild);
    var lvl=ctrl.querySelector(".zoom-level");
    function apply(){svg.style.transform="scale("+zoom+")";lvl.textContent=Math.round(zoom*100)+"%";}
    ctrl.querySelector(".zoom-in").onclick=function(){zoom=Math.min(maxZ,zoom+0.25);apply();};
    ctrl.querySelector(".zoom-out").onclick=function(){zoom=Math.max(minZ,zoom-0.25);apply();};
    ctrl.querySelector(".zoom-reset").onclick=function(){zoom=1;apply();};
    ctrl.querySelector(".zoom-fs").onclick=function(){
      box.classList.toggle("fullscreen");
      if(box.classList.contains("fullscreen")){this.textContent="";zoom=1.2;}else{this.textContent="";zoom=1;}
      apply();
    };
    box.addEventListener("wheel",function(e){
      if(e.ctrlKey){e.preventDefault();zoom=e.deltaY<0?Math.min(maxZ,zoom+0.1):Math.max(minZ,zoom-0.1);apply();}
    },{passive:false});
  });
})();
</script>
</body>
</html>
