<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multi-Tenant Vector Database - Airbnb System Design</title>
<style>
  :root {
    --primary: #FF5A5F;
    --primary-dark: #E04850;
    --secondary: #00A699;
    --accent: #FC642D;
    --purple: #7B2FF7;
    --blue: #428BF9;
    --dark: #ffffff;
    --darker: #f1f5f9;
    --card-bg: #ffffff;
    --card-border: #e2e8f0;
    --text: #1e293b;
    --text-muted: #4b5563;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--dark);
    color: var(--text);
    line-height: 1.7;
    scroll-behavior: smooth;
  }

  /* ===== HERO ===== */
  .hero {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #6B73FF 100%);
    padding: 70px 40px 60px;
    text-align: center;
    border-bottom: 3px solid var(--primary);
    position: relative;
    overflow: hidden;
  }
  .hero::before {
    content: '';
    position: absolute;
    top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: radial-gradient(circle at 30% 50%, rgba(123,47,247,0.1) 0%, transparent 50%),
                radial-gradient(circle at 70% 50%, rgba(0,166,153,0.15) 0%, transparent 50%),
                radial-gradient(circle at 50% 80%, rgba(66,139,249,0.06) 0%, transparent 40%);
    animation: pulse 8s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
  .hero .back-link {
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: #ffffff;
    text-decoration: none;
    font-size: 0.95em;
    font-weight: 600;
    padding: 10px 24px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.4);
    background: rgba(255,255,255,0.15);
    transition: all 0.3s;
    margin-bottom: 20px;
  }
  .hero .back-link:hover {
    background: rgba(255,255,255,0.25);
    border-color: #e5e7eb;
    transform: translateX(-3px);
  }
  .hero .topic-number-hero {
    position: relative;
    display: inline-block;
    font-size: 1em;
    font-weight: 800;
    color: var(--purple);
    background: rgba(123,47,247,0.15);
    border: 1px solid rgba(123,47,247,0.3);
    padding: 4px 18px;
    border-radius: 20px;
    margin-bottom: 14px;
    letter-spacing: 1px;
  }
  .hero h1 {
    font-size: 2.6em;
    background: linear-gradient(135deg, var(--purple), var(--blue), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    position: relative;
    margin-bottom: 12px;
    line-height: 1.2;
  }
  .hero .subtitle {
    font-size: 1.2em;
    color: rgba(255,255,255,0.9);
    position: relative;
    margin-bottom: 24px;
    max-width: 750px;
    margin-left: auto;
    margin-right: auto;
  }
  .hero .stats-row {
    position: relative;
    display: flex;
    justify-content: center;
    gap: 30px;
    margin-top: 24px;
    flex-wrap: wrap;
  }
  .hero .stat-item { text-align: center; }
  .hero .stat-value {
    font-size: 1.8em;
    font-weight: 800;
    color: var(--primary);
  }
  .hero .stat-label {
    font-size: 0.78em;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1.5px;
  }
  .hero-badges {
    position: relative;
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
  }

  /* ===== BADGES ===== */
  .badge {
    display: inline-block;
    padding: 4px 14px;
    border-radius: 20px;
    font-size: 0.75em;
    font-weight: 600;
    margin: 3px 2px;
    white-space: nowrap;
  }
  .badge-red { background: rgba(255,255,255,0.15); color: #ffffff; border: 1px solid rgba(255,255,255,0.3); }
  .badge-green { background: rgba(0,166,153,0.2); color: #ffffff; border: 1px solid var(--secondary); }
  .badge-blue { background: rgba(255,255,255,0.15); color: #ffffff; border: 1px solid rgba(255,255,255,0.3); }
  .badge-purple { background: rgba(255,255,255,0.15); color: #ffffff; border: 1px solid rgba(255,255,255,0.3); }
  .badge-orange { background: rgba(255,255,255,0.15); color: #ffffff; border: 1px solid rgba(255,255,255,0.3); }

  /* ===== NAV ===== */
  .nav-bar {
    background: #f8fafc;
    padding: 18px 40px;
    border-bottom: 1px solid var(--card-border);
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(12px);
  }
  .nav-bar h2 {
    color: var(--secondary);
    margin-bottom: 12px;
    font-size: 0.8em;
    text-transform: uppercase;
    letter-spacing: 2px;
  }
  .nav-links {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }
  .nav-links a {
    color: var(--text-muted);
    text-decoration: none;
    padding: 6px 14px;
    border-radius: 8px;
    background: var(--card-bg);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    font-size: 0.8em;
    transition: all 0.3s;
  }
  .nav-links a:hover {
    color: var(--primary);
    border-color: var(--primary);
    background: rgba(255,90,95,0.1);
  }

  /* ===== CONTAINER ===== */
  .container { max-width: 1100px; margin: 0 auto; padding: 0 30px; }

  /* ===== SECTION ===== */
  .section { padding: 50px 0 30px; }
  .section + .section { border-top: 1px solid #e5e7eb; }
  .section-label {
    display: inline-block;
    font-size: 0.72em;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 2.5px;
    color: var(--secondary);
    background: rgba(0,166,153,0.1);
    border: 1px solid rgba(0,166,153,0.25);
    padding: 4px 14px;
    border-radius: 6px;
    margin-bottom: 14px;
  }
  .section h2 {
    font-size: 1.9em;
    color: var(--text);
    margin-bottom: 20px;
    line-height: 1.25;
  }
  .section h3 {
    font-size: 1.3em;
    color: var(--primary);
    margin: 24px 0 12px;
  }
  .section h4 {
    font-size: 1.05em;
    color: var(--blue);
    margin: 18px 0 10px;
  }
  .section p, .section li {
    color: var(--text-muted);
    font-size: 0.95em;
    line-height: 1.75;
  }
  .section ul, .section ol {
    padding-left: 24px;
    margin: 10px 0;
  }
  .section li { margin-bottom: 6px; }
  .section li strong { color: var(--text); }

  /* ===== CARDS ===== */
  .card {
    background: var(--card-bg);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 14px;
    padding: 24px 28px;
    margin: 16px 0;
    transition: border-color 0.3s;
  }
  .card:hover { border-color: rgba(255,90,95,0.3); }
  .card h4 { margin-top: 0; }

  /* ===== GRID LAYOUTS ===== */
  .grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin: 16px 0;
  }
  .grid-3 {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 16px;
    margin: 16px 0;
  }
  .grid-4 {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin: 16px 0;
  }

  /* ===== CODE BLOCKS ===== */
  pre {
    background: #f6f8fa;
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 10px;
    padding: 20px 24px;
    overflow-x: auto;
    margin: 14px 0;
    font-size: 0.85em;
    line-height: 1.65;
  }
  code {
    font-family: 'Cascadia Code', 'Fira Code', 'JetBrains Mono', Consolas, monospace;
    color: #24292f;
  }
  .kw { color: #cf222e; }
  .fn { color: #8250df; }
  .str { color: #0a3069; }
  .cm { color: #6e7781; font-style: italic; }
  .typ { color: #0550ae; }
  .num { color: #f59e0b; }
  .op { color: #cf222e; }
  .var { color: #953800; }

  code.inline {
    background: rgba(255,255,255,0.06);
    padding: 2px 8px;
    border-radius: 5px;
    font-size: 0.88em;
    color: var(--accent);
  }

  /* ===== TABLES ===== */
  .table-wrap {
    overflow-x: auto;
    margin: 16px 0;
    border-radius: 12px;
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.88em;
  }
  th {
    background: #f8fafc;
    color: #1e293b;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-size: 0.78em;
    padding: 14px 18px;
    text-align: left;
    border-bottom: 2px solid #e5e7eb;
  }
  td {
    padding: 12px 18px;
    border-bottom: 1px solid var(--card-border);
    color: var(--text-muted);
  }
  tr:hover td { background: rgba(255,255,255,0.02); }
  tr:last-child td { border-bottom: none; }

  /* ===== ARCHITECTURE DIAGRAMS ===== */
  .arch-diagram {
    background: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 14px;
    padding: 32px;
    margin: 20px 0;
    font-family: 'Cascadia Code', 'Fira Code', Consolas, monospace;
    font-size: 0.82em;
    line-height: 1.5;
    overflow-x: auto;
    color: #6e7781;
    white-space: pre;
  }
  .diagram-box {
    background: rgba(0,0,0,0.05);
    border-radius: 12px;
    padding: 20px;
    overflow-x: auto;
    margin: 20px 0;
  }
  .arch-diagram .d-primary { color: var(--primary); font-weight: bold; }
  .arch-diagram .d-secondary { color: var(--secondary); font-weight: bold; }
  .arch-diagram .d-blue { color: var(--blue); font-weight: bold; }
  .arch-diagram .d-purple { color: var(--purple); font-weight: bold; }
  .arch-diagram .d-accent { color: var(--accent); font-weight: bold; }
  .arch-diagram .d-warn { color: var(--warning); font-weight: bold; }
  .arch-diagram .d-text { color: var(--text); }
  .arch-diagram .d-muted { color: #6e7681; }

  /* ===== CALLOUT BOXES ===== */
  .callout {
    border-radius: 12px;
    padding: 20px 24px;
    margin: 16px 0;
    border-left: 4px solid;
  }
  .callout-insight {
    background: rgba(123,47,247,0.08);
    border-color: var(--purple);
  }
  .callout-insight .callout-title { color: var(--purple); }
  .callout-warning {
    background: rgba(245,158,11,0.06);
    border-color: var(--warning);
  }
  .callout-warning .callout-title { color: var(--warning); }
  .callout-success {
    background: rgba(16,185,129,0.06);
    border-color: var(--success);
  }
  .callout-success .callout-title { color: var(--success); }
  .callout-danger {
    background: rgba(239,68,68,0.06);
    border-color: var(--danger);
  }
  .callout-danger .callout-title { color: var(--danger); }
  .callout-title {
    font-weight: 700;
    font-size: 0.88em;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 8px;
  }
  .callout p, .callout li {
    font-size: 0.9em;
    color: var(--text-muted);
  }

  /* ===== FLOW STEPS ===== */
  .flow-steps {
    display: flex;
    flex-direction: column;
    gap: 0;
    margin: 16px 0;
  }
  .flow-step {
    display: flex;
    gap: 16px;
    align-items: flex-start;
    padding: 16px 0;
  }
  .flow-step-num {
    flex-shrink: 0;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    color: #fff;
    font-weight: 800;
    font-size: 0.85em;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .flow-step-content { flex: 1; }
  .flow-step-content strong { color: var(--text); }
  .flow-step-content p { margin: 4px 0 0; color: var(--text-muted); font-size: 0.9em; }

  /* ===== METRIC PILLS ===== */
  .metric-row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin: 14px 0;
  }
  .metric-pill {
    background: var(--card-bg);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 10px;
    padding: 12px 20px;
    text-align: center;
    flex: 1;
    min-width: 140px;
  }
  .metric-pill .mp-val {
    font-size: 1.4em;
    font-weight: 800;
    color: var(--primary);
    display: block;
  }
  .metric-pill .mp-label {
    font-size: 0.72em;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  /* ===== VECTOR VIS ===== */
  .vector-vis {
    background: linear-gradient(135deg, #0d1117, #161b22);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 14px;
    padding: 30px;
    margin: 20px 0;
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  .vector-vis::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: radial-gradient(circle at 40% 40%, rgba(123,47,247,0.08), transparent 60%),
                radial-gradient(circle at 60% 60%, rgba(66,139,249,0.06), transparent 50%);
  }
  .vector-vis svg { position: relative; z-index: 1; }

  /* ===== OPTION CARDS ===== */
  .option-card {
    background: var(--card-bg);
    border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 14px;
    padding: 24px 28px;
    margin: 12px 0;
    border-top: 3px solid;
    transition: all 0.3s;
  }
  .option-card:hover { transform: translateY(-2px); }
  .option-card.opt-a { border-top-color: var(--blue); }
  .option-card.opt-b { border-top-color: var(--purple); }
  .option-card.opt-c { border-top-color: var(--accent); }
  .option-card.opt-rec { border-top-color: var(--success); }
  .option-card h4 { margin-top: 0; }
  .option-card .opt-label {
    display: inline-block;
    font-size: 0.7em;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    padding: 3px 10px;
    border-radius: 6px;
    margin-bottom: 10px;
  }
  .opt-a .opt-label { background: rgba(66,139,249,0.08); color: var(--blue); }
  .opt-b .opt-label { background: rgba(123,47,247,0.15); color: var(--purple); }
  .opt-c .opt-label { background: rgba(252,100,45,0.15); color: var(--accent); }
  .opt-rec .opt-label { background: rgba(16,185,129,0.15); color: var(--success); }

  /* ===== COMPARISON BARS ===== */
  .cmp-bar-wrap { margin: 8px 0; }
  .cmp-bar-label {
    display: flex;
    justify-content: space-between;
    font-size: 0.82em;
    margin-bottom: 4px;
  }
  .cmp-bar-label span:first-child { color: var(--text); font-weight: 600; }
  .cmp-bar-label span:last-child { color: var(--text-muted); }
  .cmp-bar {
    height: 8px;
    border-radius: 4px;
    background: rgba(255,255,255,0.06);
    overflow: hidden;
  }
  .cmp-bar-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.5s;
  }

  /* ===== TAG ROW ===== */
  .tag-row {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin: 8px 0;
  }
  .tag {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 6px;
    font-size: 0.75em;
    font-weight: 600;
  }
  .tag-pro { background: rgba(16,185,129,0.15); color: var(--success); }
  .tag-con { background: rgba(239,68,68,0.15); color: var(--danger); }

  /* ===== FOOTER ===== */
  .footer {
    text-align: center;
    padding: 50px 20px;
    border-top: 1px solid #e5e7eb;
    margin-top: 40px;
    color: var(--text-muted);
    font-size: 0.85em;
  }
  .footer a { color: var(--secondary); text-decoration: none; }
  .footer a:hover { text-decoration: underline; }

  /* ===== RESPONSIVE ===== */
  @media (max-width: 768px) {
    .hero { padding: 50px 20px 40px; }
    .hero h1 { font-size: 1.8em; }
    .nav-bar { padding: 14px 20px; }
    .container { padding: 0 16px; }
    .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
    .hero .stats-row { gap: 16px; }
    .metric-row { flex-direction: column; }
  }
  /* === DIAGRAM ZOOM CONTROLS === */
  .diagram-box { position: relative; }
  .diagram-zoom-controls {
    position: absolute; top: 12px; right: 12px; z-index: 10;
    display: flex; gap: 4px; opacity: 0.5; transition: opacity 0.3s;
  }
  .diagram-box:hover .diagram-zoom-controls { opacity: 1; }
  .diagram-zoom-controls button {
    width: 32px; height: 32px; border-radius: 8px; border: 1px solid #e5e7eb;
    background: #ffffff; color: #1e293b; cursor: pointer; font-size: 16px;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.2s;
    font-family: system-ui; line-height: 1; padding: 0;
  }
  .diagram-zoom-controls button:hover { background: #f1f5f9; border-color: var(--blue); color: var(--blue); }
  .diagram-zoom-controls button:active { transform: scale(0.95); }
  .diagram-zoom-controls .zoom-level {
    font-size: 11px; color: #64748b; display: flex; align-items: center;
    padding: 0 6px; font-weight: 600; min-width: 40px; justify-content: center;
  }
  .diagram-box svg { transition: transform 0.3s ease; transform-origin: center center; }
  .diagram-box.fullscreen {
    position: fixed !important; top: 0; left: 0; width: 100vw; height: 100vh;
    z-index: 9999; background: #ffffff; border-radius: 0; padding: 20px;
    display: flex; align-items: center; justify-content: center;
    overflow: auto;
  }
  .diagram-box.fullscreen .diagram-zoom-controls { opacity: 1; top: 20px; right: 20px; }
</style>
</head>
<body>

<!-- ============================================================ -->
<!--  HERO SECTION                                                 -->
<!-- ============================================================ -->
<div class="hero">
  <a href="index.html" class="back-link">&#8592; All Topics</a>
  <div class="topic-number-hero">TOPIC 18</div>
  <h1>Multi-Tenant Vector Database</h1>
  <p class="subtitle">Design a high-performance vector database for approximate nearest neighbor (ANN) search, serving 100+ tenants with billions of embeddings and sub-50ms query latency.</p>
  <div class="hero-badges">
    <span class="badge badge-purple">PE-Level</span>
    <span class="badge badge-red">Distributed Systems</span>
    <span class="badge badge-blue">ANN Algorithms</span>
    <span class="badge badge-green">Multi-Tenancy</span>
    <span class="badge badge-orange">Storage Engine</span>
  </div>
  <div class="stats-row">
    <div class="stat-item">
      <div class="stat-value">1B+</div>
      <div class="stat-label">Total Vectors</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">&lt;50ms</div>
      <div class="stat-label">P99 Query Latency</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">100+</div>
      <div class="stat-label">Tenants</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">10K</div>
      <div class="stat-label">Queries/sec</div>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!--  NAVIGATION BAR                                               -->
<!-- ============================================================ -->
<div class="nav-bar">
  <h2>Quick Navigation</h2>
  <div class="nav-links">
    <a href="#overview">Overview</a>
    <a href="#requirements">Requirements</a>
    <a href="#capacity">Capacity</a>
    <a href="#algorithms">Index Algorithms</a>
    <a href="#architecture">Architecture</a>
    <a href="#multi-tenancy">Multi-Tenancy</a>
    <a href="#data-model">Data Model</a>
    <a href="#api-design">API Design</a>
    <a href="#storage-engine">Storage Engine</a>
    <a href="#scaling">Scaling</a>
    <a href="#consistency">Consistency</a>
    <a href="#tradeoffs">Trade-offs</a>
    <a href="#comparison">Comparison</a>
    <a href="#interview-tips">Interview Tips</a>
  </div>
</div>

<div class="container">

<!-- ============================================================ -->
<!--  SECTION 1: OVERVIEW                                          -->
<!-- ============================================================ -->
<div class="section" id="overview">
  <div class="section-label">Section 1</div>
  <h2>System Overview</h2>
  <p>A <strong>vector database</strong> stores high-dimensional embeddings (produced by ML models) and enables fast <em>approximate nearest neighbor (ANN)</em> search across those embeddings. Unlike traditional databases optimized for exact match or range queries, a vector DB excels at finding the top-K most similar items to a given query vector using distance metrics like cosine similarity, Euclidean distance, or dot product.</p>

  <div class="card" style="border-left: 4px solid var(--purple); margin-top: 20px;">
    <h4 style="color: var(--purple);">What Are Embeddings?</h4>
    <p>Embeddings are dense numerical vectors (e.g., 768 or 1536 floats) generated by neural networks. They capture <strong>semantic meaning</strong>: similar items map to nearby points in the vector space. A listing photo embedding is "close" to similar-looking photos; a text embedding for "cozy studio downtown" is "close" to "charming apartment in city center."</p>
  </div>

  <h3>Airbnb Use Cases</h3>
  <div class="grid-2">
    <div class="card">
      <h4 style="color: var(--accent);">Listing Similarity</h4>
      <p>Encode listing features (location, amenities, price, photos, reviews) into embeddings. "Show similar listings" finds K-nearest neighbors in the vector space.</p>
    </div>
    <div class="card">
      <h4 style="color: var(--blue);">Image Similarity</h4>
      <p>Use vision model embeddings (CLIP, ResNet) for duplicate detection, visual search ("find listings that look like this photo"), and photo quality scoring.</p>
    </div>
    <div class="card">
      <h4 style="color: #1e293b;">Recommendations</h4>
      <p>User behavior embeddings enable collaborative filtering at scale. "Users who liked X also liked Y" becomes a nearest-neighbor lookup in embedding space.</p>
    </div>
    <div class="card">
      <h4 style="color: var(--purple);">Semantic Search</h4>
      <p>Encode search queries and listing descriptions into the same embedding space. Semantic search finds listings by meaning, not just keyword matching.</p>
    </div>
  </div>

  <div class="callout callout-insight">
    <div class="callout-title">Multi-Tenant Design</div>
    <p>Multiple internal teams (Search, Recommendations, Trust & Safety, Pricing) share the same vector DB infrastructure but with <strong>data isolation</strong>. Each tenant operates in its own namespace. The platform manages resource allocation, prevents noisy-neighbor problems, and provides consistent performance guarantees across all tenants.</p>
  </div>
</div>

<!-- ============================================================ -->
<!--  SECTION 2: REQUIREMENTS                                      -->
<!-- ============================================================ -->
<div class="section" id="requirements">
  <div class="section-label">Section 2</div>
  <h2>Requirements</h2>

  <div class="grid-2">
    <div class="card" style="border-top: 3px solid var(--secondary);">
      <h4 style="color: #1e293b;">Functional Requirements</h4>
      <ul>
        <li><strong>Insert/Delete Vectors:</strong> Add, update, and delete individual vectors with associated metadata</li>
        <li><strong>Query K-Nearest Neighbors:</strong> Given a query vector, return top-K most similar vectors</li>
        <li><strong>Metadata Filtering:</strong> Apply pre/post filters (e.g., price range, location, category) during ANN search</li>
        <li><strong>Multiple Distance Metrics:</strong> Support cosine similarity, Euclidean (L2) distance, and dot product</li>
        <li><strong>Namespace Per Tenant:</strong> Logical isolation so tenant A cannot access tenant B's vectors</li>
        <li><strong>Batch Upsert:</strong> Efficiently insert/update thousands of vectors in a single operation</li>
        <li><strong>Collection Management:</strong> Create, configure, and delete vector collections per tenant</li>
      </ul>
    </div>
    <div class="card" style="border-top: 3px solid var(--primary);">
      <h4 style="color: var(--primary);">Non-Functional Requirements</h4>
      <ul>
        <li><strong>Latency:</strong> &lt;50ms P99 for query with 10M vectors per tenant</li>
        <li><strong>Scale:</strong> Support 100+ concurrent tenants</li>
        <li><strong>Capacity:</strong> Store 1B+ total vectors across all tenants</li>
        <li><strong>Recall:</strong> >95% recall@10 (find 95%+ of the true top-10 nearest neighbors)</li>
        <li><strong>Availability:</strong> 99.95% uptime with graceful degradation</li>
        <li><strong>Throughput:</strong> 10K queries/second, 1M inserts/day</li>
        <li><strong>Durability:</strong> Zero data loss on node failure</li>
        <li><strong>Isolation:</strong> One tenant's heavy workload must not degrade another's performance</li>
      </ul>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!--  SECTION 3: CAPACITY ESTIMATION                               -->
<!-- ============================================================ -->
<div class="section" id="capacity">
  <div class="section-label">Section 3</div>
  <h2>Capacity Estimation</h2>

  <div class="metric-row">
    <div class="metric-pill">
      <span class="mp-val">100</span>
      <span class="mp-label">Tenants</span>
    </div>
    <div class="metric-pill">
      <span class="mp-val">10M</span>
      <span class="mp-label">Avg Vectors/Tenant</span>
    </div>
    <div class="metric-pill">
      <span class="mp-val">1B</span>
      <span class="mp-label">Total Vectors</span>
    </div>
    <div class="metric-pill">
      <span class="mp-val">768-1536</span>
      <span class="mp-label">Dimensions</span>
    </div>
  </div>

  <div class="card">
    <h4 style="color: var(--blue);">Storage Breakdown</h4>
    <pre><code><span class="cm">// Raw vector storage (assuming 768 dimensions, float32)</span>
<span class="var">single_vector</span>     = <span class="num">768</span> dims x <span class="num">4</span> bytes = <span class="num">3,072</span> bytes (~<span class="num">3 KB</span>)
<span class="var">per_tenant</span>        = <span class="num">10M</span> vectors x <span class="num">3 KB</span> = <span class="num">~30 GB</span> raw
<span class="var">total_raw</span>         = <span class="num">100</span> tenants x <span class="num">30 GB</span> = <span class="num">~3 TB</span> raw vectors

<span class="cm">// HNSW index overhead (~1.5x raw vectors for graph structure)</span>
<span class="var">index_overhead</span>    = <span class="num">3 TB</span> x <span class="num">1.5</span> = <span class="num">~4.5 TB</span>

<span class="cm">// Metadata storage (~200 bytes/vector avg)</span>
<span class="var">metadata</span>          = <span class="num">1B</span> x <span class="num">200 B</span> = <span class="num">~200 GB</span>

<span class="cm">// With replication (RF=3) and headroom</span>
<span class="var">total_storage</span>     = (<span class="num">3 TB</span> + <span class="num">4.5 TB</span> + <span class="num">0.2 TB</span>) x <span class="num">3</span> = <span class="num">~23 TB</span>
<span class="var">total_memory</span>      = <span class="num">~8 TB</span> across cluster <span class="cm">(hot index partitions in RAM)</span>

<span class="cm">// For 1536 dimensions (OpenAI-style), double all vector figures:</span>
<span class="var">total_with_1536d</span>  = <span class="num">~42 TB</span> storage, <span class="num">~15 TB</span> memory</code></pre>
  </div>

  <div class="grid-3">
    <div class="card" style="text-align: center;">
      <div style="font-size: 1.8em; font-weight: 800; color: var(--primary);">~18 TB</div>
      <div style="font-size: 0.8em; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;">Total Storage (768d)</div>
    </div>
    <div class="card" style="text-align: center;">
      <div style="font-size: 1.8em; font-weight: 800; color: var(--primary);">10K</div>
      <div style="font-size: 0.8em; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;">Queries/Second</div>
    </div>
    <div class="card" style="text-align: center;">
      <div style="font-size: 1.8em; font-weight: 800; color: var(--purple);">1M</div>
      <div style="font-size: 0.8em; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;">Inserts/Day</div>
    </div>
  </div>

  <div class="callout callout-warning">
    <div class="callout-title">Memory Is the Bottleneck</div>
    <p>HNSW-based indexes require the full graph structure in memory for optimal performance. At 1B vectors with 768 dimensions, you need <strong>~8 TB of RAM</strong> across the cluster. This is the single largest cost driver. Product quantization (PQ) can reduce memory by 4-16x at the cost of some recall.</p>
  </div>
</div>

<!-- ============================================================ -->
<!--  SECTION 4: VECTOR INDEX ALGORITHMS                           -->
<!-- ============================================================ -->
<div class="section" id="algorithms">
  <div class="section-label">Section 4</div>
  <h2>Vector Index Algorithms</h2>
  <p>Choosing the right ANN index algorithm is the most critical design decision. Each algorithm trades off recall, latency, memory, and insert speed differently.</p>

  <style>
    details.algo-detail { margin: 16px 0; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; }
    details.algo-detail[open] { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    details.algo-detail summary {
      padding: 18px 24px;
      cursor: pointer;
      font-weight: 700;
      font-size: 1.1em;
      display: flex;
      align-items: center;
      gap: 12px;
      background: #f8fafc;
      border-bottom: 1px solid transparent;
      transition: all 0.2s;
      list-style: none;
    }
    details.algo-detail[open] summary { border-bottom: 1px solid #e5e7eb; background: #f1f5f9; }
    details.algo-detail summary::-webkit-details-marker { display: none; }
    details.algo-detail summary::before { content: '▸'; font-size: 0.9em; color: var(--primary); transition: transform 0.2s; }
    details.algo-detail[open] summary::before { transform: rotate(90deg); }
    details.algo-detail summary .algo-badge { font-size: 0.65em; padding: 3px 10px; border-radius: 12px; font-weight: 600; margin-left: auto; }
    details.algo-detail summary .algo-badge.best { background: rgba(16,185,129,0.12); color: var(--success); }
    details.algo-detail summary .algo-badge.good { background: rgba(66,139,249,0.12); color: var(--blue); }
    details.algo-detail summary .algo-badge.baseline { background: rgba(100,116,139,0.12); color: #64748b; }
    details.algo-detail summary .algo-badge.advanced { background: rgba(123,47,247,0.12); color: var(--purple); }
    details.algo-detail .algo-body { padding: 24px; }
    details.algo-detail .algo-body h4 { color: var(--blue); margin: 16px 0 8px; font-size: 0.95em; }
    details.algo-detail .algo-body h4:first-child { margin-top: 0; }
    details.algo-detail .algo-body .metric-row { display: flex; gap: 12px; flex-wrap: wrap; margin: 12px 0; }
    details.algo-detail .algo-body .metric-pill { padding: 6px 14px; border-radius: 8px; font-size: 0.82em; font-weight: 600; background: #f1f5f9; border: 1px solid #e5e7eb; }
    details.algo-detail .algo-body .metric-pill.green { background: rgba(16,185,129,0.08); border-color: rgba(16,185,129,0.3); color: var(--success); }
    details.algo-detail .algo-body .metric-pill.red { background: rgba(239,68,68,0.08); border-color: rgba(239,68,68,0.3); color: var(--danger); }
    details.algo-detail .algo-body .metric-pill.amber { background: rgba(245,158,11,0.08); border-color: rgba(245,158,11,0.3); color: var(--warning); }
    details.algo-detail .algo-body .when-use { background: rgba(66,139,249,0.05); border-left: 3px solid var(--blue); padding: 12px 16px; border-radius: 0 8px 8px 0; margin: 12px 0; font-size: 0.9em; }
    details.algo-detail .algo-body .complexity-box { display: inline-block; font-family: 'Cascadia Code', monospace; background: #f6f8fa; padding: 2px 8px; border-radius: 4px; font-size: 0.88em; border: 1px solid #e5e7eb; }
    details.algo-detail .algo-body .param-table { width: 100%; margin: 10px 0; border-collapse: collapse; font-size: 0.88em; }
    details.algo-detail .algo-body .param-table th { background: #f1f5f9; color: #1e293b; padding: 8px 12px; text-align: left; font-size: 0.85em; }
    details.algo-detail .algo-body .param-table td { padding: 8px 12px; border-bottom: 1px solid #f1f5f9; }
  /* === DIAGRAM ZOOM CONTROLS === */
  .diagram-box { position: relative; }
  .diagram-zoom-controls {
    position: absolute; top: 12px; right: 12px; z-index: 10;
    display: flex; gap: 4px; opacity: 0.5; transition: opacity 0.3s;
  }
  .diagram-box:hover .diagram-zoom-controls { opacity: 1; }
  .diagram-zoom-controls button {
    width: 32px; height: 32px; border-radius: 8px; border: 1px solid #e5e7eb;
    background: #ffffff; color: #1e293b; cursor: pointer; font-size: 16px;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.2s;
    font-family: system-ui; line-height: 1; padding: 0;
  }
  .diagram-zoom-controls button:hover { background: #f1f5f9; border-color: var(--blue); color: var(--blue); }
  .diagram-zoom-controls button:active { transform: scale(0.95); }
  .diagram-zoom-controls .zoom-level {
    font-size: 11px; color: #64748b; display: flex; align-items: center;
    padding: 0 6px; font-weight: 600; min-width: 40px; justify-content: center;
  }
  .diagram-box svg { transition: transform 0.3s ease; transform-origin: center center; }
  .diagram-box.fullscreen {
    position: fixed !important; top: 0; left: 0; width: 100vw; height: 100vh;
    z-index: 9999; background: #ffffff; border-radius: 0; padding: 20px;
    display: flex; align-items: center; justify-content: center;
    overflow: auto;
  }
  .diagram-box.fullscreen .diagram-zoom-controls { opacity: 1; top: 20px; right: 20px; }
  </style>

  <!-- ALGORITHM 1: FLAT -->
  <details class="algo-detail">
    <summary>
      1. Flat (Brute-Force) — Exact Search
      <span class="algo-badge baseline">Baseline</span>
    </summary>
    <div class="algo-body">
      <h4>How It Works</h4>
      <p>Computes the exact distance between the query vector and <strong>every single vector</strong> in the dataset. No index structure — just a linear scan. This is the simplest approach and serves as the ground truth for evaluating other algorithms.</p>

      <div class="diagram-box" style="margin:16px 0;">
        <svg viewBox="0 0 700 200" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:auto;font-family:'Inter',system-ui,sans-serif;">
          <rect width="700" height="200" fill="#f8fafc" rx="12"/>
          <!-- Title -->
          <text x="350" y="24" text-anchor="middle" font-size="13" font-weight="700" fill="#1e293b">Flat (Brute-Force): Compare Query to Every Vector</text>
          <!-- Query vector Q -->
          <circle cx="45" cy="100" r="22" fill="#428BF9" stroke="#2563eb" stroke-width="2"/>
          <text x="45" y="105" text-anchor="middle" font-size="13" font-weight="700" fill="#fff">Q</text>
          <!-- Arrows from Q to all vectors -->
          <g stroke="#94a3b8" stroke-width="1" fill="none" opacity="0.5">
            <line x1="67" y1="100" x2="105" y2="58"/><line x1="67" y1="100" x2="135" y2="58"/>
            <line x1="67" y1="100" x2="165" y2="58"/><line x1="67" y1="100" x2="195" y2="58"/>
            <line x1="67" y1="100" x2="225" y2="58"/><line x1="67" y1="100" x2="255" y2="58"/>
            <line x1="67" y1="100" x2="285" y2="58"/><line x1="67" y1="100" x2="315" y2="58"/>
            <line x1="67" y1="100" x2="345" y2="58"/><line x1="67" y1="100" x2="375" y2="58"/>
            <line x1="67" y1="100" x2="405" y2="58"/><line x1="67" y1="100" x2="435" y2="58"/>
            <line x1="67" y1="100" x2="465" y2="58"/><line x1="67" y1="100" x2="495" y2="58"/>
            <line x1="67" y1="100" x2="525" y2="58"/><line x1="67" y1="100" x2="555" y2="58"/>
            <line x1="67" y1="100" x2="585" y2="58"/><line x1="67" y1="100" x2="615" y2="58"/>
            <line x1="67" y1="100" x2="645" y2="58"/><line x1="67" y1="100" x2="675" y2="58"/>
          </g>
          <!-- Highlighted arrows to closest 3 -->
          <g stroke="#10b981" stroke-width="2.5" fill="none">
            <line x1="67" y1="100" x2="195" y2="58"/>
            <line x1="67" y1="100" x2="315" y2="58"/>
            <line x1="67" y1="100" x2="465" y2="58"/>
          </g>
          <!-- Dataset vectors row -->
          <g font-size="8" text-anchor="middle" fill="#1e293b">
            <!-- v1-v20 circles -->
            <circle cx="105" cy="50" r="10" fill="#e2e8f0" stroke="#94a3b8" stroke-width="1"/>
            <text x="105" y="53" font-size="7" fill="#475569">v1</text>
            <circle cx="135" cy="50" r="10" fill="#e2e8f0" stroke="#94a3b8" stroke-width="1"/>
            <text x="135" y="53" font-size="7" fill="#475569">v2</text>
            <circle cx="165" cy="50" r="10" fill="#e2e8f0" stroke="#94a3b8" stroke-width="1"/>
            <text x="165" y="53" font-size="7" fill="#475569">v3</text>
            <!-- Closest match 1 -->
            <circle cx="195" cy="50" r="10" fill="#d1fae5" stroke="#10b981" stroke-width="2.5"/>
            <text x="195" y="53" font-size="7" font-weight="700" fill="#065f46">v4</text>
            <circle cx="225" cy="50" r="10" fill="#e2e8f0" stroke="#94a3b8" stroke-width="1"/>
            <text x="225" y="53" font-size="7" fill="#475569">v5</text>
            <circle cx="255" cy="50" r="10" fill="#e2e8f0" stroke="#94a3b8" stroke-width="1"/>
            <text x="255" y="53" font-size="7" fill="#475569">v6</text>
            <circle cx="285" cy="50" r="10" fill="#e2e8f0" stroke="#94a3b8" stroke-width="1"/>
            <text x="285" y="53" font-size="7" fill="#475569">v7</text>
            <!-- Closest match 2 -->
            <circle cx="315" cy="50" r="10" fill="#d1fae5" stroke="#10b981" stroke-width="2.5"/>
            <text x="315" y="53" font-size="7" font-weight="700" fill="#065f46">v8</text>
            <circle cx="345" cy="50" r="10" fill="#e2e8f0" stroke="#94a3b8" stroke-width="1"/>
            <text x="345" y="53" font-size="7" fill="#475569">v9</text>
            <circle cx="375" cy="50" r="10" fill="#e2e8f0" stroke="#94a3b8" stroke-width="1"/>
            <text x="375" y="53" font-size="7" fill="#475569">v10</text>
            <circle cx="405" cy="50" r="10" fill="#e2e8f0" stroke="#94a3b8" stroke-width="1"/>
            <text x="405" y="53" font-size="7" fill="#475569">v11</text>
            <circle cx="435" cy="50" r="10" fill="#e2e8f0" stroke="#94a3b8" stroke-width="1"/>
            <text x="435" y="53" font-size="7" fill="#475569">v12</text>
            <!-- Closest match 3 -->
            <circle cx="465" cy="50" r="10" fill="#d1fae5" stroke="#10b981" stroke-width="2.5"/>
            <text x="465" y="53" font-size="7" font-weight="700" fill="#065f46">v13</text>
            <circle cx="495" cy="50" r="10" fill="#e2e8f0" stroke="#94a3b8" stroke-width="1"/>
            <text x="495" y="53" font-size="7" fill="#475569">v14</text>
            <circle cx="525" cy="50" r="10" fill="#e2e8f0" stroke="#94a3b8" stroke-width="1"/>
            <text x="525" y="53" font-size="7" fill="#475569">v15</text>
            <circle cx="555" cy="50" r="10" fill="#e2e8f0" stroke="#94a3b8" stroke-width="1"/>
            <text x="555" y="53" font-size="7" fill="#475569">v16</text>
            <circle cx="585" cy="50" r="10" fill="#e2e8f0" stroke="#94a3b8" stroke-width="1"/>
            <text x="585" y="53" font-size="7" fill="#475569">v17</text>
            <circle cx="615" cy="50" r="10" fill="#e2e8f0" stroke="#94a3b8" stroke-width="1"/>
            <text x="615" y="53" font-size="7" fill="#475569">v18</text>
            <circle cx="645" cy="50" r="10" fill="#e2e8f0" stroke="#94a3b8" stroke-width="1"/>
            <text x="645" y="53" font-size="7" fill="#475569">v19</text>
            <circle cx="675" cy="50" r="10" fill="#e2e8f0" stroke="#94a3b8" stroke-width="1"/>
            <text x="675" y="53" font-size="7" fill="#475569">v20</text>
          </g>
          <!-- Distance calc label -->
          <text x="120" y="115" font-size="10" fill="#64748b" font-style="italic">dist(Q, v<tspan font-size="7" dy="2">i</tspan><tspan dy="-2">) for every i = 1..N</tspan></text>
          <!-- Legend -->
          <rect x="100" y="140" width="12" height="12" rx="6" fill="#d1fae5" stroke="#10b981" stroke-width="1.5"/>
          <text x="118" y="150" font-size="10" fill="#1e293b">= Top-3 nearest (green)</text>
          <rect x="270" y="140" width="12" height="12" rx="6" fill="#e2e8f0" stroke="#94a3b8" stroke-width="1"/>
          <text x="288" y="150" font-size="10" fill="#1e293b">= All other vectors compared</text>
          <!-- Complexity label -->
          <rect x="170" y="166" width="360" height="26" rx="8" fill="#fef2f2" stroke="#FF5A5F" stroke-width="1.5"/>
          <text x="350" y="183" text-anchor="middle" font-size="12" font-weight="700" fill="#FF5A5F">O(N) -- compare to every vector, no shortcuts</text>
        </svg>
      </div>

      <h4>Complexity</h4>
      <div class="metric-row">
        <span class="metric-pill">Query: <span class="complexity-box">O(N × D)</span></span>
        <span class="metric-pill green">Build: <span class="complexity-box">O(1)</span> — no index to build</span>
        <span class="metric-pill">Memory: <span class="complexity-box">O(N × D)</span> — raw vectors only</span>
      </div>

      <h4>Performance at Scale</h4>
      <table class="param-table">
        <tr><th>Dataset Size</th><th>Latency (768d)</th><th>Recall</th><th>Verdict</th></tr>
        <tr><td>1K vectors</td><td>~0.1ms</td><td>100%</td><td style="color:var(--success)">Fine</td></tr>
        <tr><td>10K vectors</td><td>~1ms</td><td>100%</td><td style="color:var(--success)">Acceptable</td></tr>
        <tr><td>100K vectors</td><td>~10ms</td><td>100%</td><td style="color:var(--warning)">Borderline</td></tr>
        <tr><td>1M vectors</td><td>~100ms</td><td>100%</td><td style="color:var(--danger)">Too slow</td></tr>
        <tr><td>10M vectors</td><td>~1,000ms</td><td>100%</td><td style="color:var(--danger)">Unusable</td></tr>
      </table>

      <h4>SIMD Optimization</h4>
      <p>Even brute-force benefits from hardware acceleration. Modern CPUs with <strong>AVX-512</strong> or <strong>ARM NEON</strong> can compute 16 float distances in a single instruction. Libraries like FAISS use this to achieve ~4x speedup on raw scans. GPUs can push this to ~100x for batch queries.</p>

      <h4>Distance Metrics</h4>
      <pre><code><span class="cm">// Cosine similarity (most common for NLP embeddings)</span>
<span class="fn">cosine_sim</span>(a, b) = <span class="fn">dot</span>(a, b) / (||a|| × ||b||)

<span class="cm">// Euclidean (L2) distance (common for image embeddings)</span>
<span class="fn">l2_dist</span>(a, b) = <span class="fn">sqrt</span>(<span class="fn">sum</span>((a[i] - b[i])²))

<span class="cm">// Inner Product / Dot Product (when vectors are normalized)</span>
<span class="fn">dot</span>(a, b) = <span class="fn">sum</span>(a[i] × b[i])

<span class="cm">// For normalized vectors: cosine_sim = dot product</span>
<span class="cm">// Always normalize embeddings at ingest time → use dot product (fastest)</span></code></pre>

      <div class="tag-row">
        <span class="tag tag-pro">100% Recall (exact)</span>
        <span class="tag tag-pro">Zero Build Time</span>
        <span class="tag tag-pro">No Parameters to Tune</span>
        <span class="tag tag-con">O(N) Query — Doesn't Scale</span>
        <span class="tag tag-con">No Incremental Optimization</span>
      </div>

      <div class="when-use">
        <strong>When to use:</strong> Collections under 10K vectors, recall benchmarking, as a re-ranking stage after ANN retrieval (two-phase: ANN returns top-100, flat re-ranks to top-10 with exact distances).
      </div>
    </div>
  </details>

  <!-- ALGORITHM 2: IVF -->
  <details class="algo-detail">
    <summary>
      2. IVF (Inverted File Index) — Cluster-Based Partitioning
      <span class="algo-badge good">Good Balance</span>
    </summary>
    <div class="algo-body">
      <h4>How It Works</h4>
      <p>Partitions the entire vector space into <strong>nlist</strong> clusters using k-means. Each vector is assigned to its nearest cluster centroid. At query time, instead of scanning all vectors, it finds the <strong>nprobe</strong> nearest centroids and only searches vectors within those clusters.</p>

      <div class="diagram-box" style="margin:16px 0;">
        <svg viewBox="0 0 700 300" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:auto;font-family:'Inter',system-ui,sans-serif;">
          <rect width="700" height="300" fill="#f8fafc" rx="12"/>
          <!-- Title -->
          <text x="350" y="24" text-anchor="middle" font-size="13" font-weight="700" fill="#1e293b">IVF: Query Searches Only the Nearest Clusters</text>

          <!-- Query vector Q -->
          <circle cx="55" cy="150" r="24" fill="#428BF9" stroke="#2563eb" stroke-width="2"/>
          <text x="55" y="155" text-anchor="middle" font-size="14" font-weight="700" fill="#fff">Q</text>

          <!-- Cluster 1 (Red) - HIGHLIGHTED (searched) -->
          <ellipse cx="230" cy="80" rx="95" ry="55" fill="#fef2f2" stroke="#FF5A5F" stroke-width="2.5" opacity="0.9"/>
          <animateTransform attributeName="transform" type="scale" values="1;1.01;1" dur="2s" repeatCount="indefinite"/>
          <!-- glow effect -->
          <ellipse cx="230" cy="80" rx="95" ry="55" fill="none" stroke="#FF5A5F" stroke-width="1" opacity="0.3" stroke-dasharray="5,3"/>
          <!-- Centroid -->
          <circle cx="230" cy="80" r="10" fill="#FF5A5F" stroke="#dc2626" stroke-width="2"/>
          <text x="230" y="84" text-anchor="middle" font-size="7" font-weight="700" fill="#fff">C1</text>
          <!-- Vectors in cluster -->
          <circle cx="195" cy="60" r="5" fill="#fca5a5"/><circle cx="215" cy="50" r="5" fill="#fca5a5"/>
          <circle cx="250" cy="55" r="5" fill="#fca5a5"/><circle cx="270" cy="70" r="5" fill="#fca5a5"/>
          <circle cx="200" cy="95" r="5" fill="#fca5a5"/><circle cx="255" cy="100" r="5" fill="#fca5a5"/>
          <!-- Arrow Q -> C1 -->
          <line x1="79" y1="140" x2="215" y2="88" stroke="#FF5A5F" stroke-width="2.5" marker-end="url(#ivf-arrow-red)"/>
          <text x="140" y="105" font-size="9" fill="#FF5A5F" font-weight="600" transform="rotate(-14,140,105)">search</text>

          <!-- Cluster 2 (Blue) - HIGHLIGHTED (searched) -->
          <ellipse cx="230" cy="220" rx="95" ry="55" fill="#f0f4ff" stroke="#428BF9" stroke-width="2.5" opacity="0.9"/>
          <ellipse cx="230" cy="220" rx="95" ry="55" fill="none" stroke="#428BF9" stroke-width="1" opacity="0.3" stroke-dasharray="5,3"/>
          <!-- Centroid -->
          <circle cx="230" cy="220" r="10" fill="#428BF9" stroke="#2563eb" stroke-width="2"/>
          <text x="230" y="224" text-anchor="middle" font-size="7" font-weight="700" fill="#fff">C2</text>
          <!-- Vectors -->
          <circle cx="190" cy="200" r="5" fill="#93c5fd"/><circle cx="210" cy="195" r="5" fill="#93c5fd"/>
          <circle cx="260" cy="205" r="5" fill="#93c5fd"/><circle cx="270" cy="230" r="5" fill="#93c5fd"/>
          <circle cx="200" cy="245" r="5" fill="#93c5fd"/><circle cx="250" cy="250" r="5" fill="#93c5fd"/>
          <!-- Arrow Q -> C2 -->
          <line x1="79" y1="160" x2="215" y2="213" stroke="#428BF9" stroke-width="2.5" marker-end="url(#ivf-arrow-blue)"/>
          <text x="140" y="198" font-size="9" fill="#428BF9" font-weight="600" transform="rotate(14,140,198)">search</text>

          <!-- Cluster 3 (Green) - GRAYED OUT -->
          <ellipse cx="510" cy="80" rx="95" ry="55" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1.5" opacity="0.5"/>
          <circle cx="510" cy="80" r="10" fill="#cbd5e1" stroke="#94a3b8" stroke-width="1.5"/>
          <text x="510" y="84" text-anchor="middle" font-size="7" font-weight="700" fill="#fff">C3</text>
          <circle cx="475" cy="60" r="5" fill="#d1d5db" opacity="0.5"/><circle cx="495" cy="50" r="5" fill="#d1d5db" opacity="0.5"/>
          <circle cx="530" cy="55" r="5" fill="#d1d5db" opacity="0.5"/><circle cx="550" cy="70" r="5" fill="#d1d5db" opacity="0.5"/>
          <circle cx="480" cy="95" r="5" fill="#d1d5db" opacity="0.5"/><circle cx="535" cy="100" r="5" fill="#d1d5db" opacity="0.5"/>
          <text x="510" y="128" text-anchor="middle" font-size="9" fill="#94a3b8" font-style="italic">skipped</text>

          <!-- Cluster 4 (Purple) - GRAYED OUT -->
          <ellipse cx="510" cy="220" rx="95" ry="55" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1.5" opacity="0.5"/>
          <circle cx="510" cy="220" r="10" fill="#cbd5e1" stroke="#94a3b8" stroke-width="1.5"/>
          <text x="510" y="224" text-anchor="middle" font-size="7" font-weight="700" fill="#fff">C4</text>
          <circle cx="475" cy="200" r="5" fill="#d1d5db" opacity="0.5"/><circle cx="495" cy="195" r="5" fill="#d1d5db" opacity="0.5"/>
          <circle cx="540" cy="210" r="5" fill="#d1d5db" opacity="0.5"/><circle cx="550" cy="235" r="5" fill="#d1d5db" opacity="0.5"/>
          <circle cx="480" cy="245" r="5" fill="#d1d5db" opacity="0.5"/><circle cx="530" cy="250" r="5" fill="#d1d5db" opacity="0.5"/>
          <text x="510" y="268" text-anchor="middle" font-size="9" fill="#94a3b8" font-style="italic">skipped</text>

          <!-- Label -->
          <rect x="350" y="140" width="250" height="24" rx="8" fill="#f0fdf4" stroke="#10b981" stroke-width="1.5"/>
          <text x="475" y="156" text-anchor="middle" font-size="11" font-weight="700" fill="#065f46">nprobe=2 -- search only 2 of 4 clusters</text>

          <!-- Arrow markers -->
          <defs>
            <marker id="ivf-arrow-red" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
              <path d="M0,0 L8,3 L0,6" fill="#FF5A5F"/>
            </marker>
            <marker id="ivf-arrow-blue" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
              <path d="M0,0 L8,3 L0,6" fill="#428BF9"/>
            </marker>
          </defs>
        </svg>
      </div>

      <h4>Two-Phase Process</h4>
      <pre><code><span class="cm">// BUILD PHASE (offline, ~30 min for 10M vectors)</span>
<span class="cm">// 1. Sample training data (10-50x nlist vectors)</span>
<span class="var">training_data</span> = <span class="fn">random_sample</span>(vectors, <span class="num">50</span> * nlist)
<span class="cm">// 2. Run k-means to find cluster centroids</span>
<span class="var">centroids</span> = <span class="fn">kmeans</span>(training_data, nlist=<span class="num">4096</span>)
<span class="cm">// 3. Assign every vector to nearest centroid</span>
<span class="kw">for</span> vec <span class="kw">in</span> all_vectors:
    <span class="var">cluster_id</span> = <span class="fn">nearest_centroid</span>(vec, centroids)
    inverted_lists[cluster_id].<span class="fn">append</span>(vec)

<span class="cm">// QUERY PHASE (online, ~5-20ms)</span>
<span class="cm">// 1. Find nprobe nearest centroids to query</span>
<span class="var">nearest_clusters</span> = <span class="fn">top_k_centroids</span>(query, nprobe=<span class="num">64</span>)
<span class="cm">// 2. Scan only those clusters</span>
<span class="var">candidates</span> = []
<span class="kw">for</span> cluster <span class="kw">in</span> nearest_clusters:
    candidates.<span class="fn">extend</span>(inverted_lists[cluster])
<span class="cm">// 3. Exact distance on candidates, return top-K</span>
<span class="kw">return</span> <span class="fn">top_k</span>(candidates, query, k=<span class="num">10</span>)</code></pre>

      <h4>Key Parameters &amp; Tuning</h4>
      <table class="param-table">
        <tr><th>Parameter</th><th>Typical Value</th><th>Effect of Increasing</th><th>Guidance</th></tr>
        <tr><td><strong>nlist</strong></td><td>sqrt(N) to 4×sqrt(N)</td><td>Smaller clusters, faster search per cluster</td><td>10M vectors → nlist=1024-4096</td></tr>
        <tr><td><strong>nprobe</strong></td><td>1-128</td><td>Higher recall, higher latency (linear)</td><td>Start at nlist/16, tune for recall target</td></tr>
      </table>

      <h4>Recall vs nprobe (10M vectors, nlist=4096)</h4>
      <table class="param-table">
        <tr><th>nprobe</th><th>Recall@10</th><th>Latency</th><th>Vectors Scanned</th></tr>
        <tr><td>1</td><td>~45%</td><td>~0.5ms</td><td>~2,400 (0.024%)</td></tr>
        <tr><td>8</td><td>~78%</td><td>~2ms</td><td>~19,500 (0.2%)</td></tr>
        <tr><td>32</td><td>~92%</td><td>~8ms</td><td>~78,000 (0.8%)</td></tr>
        <tr><td>64</td><td>~96%</td><td>~15ms</td><td>~156,000 (1.6%)</td></tr>
        <tr><td>128</td><td>~98%</td><td>~30ms</td><td>~312,000 (3.1%)</td></tr>
      </table>

      <h4>Known Limitations</h4>
      <ul>
        <li><strong>Uneven clusters:</strong> K-means can produce clusters of very different sizes. A few large clusters dominate query time. Mitigation: use balanced k-means or increase nlist.</li>
        <li><strong>Rebuild required:</strong> Adding new vectors doesn't update centroids. Over time, cluster quality degrades → periodic retrain needed.</li>
        <li><strong>Training data dependency:</strong> Clusters learned from a sample may not represent future data well.</li>
      </ul>

      <div class="tag-row">
        <span class="tag tag-pro">Good Recall/Speed Trade-off</span>
        <span class="tag tag-pro">Tunable via nprobe</span>
        <span class="tag tag-pro">Lower Memory Than HNSW</span>
        <span class="tag tag-con">Requires Offline Training</span>
        <span class="tag tag-con">Uneven Cluster Sizes</span>
        <span class="tag tag-con">No Incremental Updates</span>
      </div>

      <div class="when-use">
        <strong>When to use:</strong> Medium-sized datasets (1M-100M), when you can afford periodic retraining, and when memory is more constrained than with HNSW. Often combined with PQ (IVF-PQ) for billion-scale.
      </div>
    </div>
  </details>

  <!-- ALGORITHM 3: HNSW (the most important one) -->
  <details class="algo-detail" open>
    <summary>
      3. HNSW (Hierarchical Navigable Small World) — Graph-Based
      <span class="algo-badge best">Recommended</span>
    </summary>
    <div class="algo-body">
      <h4>Core Idea</h4>
      <p>Inspired by <strong>skip lists</strong>, HNSW builds a multi-layer proximity graph. Each layer is a "navigable small world" network where nodes (vectors) are connected to their nearest neighbors. Upper layers are sparse (long-range links for fast navigation), lower layers are dense (short-range links for precision). Queries enter at the top and greedily traverse down.</p>

      <div class="diagram-box" style="margin:16px 0;">
        <svg viewBox="0 0 700 350" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:auto;font-family:'Inter',system-ui,sans-serif;">
          <rect width="700" height="350" fill="#f8fafc" rx="12"/>
          <!-- Title -->
          <text x="350" y="22" text-anchor="middle" font-size="13" font-weight="700" fill="#1e293b">HNSW: Multi-Layer Navigable Small World Graph</text>

          <!-- Layer 3 background band -->
          <rect x="80" y="32" width="540" height="52" rx="8" fill="#ede9fe" opacity="0.6"/>
          <text x="68" y="62" text-anchor="end" font-size="10" font-weight="600" fill="#7B2FF7">L3</text>
          <!-- Layer 3 nodes: A, M, Z -->
          <circle cx="140" cy="58" r="12" fill="#7B2FF7" stroke="#5b21b6" stroke-width="1.5"/>
          <text x="140" y="62" text-anchor="middle" font-size="10" font-weight="700" fill="#fff">A</text>
          <circle cx="350" cy="58" r="12" fill="#7B2FF7" stroke="#5b21b6" stroke-width="1.5"/>
          <text x="350" y="62" text-anchor="middle" font-size="10" font-weight="700" fill="#fff">M</text>
          <circle cx="560" cy="58" r="12" fill="#7B2FF7" stroke="#5b21b6" stroke-width="1.5"/>
          <text x="560" y="62" text-anchor="middle" font-size="10" font-weight="700" fill="#fff">Z</text>
          <!-- L3 edges -->
          <line x1="152" y1="58" x2="338" y2="58" stroke="#a78bfa" stroke-width="1.5"/>
          <line x1="362" y1="58" x2="548" y2="58" stroke="#a78bfa" stroke-width="1.5"/>

          <!-- Layer 2 background band -->
          <rect x="80" y="90" width="540" height="52" rx="8" fill="#ede9fe" opacity="0.35"/>
          <text x="68" y="120" text-anchor="end" font-size="10" font-weight="600" fill="#7B2FF7">L2</text>
          <!-- Layer 2 nodes: A, F, M, R, Z -->
          <circle cx="140" cy="116" r="10" fill="#a78bfa" stroke="#7c3aed" stroke-width="1.5"/>
          <text x="140" y="120" text-anchor="middle" font-size="9" font-weight="600" fill="#fff">A</text>
          <circle cx="245" cy="116" r="10" fill="#a78bfa" stroke="#7c3aed" stroke-width="1.5"/>
          <text x="245" y="120" text-anchor="middle" font-size="9" font-weight="600" fill="#fff">F</text>
          <circle cx="350" cy="116" r="10" fill="#a78bfa" stroke="#7c3aed" stroke-width="1.5"/>
          <text x="350" y="120" text-anchor="middle" font-size="9" font-weight="600" fill="#fff">M</text>
          <circle cx="455" cy="116" r="10" fill="#a78bfa" stroke="#7c3aed" stroke-width="1.5"/>
          <text x="455" y="120" text-anchor="middle" font-size="9" font-weight="600" fill="#fff">R</text>
          <circle cx="560" cy="116" r="10" fill="#a78bfa" stroke="#7c3aed" stroke-width="1.5"/>
          <text x="560" y="120" text-anchor="middle" font-size="9" font-weight="600" fill="#fff">Z</text>
          <!-- L2 edges -->
          <line x1="150" y1="116" x2="235" y2="116" stroke="#c4b5fd" stroke-width="1.2"/>
          <line x1="255" y1="116" x2="340" y2="116" stroke="#c4b5fd" stroke-width="1.2"/>
          <line x1="360" y1="116" x2="445" y2="116" stroke="#c4b5fd" stroke-width="1.2"/>
          <line x1="465" y1="116" x2="550" y2="116" stroke="#c4b5fd" stroke-width="1.2"/>

          <!-- Layer 1 background band -->
          <rect x="80" y="148" width="540" height="52" rx="8" fill="#ede9fe" opacity="0.18"/>
          <text x="68" y="178" text-anchor="end" font-size="10" font-weight="600" fill="#7B2FF7">L1</text>
          <!-- Layer 1 nodes: A,C,F,H,K,M,P,R,U,Z -->
          <g font-size="8" font-weight="600" fill="#fff" text-anchor="middle">
            <circle cx="112" cy="174" r="9" fill="#c4b5fd" stroke="#8b5cf6" stroke-width="1.2"/>
            <text x="112" y="177" font-size="8" fill="#3b0764">A</text>
            <circle cx="161" cy="174" r="9" fill="#c4b5fd" stroke="#8b5cf6" stroke-width="1.2"/>
            <text x="161" y="177" font-size="8" fill="#3b0764">C</text>
            <circle cx="210" cy="174" r="9" fill="#c4b5fd" stroke="#8b5cf6" stroke-width="1.2"/>
            <text x="210" y="177" font-size="8" fill="#3b0764">F</text>
            <circle cx="259" cy="174" r="9" fill="#c4b5fd" stroke="#8b5cf6" stroke-width="1.2"/>
            <text x="259" y="177" font-size="8" fill="#3b0764">H</text>
            <circle cx="308" cy="174" r="9" fill="#c4b5fd" stroke="#8b5cf6" stroke-width="1.2"/>
            <text x="308" y="177" font-size="8" fill="#3b0764">K</text>
            <circle cx="357" cy="174" r="9" fill="#c4b5fd" stroke="#8b5cf6" stroke-width="1.2"/>
            <text x="357" y="177" font-size="8" fill="#3b0764">M</text>
            <circle cx="406" cy="174" r="9" fill="#c4b5fd" stroke="#8b5cf6" stroke-width="1.2"/>
            <text x="406" y="177" font-size="8" fill="#3b0764">P</text>
            <circle cx="455" cy="174" r="9" fill="#c4b5fd" stroke="#8b5cf6" stroke-width="1.2"/>
            <text x="455" y="177" font-size="8" fill="#3b0764">R</text>
            <circle cx="504" cy="174" r="9" fill="#c4b5fd" stroke="#8b5cf6" stroke-width="1.2"/>
            <text x="504" y="177" font-size="8" fill="#3b0764">U</text>
            <circle cx="553" cy="174" r="9" fill="#c4b5fd" stroke="#8b5cf6" stroke-width="1.2"/>
            <text x="553" y="177" font-size="8" fill="#3b0764">Z</text>
          </g>
          <!-- L1 edges -->
          <g stroke="#ddd6fe" stroke-width="1">
            <line x1="121" y1="174" x2="152" y2="174"/><line x1="170" y1="174" x2="201" y2="174"/>
            <line x1="219" y1="174" x2="250" y2="174"/><line x1="268" y1="174" x2="299" y2="174"/>
            <line x1="317" y1="174" x2="348" y2="174"/><line x1="366" y1="174" x2="397" y2="174"/>
            <line x1="415" y1="174" x2="446" y2="174"/><line x1="464" y1="174" x2="495" y2="174"/>
            <line x1="513" y1="174" x2="544" y2="174"/>
          </g>

          <!-- Layer 0 background band -->
          <rect x="80" y="206" width="540" height="60" rx="8" fill="#fff" stroke="#e2e8f0" stroke-width="1"/>
          <text x="68" y="240" text-anchor="end" font-size="10" font-weight="600" fill="#7B2FF7">L0</text>
          <!-- Layer 0 nodes: all 22 densely packed -->
          <g font-size="6" fill="#64748b" text-anchor="middle">
            <circle cx="100" cy="236" r="7" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1"/><text x="100" y="239">A</text>
            <circle cx="122" cy="236" r="7" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1"/><text x="122" y="239">B</text>
            <circle cx="144" cy="236" r="7" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1"/><text x="144" y="239">C</text>
            <circle cx="166" cy="236" r="7" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1"/><text x="166" y="239">D</text>
            <circle cx="188" cy="236" r="7" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1"/><text x="188" y="239">E</text>
            <circle cx="210" cy="236" r="7" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1"/><text x="210" y="239">F</text>
            <circle cx="232" cy="236" r="7" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1"/><text x="232" y="239">G</text>
            <circle cx="254" cy="236" r="7" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1"/><text x="254" y="239">H</text>
            <circle cx="276" cy="236" r="7" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1"/><text x="276" y="239">I</text>
            <circle cx="298" cy="236" r="7" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1"/><text x="298" y="239">J</text>
            <circle cx="320" cy="236" r="7" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1"/><text x="320" y="239">K</text>
            <circle cx="342" cy="236" r="7" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1"/><text x="342" y="239">L</text>
            <circle cx="364" cy="236" r="7" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1"/><text x="364" y="239">M</text>
            <circle cx="386" cy="236" r="7" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1"/><text x="386" y="239">N</text>
            <circle cx="408" cy="236" r="7" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1"/><text x="408" y="239">O</text>
            <circle cx="430" cy="236" r="7" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1"/><text x="430" y="239">P</text>
            <!-- Q is the RESULT node - highlighted -->
            <circle cx="452" cy="236" r="8" fill="#d1fae5" stroke="#10b981" stroke-width="2.5"/><text x="452" y="239" font-weight="700" fill="#065f46" font-size="7">Q</text>
            <circle cx="474" cy="236" r="7" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1"/><text x="474" y="239">R</text>
            <circle cx="496" cy="236" r="7" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1"/><text x="496" y="239">S</text>
            <circle cx="518" cy="236" r="7" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1"/><text x="518" y="239">T</text>
            <circle cx="540" cy="236" r="7" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1"/><text x="540" y="239">U</text>
            <circle cx="562" cy="236" r="7" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1"/><text x="562" y="239">V</text>
            <circle cx="584" cy="236" r="7" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1"/><text x="584" y="239">W</text>
            <circle cx="606" cy="236" r="7" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1"/><text x="606" y="239">X</text>
          </g>
          <!-- L0 dense edges (subset) -->
          <g stroke="#e2e8f0" stroke-width="0.6" opacity="0.5">
            <line x1="107" y1="236" x2="115" y2="236"/><line x1="129" y1="236" x2="137" y2="236"/>
            <line x1="151" y1="236" x2="159" y2="236"/><line x1="173" y1="236" x2="181" y2="236"/>
            <line x1="195" y1="236" x2="203" y2="236"/><line x1="217" y1="236" x2="225" y2="236"/>
            <line x1="239" y1="236" x2="247" y2="236"/><line x1="261" y1="236" x2="269" y2="236"/>
            <line x1="283" y1="236" x2="291" y2="236"/><line x1="305" y1="236" x2="313" y2="236"/>
            <line x1="327" y1="236" x2="335" y2="236"/><line x1="349" y1="236" x2="357" y2="236"/>
            <line x1="371" y1="236" x2="379" y2="236"/><line x1="393" y1="236" x2="401" y2="236"/>
            <line x1="415" y1="236" x2="423" y2="236"/><line x1="437" y1="236" x2="445" y2="236"/>
            <line x1="459" y1="236" x2="467" y2="236"/><line x1="481" y1="236" x2="489" y2="236"/>
            <line x1="503" y1="236" x2="511" y2="236"/><line x1="525" y1="236" x2="533" y2="236"/>
            <line x1="547" y1="236" x2="555" y2="236"/><line x1="569" y1="236" x2="577" y2="236"/>
            <line x1="591" y1="236" x2="599" y2="236"/>
            <!-- Some cross-links for density -->
            <line x1="100" y1="231" x2="144" y2="231"/><line x1="188" y1="241" x2="254" y2="241"/>
            <line x1="298" y1="231" x2="364" y2="231"/><line x1="430" y1="241" x2="496" y2="241"/>
            <line x1="518" y1="231" x2="584" y2="231"/>
          </g>

          <!-- Traversal path (thick, colored) -->
          <!-- Query enters at L3, node A -->
          <defs>
            <marker id="hnsw-path-arrow" markerWidth="7" markerHeight="5" refX="7" refY="2.5" orient="auto">
              <path d="M0,0 L7,2.5 L0,5" fill="#FC642D"/>
            </marker>
          </defs>
          <!-- Query label + arrow into L3 -->
          <text x="90" y="40" font-size="11" font-weight="700" fill="#FC642D">query</text>
          <line x1="110" y1="43" x2="132" y2="52" stroke="#FC642D" stroke-width="2.5" marker-end="url(#hnsw-path-arrow)"/>
          <!-- L3: A -> M -->
          <path d="M152,58 L338,58" stroke="#FC642D" stroke-width="3" fill="none" marker-end="url(#hnsw-path-arrow)"/>
          <!-- L3 -> L2: M drops down -->
          <line x1="350" y1="70" x2="350" y2="106" stroke="#FC642D" stroke-width="3" stroke-dasharray="4,3" marker-end="url(#hnsw-path-arrow)"/>
          <!-- L2: M -> R -->
          <path d="M360,116 L445,116" stroke="#FC642D" stroke-width="3" fill="none" marker-end="url(#hnsw-path-arrow)"/>
          <!-- L2 -> L1: R drops down -->
          <line x1="455" y1="126" x2="455" y2="165" stroke="#FC642D" stroke-width="3" stroke-dasharray="4,3" marker-end="url(#hnsw-path-arrow)"/>
          <!-- L1: R -> P -->
          <path d="M446,174 L415,174" stroke="#FC642D" stroke-width="3" fill="none" marker-end="url(#hnsw-path-arrow)"/>
          <!-- L1 -> L0: P drops down -->
          <line x1="406" y1="183" x2="435" y2="228" stroke="#FC642D" stroke-width="3" stroke-dasharray="4,3" marker-end="url(#hnsw-path-arrow)"/>
          <!-- L0: -> Q result -->
          <path d="M437,236 L444,236" stroke="#FC642D" stroke-width="3" fill="none" marker-end="url(#hnsw-path-arrow)"/>

          <!-- Vertical connection lines (faint) between layers -->
          <g stroke="#ddd6fe" stroke-width="0.8" stroke-dasharray="2,2" opacity="0.5">
            <line x1="140" y1="70" x2="140" y2="106"/><line x1="350" y1="70" x2="350" y2="106"/><line x1="560" y1="70" x2="560" y2="106"/>
            <line x1="140" y1="126" x2="112" y2="165"/><line x1="245" y1="126" x2="210" y2="165"/>
            <line x1="350" y1="126" x2="357" y2="165"/><line x1="455" y1="126" x2="455" y2="165"/><line x1="560" y1="126" x2="553" y2="165"/>
          </g>

          <!-- Legend at bottom -->
          <rect x="100" y="275" width="500" height="28" rx="8" fill="#fff7ed" stroke="#FC642D" stroke-width="1.5"/>
          <line x1="120" y1="289" x2="145" y2="289" stroke="#FC642D" stroke-width="3"/>
          <text x="152" y="293" font-size="10" fill="#1e293b">Traversal path: enter at top, greedily navigate down to result</text>
          <text x="460" y="293" font-size="10" font-weight="700" fill="#FC642D">O(log N) hops</text>

          <!-- Layer labels on right -->
          <text x="640" y="62" font-size="8" fill="#7B2FF7" opacity="0.7">sparse</text>
          <text x="640" y="120" font-size="8" fill="#7B2FF7" opacity="0.5">medium</text>
          <text x="640" y="178" font-size="8" fill="#7B2FF7" opacity="0.4">denser</text>
          <text x="640" y="240" font-size="8" fill="#475569">all nodes</text>
        </svg>
      </div>

      <h4>Multi-Layer Structure</h4>
      <pre><code><span class="cm">Layer 3 (sparse):</span>    <span class="kw">A</span> ―――――――――――――――― <span class="kw">M</span> ―――――――――――――――――――― <span class="kw">Z</span>
                         │                  │                       │
<span class="cm">Layer 2:</span>              <span class="fn">A</span> ―――― <span class="fn">F</span> ――――――――― <span class="fn">M</span> ――――――― <span class="fn">R</span> ――――――― <span class="fn">Z</span>
                         │      │            │          │            │
<span class="cm">Layer 1:</span>              <span class="var">A</span> ― <span class="var">C</span> ― <span class="var">F</span> ― <span class="var">H</span> ― <span class="var">K</span> ― <span class="var">M</span> ― <span class="var">P</span> ― <span class="var">R</span> ― <span class="var">U</span> ― <span class="var">Z</span>
                         │   │   │   │   │   │   │   │   │   │
<span class="cm">Layer 0 (all nodes):</span> A B C D E F G H I J K L M N O P Q R S T U V W X Y Z

<span class="num">Query "find nearest to Q":</span>
  → Enter Layer 3 at entry point A
  → Greedy: A → M (closer to Q) → stuck, drop to Layer 2
  → Greedy: M → R (closer) → stuck, drop to Layer 1
  → Greedy: R → P → Q found at Layer 0 with local refinement</code></pre>

      <h4>Build Algorithm (Insert)</h4>
      <pre><code><span class="kw">def</span> <span class="fn">insert</span>(new_vector):
    <span class="cm"># 1. Determine max layer for this vector (random, exponential decay)</span>
    max_layer = <span class="fn">floor</span>(-<span class="fn">ln</span>(<span class="fn">random</span>()) × mL)  <span class="cm"># mL = 1/ln(M)</span>

    <span class="cm"># 2. Find entry point at the top layer</span>
    entry = global_entry_point

    <span class="cm"># 3. Descend from top → max_layer+1 (greedy, single nearest)</span>
    <span class="kw">for</span> layer <span class="kw">in</span> <span class="fn">range</span>(top_layer, max_layer, -<span class="num">1</span>):
        entry = <span class="fn">greedy_search</span>(entry, new_vector, layer, ef=<span class="num">1</span>)

    <span class="cm"># 4. From max_layer → 0, do beam search + connect edges</span>
    <span class="kw">for</span> layer <span class="kw">in</span> <span class="fn">range</span>(max_layer, -<span class="num">1</span>, -<span class="num">1</span>):
        neighbors = <span class="fn">beam_search</span>(entry, new_vector, layer, ef=ef_construction)
        <span class="cm"># Select M best neighbors using heuristic</span>
        selected = <span class="fn">select_neighbors</span>(neighbors, M)
        <span class="cm"># Add bidirectional edges</span>
        <span class="kw">for</span> n <span class="kw">in</span> selected:
            <span class="fn">add_edge</span>(new_vector, n, layer)
            <span class="fn">add_edge</span>(n, new_vector, layer)
            <span class="cm"># Prune if n now has too many edges</span>
            <span class="kw">if</span> <span class="fn">num_edges</span>(n, layer) > M_max:
                <span class="fn">prune_edges</span>(n, layer, M_max)</code></pre>

      <h4>Search Algorithm (Query)</h4>
      <pre><code><span class="kw">def</span> <span class="fn">search</span>(query, k, ef_search=<span class="num">128</span>):
    <span class="cm"># 1. Start at entry point, top layer</span>
    entry = global_entry_point

    <span class="cm"># 2. Greedy descent: top layer → layer 1 (single nearest neighbor)</span>
    <span class="kw">for</span> layer <span class="kw">in</span> <span class="fn">range</span>(top_layer, <span class="num">0</span>, -<span class="num">1</span>):
        entry = <span class="fn">greedy_search</span>(entry, query, layer, ef=<span class="num">1</span>)

    <span class="cm"># 3. Beam search at layer 0 with ef_search candidates</span>
    candidates = <span class="fn">beam_search</span>(entry, query, layer=<span class="num">0</span>, ef=ef_search)

    <span class="cm"># 4. Return top-k from candidates</span>
    <span class="kw">return</span> <span class="fn">top_k</span>(candidates, k)

    <span class="cm"># Complexity: O(log(N) × M × ef_search) — sublinear!</span></code></pre>

      <h4>Parameter Deep Dive</h4>
      <table class="param-table">
        <tr><th>Parameter</th><th>Default</th><th>Range</th><th>Effect ↑</th><th>Trade-off</th></tr>
        <tr><td><strong>M</strong></td><td>16</td><td>4-64</td><td>Better recall, more connections</td><td>Memory ↑ (each edge = 4-8 bytes)</td></tr>
        <tr><td><strong>M_max0</strong></td><td>2×M</td><td>M-4M</td><td>Denser layer 0</td><td>Layer 0 search quality vs memory</td></tr>
        <tr><td><strong>ef_construction</strong></td><td>200</td><td>100-500</td><td>Better graph quality</td><td>Build time ↑ (linear)</td></tr>
        <tr><td><strong>ef_search</strong></td><td>128</td><td>k-2000</td><td>Better recall</td><td>Query latency ↑ (linear)</td></tr>
        <tr><td><strong>mL</strong></td><td>1/ln(M)</td><td>—</td><td>Controls layer distribution</td><td>Higher = more layers = faster navigation</td></tr>
      </table>

      <h4>Recall vs ef_search (10M vectors, M=16)</h4>
      <table class="param-table">
        <tr><th>ef_search</th><th>Recall@10</th><th>Latency</th><th>Nodes Visited</th></tr>
        <tr><td>10</td><td>~72%</td><td>~0.1ms</td><td>~160</td></tr>
        <tr><td>32</td><td>~89%</td><td>~0.3ms</td><td>~510</td></tr>
        <tr><td>64</td><td>~95%</td><td>~0.5ms</td><td>~1,020</td></tr>
        <tr><td>128</td><td>~98%</td><td>~0.9ms</td><td>~2,040</td></tr>
        <tr><td>256</td><td>~99.2%</td><td>~1.7ms</td><td>~4,090</td></tr>
        <tr><td>512</td><td>~99.7%</td><td>~3.2ms</td><td>~8,180</td></tr>
      </table>

      <h4>Memory Calculation</h4>
      <pre><code><span class="cm">// Memory per vector in HNSW (M=16, 768d, float32)</span>
<span class="var">raw_vector</span>   = <span class="num">768</span> × <span class="num">4</span> bytes           = <span class="num">3,072 bytes</span>
<span class="var">graph_edges</span>  = M × num_layers × <span class="num">4</span> bytes  ≈ <span class="num">16</span> × <span class="num">4</span> × <span class="num">4</span> = <span class="num">256 bytes</span>
<span class="var">metadata</span>     = id + flags                  ≈ <span class="num">24 bytes</span>
<span class="var">total/vec</span>    = <span class="num">~3,352 bytes</span> (<span class="num">1.09x</span> overhead)

<span class="cm">// For 10M vectors:</span>
<span class="var">total_memory</span> = <span class="num">10M</span> × <span class="num">3,352</span> = <span class="num">~33.5 GB</span>
<span class="cm">// With OS page cache + working memory: ~40 GB recommended</span>

<span class="cm">// For 1B vectors (full cluster):</span>
<span class="var">cluster_ram</span>  = <span class="num">1B</span> × <span class="num">3,352</span> = <span class="num">~3.35 TB</span> across all nodes</code></pre>

      <h4>Deletion Strategy</h4>
      <p>HNSW doesn't natively support deletes well (removing a node breaks graph connectivity). Two approaches:</p>
      <ul>
        <li><strong>Tombstone + Rebuild:</strong> Mark deleted, filter at query time. Periodic background rebuild removes tombstones. Simple but wastes memory.</li>
        <li><strong>Edge Repair:</strong> On delete, reconnect orphaned neighbors to each other. Complex but preserves graph quality. Used by Qdrant.</li>
      </ul>

      <div class="tag-row">
        <span class="tag tag-pro">Excellent Recall (&gt;95%)</span>
        <span class="tag tag-pro">Sub-ms Latency</span>
        <span class="tag tag-pro">Online Inserts</span>
        <span class="tag tag-pro">No Training Required</span>
        <span class="tag tag-con">High Memory (1.1-1.5x)</span>
        <span class="tag tag-con">Slow Deletes</span>
        <span class="tag tag-con">Build Time O(N×log(N)×M)</span>
      </div>

      <div class="when-use">
        <strong>When to use:</strong> The default choice for most vector DB workloads. Best when you need low latency (&lt;5ms), high recall (&gt;95%), and can afford the memory. Used by Pinecone, Qdrant, Weaviate, pgvector (with ivfflat or hnsw), and Milvus.
      </div>
    </div>
  </details>

  <!-- ALGORITHM 4: PQ -->
  <details class="algo-detail">
    <summary>
      4. PQ (Product Quantization) — Vector Compression
      <span class="algo-badge advanced">Memory Optimization</span>
    </summary>
    <div class="algo-body">
      <h4>Core Idea</h4>
      <p>Instead of storing full float32 vectors, PQ compresses them by splitting each vector into <strong>m sub-vectors</strong>, then replacing each sub-vector with the ID of its nearest centroid from a learned codebook. This reduces each vector from thousands of bytes to tens of bytes.</p>

      <div class="diagram-box" style="margin:16px 0;">
        <svg viewBox="0 0 700 250" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:auto;font-family:'Inter',system-ui,sans-serif;">
          <rect width="700" height="250" fill="#f8fafc" rx="12"/>
          <!-- Title -->
          <text x="350" y="22" text-anchor="middle" font-size="13" font-weight="700" fill="#1e293b">Product Quantization: Split, Quantize, Compress</text>

          <!-- Original vector bar -->
          <text x="20" y="52" font-size="10" font-weight="600" fill="#1e293b">768-dim vector</text>
          <text x="20" y="63" font-size="8" fill="#64748b">(3,072 bytes)</text>
          <!-- 8 colored segments -->
          <rect x="110" y="42" width="72" height="28" rx="4" fill="#FF5A5F" opacity="0.8"/>
          <text x="146" y="60" text-anchor="middle" font-size="8" font-weight="600" fill="#fff">d1-d96</text>
          <rect x="182" y="42" width="72" height="28" rx="4" fill="#FC642D" opacity="0.8"/>
          <text x="218" y="60" text-anchor="middle" font-size="8" font-weight="600" fill="#fff">d97-d192</text>
          <rect x="254" y="42" width="72" height="28" rx="4" fill="#f59e0b" opacity="0.8"/>
          <text x="290" y="60" text-anchor="middle" font-size="8" font-weight="600" fill="#fff">d193-d288</text>
          <rect x="326" y="42" width="72" height="28" rx="4" fill="#10b981" opacity="0.8"/>
          <text x="362" y="60" text-anchor="middle" font-size="8" font-weight="600" fill="#fff">d289-d384</text>
          <rect x="398" y="42" width="72" height="28" rx="4" fill="#00A699" opacity="0.8"/>
          <text x="434" y="60" text-anchor="middle" font-size="8" font-weight="600" fill="#fff">d385-d480</text>
          <rect x="470" y="42" width="72" height="28" rx="4" fill="#428BF9" opacity="0.8"/>
          <text x="506" y="60" text-anchor="middle" font-size="8" font-weight="600" fill="#fff">d481-d576</text>
          <rect x="542" y="42" width="72" height="28" rx="4" fill="#7B2FF7" opacity="0.8"/>
          <text x="578" y="60" text-anchor="middle" font-size="8" font-weight="600" fill="#fff">d577-d672</text>
          <rect x="614" y="42" width="72" height="28" rx="4" fill="#a855f7" opacity="0.8"/>
          <text x="650" y="60" text-anchor="middle" font-size="8" font-weight="600" fill="#fff">d673-d768</text>

          <!-- Arrows down to codebooks -->
          <g stroke="#94a3b8" stroke-width="1.2" fill="none" marker-end="url(#pq-arrow-down)">
            <line x1="146" y1="70" x2="146" y2="90"/>
            <line x1="218" y1="70" x2="218" y2="90"/>
            <line x1="290" y1="70" x2="290" y2="90"/>
            <line x1="362" y1="70" x2="362" y2="90"/>
            <line x1="434" y1="70" x2="434" y2="90"/>
            <line x1="506" y1="70" x2="506" y2="90"/>
            <line x1="578" y1="70" x2="578" y2="90"/>
            <line x1="650" y1="70" x2="650" y2="90"/>
          </g>

          <!-- Codebook grids (small 4x4 representing 256 entries) -->
          <g opacity="0.9">
            <!-- Codebook 1 -->
            <rect x="126" y="93" width="40" height="32" rx="3" fill="#fff" stroke="#FF5A5F" stroke-width="1.2"/>
            <line x1="136" y1="93" x2="136" y2="125" stroke="#FF5A5F" stroke-width="0.4" opacity="0.4"/>
            <line x1="146" y1="93" x2="146" y2="125" stroke="#FF5A5F" stroke-width="0.4" opacity="0.4"/>
            <line x1="156" y1="93" x2="156" y2="125" stroke="#FF5A5F" stroke-width="0.4" opacity="0.4"/>
            <line x1="126" y1="101" x2="166" y2="101" stroke="#FF5A5F" stroke-width="0.4" opacity="0.4"/>
            <line x1="126" y1="109" x2="166" y2="109" stroke="#FF5A5F" stroke-width="0.4" opacity="0.4"/>
            <line x1="126" y1="117" x2="166" y2="117" stroke="#FF5A5F" stroke-width="0.4" opacity="0.4"/>
            <!-- Highlighted cell -->
            <rect x="146" y="101" width="10" height="8" fill="#FF5A5F" opacity="0.5"/>
            <text x="146" y="133" font-size="6" fill="#64748b" text-anchor="middle">256 entries</text>

            <!-- Codebook 2 -->
            <rect x="198" y="93" width="40" height="32" rx="3" fill="#fff" stroke="#FC642D" stroke-width="1.2"/>
            <line x1="208" y1="93" x2="208" y2="125" stroke="#FC642D" stroke-width="0.4" opacity="0.4"/>
            <line x1="218" y1="93" x2="218" y2="125" stroke="#FC642D" stroke-width="0.4" opacity="0.4"/>
            <line x1="228" y1="93" x2="228" y2="125" stroke="#FC642D" stroke-width="0.4" opacity="0.4"/>
            <line x1="198" y1="101" x2="238" y2="101" stroke="#FC642D" stroke-width="0.4" opacity="0.4"/>
            <line x1="198" y1="109" x2="238" y2="109" stroke="#FC642D" stroke-width="0.4" opacity="0.4"/>
            <line x1="198" y1="117" x2="238" y2="117" stroke="#FC642D" stroke-width="0.4" opacity="0.4"/>
            <rect x="208" y="109" width="10" height="8" fill="#FC642D" opacity="0.5"/>

            <!-- Codebook 3 -->
            <rect x="270" y="93" width="40" height="32" rx="3" fill="#fff" stroke="#f59e0b" stroke-width="1.2"/>
            <line x1="280" y1="93" x2="280" y2="125" stroke="#f59e0b" stroke-width="0.4" opacity="0.4"/>
            <line x1="290" y1="93" x2="290" y2="125" stroke="#f59e0b" stroke-width="0.4" opacity="0.4"/>
            <line x1="300" y1="93" x2="300" y2="125" stroke="#f59e0b" stroke-width="0.4" opacity="0.4"/>
            <line x1="270" y1="101" x2="310" y2="101" stroke="#f59e0b" stroke-width="0.4" opacity="0.4"/>
            <line x1="270" y1="109" x2="310" y2="109" stroke="#f59e0b" stroke-width="0.4" opacity="0.4"/>
            <line x1="270" y1="117" x2="310" y2="117" stroke="#f59e0b" stroke-width="0.4" opacity="0.4"/>
            <rect x="280" y="93" width="10" height="8" fill="#f59e0b" opacity="0.5"/>

            <!-- Codebook 4 -->
            <rect x="342" y="93" width="40" height="32" rx="3" fill="#fff" stroke="#10b981" stroke-width="1.2"/>
            <line x1="352" y1="93" x2="352" y2="125" stroke="#10b981" stroke-width="0.4" opacity="0.4"/>
            <line x1="362" y1="93" x2="362" y2="125" stroke="#10b981" stroke-width="0.4" opacity="0.4"/>
            <line x1="372" y1="93" x2="372" y2="125" stroke="#10b981" stroke-width="0.4" opacity="0.4"/>
            <line x1="342" y1="101" x2="382" y2="101" stroke="#10b981" stroke-width="0.4" opacity="0.4"/>
            <line x1="342" y1="109" x2="382" y2="109" stroke="#10b981" stroke-width="0.4" opacity="0.4"/>
            <line x1="342" y1="117" x2="382" y2="117" stroke="#10b981" stroke-width="0.4" opacity="0.4"/>
            <rect x="362" y="117" width="10" height="8" fill="#10b981" opacity="0.5"/>

            <!-- Codebook 5 -->
            <rect x="414" y="93" width="40" height="32" rx="3" fill="#fff" stroke="#00A699" stroke-width="1.2"/>
            <line x1="424" y1="93" x2="424" y2="125" stroke="#00A699" stroke-width="0.4" opacity="0.4"/>
            <line x1="434" y1="93" x2="434" y2="125" stroke="#00A699" stroke-width="0.4" opacity="0.4"/>
            <line x1="444" y1="93" x2="444" y2="125" stroke="#00A699" stroke-width="0.4" opacity="0.4"/>
            <line x1="414" y1="101" x2="454" y2="101" stroke="#00A699" stroke-width="0.4" opacity="0.4"/>
            <line x1="414" y1="109" x2="454" y2="109" stroke="#00A699" stroke-width="0.4" opacity="0.4"/>
            <line x1="414" y1="117" x2="454" y2="117" stroke="#00A699" stroke-width="0.4" opacity="0.4"/>
            <rect x="424" y="101" width="10" height="8" fill="#00A699" opacity="0.5"/>

            <!-- Codebook 6 -->
            <rect x="486" y="93" width="40" height="32" rx="3" fill="#fff" stroke="#428BF9" stroke-width="1.2"/>
            <line x1="496" y1="93" x2="496" y2="125" stroke="#428BF9" stroke-width="0.4" opacity="0.4"/>
            <line x1="506" y1="93" x2="506" y2="125" stroke="#428BF9" stroke-width="0.4" opacity="0.4"/>
            <line x1="516" y1="93" x2="516" y2="125" stroke="#428BF9" stroke-width="0.4" opacity="0.4"/>
            <line x1="486" y1="101" x2="526" y2="101" stroke="#428BF9" stroke-width="0.4" opacity="0.4"/>
            <line x1="486" y1="109" x2="526" y2="109" stroke="#428BF9" stroke-width="0.4" opacity="0.4"/>
            <line x1="486" y1="117" x2="526" y2="117" stroke="#428BF9" stroke-width="0.4" opacity="0.4"/>
            <rect x="516" y="109" width="10" height="8" fill="#428BF9" opacity="0.5"/>

            <!-- Codebook 7 -->
            <rect x="558" y="93" width="40" height="32" rx="3" fill="#fff" stroke="#7B2FF7" stroke-width="1.2"/>
            <line x1="568" y1="93" x2="568" y2="125" stroke="#7B2FF7" stroke-width="0.4" opacity="0.4"/>
            <line x1="578" y1="93" x2="578" y2="125" stroke="#7B2FF7" stroke-width="0.4" opacity="0.4"/>
            <line x1="588" y1="93" x2="588" y2="125" stroke="#7B2FF7" stroke-width="0.4" opacity="0.4"/>
            <line x1="558" y1="101" x2="598" y2="101" stroke="#7B2FF7" stroke-width="0.4" opacity="0.4"/>
            <line x1="558" y1="109" x2="598" y2="109" stroke="#7B2FF7" stroke-width="0.4" opacity="0.4"/>
            <line x1="558" y1="117" x2="598" y2="117" stroke="#7B2FF7" stroke-width="0.4" opacity="0.4"/>
            <rect x="568" y="93" width="10" height="8" fill="#7B2FF7" opacity="0.5"/>

            <!-- Codebook 8 -->
            <rect x="630" y="93" width="40" height="32" rx="3" fill="#fff" stroke="#a855f7" stroke-width="1.2"/>
            <line x1="640" y1="93" x2="640" y2="125" stroke="#a855f7" stroke-width="0.4" opacity="0.4"/>
            <line x1="650" y1="93" x2="650" y2="125" stroke="#a855f7" stroke-width="0.4" opacity="0.4"/>
            <line x1="660" y1="93" x2="660" y2="125" stroke="#a855f7" stroke-width="0.4" opacity="0.4"/>
            <line x1="630" y1="101" x2="670" y2="101" stroke="#a855f7" stroke-width="0.4" opacity="0.4"/>
            <line x1="630" y1="109" x2="670" y2="109" stroke="#a855f7" stroke-width="0.4" opacity="0.4"/>
            <line x1="630" y1="117" x2="670" y2="117" stroke="#a855f7" stroke-width="0.4" opacity="0.4"/>
            <rect x="650" y="117" width="10" height="8" fill="#a855f7" opacity="0.5"/>
          </g>

          <!-- Arrows from codebooks down to output bytes -->
          <g stroke="#94a3b8" stroke-width="1" fill="none" marker-end="url(#pq-arrow-down)">
            <line x1="146" y1="138" x2="146" y2="157"/>
            <line x1="218" y1="138" x2="218" y2="157"/>
            <line x1="290" y1="138" x2="290" y2="157"/>
            <line x1="362" y1="138" x2="362" y2="157"/>
            <line x1="434" y1="138" x2="434" y2="157"/>
            <line x1="506" y1="138" x2="506" y2="157"/>
            <line x1="578" y1="138" x2="578" y2="157"/>
            <line x1="650" y1="138" x2="650" y2="157"/>
          </g>

          <!-- Output: 8 byte codes -->
          <text x="20" y="172" font-size="10" font-weight="600" fill="#1e293b">Compressed</text>
          <text x="20" y="183" font-size="8" fill="#64748b">(8 bytes!)</text>
          <g font-size="8" text-anchor="middle" font-weight="700" fill="#fff">
            <rect x="126" y="159" width="40" height="22" rx="4" fill="#FF5A5F"/><text x="146" y="174" fill="#fff">0x3A</text>
            <rect x="198" y="159" width="40" height="22" rx="4" fill="#FC642D"/><text x="218" y="174" fill="#fff">0xB7</text>
            <rect x="270" y="159" width="40" height="22" rx="4" fill="#f59e0b"/><text x="290" y="174" fill="#fff">0x12</text>
            <rect x="342" y="159" width="40" height="22" rx="4" fill="#10b981"/><text x="362" y="174" fill="#fff">0xF4</text>
            <rect x="414" y="159" width="40" height="22" rx="4" fill="#00A699"/><text x="434" y="174" fill="#fff">0x6E</text>
            <rect x="486" y="159" width="40" height="22" rx="4" fill="#428BF9"/><text x="506" y="174" fill="#fff">0x91</text>
            <rect x="558" y="159" width="40" height="22" rx="4" fill="#7B2FF7"/><text x="578" y="174" fill="#fff">0x05</text>
            <rect x="630" y="159" width="40" height="22" rx="4" fill="#a855f7"/><text x="650" y="174" fill="#fff">0xCC</text>
          </g>

          <!-- Bottom comparison bar -->
          <rect x="80" y="200" width="540" height="38" rx="10" fill="#f0fdf4" stroke="#10b981" stroke-width="1.5"/>
          <!-- Original bar (large) -->
          <rect x="100" y="208" width="260" height="10" rx="3" fill="#fca5a5" opacity="0.6"/>
          <text x="230" y="216" text-anchor="middle" font-size="7" fill="#991b1b" font-weight="600">3,072 bytes (float32)</text>
          <!-- Compressed bar (tiny) -->
          <rect x="100" y="222" width="8" height="10" rx="3" fill="#10b981"/>
          <text x="115" y="230" font-size="7" fill="#065f46" font-weight="600">8 bytes</text>
          <!-- Compression label -->
          <rect x="430" y="205" width="170" height="28" rx="8" fill="#10b981"/>
          <text x="515" y="223" text-anchor="middle" font-size="12" font-weight="800" fill="#fff">384x compression</text>

          <defs>
            <marker id="pq-arrow-down" markerWidth="6" markerHeight="5" refX="3" refY="5" orient="auto">
              <path d="M0,0 L3,5 L6,0" fill="#94a3b8"/>
            </marker>
          </defs>
        </svg>
      </div>

      <h4>Compression Math</h4>
      <pre><code><span class="cm">// Original vector: 768 dimensions × 4 bytes = 3,072 bytes</span>

<span class="cm">// Step 1: Split into m=96 sub-vectors of 8 dimensions each</span>
<span class="var">sub_vectors</span> = <span class="fn">split</span>(vector_768d, m=<span class="num">96</span>)  <span class="cm">// 96 groups of 8 dims</span>

<span class="cm">// Step 2: For each sub-vector, find nearest centroid (256 centroids per group)</span>
<span class="cm">// This is learned offline via k-means on training data</span>
<span class="var">codes</span> = [<span class="fn">nearest_centroid_id</span>(sv) <span class="kw">for</span> sv <span class="kw">in</span> sub_vectors]

<span class="cm">// Step 3: Store only the centroid IDs (1 byte each for 256 centroids)</span>
<span class="var">compressed</span> = <span class="num">96</span> codes × <span class="num">1</span> byte = <span class="num">96 bytes</span>

<span class="cm">// Compression ratio: 3,072 / 96 = 32× reduction!</span>

<span class="cm">// QUERY: Precompute lookup table, then sum</span>
<span class="cm">// For each sub-space i, compute distance from query_sub[i] to all 256 centroids</span>
<span class="var">lookup</span>[i][j] = <span class="fn">dist</span>(query_sub[i], codebook[i][j])  <span class="cm">// 96 × 256 entries</span>
<span class="cm">// Distance to any compressed vector = sum of 96 table lookups</span>
<span class="var">approx_dist</span> = <span class="fn">sum</span>(lookup[i][codes[i]] <span class="kw">for</span> i <span class="kw">in</span> <span class="fn">range</span>(<span class="num">96</span>))</code></pre>

      <h4>Compression vs Recall Trade-off</h4>
      <table class="param-table">
        <tr><th>Config (768d)</th><th>Bytes/Vec</th><th>Compression</th><th>Recall@10</th><th>Memory for 1B Vectors</th></tr>
        <tr><td>No PQ (float32)</td><td>3,072</td><td>1x</td><td>100%</td><td>3.07 TB</td></tr>
        <tr><td>PQ m=96, 8-bit</td><td>96</td><td>32x</td><td>~92%</td><td>96 GB</td></tr>
        <tr><td>PQ m=48, 8-bit</td><td>48</td><td>64x</td><td>~85%</td><td>48 GB</td></tr>
        <tr><td>PQ m=192, 8-bit</td><td>192</td><td>16x</td><td>~95%</td><td>192 GB</td></tr>
      </table>

      <h4>Two-Phase Search with Re-ranking</h4>
      <p>To recover recall lost by quantization, use a <strong>two-phase approach</strong>: (1) PQ finds top-100 approximate candidates, (2) re-rank those 100 using exact full-precision vectors from disk/SSD. This recovers 3-5% recall at minimal latency cost.</p>

      <div class="tag-row">
        <span class="tag tag-pro">4-32× Memory Reduction</span>
        <span class="tag tag-pro">Fast Lookup-Based Distance</span>
        <span class="tag tag-pro">Combinable with IVF/HNSW</span>
        <span class="tag tag-con">5-15% Recall Loss</span>
        <span class="tag tag-con">Requires Offline Training</span>
        <span class="tag tag-con">Not Great for High-Dim (&gt;1536d)</span>
      </div>

      <div class="when-use">
        <strong>When to use:</strong> When memory is the bottleneck — you have more vectors than fit in RAM with full precision. Essential for billion-scale deployments. Almost always combined with IVF or HNSW rather than used standalone.
      </div>
    </div>
  </details>

  <!-- ALGORITHM 5: IVF-PQ -->
  <details class="algo-detail">
    <summary>
      5. IVF-PQ (Combined) — Billion-Scale Workhorse
      <span class="algo-badge advanced">Billion Scale</span>
    </summary>
    <div class="algo-body">
      <h4>How It Works</h4>
      <p>Combines the <strong>coarse partitioning</strong> of IVF with the <strong>memory compression</strong> of PQ. Two-level structure: first find relevant clusters (IVF), then search within clusters using compressed vectors (PQ).</p>

      <div class="diagram-box" style="margin:16px 0;">
        <svg viewBox="0 0 700 280" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:auto;font-family:'Inter',system-ui,sans-serif;">
          <rect width="700" height="280" fill="#f8fafc" rx="12"/>
          <!-- Title -->
          <text x="350" y="22" text-anchor="middle" font-size="13" font-weight="700" fill="#1e293b">IVF-PQ: Cluster First, Then Search Compressed Vectors</text>

          <!-- LEFT SIDE: IVF step -->
          <rect x="15" y="35" width="280" height="200" rx="10" fill="#f0f4ff" stroke="#428BF9" stroke-width="1.5" stroke-dasharray="6,3"/>
          <text x="155" y="52" text-anchor="middle" font-size="11" font-weight="700" fill="#428BF9">Step 1: IVF (Find Clusters)</text>

          <!-- Query Q -->
          <circle cx="45" cy="130" r="18" fill="#428BF9" stroke="#2563eb" stroke-width="2"/>
          <text x="45" y="134" text-anchor="middle" font-size="12" font-weight="700" fill="#fff">Q</text>

          <!-- Cluster A (highlighted) -->
          <ellipse cx="170" cy="95" rx="65" ry="35" fill="#fef2f2" stroke="#FF5A5F" stroke-width="2" opacity="0.9"/>
          <circle cx="170" cy="95" r="8" fill="#FF5A5F" stroke="#dc2626" stroke-width="1.5"/>
          <text x="170" y="98" text-anchor="middle" font-size="6" font-weight="700" fill="#fff">C1</text>
          <circle cx="145" cy="82" r="4" fill="#fca5a5"/><circle cx="160" cy="78" r="4" fill="#fca5a5"/>
          <circle cx="185" cy="80" r="4" fill="#fca5a5"/><circle cx="195" cy="100" r="4" fill="#fca5a5"/>
          <circle cx="150" cy="105" r="4" fill="#fca5a5"/><circle cx="180" cy="110" r="4" fill="#fca5a5"/>
          <!-- Arrow Q -> C1 -->
          <line x1="63" y1="123" x2="100" y2="100" stroke="#FF5A5F" stroke-width="2" marker-end="url(#ivfpq-arrow)"/>

          <!-- Cluster B (highlighted) -->
          <ellipse cx="170" cy="175" rx="65" ry="35" fill="#f0fdf4" stroke="#10b981" stroke-width="2" opacity="0.9"/>
          <circle cx="170" cy="175" r="8" fill="#10b981" stroke="#059669" stroke-width="1.5"/>
          <text x="170" y="178" text-anchor="middle" font-size="6" font-weight="700" fill="#fff">C2</text>
          <circle cx="145" cy="162" r="4" fill="#86efac"/><circle cx="160" cy="158" r="4" fill="#86efac"/>
          <circle cx="190" cy="165" r="4" fill="#86efac"/><circle cx="195" cy="185" r="4" fill="#86efac"/>
          <circle cx="148" cy="188" r="4" fill="#86efac"/><circle cx="180" cy="190" r="4" fill="#86efac"/>
          <!-- Arrow Q -> C2 -->
          <line x1="63" y1="137" x2="100" y2="170" stroke="#10b981" stroke-width="2" marker-end="url(#ivfpq-arrow-g)"/>

          <!-- Grayed clusters (C3, C4 as tiny labels) -->
          <ellipse cx="250" cy="135" rx="30" ry="15" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1" opacity="0.4"/>
          <text x="250" y="139" text-anchor="middle" font-size="7" fill="#94a3b8">C3, C4...</text>

          <!-- CENTER: Residual arrow -->
          <rect x="300" y="95" width="90" height="50" rx="8" fill="#fff7ed" stroke="#FC642D" stroke-width="1.5"/>
          <text x="345" y="114" text-anchor="middle" font-size="9" font-weight="700" fill="#FC642D">residual =</text>
          <text x="345" y="128" text-anchor="middle" font-size="9" font-weight="600" fill="#FC642D">vec - centroid</text>
          <!-- Arrow from IVF to residual -->
          <line x1="235" y1="135" x2="298" y2="120" stroke="#FC642D" stroke-width="1.5" marker-end="url(#ivfpq-arrow-o)"/>

          <!-- RIGHT SIDE: PQ step -->
          <rect x="400" y="35" width="285" height="200" rx="10" fill="#faf5ff" stroke="#7B2FF7" stroke-width="1.5" stroke-dasharray="6,3"/>
          <text x="542" y="52" text-anchor="middle" font-size="11" font-weight="700" fill="#7B2FF7">Step 2: PQ (Compressed Search)</text>

          <!-- Arrow from residual to PQ -->
          <line x1="392" y1="120" x2="415" y2="100" stroke="#7B2FF7" stroke-width="1.5" marker-end="url(#ivfpq-arrow-p)"/>

          <!-- Compressed vectors in cluster (colored blocks) -->
          <text x="420" y="75" font-size="9" fill="#475569" font-weight="600">Vectors as PQ codes:</text>
          <!-- Row 1 (from C1) -->
          <g transform="translate(420,80)">
            <rect x="0" y="0" width="10" height="10" rx="2" fill="#FF5A5F"/><rect x="11" y="0" width="10" height="10" rx="2" fill="#FC642D"/>
            <rect x="22" y="0" width="10" height="10" rx="2" fill="#f59e0b"/><rect x="33" y="0" width="10" height="10" rx="2" fill="#10b981"/>
            <rect x="44" y="0" width="10" height="10" rx="2" fill="#428BF9"/><rect x="55" y="0" width="10" height="10" rx="2" fill="#7B2FF7"/>
            <rect x="66" y="0" width="10" height="10" rx="2" fill="#a855f7"/><rect x="77" y="0" width="10" height="10" rx="2" fill="#00A699"/>
            <text x="95" y="9" font-size="7" fill="#64748b">8 bytes</text>
          </g>
          <g transform="translate(420,94)">
            <rect x="0" y="0" width="10" height="10" rx="2" fill="#FF5A5F"/><rect x="11" y="0" width="10" height="10" rx="2" fill="#FC642D"/>
            <rect x="22" y="0" width="10" height="10" rx="2" fill="#f59e0b"/><rect x="33" y="0" width="10" height="10" rx="2" fill="#10b981"/>
            <rect x="44" y="0" width="10" height="10" rx="2" fill="#428BF9"/><rect x="55" y="0" width="10" height="10" rx="2" fill="#7B2FF7"/>
            <rect x="66" y="0" width="10" height="10" rx="2" fill="#a855f7"/><rect x="77" y="0" width="10" height="10" rx="2" fill="#00A699"/>
            <text x="95" y="9" font-size="7" fill="#64748b">8 bytes</text>
          </g>
          <g transform="translate(420,108)">
            <rect x="0" y="0" width="10" height="10" rx="2" fill="#FF5A5F"/><rect x="11" y="0" width="10" height="10" rx="2" fill="#FC642D"/>
            <rect x="22" y="0" width="10" height="10" rx="2" fill="#f59e0b"/><rect x="33" y="0" width="10" height="10" rx="2" fill="#10b981"/>
            <rect x="44" y="0" width="10" height="10" rx="2" fill="#428BF9"/><rect x="55" y="0" width="10" height="10" rx="2" fill="#7B2FF7"/>
            <rect x="66" y="0" width="10" height="10" rx="2" fill="#a855f7"/><rect x="77" y="0" width="10" height="10" rx="2" fill="#00A699"/>
            <text x="95" y="9" font-size="7" fill="#64748b">8 bytes</text>
          </g>
          <g transform="translate(420,122)">
            <rect x="0" y="0" width="10" height="10" rx="2" fill="#FF5A5F"/><rect x="11" y="0" width="10" height="10" rx="2" fill="#FC642D"/>
            <rect x="22" y="0" width="10" height="10" rx="2" fill="#f59e0b"/><rect x="33" y="0" width="10" height="10" rx="2" fill="#10b981"/>
            <rect x="44" y="0" width="10" height="10" rx="2" fill="#428BF9"/><rect x="55" y="0" width="10" height="10" rx="2" fill="#7B2FF7"/>
            <rect x="66" y="0" width="10" height="10" rx="2" fill="#a855f7"/><rect x="77" y="0" width="10" height="10" rx="2" fill="#00A699"/>
            <text x="95" y="9" font-size="7" fill="#64748b">8 bytes</text>
          </g>
          <text x="420" y="148" font-size="7" fill="#94a3b8" font-style="italic">... (only vectors in probed clusters)</text>

          <!-- PQ lookup table -->
          <rect x="420" y="155" width="250" height="28" rx="6" fill="#fff" stroke="#7B2FF7" stroke-width="1"/>
          <text x="545" y="173" text-anchor="middle" font-size="9" fill="#7B2FF7" font-weight="600">approx_dist = sum of lookup table entries</text>

          <!-- vs comparison with full vector -->
          <g transform="translate(420,190)">
            <text x="0" y="10" font-size="8" fill="#94a3b8">vs full vector:</text>
            <rect x="80" y="0" width="180" height="12" rx="3" fill="#e2e8f0" opacity="0.5"/>
            <text x="170" y="10" text-anchor="middle" font-size="7" fill="#94a3b8">3,072 bytes (not stored in RAM)</text>
          </g>

          <!-- Bottom label -->
          <rect x="110" y="246" width="480" height="26" rx="8" fill="#f0fdf4" stroke="#10b981" stroke-width="1.5"/>
          <text x="350" y="263" text-anchor="middle" font-size="11" font-weight="700" fill="#065f46">IVF narrows search, PQ compresses storage</text>

          <!-- Arrow markers -->
          <defs>
            <marker id="ivfpq-arrow" markerWidth="7" markerHeight="5" refX="7" refY="2.5" orient="auto">
              <path d="M0,0 L7,2.5 L0,5" fill="#FF5A5F"/>
            </marker>
            <marker id="ivfpq-arrow-g" markerWidth="7" markerHeight="5" refX="7" refY="2.5" orient="auto">
              <path d="M0,0 L7,2.5 L0,5" fill="#10b981"/>
            </marker>
            <marker id="ivfpq-arrow-o" markerWidth="7" markerHeight="5" refX="7" refY="2.5" orient="auto">
              <path d="M0,0 L7,2.5 L0,5" fill="#FC642D"/>
            </marker>
            <marker id="ivfpq-arrow-p" markerWidth="7" markerHeight="5" refX="7" refY="2.5" orient="auto">
              <path d="M0,0 L7,2.5 L0,5" fill="#7B2FF7"/>
            </marker>
          </defs>
        </svg>
      </div>

      <pre><code><span class="cm">// BUILD: Train both IVF centroids and PQ codebooks</span>
<span class="var">centroids</span> = <span class="fn">kmeans</span>(sample, nlist=<span class="num">65536</span>)       <span class="cm">// coarse quantizer</span>
<span class="var">residuals</span> = vectors - centroids[assignments]   <span class="cm">// compute residuals</span>
<span class="var">pq_codebook</span> = <span class="fn">train_pq</span>(residuals, m=<span class="num">96</span>)       <span class="cm">// train PQ on residuals</span>

<span class="cm">// QUERY:</span>
<span class="cm">// 1. Find nprobe nearest centroids</span>
<span class="var">clusters</span> = <span class="fn">top_k_centroids</span>(query, nprobe=<span class="num">128</span>)
<span class="cm">// 2. Compute residual: query - centroid</span>
<span class="cm">// 3. Search compressed vectors in those clusters via PQ lookup</span>
<span class="cm">// 4. Return top-K</span></code></pre>

      <h4>Why Residuals Matter</h4>
      <p>PQ works better on <strong>residuals</strong> (vector - cluster_centroid) than on raw vectors. Residuals have smaller variance, making quantization more accurate. This is the key insight that makes IVF-PQ work well.</p>

      <h4>Scale Reference (FAISS benchmarks)</h4>
      <table class="param-table">
        <tr><th>Dataset</th><th>Config</th><th>Memory</th><th>Recall@10</th><th>Latency</th></tr>
        <tr><td>100M (128d)</td><td>IVF4096,PQ32</td><td>~6 GB</td><td>~82%</td><td>~3ms</td></tr>
        <tr><td>1B (128d)</td><td>IVF65536,PQ64</td><td>~120 GB</td><td>~78%</td><td>~8ms</td></tr>
        <tr><td>1B (768d)</td><td>IVF65536,PQ96</td><td>~150 GB</td><td>~75%</td><td>~12ms</td></tr>
      </table>

      <div class="tag-row">
        <span class="tag tag-pro">Scales to 1B+ Vectors</span>
        <span class="tag tag-pro">Very Low Memory</span>
        <span class="tag tag-pro">Battle-Tested (FAISS)</span>
        <span class="tag tag-con">Lower Recall than HNSW</span>
        <span class="tag tag-con">Requires Two-Phase Training</span>
        <span class="tag tag-con">No Online Inserts</span>
      </div>

      <div class="when-use">
        <strong>When to use:</strong> The go-to choice for billion-scale vector search when HNSW's memory footprint is prohibitive. Used by Facebook (FAISS), Spotify, and most large-scale recommendation systems. Accept ~5-10% recall loss for 10-30× memory savings.
      </div>
    </div>
  </details>

  <!-- ALGORITHM 6: HNSW+PQ (bonus) -->
  <details class="algo-detail">
    <summary>
      6. HNSW + PQ (Hybrid) — Best of Both Worlds
      <span class="algo-badge best">Production Pick</span>
    </summary>
    <div class="algo-body">
      <h4>How It Works</h4>
      <p>Use HNSW's graph structure for navigation, but store <strong>PQ-compressed vectors</strong> in the graph nodes instead of full-precision vectors. The graph traversal is the same, but distance calculations use PQ lookup tables instead of full float operations.</p>

      <div class="diagram-box" style="margin:16px 0;">
        <svg viewBox="0 0 700 280" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:auto;font-family:'Inter',system-ui,sans-serif;">
          <rect width="700" height="280" fill="#f8fafc" rx="12"/>
          <!-- Title -->
          <text x="350" y="22" text-anchor="middle" font-size="13" font-weight="700" fill="#1e293b">HNSW + PQ: Graph Navigation with Compressed Nodes</text>

          <!-- Phase 1 Box (left) -->
          <rect x="15" y="35" width="340" height="200" rx="10" fill="#f0f4ff" stroke="#428BF9" stroke-width="1.5"/>
          <text x="185" y="52" text-anchor="middle" font-size="10" font-weight="700" fill="#428BF9">Phase 1: HNSW + PQ in RAM (fast)</text>

          <!-- Mini HNSW graph structure -->
          <!-- Layer labels -->
          <text x="28" y="75" font-size="7" fill="#7B2FF7" font-weight="600">L2</text>
          <text x="28" y="120" font-size="7" fill="#7B2FF7" font-weight="600">L1</text>
          <text x="28" y="175" font-size="7" fill="#7B2FF7" font-weight="600">L0</text>

          <!-- Layer 2 nodes with PQ inside -->
          <g transform="translate(0,0)">
            <circle cx="90" cy="72" r="14" fill="#ede9fe" stroke="#7B2FF7" stroke-width="1.5"/>
            <rect x="82" y="67" width="5" height="5" rx="1" fill="#FF5A5F"/><rect x="88" y="67" width="5" height="5" rx="1" fill="#428BF9"/><rect x="82" y="73" width="5" height="5" rx="1" fill="#10b981"/><rect x="88" y="73" width="5" height="5" rx="1" fill="#f59e0b"/>
            <circle cx="200" cy="72" r="14" fill="#ede9fe" stroke="#7B2FF7" stroke-width="1.5"/>
            <rect x="192" y="67" width="5" height="5" rx="1" fill="#FF5A5F"/><rect x="198" y="67" width="5" height="5" rx="1" fill="#428BF9"/><rect x="192" y="73" width="5" height="5" rx="1" fill="#10b981"/><rect x="198" y="73" width="5" height="5" rx="1" fill="#f59e0b"/>
            <circle cx="310" cy="72" r="14" fill="#ede9fe" stroke="#7B2FF7" stroke-width="1.5"/>
            <rect x="302" y="67" width="5" height="5" rx="1" fill="#FF5A5F"/><rect x="308" y="67" width="5" height="5" rx="1" fill="#428BF9"/><rect x="302" y="73" width="5" height="5" rx="1" fill="#10b981"/><rect x="308" y="73" width="5" height="5" rx="1" fill="#f59e0b"/>
            <!-- L2 edges -->
            <line x1="104" y1="72" x2="186" y2="72" stroke="#c4b5fd" stroke-width="1.2"/>
            <line x1="214" y1="72" x2="296" y2="72" stroke="#c4b5fd" stroke-width="1.2"/>
          </g>

          <!-- Layer 1 nodes with PQ inside -->
          <g transform="translate(0,0)">
            <circle cx="65" cy="117" r="12" fill="#f5f3ff" stroke="#a78bfa" stroke-width="1.2"/>
            <rect x="59" y="113" width="4" height="4" rx="1" fill="#FF5A5F"/><rect x="64" y="113" width="4" height="4" rx="1" fill="#428BF9"/><rect x="59" y="118" width="4" height="4" rx="1" fill="#10b981"/><rect x="64" y="118" width="4" height="4" rx="1" fill="#f59e0b"/>
            <circle cx="135" cy="117" r="12" fill="#f5f3ff" stroke="#a78bfa" stroke-width="1.2"/>
            <rect x="129" y="113" width="4" height="4" rx="1" fill="#FF5A5F"/><rect x="134" y="113" width="4" height="4" rx="1" fill="#428BF9"/><rect x="129" y="118" width="4" height="4" rx="1" fill="#10b981"/><rect x="134" y="118" width="4" height="4" rx="1" fill="#f59e0b"/>
            <circle cx="200" cy="117" r="12" fill="#f5f3ff" stroke="#a78bfa" stroke-width="1.2"/>
            <rect x="194" y="113" width="4" height="4" rx="1" fill="#FF5A5F"/><rect x="199" y="113" width="4" height="4" rx="1" fill="#428BF9"/><rect x="194" y="118" width="4" height="4" rx="1" fill="#10b981"/><rect x="199" y="118" width="4" height="4" rx="1" fill="#f59e0b"/>
            <circle cx="265" cy="117" r="12" fill="#f5f3ff" stroke="#a78bfa" stroke-width="1.2"/>
            <rect x="259" y="113" width="4" height="4" rx="1" fill="#FF5A5F"/><rect x="264" y="113" width="4" height="4" rx="1" fill="#428BF9"/><rect x="259" y="118" width="4" height="4" rx="1" fill="#10b981"/><rect x="264" y="118" width="4" height="4" rx="1" fill="#f59e0b"/>
            <circle cx="335" cy="117" r="12" fill="#f5f3ff" stroke="#a78bfa" stroke-width="1.2"/>
            <rect x="329" y="113" width="4" height="4" rx="1" fill="#FF5A5F"/><rect x="334" y="113" width="4" height="4" rx="1" fill="#428BF9"/><rect x="329" y="118" width="4" height="4" rx="1" fill="#10b981"/><rect x="334" y="118" width="4" height="4" rx="1" fill="#f59e0b"/>
            <!-- L1 edges -->
            <line x1="77" y1="117" x2="123" y2="117" stroke="#ddd6fe" stroke-width="1"/>
            <line x1="147" y1="117" x2="188" y2="117" stroke="#ddd6fe" stroke-width="1"/>
            <line x1="212" y1="117" x2="253" y2="117" stroke="#ddd6fe" stroke-width="1"/>
            <line x1="277" y1="117" x2="323" y2="117" stroke="#ddd6fe" stroke-width="1"/>
          </g>

          <!-- Layer 0 nodes with PQ inside (denser) -->
          <g transform="translate(0,0)">
            <circle cx="42" cy="170" r="10" fill="#faf5ff" stroke="#ddd6fe" stroke-width="1"/>
            <rect x="37" y="166" width="3.5" height="3.5" rx="1" fill="#FF5A5F"/><rect x="41.5" y="166" width="3.5" height="3.5" rx="1" fill="#428BF9"/><rect x="37" y="170.5" width="3.5" height="3.5" rx="1" fill="#10b981"/><rect x="41.5" y="170.5" width="3.5" height="3.5" rx="1" fill="#f59e0b"/>
            <circle cx="80" cy="170" r="10" fill="#faf5ff" stroke="#ddd6fe" stroke-width="1"/>
            <rect x="75" y="166" width="3.5" height="3.5" rx="1" fill="#FF5A5F"/><rect x="79.5" y="166" width="3.5" height="3.5" rx="1" fill="#428BF9"/><rect x="75" y="170.5" width="3.5" height="3.5" rx="1" fill="#10b981"/><rect x="79.5" y="170.5" width="3.5" height="3.5" rx="1" fill="#f59e0b"/>
            <circle cx="118" cy="170" r="10" fill="#faf5ff" stroke="#ddd6fe" stroke-width="1"/>
            <rect x="113" y="166" width="3.5" height="3.5" rx="1" fill="#FF5A5F"/><rect x="117.5" y="166" width="3.5" height="3.5" rx="1" fill="#428BF9"/><rect x="113" y="170.5" width="3.5" height="3.5" rx="1" fill="#10b981"/><rect x="117.5" y="170.5" width="3.5" height="3.5" rx="1" fill="#f59e0b"/>
            <circle cx="156" cy="170" r="10" fill="#faf5ff" stroke="#ddd6fe" stroke-width="1"/>
            <rect x="151" y="166" width="3.5" height="3.5" rx="1" fill="#FF5A5F"/><rect x="155.5" y="166" width="3.5" height="3.5" rx="1" fill="#428BF9"/><rect x="151" y="170.5" width="3.5" height="3.5" rx="1" fill="#10b981"/><rect x="155.5" y="170.5" width="3.5" height="3.5" rx="1" fill="#f59e0b"/>
            <circle cx="194" cy="170" r="10" fill="#faf5ff" stroke="#ddd6fe" stroke-width="1"/>
            <rect x="189" y="166" width="3.5" height="3.5" rx="1" fill="#FF5A5F"/><rect x="193.5" y="166" width="3.5" height="3.5" rx="1" fill="#428BF9"/><rect x="189" y="170.5" width="3.5" height="3.5" rx="1" fill="#10b981"/><rect x="193.5" y="170.5" width="3.5" height="3.5" rx="1" fill="#f59e0b"/>
            <circle cx="232" cy="170" r="10" fill="#faf5ff" stroke="#ddd6fe" stroke-width="1"/>
            <rect x="227" y="166" width="3.5" height="3.5" rx="1" fill="#FF5A5F"/><rect x="231.5" y="166" width="3.5" height="3.5" rx="1" fill="#428BF9"/><rect x="227" y="170.5" width="3.5" height="3.5" rx="1" fill="#10b981"/><rect x="231.5" y="170.5" width="3.5" height="3.5" rx="1" fill="#f59e0b"/>
            <circle cx="270" cy="170" r="10" fill="#faf5ff" stroke="#ddd6fe" stroke-width="1"/>
            <rect x="265" y="166" width="3.5" height="3.5" rx="1" fill="#FF5A5F"/><rect x="269.5" y="166" width="3.5" height="3.5" rx="1" fill="#428BF9"/><rect x="265" y="170.5" width="3.5" height="3.5" rx="1" fill="#10b981"/><rect x="269.5" y="170.5" width="3.5" height="3.5" rx="1" fill="#f59e0b"/>
            <circle cx="308" cy="170" r="10" fill="#faf5ff" stroke="#ddd6fe" stroke-width="1"/>
            <rect x="303" y="166" width="3.5" height="3.5" rx="1" fill="#FF5A5F"/><rect x="307.5" y="166" width="3.5" height="3.5" rx="1" fill="#428BF9"/><rect x="303" y="170.5" width="3.5" height="3.5" rx="1" fill="#10b981"/><rect x="307.5" y="170.5" width="3.5" height="3.5" rx="1" fill="#f59e0b"/>
            <circle cx="343" cy="170" r="10" fill="#faf5ff" stroke="#ddd6fe" stroke-width="1"/>
            <rect x="338" y="166" width="3.5" height="3.5" rx="1" fill="#FF5A5F"/><rect x="342.5" y="166" width="3.5" height="3.5" rx="1" fill="#428BF9"/><rect x="338" y="170.5" width="3.5" height="3.5" rx="1" fill="#10b981"/><rect x="342.5" y="170.5" width="3.5" height="3.5" rx="1" fill="#f59e0b"/>
            <!-- L0 edges -->
            <g stroke="#e2e8f0" stroke-width="0.8">
              <line x1="52" y1="170" x2="70" y2="170"/><line x1="90" y1="170" x2="108" y2="170"/>
              <line x1="128" y1="170" x2="146" y2="170"/><line x1="166" y1="170" x2="184" y2="170"/>
              <line x1="204" y1="170" x2="222" y2="170"/><line x1="242" y1="170" x2="260" y2="170"/>
              <line x1="280" y1="170" x2="298" y2="170"/><line x1="318" y1="170" x2="333" y2="170"/>
              <!-- cross links -->
              <line x1="42" y1="162" x2="118" y2="162" opacity="0.4"/>
              <line x1="156" y1="178" x2="270" y2="178" opacity="0.4"/>
              <line x1="232" y1="162" x2="343" y2="162" opacity="0.4"/>
            </g>
          </g>

          <!-- Vertical connections between layers -->
          <g stroke="#ddd6fe" stroke-width="0.7" stroke-dasharray="2,2" opacity="0.4">
            <line x1="90" y1="86" x2="65" y2="105"/><line x1="90" y1="86" x2="135" y2="105"/>
            <line x1="200" y1="86" x2="200" y2="105"/><line x1="310" y1="86" x2="265" y2="105"/><line x1="310" y1="86" x2="335" y2="105"/>
            <line x1="65" y1="129" x2="42" y2="160"/><line x1="65" y1="129" x2="80" y2="160"/>
            <line x1="135" y1="129" x2="118" y2="160"/><line x1="135" y1="129" x2="156" y2="160"/>
            <line x1="200" y1="129" x2="194" y2="160"/><line x1="265" y1="129" x2="232" y2="160"/><line x1="265" y1="129" x2="270" y2="160"/>
            <line x1="335" y1="129" x2="308" y2="160"/><line x1="335" y1="129" x2="343" y2="160"/>
          </g>

          <!-- Traversal path on HNSW -->
          <defs>
            <marker id="hnswpq-arrow" markerWidth="7" markerHeight="5" refX="7" refY="2.5" orient="auto">
              <path d="M0,0 L7,2.5 L0,5" fill="#FC642D"/>
            </marker>
            <marker id="hnswpq-arrow-b" markerWidth="7" markerHeight="5" refX="7" refY="2.5" orient="auto">
              <path d="M0,0 L7,2.5 L0,5" fill="#428BF9"/>
            </marker>
          </defs>
          <!-- Query enters -->
          <text x="45" y="55" font-size="9" font-weight="700" fill="#FC642D">query</text>
          <line x1="68" y1="58" x2="78" y2="66" stroke="#FC642D" stroke-width="2.5" marker-end="url(#hnswpq-arrow)"/>
          <!-- L2: first -> second -->
          <path d="M104,72 L186,72" stroke="#FC642D" stroke-width="2.5" fill="none" marker-end="url(#hnswpq-arrow)"/>
          <!-- L2 -> L1: drop down -->
          <line x1="200" y1="86" x2="200" y2="105" stroke="#FC642D" stroke-width="2.5" stroke-dasharray="3,2" marker-end="url(#hnswpq-arrow)"/>
          <!-- L1: navigate -->
          <path d="M212,117 L253,117" stroke="#FC642D" stroke-width="2.5" fill="none" marker-end="url(#hnswpq-arrow)"/>
          <!-- L1 -> L0 -->
          <line x1="265" y1="129" x2="270" y2="160" stroke="#FC642D" stroke-width="2.5" stroke-dasharray="3,2" marker-end="url(#hnswpq-arrow)"/>

          <!-- PQ code label -->
          <text x="185" y="200" text-anchor="middle" font-size="8" fill="#475569">Each node stores PQ codes (not full vectors)</text>
          <text x="185" y="212" text-anchor="middle" font-size="8" fill="#7B2FF7" font-weight="600">~8-96 bytes per node instead of 3,072</text>

          <!-- Phase arrow -->
          <line x1="355" y1="135" x2="370" y2="135" stroke="#1e293b" stroke-width="2.5" marker-end="url(#hnswpq-arrow-b)"/>

          <!-- Phase 2 Box (right) -->
          <rect x="375" y="35" width="310" height="200" rx="10" fill="#fef2f2" stroke="#FF5A5F" stroke-width="1.5"/>
          <text x="530" y="52" text-anchor="middle" font-size="10" font-weight="700" fill="#FF5A5F">Phase 2: Re-Rank from SSD (precise)</text>

          <!-- SSD icon -->
          <rect x="405" y="65" width="60" height="40" rx="6" fill="#fff" stroke="#94a3b8" stroke-width="1.5"/>
          <rect x="415" y="75" width="40" height="6" rx="2" fill="#e2e8f0"/>
          <rect x="415" y="85" width="25" height="6" rx="2" fill="#e2e8f0"/>
          <text x="435" y="118" text-anchor="middle" font-size="8" font-weight="600" fill="#475569">SSD Storage</text>
          <text x="435" y="128" text-anchor="middle" font-size="7" fill="#94a3b8">full vectors</text>

          <!-- Arrow from SSD to candidates -->
          <line x1="465" y1="85" x2="495" y2="85" stroke="#94a3b8" stroke-width="1.2" marker-end="url(#hnswpq-arrow-b)"/>

          <!-- Top-100 candidates box -->
          <rect x="500" y="65" width="80" height="35" rx="6" fill="#dbeafe" stroke="#428BF9" stroke-width="1.2"/>
          <text x="540" y="80" text-anchor="middle" font-size="8" font-weight="600" fill="#1e293b">Top-100</text>
          <text x="540" y="91" text-anchor="middle" font-size="7" fill="#64748b">candidates</text>

          <!-- Arrow to re-rank -->
          <line x1="540" y1="100" x2="540" y2="118" stroke="#FF5A5F" stroke-width="1.5" marker-end="url(#hnswpq-re-arrow)"/>

          <!-- Re-rank process -->
          <rect x="490" y="120" width="100" height="28" rx="6" fill="#fff" stroke="#FF5A5F" stroke-width="1.5"/>
          <text x="540" y="138" text-anchor="middle" font-size="9" font-weight="700" fill="#FF5A5F">Exact re-rank</text>

          <!-- Arrow to final result -->
          <line x1="540" y1="148" x2="540" y2="166" stroke="#10b981" stroke-width="1.5" marker-end="url(#hnswpq-g-arrow)"/>

          <!-- Final top-10 result -->
          <rect x="495" y="168" width="90" height="28" rx="8" fill="#d1fae5" stroke="#10b981" stroke-width="2"/>
          <text x="540" y="186" text-anchor="middle" font-size="10" font-weight="700" fill="#065f46">Top-10</text>

          <!-- Latency labels -->
          <text x="435" y="150" font-size="7" fill="#64748b">load 100 vectors</text>
          <text x="435" y="160" font-size="7" fill="#64748b">~0.5-2ms extra</text>

          <!-- Recall recovery note -->
          <rect x="395" y="200" width="270" height="24" rx="6" fill="#f0fdf4" stroke="#10b981" stroke-width="1"/>
          <text x="530" y="216" text-anchor="middle" font-size="9" font-weight="600" fill="#065f46">PQ ~92% recall + re-rank = ~97% recall</text>

          <!-- Bottom two-phase label -->
          <rect x="60" y="246" width="580" height="26" rx="8" fill="#f0f4ff" stroke="#428BF9" stroke-width="1.5"/>
          <text x="185" y="263" text-anchor="middle" font-size="10" font-weight="700" fill="#428BF9">Phase 1: HNSW+PQ in RAM (fast)</text>
          <text x="350" y="263" text-anchor="middle" font-size="12" fill="#1e293b" font-weight="700">&rarr;</text>
          <text x="500" y="263" text-anchor="middle" font-size="10" font-weight="700" fill="#FF5A5F">Phase 2: Full vectors from SSD (precise)</text>

          <!-- More arrow defs -->
          <defs>
            <marker id="hnswpq-re-arrow" markerWidth="6" markerHeight="5" refX="3" refY="5" orient="auto">
              <path d="M0,0 L3,5 L6,0" fill="#FF5A5F"/>
            </marker>
            <marker id="hnswpq-g-arrow" markerWidth="6" markerHeight="5" refX="3" refY="5" orient="auto">
              <path d="M0,0 L3,5 L6,0" fill="#10b981"/>
            </marker>
          </defs>
        </svg>
      </div>

      <h4>Two-Phase Approach (used by Qdrant, Milvus)</h4>
      <pre><code><span class="cm">// Phase 1: Coarse search using HNSW + PQ (in RAM)</span>
<span class="var">candidates_100</span> = <span class="fn">hnsw_search</span>(query, ef=<span class="num">256</span>, using=PQ_vectors)

<span class="cm">// Phase 2: Re-rank using full-precision vectors (from SSD)</span>
<span class="var">full_vectors</span> = <span class="fn">load_from_ssd</span>(candidates_100.ids)
<span class="var">exact_scores</span> = [<span class="fn">exact_distance</span>(query, fv) <span class="kw">for</span> fv <span class="kw">in</span> full_vectors]
<span class="kw">return</span> <span class="fn">top_k</span>(exact_scores, k=<span class="num">10</span>)

<span class="cm">// Result: HNSW-level recall, PQ-level memory</span>
<span class="cm">// Extra latency from SSD reads: ~0.5-2ms (100 random reads)</span></code></pre>

      <h4>Memory Comparison (10M vectors, 768d)</h4>
      <table class="param-table">
        <tr><th>Approach</th><th>RAM Required</th><th>Recall@10</th><th>Latency</th></tr>
        <tr><td>HNSW (full precision)</td><td style="color:var(--danger)">~33.5 GB</td><td style="color:var(--success)">>98%</td><td style="color:var(--success)">~0.9ms</td></tr>
        <tr><td>HNSW + PQ (m=96)</td><td style="color:var(--success)">~2.6 GB</td><td style="color:var(--warning)">~92%</td><td>~1.2ms</td></tr>
        <tr><td>HNSW + PQ + re-rank</td><td style="color:var(--success)">~2.6 GB + SSD</td><td style="color:var(--success)">~97%</td><td>~2.5ms</td></tr>
      </table>

      <div class="tag-row">
        <span class="tag tag-pro">HNSW Recall + PQ Memory</span>
        <span class="tag tag-pro">Online Inserts</span>
        <span class="tag tag-pro">SSD Re-rank Recovers Recall</span>
        <span class="tag tag-con">More Complex Implementation</span>
        <span class="tag tag-con">SSD Re-rank Adds ~1-2ms</span>
      </div>

      <div class="when-use">
        <strong>When to use:</strong> The production pick for most vector databases. Gives you HNSW's navigation speed and recall with PQ's memory efficiency. This is what Qdrant and Milvus use internally. For our multi-tenant vector DB, this is the <strong>recommended default</strong>.
      </div>
    </div>
  </details>

  <h3>Algorithm Comparison</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Algorithm</th>
          <th>Recall@10</th>
          <th>Latency (10M)</th>
          <th>Memory</th>
          <th>Insert Speed</th>
          <th>Best For</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong style="color: var(--text);">Flat</strong></td>
          <td style="color: var(--success);">100%</td>
          <td style="color: var(--danger);">~500ms</td>
          <td>1x (raw)</td>
          <td style="color: var(--success);">Instant</td>
          <td>&lt;10K vectors</td>
        </tr>
        <tr>
          <td><strong style="color: var(--text);">IVF</strong></td>
          <td style="color: var(--warning);">90-97%</td>
          <td style="color: var(--warning);">5-20ms</td>
          <td>~1.1x</td>
          <td style="color: var(--warning);">Requires retrain</td>
          <td>Medium datasets</td>
        </tr>
        <tr>
          <td><strong style="color: var(--text);">HNSW</strong></td>
          <td style="color: var(--success);">>95%</td>
          <td style="color: var(--success);">&lt;1ms</td>
          <td style="color: var(--danger);">~1.5x</td>
          <td style="color: var(--success);">Online</td>
          <td>Low-latency, high recall</td>
        </tr>
        <tr>
          <td><strong style="color: var(--text);">PQ</strong></td>
          <td style="color: var(--warning);">85-93%</td>
          <td style="color: var(--warning);">10-50ms</td>
          <td style="color: var(--success);">0.03-0.1x</td>
          <td style="color: var(--warning);">Requires retrain</td>
          <td>Memory-constrained</td>
        </tr>
        <tr>
          <td><strong style="color: var(--text);">IVF-PQ</strong></td>
          <td style="color: var(--warning);">88-95%</td>
          <td style="color: var(--success);">1-10ms</td>
          <td style="color: var(--success);">0.05-0.15x</td>
          <td style="color: var(--warning);">Requires retrain</td>
          <td>Billion-scale</td>
        </tr>
        <tr>
          <td><strong style="color: var(--text);">HNSW+PQ</strong></td>
          <td style="color: var(--success);">92-97%</td>
          <td style="color: var(--success);">1-5ms</td>
          <td style="color: var(--warning);">0.1-0.3x</td>
          <td style="color: var(--success);">Online</td>
          <td>Balance of all factors</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="callout callout-insight">
    <div class="callout-title">Our Recommendation: HNSW with Optional PQ</div>
    <p>For the primary index, use <strong>HNSW</strong> for its excellent recall and sub-millisecond latency. For large tenants (>50M vectors) or when memory is tight, layer <strong>Product Quantization</strong> on top to compress vectors while keeping the HNSW graph structure. This gives the best balance of speed, recall, and memory efficiency.</p>
  </div>
</div>

<!-- ============================================================ -->
<!--  SECTION 5: ARCHITECTURE                                      -->
<!-- ============================================================ -->
<div class="section" id="architecture">
  <div class="section-label">Section 5</div>
  <h2>System Architecture</h2>

  <div class="diagram-box">
  <svg viewBox="0 0 1100 620" xmlns="http://www.w3.org/2000/svg" font-family="Segoe UI, system-ui, sans-serif">
    <defs>
      <filter id="sh2" x="-4%" y="-4%" width="108%" height="112%">
        <feDropShadow dx="1" dy="2" stdDeviation="3" flood-color="#000" flood-opacity="0.1"/>
      </filter>
      <linearGradient id="v1" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#FF5A5F"/><stop offset="100%" stop-color="#E04850"/></linearGradient>
      <linearGradient id="v2" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#00A699"/><stop offset="100%" stop-color="#008F84"/></linearGradient>
      <linearGradient id="v3" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#428BF9"/><stop offset="100%" stop-color="#3070D4"/></linearGradient>
      <linearGradient id="v4" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#7B2FF7"/><stop offset="100%" stop-color="#6320CC"/></linearGradient>
      <linearGradient id="v5" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#FC642D"/><stop offset="100%" stop-color="#E04F1C"/></linearGradient>
      <marker id="arrS2" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6 Z" fill="#94a3b8"/></marker>
      <marker id="arrA2" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6 Z" fill="#c2410c"/></marker>
      <marker id="arrRaft" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6 Z" fill="#7B2FF7"/></marker>
    </defs>

    <!-- Background -->
    <rect width="1100" height="620" rx="12" fill="#f1f5f9"/>

    <!-- Title -->
    <text x="550" y="28" fill="#7B2FF7" font-size="13" font-weight="800" text-anchor="middle" letter-spacing="2">MULTI-TENANT VECTOR DATABASE ARCHITECTURE</text>

    <!-- ===== CLIENT BOXES ===== -->
    <g filter="url(#sh2)">
      <rect x="140" y="45" width="140" height="42" rx="10" fill="url(#v3)" opacity="0.85"/>
      <text x="210" y="70" fill="#fff" font-size="10" font-weight="700" text-anchor="middle">ML Applications</text>
    </g>
    <g filter="url(#sh2)">
      <rect x="320" y="45" width="140" height="42" rx="10" fill="url(#v3)" opacity="0.85"/>
      <text x="390" y="70" fill="#fff" font-size="10" font-weight="700" text-anchor="middle">Search Service</text>
    </g>
    <g filter="url(#sh2)">
      <rect x="500" y="45" width="180" height="42" rx="10" fill="url(#v3)" opacity="0.85"/>
      <text x="590" y="70" fill="#fff" font-size="10" font-weight="700" text-anchor="middle">Recommendation Engine</text>
    </g>

    <!-- Arrows: Clients to API Gateway -->
    <line x1="210" y1="87" x2="420" y2="110" stroke="#94a3b8" stroke-width="1.3" marker-end="url(#arrS2)"/>
    <line x1="390" y1="87" x2="420" y2="110" stroke="#94a3b8" stroke-width="1.3" marker-end="url(#arrS2)"/>
    <line x1="590" y1="87" x2="500" y2="110" stroke="#94a3b8" stroke-width="1.3" marker-end="url(#arrS2)"/>

    <!-- ===== API GATEWAY ===== -->
    <g filter="url(#sh2)">
      <rect x="210" y="110" width="580" height="55" rx="10" fill="#fafbfc" stroke="#FF5A5F" stroke-width="1.8"/>
      <!-- Shield icon -->
      <path d="M234,124 L234,147 Q234,155 244,158 Q254,155 254,147 L254,124 Q244,120 234,124Z" fill="none" stroke="#FF5A5F" stroke-width="1.5"/>
      <polyline points="240,138 244,143 252,132" fill="none" stroke="#FF5A5F" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
      <text x="264" y="135" fill="#FF5A5F" font-size="13" font-weight="800">API GATEWAY</text>
      <text x="395" y="135" fill="#94a3b8" font-size="9">Auth</text>
      <line x1="415" y1="127" x2="415" y2="145" stroke="#cbd5e1" stroke-width="1"/>
      <text x="425" y="135" fill="#94a3b8" font-size="9">Rate Limit (per-tenant)</text>
      <line x1="545" y1="127" x2="545" y2="145" stroke="#cbd5e1" stroke-width="1"/>
      <text x="555" y="135" fill="#94a3b8" font-size="9">Tenant Isolation</text>
      <line x1="650" y1="127" x2="650" y2="145" stroke="#cbd5e1" stroke-width="1"/>
      <text x="660" y="135" fill="#94a3b8" font-size="9">Request Validation</text>
    </g>

    <!-- Arrow: API GW to Router -->
    <line x1="500" y1="165" x2="500" y2="185" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arrS2)"/>

    <!-- ===== ROUTER SERVICE ===== -->
    <g filter="url(#sh2)">
      <rect x="250" y="190" width="500" height="50" rx="10" fill="url(#v2)" opacity="0.92"/>
      <!-- Split arrows icon -->
      <line x1="272" y1="215" x2="282" y2="205" stroke="#fff" stroke-width="1.5" stroke-linecap="round"/>
      <line x1="272" y1="215" x2="282" y2="225" stroke="#fff" stroke-width="1.5" stroke-linecap="round"/>
      <line x1="264" y1="215" x2="282" y2="215" stroke="#fff" stroke-width="1.5" stroke-linecap="round"/>
      <text x="292" y="212" fill="#fff" font-size="12" font-weight="800">ROUTER SERVICE</text>
      <text x="420" y="212" fill="rgba(255,255,255,0.8)" font-size="9">tenant_id --> collection --> shard mapping</text>
      <text x="420" y="228" fill="rgba(255,255,255,0.7)" font-size="8">Query planning &amp; fan-out</text>
    </g>

    <!-- Arrows: Router to Query Nodes (fan-out) -->
    <line x1="370" y1="240" x2="200" y2="290" stroke="#94a3b8" stroke-width="1.3" marker-end="url(#arrS2)"/>
    <line x1="460" y1="240" x2="420" y2="290" stroke="#94a3b8" stroke-width="1.3" marker-end="url(#arrS2)"/>
    <line x1="540" y1="240" x2="620" y2="290" stroke="#94a3b8" stroke-width="1.3" marker-end="url(#arrS2)"/>

    <!-- ===== QUERY NODE 1 (Leader) ===== -->
    <g filter="url(#sh2)">
      <rect x="110" y="290" width="175" height="90" rx="10" fill="#f0f4ff" stroke="#428BF9" stroke-width="2"/>
      <text x="120" y="310" fill="#428BF9" font-size="11" font-weight="800">Query Node 1 (Leader)</text>
      <!-- HNSW graph icon -->
      <circle cx="140" cy="340" r="3" fill="#7B2FF7"/>
      <circle cx="160" cy="330" r="3" fill="#7B2FF7"/>
      <circle cx="155" cy="350" r="3" fill="#7B2FF7"/>
      <circle cx="175" cy="345" r="3" fill="#7B2FF7"/>
      <circle cx="170" cy="325" r="3" fill="#7B2FF7"/>
      <line x1="140" y1="340" x2="160" y2="330" stroke="#7B2FF7" stroke-width="0.8" opacity="0.7"/>
      <line x1="140" y1="340" x2="155" y2="350" stroke="#7B2FF7" stroke-width="0.8" opacity="0.7"/>
      <line x1="160" y1="330" x2="175" y2="345" stroke="#7B2FF7" stroke-width="0.8" opacity="0.7"/>
      <line x1="160" y1="330" x2="170" y2="325" stroke="#7B2FF7" stroke-width="0.8" opacity="0.7"/>
      <line x1="155" y1="350" x2="175" y2="345" stroke="#7B2FF7" stroke-width="0.8" opacity="0.7"/>
      <text x="192" y="338" fill="#7c3aed" font-size="9" font-weight="600">HNSW Index</text>
      <text x="192" y="352" fill="#6b7280" font-size="8">in-memory</text>
      <text x="192" y="366" fill="#c2410c" font-size="8">+ WAL</text>
    </g>

    <!-- ===== QUERY NODE 2 (Follower) ===== -->
    <g filter="url(#sh2)">
      <rect x="330" y="290" width="175" height="90" rx="10" fill="#f0f4ff" stroke="#428BF9" stroke-width="1.5"/>
      <text x="340" y="310" fill="#428BF9" font-size="11" font-weight="700">Query Node 2 (Follower)</text>
      <circle cx="360" cy="340" r="3" fill="#7B2FF7"/>
      <circle cx="380" cy="330" r="3" fill="#7B2FF7"/>
      <circle cx="375" cy="350" r="3" fill="#7B2FF7"/>
      <circle cx="395" cy="345" r="3" fill="#7B2FF7"/>
      <line x1="360" y1="340" x2="380" y2="330" stroke="#7B2FF7" stroke-width="0.8" opacity="0.7"/>
      <line x1="360" y1="340" x2="375" y2="350" stroke="#7B2FF7" stroke-width="0.8" opacity="0.7"/>
      <line x1="380" y1="330" x2="395" y2="345" stroke="#7B2FF7" stroke-width="0.8" opacity="0.7"/>
      <text x="405" y="338" fill="#7c3aed" font-size="9" font-weight="600">HNSW Index</text>
      <text x="405" y="352" fill="#6b7280" font-size="8">in-memory + WAL</text>
    </g>

    <!-- ===== QUERY NODE 3 (Follower) ===== -->
    <g filter="url(#sh2)">
      <rect x="550" y="290" width="175" height="90" rx="10" fill="#f0f4ff" stroke="#428BF9" stroke-width="1.5"/>
      <text x="560" y="310" fill="#428BF9" font-size="11" font-weight="700">Query Node 3 (Follower)</text>
      <circle cx="580" cy="340" r="3" fill="#7B2FF7"/>
      <circle cx="600" cy="330" r="3" fill="#7B2FF7"/>
      <circle cx="595" cy="350" r="3" fill="#7B2FF7"/>
      <circle cx="615" cy="345" r="3" fill="#7B2FF7"/>
      <line x1="580" y1="340" x2="600" y2="330" stroke="#7B2FF7" stroke-width="0.8" opacity="0.7"/>
      <line x1="580" y1="340" x2="595" y2="350" stroke="#7B2FF7" stroke-width="0.8" opacity="0.7"/>
      <line x1="600" y1="330" x2="615" y2="345" stroke="#7B2FF7" stroke-width="0.8" opacity="0.7"/>
      <text x="625" y="338" fill="#7c3aed" font-size="9" font-weight="600">HNSW Index</text>
      <text x="625" y="352" fill="#6b7280" font-size="8">in-memory + WAL</text>
    </g>

    <!-- ===== RAFT REPLICATION ARROWS ===== -->
    <line x1="285" y1="335" x2="328" y2="335" stroke="#7B2FF7" stroke-width="1.5" marker-end="url(#arrRaft)"/>
    <line x1="285" y1="345" x2="548" y2="345" stroke="#7B2FF7" stroke-width="1.5" marker-end="url(#arrRaft)"/>
    <text x="295" y="328" fill="#7B2FF7" font-size="7" font-weight="600">Raft</text>
    <text x="400" y="395" fill="#7B2FF7" font-size="8" font-style="italic">Leader replicates to followers</text>

    <!-- ===== CONTROL PLANE (PostgreSQL) ===== -->
    <g filter="url(#sh2)" transform="translate(830,190)">
      <!-- DB Cylinder -->
      <ellipse cx="50" cy="10" rx="38" ry="10" fill="#dbeafe" stroke="#428BF9" stroke-width="1.5"/>
      <rect x="12" y="10" width="76" height="45" fill="#dbeafe" stroke="none"/>
      <line x1="12" y1="10" x2="12" y2="55" stroke="#428BF9" stroke-width="1.5"/>
      <line x1="88" y1="10" x2="88" y2="55" stroke="#428BF9" stroke-width="1.5"/>
      <ellipse cx="50" cy="55" rx="38" ry="10" fill="#dbeafe" stroke="#428BF9" stroke-width="1.5"/>
      <ellipse cx="50" cy="10" rx="38" ry="10" fill="#bfdbfe" stroke="#428BF9" stroke-width="1.5"/>
      <text x="50" y="32" fill="#1e40af" font-size="10" font-weight="700" text-anchor="middle">PostgreSQL</text>
      <text x="50" y="46" fill="#6b7280" font-size="8" text-anchor="middle">Control Plane</text>
    </g>
    <!-- Labels beside control plane -->
    <g transform="translate(940,210)">
      <text x="0" y="0" fill="#f59e0b" font-size="8">Tenant mgmt</text>
      <text x="0" y="14" fill="#f59e0b" font-size="8">Shard assignments</text>
      <text x="0" y="28" fill="#f59e0b" font-size="8">Collection schemas</text>
      <text x="0" y="42" fill="#f59e0b" font-size="8">Monitoring</text>
    </g>

    <!-- Arrow: Router reads Control Plane -->
    <line x1="750" y1="215" x2="828" y2="220" stroke="#94a3b8" stroke-width="1.2" stroke-dasharray="4,3" marker-end="url(#arrS2)"/>
    <text x="760" y="208" fill="#6b7280" font-size="7" font-style="italic">metadata reads</text>

    <!-- ===== STORAGE LAYER ===== -->
    <g filter="url(#sh2)">
      <rect x="50" y="415" width="750" height="100" rx="12" fill="#faf5f0" stroke="#FC642D" stroke-width="1.5"/>
      <text x="340" y="438" fill="#FC642D" font-size="12" font-weight="800" text-anchor="middle">STORAGE LAYER</text>
    </g>

    <!-- WAL -->
    <g transform="translate(80,455)">
      <rect x="0" y="0" width="80" height="40" rx="6" fill="#fef2f2" stroke="#FF5A5F" stroke-width="1.2"/>
      <text x="40" y="17" fill="#FF5A5F" font-size="10" font-weight="700" text-anchor="middle">WAL</text>
      <text x="40" y="32" fill="#6b7280" font-size="7" text-anchor="middle">Write-ahead log</text>
    </g>

    <!-- Arrow WAL to SSD -->
    <line x1="162" y1="475" x2="200" y2="475" stroke="#94a3b8" stroke-width="1.2" marker-end="url(#arrS2)"/>

    <!-- SSD Segments -->
    <g transform="translate(210,455)">
      <rect x="0" y="0" width="140" height="40" rx="6" fill="#f0f4ff" stroke="#428BF9" stroke-width="1.2"/>
      <!-- Disk icon -->
      <rect x="10" y="8" width="16" height="12" rx="2" fill="none" stroke="#428BF9" stroke-width="1"/>
      <line x1="10" y1="16" x2="26" y2="16" stroke="#428BF9" stroke-width="0.8"/>
      <circle cx="22" cy="12" r="1.5" fill="#428BF9"/>
      <text x="34" y="17" fill="#428BF9" font-size="9" font-weight="600">SSD Segments</text>
      <text x="34" y="32" fill="#6b7280" font-size="7">Memory-mapped files</text>
    </g>

    <!-- Arrow SSD to S3 -->
    <line x1="352" y1="475" x2="400" y2="475" stroke="#ffa657" stroke-width="1.2" stroke-dasharray="5,3" marker-end="url(#arrA2)"/>

    <!-- S3 Snapshots -->
    <g transform="translate(410,455)">
      <rect x="0" y="0" width="140" height="40" rx="6" fill="#f0fdf4" stroke="#4caf50" stroke-width="1.2"/>
      <!-- S3 bucket icon -->
      <ellipse cx="20" cy="10" rx="8" ry="3" fill="none" stroke="#4caf50" stroke-width="1"/>
      <line x1="12" y1="10" x2="12" y2="28" stroke="#4caf50" stroke-width="1"/>
      <line x1="28" y1="10" x2="28" y2="28" stroke="#4caf50" stroke-width="1"/>
      <ellipse cx="20" cy="28" rx="8" ry="3" fill="none" stroke="#4caf50" stroke-width="1"/>
      <text x="38" y="17" fill="#4caf50" font-size="9" font-weight="600">S3 Snapshots</text>
      <text x="38" y="32" fill="#6b7280" font-size="7">Disaster recovery</text>
    </g>

    <!-- PostgreSQL in storage layer -->
    <g transform="translate(610,450)">
      <ellipse cx="40" cy="8" rx="32" ry="8" fill="#dbeafe" stroke="#428BF9" stroke-width="1"/>
      <rect x="8" y="8" width="64" height="30" fill="#dbeafe" stroke="none"/>
      <line x1="8" y1="8" x2="8" y2="38" stroke="#428BF9" stroke-width="1"/>
      <line x1="72" y1="8" x2="72" y2="38" stroke="#428BF9" stroke-width="1"/>
      <ellipse cx="40" cy="38" rx="32" ry="8" fill="#dbeafe" stroke="#428BF9" stroke-width="1"/>
      <ellipse cx="40" cy="8" rx="32" ry="8" fill="#bfdbfe" stroke="#428BF9" stroke-width="1"/>
      <text x="40" y="24" fill="#1e40af" font-size="8" font-weight="600" text-anchor="middle">PostgreSQL</text>
      <text x="40" y="35" fill="#64748b" font-size="7" text-anchor="middle">Metadata</text>
    </g>

    <!-- Arrows: Query Nodes down to Storage -->
    <line x1="198" y1="380" x2="198" y2="413" stroke="#94a3b8" stroke-width="1.2" marker-end="url(#arrS2)"/>
    <line x1="418" y1="380" x2="418" y2="413" stroke="#94a3b8" stroke-width="1.2" marker-end="url(#arrS2)"/>
    <line x1="638" y1="380" x2="638" y2="413" stroke="#94a3b8" stroke-width="1.2" marker-end="url(#arrS2)"/>

    <!-- ===== TENANT TIERS ===== -->
    <text x="880" y="310" fill="#7B2FF7" font-size="10" font-weight="700">TENANT TIERS</text>

    <!-- Platinum -->
    <g filter="url(#sh2)" transform="translate(830,320)">
      <rect x="0" y="0" width="200" height="38" rx="8" fill="#2a1a4a" stroke="#7B2FF7" stroke-width="1.8"/>
      <circle cx="16" cy="19" r="6" fill="#7B2FF7" opacity="0.3"/>
      <text x="14" y="22" fill="#fff" font-size="8" font-weight="700" text-anchor="middle">P</text>
      <text x="30" y="16" fill="#7c3aed" font-size="9" font-weight="700">Platinum</text>
      <text x="30" y="30" fill="#6b7280" font-size="7">Dedicated nodes</text>
    </g>

    <!-- Gold -->
    <g filter="url(#sh2)" transform="translate(830,368)">
      <rect x="0" y="0" width="200" height="38" rx="8" fill="#2a2a1a" stroke="#f59e0b" stroke-width="1.5"/>
      <circle cx="16" cy="19" r="6" fill="#f59e0b" opacity="0.3"/>
      <text x="14" y="22" fill="#fff" font-size="8" font-weight="700" text-anchor="middle">G</text>
      <text x="30" y="16" fill="#fbbf24" font-size="9" font-weight="700">Gold</text>
      <text x="30" y="30" fill="#6b7280" font-size="7">Namespace isolation</text>
    </g>

    <!-- Silver -->
    <g filter="url(#sh2)" transform="translate(830,416)">
      <rect x="0" y="0" width="200" height="38" rx="8" fill="#1a2a2a" stroke="#94a3b8" stroke-width="1.2"/>
      <circle cx="16" cy="19" r="6" fill="#94a3b8" opacity="0.3"/>
      <text x="14" y="22" fill="#fff" font-size="8" font-weight="700" text-anchor="middle">S</text>
      <text x="30" y="16" fill="#cbd5e1" font-size="9" font-weight="700">Silver</text>
      <text x="30" y="30" fill="#6b7280" font-size="7">Shared resources</text>
    </g>

    <!-- ===== FLOW DESCRIPTION ===== -->
    <g transform="translate(50,535)">
      <text x="0" y="0" fill="#79c0ff" font-size="9" font-weight="700">READ:</text>
      <text x="42" y="0" fill="#6b7280" font-size="8.5">Client --> API GW --> Router --> Query Node --> HNSW ANN search (in-memory) --> return top-K results</text>
      <text x="0" y="18" fill="#c2410c" font-size="9" font-weight="700">WRITE:</text>
      <text x="46" y="18" fill="#6b7280" font-size="8.5">Client --> API GW --> Router --> Query Node --> WAL append --> update HNSW index --> async Raft replicate to followers</text>
    </g>

    <!-- ===== NUMBERED STEP CIRCLES ===== -->
    <!-- Step 1: ML Application → API Gateway -->
    <circle cx="330" cy="95" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/>
    <text x="330" y="99" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">1</text>

    <!-- Step 2: API Gateway → Router Service -->
    <circle cx="520" cy="178" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/>
    <text x="520" y="182" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">2</text>

    <!-- Step 3: Router → PostgreSQL metadata DB -->
    <circle cx="790" cy="208" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/>
    <text x="790" y="212" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">3</text>

    <!-- Step 4: Write: Router → Leader Query Node -->
    <circle cx="280" cy="268" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/>
    <text x="280" y="272" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">4</text>

    <!-- Step 5: Leader: Write to WAL -->
    <circle cx="120" cy="408" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/>
    <text x="120" y="412" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">5</text>

    <!-- Step 6: Leader: Update HNSW index in memory -->
    <circle cx="197" cy="285" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/>
    <text x="197" y="289" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">6</text>

    <!-- Step 7: Leader → Follower nodes (Raft replication) -->
    <circle cx="310" cy="388" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/>
    <text x="310" y="392" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">7</text>

    <!-- Step 8: Read: Router → any Query Node (ANN search) -->
    <circle cx="585" cy="268" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/>
    <text x="585" y="272" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">8</text>

    <!-- Step 9: Query Node: HNSW graph traversal -->
    <circle cx="635" cy="365" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/>
    <text x="635" y="369" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">9</text>

    <!-- Step 10: Query Node: metadata post-filter → return top-K -->
    <circle cx="740" cy="340" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/>
    <text x="740" y="344" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">10</text>

    <!-- Step 11: Background: Flush WAL to SSD, snapshot to S3 -->
    <circle cx="375" cy="510" r="10" fill="#FF5A5F" stroke="#fff" stroke-width="1.5"/>
    <text x="375" y="514" fill="#fff" font-size="10" font-weight="800" text-anchor="middle">11</text>

    <!-- Legend -->
    <g transform="translate(50,580)">
      <line x1="0" y1="5" x2="25" y2="5" stroke="#94a3b8" stroke-width="1.5"/>
      <text x="30" y="9" fill="#6b7280" font-size="8">Sync</text>
      <line x1="75" y1="5" x2="100" y2="5" stroke="#ffa657" stroke-width="1.5" stroke-dasharray="5,3"/>
      <text x="105" y="9" fill="#6b7280" font-size="8">Async</text>
      <line x1="150" y1="5" x2="175" y2="5" stroke="#7B2FF7" stroke-width="1.5"/>
      <text x="180" y="9" fill="#6b7280" font-size="8">Raft Replication</text>
      <circle cx="290" cy="5" r="6" fill="#FF5A5F" stroke="#fff" stroke-width="1"/>
      <text x="290" y="8" fill="#fff" font-size="7" font-weight="800" text-anchor="middle">N</text>
      <text x="302" y="9" fill="#6b7280" font-size="8">Flow Step</text>
    </g>
  </svg>
  </div>

  <!-- ===== REQUEST FLOW REFERENCE ===== -->
  <h3>Request Flow Reference</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr><th>Step</th><th>From</th><th>To</th><th>Action</th></tr>
      </thead>
      <tbody>
        <tr><td><strong>1</strong></td><td>ML Application</td><td>API Gateway</td><td>HTTPS request with auth + tenant isolation</td></tr>
        <tr><td><strong>2</strong></td><td>API Gateway</td><td>Router Service</td><td>Lookup tenant &rarr; shard mapping</td></tr>
        <tr><td><strong>3</strong></td><td>Router</td><td>PostgreSQL (metadata DB)</td><td>Read tenant / collection / shard info</td></tr>
        <tr><td><strong>4</strong></td><td>Router</td><td>Leader Query Node</td><td>Forward upsert request (write path)</td></tr>
        <tr><td><strong>5</strong></td><td>Leader Query Node</td><td>WAL (local SSD)</td><td>Append write-ahead log entry for durability</td></tr>
        <tr><td><strong>6</strong></td><td>Leader Query Node</td><td>HNSW Index (in-memory)</td><td>Insert vector into graph structure</td></tr>
        <tr><td><strong>7</strong></td><td>Leader Query Node</td><td>Follower Query Nodes</td><td>Raft replication (wait for quorum)</td></tr>
        <tr><td><strong>8</strong></td><td>Router</td><td>Any Query Node</td><td>ANN search request (read path)</td></tr>
        <tr><td><strong>9</strong></td><td>Query Node</td><td>HNSW Index (in-memory)</td><td>Graph traversal &mdash; approximate nearest neighbor search</td></tr>
        <tr><td><strong>10</strong></td><td>Query Node</td><td>Client</td><td>Metadata post-filter &rarr; return top-K results</td></tr>
        <tr><td><strong>11</strong></td><td>Background job</td><td>SSD + S3</td><td>Flush WAL segments to SSD; snapshot to S3 for disaster recovery</td></tr>
      </tbody>
    </table>
  </div>

  <!-- ===== HAPPY PATH ===== -->
  <h3>Happy Path</h3>
  <div class="card" style="border-left: 4px solid var(--success); background: rgba(16,185,129,0.05);">
    <h4 style="color: var(--success); margin-top: 0;">Write + Read Sunny Day Flow</h4>
    <div class="flow-steps">
      <div class="flow-step">
        <div class="flow-step-num" style="background: linear-gradient(135deg, var(--success), #059669);">W1</div>
        <div class="flow-step-content"><strong>Client upserts vector</strong><p>ML application sends upsert request through API Gateway. Auth validated, tenant rate-limit checked.</p></div>
      </div>
      <div class="flow-step">
        <div class="flow-step-num" style="background: linear-gradient(135deg, var(--success), #059669);">W2</div>
        <div class="flow-step-content"><strong>WAL write for durability</strong><p>Leader Query Node appends vector operation to Write-Ahead Log on local SSD before any in-memory update.</p></div>
      </div>
      <div class="flow-step">
        <div class="flow-step-num" style="background: linear-gradient(135deg, var(--success), #059669);">W3</div>
        <div class="flow-step-content"><strong>HNSW index update</strong><p>Vector inserted into in-memory HNSW graph. O(log N) operation connecting to M nearest neighbors per layer.</p></div>
      </div>
      <div class="flow-step">
        <div class="flow-step-num" style="background: linear-gradient(135deg, var(--success), #059669);">W4</div>
        <div class="flow-step-content"><strong>Raft replicate + ACK</strong><p>WAL entry replicated to followers. After quorum (2 of 3), write ACK returned to client.</p></div>
      </div>
      <div class="flow-step">
        <div class="flow-step-num" style="background: linear-gradient(135deg, var(--purple), var(--blue));">R1</div>
        <div class="flow-step-content"><strong>Client queries nearest neighbors</strong><p>Query routed to any healthy node in the shard. Router picks node with lowest load.</p></div>
      </div>
      <div class="flow-step">
        <div class="flow-step-num" style="background: linear-gradient(135deg, var(--purple), var(--blue));">R2</div>
        <div class="flow-step-content"><strong>HNSW search + filter</strong><p>Approximate nearest neighbor traversal on the HNSW graph. Metadata post-filter applied to prune non-matching results.</p></div>
      </div>
      <div class="flow-step">
        <div class="flow-step-num" style="background: linear-gradient(135deg, var(--purple), var(--blue));">R3</div>
        <div class="flow-step-content"><strong>Top-K returned in &lt;50ms</strong><p>Final ranked results returned to client with distance scores and metadata. P99 latency target: 50ms.</p></div>
      </div>
    </div>
  </div>

  <!-- ===== FAILURE PATHS ===== -->
  <h3>Failure Paths</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr><th>Failure Scenario</th><th>Impact</th><th>Mitigation</th><th>Recovery</th></tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Leader node crash</strong></td>
          <td>Write path unavailable for affected shard until new leader elected</td>
          <td>Raft consensus protocol detects missing heartbeat</td>
          <td>New leader elected in &lt;5s; follower with most recent WAL promoted; reads unaffected (served by followers)</td>
        </tr>
        <tr>
          <td><strong>HNSW index corruption</strong></td>
          <td>Search returns incorrect or incomplete results</td>
          <td>Checksum validation on index segments; periodic consistency checks</td>
          <td>Rebuild index from WAL + latest S3 snapshot; node removed from read pool during rebuild</td>
        </tr>
        <tr>
          <td><strong>Query timeout</strong></td>
          <td>Client receives error or partial results; high-dimension queries most affected</td>
          <td>Configurable <code class="inline">ef_search</code> parameter per query; circuit breaker on query nodes</td>
          <td>Reduce <code class="inline">ef_search</code> to trade accuracy for speed; return partial results with truncation flag</td>
        </tr>
        <tr>
          <td><strong>Tenant noisy neighbor</strong></td>
          <td>One tenant&rsquo;s heavy workload degrades performance for others on shared nodes</td>
          <td>Per-tenant rate limiting at API Gateway; resource quotas per namespace</td>
          <td>Throttle offending tenant; auto-migrate hot tenants to dedicated nodes (Platinum tier)</td>
        </tr>
        <tr>
          <td><strong>S3 snapshot failure</strong></td>
          <td>Disaster recovery window grows; risk of data loss if all replicas fail simultaneously</td>
          <td>Retry with exponential backoff; alert if 3 consecutive failures</td>
          <td>Operator alert triggers manual snapshot; fall back to WAL replay for recovery</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h3>Write Path</h3>
  <div class="flow-steps">
    <div class="flow-step">
      <div class="flow-step-num">1</div>
      <div class="flow-step-content">
        <strong>API Gateway</strong>
        <p>Receives upsert request. Authenticates tenant, validates vector dimensions match collection schema, rate-limits per-tenant.</p>
      </div>
    </div>
    <div class="flow-step">
      <div class="flow-step-num">2</div>
      <div class="flow-step-content">
        <strong>Router</strong>
        <p>Resolves tenant_id + collection_name to target shard(s). For batch upserts, groups vectors by shard to minimize fan-out.</p>
      </div>
    </div>
    <div class="flow-step">
      <div class="flow-step-num">3</div>
      <div class="flow-step-content">
        <strong>WAL Write</strong>
        <p>Appends the vector operation to the Write-Ahead Log on local SSD. This ensures durability before acknowledging the write.</p>
      </div>
    </div>
    <div class="flow-step">
      <div class="flow-step-num">4</div>
      <div class="flow-step-content">
        <strong>Index Update</strong>
        <p>Inserts the vector into the in-memory HNSW index. For HNSW, this is an O(log N) operation that adds the node and connects it to M nearest neighbors per layer.</p>
      </div>
    </div>
    <div class="flow-step">
      <div class="flow-step-num">5</div>
      <div class="flow-step-content">
        <strong>Replication</strong>
        <p>Asynchronously replicates the WAL entry to replica nodes. Waits for quorum (2 of 3 replicas) before confirming write to client.</p>
      </div>
    </div>
  </div>

  <h3>Read Path</h3>
  <div class="flow-steps">
    <div class="flow-step">
      <div class="flow-step-num">1</div>
      <div class="flow-step-content">
        <strong>Route to Shard(s)</strong>
        <p>Router identifies which shard(s) hold the target collection. If the collection is partitioned across multiple shards, fan out to all.</p>
      </div>
    </div>
    <div class="flow-step">
      <div class="flow-step-num">2</div>
      <div class="flow-step-content">
        <strong>ANN Search</strong>
        <p>Each query node performs HNSW traversal with ef_search beam width. If metadata filters are specified, applies pre-filtering or post-filtering strategy.</p>
      </div>
    </div>
    <div class="flow-step">
      <div class="flow-step-num">3</div>
      <div class="flow-step-content">
        <strong>Merge & Return</strong>
        <p>Router merges top-K results from all shards, re-ranks by distance, and returns final top-K to client with vectors, distances, and metadata.</p>
      </div>
    </div>
  </div>

  <h3>Pre-Filter vs Post-Filter</h3>
  <div class="grid-2">
    <div class="card" style="border-top: 3px solid var(--blue);">
      <h4 style="color: var(--blue);">Pre-Filter</h4>
      <p>Filter vectors by metadata <strong>before</strong> ANN search. Build a bitmap of matching vector IDs, then search only within that subset.</p>
      <div class="tag-row">
        <span class="tag tag-pro">Exact Filter Results</span>
        <span class="tag tag-pro">Good When Filter Is Selective</span>
        <span class="tag tag-con">Slow If Most Vectors Match</span>
        <span class="tag tag-con">Needs Inverted Index on Metadata</span>
      </div>
    </div>
    <div class="card" style="border-top: 3px solid var(--purple);">
      <h4 style="color: var(--purple);">Post-Filter</h4>
      <p>Perform ANN search first (retrieve K' > K candidates), then filter results by metadata, keeping top-K that pass filters.</p>
      <div class="tag-row">
        <span class="tag tag-pro">Fast ANN Search</span>
        <span class="tag tag-pro">Simple Implementation</span>
        <span class="tag tag-con">May Return &lt;K Results</span>
        <span class="tag tag-con">Wasted Work on Non-Matching Vectors</span>
      </div>
    </div>
  </div>

  <div class="callout callout-success">
    <div class="callout-title">Hybrid Approach</div>
    <p>Use <strong>pre-filtering</strong> when the filter is highly selective (passes &lt;20% of vectors) and <strong>post-filtering</strong> when it is broad (passes >50%). The query planner estimates selectivity from metadata statistics and chooses the optimal strategy automatically.</p>
  </div>
</div>

<!-- ============================================================ -->
<!--  SECTION 6: MULTI-TENANCY                                     -->
<!-- ============================================================ -->
<div class="section" id="multi-tenancy">
  <div class="section-label">Section 6</div>
  <h2>Multi-Tenancy Design</h2>
  <p>The multi-tenancy model determines data isolation, resource sharing, and operational complexity. We evaluate three options and recommend a hybrid approach.</p>

  <div class="option-card opt-a">
    <div class="opt-label">Option A</div>
    <h4 style="color: var(--blue);">Shared Index + Tenant ID Filter</h4>
    <p>All tenants' vectors live in a single shared HNSW index. Each vector is tagged with a <code class="inline">tenant_id</code> in its metadata. Queries include a mandatory tenant_id filter.</p>
    <div class="grid-2" style="margin-top: 12px;">
      <div>
        <strong style="color: var(--success);">Pros</strong>
        <ul>
          <li>Simplest to implement and operate</li>
          <li>Single index means maximum resource efficiency</li>
          <li>Easy to scale: just add more shards</li>
        </ul>
      </div>
      <div>
        <strong style="color: var(--danger);">Cons</strong>
        <ul>
          <li><strong>Noisy neighbor problem:</strong> one tenant's large insert degrades all</li>
          <li>Post-filter on tenant_id wastes ANN computation on wrong tenants</li>
          <li>Security risk: bug in filter exposes cross-tenant data</li>
          <li>Cannot tune index params per tenant</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="option-card opt-b">
    <div class="opt-label">Option B</div>
    <h4 style="color: var(--purple);">Namespace Per Tenant</h4>
    <p>Each tenant gets a logical namespace (separate HNSW index) but indexes share physical machines. A query node may host multiple tenant namespaces.</p>
    <div class="grid-2" style="margin-top: 12px;">
      <div>
        <strong style="color: var(--success);">Pros</strong>
        <ul>
          <li>Strong logical isolation between tenants</li>
          <li>Per-tenant index tuning (M, ef, distance metric)</li>
          <li>Easy to move namespaces between nodes for rebalancing</li>
          <li>No cross-tenant filter overhead during search</li>
        </ul>
      </div>
      <div>
        <strong style="color: var(--danger);">Cons</strong>
        <ul>
          <li>Memory fragmentation across many small indexes</li>
          <li>Still share CPU/IO resources, some noise possible</li>
          <li>Operational complexity: manage 100s of indexes</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="option-card opt-c">
    <div class="opt-label">Option C</div>
    <h4 style="color: var(--accent);">Dedicated Index Per Tenant</h4>
    <p>Each tenant gets a fully dedicated set of query nodes. Complete physical isolation.</p>
    <div class="grid-2" style="margin-top: 12px;">
      <div>
        <strong style="color: var(--success);">Pros</strong>
        <ul>
          <li>Complete isolation: zero noisy-neighbor impact</li>
          <li>Per-tenant SLAs and scaling</li>
          <li>Simplest failure domain: tenant failure is isolated</li>
        </ul>
      </div>
      <div>
        <strong style="color: var(--danger);">Cons</strong>
        <ul>
          <li>Extremely wasteful for small tenants (&lt;100K vectors)</li>
          <li>High operational cost: 100 separate clusters</li>
          <li>Slow provisioning for new tenants</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="option-card opt-rec">
    <div class="opt-label">Recommended</div>
    <h4 style="color: var(--success);">Hybrid Tiered Approach</h4>
    <p>Classify tenants into tiers and apply the appropriate isolation level.</p>
    <div class="arch-diagram"><span class="d-secondary">Tiered Multi-Tenancy Model:</span>

<span class="d-primary">Tier 1 - Platinum (>50M vectors):</span> Dedicated query nodes, own shards
  Example: Search team (500M listing embeddings)
  --> Full physical isolation, dedicated scaling

<span class="d-blue">Tier 2 - Gold (1M-50M vectors):</span> Namespace per tenant, shared nodes with resource limits
  Example: Recommendations (20M user embeddings), Trust (10M review embeddings)
  --> Logical isolation + cgroup/memory limits per namespace

<span class="d-purple">Tier 3 - Silver (<1M vectors):</span> Shared index with tenant_id partitioning
  Example: Pricing team (100K price embeddings), Experimental projects
  --> Cost-efficient, tenant_id pre-filter on small shared index

<span class="d-warn">Promotion:</span> Tenants auto-promote when vector count exceeds tier threshold
<span class="d-warn">Resource Quotas:</span> Each tier has CPU, memory, and QPS quotas enforced by the control plane</div>
  </div>
</div>

<!-- ============================================================ -->
<!--  SECTION 7: DATA MODEL                                        -->
<!-- ============================================================ -->
<div class="section" id="data-model">
  <div class="section-label">Section 7</div>
  <h2>Data Model</h2>

  <h3>Control Plane (PostgreSQL)</h3>
  <pre><code><span class="cm">-- Tenant registry</span>
<span class="kw">CREATE TABLE</span> <span class="fn">tenants</span> (
    <span class="var">tenant_id</span>       <span class="typ">UUID</span> <span class="kw">PRIMARY KEY</span>,
    <span class="var">name</span>            <span class="typ">VARCHAR(255)</span> <span class="kw">NOT NULL</span>,
    <span class="var">tier</span>            <span class="typ">ENUM</span>(<span class="str">'platinum'</span>, <span class="str">'gold'</span>, <span class="str">'silver'</span>) <span class="kw">DEFAULT</span> <span class="str">'silver'</span>,
    <span class="var">api_key_hash</span>    <span class="typ">VARCHAR(64)</span> <span class="kw">NOT NULL</span>,
    <span class="var">max_vectors</span>     <span class="typ">BIGINT</span> <span class="kw">DEFAULT</span> <span class="num">10000000</span>,
    <span class="var">max_qps</span>         <span class="typ">INT</span> <span class="kw">DEFAULT</span> <span class="num">100</span>,
    <span class="var">created_at</span>      <span class="typ">TIMESTAMPTZ</span> <span class="kw">DEFAULT NOW</span>()
);

<span class="cm">-- Collection definitions</span>
<span class="kw">CREATE TABLE</span> <span class="fn">collections</span> (
    <span class="var">collection_id</span>   <span class="typ">UUID</span> <span class="kw">PRIMARY KEY</span>,
    <span class="var">tenant_id</span>       <span class="typ">UUID</span> <span class="kw">REFERENCES</span> tenants(<span class="var">tenant_id</span>),
    <span class="var">name</span>            <span class="typ">VARCHAR(255)</span> <span class="kw">NOT NULL</span>,
    <span class="var">dimensions</span>      <span class="typ">INT</span> <span class="kw">NOT NULL</span>,         <span class="cm">-- 768, 1536, etc.</span>
    <span class="var">distance_metric</span> <span class="typ">ENUM</span>(<span class="str">'cosine'</span>, <span class="str">'euclidean'</span>, <span class="str">'dot_product'</span>),
    <span class="var">index_type</span>      <span class="typ">ENUM</span>(<span class="str">'hnsw'</span>, <span class="str">'ivf'</span>, <span class="str">'flat'</span>) <span class="kw">DEFAULT</span> <span class="str">'hnsw'</span>,
    <span class="var">hnsw_m</span>          <span class="typ">INT</span> <span class="kw">DEFAULT</span> <span class="num">16</span>,
    <span class="var">hnsw_ef_construct</span> <span class="typ">INT</span> <span class="kw">DEFAULT</span> <span class="num">200</span>,
    <span class="var">num_shards</span>      <span class="typ">INT</span> <span class="kw">DEFAULT</span> <span class="num">1</span>,
    <span class="var">vector_count</span>    <span class="typ">BIGINT</span> <span class="kw">DEFAULT</span> <span class="num">0</span>,
    <span class="var">created_at</span>      <span class="typ">TIMESTAMPTZ</span> <span class="kw">DEFAULT NOW</span>(),
    <span class="kw">UNIQUE</span>(<span class="var">tenant_id</span>, <span class="var">name</span>)
);

<span class="cm">-- Shard assignments</span>
<span class="kw">CREATE TABLE</span> <span class="fn">shard_assignments</span> (
    <span class="var">shard_id</span>        <span class="typ">UUID</span> <span class="kw">PRIMARY KEY</span>,
    <span class="var">collection_id</span>   <span class="typ">UUID</span> <span class="kw">REFERENCES</span> collections(<span class="var">collection_id</span>),
    <span class="var">shard_index</span>     <span class="typ">INT</span> <span class="kw">NOT NULL</span>,        <span class="cm">-- 0, 1, 2...</span>
    <span class="var">primary_node</span>    <span class="typ">VARCHAR(255)</span>,        <span class="cm">-- query-node-07.vpc</span>
    <span class="var">replica_nodes</span>   <span class="typ">TEXT[]</span>,              <span class="cm">-- {node-08, node-12}</span>
    <span class="var">status</span>          <span class="typ">ENUM</span>(<span class="str">'active'</span>, <span class="str">'migrating'</span>, <span class="str">'rebuilding'</span>),
    <span class="var">vector_range</span>    <span class="typ">INT4RANGE</span>            <span class="cm">-- hash range for this shard</span>
);</code></pre>

  <h3>Vector Storage (Custom Engine)</h3>
  <pre><code><span class="cm">// Each vector record in the storage engine</span>
<span class="kw">struct</span> <span class="typ">VectorRecord</span> {
    <span class="var">id</span>:         <span class="typ">UUID</span>,              <span class="cm">// unique vector ID</span>
    <span class="var">vector</span>:     <span class="typ">[f32; D]</span>,          <span class="cm">// raw embedding (D = dimensions)</span>
    <span class="var">metadata</span>:   <span class="typ">Map&lt;String, Value&gt;</span>, <span class="cm">// filterable key-value pairs</span>
    <span class="var">tenant_id</span>:  <span class="typ">UUID</span>,              <span class="cm">// owning tenant</span>
    <span class="var">collection</span>: <span class="typ">UUID</span>,              <span class="cm">// parent collection</span>
    <span class="var">created_at</span>: <span class="typ">u64</span>,               <span class="cm">// unix timestamp</span>
    <span class="var">version</span>:    <span class="typ">u64</span>,               <span class="cm">// optimistic concurrency</span>
}

<span class="cm">// HNSW graph node (in-memory)</span>
<span class="kw">struct</span> <span class="typ">HnswNode</span> {
    <span class="var">vector_id</span>:  <span class="typ">UUID</span>,
    <span class="var">level</span>:      <span class="typ">u8</span>,                <span class="cm">// max layer this node appears in</span>
    <span class="var">neighbors</span>:  <span class="typ">Vec&lt;Vec&lt;UUID&gt;&gt;</span>,    <span class="cm">// neighbors[layer] = list of neighbor IDs</span>
}

<span class="cm">// Metadata index (for pre-filtering)</span>
<span class="kw">struct</span> <span class="typ">MetadataIndex</span> {
    <span class="var">field_name</span>: <span class="typ">String</span>,
    <span class="var">index_type</span>: <span class="typ">Enum</span> { Keyword, Numeric, Geo },
    <span class="var">inverted</span>:   <span class="typ">Map&lt;Value, RoaringBitmap&gt;</span>, <span class="cm">// value -> set of vector offsets</span>
}</code></pre>
</div>

<!-- ============================================================ -->
<!--  SECTION 8: API DESIGN                                        -->
<!-- ============================================================ -->
<div class="section" id="api-design">
  <div class="section-label">Section 8</div>
  <h2>API Design</h2>

  <h3>Collection Management</h3>
  <pre><code><span class="cm">// Create a new vector collection</span>
<span class="kw">POST</span> <span class="str">/v1/collections</span>
<span class="var">Headers</span>: Authorization: Bearer &lt;tenant_api_key&gt;

{
  <span class="str">"name"</span>:            <span class="str">"listing-embeddings"</span>,
  <span class="str">"dimensions"</span>:      <span class="num">768</span>,
  <span class="str">"distance_metric"</span>: <span class="str">"cosine"</span>,
  <span class="str">"index_config"</span>: {
    <span class="str">"type"</span>:            <span class="str">"hnsw"</span>,
    <span class="str">"m"</span>:               <span class="num">16</span>,
    <span class="str">"ef_construction"</span>: <span class="num">200</span>
  },
  <span class="str">"metadata_schema"</span>: {
    <span class="str">"city"</span>:     <span class="str">"keyword"</span>,
    <span class="str">"price"</span>:    <span class="str">"float"</span>,
    <span class="str">"rating"</span>:   <span class="str">"float"</span>,
    <span class="str">"category"</span>: <span class="str">"keyword"</span>
  }
}

<span class="cm">// Response</span>
{
  <span class="str">"collection_id"</span>: <span class="str">"col_abc123"</span>,
  <span class="str">"status"</span>:        <span class="str">"ready"</span>,
  <span class="str">"shards"</span>:        <span class="num">1</span>
}</code></pre>

  <h3>Upsert Vectors</h3>
  <pre><code><span class="cm">// Batch upsert (insert or update) vectors</span>
<span class="kw">POST</span> <span class="str">/v1/collections/{collection_id}/vectors</span>

{
  <span class="str">"vectors"</span>: [
    {
      <span class="str">"id"</span>:       <span class="str">"listing_12345"</span>,
      <span class="str">"values"</span>:   [<span class="num">0.12</span>, <span class="num">-0.34</span>, <span class="num">0.56</span>, ... ],  <span class="cm">// 768 floats</span>
      <span class="str">"metadata"</span>: {
        <span class="str">"city"</span>:     <span class="str">"San Francisco"</span>,
        <span class="str">"price"</span>:    <span class="num">150.0</span>,
        <span class="str">"rating"</span>:   <span class="num">4.8</span>,
        <span class="str">"category"</span>: <span class="str">"entire_home"</span>
      }
    },
    <span class="cm">// ... up to 1000 vectors per batch</span>
  ]
}

<span class="cm">// Response</span>
{
  <span class="str">"upserted_count"</span>: <span class="num">1000</span>,
  <span class="str">"status"</span>:         <span class="str">"ok"</span>
}</code></pre>

  <h3>Query (Nearest Neighbor Search)</h3>
  <pre><code><span class="cm">// Find K nearest neighbors with optional metadata filter</span>
<span class="kw">POST</span> <span class="str">/v1/collections/{collection_id}/query</span>

{
  <span class="str">"vector"</span>:        [<span class="num">0.08</span>, <span class="num">-0.21</span>, <span class="num">0.44</span>, ... ],  <span class="cm">// query embedding</span>
  <span class="str">"top_k"</span>:         <span class="num">10</span>,
  <span class="str">"ef_search"</span>:     <span class="num">128</span>,                          <span class="cm">// optional HNSW param override</span>
  <span class="str">"include_values"</span>: <span class="kw">false</span>,                        <span class="cm">// don't return raw vectors</span>
  <span class="str">"filter"</span>: {
    <span class="str">"city"</span>:  { <span class="str">"$eq"</span>: <span class="str">"San Francisco"</span> },
    <span class="str">"price"</span>: { <span class="str">"$lte"</span>: <span class="num">200.0</span> },
    <span class="str">"rating"</span>: { <span class="str">"$gte"</span>: <span class="num">4.0</span> }
  }
}

<span class="cm">// Response</span>
{
  <span class="str">"matches"</span>: [
    {
      <span class="str">"id"</span>:       <span class="str">"listing_67890"</span>,
      <span class="str">"score"</span>:    <span class="num">0.9534</span>,          <span class="cm">// cosine similarity</span>
      <span class="str">"metadata"</span>: { <span class="str">"city"</span>: <span class="str">"San Francisco"</span>, <span class="str">"price"</span>: <span class="num">135.0</span>, ... }
    },
    <span class="cm">// ... 9 more results</span>
  ],
  <span class="str">"query_time_ms"</span>: <span class="num">12</span>
}</code></pre>

  <h3>Delete Vectors</h3>
  <pre><code><span class="cm">// Delete by IDs</span>
<span class="kw">DELETE</span> <span class="str">/v1/collections/{collection_id}/vectors</span>

{
  <span class="str">"ids"</span>: [<span class="str">"listing_12345"</span>, <span class="str">"listing_12346"</span>]
}

<span class="cm">// Delete by metadata filter (bulk)</span>
<span class="kw">DELETE</span> <span class="str">/v1/collections/{collection_id}/vectors</span>

{
  <span class="str">"filter"</span>: { <span class="str">"category"</span>: { <span class="str">"$eq"</span>: <span class="str">"deprecated"</span> } }
}</code></pre>
</div>

<!-- ============================================================ -->
<!--  SECTION 9: STORAGE ENGINE                                    -->
<!-- ============================================================ -->
<div class="section" id="storage-engine">
  <div class="section-label">Section 9</div>
  <h2>Storage Engine</h2>

  <div class="arch-diagram"><span class="d-accent">STORAGE ENGINE INTERNALS</span>

<span class="d-primary">Write Path:</span>
  Client Request
       |
       v
  <span class="d-warn">[WAL Append]</span> ----> Sequential write to append-only log on SSD
       |              (fsync every 10ms or every 100 entries)
       v
  <span class="d-blue">[Memtable]</span> -----> In-memory buffer of recent vectors
       |              (Red-Black tree, sorted by vector ID)
       |
       +---> <span class="d-secondary">[HNSW Index Update]</span> ----> Insert node into graph
       |                                (connects to M nearest neighbors)
       |
       v (when memtable full, ~64MB)
  <span class="d-purple">[Flush to Segment]</span> --> Immutable segment file on SSD
                          - Vector data (contiguous float arrays)
                          - Metadata (columnar encoding)
                          - Bloom filter for ID lookups

<span class="d-primary">Recovery Path:</span>
  Node restart --> Replay WAL from last checkpoint
                   Rebuild HNSW index from segment files
                   (or load HNSW snapshot if available)

<span class="d-primary">Background Compaction:</span>
  Merge small segments --> Larger segments (like LSM-tree)
  Remove deleted vectors (tombstones)
  Rebuild HNSW graph periodically for optimal structure</div>

  <div class="grid-2">
    <div class="card">
      <h4 style="color: var(--primary);">Write-Ahead Log (WAL)</h4>
      <ul>
        <li>Append-only sequential writes for maximum throughput</li>
        <li>Group commit: batch fsync every 10ms or 100 operations</li>
        <li>Log structured: insert, update, delete entries with sequence numbers</li>
        <li>Truncated after successful flush + snapshot</li>
        <li>Replicated to 2 followers before ack</li>
      </ul>
    </div>
    <div class="card">
      <h4 style="color: var(--blue);">Memory-Mapped Files</h4>
      <ul>
        <li>Segment files are mmap'd for efficient random reads</li>
        <li>OS manages page cache, frequently accessed vectors stay in RAM</li>
        <li>Zero-copy reads: no serialization overhead</li>
        <li>Works well with SSD for cold vectors</li>
        <li>Prefetch hints for sequential scans during compaction</li>
      </ul>
    </div>
    <div class="card">
      <h4 style="color: #1e293b;">HNSW Index Management</h4>
      <ul>
        <li>Full HNSW graph lives in memory for query performance</li>
        <li>Serialized to disk as periodic snapshots (every 5 min)</li>
        <li>On restart: load latest snapshot + replay WAL delta</li>
        <li>Background re-indexing for graph quality optimization</li>
        <li>Soft-delete with tombstones, periodic cleanup</li>
      </ul>
    </div>
    <div class="card">
      <h4 style="color: var(--purple);">Snapshots to S3</h4>
      <ul>
        <li>Full collection snapshots uploaded to S3 hourly</li>
        <li>Includes: HNSW graph, segment files, metadata indexes</li>
        <li>Used for disaster recovery and spinning up new replicas</li>
        <li>Incremental snapshots (delta from last full) every 15 min</li>
        <li>Retention: 7 days of hourly snapshots, 30 days of daily</li>
      </ul>
    </div>
  </div>

  <h3>Quantization for Memory Reduction</h3>
  <div class="card">
    <p>For large collections where full HNSW in memory is too expensive, we apply <strong>Scalar Quantization (SQ8)</strong> or <strong>Product Quantization (PQ)</strong> to compress vectors in the index while keeping full-precision vectors on disk for re-ranking.</p>
    <pre><code><span class="cm">// Two-phase search with quantized index:</span>

<span class="cm">// Phase 1: Coarse search using quantized vectors in HNSW (fast, in memory)</span>
<span class="var">candidates</span> = hnsw_search(quantized_index, query, ef=<span class="num">256</span>, top=<span class="num">100</span>)

<span class="cm">// Phase 2: Re-rank using full-precision vectors from disk/mmap (accurate)</span>
<span class="var">results</span> = rerank(candidates, query, full_precision_vectors, top_k=<span class="num">10</span>)

<span class="cm">// Memory savings:</span>
<span class="cm">// SQ8:  768 dims x 1 byte = 768 bytes (4x compression)</span>
<span class="cm">// PQ96: 96 codes x 1 byte = 96 bytes  (32x compression)</span></code></pre>
  </div>
</div>

<!-- ============================================================ -->
<!--  SECTION 10: SCALING                                          -->
<!-- ============================================================ -->
<div class="section" id="scaling">
  <div class="section-label">Section 10</div>
  <h2>Scaling Strategy</h2>

  <h3>Sharding</h3>
  <div class="card">
    <h4 style="color: var(--accent);">Shard by Collection</h4>
    <p>Each collection can be split across multiple shards. Vectors are assigned to shards by consistent hashing on the vector ID. Each shard holds a partition of the HNSW graph.</p>
    <div class="arch-diagram"><span class="d-blue">Collection "listing-embeddings" (50M vectors, 4 shards):</span>

  <span class="d-primary">Shard 0</span>              <span class="d-secondary">Shard 1</span>              <span class="d-purple">Shard 2</span>              <span class="d-accent">Shard 3</span>
  [12.5M vectors]      [12.5M vectors]      [12.5M vectors]      [12.5M vectors]
  HNSW index           HNSW index           HNSW index           HNSW index
  Node: qn-01          Node: qn-03          Node: qn-05          Node: qn-07
  Replicas: qn-02,04   Replicas: qn-04,06   Replicas: qn-06,08   Replicas: qn-08,02

<span class="d-warn">Query fan-out:</span> Router sends query to all 4 shards in parallel
              Each shard returns local top-K
              Router merges + re-ranks to global top-K</div>
  </div>

  <h3>Replication</h3>
  <div class="grid-2">
    <div class="card">
      <h4 style="color: #1e293b;">Leader-Follower Replication</h4>
      <ul>
        <li>Each shard has 1 leader + 2 followers (RF=3)</li>
        <li>Writes go to leader, replicated via WAL shipping</li>
        <li>Quorum writes: ack after 2/3 nodes confirm</li>
        <li>Reads served by any replica (load balanced)</li>
        <li>Automatic leader election on failure (via Raft)</li>
      </ul>
    </div>
    <div class="card">
      <h4 style="color: var(--blue);">Query Fan-Out + Merge</h4>
      <ul>
        <li>Multi-shard queries fan out to all shards in parallel</li>
        <li>Each shard returns top-K candidates with scores</li>
        <li>Router performs a merge-sort by score</li>
        <li>Over-fetch (request 2x K per shard) to improve recall after merge</li>
        <li>Tail latency mitigation: hedge requests to replicas</li>
      </ul>
    </div>
  </div>

  <h3>Auto-Scaling Triggers</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Metric</th>
          <th>Threshold</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong style="color: var(--text);">Memory Usage</strong></td>
          <td>>80% of node RAM</td>
          <td>Add shards (split collection), rebalance</td>
        </tr>
        <tr>
          <td><strong style="color: var(--text);">QPS per Shard</strong></td>
          <td>>500 QPS sustained</td>
          <td>Add read replicas for that shard</td>
        </tr>
        <tr>
          <td><strong style="color: var(--text);">P99 Latency</strong></td>
          <td>>40ms for 3+ minutes</td>
          <td>Add replicas or split hot shards</td>
        </tr>
        <tr>
          <td><strong style="color: var(--text);">Vector Count</strong></td>
          <td>>20M per shard</td>
          <td>Split shard into 2, rebalance graph</td>
        </tr>
        <tr>
          <td><strong style="color: var(--text);">Insert Rate</strong></td>
          <td>>100K/hour sustained</td>
          <td>Scale write path, add WAL throughput</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="callout callout-warning">
    <div class="callout-title">Shard Splitting is Expensive</div>
    <p>Splitting an HNSW shard requires building a new graph from scratch for each half. This takes O(N log N) time and significant memory. Plan shard sizes conservatively (target 10-15M vectors per shard) and split proactively during low-traffic windows.</p>
  </div>
</div>

<!-- ============================================================ -->
<!--  SECTION 11: CONSISTENCY MODEL                                -->
<!-- ============================================================ -->
<div class="section" id="consistency">
  <div class="section-label">Section 11</div>
  <h2>Consistency Model</h2>

  <div class="grid-2">
    <div class="card" style="border-top: 3px solid var(--primary);">
      <h4 style="color: var(--primary);">Write Consistency</h4>
      <ul>
        <li><strong>WAL + Quorum:</strong> Write is durable after WAL fsync on leader + 1 follower (quorum of 2/3)</li>
        <li><strong>Synchronous index update:</strong> Vector is searchable on the leader immediately after WAL write</li>
        <li><strong>Async replication:</strong> Followers apply WAL entries and update their local HNSW index</li>
        <li><strong>Replication lag:</strong> Typically &lt;100ms, max 5s before alerting</li>
        <li><strong>Conflict resolution:</strong> Last-writer-wins using vector version numbers</li>
      </ul>
    </div>
    <div class="card" style="border-top: 3px solid var(--secondary);">
      <h4 style="color: #1e293b;">Read Consistency</h4>
      <ul>
        <li><strong>Eventual consistency is acceptable:</strong> Missing a just-inserted vector in ANN results is tolerable</li>
        <li><strong>Read-your-writes:</strong> Sticky routing to leader for 5s after a write (optional)</li>
        <li><strong>Stale reads:</strong> Followers may return results up to ~100ms stale</li>
        <li><strong>ANN is approximate anyway:</strong> Missing 1-2 recently inserted vectors has negligible impact on recall</li>
      </ul>
    </div>
  </div>

  <div class="card">
    <h4 style="color: var(--purple);">Background Index Rebuild</h4>
    <p>Over time, the HNSW graph degrades as vectors are deleted (tombstoned) and the graph structure becomes suboptimal. A background process periodically rebuilds the index:</p>
    <ol>
      <li><strong>Build new HNSW graph</strong> from current segment files (shadow index)</li>
      <li><strong>Apply WAL delta</strong> accumulated during rebuild</li>
      <li><strong>Atomic swap:</strong> Replace old index pointer with new index</li>
      <li><strong>Cleanup:</strong> Release memory from old graph</li>
    </ol>
    <p>This runs during low-traffic windows (2-6 AM) and takes ~30 minutes for a 10M vector shard.</p>
  </div>
</div>

<!-- ============================================================ -->
<!--  SECTION 12: TRADE-OFFS                                       -->
<!-- ============================================================ -->
<div class="section" id="tradeoffs">
  <div class="section-label">Section 12</div>
  <h2>Key Trade-offs</h2>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Trade-off</th>
          <th>Option A</th>
          <th>Option B</th>
          <th>Our Choice</th>
          <th>Rationale</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong style="color: var(--text);">Index Algorithm</strong></td>
          <td>IVF-PQ (low memory)</td>
          <td>HNSW (high recall)</td>
          <td style="color: var(--success);">HNSW + optional PQ</td>
          <td>Sub-ms latency and >95% recall outweigh memory cost; PQ for large tenants</td>
        </tr>
        <tr>
          <td><strong style="color: var(--text);">Tenancy Model</strong></td>
          <td>Shared index</td>
          <td>Dedicated per tenant</td>
          <td style="color: var(--success);">Hybrid tiers</td>
          <td>Large tenants get isolation; small tenants share efficiently</td>
        </tr>
        <tr>
          <td><strong style="color: var(--text);">Consistency</strong></td>
          <td>Strong (sync replicas)</td>
          <td>Eventual</td>
          <td style="color: var(--success);">Eventual + quorum writes</td>
          <td>ANN is inherently approximate; strong consistency adds latency for no benefit</td>
        </tr>
        <tr>
          <td><strong style="color: var(--text);">Metadata Filter</strong></td>
          <td>Always pre-filter</td>
          <td>Always post-filter</td>
          <td style="color: var(--success);">Adaptive (cost-based)</td>
          <td>Query planner selects strategy based on filter selectivity</td>
        </tr>
        <tr>
          <td><strong style="color: var(--text);">Storage</strong></td>
          <td>All in-memory</td>
          <td>Disk-based (DiskANN)</td>
          <td style="color: var(--success);">Memory + SSD tiering</td>
          <td>Hot index in RAM, full vectors on SSD, snapshots on S3</td>
        </tr>
        <tr>
          <td><strong style="color: var(--text);">Replication</strong></td>
          <td>Sync (strong)</td>
          <td>Async (fast)</td>
          <td style="color: var(--success);">Quorum (2/3)</td>
          <td>Balance between durability and write latency</td>
        </tr>
        <tr>
          <td><strong style="color: var(--text);">Sharding</strong></td>
          <td>Shard by tenant</td>
          <td>Shard by vector hash</td>
          <td style="color: var(--success);">Shard by collection + hash</td>
          <td>Collection-level sharding allows per-tenant scaling decisions</td>
        </tr>
        <tr>
          <td><strong style="color: var(--text);">Distance Computation</strong></td>
          <td>Scalar (portable)</td>
          <td>SIMD-optimized</td>
          <td style="color: var(--success);">SIMD (AVX-512/NEON)</td>
          <td>SIMD gives 4-8x speedup on distance computations, critical for throughput</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ============================================================ -->
<!--  SECTION 13: COMPARISON WITH EXISTING                         -->
<!-- ============================================================ -->
<div class="section" id="comparison">
  <div class="section-label">Section 13</div>
  <h2>Comparison with Existing Solutions</h2>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>System</th>
          <th>Type</th>
          <th>Index</th>
          <th>Multi-Tenancy</th>
          <th>Scaling</th>
          <th>Best For</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong style="color: var(--primary);">Pinecone</strong></td>
          <td>Managed SaaS</td>
          <td>Proprietary (likely IVF-PQ based)</td>
          <td>Namespace-based</td>
          <td>Auto (serverless)</td>
          <td>Zero-ops, fast time to market</td>
        </tr>
        <tr>
          <td><strong style="color: #1e293b;">Weaviate</strong></td>
          <td>Open-source</td>
          <td>HNSW</td>
          <td>Multi-tenant classes</td>
          <td>Horizontal (shards)</td>
          <td>GraphQL API, hybrid search</td>
        </tr>
        <tr>
          <td><strong style="color: var(--blue);">Milvus</strong></td>
          <td>Open-source</td>
          <td>IVF, HNSW, DiskANN</td>
          <td>Database/collection level</td>
          <td>Kubernetes-native</td>
          <td>Billion-scale, flexible indexes</td>
        </tr>
        <tr>
          <td><strong style="color: var(--purple);">Qdrant</strong></td>
          <td>Open-source</td>
          <td>HNSW + quantization</td>
          <td>Collection-level</td>
          <td>Horizontal (Raft)</td>
          <td>Rust performance, filtering</td>
        </tr>
        <tr>
          <td><strong style="color: var(--accent);">pgvector</strong></td>
          <td>PG Extension</td>
          <td>IVFFlat, HNSW</td>
          <td>Row-level security</td>
          <td>PG replication</td>
          <td>Simple use cases, &lt;5M vectors</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h3>When to Use Each</h3>
  <div class="grid-2">
    <div class="card">
      <h4 style="color: var(--primary);">Use Pinecone when...</h4>
      <ul>
        <li>You need zero operational overhead</li>
        <li>Budget allows managed service pricing</li>
        <li>Fast prototyping and time-to-market matters</li>
        <li>&lt;100M vectors, moderate query volume</li>
      </ul>
    </div>
    <div class="card">
      <h4 style="color: var(--blue);">Use Milvus when...</h4>
      <ul>
        <li>Billion-scale vectors with complex requirements</li>
        <li>Need flexibility in index algorithm choice</li>
        <li>Kubernetes-native deployment preferred</li>
        <li>Need DiskANN for cost-effective large-scale search</li>
      </ul>
    </div>
    <div class="card">
      <h4 style="color: var(--purple);">Use Qdrant when...</h4>
      <ul>
        <li>Need advanced filtering with high performance</li>
        <li>Rust ecosystem and performance characteristics</li>
        <li>On-premise deployment with strong consistency needs</li>
        <li>Collections with rich metadata and complex queries</li>
      </ul>
    </div>
    <div class="card">
      <h4 style="color: var(--accent);">Use pgvector when...</h4>
      <ul>
        <li>Already using PostgreSQL and want simplicity</li>
        <li>Small to medium scale (&lt;5M vectors)</li>
        <li>Need ACID transactions with vector operations</li>
        <li>Don't want to manage a separate vector database</li>
      </ul>
    </div>
  </div>

  <div class="callout callout-insight">
    <div class="callout-title">Build vs Buy Decision</div>
    <p>Building a custom multi-tenant vector database makes sense when: (1) you have <strong>100+ tenants</strong> with diverse requirements, (2) you need <strong>deep integration</strong> with internal ML pipelines, (3) you require <strong>custom tenancy isolation</strong> that no existing solution provides, and (4) you have the engineering team to maintain it. For most organizations, <strong>Milvus or Qdrant + custom routing layer</strong> is the pragmatic choice.</p>
  </div>
</div>

<!-- ============================================================ -->
<!--  SECTION 14: INTERVIEW TIPS                                   -->
<!-- ============================================================ -->
<div class="section" id="interview-tips">
  <div class="section-label">Section 14</div>
  <h2>Interview Tips</h2>

  <div class="callout callout-danger">
    <div class="callout-title">What This Question Tests</div>
    <p>This is a PE-level question that simultaneously probes three deep areas: <strong>(1) ANN algorithm expertise</strong> (HNSW, IVF, PQ internals), <strong>(2) distributed systems design</strong> (sharding, replication, consistency), and <strong>(3) multi-tenancy depth</strong> (isolation models, noisy-neighbor, resource management). Interviewers expect you to go deep in at least two of these areas.</p>
  </div>

  <div class="grid-2">
    <div class="card" style="border-left: 4px solid var(--primary);">
      <h4 style="color: var(--primary);">Do</h4>
      <ul>
        <li><strong>Start with the embedding model output</strong> - clarify dimensions, distance metric, and use cases before diving into infrastructure</li>
        <li><strong>Explain HNSW at graph level</strong> - multi-layer greedy traversal, M parameter, ef_search trade-off. Draw the skip-list analogy</li>
        <li><strong>Quantify memory</strong> - show the math: 10M vectors x 768 dims x 4 bytes = 30 GB per tenant. This drives all scaling decisions</li>
        <li><strong>Discuss recall vs latency trade-off</strong> - show you understand that ANN is fundamentally approximate and that parameters control the trade-off</li>
        <li><strong>Address multi-tenancy explicitly</strong> - noisy neighbor, isolation levels, tiering. This is what makes it PE-level</li>
        <li><strong>Mention metadata filtering</strong> - pre-filter vs post-filter is a critical design decision interviewers look for</li>
      </ul>
    </div>
    <div class="card" style="border-left: 4px solid var(--danger);">
      <h4 style="color: var(--danger);">Don't</h4>
      <ul>
        <li><strong>Don't treat it as a key-value store</strong> - the ANN search algorithm is the core, not just storage and retrieval</li>
        <li><strong>Don't skip capacity estimation</strong> - memory is the bottleneck and drives the entire architecture. Show the math</li>
        <li><strong>Don't ignore the index build cost</strong> - HNSW build is O(N log N), IVF requires k-means training. Discuss how this affects inserts</li>
        <li><strong>Don't forget SIMD</strong> - mention that distance computation is vectorized with AVX-512/NEON for production performance</li>
        <li><strong>Don't over-engineer tenancy</strong> - a single shared index can work for simple cases; show you can match complexity to requirements</li>
        <li><strong>Don't neglect durability</strong> - WAL + snapshots for recovery. In-memory indexes need a persistence story</li>
      </ul>
    </div>
  </div>

  <h3>Possible Follow-Up Questions</h3>
  <div class="card">
    <ol>
      <li><strong>How would you handle a tenant that suddenly needs 10x more vectors?</strong> -- Discuss shard splitting, automatic tier promotion, and capacity planning</li>
      <li><strong>What happens when a query node crashes mid-search?</strong> -- Replica failover, request retries, partial results with degraded recall</li>
      <li><strong>How do you update the embedding model (new dimensions)?</strong> -- Dual-write period, shadow collection with new model, gradual migration, then swap</li>
      <li><strong>How would you add real-time hybrid search (vector + full-text)?</strong> -- Combine vector ANN with BM25 scoring, reciprocal rank fusion for merging results</li>
      <li><strong>What if you need to support 100B vectors?</strong> -- Disk-based ANN (DiskANN/Vamana), aggressive quantization, distributed IVF-PQ with SSD-resident vectors</li>
      <li><strong>How do you measure and guarantee recall?</strong> -- Ground truth evaluation set, periodic brute-force comparison on sample queries, recall@K dashboards per collection</li>
    </ol>
  </div>

  <h3>Time Allocation (45 min interview)</h3>
  <div class="metric-row">
    <div class="metric-pill">
      <span class="mp-val">5 min</span>
      <span class="mp-label">Requirements & Scope</span>
    </div>
    <div class="metric-pill">
      <span class="mp-val">8 min</span>
      <span class="mp-label">ANN Algorithms</span>
    </div>
    <div class="metric-pill">
      <span class="mp-val">10 min</span>
      <span class="mp-label">Architecture</span>
    </div>
    <div class="metric-pill">
      <span class="mp-val">8 min</span>
      <span class="mp-label">Multi-Tenancy</span>
    </div>
    <div class="metric-pill">
      <span class="mp-val">7 min</span>
      <span class="mp-label">Storage & Scale</span>
    </div>
    <div class="metric-pill">
      <span class="mp-val">7 min</span>
      <span class="mp-label">Deep Dives / Q&A</span>
    </div>
  </div>
</div>

</div><!-- /.container -->

<!-- ============================================================ -->
<!--  FOOTER                                                       -->
<!-- ============================================================ -->
<div class="footer">
  <p>Multi-Tenant Vector Database &mdash; PE-Level System Design</p>
  <p style="margin-top: 8px;">
    <a href="index.html">&#8592; Back to All Topics</a>
  </p>
  <p style="margin-top: 16px; font-size: 0.78em; color: var(--text-muted);">
    Covers: ANN algorithms (Flat, IVF, HNSW, PQ) &bull; Distributed architecture &bull; Multi-tenancy isolation &bull; Storage engine design &bull; Scaling &amp; consistency
  </p>
</div>

<script>
(function(){
  document.querySelectorAll(".diagram-box").forEach(function(box){
    var svg=box.querySelector("svg");
    if(!svg) return;
    var zoom=1, minZ=0.5, maxZ=3;
    var ctrl=document.createElement("div");
    ctrl.className="diagram-zoom-controls";
    ctrl.innerHTML='<button class="zoom-out" title="Zoom Out">−</button><span class="zoom-level">100%</span><button class="zoom-in" title="Zoom In">+</button><button class="zoom-reset" title="Reset">↺</button><button class="zoom-fs" title="Fullscreen">⤢</button>';
    box.insertBefore(ctrl,box.firstChild);
    var lvl=ctrl.querySelector(".zoom-level");
    function apply(){svg.style.transform="scale("+zoom+")";lvl.textContent=Math.round(zoom*100)+"%";}
    ctrl.querySelector(".zoom-in").onclick=function(){zoom=Math.min(maxZ,zoom+0.25);apply();};
    ctrl.querySelector(".zoom-out").onclick=function(){zoom=Math.max(minZ,zoom-0.25);apply();};
    ctrl.querySelector(".zoom-reset").onclick=function(){zoom=1;apply();};
    ctrl.querySelector(".zoom-fs").onclick=function(){
      box.classList.toggle("fullscreen");
      if(box.classList.contains("fullscreen")){this.textContent="✖";zoom=1.2;}else{this.textContent="⤢";zoom=1;}
      apply();
    };
    box.addEventListener("wheel",function(e){
      if(e.ctrlKey){e.preventDefault();zoom=e.deltaY<0?Math.min(maxZ,zoom+0.1):Math.max(minZ,zoom-0.1);apply();}
    },{passive:false});
  });
})();
</script>
</body>
</html>